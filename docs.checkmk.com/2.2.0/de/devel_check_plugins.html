<!DOCTYPE html>
<html lang="de">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="UTF-8">
<!--[if IE]><meta http-equiv="X-UA-Compatible" content="IE=edge"><![endif]--><meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.10">
<link rel="icon" href="/favicon.png">
<meta name="robots" content="noindex">
<meta name="description" content="Hier erfahren Sie, wie Sie agentenbasierte Checkmk-Plugins entwickeln können - mit allem was dazugehört, insbesondere mit der in der Version 2.0.0 neu entwickelten Check-API.">
<meta name="og:locale" content="de">
<meta name="og:site_name" content="Checkmk Docs">
<meta name="og:title" content="Agentenbasierte Check-Plugins schreiben">
<meta name="og:description" content="Hier erfahren Sie, wie Sie agentenbasierte Checkmk-Plugins entwickeln können - mit allem was dazugehört, insbesondere mit der in der Version 2.0.0 neu entwickelten Check-API.">
<meta name="og:image" content="https://docs.checkmk.com/assets/images/share_image.png">
<meta name="twitter:site" content="@checkmk">
<meta name="twitter:creator" content="@checkmk">
<title>Agentenbasierte Check-Plugins schreiben</title>
<link rel="stylesheet" href="../../assets/css/checkmk.css?id=4473d2acbb1ea6136428">
<link rel="stylesheet" href="../../assets/css/pygments-monokai.css">
<link rel="stylesheet" href="../../assets/css/addons.css">
<link rel="stylesheet" href="../../assets/css/SourceCodePro.css">
<link rel="search" href="./opensearch.xml" type="application/opensearchdescription+xml" title="Suche auf docs.checkmk.com">
<!-- Google Tag Manager -->
<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
        new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
    j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
    'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-NJ3VGL8');</script>
<!-- End Google Tag Manager --><style>
#staticinfo { font-style: italic; }
</style>
</head>
<body class="article toc2 toc-right">
<!-- Cookie Consent (GDPR Compliance) -->

<!-- End Cookie Consent (GDPR Compliance) -->
<!-- Google Tag Manager (noscript) -->
<noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-NJ3VGL8" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
<!-- End Google Tag Manager (noscript) --><div class="header-top">
<div class="header-top__left">
<a class="header-top__logo d-none d-xl-inline-block" href="/2.2.0/de"><img src="../../assets/images/docs_logo.png" alt="Checkmk"></a><a class="header-top__icon d-inline-block d-xl-none" href="/2.2.0/de"><img src="../../assets/images/logo_icon.svg" alt="Checkmk"></a>
</div>
<div class="header-top__center">
<input type="text" class="header-top__search" placeholder="Search the checkmk docs"><div class="header-top__search__results"></div>
</div>
<div class="header-top__right d-block">
<button class="header-top__search__toggle d-inline-block d-md-none"><img class="header-top__search__toggle__icon" src="../../assets/images/search.svg" alt="Search"></button><div class="dropdown dropdown__language">
                    <button class="btn dropdown-toggle" type="button" id="languageMenuButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">de</button>
                    <div class="dropdown-menu  dropdown-menu-right" aria-labelledby="languageMenuButton"><a class="dropdown-item" href="../../2.2.0/en/devel_check_plugins.html">English</a></div>
</div>
<div class="dropdown dropdown__branch">
                        <button class="btn dropdown-toggle" type="button" id="branchMenuButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">2.2.0</button>
                        <div class="dropdown-menu dropdown-menu-right" aria-labelledby="branchMenuButton">
<a class="dropdown-item" href="../../2.1.0/de/devel_check_plugins.html">2.1.0</a><a class="dropdown-item" href="../../latest/de/devel_check_plugins.html">latest (2.3.0)</a>
</div>
</div>
<a class="header-top__back d-none d-lg-inline-block" href="https://checkmk.com">to checkmk.com</a><button class="header-top__toggle d-inline-block d-lg-none"><span class="header-top__toggle__icon"></span></button>
</div>
</div>
<aside><div class="main-nav">
<div class="main-nav__content"><div id="content">
<div class="sect1">
<h2 id="_willkommen_bei_checkmk">
<a class="anchor" href="#_willkommen_bei_checkmk"></a>1. Willkommen bei Checkmk</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p><a href="welcome.html">Willkommen im Checkmk Handbuch</a></p>
</li>
<li>
<p><a href="release_notes.html">Release notes</a></p>
</li>
<li>
<p><a href="glossar.html">Glossar</a></p>
</li>
<li>
<p><a href="search.html">Suchen in docs.checkmk.com</a></p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_leitfaden_für_einsteiger">
<a class="anchor" href="#_leitfaden_f%C3%BCr_einsteiger"></a>2. Leitfaden für Einsteiger</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p><a href="intro_setup.html">Checkmk aufsetzen</a></p>
</li>
<li>
<p><a href="intro_gui.html">Die Checkmk-Oberfläche</a></p>
</li>
<li>
<p><a href="intro_setup_monitor.html">Das Monitoring einrichten</a></p>
</li>
<li>
<p><a href="intro_tools.html">Die Monitoring-Werkzeuge</a></p>
</li>
<li>
<p><a href="intro_monitor.html">Checkmk im Monitoring</a></p>
</li>
<li>
<p><a href="intro_finetune.html">Das Monitoring feinjustieren</a></p>
</li>
<li>
<p><a href="intro_users.html">Mit mehreren Benutzern arbeiten</a></p>
</li>
<li>
<p><a href="intro_notifications.html">Benachrichtigungen einschalten</a></p>
</li>
<li>
<p><a href="intro_extend.html">Das Monitoring weiter ausbauen</a></p>
</li>
<li>
<p><a href="intro_bestpractise.html">Best Practices, Tipps &amp; Tricks</a></p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_installation">
<a class="anchor" href="#_installation"></a>3. Installation</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p><a href="install_packages.html">Grundsätzliches zur Installation von Checkmk</a></p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="_server_und_vms">
<a class="anchor" href="#_server_und_vms"></a>3.1. Server und VMs</h3>
<div class="ulist">
<ul>
<li>
<p><a href="install_packages_debian.html">Installation unter Debian und Ubuntu</a></p>
</li>
<li>
<p><a href="install_packages_redhat.html">Installation unter Red Hat und Derivaten</a></p>
</li>
<li>
<p><a href="install_packages_sles.html">Installation unter SUSE Linux Enterprise Server</a></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_appliance_container_cloud">
<a class="anchor" href="#_appliance_container_cloud"></a>3.2. Appliance, Container, Cloud</h3>
<div class="ulist">
<ul>
<li>
<p><a href="install_appliance_cmk.html">Installation von Checkmk in der Appliance</a></p>
</li>
<li>
<p><a href="introduction_docker.html">Installation als Docker-Container</a></p>
</li>
<li>
<p><a href="install_azure.html">Installation aus dem Azure Marketplace</a></p>
</li>
<li>
<p><a href="install_aws.html">Installation aus dem AWS Marketplace</a></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_updates">
<a class="anchor" href="#_updates"></a>3.3. Updates</h3>
<div class="ulist">
<ul>
<li>
<p><a href="update.html">Updates und Upgrades</a></p>
</li>
<li>
<p><a href="update_major.html">Update auf Version <span class="new">2.2.0</span></a></p>
</li>
<li>
<p><a href="update_matrix.html">Update-Matrix für Version <span class="new">2.2.0</span></a></p>
</li>
<li>
<p><a href="release_upgrade.html">Linux-Upgrade auf dem Checkmk-Server</a></p>
</li>
<li>
<p><a href="cmk_versions.html">Checkmk-Versionen</a></p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_administration_von_checkmk">
<a class="anchor" href="#_administration_von_checkmk"></a>4. Administration von Checkmk</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_server">
<a class="anchor" href="#_server"></a>4.1. Server</h3>
<div class="ulist">
<ul>
<li>
<p><a href="saml.html">Anmeldung mit SAML</a></p>
</li>
<li>
<p><a href="kerberos.html">Single Sign-On mit Kerberos</a></p>
</li>
<li>
<p><a href="managing_docker.html">Checkmk-Server im Docker-Container</a></p>
</li>
<li>
<p><a href="security.html">Sicherheit (Security)</a></p>
</li>
<li>
<p><a href="ports.html">Ports</a></p>
</li>
<li>
<p><a href="omd_https.html">Weboberfläche mit HTTPS absichern</a></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_instanzen">
<a class="anchor" href="#_instanzen"></a>4.2. Instanzen</h3>
<div class="ulist">
<ul>
<li>
<p><a href="omd_basics.html">Instanzen (Sites) mit omd verwalten</a></p>
</li>
<li>
<p><a href="cmk_commandline.html">Checkmk auf der Kommandozeile</a></p>
</li>
<li>
<p><a href="license.html">Lizenzen verwalten</a></p>
</li>
<li>
<p><a href="distributed_monitoring.html">Verteiltes Monitoring</a></p>
</li>
<li>
<p><a href="backup.html">Backups</a></p>
</li>
<li>
<p><a href="password_store.html">Passwortspeicher (Password store)</a></p>
</li>
<li>
<p><a href="analyze_configuration.html">Konfiguration der Checkmk Instanz analysieren</a></p>
</li>
<li>
<p><a href="mkps.html">Checkmk-Erweiterungspakete (MKPs)</a></p>
</li>
<li>
<p><a href="mkp_viewables.html">MKPs für GUI-Erweiterungen</a></p>
</li>
<li>
<p><a href="simulation_mode.html">Der Simulationsmodus</a></p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_konfiguration">
<a class="anchor" href="#_konfiguration"></a>5. Konfiguration</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p><a href="wato.html">Die Konfiguration von Checkmk</a></p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="_hosts">
<a class="anchor" href="#_hosts"></a>5.1. Hosts</h3>
<div class="ulist">
<ul>
<li>
<p><a href="hosts_setup.html">Verwaltung der Hosts</a></p>
</li>
<li>
<p><a href="hosts_structure.html">Strukturierung der Hosts</a></p>
</li>
<li>
<p><a href="host_tags.html">Host-Merkmale</a></p>
</li>
<li>
<p><a href="dcd.html">Dynamische Host-Konfiguration</a></p>
</li>
<li>
<p><a href="hosts_autoregister.html">Automatisch Hosts erstellen</a></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_services">
<a class="anchor" href="#_services"></a>5.2. Services</h3>
<div class="ulist">
<ul>
<li>
<p><a href="wato_services.html">Services verstehen und konfigurieren</a></p>
</li>
<li>
<p><a href="clustered_services.html">Cluster-Services überwachen</a></p>
</li>
<li>
<p><a href="piggyback.html">Der Piggyback-Mechanismus</a></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_regeln">
<a class="anchor" href="#_regeln"></a>5.3. Regeln</h3>
<div class="ulist">
<ul>
<li>
<p><a href="wato_rules.html">Regeln</a></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_unterstützende_konfigurationen">
<a class="anchor" href="#_unterst%C3%BCtzende_konfigurationen"></a>5.4. Unterstützende Konfigurationen</h3>
<div class="ulist">
<ul>
<li>
<p><a href="timeperiods.html">Zeitperioden (Time Periods)</a></p>
</li>
<li>
<p><a href="labels.html">Labels</a></p>
</li>
<li>
<p><a href="regexes.html">Reguläre Ausdrücke in Checkmk</a></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_benutzer_und_berechtigungen">
<a class="anchor" href="#_benutzer_und_berechtigungen"></a>5.5. Benutzer und Berechtigungen</h3>
<div class="ulist">
<ul>
<li>
<p><a href="wato_user.html">Benutzer, Zuständigkeiten, Berechtigungen</a></p>
</li>
<li>
<p><a href="ldap.html">Benutzerverwaltung mit LDAP/Active Directory</a></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_benachrichtigungen">
<a class="anchor" href="#_benachrichtigungen"></a>5.6. Benachrichtigungen</h3>
<div class="ulist">
<ul>
<li>
<p><a href="notifications.html">Benachrichtigungen</a></p>
</li>
<li>
<p><a href="notifications_webex.html">Benachrichtigungen per Cisco Webex Teams</a></p>
</li>
<li>
<p><a href="notifications_ilert.html">Benachrichtigungen per ilert</a></p>
</li>
<li>
<p><a href="notifications_jira.html">Benachrichtigungen per Jira</a></p>
</li>
<li>
<p><a href="notifications_mattermost.html">Benachrichtigungen per Mattermost</a></p>
</li>
<li>
<p><a href="notifications_teams.html">Benachrichtigungen per Microsoft Teams</a></p>
</li>
<li>
<p><a href="notifications_pagerduty.html">Benachrichtigungen per PagerDuty</a></p>
</li>
<li>
<p><a href="notifications_pushover.html">Benachrichtigungen per Pushover</a></p>
</li>
<li>
<p><a href="notifications_opsgenie.html">Benachrichtigungen per Opsgenie</a></p>
</li>
<li>
<p><a href="notifications_servicenow.html">Benachrichtigungen per ServiceNow</a></p>
</li>
<li>
<p><a href="notifications_slack.html">Benachrichtigungen per Slack</a></p>
</li>
<li>
<p><a href="notifications_splunkoncall.html">Benachrichtigungen per Splunk On-Call</a></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_events">
<a class="anchor" href="#_events"></a>5.7. Events</h3>
<div class="ulist">
<ul>
<li>
<p><a href="ec.html">Die Event Console</a></p>
</li>
<li>
<p><a href="alert_handlers.html">Alert Handler</a></p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_überwachung_von_systemen">
<a class="anchor" href="#_%C3%BCberwachung_von_systemen"></a>6. Überwachung von Systemen</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p><a href="wato_monitoringagents.html">Monitoring-Agenten</a></p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="_checkmk_agenten_und_snmp">
<a class="anchor" href="#_checkmk_agenten_und_snmp"></a>6.1. Checkmk-Agenten und SNMP</h3>
<div class="ulist">
<ul>
<li>
<p><a href="agent_deployment.html">Automatische Agenten-Updates</a></p>
</li>
<li>
<p><a href="agent_linux.html">Linux überwachen</a></p>
</li>
<li>
<p><a href="agent_linux_legacy.html">Linux überwachen im Legacy-Modus</a></p>
</li>
<li>
<p><a href="agent_windows.html">Windows überwachen</a></p>
</li>
<li>
<p><a href="agent_freebsd.html">FreeBSD überwachen</a></p>
</li>
<li>
<p><a href="snmp.html">Überwachen via SNMP</a></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_agentenerweiterungen">
<a class="anchor" href="#_agentenerweiterungen"></a>6.2. Agentenerweiterungen</h3>
<div class="ulist">
<ul>
<li>
<p><a href="inventory.html">Die HW/SW-Inventur</a></p>
</li>
<li>
<p><a href="mk_filestats.html">Dateien überwachen</a></p>
</li>
<li>
<p><a href="monitoring_logfiles.html">Log-Dateien überwachen</a></p>
</li>
<li>
<p><a href="monitoring_oracle.html">Oracle-Datenbanken überwachen</a></p>
</li>
<li>
<p><a href="monitoring_mysql.html">MySQL überwachen</a></p>
</li>
<li>
<p><a href="monitoring_mssql.html">MSSQL überwachen</a></p>
</li>
<li>
<p><a href="monitoring_jobs.html">Zeitbasierte Prozesse (Cronjobs) überwachen</a></p>
</li>
<li>
<p><a href="spool_directory.html">Das Spool-Verzeichnis</a></p>
</li>
<li>
<p><a href="localchecks.html">Lokale Checks</a></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_vm_cloud_container">
<a class="anchor" href="#_vm_cloud_container"></a>6.3. VM, Cloud, Container</h3>
<div class="ulist">
<ul>
<li>
<p><a href="datasource_programs.html">Datenquellenprogramme</a></p>
</li>
<li>
<p><a href="monitoring_vmware.html">VMware ESXi überwachen</a></p>
</li>
<li>
<p><a href="monitoring_aws.html">Amazon Web Services (AWS) überwachen</a></p>
</li>
<li>
<p><a href="monitoring_azure.html">Microsoft Azure überwachen</a></p>
</li>
<li>
<p><a href="monitoring_gcp.html">Google Cloud Platform (GCP) überwachen</a></p>
</li>
<li>
<p><a href="monitoring_kubernetes.html">Kubernetes überwachen</a></p>
</li>
<li>
<p><a href="monitoring_openshift.html">OpenShift überwachen</a></p>
</li>
<li>
<p><a href="monitoring_docker.html">Docker überwachen</a></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_endpunkte">
<a class="anchor" href="#_endpunkte"></a>6.4. Endpunkte</h3>
<div class="ulist">
<ul>
<li>
<p><a href="active_checks.html">Netzwerkdienste überwachen (Aktive Checks)</a></p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_dashboards_views_metriken">
<a class="anchor" href="#_dashboards_views_metriken"></a>7. Dashboards, Views, Metriken</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p><a href="user_interface.html">Die Benutzeroberfläche</a></p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="_allgemein">
<a class="anchor" href="#_allgemein"></a>7.1. Allgemein</h3>
<div class="ulist">
<ul>
<li>
<p><a href="views.html">Ansichten von Hosts und Services (Views)</a></p>
</li>
<li>
<p><a href="dashboards.html">Dashboards</a></p>
</li>
<li>
<p><a href="graphing.html">Messwerte und Graphing</a></p>
</li>
<li>
<p><a href="custom_notes.html">Anmerkungen (Custom notes)</a></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_kommandos_in_ansichten">
<a class="anchor" href="#_kommandos_in_ansichten"></a>7.2. Kommandos in Ansichten</h3>
<div class="ulist">
<ul>
<li>
<p><a href="commands.html">Kommandos</a></p>
</li>
<li>
<p><a href="basics_ackn.html">Quittierung von Problemen</a></p>
</li>
<li>
<p><a href="basics_downtimes.html">Wartungszeiten</a></p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_auswertungen_und_prognosen">
<a class="anchor" href="#_auswertungen_und_prognosen"></a>8. Auswertungen und Prognosen</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_auswertungen">
<a class="anchor" href="#_auswertungen"></a>8.1. Auswertungen</h3>
<div class="ulist">
<ul>
<li>
<p><a href="availability.html">Verfügbarkeit (Availability)</a></p>
</li>
<li>
<p><a href="sla.html">Erweiterte Verfügbarkeiten (SLAs)</a></p>
</li>
<li>
<p><a href="bi.html">Business Intelligence (BI)</a></p>
</li>
<li>
<p><a href="reporting.html">Berichte (Reports)</a></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_prognosen">
<a class="anchor" href="#_prognosen"></a>8.2. Prognosen</h3>
<div class="ulist">
<ul>
<li>
<p><a href="predictive_monitoring.html">Prognosebasiertes Monitoring</a></p>
</li>
<li>
<p><a href="forecast_graphs.html">Vorhersagegraphen erstellen</a></p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_anbindung_anderer_applikationen">
<a class="anchor" href="#_anbindung_anderer_applikationen"></a>9. Anbindung anderer Applikationen</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p><a href="monitoring_prometheus.html">Prometheus integrieren</a></p>
</li>
<li>
<p><a href="integrating_datadog.html">Datadog integrieren</a></p>
</li>
<li>
<p><a href="nagvis.html">NagVis: Statusdaten auf Karten und Diagrammen</a></p>
</li>
<li>
<p><a href="ntop.html">ntopng in Checkmk integrieren</a></p>
</li>
<li>
<p><a href="grafana.html">Checkmk in Grafana integrieren</a></p>
</li>
<li>
<p><a href="metrics_exporter.html">Metriken an InfluxDB und Graphite senden</a></p>
</li>
<li>
<p><a href="nagstamon.html">Nagstamon mit Checkmk verbinden</a></p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_besonderheiten_in_den_editionen">
<a class="anchor" href="#_besonderheiten_in_den_editionen"></a>10. Besonderheiten in den Editionen</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p><a href="cse.html">Die Standard Edition</a></p>
</li>
<li>
<p><a href="cce.html">Die Cloud Edition</a></p>
</li>
<li>
<p><a href="managed.html">Die Managed Services Edition</a></p>
</li>
<li>
<p><a href="support_diagnostics.html">Support Diagnostics</a></p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_automatisierung_und_programmierung">
<a class="anchor" href="#_automatisierung_und_programmierung"></a>11. Automatisierung und Programmierung</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_apis_zur_automatisierung">
<a class="anchor" href="#_apis_zur_automatisierung"></a>11.1. APIs zur Automatisierung</h3>
<div class="ulist">
<ul>
<li>
<p><a href="rest_api.html">Die Checkmk REST-API</a></p>
</li>
<li>
<p><a href="livestatus.html">Statusdaten abrufen via Livestatus</a></p>
</li>
<li>
<p><a href="livestatus_references.html">Livestatus Befehlsreferenz</a></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_apis_zur_programmierung">
<a class="anchor" href="#_apis_zur_programmierung"></a>11.2. APIs zur Programmierung</h3>
<div class="ulist">
<ul>
<li>
<p><a href="bakery_api.html">Die Bakery-API</a></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_programmierung_von_check_plugins">
<a class="anchor" href="#_programmierung_von_check_plugins"></a>11.3. Programmierung von Check-Plugins</h3>
<div class="ulist">
<ul>
<li>
<p><a href="devel_intro.html">Erweiterungen für Checkmk entwickeln</a></p>
</li>
<li>
<p><a href="devel_check_plugins.html">Agentenbasierte Check-Plugins schreiben</a></p>
</li>
<li>
<p><a href="devel_check_plugins_snmp.html">SNMP-basierte Check-Plugins schreiben</a></p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_konzepte">
<a class="anchor" href="#_konzepte"></a>12. Konzepte</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p><a href="monitoring_basics.html">Grundlagen des Monitorings mit Checkmk</a></p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="_der_checkmk_micro_core_cmc">
<a class="anchor" href="#_der_checkmk_micro_core_cmc"></a>12.1. Der Checkmk Micro Core (CMC)</h3>
<div class="ulist">
<ul>
<li>
<p><a href="cmc.html">Der Checkmk Micro Core (CMC)</a></p>
</li>
<li>
<p><a href="cmc_differences.html">Besonderheiten des CMC</a></p>
</li>
<li>
<p><a href="cmc_migration.html">Migration auf den CMC</a></p>
</li>
<li>
<p><a href="cmc_files.html">Dateien und Verzeichnisse des CMC</a></p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_die_checkmk_appliance">
<a class="anchor" href="#_die_checkmk_appliance"></a>13. Die Checkmk Appliance</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p><a href="appliance_rack1_quick_start.html">Schnellstart-Anleitung für Checkmk-Racks</a></p>
</li>
<li>
<p><a href="appliance_virt1_quick_start.html">Schnellstart-Anleitung für Checkmk virt1</a></p>
</li>
<li>
<p><a href="appliance_install_virt1.html">Virtuelle Appliance installieren</a></p>
</li>
<li>
<p><a href="appliance_usage.html">Appliance einrichten und nutzen</a></p>
</li>
<li>
<p><a href="appliance_backup.html">Backup in der Appliance</a></p>
</li>
<li>
<p><a href="appliance_cluster.html">Appliance im Cluster-Betrieb</a></p>
</li>
<li>
<p><a href="appliance_rack_config.html">Besonderheiten der Hardware-Appliance</a></p>
</li>
</ul>
</div>
</div>
</div>
</div></div>
<div class="main-nav__utils">
<div class="dropup dropdown__utils">
<button class="btn dropdown-toggle" type="button" id="aboutMenuButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">About Checkmk</button><div class="dropdown-menu dropup" aria-labelledby="aboutMenuButton">
<a class="dropdown-item" href="https://checkmk.com/product/features" target="_blank">Features</a><a class="dropdown-item" href="https://checkmk.com/product/editions" target="_blank">Editions</a><a class="dropdown-item" href="https://checkmk.com/integrations" target="_blank">Integrations</a><a class="dropdown-item" href="https://checkmk.com/imprint" target="_blank">Imprint</a><a class="dropdown-item" href="copyright.html" target="_blank">Copyright</a>
</div>
</div>
<div class="dropup dropdown__utils">
<button class="btn dropdown-toggle" type="button" id="learnMenuButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Learn</button><div class="dropdown-menu dropup" aria-labelledby="learnMenuButton">
<a class="dropdown-item" href="https://checkmk.com/videos">Videos</a><a class="dropdown-item" href="https://checkmk.com/webinars">Webinars</a><a class="dropdown-item" href="https://checkmk.com/trainings/classes">Trainings</a>
</div>
</div>
<a class="main-nav__utils__link" href="https://forum.checkmk.com">Forum</a>
</div>
</div></aside><main><div id="header">
<h1>Agentenbasierte Check-Plugins schreiben</h1>
<div class="details">
<span id="revdate">Last modified on 10-Oct-2023</span><a class="edit-document" href="https://github.com/Checkmk/checkmk-docs/edit/2.2.0/src/onprem/de/devel_check_plugins.asciidoc">Edit this page on GitHub</a>
</div>
</div>
<div id="content">
<div id="preamble">
<div id="staticinfo">Dies ist eine am 2025-01-07 22:12:14 +0000 für die Offline-Nutzung exportierte Seite. Sie spiegelt möglicherweise nicht den aktuellen Stand der Checkmk Dokumentation wider. Um eine täglich aktualisierte Version dieser Seite anzusehen, rufen Sie bitte <a href="https://docs.checkmk.com/" target="_blank">docs.checkmk.com</a> auf.</div>
<div class="sectionbody"><div class="paragraph">
<p></p>
<div class="dropdown dropdown__related">
<button class="btn btn-primary dropdown-toggle" type="button" id="relatedMenuButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Related Articles</button><div class="dropdown-menu dropdown-menu-right" aria-labelledby="relatedMenuButton">
<a href="devel_intro.html">Erweiterungen für Checkmk entwickeln</a>
<a href="devel_check_plugins_snmp.html">SNMP-basierte Check-Plugins entwickeln</a>
<a href="wato_monitoringagents.html">Monitoring-Agenten</a>
<a href="agent_linux.html">Linux überwachen</a>
<a href="agent_windows.html">Windows überwachen</a>
<a href="wato_services.html">Services verstehen und konfigurieren</a>
<a href="cmk_commandline.html">Checkmk auf der Kommandozeile</a>
<a href="mkps.html">Checkmk-Erweiterungspakete (MKPs)</a>
</div>
</div>
</div></div>
</div>
<div class="sect1">
<h2 id="heading_intro">
<span class="hidden-anchor sr-only" id="intro"></span>1. Einleitung</h2>
<div class="sectionbody">
<div class="paragraph"><p>Check-Plugins sind in Python geschriebene Software-Module, die auf der Checkmk-<a href="glossar.html#site">Instanz</a> ausgeführt werden und die <a href="glossar.html#service">Services</a> eines <a href="glossar.html#host">Hosts</a> erstellen und auswerten.</p></div>
<div class="paragraph"><p>Checkmk umfasst über 2000 fertige Check-Plugins für alle nur denkbare Hardware und Software.
Diese werden vom Checkmk-Team gepflegt und jede Woche kommen neue dazu.
Daneben gibt es auf der <a href="https://exchange.checkmk.com" target="_blank">Checkmk Exchange</a> weitere Plugins, die von unseren Anwendern beigesteuert werden.</p></div>
<div class="paragraph"><p>Und trotzdem kann es immer wieder vorkommen, dass ein Gerät, eine Anwendung oder einfach nur eine bestimmte <a href="glossar.html#metric">Metrik,</a> die für Sie wichtig ist, noch von keinem dieser Plugins erfasst wird — vielleicht auch einfach deshalb, weil es sich dabei um etwas handelt, das in Ihrer Firma entwickelt wurde und es daher niemand anders haben kann.
Im Artikel zur Einführung in die <a href="devel_intro.html">Programmierung von Erweiterungen</a> für Checkmk erfahren Sie, welche Möglichkeiten Sie haben.</p></div>
<div class="paragraph"><p>Dieser Artikel zeigt Ihnen, wie Sie echte Check-Plugins für den Checkmk-Agenten entwickeln können — mit allem was dazugehört.
Für SNMP-basierte Check-Plugins gibt es einen <a href="devel_check_plugins_snmp.html">eigenen Artikel.</a></p></div>
<div class="sect2">
<h3 id="heading_check_api_doc">
<span class="hidden-anchor sr-only" id="check_api_doc"></span>1.1. Die Check-API-Dokumentation</h3>
<div class="paragraph"><p>Für die Programmierung der Check-Plugins gibt es seit der Checkmk-Version <span class="new">2.0.0</span> eine neu entwickelte <strong>Check-API.</strong>
Wir zeigen Ihnen, wie Sie diese Check-API für die Plugin-Programmierung nutzen können.</p></div>
<div class="paragraph"><p>Über die Checkmk-Benutzeroberfläche haben Sie jederzeit Zugriff auf die Dokumentation der Check-API: <span class="guihint">Help &gt; Developer resources &gt; Check plugin API reference.</span>
Wählen Sie im neuen Browserfenster in der linken Navigationsleiste <span class="guihint">BASE &gt; Agent based API ("Check API")</span> aus:</p></div>
<div class="imageblock border"><div class="content"><img src="../images/devel_cpi_checkapi_doc.png" alt="Seite zum Einstieg in die Check-API-Dokumentation."></div></div>
<div class="paragraph"><p><strong>Hinweis</strong> für Benutzer der bis zur Version <span class="new">1.6.0</span> gültigen Check-API:
Falls Sie noch Check-Plugins haben, die mit der alten API entwickelt wurden, sollten Sie diese bald auf die neue Check-API migrieren.
Zwar wird die alte Check-API für eine Übergangszeit weiterhin unterstützt — aber auch diese Zeit wird einmal enden.
Den einmaligen Aufwand zur Migration machen die Vorteile der neuen Check-API wett,
denn diese ist konsistenter, logischer, besser dokumentiert und zukunftssicher.
Im <a href="https://checkmk.com/de/blog/migrating-check-plug-ins-to-checkmk-2-0" target="_blank">Blogpost zur Migration von Check-Plugins</a> informieren wir Sie ausführlich über die notwendigen Schritte.</p></div>
</div>
<div class="sect2">
<h3 id="heading__voraussetzungen">
<span class="hidden-anchor sr-only" id="_voraussetzungen"></span>1.2. Voraussetzungen</h3>
<div class="paragraph"><p>Wenn Sie Lust haben, sich mit dem Programmieren von Check-Plugins zu befassen, benötigen Sie folgendes:</p></div>
<div class="ulist"><ul>
<li><p>Kenntnisse in der Programmiersprache Python.</p></li>
<li><p>Erfahrung mit Checkmk, vor allem was das Thema Agenten und Checks betrifft.</p></li>
<li><p>Übung mit Linux auf der Kommandozeile.</p></li>
</ul></div>
</div>
<div class="sect2">
<h3 id="heading__begriffe">
<span class="hidden-anchor sr-only" id="_begriffe"></span>1.3. Begriffe</h3>
<div class="paragraph"><p>Zwar ist hier immer die Rede von einem Check-Plugin und davon, dieses zu schreiben.
Aber genau genommen benötigen Sie immer zwei Plugins, das <a href="glossar.html#agent_plugin">Agentenplugin</a> auf dem überwachten Host und das <a href="glossar.html#check_plugin">Check-Plugin</a> auf dem Checkmk-Server.
Beide müssen geschrieben und aufeinander abgestimmt werden.
Nur so funktionieren sie hinterher reibungsfrei.</p></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="heading_agentplugin">
<span class="hidden-anchor sr-only" id="agentplugin"></span>2. Ein Agentenplugin schreiben</h2>
<div class="sectionbody">
<div class="paragraph"><p>Wer sich für die Programmierung von Check-Plugins in Checkmk interessiert, hat mit großer Wahrscheinlichkeit auch schon einmal einen Checkmk-Server aufgesetzt.
Haben auch Sie dies bereits gemacht, haben Sie dabei als Einstieg vermutlich auch Ihren Checkmk-Server selbst als Host überwacht.</p></div>
<div class="paragraph"><p>Im Folgenden gehen wir von einem beispielhaften Szenario aus, in dem Checkmk-Server und überwachter Host identisch sind.
So ist es uns möglich über <a href="glossar.html#livestatus">Livestatus</a>-Abfragen vom Host Informationen über Host-Gruppen zu erhalten, die der Checkmk-Server zur Verfügung stellt.</p></div>
<div class="paragraph"><p>Im beschriebenen Beispiel gehen wir von einem Unternehmen mit mehreren Standorten aus:</p></div>
<div class="ulist"><ul>
<li><p>Jeder dieser Standorte wird in Checkmk durch eine <a href="glossar.html#host_group">Host-Gruppe</a> abgebildet.</p></li>
<li><p>Jeder Standort hat sein eigenes Service-Team.</p></li>
</ul></div>
<div class="paragraph"><p>Damit bei Problemen jeweils das richtige Service-Team verständigt werden kann, gilt, dass jeder Host einem Standort — also auch einer Host-Gruppe — zugewiesen sein muss.
Das Ziel in diesem Beispiel ist nun, eine Prüfung aufzusetzen, mit der kontrolliert werden kann, ob für keinen Host vergessen wurde, eine Host-Gruppe zuzuweisen.</p></div>
<div class="paragraph"><p>Das Ganze läuft in zwei Schritten:</p></div>
<div class="olist arabic"><ol class="arabic">
<li><p>Informationen für das Monitoring aus dem Host auslesen.
Darum geht es in diesem Kapitel.</p></li>
<li><p>Schreiben eines Check-Plugins in der Checkmk-Instanz, welches diese Daten auswertet.
Das zeigen wir im <a href="#write_check_plugin">nächsten Kapitel.</a></p></li>
</ol></div>
<div class="paragraph"><p>Und los geht’s …​</p></div>
<div class="sect2">
<h3 id="heading_right_command">
<span class="hidden-anchor sr-only" id="right_command"></span>2.1. Informationen auslesen und filtern</h3>
<div class="paragraph"><p>Am Anfang jeder Plugin-Programmierung steht: die Recherche!
Das bedeutet, dass Sie herausfinden müssen, wie Sie überhaupt an die Informationen kommen, die Sie für die Überwachung brauchen.</p></div>
<div class="paragraph"><p>Für das gewählte Beispiel nutzen wir die Tatsache, dass der Checkmk-Server zugleich der Host ist.
Damit genügt zunächst ein <a href="livestatus.html">Abruf der Statusdaten via Livestatus,</a> also der in Tabellen organisierten Daten, die Checkmk über die überwachten Hosts und Services im flüchtigen Speicher vorhält.</p></div>
<div class="paragraph"><p>Melden Sie sich als Instanzbenutzer an und fragen Sie die Informationen zu den Host-Gruppen mit folgendem Befehl ab:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="console"><span></span><span class="tok-gp">OMD[mysite]:~$ </span>lq<span class="tok-w"> </span><span class="tok-s2">"GET hostgroups"</span>
<span class="tok-go">action_url;alias;members;members_with_state;name;notes;notes_url;num_hosts;num_hosts_down;num_hosts_handled_problems;num_hosts_pending;num_hosts_unhandled_problems;num_hosts_unreach;num_hosts_up;num_services;num_services_crit;num_services_handled_problems;num_services_hard_crit;num_services_hard_ok;num_services_hard_unknown;num_services_hard_warn;num_services_ok;num_services_pending;num_services_unhandled_problems;num_services_unknown;num_services_warn;worst_host_state;worst_service_hard_state;worst_service_state</span>
<span class="tok-go">;Hamburg;myhost11,myhost22,myhost33;myhost11|0|1,myhost22|0|1,myhost33|0|1;Hamburg;;;3;0;0;0;0;0;3;123;10;0;10;99;0;14;99;0;24;0;14;0;2;2</span>
<span class="tok-go">;Munich;myhost1,myhost2,myhost3;myhost1|0|1,myhost2|0|1,myhost3|0|1;Munich;;;3;0;0;0;0;0;3;123;10;0;10;99;0;14;99;0;24;0;14;0;2;2</span>
<span class="tok-go">;check_mk;localhost;localhost|0|1;check_mk;;;1;0;0;0;0;0;1;66;0;0;0;4;0;1;4;61;1;0;1;0;1;1</span></code></pre></div></div>
<div class="paragraph"><p>Die erste Zeile der Ausgabe enthält die Spaltennamen der abgefragten Tabelle <code>hostgroups</code>.
Als Trennzeichen fungiert das Semikolon.
In den folgenden Zeilen folgen dann die Inhalte sämtlicher Spalten, ebenfalls durch Semikolons getrennt.</p></div>
<div class="paragraph"><p>Die Ausgabe ist bereits für dieses kleine Beispiel relativ unübersichtlich und enthält Informationen, die für unser Beispiel nicht relevant sind.
Generell sollten Sie zwar die Interpretation der Daten Checkmk überlassen.
Allerdings kann eine Vorfilterung auf dem Host den Umfang der zu übertragenden Daten reduzieren, wenn diese gar nicht gebraucht werden.
Also schränken Sie in diesem Fall die Abfrage auf die relevanten Spalten (<code>Columns</code>) ein — auf die Namen der Host-Gruppen (<code>name</code>) und die in den Gruppen befindlichen Hosts (<code>members</code>):</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="console"><span></span><span class="tok-gp">OMD[mysite]:~$ </span>lq<span class="tok-w"> </span><span class="tok-s2">"GET hostgroups\nColumns: name members"</span>
<span class="tok-go">Hamburg;myhost11,myhost22,myhost33</span>
<span class="tok-go">Munich;myhost1,myhost2,myhost3</span>
<span class="tok-go">check_mk;localhost</span></code></pre></div></div>
<div class="paragraph"><p>Die Livestatus-Schnittstelle erwartet alle Befehle und Header in jeweils einer eigenen Zeile.
Die daher notwendigen Zeilenumbrüche machen Sie durch <code>\n</code> kenntlich.</p></div>
<div class="paragraph"><p>In diesem Beispiel existieren aktuell drei Host-Gruppen: zwei Gruppen für die Standorte sowie die Gruppe <code>check_mk</code>.
Diese enthält einen Host namens <code>localhost</code>.</p></div>
<div class="paragraph"><p>Die Host-Gruppe <code>check_mk</code> stellt eine Besonderheit innerhalb der Host-Gruppen dar.
Sie haben diese nämlich nicht selbst angelegt.
Und Sie können auch keinen Host aktiv in diese Gruppe aufnehmen.
Woher also stammt diese Host-Gruppe?
Da in Checkmk per Definition jeder Host einer Gruppe angehören muss, weist Checkmk jeden Host, den Sie keiner Gruppe zuweisen, der „speziellen“ Gruppe <code>check_mk</code> zu.</p></div>
<div class="paragraph"><p>Sobald Sie einen Host einer Ihrer eigenen Host-Gruppen zuweisen, wird er aus der Gruppe <code>check_mk</code> entfernt.
Auch gibt es keinen Weg, einen Host erneut der Host-Gruppe <code>check_mk</code> zuzuweisen.</p></div>
<div class="paragraph"><p>Genau diese Eigenschaften der Gruppe <code>check_mk</code> werden nun für unser Beispiel genutzt:
Da jeder Host einem Standort zugeordnet sein soll, müsste die Host-Gruppe <code>check_mk</code> leer sein.
Ist sie nicht leer, so besteht Handlungsbedarf, sprich darin befindliche Hosts müssen den Host-Gruppen und damit den Standorten zugeordnet werden.</p></div>
</div>
<div class="sect2">
<h3 id="heading_command_in_agent">
<span class="hidden-anchor sr-only" id="command_in_agent"></span>2.2. Den Befehl in den Agenten einbauen</h3>
<div class="paragraph"><p>Bis jetzt haben Sie sich mit dem <code>lq</code>-Befehl als Instanzbenutzer die Informationen anzeigen lassen.
Das ist hilfreich, um sich einen Einblick in die Daten zu verschaffen.</p></div>
<div class="paragraph"><p>Damit Sie diese Daten vom Checkmk-Server aus abrufen können, muss der neue Befehl jedoch Teil vom Checkmk-Agenten auf dem überwachten Host werden.
Theoretisch könnten Sie nun direkt den Checkmk-Agenten in der Datei <code>/usr/bin/check_mk_agent</code> editieren und diesen Teil einbauen.
Das hätte aber den Nachteil, dass Ihr neuer Befehl bei einem Software-Update des Agenten wieder verschwindet, weil die Datei ersetzt wird.</p></div>
<div class="paragraph"><p>Besser ist es daher, ein <a href="glossar.html#agent_plugin">Agentenplugin</a> zu erstellen.
Alles was Sie dafür brauchen, ist eine ausführbare Datei, die den Befehl enthält und im Verzeichnis <code>/usr/lib/check_mk_agent/plugins/</code> liegt.</p></div>
<div class="paragraph"><p>Und noch eins ist wichtig:
Die Daten können nicht einfach so ausgegeben werden.
Sie brauchen noch einen <strong>Sektions-Header</strong> (<em>section header</em>).
Das ist eine speziell formatierte Zeile, die den Namen des neuen Agentenplugins enthält.
An diesem Sektions-Header kann Checkmk später erkennen, wo die Daten des Agentenplugins beginnen und die des vorherigen aufhören.
Am einfachsten ist es, wenn Sektions-Header und Check-Plugin den gleichen Namen tragen — auch wenn dies nicht verpflichtend ist.</p></div>
<div class="paragraph"><p>Also brauchen Sie jetzt erst einmal einen sinnvollen Namen für Ihr neues Check-Plugin.
Dieser Name darf nur Kleinbuchstaben (nur <em>a-z</em>, keine Umlaute, keine Akzente), Unterstriche und Ziffern enthalten und muss eindeutig sein.
Vermeiden Sie Namenskollisionen mit vorhandenen Check-Plugins.
Wenn Sie neugierig sind, welche Namen es schon gibt, können Sie diese in einer Checkmk-Instanz auf der Kommandozeile mit <code>cmk -L</code> auflisten lassen:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="console"><span></span><span class="tok-gp">OMD[mysite]:~$ </span>cmk<span class="tok-w"> </span>-L
<span class="tok-go">3par_capacity               agent      HPE 3PAR: Capacity</span>
<span class="tok-go">3par_cpgs                   agent      HPE 3PAR: CPGs</span>
<span class="tok-go">3par_cpgs_usage             agent      HPE 3PAR: CPGs Usage</span>
<span class="tok-go">3par_hosts                  agent      HPE 3PAR: Hosts</span>
<span class="tok-go">3par_ports                  agent      HPE 3PAR: Ports</span>
<span class="tok-go">3par_remotecopy             agent      HPE 3PAR: Remote Copy</span>
<span class="tok-go">3par_system                 agent      HPE 3PAR: System</span>
<span class="tok-go">3par_volumes                agent      HPE 3PAR: Volumes</span>
<span class="tok-go">3ware_disks                 agent      3ware ATA RAID Controller: State of Disks</span>
<span class="tok-go">3ware_info                  agent      3ware ATA RAID Controller: General Information</span>
<span class="tok-go">3ware_units                 agent      3ware ATA RAID Controller: State of Units</span>
<span class="tok-go">acme_agent_sessions         snmp       ACME Devices: Agent Sessions</span>
<span class="tok-go">acme_certificates           snmp       ACME Devices: Certificates</span></code></pre></div></div>
<div class="paragraph"><p>Die Ausgabe zeigt nur die ersten Zeilen der sehr langen Liste. Durch die Verwendung von Präfixen ist die Zugehörigkeit vieler Check-Plugins hier bereits gut zu erkennen.
Auch für Ihre eigenen Check-Plugins empfiehlt sich daher die Verwendung von Präfixen.
Die zweite Spalte zeigt übrigens an, wie das jeweilige Check-Plugin seine Daten bezieht.</p></div>
<div class="paragraph"><p>Ein für unser Beispiel passender Name für das neue Check-Plugin ist zum Beispiel <code>myhostgroups</code>.</p></div>
<div class="paragraph"><p>Nun haben Sie alle Informationen zusammen, um das Skript mit dem Agentenplugin zu erstellen.
Legen Sie als <code>root</code>-Benutzer eine neue Datei <code>myhostgroups</code> im Verzeichnis <code>/usr/lib/check_mk_agent/plugins/</code> an:</p></div>
<div class="listingblock">
<div class="title">/usr/lib/check_mk_agent/plugins/myhostgroups</div>
<div class="content"><pre class="pygments highlight"><code><span></span>#!/bin/bash

columns="name members"
site="mysite"

echo '&lt;&lt;&lt;myhostgroups:sep(59)&gt;&gt;&gt;'
su - ${site} lq "GET hostgroups\nColumns: ${columns}"</code></pre></div>
</div>
<div class="paragraph"><p>Was bedeutet das nun im Einzelnen?</p></div>
<div class="paragraph"><p>Die erste Zeile enthält den „Shebang“ (das ist eine Abkürzung für <em>sharp</em> und <em>bang,</em> wobei Letzteres eine Abkürzung für das Ausrufezeichen ist), an dem Linux erkennt, dass es das Skript mit der angegebenen Shell ausführen soll.</p></div>
<div class="paragraph"><p>Um das Skript erweiterbar zu halten, werden als nächstes zwei Variablen eingeführt:</p></div>
<div class="ulist"><ul>
<li><p>die Variable <code>columns</code>, die aktuell die Gruppennamen und die zugehörigen Mitglieder enthält,</p></li>
<li><p>die Variable <code>site</code>, die den Namen der Checkmk-Instanz enthält.</p></li>
</ul></div>
<div class="paragraph"><p>Mit dem <code>echo</code>-Befehl geben Sie den Sektions-Header aus.
Da die Spalten der Tabelle mit dem Semikolon getrennt werden, legen Sie gleichzeitig mit dem Zusatz <code>sep(59)</code> fest, dass das Semikolon als Trennzeichen (<em>separator</em>) für die Daten in der Agentenausgabe genutzt wird.
59 steht für das <a href="https://de.wikipedia.org/wiki/American_Standard_Code_for_Information_Interchange#ASCII-Tabelle" target="_blank">ASCII</a>-Zeichen Nummer 59, das Semikolon.
Ohne diesen Zusatz würde als Standard das Leerzeichen (ASCII-Zeichen 32) als Trennzeichen verwendet werden.</p></div>
<div class="paragraph"><p>Um den <code>lq</code>-Befehl, der Ihnen als Instanzbenutzer zur Verfügung steht, auch in einem Skript nutzen zu können, das vom <code>root</code>-Benutzer ausgeführt wird, stellen Sie ein <code>su</code> voran.</p></div>
<div class="paragraph"><p><strong>Hinweis:</strong> Es kann vorkommen, dass der Zugriff auf <code>lq</code> per <code>su</code> Probleme bereitet.
Sie können alternativ als <code>root</code>-Benutzer auch direkt auf Livestatus in der Shell mit <code>printf</code> oder <code>echo -e</code> über einen Unix-Socket zugreifen.
Im Artikel zu <a href="livestatus.html#lql_shell">Livestatus</a> erfahren Sie, wie das geht.</p></div>
<div class="paragraph"><p>Eines ist noch sehr wichtig, sobald Sie die Datei erstellt haben.
Machen Sie die Datei ausführbar:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="console"><span></span><span class="tok-gp">root@linux# </span>chmod<span class="tok-w"> </span>+x<span class="tok-w"> </span>/usr/lib/check_mk_agent/plugins/myhostgroups</code></pre></div></div>
<div class="paragraph"><p>Sie können das Agentenplugin direkt von Hand ausprobieren, indem Sie den kompletten Pfad als Befehl eingeben:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="console"><span></span><span class="tok-gp">root@linux# </span>/usr/lib/check_mk_agent/plugins/myhostgroups
<span class="tok-go">&lt;&lt;&lt;myhostgroups:sep(59)&gt;&gt;&gt;</span>
<span class="tok-go">Hamburg;myhost11,myhost22,myhost33</span>
<span class="tok-go">Munich;myhost1,myhost2,myhost3</span>
<span class="tok-go">check_mk;localhost</span></code></pre></div></div>
<div class="paragraph"><p>Host-Gruppen, die keine Hosts enthalten, werden hierbei nicht aufgeführt.</p></div>
</div>
<div class="sect2">
<h3 id="heading_test_agent">
<span class="hidden-anchor sr-only" id="test_agent"></span>2.3. Agent ausprobieren</h3>
<div class="paragraph"><p>Test und Fehlersuche sind am wichtigsten, um zu einem funktionierenden Agentenplugin zu gelangen.
Am besten gehen Sie in drei Schritten vor:</p></div>
<div class="olist arabic"><ol class="arabic">
<li><p>Agentenplugin solo ausprobieren.
Das haben Sie gerade im vorherigen Abschnitt gemacht.</p></li>
<li><p>Agent als Ganzes lokal testen.</p></li>
<li><p>Agent vom Checkmk-Server aus abrufen.</p></li>
</ol></div>
<div class="paragraph"><p>Das lokale Testen des Agenten ist sehr einfach.
Rufen Sie als <code>root</code> den Befehl <code>check_mk_agent</code> auf:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="console"><span></span><span class="tok-gp">root@linux# </span>check_mk_agent</code></pre></div></div>
<div class="paragraph"><p>Irgendwo in der sehr langen Ausgabe muss die neue Sektion erscheinen.
Agentenplugins werden vom Agenten zum Schluss ausgegeben.</p></div>
<div class="paragraph"><p>Durch Anhängen von <code>less</code> können Sie in der Ausgabe blättern (drücken Sie die Leertaste zum Blättern, <code>/</code> zum Suchen und <code>q</code> zum Beenden):</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="console"><span></span><span class="tok-gp">root@linux# </span>check_mk_agent<span class="tok-w"> </span><span class="tok-p">|</span><span class="tok-w"> </span>less</code></pre></div></div>
<div class="paragraph"><p>Oder Sie durchsuchen die Ausgabe nach den interessanten Zeilen.
So hat <code>grep</code> mit <code>-A</code> eine Option, nach jedem Treffer noch einige Zeilen mehr auszugeben.
Damit können Sie bequem die Sektion suchen und ausgeben:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="console"><span></span><span class="tok-gp">root@linux# </span>check_mk_agent<span class="tok-w"> </span><span class="tok-p">|</span><span class="tok-w"> </span>grep<span class="tok-w"> </span>-A3<span class="tok-w"> </span><span class="tok-s1">'^&lt;&lt;&lt;myhostgroups'</span>
<span class="tok-go">&lt;&lt;&lt;myhostgroups:sep(59)&gt;&gt;&gt;</span>
<span class="tok-go">Hamburg;myhost11,myhost22,myhost33</span>
<span class="tok-go">Munich;myhost1,myhost2,myhost3</span>
<span class="tok-go">check_mk;localhost</span></code></pre></div></div>
<div class="paragraph"><p>Der dritte und letzte Test ist dann direkt von der Checkmk-Instanz aus.
Nehmen Sie den <a href="intro_setup_monitor.html#linux">Host ins Monitoring</a> auf (zum Beispiel als <code>localhost</code>), melden Sie sich als Instanzbenutzer an und rufen Sie dann die Agentendaten mit <code>cmk -d</code> ab:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="console"><span></span><span class="tok-gp">OMD[mysite]:~$ </span>cmk<span class="tok-w"> </span>-d<span class="tok-w"> </span>localhost<span class="tok-w"> </span><span class="tok-p">|</span><span class="tok-w"> </span>grep<span class="tok-w"> </span>-A3<span class="tok-w"> </span><span class="tok-s1">'^&lt;&lt;&lt;myhostgroups'</span></code></pre></div></div>
<div class="paragraph"><p>Hier sollte die gleiche Ausgabe kommen wie beim vorherigen Befehl.</p></div>
<div class="paragraph"><p>Wenn das funktioniert, ist Ihr Agent vorbereitet.
Und was haben Sie dafür gemacht?
Sie haben ein kurzes Skript unter dem Pfad <code>/usr/lib/check_mk_agent/plugins/myhostgroups</code> erzeugt und ausführbar gemacht.</p></div>
<div class="paragraph"><p>Alles was nun folgt, geschieht nur noch auf dem Checkmk-Server:
Dort schreiben Sie das Check-Plugin.</p></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="heading_write_check_plugin">
<span class="hidden-anchor sr-only" id="write_check_plugin"></span>3. Ein einfaches Check-Plugin schreiben</h2>
<div class="sectionbody">
<div class="paragraph"><p>Das Vorbereiten des Agenten ist nur die halbe Miete.
Jetzt müssen Sie Checkmk noch beibringen, wie es mit den Informationen aus der neuen Agentensektion umgehen soll, welche Services es erzeugen soll, wann diese auf <span class="state1">WARN</span> oder <span class="state2">CRIT</span> gehen sollen usw.
All dies machen Sie durch die Programmierung eines Check-Plugins in Python.</p></div>
<div class="sect2">
<h3 id="heading_scaffold">
<span class="hidden-anchor sr-only" id="scaffold"></span>3.1. Die Datei vorbereiten</h3>
<div class="paragraph"><p>Für Ihre eigenen Check-Plugins finden Sie ein Verzeichnis vorbereitet in der <code>local</code>-Hierarchie des <a href="cmk_commandline.html#sitedir">Instanzverzeichnisses.</a>
Dieses lautet <code>~/local/lib/check_mk/base/plugins/agent_based/</code>.
Hier im Pfad meint <code>base</code> den Teil von Checkmk, der für das eigentlich Monitoring und die Benachrichtigungen zuständig ist.
Der Ordner <code>agent_based</code> beinhaltet alle Plugins, die sich auf den Checkmk-Agenten beziehen (also zum Beispiel nicht Benachrichtigungs-Plugins).
Am besten wechseln Sie zum Arbeiten dort hinein:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="console"><span></span><span class="tok-gp">OMD[mysite]:~$ </span><span class="tok-nb">cd</span><span class="tok-w"> </span>local/lib/check_mk/base/plugins/agent_based</code></pre></div></div>
<div class="paragraph"><p>Das Verzeichnis gehört dem Instanzbenutzer und ist daher für Sie schreibbar.
Sie können Ihr Check-Plugin mit jedem auf dem Linux-System installierten Texteditor bearbeiten.</p></div>
<div class="paragraph"><p>Legen Sie also die Datei <code>myhostgroups.py</code> für das Check-Plugin hier an.
Konvention ist, dass der Dateiname den Namen der Agentensektion wiedergibt.
<em>Pflicht</em> ist, dass die Datei mit <code>.py</code> endet, denn ab Version <span class="new">2.0.0</span> von Checkmk handelt es sich bei den Check-Plugins immer um echte Python-Module.</p></div>
<div class="paragraph"><p>Ein lauffähiges Grundgerüst (<a href="https://github.com/Checkmk/checkmk-docs/blob/2.2.0/examples/devel_check_plugins/check_plugin_simple_myhostgroups_bare_minimum.py" target="_blank">Download bei GitHub</a>), das Sie im Folgenden Schritt für Schritt weiter ausbauen werden, sieht so aus:</p></div>
<div class="listingblock">
<div class="title">~/local/lib/check_mk/base/plugins/agent_based/myhostgroups.py</div>
<div class="content"><pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-ch">#!/usr/bin/env python3</span>

<span class="tok-kn">from</span> <span class="tok-nn">.agent_based_api.v1</span> <span class="tok-kn">import</span> <span class="tok-n">check_levels</span><span class="tok-p">,</span> <span class="tok-n">Metric</span><span class="tok-p">,</span> <span class="tok-n">register</span><span class="tok-p">,</span> <span class="tok-n">Result</span><span class="tok-p">,</span> <span class="tok-n">Service</span><span class="tok-p">,</span> <span class="tok-n">State</span>

<span class="tok-k">def</span> <span class="tok-nf">parse_myhostgroups</span><span class="tok-p">(</span><span class="tok-n">string_table</span><span class="tok-p">):</span>
    <span class="tok-n">parsed</span> <span class="tok-o">=</span> <span class="tok-p">{}</span>
    <span class="tok-k">return</span> <span class="tok-n">parsed</span>

<span class="tok-k">def</span> <span class="tok-nf">discover_myhostgroups</span><span class="tok-p">(</span><span class="tok-n">section</span><span class="tok-p">):</span>
    <span class="tok-k">yield</span> <span class="tok-n">Service</span><span class="tok-p">()</span>

<span class="tok-k">def</span> <span class="tok-nf">check_myhostgroups</span><span class="tok-p">(</span><span class="tok-n">section</span><span class="tok-p">):</span>
    <span class="tok-k">yield</span> <span class="tok-n">Result</span><span class="tok-p">(</span><span class="tok-n">state</span><span class="tok-o">=</span><span class="tok-n">State</span><span class="tok-o">.</span><span class="tok-n">OK</span><span class="tok-p">,</span> <span class="tok-n">summary</span><span class="tok-o">=</span><span class="tok-s2">"Everything is fine"</span><span class="tok-p">)</span>

<span class="tok-n">register</span><span class="tok-o">.</span><span class="tok-n">agent_section</span><span class="tok-p">(</span>
    <span class="tok-n">name</span> <span class="tok-o">=</span> <span class="tok-s2">"myhostgroups"</span><span class="tok-p">,</span>
    <span class="tok-n">parse_function</span> <span class="tok-o">=</span> <span class="tok-n">parse_myhostgroups</span><span class="tok-p">,</span>
<span class="tok-p">)</span>

<span class="tok-n">register</span><span class="tok-o">.</span><span class="tok-n">check_plugin</span><span class="tok-p">(</span>
    <span class="tok-n">name</span> <span class="tok-o">=</span> <span class="tok-s2">"myhostgroups"</span><span class="tok-p">,</span>
    <span class="tok-n">service_name</span> <span class="tok-o">=</span> <span class="tok-s2">"Host group check_mk"</span><span class="tok-p">,</span>
    <span class="tok-n">discovery_function</span> <span class="tok-o">=</span> <span class="tok-n">discover_myhostgroups</span><span class="tok-p">,</span>
    <span class="tok-n">check_function</span> <span class="tok-o">=</span> <span class="tok-n">check_myhostgroups</span><span class="tok-p">,</span>
<span class="tok-p">)</span></code></pre></div>
</div>
<div class="paragraph"><p>Als erstes müssen Sie die für die Check-Plugins nötigen Funktionen und Klassen aus Python-Modulen importieren.
Die einfachste Methode dafür ist <code>import *</code>, allerdings sollten Sie das vermeiden, da so verschleiert wird, welche Namensräume tatsächlich verfügbar gemacht wurden.</p></div>
<div class="paragraph"><p>Für unser Beispiel wird also nur das importiert, was im weiteren Verlauf des Artikels genutzt wird:</p></div>
<div class="listingblock">
<div class="title">~/local/lib/check_mk/base/plugins/agent_based/myhostgroups.py</div>
<div class="content"><pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-kn">from</span> <span class="tok-nn">.agent_based_api.v1</span> <span class="tok-kn">import</span> <span class="tok-n">check_levels</span><span class="tok-p">,</span> <span class="tok-n">Metric</span><span class="tok-p">,</span> <span class="tok-n">register</span><span class="tok-p">,</span> <span class="tok-n">Result</span><span class="tok-p">,</span> <span class="tok-n">Service</span><span class="tok-p">,</span> <span class="tok-n">State</span></code></pre></div>
</div>
</div>
<div class="sect2">
<h3 id="heading_parsefunction">
<span class="hidden-anchor sr-only" id="parsefunction"></span>3.2. Die Parse-Funktion schreiben</h3>
<div class="paragraph"><p>Die Parse-Funktion hat die Aufgabe, die „rohen“ Agentendaten zu „parsen“, das heißt zu analysieren und zu zerteilen, und in eine logisch aufgeräumte Form zu bringen, die für alle weiteren Schritte einfach zu verarbeiten ist.</p></div>
<div class="paragraph"><p>Wie im Abschnitt zum <a href="#test_agent">Testen des Agenten</a> gezeigt, hat die vom Agentenplugin gelieferte Sektion die folgende Struktur:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="console"><span></span><span class="tok-go">&lt;&lt;&lt;myhostgroups:sep(59)&gt;&gt;&gt;</span>
<span class="tok-go">Hamburg;myhost11,myhost22,myhost33</span>
<span class="tok-go">Munich;myhost1,myhost2,myhost3</span>
<span class="tok-go">check_mk;localhost</span></code></pre></div></div>
<div class="paragraph"><p>Checkmk zerlegt bereits die Zeilen der vom Agentenplugin gelieferten Sektion anhand des Trennzeichens im Sektions-Header (im Beispiel <code>;</code>) in eine Liste von Zeilen, die ihrerseits wiederum Listen von Worten sind.
In Checkmk steht daher statt der Rohdaten des Agentenplugins die folgende Datenstruktur zur Verfügung:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-p">[</span>
    <span class="tok-p">[</span><span class="tok-s1">'Hamburg'</span><span class="tok-p">,</span> <span class="tok-s1">'myhost11,myhost22,myhost33'</span><span class="tok-p">],</span>
    <span class="tok-p">[</span><span class="tok-s1">'Munich'</span><span class="tok-p">,</span> <span class="tok-s1">'myhost1,myhost2,myhost3'</span><span class="tok-p">],</span>
    <span class="tok-p">[</span><span class="tok-s1">'check_mk'</span><span class="tok-p">,</span> <span class="tok-s1">'localhost'</span><span class="tok-p">]</span>
<span class="tok-p">]</span></code></pre></div></div>
<div class="paragraph"><p>In der inneren Liste enthält das jeweils erste Element den Namen der Host-Gruppe und das zweite die Namen der der Gruppe angehörenden Hosts.</p></div>
<div class="paragraph"><p>Diese Informationen können Sie zwar alle ansprechen, aber jeweils nur über ihre Position im Datensatz.
Sie müssten also immer angeben, die wievielte eckige Klammer und den wievielten Inhalt innerhalb der jeweiligen Klammer Sie brauchen.
Bei größeren Datenmengen gestaltet sich dies komplex und es wird immer schwieriger, den Überblick zu behalten.</p></div>
<div class="paragraph"><p>An diesem Punkt bietet die Parse-Funktion durch die von ihr erzeugte Struktur deutliche Vorteile.
Durch sie wird der Code leichter lesbar, die Zugriffe werden performanter und Sie behalten viel einfacher den Überblick.
Sie transformiert die von Checkmk gelieferte Datenstruktur so, dass man jeden der einzelnen Werte wahlfrei durch einen Namen (oder Schlüssel) ansprechen kann und nicht darauf angewiesen ist, den Bereich (<em>array</em>) iterativ zu durchlaufen, um das zu finden, was man sucht:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-p">{</span>
    <span class="tok-s1">'Hamburg'</span><span class="tok-p">:</span> <span class="tok-p">{</span><span class="tok-s1">'members'</span><span class="tok-p">:</span> <span class="tok-s1">'myhost11,myhost22,myhost33'</span><span class="tok-p">},</span>
    <span class="tok-s1">'Munich'</span><span class="tok-p">:</span> <span class="tok-p">{</span><span class="tok-s1">'members'</span><span class="tok-p">:</span> <span class="tok-s1">'myhost1,myhost2,myhost3'</span><span class="tok-p">},</span>
    <span class="tok-s1">'check_mk'</span><span class="tok-p">:</span> <span class="tok-p">{</span><span class="tok-s1">'members'</span><span class="tok-p">:</span> <span class="tok-s1">'localhost'</span><span class="tok-p">}</span>
<span class="tok-p">}</span></code></pre></div></div>
<div class="paragraph"><p>Konvention ist, dass die Parse-Funktion nach der Agentensektion benannt wird und mit <code>parse_</code> beginnt.
Sie bekommt als einziges Argument <code>string_table</code>.
Beachten Sie, dass Sie hier nicht frei in der Wahl des Arguments sind.
Es <em>muss</em> wirklich so heißen.</p></div>
<div class="listingblock">
<div class="title">~/local/lib/check_mk/base/plugins/agent_based/myhostgroups.py</div>
<div class="content"><pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">def</span> <span class="tok-nf">parse_myhostgroups</span><span class="tok-p">(</span><span class="tok-n">string_table</span><span class="tok-p">):</span>
    <span class="tok-c1"># print(string_table)</span>
    <span class="tok-n">parsed</span> <span class="tok-o">=</span> <span class="tok-p">{}</span>
    <span class="tok-k">for</span> <span class="tok-n">line</span> <span class="tok-ow">in</span> <span class="tok-n">string_table</span><span class="tok-p">:</span>
        <span class="tok-n">parsed</span><span class="tok-p">[</span><span class="tok-n">line</span><span class="tok-p">[</span><span class="tok-mi">0</span><span class="tok-p">]]</span> <span class="tok-o">=</span> <span class="tok-p">{</span><span class="tok-s2">"members"</span><span class="tok-p">:</span> <span class="tok-n">line</span><span class="tok-p">[</span><span class="tok-mi">1</span><span class="tok-p">]}</span>
    <span class="tok-c1"># print(parsed)</span>
    <span class="tok-k">return</span> <span class="tok-n">parsed</span></code></pre></div>
</div>
<div class="paragraph"><p>Mit <code>def</code> geben Sie in Python an, dass nachfolgend eine Funktion definiert wird.
<code>parsed = {}</code> erzeugt das <em>Dictionary</em> mit der verbesserten Datenstruktur.
In unserem Beispiel wird jede Zeile Element für Element durchgegangen.
Aus jeder Zeile wird die Host-Gruppe gefolgt von den Mitgliedern der Host-Gruppe genommen und zu einem Eintrag für das Dictionary zusammengesetzt.</p></div>
<div class="paragraph"><p>Mit <code>return parsed</code> wird dann das Dictionary zurückgegeben.</p></div>
<div class="paragraph"><p><strong>Hinweis:</strong> Im oben gezeigten Beispiel finden Sie zwei auskommentierte Zeilen.
Wenn Sie diese später beim <a href="#test">Testen des Check-Plugins</a> einkommentieren, werden Ihnen die Daten vor und nach der Ausführung der Parse-Funktion auf der Kommandozeile angezeigt.
So können Sie überprüfen, ob die Funktion auch wirklich das tut, was sie soll.</p></div>
</div>
<div class="sect2">
<h3 id="heading__die_agentensektion_registrieren">
<span class="hidden-anchor sr-only" id="_die_agentensektion_registrieren"></span>3.3. Die Agentensektion registrieren</h3>
<div class="paragraph"><p>Damit das Ganze auch etwas bewirken kann, müssen Sie die Parse-Funktion, und überhaupt die neue Agentensektion, bei Checkmk bekannt machen.
Dazu rufen Sie eine Registrierfunktion auf:</p></div>
<div class="listingblock">
<div class="title">~/local/lib/check_mk/base/plugins/agent_based/myhostgroups.py</div>
<div class="content"><pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-n">register</span><span class="tok-o">.</span><span class="tok-n">agent_section</span><span class="tok-p">(</span>
    <span class="tok-n">name</span> <span class="tok-o">=</span> <span class="tok-s2">"myhostgroups"</span><span class="tok-p">,</span>
    <span class="tok-n">parse_function</span> <span class="tok-o">=</span> <span class="tok-n">parse_myhostgroups</span><span class="tok-p">,</span>
<span class="tok-p">)</span></code></pre></div>
</div>
<div class="paragraph"><p>Hier ist es wichtig, dass der Name der Sektion wirklich exakt mit dem Sektions-Header in der Agentenausgabe übereinstimmt.
Von diesem Moment an bekommt jedes Check-Plugin, das die Sektion <code>myhostgroups</code> benutzt, den Rückgabewert der Parse-Funktion übergeben.
In der Regel wird das das gleichnamige Check-Plugin sein.
Aber auch andere Check-Plugins können dieses Sektion abonnieren, wie wir bei der <a href="#discovery">Erweiterung des Check-Plugins</a> noch zeigen werden.</p></div>
<div class="paragraph"><p>Übrigens: Wenn Sie es ganz genau wissen wollen, können Sie an dieser Stelle einen Blick in die <a href="#check_api_doc">Check-API-Dokumentation</a> werfen.
Dort finden Sie die detaillierte Beschreibung dieser Registrierfunktion — und auch der Funktionen und Objekte, die später im Artikel noch verwendet werden.</p></div>
<div class="imageblock border"><div class="content"><img src="../images/devel_cpi_checkapi_doc_agent_section.png" alt="Check-API-Dokumentation für die Registrierfunktion 'agent_section'."></div></div>
</div>
<div class="sect2">
<h3 id="heading_register_check_plug-in">
<span class="hidden-anchor sr-only" id="register_check_plug-in"></span>3.4. Das Check-Plugin registrieren</h3>
<div class="paragraph"><p>Damit Checkmk weiß, dass es ein neues Check-Plugin gibt, muss dieses registriert werden.
Dies geschieht durch den Aufruf der Funktion <code>register.check_plugin</code>.
Dabei müssen Sie immer mindestens vier Dinge angeben:</p></div>
<div class="olist arabic"><ol class="arabic">
<li><p><code>name</code>: Der Name des Check-Plugins.
Am einfachsten ist es, wenn Sie hier den gleichen Namen wie bei Ihrer neuen Agentensektion nehmen.
Damit weiß der später in der Check-Funktion definierte Check automatisch, welche Sektion er auswerten soll.</p></li>
<li><p><code>service_name</code>:
Der Name des Services wie er dann im Monitoring erscheinen soll.</p></li>
<li><p><code>discovery_function</code>:
Die Funktion zum Erkennen von Services dieses Typs (dazu gleich mehr).</p></li>
<li><p><code>check_funktion</code>:
Die Funktion zum Durchführen des eigentlichen Checks (auch dazu gleich mehr).</p></li>
</ol></div>
<div class="paragraph"><p>Für das Check-Plugin sieht das dann also so aus:</p></div>
<div class="listingblock">
<div class="title">~/local/lib/check_mk/base/plugins/agent_based/myhostgroups.py</div>
<div class="content"><pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-n">register</span><span class="tok-o">.</span><span class="tok-n">check_plugin</span><span class="tok-p">(</span>
    <span class="tok-n">name</span> <span class="tok-o">=</span> <span class="tok-s2">"myhostgroups"</span><span class="tok-p">,</span>
    <span class="tok-n">service_name</span> <span class="tok-o">=</span> <span class="tok-s2">"Host group check_mk"</span><span class="tok-p">,</span>
    <span class="tok-n">discovery_function</span> <span class="tok-o">=</span> <span class="tok-n">discover_myhostgroups</span><span class="tok-p">,</span>
    <span class="tok-n">check_function</span> <span class="tok-o">=</span> <span class="tok-n">check_myhostgroups</span><span class="tok-p">,</span>
<span class="tok-p">)</span></code></pre></div>
</div>
<div class="paragraph"><p>Versuchen Sie am besten noch nicht, das gleich auszuprobieren, denn Sie müssen die Funktionen <code>discover_myhostgroups</code> und <code>check_myhostgroups</code> vorher noch schreiben.
Und diese müssen im Quellcode <em>vor</em> obiger Registrierung erscheinen.</p></div>
</div>
<div class="sect2">
<h3 id="heading_discovery_function">
<span class="hidden-anchor sr-only" id="discovery_function"></span>3.5. Die Discovery-Funktion schreiben</h3>
<div class="paragraph"><p>Eine Besonderheit von Checkmk ist die automatische Erkennung von zu überwachenden Services.
Damit dies klappt, muss jedes Check-Plugin eine Funktion definieren, welche anhand der Agentenausgabe erkennt, <em>ob</em> ein Service dieses Typs bzw. <em>welche</em> Services des Typs für den betreffenden Host angelegt werden sollen.</p></div>
<div class="paragraph"><p>Die Discovery-Funktion wird immer dann aufgerufen, wenn für einen Host die Service-Erkennung durchgeführt wird.
Sie entscheidet dann ob, bzw. welche Services angelegt werden sollen.
Im Standardfall bekommt sie genau ein Argument mit dem Namen <code>section</code>.
Dieses enthält die Daten der Agentensektion in einem durch die <a href="#parsefunction">Parse-Funktion</a> aufbereiteten Format.</p></div>
<div class="paragraph"><p>Daher implementieren Sie folgende simple Logik:
<em>Wenn</em> die Agentensektion <code>myhostgroups</code> vorhanden ist, dann legen Sie auch einen passenden Service an.
Dann erscheint dieser automatisch auf allen Hosts, auf denen das Agentenplugin verteilt ist.</p></div>
<div class="paragraph"><p>Bei Check-Plugins, die pro Host nur einen Service erzeugen, benötigt man keine weiteren Angaben:</p></div>
<div class="listingblock">
<div class="title">~/local/lib/check_mk/base/plugins/agent_based/myhostgroups.py</div>
<div class="content"><pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">def</span> <span class="tok-nf">discover_myhostgroups</span><span class="tok-p">(</span><span class="tok-n">section</span><span class="tok-p">):</span>
    <span class="tok-k">yield</span> <span class="tok-n">Service</span><span class="tok-p">()</span></code></pre></div>
</div>
<div class="paragraph"><p>Die Discovery-Funktion muss für jeden anzulegenden Service mittels <code>yield</code> ein Objekt vom Typ <code>Service</code> zurückgeben (nicht mit <code>return</code>).
<code>yield</code> hat in Python die gleiche Aufgabe wie <code>return</code> – beide geben einen Wert an die aufrufende Funktion zurück.
Der entscheidende Unterschied besteht darin, dass sich bei einem <code>yield</code> gemerkt wird, wie weit die Funktion in einer Datenverarbeitung gekommen ist.
Beim nächsten Aufruf wird <em>nach</em> der letzten <code>yield</code>-Anweisung weiter gemacht - und nicht wieder am Anfang begonnen.
Dadurch wird nicht nur der erste Treffer ausgelesen (wie es beim <code>return</code> der Fall wäre), sondern sukzessive alle Treffer (dieser Vorteil wird später in unserem Beispiel bei der <a href="#discovery">Service-Erkennung</a> noch relevant).</p></div>
</div>
<div class="sect2">
<h3 id="heading_check_function">
<span class="hidden-anchor sr-only" id="check_function"></span>3.6. Die Check-Funktion schreiben</h3>
<div class="paragraph"><p>Somit können Sie nun zur eigentlichen Check-Funktion kommen, welche anhand der aktuellen Agentenausgabe entscheidet, welchen Zustand der Service annehmen soll und weitere Informationen ausgeben kann.</p></div>
<div class="paragraph"><p>Ziel der Check-Funktion ist es, eine Prüfung aufzusetzen, mit der kontrolliert werden kann, ob für keinen Host vergessen wurde, eine Host-Gruppe zuzuweisen.
Dazu wird überprüft, ob die Host-Gruppe <code>check_mk</code> Hosts enthält.
Wenn das der Fall ist, soll der Service den Zustand <span class="state2">CRIT</span> erhalten.
Wenn nicht, ist alles <span class="state0">OK</span> und der Zustand des Services auch.</p></div>
<div class="paragraph"><p>Hier ist die Implementierung:</p></div>
<div class="listingblock">
<div class="title">~/local/lib/check_mk/base/plugins/agent_based/myhostgroups.py</div>
<div class="content"><pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">def</span> <span class="tok-nf">check_myhostgroups</span><span class="tok-p">(</span><span class="tok-n">section</span><span class="tok-p">):</span>
    <span class="tok-n">attr</span> <span class="tok-o">=</span> <span class="tok-n">section</span><span class="tok-o">.</span><span class="tok-n">get</span><span class="tok-p">(</span><span class="tok-s2">"check_mk"</span><span class="tok-p">)</span>
    <span class="tok-n">hosts</span> <span class="tok-o">=</span> <span class="tok-n">attr</span><span class="tok-p">[</span><span class="tok-s2">"members"</span><span class="tok-p">]</span> <span class="tok-k">if</span> <span class="tok-n">attr</span> <span class="tok-k">else</span> <span class="tok-s2">""</span>
    <span class="tok-k">if</span> <span class="tok-n">hosts</span><span class="tok-p">:</span>
        <span class="tok-k">yield</span> <span class="tok-n">Result</span><span class="tok-p">(</span><span class="tok-n">state</span><span class="tok-o">=</span><span class="tok-n">State</span><span class="tok-o">.</span><span class="tok-n">CRIT</span><span class="tok-p">,</span> <span class="tok-n">summary</span><span class="tok-o">=</span><span class="tok-sa">f</span><span class="tok-s2">"Default group is not empty; Current member list: </span><span class="tok-si">{</span><span class="tok-n">hosts</span><span class="tok-si">}</span><span class="tok-s2">"</span><span class="tok-p">)</span>
    <span class="tok-k">else</span><span class="tok-p">:</span>
        <span class="tok-k">yield</span> <span class="tok-n">Result</span><span class="tok-p">(</span><span class="tok-n">state</span><span class="tok-o">=</span><span class="tok-n">State</span><span class="tok-o">.</span><span class="tok-n">OK</span><span class="tok-p">,</span> <span class="tok-n">summary</span><span class="tok-o">=</span><span class="tok-s2">"Everything is fine"</span><span class="tok-p">)</span></code></pre></div>
</div>
<div class="paragraph"><p>Und nun die Erklärung dazu:
Die Funktion <code>check_myhostgroups()</code> holt als erstes den zum Schlüssel <code>check_mk</code> gehörenden Wert in die Variable <code>attr</code>.
Dann wird die Variable <code>hosts</code> mit dem <code>members</code>-Wert verknüpft, wenn dieser vorhanden ist.
Gibt es keine <code>members</code>, so bleibt <code>hosts</code> leer.</p></div>
<div class="paragraph"><p>Jetzt folgt eine <code>if</code>-Abfrage für die eigentliche Auswertung:</p></div>
<div class="ulist"><ul>
<li><p>Enthält die Variable <code>hosts</code> Inhalte, ist also die Host-Gruppe <code>check_mk</code> nicht leer, so geht der Status des Services auf <span class="state2">CRIT</span> und es wird ein Hinweistext ausgegeben.
Dieser enthält zusätzlich eine Auflistung der Host-Namen aller Hosts, die sich in der Host-Gruppe <code>check_mk</code> befinden.
Für die Ausgabe des Textes mit Ausdrücken wird der Python <a href="https://docs.python.org/3/tutorial/inputoutput.html#formatted-string-literals" target="_blank">F-String</a> verwendet, der so heißt, weil vor der String-Zeichenfolge der Buchstabe <code>f</code> steht.</p></li>
<li><p>Ist die Variable <code>hosts</code> leer, sind also keine Hosts in der Host-Gruppe <code>check_mk</code>, so geht stattdessen der Status des Services auf <span class="state0">OK</span>.
Dann wird zudem ein passender Hinweistext ausgegeben.</p></li>
</ul></div>
<div class="paragraph"><p>Mit der Erstellung der Check-Funktion ist das Check-Plugin fertig.</p></div>
<div class="paragraph"><p>Das <a href="https://github.com/Checkmk/checkmk-docs/blob/2.2.0/examples/devel_check_plugins/check_plugin_simple_myhostgroups.py" target="_blank">Check-Plugin</a>
und auch das <a href="https://github.com/Checkmk/checkmk-docs/blob/2.2.0/examples/devel_check_plugins/agent_plugin_simple_myhostgroups" target="_blank">Agentenplugin</a>
haben wir auf GitHub bereitgestellt.</p></div>
</div>
<div class="sect2">
<h3 id="heading_test">
<span class="hidden-anchor sr-only" id="test"></span>3.7. Das Check-Plugin testen und aktivieren</h3>
<div class="paragraph"><p>Test und Aktivierung werden auf der Kommandozeile mit dem Befehl <code>cmk</code> erledigt.</p></div>
<div class="paragraph"><p>Probieren Sie zunächst die <a href="wato_services.html#commandline">Service-Erkennung</a> mit der Option <code>-I</code> aus.
Durch Zugabe der Option <code>v</code> (für <em>verbose</em>) werden ausführliche Ausgaben angefordert.
Das <code>--detect-plugins</code> beschränkt die Befehlsausführung auf dieses Check-Plugin und durch <code>localhost</code> auf eben diesen Host:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="console"><span></span><span class="tok-gp">OMD[mysite]:~$ </span>cmk<span class="tok-w"> </span>-vI<span class="tok-w"> </span>--detect-plugins<span class="tok-o">=</span>myhostgroups<span class="tok-w"> </span>localhost
<span class="tok-go">Discovering services and host labels on: localhost</span>
<span class="tok-go">localhost:</span>
<span class="tok-go">+ FETCHING DATA</span>
<span class="tok-go">[TCPFetcher] Execute data source</span>
<span class="tok-go">[PiggybackFetcher] Execute data source</span>
<span class="tok-go">No piggyback files for 'localhost'. Skip processing.</span>
<span class="tok-go">No piggyback files for '127.0.0.1'. Skip processing.</span>
<span class="tok-go">+ ANALYSE DISCOVERED HOST LABELS</span>
<span class="tok-go">SUCCESS - Found no new host labels</span>
<span class="tok-go">+ ANALYSE DISCOVERED SERVICES</span>
<span class="hll"><span class="tok-go">+ EXECUTING DISCOVERY PLUGINS (1)</span>
</span><span class="hll"><span class="tok-go">  1 myhostgroups</span>
</span><span class="hll"><span class="tok-go">SUCCESS - Found 1 services</span>
</span></code></pre></div></div>
<div class="paragraph"><p>Wie geplant, erkennt die Service-Erkennung einen neuen Service im Check-Plugin <code>myhostgroups</code>.</p></div>
<div class="paragraph"><p>Jetzt können Sie den im Check-Plugin enthaltenen <a href="cmk_commandline.html#execute_checks">Check ausprobieren:</a></p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="console"><span></span><span class="tok-gp">OMD[mysite]:~$ </span>cmk<span class="tok-w"> </span>--detect-plugins<span class="tok-o">=</span>myhostgroups<span class="tok-w"> </span>-v<span class="tok-w"> </span>localhost
<span class="tok-go">+ FETCHING DATA</span>
<span class="tok-go">[TCPFetcher] Execute data source</span>
<span class="tok-go">[PiggybackFetcher] Execute data source</span>
<span class="tok-go">No piggyback files for 'localhost'. Skip processing.</span>
<span class="tok-go">No piggyback files for '127.0.0.1'. Skip processing.</span>
<span class="hll"><span class="tok-go">Host group check_mk   <span class="red">Default group is not empty; Current member list: localhost</span></span>
</span><span class="tok-go">[agent] Success, [piggyback] Success (but no data found for this host), execution time 1.3 sec | execution_time=1.330 user_time=0.010 system_time=0.000 children_user_time=0.000 children_system_time=0.000 cmk_time_agent=1.330</span></code></pre></div></div>
<div class="paragraph"><p>Durch Ausführung des Checks wird der Zustand des zuvor gefundenen Services bestimmt.</p></div>
<div class="paragraph"><p>Wenn soweit alles wie erwartet abgelaufen ist, können Sie die Änderungen aktivieren.
Falls nicht, finden Sie im Kapitel zur <a href="#errors">Fehlerbehebung</a> Hinweise.</p></div>
<div class="paragraph"><p>Aktivieren Sie zum Abschluss die Änderungen durch einen <a href="cmk_commandline.html#commands_core">Neustart des Monitoring-Kerns:</a></p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="console"><span></span><span class="tok-gp">OMD[mysite]:~$ </span>cmk<span class="tok-w"> </span>-R
<span class="tok-go">Generating configuration for core (type nagios)...</span>
<span class="tok-go">Precompiling host checks...OK</span>
<span class="tok-go">Validating Nagios configuration...OK</span>
<span class="tok-go">Restarting monitoring core...OK</span></code></pre></div></div>
<div class="paragraph"><p>Im Monitoring von Checkmk finden Sie nun beim Host <code>localhost</code> den neuen Service <span class="guihint">Host group check_mk:</span></p></div>
<div class="imageblock">
<div class="content"><img src="../images/devel_cpi_service_simple.png" alt="Der vom Check-Plugin erzeugte neue Service im Monitoring."></div>
<div class="title">Da die Host-Gruppe <code>check_mk</code> nicht leer ist, ist der Service <span class="state2">CRIT</span>
</div>
</div>
<div class="paragraph"><p>Wir gratulieren Ihnen zur erfolgreichen Erstellung des ersten Check-Plugins!</p></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="heading_extend">
<span class="hidden-anchor sr-only" id="extend"></span>4. Das Check-Plugin erweitern</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="heading_prepare">
<span class="hidden-anchor sr-only" id="prepare"></span>4.1. Vorbereitungen</h3>
<div class="paragraph"><p>Das gerade frisch fertiggestellte erste Check-Plugin soll nun schrittweise erweitert werden.
Bisher hat das Agentenplugin nur die Informationen über die Namen und die Mitglieder der Host-Gruppen geliefert.
Um etwa die Zustände der Hosts und der auf ihnen laufenden Services auswerten zu können, braucht es mehr Daten.</p></div>
<div class="sect3">
<h4 id="heading__agentenplugin_erweitern">
<span class="hidden-anchor sr-only" id="_agentenplugin_erweitern"></span>Agentenplugin erweitern</h4>
<div class="paragraph"><p>Sie werden zunächst das Agentenplugin <em>einmal</em> erweitern, um all die Informationen einzusammeln, die für die Erweiterung des Check-Plugins in den nächsten Abschnitten benötigt werden.</p></div>
<div class="paragraph"><p>Um herauszubekommen, welche Informationen Checkmk denn für Host-Gruppen so bietet,
können Sie alle verfügbaren Spalten der Host-Gruppentabelle mit <a href="livestatus.html#columns">folgendem Befehl</a> als Instanzbenutzer abfragen:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="console"><span></span><span class="tok-gp">OMD[mysite]:~$ </span>lq<span class="tok-w"> </span><span class="tok-s2">"GET columns\nFilter: table = hostgroups\nColumns: name"</span>
<span class="tok-go">action_url</span>
<span class="tok-go">alias</span>
<span class="tok-go">members</span>
<span class="tok-go">members_with_state</span>
<span class="tok-go">name</span>
<span class="tok-go">notes</span>
<span class="tok-go">notes_url</span>
<span class="tok-go">num_hosts</span>
<span class="tok-go">...</span></code></pre></div></div>
<div class="paragraph"><p>Die Ausgabe geht noch weiter.
Fast 30 Spalten bietet die Tabelle — und unter den meisten Spaltennamen kann man sich sogar etwas vorstellen.
Hier interessieren die folgenden Spalten:
Anzahl der Hosts pro Gruppe (Spalte <code>num_hosts</code>), Anzahl der Hosts im Zustand <span class="hstate0">UP</span> (<code>num_hosts_up</code>), Anzahl der Services aller Hosts in der Gruppe (<code>num_services</code>) und Anzahl der Services im Zustand <span class="state0">OK</span> (<code>num_services_ok</code>).</p></div>
<div class="paragraph"><p>Jetzt müssen diese neuen Spalten nur noch vom Agenten geliefert werden.
Das erreichen Sie durch Erweiterung des im vorherigen Kapitel erstellten <a href="#agentplugin">Agentenplugins.</a></p></div>
<div class="paragraph"><p>Editieren Sie als root-Benutzer das Skript des Agentenplugins.
Da das Skript die konfigurierbaren Werte bereits in Variablen gesteckt hat, reicht es aus, nur die mit <code>columns</code> beginnende Zeile zu ändern und dort die zusätzlich abgerufenen vier Spalten einzutragen:</p></div>
<div class="listingblock">
<div class="title">/usr/lib/check_mk_agent/plugins/myhostgroups</div>
<div class="content"><pre class="pygments highlight"><code><span></span>#!/bin/bash

<span class="hll">columns="name members num_hosts num_hosts_up num_services num_services_ok"
</span>site="mysite"

echo '&lt;&lt;&lt;myhostgroups:sep(59)&gt;&gt;&gt;'
su - ${site} lq "GET hostgroups\nColumns: ${columns}"</code></pre></div>
</div>
<div class="paragraph"><p>Führen Sie zur Kontrolle das Skript aus:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="console"><span></span><span class="tok-gp">root@linux# </span>/usr/lib/check_mk_agent/plugins/myhostgroups
<span class="tok-go">&lt;&lt;&lt;myhostgroups:sep(59)&gt;&gt;&gt;</span>
<span class="tok-go">Munich;myhost3,myhost2,myhost1;3;3;180;144</span>
<span class="tok-go">Hamburg;myhost22,myhost33,myhost11;3;2;132;105</span>
<span class="tok-go">check_mk;SQL-Server,localhost;2;2;95;83</span></code></pre></div></div>
<div class="paragraph"><p>Am Ende jeder Zeile stehen nun, durch Semikolon abgetrennt, die vier neuen Werte.</p></div>
<div class="paragraph"><p>Mit dieser Änderung liefert das Agentenplugin nun andere Daten als vorher.
An dieser Stelle ist es wichtig, sich zu vergewissern, dass das Check-Plugin auch mit den geänderten Daten immer noch das tut, was es soll.</p></div>
</div>
<div class="sect3">
<h4 id="heading__parse_funktion_erweitern">
<span class="hidden-anchor sr-only" id="_parse_funktion_erweitern"></span>Parse-Funktion erweitern</h4>
<div class="paragraph"><p>Im Check-Plugin ist die Parse-Funktion für die Umwandlung der vom Agentenplugin gelieferten Daten verantwortlich.
Beim <a href="#parsefunction">Schreiben der Parse-Funktion</a> haben Sie nur zwei Spalten der Host-Gruppentabelle berücksichtigt.
Nun werden sechs statt zwei Spalten geliefert.
Die Parse-Funktion muss also fit gemacht werden, um auch die zusätzlichen vier Spalten zu verarbeiten.</p></div>
<div class="paragraph"><p>Ändern Sie als Instanzbenutzer die Parse-Funktion in der Datei <code>myhostgroups.py</code>, die das Check-Plugin enthält:</p></div>
<div class="listingblock">
<div class="title">~/local/lib/check_mk/base/plugins/agent_based/myhostgroups.py</div>
<div class="content"><pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">def</span> <span class="tok-nf">parse_myhostgroups</span><span class="tok-p">(</span><span class="tok-n">string_table</span><span class="tok-p">):</span>
    <span class="tok-n">parsed</span> <span class="tok-o">=</span> <span class="tok-p">{}</span>
<span class="hll">    <span class="tok-n">column_names</span> <span class="tok-o">=</span> <span class="tok-p">[</span>
</span><span class="hll">        <span class="tok-s2">"name"</span><span class="tok-p">,</span>
</span><span class="hll">        <span class="tok-s2">"members"</span><span class="tok-p">,</span>
</span><span class="hll">        <span class="tok-s2">"num_hosts"</span><span class="tok-p">,</span>
</span><span class="hll">        <span class="tok-s2">"num_hosts_up"</span><span class="tok-p">,</span>
</span><span class="hll">        <span class="tok-s2">"num_services"</span><span class="tok-p">,</span>
</span><span class="hll">        <span class="tok-s2">"num_services_ok"</span><span class="tok-p">,</span>
</span><span class="hll">    <span class="tok-p">]</span>
</span><span class="hll">    <span class="tok-k">for</span> <span class="tok-n">line</span> <span class="tok-ow">in</span> <span class="tok-n">string_table</span><span class="tok-p">:</span>
</span><span class="hll">        <span class="tok-n">parsed</span><span class="tok-p">[</span><span class="tok-n">line</span><span class="tok-p">[</span><span class="tok-mi">0</span><span class="tok-p">]]</span> <span class="tok-o">=</span> <span class="tok-p">{}</span>
</span><span class="hll">        <span class="tok-k">for</span> <span class="tok-n">n</span> <span class="tok-ow">in</span> <span class="tok-nb">range</span><span class="tok-p">(</span><span class="tok-mi">1</span><span class="tok-p">,</span> <span class="tok-nb">len</span><span class="tok-p">(</span><span class="tok-n">column_names</span><span class="tok-p">)):</span>
</span><span class="hll">            <span class="tok-n">parsed</span><span class="tok-p">[</span><span class="tok-n">line</span><span class="tok-p">[</span><span class="tok-mi">0</span><span class="tok-p">]][</span><span class="tok-n">column_names</span><span class="tok-p">[</span><span class="tok-n">n</span><span class="tok-p">]]</span> <span class="tok-o">=</span> <span class="tok-n">line</span><span class="tok-p">[</span><span class="tok-n">n</span><span class="tok-p">]</span>
</span>    <span class="tok-k">return</span> <span class="tok-n">parsed</span></code></pre></div>
</div>
<div class="paragraph"><p>Geändert wurde hier alles zwischen <code>parsed = {}</code> und <code>return parsed</code>.
Zuerst werden die zu verarbeitenden Spalten unter ihren Namen als Liste <code>column_names</code> definiert.
In der <code>for</code>-Schleife wird dann ein Dictionary aufgebaut, indem in jeder Zeile aus Spaltenname und ausgelesenem Wert die Schlüssel-Wert-Paare erzeugt werden.</p></div>
<div class="paragraph"><p>Für die existierende <a href="#check_function">Check-Funktion</a> ist diese Erweiterung unkritisch, denn die Datenstruktur für die ersten beiden Spalten bleibt unverändert.
Es werden nur zusätzliche Spalten bereitgestellt, die in der Check-Funktion (noch) gar nicht ausgewertet werden.</p></div>
<div class="paragraph"><p>Nun, da die neuen Daten verarbeitet werden können, werden Sie sie auch nutzen.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="heading_discovery">
<span class="hidden-anchor sr-only" id="discovery"></span>4.2. Service-Erkennung</h3>
<div class="paragraph"><p>Im Beispiel haben Sie einen sehr einfachen Check gebaut, der auf einem Host einen Service erzeugt.
Ein sehr üblicher Fall ist aber auch, dass es von einem Check mehrere Services auf einem Host geben kann.</p></div>
<div class="paragraph"><p>Das häufigste Beispiel dafür sind die Dateisysteme eines Hosts.
Das Check-Plugin mit dem Namen <code>df</code> legt pro Dateisystem auf dem Host einen Service an.
Um diese Services zu unterscheiden, wird der Mount-Punkt des Dateisystems (zum Beispiel <code>/var</code>) bzw. der Laufwerksbuchstabe (zum Beispiel <code>C:</code>) in den Namen des Services eingebaut.
Das ergibt dann als Service-Name zum Beispiel <code>Filesystem /var</code> oder <code>Filesystem C:</code>.
Das Wort <code>/var</code> bzw. <code>C:</code> wird hier als <em>Item</em> bezeichnet.
Wir sprechen also auch von einem <em>Check mit Items.</em></p></div>
<div class="paragraph"><p>Wenn Sie einen Check mit Items bauen möchten, müssen Sie folgende Dinge umsetzen:</p></div>
<div class="ulist"><ul>
<li><p>Die Discovery-Funktion muss für jedes der Items, die auf dem Host sinnvollerweise überwacht werden sollen, einen Service generieren.</p></li>
<li><p>Im Service-Namen müssen Sie das Item mithilfe des Platzhalters <code>%s</code> einbauen (also zum Beispiel <code>"Filesystem %s"</code>).</p></li>
<li><p>Die Check-Funktion wird pro Item einmal separat aufgerufen und bekommt dieses als Argument.
Sie muss dann aus den Agentendaten die für dieses Item relevanten Daten herausfischen.</p></li>
</ul></div>
<div class="paragraph"><p>Um dies praktisch auszuprobieren, werden Sie für jede existierende Host-Gruppe einen eigenen Service erzeugen.</p></div>
<div class="paragraph"><p>Da das im vorherigen Kapitel erstellte Check-Plugin <code>myhostgroups</code> zur Überprüfung der Standardgruppe <code>check_mk</code> weiterhin funktionieren soll, bleibt dieses Check-Plugin so, wie es ist.
Für die Erweiterung erstellen Sie in der Datei <code>myhostgroups.py</code> ein neues Check-Plugin — im ersten Schritt so wie <a href="#register_check_plug-in">zuvor</a> durch die Registrierung des Plugins.</p></div>
<div class="paragraph"><p><strong>Wichtig:</strong> Die neue Registrierung wird zusätzlich zur bereits vorhandenen vorgenommen, die im <a href="#write_check_plugin">vorherigen Kapitel</a> gezeigte bleibt unverändert enthalten.
Hier nur der <em>neue</em> Code:</p></div>
<div class="listingblock">
<div class="title">~/local/lib/check_mk/base/plugins/agent_based/myhostgroups.py</div>
<div class="content"><pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-o">...</span>

<span class="tok-n">register</span><span class="tok-o">.</span><span class="tok-n">check_plugin</span><span class="tok-p">(</span>
    <span class="tok-n">name</span> <span class="tok-o">=</span> <span class="tok-s2">"myhostgroups_advanced"</span><span class="tok-p">,</span>
    <span class="tok-n">sections</span> <span class="tok-o">=</span> <span class="tok-p">[</span><span class="tok-s2">"myhostgroups"</span><span class="tok-p">],</span>
    <span class="tok-n">service_name</span> <span class="tok-o">=</span> <span class="tok-s2">"Host group </span><span class="tok-si">%s</span><span class="tok-s2">"</span><span class="tok-p">,</span>
    <span class="tok-n">discovery_function</span> <span class="tok-o">=</span> <span class="tok-n">discover_myhostgroups_advanced</span><span class="tok-p">,</span>
    <span class="tok-n">check_function</span> <span class="tok-o">=</span> <span class="tok-n">check_myhostgroups_advanced</span><span class="tok-p">,</span>
<span class="tok-p">)</span></code></pre></div>
</div>
<div class="paragraph"><p>Damit man das neue vom alten Check-Plugin unterscheiden kann, erhält es mit <code>myhostgroups_advanced</code> einen eindeutigen Namen.
Der Parameter <code>sections</code> bestimmt die Sektionen der Agentenausgabe, die das Check-Plugin abonniert.
Mit <code>myhostgroups</code> wird hier festgelegt, dass das neue Check-Plugin die gleichen Daten nutzt wie das alte: die durch die Parse-Funktion aufbereitete Sektion des Agentenplugins.
Der Service-Name enthält jetzt den Platzhalter <code>%s</code>.
An dieser Stelle wird später dann von Checkmk der Name des Items eingesetzt.
In den letzten beiden Zeilen werden schließlich die Namen für die neue Discovery-Funktion und die neue Check-Funktion festgelegt, die beide noch geschrieben werden wollen.</p></div>
<div class="paragraph"><p>Zuerst zur Discovery-Funktion, die jetzt die Aufgabe hat, die zu überwachenden Items zu ermitteln – auch diese wird zusätzlich zur vorhandenen eingetragen:</p></div>
<div class="listingblock">
<div class="title">~/local/lib/check_mk/base/plugins/agent_based/myhostgroups.py</div>
<div class="content"><pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">def</span> <span class="tok-nf">discover_myhostgroups_advanced</span><span class="tok-p">(</span><span class="tok-n">section</span><span class="tok-p">):</span>
    <span class="tok-k">for</span> <span class="tok-n">group</span> <span class="tok-ow">in</span> <span class="tok-n">section</span><span class="tok-p">:</span>
        <span class="tok-k">if</span> <span class="tok-n">group</span> <span class="tok-o">!=</span> <span class="tok-s2">"check_mk"</span><span class="tok-p">:</span>
            <span class="tok-k">yield</span> <span class="tok-n">Service</span><span class="tok-p">(</span><span class="tok-n">item</span><span class="tok-o">=</span><span class="tok-n">group</span><span class="tok-p">)</span></code></pre></div>
</div>
<div class="paragraph"><p>Wie <a href="#discovery_function">zuvor</a> bekommt die Discovery-Funktion das Argument <code>section</code>.
Mit einer Schleife werden die einzelnen Host-Gruppen durchlaufen.
Hier interessieren alle Host-Gruppen — mit Ausnahme von <code>check_mk</code>, denn um diese spezielle Host-Gruppe kümmert sich bereits das existierende Check-Plugin <code>myhostgroups</code>.
Immer, wenn ein Item gefunden wurde, wird es mit <code>yield</code> zurück gegeben, wobei ein Objekt vom Typ <code>Service</code> erzeugt wird, das den Host-Gruppennamen als Item übergeben bekommt.</p></div>
<div class="paragraph"><p>Wenn später der Host überwacht wird, dann wird die Check-Funktion für jeden Service — und damit für jedes Item — separat aufgerufen.
Womit Sie bereits bei der Definition der Check-Funktion für das neue Check-Plugin <code>myhostgroups_advanced</code> angekommen sind.
Die Check-Funktion bekommt zusätzlich zur Sektion das Argument <code>item</code> übergeben.
Die erste Zeile der Funktion sieht dann so aus:</p></div>
<div class="listingblock">
<div class="title">~/local/lib/check_mk/base/plugins/agent_based/myhostgroups.py</div>
<div class="content"><pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">def</span> <span class="tok-nf">check_myhostgroups_advanced</span><span class="tok-p">(</span><span class="tok-n">item</span><span class="tok-p">,</span> <span class="tok-n">section</span><span class="tok-p">):</span></code></pre></div>
</div>
<div class="paragraph"><p>Der Algorithmus für die Check-Funktion ist einfach:
Wenn die Host-Gruppe existiert, wird der Service auf <span class="state0">OK</span> gesetzt und Anzahl und Namen der Hosts in der Gruppe aufgelistet.
Die komplette Funktion dazu:</p></div>
<div class="listingblock">
<div class="title">~/local/lib/check_mk/base/plugins/agent_based/myhostgroups.py</div>
<div class="content"><pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">def</span> <span class="tok-nf">check_myhostgroups_advanced</span><span class="tok-p">(</span><span class="tok-n">item</span><span class="tok-p">,</span> <span class="tok-n">section</span><span class="tok-p">):</span>
    <span class="tok-n">attr</span> <span class="tok-o">=</span> <span class="tok-n">section</span><span class="tok-o">.</span><span class="tok-n">get</span><span class="tok-p">(</span><span class="tok-n">item</span><span class="tok-p">)</span>
    <span class="tok-k">if</span> <span class="tok-n">attr</span><span class="tok-p">:</span>
        <span class="tok-k">yield</span> <span class="tok-n">Result</span><span class="tok-p">(</span><span class="tok-n">state</span><span class="tok-o">=</span><span class="tok-n">State</span><span class="tok-o">.</span><span class="tok-n">OK</span><span class="tok-p">,</span> <span class="tok-n">summary</span><span class="tok-o">=</span><span class="tok-sa">f</span><span class="tok-s2">"</span><span class="tok-si">{</span><span class="tok-n">attr</span><span class="tok-p">[</span><span class="tok-s1">'num_hosts'</span><span class="tok-p">]</span><span class="tok-si">}</span><span class="tok-s2"> hosts in this group: </span><span class="tok-si">{</span><span class="tok-n">attr</span><span class="tok-p">[</span><span class="tok-s1">'members'</span><span class="tok-p">]</span><span class="tok-si">}</span><span class="tok-s2">"</span><span class="tok-p">)</span></code></pre></div>
</div>
<div class="paragraph"><p>Das Check-Ergebnis wird geliefert, indem ein Objekt der Klasse <code>Result</code> per <code>yield</code> zurückgeben wird.
Dieses benötigt die Parameter <code>state</code> und <code>summary</code>.
Dabei legt <code>state</code> den Zustand des Services fest (im Beispiel <code>OK</code>) und <code>summary</code> den Text, der in dem <span class="guihint">Summary</span> des Services angezeigt wird.
Er ist rein informativ und wird von Checkmk nicht weiter ausgewertet.
Mehr dazu erfahren Sie im <a href="#summary_details">nächsten Abschnitt.</a></p></div>
<div class="paragraph"><p>So weit, so gut.
Was passiert aber, wenn das gesuchte Item nicht gefunden wird?
Das kann passieren, wenn in der Vergangenheit ein Service für eine Host-Gruppe bereits erzeugt wurde, diese Host-Gruppe aber nun verschwunden ist — entweder weil die Host-Gruppe in Checkmk noch existiert, aber keinen Host mehr enthält, oder weil sie gleich ganz gelöscht wurde.
In beiden Fällen ist diese Host-Gruppe in der Agentenausgabe nicht (mehr) präsent.</p></div>
<div class="paragraph"><p>Die gute Nachricht:
Checkmk kümmert sich darum!
Wird ein gesuchtes Item nicht gefunden, so erzeugt Checkmk <em>automatisch</em> für den Service das Resultat <code>UNKNOWN - Item not found in monitoring data</code>.
Das ist so gewollt und gut so.
Wenn ein gesuchtes Item nicht gefunden wird, so können Sie Python einfach aus der Funktion herauslaufen und Checkmk seine Arbeit erledigen lassen.</p></div>
<div class="paragraph"><p>Checkmk weiß nur, dass das Item, das vorher da war, nun weg ist.
Den Grund dafür kennt Checkmk nicht — Sie aber schon.
Darum ist es legitim, Ihr Wissen nicht für sich zu behalten und diesen Fall in der Check-Funktion abzufangen und dabei eine hilfreiche Meldung ausgeben zu lassen.</p></div>
<div class="listingblock">
<div class="title">~/local/lib/check_mk/base/plugins/agent_based/myhostgroups.py</div>
<div class="content"><pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">def</span> <span class="tok-nf">check_myhostgroups_advanced</span><span class="tok-p">(</span><span class="tok-n">item</span><span class="tok-p">,</span> <span class="tok-n">section</span><span class="tok-p">):</span>
    <span class="tok-n">attr</span> <span class="tok-o">=</span> <span class="tok-n">section</span><span class="tok-o">.</span><span class="tok-n">get</span><span class="tok-p">(</span><span class="tok-n">item</span><span class="tok-p">)</span>
<span class="hll">    <span class="tok-k">if</span> <span class="tok-ow">not</span> <span class="tok-n">attr</span><span class="tok-p">:</span>
</span><span class="hll">        <span class="tok-k">yield</span> <span class="tok-n">Result</span><span class="tok-p">(</span><span class="tok-n">state</span><span class="tok-o">=</span><span class="tok-n">State</span><span class="tok-o">.</span><span class="tok-n">CRIT</span><span class="tok-p">,</span> <span class="tok-n">summary</span><span class="tok-o">=</span><span class="tok-s2">"Group is empty or has been deleted"</span><span class="tok-p">)</span>
</span><span class="hll">        <span class="tok-k">return</span>
</span>
    <span class="tok-k">yield</span> <span class="tok-n">Result</span><span class="tok-p">(</span><span class="tok-n">state</span><span class="tok-o">=</span><span class="tok-n">State</span><span class="tok-o">.</span><span class="tok-n">OK</span><span class="tok-p">,</span> <span class="tok-n">summary</span><span class="tok-o">=</span><span class="tok-sa">f</span><span class="tok-s2">"</span><span class="tok-si">{</span><span class="tok-n">attr</span><span class="tok-p">[</span><span class="tok-s1">'num_hosts'</span><span class="tok-p">]</span><span class="tok-si">}</span><span class="tok-s2"> hosts in this group: </span><span class="tok-si">{</span><span class="tok-n">attr</span><span class="tok-p">[</span><span class="tok-s1">'members'</span><span class="tok-p">]</span><span class="tok-si">}</span><span class="tok-s2">"</span><span class="tok-p">)</span></code></pre></div>
</div>
<div class="paragraph"><p>Was hat sich geändert?
Der Fehlerfall wird jetzt zuerst abgehandelt.
Daher überprüfen Sie im <code>if</code>-Zweig, ob das Item <em>nicht</em> existiert, setzen den Status auf <span class="state2">CRIT</span> und verlassen mit <code>return</code> die Funktion.
In allen anderen Fällen geben Sie, wie zuvor, <span class="state0">OK</span> zurück.</p></div>
<div class="paragraph"><p>Damit haben Sie in der Check-Funktion den Fall der verschwundenen Host-Gruppen übernommen.
Statt <span class="state3">UNKNOWN</span> wird der zugehörige Service nun <span class="state2">CRIT</span> sein und die Information über die Ursache des kritischen Zustands beinhalten.</p></div>
<div class="paragraph"><p>Damit ist das neue Check-Plugin als Erweiterung des alten fertiggestellt.
Das erweiterte <a href="https://github.com/Checkmk/checkmk-docs/blob/2.2.0/examples/devel_check_plugins/agent_plugin_advanced_myhostgroups" target="_blank">Agentenplugin</a>
und die erweiterte Datei für die <a href="https://github.com/Checkmk/checkmk-docs/blob/2.2.0/examples/devel_check_plugins/check_plugin_advanced_myhostgroups_step01.py" target="_blank">Check-Plugins</a>
finden Sie wieder auf GitHub.
Letztere enthält das einfache Check-Plugin <code>myhostgroups</code> aus dem <a href="#write_check_plugin">vorherigen Kapitel</a>, die erweiterte Parse-Funktion und die Komponenten des neuen Check-Plugins <code>myhostgroups_advanced</code> mit der Registrierung, der Discovery-Funktion und der Check-Funktion.
Beachten Sie, dass die Funktionen immer vor dem Registrieren definiert werden müssen, damit es keine Fehler wegen nicht definierter Funktionsnamen gibt.</p></div>
<div class="paragraph"><p>Da das neue Check-Plugin <code>myhostgroups_advanced</code> neue Services zur Verfügung stellt, müssen Sie eine Service-Erkennung für dieses Check-Plugin durchführen und die Änderungen aktivieren, um die Services im Monitoring zu sehen:</p></div>
<div class="imageblock">
<div class="content"><img src="../images/devel_cpi_service_advanced_01.png" alt="Die vom erweiterten Check-Plugin erzeugten zwei neuen Services im Monitoring."></div>
<div class="title">Zwei neue Services im Monitoring</div>
</div>
<div class="paragraph"><p>Gehen Sie dabei so vor, wie es im Kapitel für das <a href="#test">einfache Check-Plugin</a> beschrieben ist.</p></div>
</div>
<div class="sect2">
<h3 id="heading_summary_details">
<span class="hidden-anchor sr-only" id="summary_details"></span>4.3. Summary und Details</h3>
<div class="paragraph"><p>Im Monitoring von Checkmk hat jeder Service neben dem Status — <span class="state0">OK</span>, <span class="state1">WARN</span> usw. — auch eine Zeile Text.
Diese steht in der Spalte <span class="guihint">Summary</span> — wie im vorherigen Screenshot zu sehen ist — und hat also die Aufgabe einer knappen Zusammenfassung des Zustands.
Die Idee ist, dass dieser Text eine Länge von 60 Zeichen nicht überschreitet.
Das sorgt dann immer für eine übersichtliche Tabellendarstellung ohne störende Zeilenumbrüche.</p></div>
<div class="paragraph"><p>Daneben gibt es noch das Feld <span class="guihint">Details,</span> in dem alle Details zum Zustand des Services angezeigt werden, wobei alle Informationen des Summary auch in den Details enthalten sind.
Nach Anklicken des Services wird die Service-Seite geöffnet, in der neben vielen anderen auch die beiden Felder <span class="guihint">Summary</span> und <span class="guihint">Details</span> zu sehen sind.</p></div>
<div class="paragraph"><p>Beim Aufruf von <code>yield Result(...)</code> können Sie bestimmen, welche Informationen so wichtig sind, dass sie im Summary angezeigt werden sollen, und bei welchen es genügt, dass diese in den Details erscheinen.</p></div>
<div class="paragraph"><p>In unserem Beispiel haben Sie bisher immer einen Aufruf der folgenden Art verwendet:</p></div>
<div class="listingblock">
<div class="title">~/local/lib/check_mk/base/plugins/agent_based/myhostgroups.py</div>
<div class="content"><pre class="pygments highlight"><code data-lang="python"><span></span>    <span class="tok-k">yield</span> <span class="tok-n">Result</span><span class="tok-p">(</span><span class="tok-n">state</span><span class="tok-o">=</span><span class="tok-n">State</span><span class="tok-o">.</span><span class="tok-n">OK</span><span class="tok-p">,</span> <span class="tok-n">summary</span><span class="tok-o">=</span><span class="tok-sa">f</span><span class="tok-s2">"</span><span class="tok-si">{</span><span class="tok-n">attr</span><span class="tok-p">[</span><span class="tok-s1">'num_hosts'</span><span class="tok-p">]</span><span class="tok-si">}</span><span class="tok-s2"> hosts in this group: </span><span class="tok-si">{</span><span class="tok-n">attr</span><span class="tok-p">[</span><span class="tok-s1">'members'</span><span class="tok-p">]</span><span class="tok-si">}</span><span class="tok-s2">"</span><span class="tok-p">)</span></code></pre></div>
</div>
<div class="paragraph"><p>Dieser führt dazu, dass der als <code>summary</code> festgelegte Text immer im <span class="guihint">Summary</span> erscheint — und zusätzlich auch in den <span class="guihint">Details</span>.
Dies sollten Sie also nur für wichtige Informationen verwenden.
Enthält eine Host-Gruppe viele Hosts, kann die Liste sehr lang werden — länger als die empfohlenen 60 Zeichen.
Ist eine Information eher untergeordnet, so können Sie mit <code>details</code> festlegen, dass der Text <em>nur</em> in den Details erscheint:</p></div>
<div class="listingblock" id="summary_details_yield">
<div class="title">~/local/lib/check_mk/base/plugins/agent_based/myhostgroups.py</div>
<div class="content"><pre class="pygments highlight"><code data-lang="python"><span></span>    <span class="tok-k">yield</span> <span class="tok-n">Result</span><span class="tok-p">(</span>
        <span class="tok-n">state</span> <span class="tok-o">=</span> <span class="tok-n">State</span><span class="tok-o">.</span><span class="tok-n">OK</span><span class="tok-p">,</span>
        <span class="tok-n">summary</span> <span class="tok-o">=</span> <span class="tok-sa">f</span><span class="tok-s2">"</span><span class="tok-si">{</span><span class="tok-n">attr</span><span class="tok-p">[</span><span class="tok-s1">'num_hosts'</span><span class="tok-p">]</span><span class="tok-si">}</span><span class="tok-s2"> hosts in this group"</span><span class="tok-p">,</span>
        <span class="tok-n">details</span> <span class="tok-o">=</span> <span class="tok-sa">f</span><span class="tok-s2">"</span><span class="tok-si">{</span><span class="tok-n">attr</span><span class="tok-p">[</span><span class="tok-s1">'num_hosts'</span><span class="tok-p">]</span><span class="tok-si">}</span><span class="tok-s2"> hosts in this group: </span><span class="tok-si">{</span><span class="tok-n">attr</span><span class="tok-p">[</span><span class="tok-s1">'members'</span><span class="tok-p">]</span><span class="tok-si">}</span><span class="tok-s2">"</span><span class="tok-p">,</span>
    <span class="tok-p">)</span></code></pre></div>
</div>
<div class="paragraph"><p>Im obigen Beispiel wird die Liste der Hosts daher nur noch in den <span class="guihint">Details</span> angezeigt.
Im <span class="guihint">Summary</span> steht dann nur die Anzahl der Hosts in der Gruppe:</p></div>
<div class="imageblock">
<div class="content"><img src="../images/devel_cpi_service_summary_details.png" alt="'Summary' und 'Details' in den Service-Details."></div>
<div class="title">Unterschiedliche Inhalte für Summary und Details im Monitoring</div>
</div>
<div class="paragraph" id="notice"><p>Es gibt neben <code>summary</code> und <code>details</code> noch einen dritten Parameter.
Mit <code>notice</code> bestimmen Sie, dass ein Text für einen Service im Zustand <span class="state0">OK</span> <em>nur</em> in den Details angezeigt wird — aber zusätzlich im Summary für alle anderen Zustände.
Somit wird dann aus dem Summary sofort klar, warum der Service nicht <span class="state0">OK</span> ist.
Der Parameter <code>notice</code> ist nicht besonders sinnvoll, wenn Texte fest an Zustände gebunden sind, wie bisher in unserem Beispiel.</p></div>
<div class="paragraph"><p>Zusammengefasst bedeutet das:</p></div>
<div class="ulist"><ul>
<li><p>Der Gesamttext für das Summary sollte bei Services, die <span class="state0">OK</span> sind, nicht länger als 60 Zeichen sein.</p></li>
<li><p>Verwenden Sie immer entweder <code>summary</code> oder <code>notice</code> — nicht beides und nicht keines davon.</p></li>
<li><p>Fügen Sie bei Bedarf <code>details</code> hinzu, wenn der Text für die Details ein alternativer sein soll.</p></li>
</ul></div>
</div>
<div class="sect2">
<h3 id="heading_partial_results">
<span class="hidden-anchor sr-only" id="partial_results"></span>4.4. Mehrere Teilresultate pro Service</h3>
<div class="paragraph"><p>Um die Anzahl der Services auf einem Host nicht ins Unermessliche steigen zu lassen, sind in einem Service oft mehrere Teilresultate zusammengefasst.
So prüft zum Beispiel der Service <span class="guihint">Memory</span> unter Linux nicht nur RAM- und Swap-Nutzung, sondern auch geteilten Speicher (<em>shared memory</em>), Page-Tabellen und alles Mögliche andere.</p></div>
<div class="paragraph"><p>Die <a href="#check_api_doc">Check-API</a> bietet dafür eine sehr komfortable Schnittstelle.
So darf eine Check-Funktion einfach beliebig oft ein Ergebnis mit <code>yield</code> erzeugen.
Der Gesamtstatus des Services richtet sich dann nach dem schlechtesten Teilergebnis in der Reihenfolge <span class="state0">OK</span> → <span class="state1">WARN</span> → <span class="state3">UNKNOWN</span> → <span class="state2">CRIT</span>.</p></div>
<div class="paragraph"><p>Nutzen Sie diese Möglichkeit, um in unserem Beispiel für jeden Service der Host-Gruppen zu dem bestehenden Resultat zwei weitere zu definieren.
Diese werten den Prozentsatz der Hosts im Zustand <span class="hstate0">UP</span> und der Services im Zustand <span class="state0">OK</span> aus.
Dabei nutzen Sie die <a href="#prepare">zuvor</a> in der Agentenausgabe und der Parse-Funktion festgelegten zusätzlichen Spalten der Host-Gruppentabelle.</p></div>
<div class="paragraph"><p>Erweitern Sie die Check-Funktion nun sukzessive von oben nach unten:</p></div>
<div class="listingblock">
<div class="title">~/local/lib/check_mk/base/plugins/agent_based/myhostgroups.py</div>
<div class="content"><pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">def</span> <span class="tok-nf">check_myhostgroups_advanced</span><span class="tok-p">(</span><span class="tok-n">item</span><span class="tok-p">,</span> <span class="tok-n">section</span><span class="tok-p">):</span>
    <span class="tok-n">attr</span> <span class="tok-o">=</span> <span class="tok-n">section</span><span class="tok-o">.</span><span class="tok-n">get</span><span class="tok-p">(</span><span class="tok-n">item</span><span class="tok-p">)</span>
    <span class="tok-k">if</span> <span class="tok-ow">not</span> <span class="tok-n">attr</span><span class="tok-p">:</span>
        <span class="tok-k">yield</span> <span class="tok-n">Result</span><span class="tok-p">(</span><span class="tok-n">state</span><span class="tok-o">=</span><span class="tok-n">State</span><span class="tok-o">.</span><span class="tok-n">CRIT</span><span class="tok-p">,</span> <span class="tok-n">summary</span><span class="tok-o">=</span><span class="tok-s2">"Group is empty or has been deleted"</span><span class="tok-p">)</span>
        <span class="tok-k">return</span>

    <span class="tok-n">members</span> <span class="tok-o">=</span> <span class="tok-n">attr</span><span class="tok-p">[</span><span class="tok-s2">"members"</span><span class="tok-p">]</span>
    <span class="tok-n">num_hosts</span> <span class="tok-o">=</span> <span class="tok-nb">int</span><span class="tok-p">(</span><span class="tok-n">attr</span><span class="tok-p">[</span><span class="tok-s2">"num_hosts"</span><span class="tok-p">])</span>
    <span class="tok-n">num_hosts_up</span> <span class="tok-o">=</span> <span class="tok-nb">int</span><span class="tok-p">(</span><span class="tok-n">attr</span><span class="tok-p">[</span><span class="tok-s2">"num_hosts_up"</span><span class="tok-p">])</span>
    <span class="tok-n">num_services</span> <span class="tok-o">=</span> <span class="tok-nb">int</span><span class="tok-p">(</span><span class="tok-n">attr</span><span class="tok-p">[</span><span class="tok-s2">"num_services"</span><span class="tok-p">])</span>
    <span class="tok-n">num_services_ok</span> <span class="tok-o">=</span> <span class="tok-nb">int</span><span class="tok-p">(</span><span class="tok-n">attr</span><span class="tok-p">[</span><span class="tok-s2">"num_services_ok"</span><span class="tok-p">])</span></code></pre></div>
</div>
<div class="paragraph"><p>Der <code>if</code>-Zweig bleibt unverändert, das heißt auch die neuen Teilresultate gelten nur für Host-Gruppen, die auch existieren.
Anschließend definieren Sie fünf Variablen für die in der Sektion enthaltenen Spalten der Host-Gruppentabelle.
Dies erhöht zum einen im folgenden die Lesbarkeit und nebenbei können Sie für die vier Spalten, mit denen noch gerechnet werden soll, die ausgelesenen Strings mit <code>int()</code> in Zahlen umwandeln.</p></div>
<div class="paragraph"><p>Auch das bisher einzig existierende Resultat bleibt (fast) unverändert:</p></div>
<div class="listingblock">
<div class="title">~/local/lib/check_mk/base/plugins/agent_based/myhostgroups.py</div>
<div class="content"><pre class="pygments highlight"><code data-lang="python"><span></span>    <span class="tok-k">yield</span> <span class="tok-n">Result</span><span class="tok-p">(</span>
        <span class="tok-n">state</span> <span class="tok-o">=</span> <span class="tok-n">State</span><span class="tok-o">.</span><span class="tok-n">OK</span><span class="tok-p">,</span>
        <span class="tok-n">summary</span> <span class="tok-o">=</span> <span class="tok-sa">f</span><span class="tok-s2">"</span><span class="tok-si">{</span><span class="tok-n">num_hosts</span><span class="tok-si">}</span><span class="tok-s2"> hosts in this group"</span><span class="tok-p">,</span>
        <span class="tok-n">details</span> <span class="tok-o">=</span> <span class="tok-sa">f</span><span class="tok-s2">"</span><span class="tok-si">{</span><span class="tok-n">num_hosts</span><span class="tok-si">}</span><span class="tok-s2"> hosts in this group: </span><span class="tok-si">{</span><span class="tok-n">members</span><span class="tok-si">}</span><span class="tok-s2">"</span><span class="tok-p">,</span>
    <span class="tok-p">)</span></code></pre></div>
</div>
<div class="paragraph"><p>Nur der Zugriff im Python-„F-String“ auf den Ausdruck, der den Wert liefert, ist nun einfacher als <a href="#summary_details_yield">zuvor</a>, da das <code>attr</code> bereits in den Variablendefinitionen steckt.</p></div>
<div class="paragraph"><p>Nun zum eigentlichen Kern der Erweiterung, der Definition eines Resultats, das die folgende Aussage umsetzt:
„Der Service der Host-Gruppe ist <span class="state1">WARN</span>, wenn 90 % der Hosts <span class="hstate0">UP</span> sind, und <span class="state2">CRIT</span> bei 80 % der Hosts.“
Dabei gilt die Konvention, dass der Check bereits beim <em>Erreichen</em> der Schwelle — und nicht erst beim Überschreiten — auf <span class="state1">WARN</span> bzw. <span class="state2">CRIT</span> geht.
Für den Vergleich eines ermittelten Werts mit Schwellwerten stellt die Check-API die Hilfsfunktion <code>check_levels</code> bereit.</p></div>
<div class="listingblock">
<div class="title">~/local/lib/check_mk/base/plugins/agent_based/myhostgroups.py</div>
<div class="content"><pre class="pygments highlight"><code data-lang="python"><span></span>    <span class="tok-n">hosts_up_perc</span> <span class="tok-o">=</span> <span class="tok-mf">100.0</span> <span class="tok-o">*</span> <span class="tok-n">num_hosts_up</span> <span class="tok-o">/</span> <span class="tok-n">num_hosts</span>
    <span class="tok-k">yield from</span> <span class="tok-n">check_levels</span><span class="tok-p">(</span>
        <span class="tok-n">hosts_up_perc</span><span class="tok-p">,</span>
        <span class="tok-n">levels_lower</span> <span class="tok-o">=</span> <span class="tok-p">(</span><span class="tok-mf">90.0</span><span class="tok-p">,</span> <span class="tok-mf">80.0</span><span class="tok-p">),</span>
        <span class="tok-n">label</span> <span class="tok-o">=</span> <span class="tok-s2">"UP hosts"</span><span class="tok-p">,</span>
        <span class="tok-n">notice_only</span> <span class="tok-o">=</span> <span class="tok-kc">True</span><span class="tok-p">,</span>
    <span class="tok-p">)</span></code></pre></div>
</div>
<div class="paragraph"><p>In der ersten Zeile wird aus Gesamtzahl und Zahl der Hosts im Zustand <span class="hstate0">UP</span> der Prozentsatz berechnet und in der Variablen <code>hosts_up_perc</code> gespeichert.
Durch den einfachen Schrägstrich (<code>/</code>) wird eine Gleitkommadivison ausgeführt, die sicherstellt, das das Ergebnis ein Float-Wert ist.
Das ist sinnvoll, weil einige im weiteren Verlauf verwendete Funktionen Float als Eingabe erwarten.</p></div>
<div class="paragraph"><p>In der zweiten Zeile wird dann das Ergebnis der Funktion <code>check_levels</code> als Objekt vom Typ <code>Result</code> zurückgegeben.
Die Funktion wird gefüttert mit dem gerade berechneten Prozentsatz als Wert (<code>hosts_up_perc</code>), den beiden unteren Schwellwerten (<code>levels_lower</code>), einer Bezeichnung, die der Ausgabe vorangestellt wird (<code>label</code>) und schließlich mit <code>notice_only=True</code>.</p></div>
<div class="paragraph"><p>Der letzte Parameter nutzt den im <a href="#notice">vorherigen Abschnitt</a> für das Objekt <code>Result()</code> bereits vorgestellten Parameter <code>notice</code>.
Mit <code>notice_only=True</code> legen Sie fest, dass der Text für den Service nur dann im <span class="guihint">Summary</span> angezeigt wird, wenn der Zustand nicht <span class="state0">OK</span> ist.
Allerdings werden Teilergebnisse, die zu einem <span class="state1">WARN</span> oder <span class="state2">CRIT</span> führen, sowieso <em>immer</em> im Summary sichtbar werden — unabhängig davon, welchen Wert <code>notice_only</code> hat.</p></div>
<div class="paragraph"><p>Schließlich definieren Sie analog zum zweiten das dritte Resultat, das den Prozentsatz der Services im Zustand <span class="state0">OK</span> auswertet:</p></div>
<div class="listingblock">
<div class="title">~/local/lib/check_mk/base/plugins/agent_based/myhostgroups.py</div>
<div class="content"><pre class="pygments highlight"><code data-lang="python"><span></span>    <span class="tok-n">services_ok_perc</span> <span class="tok-o">=</span> <span class="tok-mf">100.0</span> <span class="tok-o">*</span> <span class="tok-n">num_services_ok</span> <span class="tok-o">/</span> <span class="tok-n">num_services</span>
    <span class="tok-k">yield from</span> <span class="tok-n">check_levels</span><span class="tok-p">(</span>
        <span class="tok-n">services_ok_perc</span><span class="tok-p">,</span>
        <span class="tok-n">levels_lower</span> <span class="tok-o">=</span> <span class="tok-p">(</span><span class="tok-mf">90.0</span><span class="tok-p">,</span> <span class="tok-mf">80.0</span><span class="tok-p">),</span>
        <span class="tok-n">label</span> <span class="tok-o">=</span> <span class="tok-s2">"OK services"</span><span class="tok-p">,</span>
        <span class="tok-n">notice_only</span> <span class="tok-o">=</span> <span class="tok-kc">True</span><span class="tok-p">,</span>
    <span class="tok-p">)</span></code></pre></div>
</div>
<div class="paragraph"><p>Damit ist die Check-Funktion komplett.</p></div>
<div class="paragraph"><p>Der Service für eine Host-Gruppe wertet jetzt drei Resultate aus und zeigt aus diesen den schlechtesten Zustand im Monitoring an, wie im folgenden Beispiel:</p></div>
<div class="imageblock">
<div class="content"><img src="../images/devel_cpi_service_partial_results.png" alt="Das Summary zeigt den Text zum kritischen Zustand."></div>
<div class="title">Das Summary zeigt den Text zum kritischen Zustand</div>
</div>
</div>
<div class="sect2">
<h3 id="heading_metrics">
<span class="hidden-anchor sr-only" id="metrics"></span>4.5. Metriken</h3>
<div class="paragraph"><p>Nicht immer, aber oft befassen sich Checks mit Zahlen.
Und sehr oft handelt es sich bei diesen Zahlen um gemessene oder berechnete Werte.
In unserem Beispiel sind die Zahl der Hosts in der Host-Gruppe (<code>num_hosts</code>) und die Zahl der Hosts im Zustand <span class="hstate0">UP</span> (<code>num_hosts_up</code>) die Messwerte.
Der Prozentsatz der Hosts im Zustand <span class="hstate0">UP</span> (<code>hosts_up_perc</code>) ist ein daraus berechneter Wert.
Wenn dann solch ein Wert im zeitlichen Verlauf dargestellt werden kann, wird er auch als <a href="glossar.html#metric">Metrik</a> bezeichnet.</p></div>
<div class="paragraph"><p>Mit seinem <a href="graphing.html">Graphing-System</a> hat Checkmk eine Komponente, um solche Zahlen zu speichern, auszuwerten und darzustellen.
Das geht dabei völlig unabhängig von der Berechnung der Zustände <span class="state0">OK</span>, <span class="state1">WARN</span> und <span class="state2">CRIT</span>.</p></div>
<div class="paragraph"><p>Sie werden in diesem Beispiel die beiden berechneten Werte <code>hosts_up_perc</code> und <code>services_ok_perc</code> als Metriken definieren.
Metriken werden in der grafischen Benutzeroberfläche von Checkmk sofort sichtbar, ohne dass Sie etwas dafür tun müssen.
Pro Metrik wird automatisch ein Graph erzeugt.</p></div>
<div class="paragraph"><p>Metriken werden von der Check-Funktion ermittelt und als zusätzliches Ergebnis zurückgegeben.
Am einfachsten ist es, der Funktion <code>check_levels()</code> im Aufruf die Metrikinformationen mitzugeben.</p></div>
<div class="paragraph"><p>Zur Erinnerung folgt die Zeile mit dem Funktionsaufruf von <code>check_levels()</code> aus dem <a href="#partial_results">vorherigen Abschnitt:</a></p></div>
<div class="listingblock">
<div class="title">~/local/lib/check_mk/base/plugins/agent_based/myhostgroups.py</div>
<div class="content"><pre class="pygments highlight"><code data-lang="python"><span></span>    <span class="tok-k">yield from</span> <span class="tok-n">check_levels</span><span class="tok-p">(</span>
        <span class="tok-n">hosts_up_perc</span><span class="tok-p">,</span>
        <span class="tok-n">levels_lower</span> <span class="tok-o">=</span> <span class="tok-p">(</span><span class="tok-mf">90.0</span><span class="tok-p">,</span> <span class="tok-mf">80.0</span><span class="tok-p">),</span>
        <span class="tok-n">label</span> <span class="tok-o">=</span> <span class="tok-s2">"UP hosts"</span><span class="tok-p">,</span>
        <span class="tok-n">notice_only</span> <span class="tok-o">=</span> <span class="tok-kc">True</span><span class="tok-p">,</span>
    <span class="tok-p">)</span></code></pre></div>
</div>
<div class="paragraph"><p>Die beiden neuen Argumente für die Metrik sind <code>metric_name</code> und <code>boundaries</code>:</p></div>
<div class="listingblock">
<div class="title">~/local/lib/check_mk/base/plugins/agent_based/myhostgroups.py</div>
<div class="content"><pre class="pygments highlight"><code data-lang="python"><span></span>    <span class="tok-k">yield from</span> <span class="tok-n">check_levels</span><span class="tok-p">(</span>
        <span class="tok-n">hosts_up_perc</span><span class="tok-p">,</span>
        <span class="tok-n">levels_lower</span> <span class="tok-o">=</span> <span class="tok-p">(</span><span class="tok-mf">90.0</span><span class="tok-p">,</span> <span class="tok-mf">80.0</span><span class="tok-p">),</span>
<span class="hll">        <span class="tok-n">metric_name</span> <span class="tok-o">=</span> <span class="tok-s2">"hosts_up_perc"</span><span class="tok-p">,</span>
</span>        <span class="tok-n">label</span> <span class="tok-o">=</span> <span class="tok-s2">"UP hosts"</span><span class="tok-p">,</span>
<span class="hll">        <span class="tok-n">boundaries</span> <span class="tok-o">=</span> <span class="tok-p">(</span><span class="tok-mf">0.0</span><span class="tok-p">,</span> <span class="tok-mf">100.0</span><span class="tok-p">),</span>
</span>        <span class="tok-n">notice_only</span> <span class="tok-o">=</span> <span class="tok-kc">True</span><span class="tok-p">,</span>
    <span class="tok-p">)</span></code></pre></div>
</div>
<div class="paragraph"><p>Um es schön einfach und aussagekräftig zu halten, nehmen Sie als Namen der Metrik den Namen der Variabel, in der der Prozentsatz als Wert gespeichert ist.</p></div>
<div class="paragraph"><p>Mit <code>boundaries</code> können Sie dem Graphing-System die Information über den möglichen Wertebereich mitgeben.
Damit ist der kleinste und größte mögliche Wert gemeint.
Bei einem Prozentsatz sind die Grenzen mit <code>0.0</code> und <code>100.0</code> nicht allzu schwer zu bestimmen.
Es sind sowohl Gleitkommazahlen (<em>Float</em>) als auch Ganzzahlen (<em>Integer</em>, die intern wiederum in Gleitkommazahlen umgewandelt werden) erlaubt, aber keine Strings.
Falls nur eine Grenze des Wertebereichs definiert ist, tragen Sie für die andere einfach <code>None</code> ein, also zum Beispiel <code>boundaries=(0.0, None)</code>.</p></div>
<div class="paragraph"><p>Durch diese Erweiterung gibt die Funktion <code>check_levels</code> nun per <code>yield</code> zusätzlich zum <code>Result</code> auch noch ein Objekt vom Typ <code>Metric</code> zurück.</p></div>
<div class="paragraph"><p>Analog können Sie jetzt auch die Metrik <code>services_ok_perc</code> definieren.
Die letzten Zeilen der Check-Funktion sehen dann so aus:</p></div>
<div class="listingblock">
<div class="title">~/local/lib/check_mk/base/plugins/agent_based/myhostgroups.py</div>
<div class="content"><pre class="pygments highlight"><code data-lang="python"><span></span>    <span class="tok-n">hosts_up_perc</span> <span class="tok-o">=</span> <span class="tok-mf">100.0</span> <span class="tok-o">*</span> <span class="tok-n">num_hosts_up</span> <span class="tok-o">/</span> <span class="tok-n">num_hosts</span>
    <span class="tok-k">yield from</span> <span class="tok-n">check_levels</span><span class="tok-p">(</span>
        <span class="tok-n">hosts_up_perc</span><span class="tok-p">,</span>
        <span class="tok-n">levels_lower</span> <span class="tok-o">=</span> <span class="tok-p">(</span><span class="tok-mf">90.0</span><span class="tok-p">,</span> <span class="tok-mf">80.0</span><span class="tok-p">),</span>
        <span class="tok-n">metric_name</span> <span class="tok-o">=</span> <span class="tok-s2">"hosts_up_perc"</span><span class="tok-p">,</span>
        <span class="tok-n">label</span> <span class="tok-o">=</span> <span class="tok-s2">"UP hosts"</span><span class="tok-p">,</span>
        <span class="tok-n">boundaries</span> <span class="tok-o">=</span> <span class="tok-p">(</span><span class="tok-mf">0.0</span><span class="tok-p">,</span> <span class="tok-mf">100.0</span><span class="tok-p">),</span>
        <span class="tok-n">notice_only</span> <span class="tok-o">=</span> <span class="tok-kc">True</span><span class="tok-p">,</span>
    <span class="tok-p">)</span>
    <span class="tok-n">services_ok_perc</span> <span class="tok-o">=</span> <span class="tok-mf">100.0</span> <span class="tok-o">*</span> <span class="tok-n">num_services_ok</span> <span class="tok-o">/</span> <span class="tok-n">num_services</span>
    <span class="tok-k">yield from</span> <span class="tok-n">check_levels</span><span class="tok-p">(</span>
        <span class="tok-n">services_ok_perc</span><span class="tok-p">,</span>
        <span class="tok-n">levels_lower</span> <span class="tok-o">=</span> <span class="tok-p">(</span><span class="tok-mf">90.0</span><span class="tok-p">,</span> <span class="tok-mf">80.0</span><span class="tok-p">),</span>
        <span class="tok-n">metric_name</span> <span class="tok-o">=</span> <span class="tok-s2">"services_ok_perc"</span><span class="tok-p">,</span>
        <span class="tok-n">label</span> <span class="tok-o">=</span> <span class="tok-s2">"OK services"</span><span class="tok-p">,</span>
        <span class="tok-n">boundaries</span> <span class="tok-o">=</span> <span class="tok-p">(</span><span class="tok-mf">0.0</span><span class="tok-p">,</span> <span class="tok-mf">100.0</span><span class="tok-p">),</span>
        <span class="tok-n">notice_only</span> <span class="tok-o">=</span> <span class="tok-kc">True</span><span class="tok-p">,</span>
    <span class="tok-p">)</span></code></pre></div>
</div>
<div class="paragraph"><p>Mit der so erweiterten Check-Funktion sind die beiden Graphen im Monitoring sichtbar.
In der Service-Liste zeigt nun das Symbol <span class="image-inline"><img src="../images/icons/icon_service_graph.png" alt="Symbol zur Anzeige der Graphen eines Services."></span>, dass es Graphen zum Service gibt.
Wenn Sie mit der Maus auf das Symbol zeigen, werden die Graphen als Vorschau eingeblendet.</p></div>
<div class="imageblock">
<div class="content"><img src="../images/devel_cpi_service_graphs.png" alt="Die Service-Liste mit 2 Graphen als Vorschau."></div>
<div class="title">Die Namen der Metriken werden als Titel der Graphen verwendet</div>
</div>
<div class="paragraph"><p>Eine Übersicht aller Graphen inklusive Legende und mehr finden Sie in den Service-Details.</p></div>
<div class="paragraph"><p>Was macht man aber, wenn der Wert für die gewünschte Metrik gar nicht mit der Funktion <code>check_levels()</code> definiert wurde?
Sie können selbstverständlich eine Metrik auch unabhängig von einem Funktionsaufruf festlegen.
Dazu dient das Objekt <code>Metric()</code>, welches Sie auch direkt über seinen Konstruktor erzeugen können.
Die alternative Definition einer Metrik für den Wert <code>hosts_up_perc</code> sieht so aus:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="python"><span></span>    <span class="tok-k">yield</span> <span class="tok-n">Metric</span><span class="tok-p">(</span>
        <span class="tok-n">name</span> <span class="tok-o">=</span> <span class="tok-s2">"hosts_up_perc"</span><span class="tok-p">,</span>
        <span class="tok-n">value</span> <span class="tok-o">=</span> <span class="tok-n">hosts_up_perc</span><span class="tok-p">,</span>
        <span class="tok-n">levels</span> <span class="tok-o">=</span> <span class="tok-p">(</span><span class="tok-mf">80.0</span><span class="tok-p">,</span> <span class="tok-mf">90.0</span><span class="tok-p">),</span>
        <span class="tok-n">boundaries</span> <span class="tok-o">=</span> <span class="tok-p">(</span><span class="tok-mf">0.0</span><span class="tok-p">,</span> <span class="tok-mf">100.0</span><span class="tok-p">),</span>
    <span class="tok-p">)</span></code></pre></div></div>
<div class="paragraph"><p>Die Argumente von <code>Metric()</code> sind sehr ähnlich zu denen im oben gezeigten Funktionsaufruf:
Verpflichtend sind die ersten beiden Argumente für den Metriknamen und den Wert.
Zusätzlich gibt es noch zwei optionale Argumente: <code>levels</code> für die Schwellwerte <span class="state1">WARN</span> und <span class="state2">CRIT</span> und <code>boundaries</code> für den Wertebereich.</p></div>
<div class="paragraph"><p><strong>Wichtig:</strong> Die Angabe von <code>levels</code> dient hier lediglich als Information für die Darstellung des Graphen.
Im Graphen werden die Schwellwerte üblicherweise als gelbe und rote Linien eingezeichnet.
Für die <em>Überprüfung</em> ist die Funktion <code>check_levels</code> mit den dort festgelegten Schwellwerten verantwortlich.</p></div>
<div class="paragraph"><p>Nutzen Sie nun die Möglichkeit, nicht nur die beiden berechneten Werte, sondern mit <code>Metric()</code> <em>alle</em> Messwerte als Metriken zu definieren — in unserem Beispiel also die vier Messwerte aus der Host-Gruppentabelle.
Beschränken Sie sich dabei auf die beiden obligatorischen Angaben von Metrikname und Wert.
Die vier neuen Zeilen komplettieren die Erweiterung der Check-Funktion für Metriken:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="python"><span></span>    <span class="tok-n">hosts_up_perc</span> <span class="tok-o">=</span> <span class="tok-mf">100.0</span> <span class="tok-o">*</span> <span class="tok-n">num_hosts_up</span> <span class="tok-o">/</span> <span class="tok-n">num_hosts</span>
    <span class="tok-k">yield from</span> <span class="tok-n">check_levels</span><span class="tok-p">(</span>
        <span class="tok-n">hosts_up_perc</span><span class="tok-p">,</span>
        <span class="tok-n">levels_lower</span> <span class="tok-o">=</span> <span class="tok-p">(</span><span class="tok-mf">90.0</span><span class="tok-p">,</span> <span class="tok-mf">80.0</span><span class="tok-p">),</span>
        <span class="tok-n">metric_name</span> <span class="tok-o">=</span> <span class="tok-s2">"hosts_up_perc"</span><span class="tok-p">,</span>
        <span class="tok-n">label</span> <span class="tok-o">=</span> <span class="tok-s2">"UP hosts"</span><span class="tok-p">,</span>
        <span class="tok-n">boundaries</span> <span class="tok-o">=</span> <span class="tok-p">(</span><span class="tok-mf">0.0</span><span class="tok-p">,</span> <span class="tok-mf">100.0</span><span class="tok-p">),</span>
        <span class="tok-n">notice_only</span> <span class="tok-o">=</span> <span class="tok-kc">True</span><span class="tok-p">,</span>
    <span class="tok-p">)</span>
    <span class="tok-n">services_ok_perc</span> <span class="tok-o">=</span> <span class="tok-mf">100.0</span> <span class="tok-o">*</span> <span class="tok-n">num_services_ok</span> <span class="tok-o">/</span> <span class="tok-n">num_services</span>
    <span class="tok-k">yield from</span> <span class="tok-n">check_levels</span><span class="tok-p">(</span>
        <span class="tok-n">services_ok_perc</span><span class="tok-p">,</span>
        <span class="tok-n">levels_lower</span> <span class="tok-o">=</span> <span class="tok-p">(</span><span class="tok-mf">90.0</span><span class="tok-p">,</span> <span class="tok-mf">80.0</span><span class="tok-p">),</span>
        <span class="tok-n">metric_name</span> <span class="tok-o">=</span> <span class="tok-s2">"services_ok_perc"</span><span class="tok-p">,</span>
        <span class="tok-n">label</span> <span class="tok-o">=</span> <span class="tok-s2">"OK services"</span><span class="tok-p">,</span>
        <span class="tok-n">boundaries</span> <span class="tok-o">=</span> <span class="tok-p">(</span><span class="tok-mf">0.0</span><span class="tok-p">,</span> <span class="tok-mf">100.0</span><span class="tok-p">),</span>
        <span class="tok-n">notice_only</span> <span class="tok-o">=</span> <span class="tok-kc">True</span><span class="tok-p">,</span>
    <span class="tok-p">)</span>

    <span class="tok-k">yield</span> <span class="tok-n">Metric</span><span class="tok-p">(</span><span class="tok-n">name</span><span class="tok-o">=</span><span class="tok-s2">"num_hosts"</span><span class="tok-p">,</span> <span class="tok-n">value</span><span class="tok-o">=</span><span class="tok-n">num_hosts</span><span class="tok-p">)</span>
    <span class="tok-k">yield</span> <span class="tok-n">Metric</span><span class="tok-p">(</span><span class="tok-n">name</span><span class="tok-o">=</span><span class="tok-s2">"num_hosts_up"</span><span class="tok-p">,</span> <span class="tok-n">value</span><span class="tok-o">=</span><span class="tok-n">num_hosts_up</span><span class="tok-p">)</span>
    <span class="tok-k">yield</span> <span class="tok-n">Metric</span><span class="tok-p">(</span><span class="tok-n">name</span><span class="tok-o">=</span><span class="tok-s2">"num_services"</span><span class="tok-p">,</span> <span class="tok-n">value</span><span class="tok-o">=</span><span class="tok-n">num_services</span><span class="tok-p">)</span>
    <span class="tok-k">yield</span> <span class="tok-n">Metric</span><span class="tok-p">(</span><span class="tok-n">name</span><span class="tok-o">=</span><span class="tok-s2">"num_services_ok"</span><span class="tok-p">,</span> <span class="tok-n">value</span><span class="tok-o">=</span><span class="tok-n">num_services_ok</span><span class="tok-p">)</span></code></pre></div></div>
<div class="paragraph"><p>Das erhöht schon einmal die Zahl der Graphen pro Service, bietet Ihnen aber zum Beispiel auch die Möglichkeit, mehrere Metriken in einem Graphen zu kombinieren.
Wir zeigen diese und andere Möglichkeiten im Abschnitt <a href="#metrics_advanced">Darstellung von Metriken anpassen</a> weiter unten.</p></div>
<div class="paragraph"><p>In der Beispieldatei auf
<a href="https://github.com/Checkmk/checkmk-docs/blob/2.2.0/examples/devel_check_plugins/check_plugin_advanced_myhostgroups_step02.py" target="_blank">GitHub</a>
finden Sie wieder die gesamte Check-Funktion.</p></div>
</div>
<div class="sect2">
<h3 id="heading_rule_set">
<span class="hidden-anchor sr-only" id="rule_set"></span>4.6. Check-Parameter für Regelsätze</h3>
<div class="paragraph"><p>Im erweiterten Check-Plugin <code>myhostgroups_advanced</code> haben Sie den Zustand <span class="state1">WARN</span> erzeugt, wenn nur 90 % der Hosts <span class="hstate0">UP</span> sind, und <span class="state2">CRIT</span> bei 80 %.
Dabei sind die Zahlen <code>90</code> und <code>80</code> direkt in der Check-Funktion fest einprogrammiert oder, wie Programmierer sagen würden, <em>hart codiert.</em>
In Checkmk ist man allerdings als Benutzer gewohnt, dass man solche Schwellwerte und andere Check-Parameter per <a href="glossar.html#rule">Regel</a> konfigurieren kann.
Denn hat zum Beispiel eine Host-Gruppe nur vier Mitglieder, dann passen die beiden Schwellwerte von 90 und 80 % nicht wirklich gut,
da bereits beim Ausfall des ersten Hosts der Prozentsatz auf 75 % sinkt und der Zustand — ohne Umweg über <span class="state1">WARN</span> — direkt auf <span class="state2">CRIT</span> geht.</p></div>
<div class="paragraph"><p>Daher soll das Check-Plugin nun so verbessert werden, dass es über die <span class="guihint">Setup</span>-Oberfläche konfigurierbar ist.
Dazu benötigen Sie einen <a href="glossar.html#rule_set">Regelsatz.</a>
Falls es in Checkmk bereits einen passenden Regelsatz gibt, dann können Sie diesen verwenden.
Da Check-Funktion und Regelsatz zusammenpassen müssen, wird dies in aller Regel nicht der Fall sein.
Weiter unten finden Sie mehr Informationen zu <a href="#reuse_ruleset">vorhandenen Regelsätzen.</a></p></div>
<div class="paragraph"><p><strong>Hinweis:</strong> Beachten Sie, dass die in diesem Abschnitt vorgestellten Beispiele <em>nicht</em> durch die Check-API abgedeckt sind.</p></div>
<div class="sect3">
<h4 id="heading_new_ruleset">
<span class="hidden-anchor sr-only" id="new_ruleset"></span>Neuen Regelsatz definieren</h4>
<div class="paragraph"><p>Um einen neuen Regelsatz zu erstellen, legen Sie eine neue Datei im Verzeichnis <code>~/local/share/check_mk/web/plugins/wato</code> an.
Der Name der Datei sollte sich an dem des Check-Plugins orientieren und muss wie alle Plugin-Dateien die Endung <code>.py</code> haben.
Für unser Beispiel passt der Dateiname <code>myhostgroups_advanced_parameters.py</code>.</p></div>
<div class="paragraph"><p>Sehen Sie sich den Aufbau so einer Datei Schritt für Schritt an.
Zunächst kommen einige Importbefehle.</p></div>
<div class="paragraph"><p>Falls die Texte in Ihrer Datei, die auf der Checkmk-GUI angezeigt werden, in andere Sprachen übersetzbar sein sollen, importieren Sie <code>_</code> (Unterstrich):</p></div>
<div class="listingblock">
<div class="title">~/local/share/check_mk/web/plugins/wato/myhostgroups_advanced_parameters.py</div>
<div class="content"><pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-kn">from</span> <span class="tok-nn">cmk.gui.i18n</span> <span class="tok-kn">import</span> <span class="tok-n">_</span></code></pre></div>
</div>
<div class="paragraph"><p>Dies ist eine Funktion und fungiert als Markierung für alle übersetzbaren Texte.
Im Weiteren schreiben Sie dann zum Beispiel anstelle von <code>"Threshold for Warning"</code> ein <code>_("Threshold for Warning")</code> für den Funktionsaufruf.
Das Übersetzungssystem von Checkmk, welches auf <a href="https://docs.python.org/3/library/gettext.html#module-gettext" target="_blank">gettext</a> basiert,
findet solche Texte und übernimmt sie in die Liste der zu übersetzenden Texte.
Falls Sie den Check nur für sich selbst bauen, können Sie darauf und damit auch auf die <code>import</code>-Zeile verzichten.</p></div>
<div class="paragraph"><p>Als nächstes importieren Sie sogenannte <em>ValueSpecs.</em>
Ein ValueSpec ist ein sehr praktisches und universelles Werkzeug, das Checkmk an vielen Stellen verwendet.
Es dient dem Generieren von angepassten Eingabeformularen, der Darstellung und Validierung der eingegebenen Werte und der Umwandlung in Python-Datenstrukturen.</p></div>
<div class="listingblock">
<div class="title">~/local/share/check_mk/web/plugins/wato/myhostgroups_advanced_parameters.py</div>
<div class="content"><pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-kn">from</span> <span class="tok-nn">cmk.gui.valuespec</span> <span class="tok-kn">import</span> <span class="tok-p">(</span>
    <span class="tok-n">Dictionary</span><span class="tok-p">,</span>
    <span class="tok-n">Percentage</span><span class="tok-p">,</span>
    <span class="tok-n">TextInput</span><span class="tok-p">,</span>
    <span class="tok-n">Tuple</span><span class="tok-p">,</span>
<span class="tok-p">)</span></code></pre></div>
</div>
<div class="paragraph"><p>Das <code>Dictionary</code> benötigen Sie auf jeden Fall, denn seit Checkmk-Version <span class="new">2.0.0</span> werden Check-Parameter in Python-Dictionaries gespeichert.
<code>Percentage</code> ist für die Eingabe von Prozentwerten verantwortlich, <code>TextInput</code> für einen Unicode-Text und <code>Tuple</code> für eine geordnete, eindimensionale Menge von Objekten.
Sie werden auch häufiger <code>Float</code> (Gleitkommazahlen) und <code>Integer</code> (Ganzzahlen) verwenden.</p></div>
<div class="paragraph"><p>Als nächstes werden noch Klassen und Funktionen importiert, die beim Registrieren benötigt werden:</p></div>
<div class="listingblock">
<div class="title">~/local/share/check_mk/web/plugins/wato/myhostgroups_advanced_parameters.py</div>
<div class="content"><pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-kn">from</span> <span class="tok-nn">cmk.gui.plugins.wato.utils</span> <span class="tok-kn">import</span> <span class="tok-p">(</span>
    <span class="tok-n">CheckParameterRulespecWithItem</span><span class="tok-p">,</span>
    <span class="tok-n">rulespec_registry</span><span class="tok-p">,</span>
    <span class="tok-n">RulespecGroupCheckParametersApplications</span><span class="tok-p">,</span>
<span class="tok-p">)</span></code></pre></div>
</div>
<div class="paragraph"><p>Da Ihr Check-Plugin <code>myhostgroups_advanced</code> mehrere Services erzeugt, importieren Sie <code>CheckParameterRulespecWithItem</code>.
Falls Ihr Check keinen Service erzeugt, mit anderen Worten kein Item hat, importieren Sie stattdessen <code>CheckParameterRulespecWithoutItem</code>.
Zur <code>RulespecGroup</code> gibt es am Ende dieses Abschnitts noch Informationen.</p></div>
<div class="paragraph"><p>Nun kommen die eigentlichen Definitionen.
Zunächst deklarieren Sie ein Eingabefeld, mit dem der Benutzer das <em>Item</em> des Checks angeben kann.
Dieses Feld wird in der Bedingung der Regel angezeigt und erlaubt es den Benutzern, die Regel auf bestimmte Services einzuschränken.
Es ist auch für das manuelle Anlegen von Checks notwendig, welche ohne Discovery funktionieren sollen.</p></div>
<div class="paragraph"><p>Das Feld erstellen Sie mit <code>TextInput</code>.
Es bekommt per <code>title</code> einen Titel zugewiesen, welcher dann in der Regel als Überschrift für das Eingabefeld angezeigt wird.
Wenn Sie ein Herz für Ihre Benutzer haben, geben Sie ihnen auch noch einen hilfreichen Text für die Inline-Hilfe mit:</p></div>
<div class="listingblock">
<div class="title">~/local/share/check_mk/web/plugins/wato/myhostgroups_advanced_parameters.py</div>
<div class="content"><pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">def</span> <span class="tok-nf">_item_valuespec_myhostgroups_advanced</span><span class="tok-p">():</span>
    <span class="tok-k">return</span> <span class="tok-n">TextInput</span><span class="tok-p">(</span>
        <span class="tok-n">title</span> <span class="tok-o">=</span> <span class="tok-s2">"Host group name"</span><span class="tok-p">,</span>
        <span class="tok-n">help</span> <span class="tok-o">=</span> <span class="tok-s2">"You can restrict this rule to certain services of the specified hosts."</span><span class="tok-p">,</span>
    <span class="tok-p">)</span></code></pre></div>
</div>
<div class="paragraph"><p>Den Namen der Funktion, welche dieses ValueSpec zurückgibt, können Sie frei wählen, er wird nur bei der Registrierung weiter unten benötigt.
Damit die Funktion nicht über die Modulgrenze hinaus sichtbar wird, sollte der Name mit einem Unterstrich beginnen.</p></div>
<div class="paragraph"><p>Als nächstes kommt das ValueSpec für die Eingabe der eigentlichen Check-Parameter.
Auch hierfür legen Sie eine Funktion an, welche das ValueSpec erzeugt.
Der Benutzer soll die beiden Schwellwerte für <span class="state1">WARN</span> und <span class="state2">CRIT</span> festlegen können und zwar getrennt für die Anzahl der Hosts im Zustand <span class="hstate0">UP</span> und der Services im Zustand <span class="state0">OK</span>:</p></div>
<div class="listingblock">
<div class="title">~/local/share/check_mk/web/plugins/wato/myhostgroups_advanced_parameters.py</div>
<div class="content"><pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">def</span> <span class="tok-nf">_parameter_valuespec_myhostgroups_advanced</span><span class="tok-p">():</span>
    <span class="tok-k">return</span> <span class="tok-n">Dictionary</span><span class="tok-p">(</span>
        <span class="tok-n">elements</span> <span class="tok-o">=</span> <span class="tok-p">[</span>
            <span class="tok-p">(</span><span class="tok-s2">"hosts_up_lower"</span><span class="tok-p">,</span>
                <span class="tok-n">Tuple</span><span class="tok-p">(</span>
                    <span class="tok-n">title</span> <span class="tok-o">=</span> <span class="tok-n">_</span><span class="tok-p">(</span><span class="tok-s2">"Lower percentage threshold for host in UP status"</span><span class="tok-p">),</span>
                    <span class="tok-n">elements</span> <span class="tok-o">=</span> <span class="tok-p">[</span>
                        <span class="tok-n">Percentage</span><span class="tok-p">(</span><span class="tok-n">title</span><span class="tok-o">=</span><span class="tok-n">_</span><span class="tok-p">(</span><span class="tok-s2">"Warning"</span><span class="tok-p">)),</span>
                        <span class="tok-n">Percentage</span><span class="tok-p">(</span><span class="tok-n">title</span><span class="tok-o">=</span><span class="tok-n">_</span><span class="tok-p">(</span><span class="tok-s2">"Critical"</span><span class="tok-p">)),</span>
                    <span class="tok-p">],</span>
                <span class="tok-p">)</span>
            <span class="tok-p">),</span>
            <span class="tok-p">(</span><span class="tok-s2">"services_ok_lower"</span><span class="tok-p">,</span>
                <span class="tok-n">Tuple</span><span class="tok-p">(</span>
                    <span class="tok-n">title</span> <span class="tok-o">=</span> <span class="tok-n">_</span><span class="tok-p">(</span><span class="tok-s2">"Lower percentage threshold for services in OK status"</span><span class="tok-p">),</span>
                    <span class="tok-n">elements</span> <span class="tok-o">=</span> <span class="tok-p">[</span>
                        <span class="tok-n">Percentage</span><span class="tok-p">(</span><span class="tok-n">title</span><span class="tok-o">=</span><span class="tok-n">_</span><span class="tok-p">(</span><span class="tok-s2">"Warning"</span><span class="tok-p">)),</span>
                        <span class="tok-n">Percentage</span><span class="tok-p">(</span><span class="tok-n">title</span><span class="tok-o">=</span><span class="tok-n">_</span><span class="tok-p">(</span><span class="tok-s2">"Critical"</span><span class="tok-p">)),</span>
                    <span class="tok-p">],</span>
                <span class="tok-p">)</span>
            <span class="tok-p">),</span>
        <span class="tok-p">],</span>
    <span class="tok-p">)</span></code></pre></div>
</div>
<div class="paragraph"><p>Das <code>return Dictionary()</code> ist vorgeschrieben.
Innerhalb dessen legen Sie mit <code>elements=[]</code> die Liste der Parameter an, im Beispiel <code>hosts_up_lower</code> und <code>services_ok_lower</code>.
Beide Parameter werden jeweils durch ein <em>Tupel</em> von zwei Werten für die <span class="state2">CRIT</span> und <span class="state1">WARN</span> Schwellwerte definiert.
Alle Schwellwerte sollen Prozentzahlen sein, also verwenden Sie hier <code>Percentage</code>.</p></div>
<div class="paragraph"><p><strong>Hinweis:</strong> Wenn Sie den Benutzern des Regelsatzes statt leerer Eingabefelder bereits Werte vorgeben wollen, können Sie das tun, indem Sie die <code>Percentage()</code> Funktion um das Argument <code>default_value</code> erweitern.
Für das Tupel <code>hosts_up_lower</code> aus dem eben gezeigten Beispiel sieht das dann so aus:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="python"><span></span>            <span class="tok-p">(</span><span class="tok-s2">"hosts_up_lower"</span><span class="tok-p">,</span>
                <span class="tok-n">Tuple</span><span class="tok-p">(</span>
                    <span class="tok-n">title</span> <span class="tok-o">=</span> <span class="tok-n">_</span><span class="tok-p">(</span><span class="tok-s2">"Lower percentage threshold for host in UP status"</span><span class="tok-p">),</span>
                    <span class="tok-n">elements</span> <span class="tok-o">=</span> <span class="tok-p">[</span>
                        <span class="tok-n">Percentage</span><span class="tok-p">(</span><span class="tok-n">title</span><span class="tok-o">=</span><span class="tok-n">_</span><span class="tok-p">(</span><span class="tok-s2">"Warning"</span><span class="tok-p">),</span> <span class="tok-n">default_value</span><span class="tok-o">=</span><span class="tok-mf">90.0</span><span class="tok-p">),</span>
                        <span class="tok-n">Percentage</span><span class="tok-p">(</span><span class="tok-n">title</span><span class="tok-o">=</span><span class="tok-n">_</span><span class="tok-p">(</span><span class="tok-s2">"Critical"</span><span class="tok-p">),</span> <span class="tok-n">default_value</span><span class="tok-o">=</span><span class="tok-mf">80.0</span><span class="tok-p">),</span>
                    <span class="tok-p">],</span>
                <span class="tok-p">)</span>
            <span class="tok-p">),</span></code></pre></div></div>
<div class="paragraph"><p>Beachten Sie, dass diese in der GUI angezeigten Werte <em>nicht</em> die Standardwerte sind, die weiter unten bei der <a href="#ruleset_defaults">Registrierung des Check-Plugins</a> per <code>check_default_parameters</code> gesetzt werden.
Wollen Sie die gleichen Standardwerte in der GUI anzeigen lassen, die auch für die Check-Funktion gelten, dann müssen Sie die Werte an beiden Stellen selbst konsistent halten.</p></div>
<div class="paragraph"><p>Zu guter Letzt registrieren Sie jetzt mithilfe der importierten und selbst definierten Dinge den neuen Regelsatz.
Dazu gibt es die Funktion <code>rulespec_registry.register()</code>:</p></div>
<div class="listingblock">
<div class="title">~/local/share/check_mk/web/plugins/wato/myhostgroups_advanced_parameters.py</div>
<div class="content"><pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-n">rulespec_registry</span><span class="tok-o">.</span><span class="tok-n">register</span><span class="tok-p">(</span>
    <span class="tok-n">CheckParameterRulespecWithItem</span><span class="tok-p">(</span>
        <span class="tok-n">check_group_name</span> <span class="tok-o">=</span> <span class="tok-s2">"myhostgroups_advanced"</span><span class="tok-p">,</span>
        <span class="tok-n">group</span> <span class="tok-o">=</span> <span class="tok-n">RulespecGroupCheckParametersApplications</span><span class="tok-p">,</span>
        <span class="tok-n">match_type</span> <span class="tok-o">=</span> <span class="tok-s2">"dict"</span><span class="tok-p">,</span>
        <span class="tok-n">item_spec</span> <span class="tok-o">=</span> <span class="tok-n">_item_valuespec_myhostgroups_advanced</span><span class="tok-p">,</span>
        <span class="tok-n">parameter_valuespec</span> <span class="tok-o">=</span> <span class="tok-n">_parameter_valuespec_myhostgroups_advanced</span><span class="tok-p">,</span>
        <span class="tok-n">title</span> <span class="tok-o">=</span> <span class="tok-k">lambda</span><span class="tok-p">:</span> <span class="tok-n">_</span><span class="tok-p">(</span><span class="tok-s2">"Host group status"</span><span class="tok-p">),</span>
    <span class="tok-p">)</span>
<span class="tok-p">)</span></code></pre></div>
</div>
<div class="paragraph"><p>Dazu die folgenden Erklärungen:</p></div>
<div class="ulist"><ul>
<li><p>Falls Ihr Check kein Item verwendet, lautet die innere Funktion <code>CheckParameterRulespecWithoutItem</code>.
Die Zeile <code>item_spec</code> entfällt dann.</p></li>
<li><p>Der <code>check_group_name</code> als Name des Regelsatzes stellt die Verbindung zu den Check-Plugins her.
Ein Check-Plugin, das diesen Regelsatz verwenden will, muss beim Registrieren diesen Namen als <code>check_ruleset_name</code> verwenden.
Der Name darf auf keinen Fall identisch sein mit einem bereits existierenden Regelsatz, weil dieser damit überschrieben würde.
Um dieser Gefahr aus dem Weg zu gehen, verwenden Sie am besten im Namen einen Präfix.</p></li>
<li><p>Die <code>group</code> legt fest, wo im <span class="guihint">Setup</span> der Regelsatz auftauchen soll.
Mit dem im Beispiel gewählten Wert finden Sie ihn unter <span class="guihint">Setup &gt; Services &gt; Service monitoring rules</span> im ersten Kasten <span class="guihint">Applications, Processes &amp; Services.</span>
Die meisten dieser Gruppen sind in der Datei <code>~/lib/check_mk/gui/plugins/wato/utils/__init__.py</code> definiert.
Dort finden Sie auch Beispiele, wie Sie eine eigene neue Gruppe anlegen können.</p></li>
<li><p>Der <code>match_type</code> ist immer <code>"dict"</code>.</p></li>
<li><p>Als <code>item_spec</code> und <code>parameter_valuespec</code> geben Sie die Namen der beiden zuvor erstellten Funktionen ein.</p></li>
<li><p><code>title</code> legt den Titel des Regelsatzes fest, so wie er auch in der Checkmk-GUI erscheint.
Der Titel wird aber nicht direkt als Text, sondern als ausführbare Funktion angegeben, welche den Text zurückliefert (deswegen das <code>lambda:</code>).</p></li>
</ul></div>
</div>
<div class="sect3">
<h4 id="heading_test_ruleset">
<span class="hidden-anchor sr-only" id="test_ruleset"></span>Regelsatz testen</h4>
<div class="paragraph"><p>Wenn Sie die Datei für den Regelsatz angelegt haben, sollten Sie ausprobieren, ob alles soweit funktioniert — noch ohne Verbindung zum Check-Plugin.
Dazu müssen Sie zuerst den Apache der Instanz neu starten, damit die neue Datei gelesen wird.
Das macht der Befehl:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="console"><span></span><span class="tok-gp">OMD[mysite]:~$ </span>omd<span class="tok-w"> </span>restart<span class="tok-w"> </span>apache</code></pre></div></div>
<div class="paragraph"><p>Danach sollte der Regelsatz im <span class="guihint">Setup</span> auf der oben genannten Seite zu finden sein.
Mit der Suchfunktion im Setup-Menü finden Sie den Regelsatz auch — aber erst nach einem Neustart von Redis:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="console"><span></span><span class="tok-gp">OMD[mysite]:~$ </span>omd<span class="tok-w"> </span>restart<span class="tok-w"> </span>redis</code></pre></div></div>
<div class="paragraph"><p>Der soeben definierte Regelsatz sieht in der GUI so aus:</p></div>
<div class="imageblock"><div class="content"><img src="../images/devel_cpi_ruleset.png" alt="Der neu erstellte Regelsatz im Setup."></div></div>
<div class="paragraph"><p>In der Bedingung finden Sie das definierte Feld <span class="guihint">Host group name</span> mit der Inline-Hilfe:</p></div>
<div class="imageblock"><div class="content"><img src="../images/devel_cpi_ruleset_condition.png" alt="Das Feld zur Service-Auswahl in der Regelbedingung."></div></div>
<div class="paragraph"><p>Die Texte zum Umgang mit den regulären Ausrücken hat übrigens Checkmk Ihrem Regelsatz spendiert.</p></div>
<div class="paragraph"><p>Legen Sie eine Regel an und probieren Sie verschiedene Werte aus, wie im obigen Screenshot gezeigt.
Wenn das ohne Fehler geht, können Sie die Check-Parameter jetzt in der Check-Funktion verwenden.</p></div>
</div>
<div class="sect3">
<h4 id="heading_use_ruleset">
<span class="hidden-anchor sr-only" id="use_ruleset"></span>Regelsatz im Check-Plugin benutzen</h4>
<div class="paragraph"><p>Damit die Regel zum Greifen kommt, müssen Sie dem Check-Plugin erlauben, Check-Parameter entgegenzunehmen und ihm sagen, welche Regel benutzt werden soll.
Dazu fügen Sie zwei neue Zeilen in die Registrierungsfunktion ein:</p></div>
<div class="listingblock">
<div class="title">~/local/lib/check_mk/base/plugins/agent_based/myhostgroups.py</div>
<div class="content"><pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-n">register</span><span class="tok-o">.</span><span class="tok-n">check_plugin</span><span class="tok-p">(</span>
    <span class="tok-n">name</span> <span class="tok-o">=</span> <span class="tok-s2">"myhostgroups_advanced"</span><span class="tok-p">,</span>
    <span class="tok-n">sections</span> <span class="tok-o">=</span> <span class="tok-p">[</span><span class="tok-s2">"myhostgroups"</span><span class="tok-p">],</span>
    <span class="tok-n">service_name</span> <span class="tok-o">=</span> <span class="tok-s2">"Host group </span><span class="tok-si">%s</span><span class="tok-s2">"</span><span class="tok-p">,</span>
    <span class="tok-n">discovery_function</span> <span class="tok-o">=</span> <span class="tok-n">discover_myhostgroups_advanced</span><span class="tok-p">,</span>
    <span class="tok-n">check_function</span> <span class="tok-o">=</span> <span class="tok-n">check_myhostgroups_advanced</span><span class="tok-p">,</span>
<span class="hll">    <span class="tok-n">check_default_parameters</span> <span class="tok-o">=</span> <span class="tok-p">{},</span>
</span><span class="hll">    <span class="tok-n">check_ruleset_name</span> <span class="tok-o">=</span> <span class="tok-s2">"myhostgroups_advanced"</span><span class="tok-p">,</span>
</span><span class="tok-p">)</span></code></pre></div>
</div>
<div class="paragraph"><p>Mit dem Eintrag <code>check_default_parameters</code> können Sie die Standardwerte setzen, die gelten, solange noch keine Regel angelegt ist.
Bei der Registrierung muss diese Zeile unbedingt vorhanden sein.
Im einfachsten Fall übergeben Sie ein leeres Dictionary <code>{}</code>.</p></div>
<div class="paragraph"><p>Als zweites übergeben Sie der Registrierungsfunktion noch den <code>check_ruleset_name</code>, also den Namen, den Sie oben mittels <code>check_group_name</code> an den Regelsatz vergeben haben.
So weiß Checkmk aus welchem Regelsatz die Parameter bestimmt werden sollen.</p></div>
<div class="paragraph"><p>Nun wird Checkmk versuchen, der Check-Funktion Parameter zu übergeben.
Damit das klappen kann, müssen Sie die Check-Funktion so erweitern, dass sie das Argument <code>params</code> erwartet, welches sich zwischen <code>item</code> und <code>section</code> schiebt:</p></div>
<div class="listingblock">
<div class="title">~/local/lib/check_mk/base/plugins/agent_based/myhostgroups.py</div>
<div class="content"><pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">def</span> <span class="tok-nf">check_myhostgroups_advanced</span><span class="tok-p">(</span><span class="tok-n">item</span><span class="tok-p">,</span> <span class="tok-n">params</span><span class="tok-p">,</span> <span class="tok-n">section</span><span class="tok-p">):</span></code></pre></div>
</div>
<div class="paragraph"><p>Falls Sie einen Check ohne Item bauen, entfällt das <code>item</code> und <code>params</code> steht am Anfang.</p></div>
<div class="paragraph"><p>Es ist sehr empfehlenswert, sich jetzt als ersten Test den Inhalt der Variable <code>params</code> mit einem <code>print</code> ausgeben zu lassen:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">def</span> <span class="tok-nf">check_myhostgroups_advanced</span><span class="tok-p">(</span><span class="tok-n">item</span><span class="tok-p">,</span> <span class="tok-n">params</span><span class="tok-p">,</span> <span class="tok-n">section</span><span class="tok-p">):</span>
    <span class="tok-nb">print</span><span class="tok-p">(</span><span class="tok-n">params</span><span class="tok-p">)</span></code></pre></div></div>
<div class="paragraph"><p>Bei der Ausführung des Check-Plugins sehen die beiden ausgedruckten Zeilen (für jeden Service eine) dann etwa so aus:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="console"><span></span><span class="tok-gp">OMD[mysite]:~$ </span>cmk<span class="tok-w"> </span>--detect-plugins<span class="tok-o">=</span>myhostgroups_advanced<span class="tok-w"> </span>-v<span class="tok-w"> </span>localhost
<span class="tok-go">Parameters({'hosts_up_lower': (70.0, 60.0), 'services_ok_lower': (75.0, 65.0)})</span>
<span class="tok-go">Parameters({'hosts_up_lower': (70.0, 60.0), 'services_ok_lower': (75.0, 65.0)})</span>
<span class="tok-go">Parameters({'hosts_up_lower': (70.0, 60.0), 'services_ok_lower': (75.0, 65.0)})</span></code></pre></div></div>
<div class="paragraph"><p><strong>Wichtig:</strong> Wenn alles fertig ist und funktioniert, entfernen Sie unbedingt die <code>print</code>-Befehle wieder.
Diese können die interne Kommunikation von Checkmk durcheinanderbringen.</p></div>
<div class="paragraph"><p>Nun passen Sie Ihre Check-Funktion weiter an, so dass die übergebenen Parameter ihre Wirkung entfalten können.
Holen Sie sich die beiden Tupel mit dem in der Regel gewählten Namen aus den Parametern:</p></div>
<div class="listingblock">
<div class="title">~/local/lib/check_mk/base/plugins/agent_based/myhostgroups.py</div>
<div class="content"><pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">def</span> <span class="tok-nf">check_myhostgroups_advanced</span><span class="tok-p">(</span><span class="tok-n">item</span><span class="tok-p">,</span> <span class="tok-n">params</span><span class="tok-p">,</span> <span class="tok-n">section</span><span class="tok-p">):</span>
    <span class="tok-n">hosts_up_lower</span> <span class="tok-o">=</span> <span class="tok-n">params</span><span class="tok-p">[</span><span class="tok-s2">"hosts_up_lower"</span><span class="tok-p">]</span>
    <span class="tok-n">services_ok_lower</span> <span class="tok-o">=</span> <span class="tok-n">params</span><span class="tok-p">[</span><span class="tok-s2">"services_ok_lower"</span><span class="tok-p">]</span></code></pre></div>
</div>
<div class="paragraph"><p>Weiter unten in der Check-Funktion werden dann die bisher hart kodierten Schwellwerte <code>(90, 80)</code> durch die Variablen <code>hosts_up_lower</code> und <code>services_ok_lower</code> ersetzt:</p></div>
<div class="listingblock">
<div class="title">~/local/lib/check_mk/base/plugins/agent_based/myhostgroups.py</div>
<div class="content"><pre class="pygments highlight"><code data-lang="python"><span></span>    <span class="tok-n">hosts_up_perc</span> <span class="tok-o">=</span> <span class="tok-mf">100.0</span> <span class="tok-o">*</span> <span class="tok-n">num_hosts_up</span> <span class="tok-o">/</span> <span class="tok-n">num_hosts</span>
    <span class="tok-k">yield from</span> <span class="tok-n">check_levels</span><span class="tok-p">(</span>
        <span class="tok-n">hosts_up_perc</span><span class="tok-p">,</span>
<span class="hll">        <span class="tok-n">levels_lower</span> <span class="tok-o">=</span> <span class="tok-p">(</span><span class="tok-n">hosts_up_lower</span><span class="tok-p">),</span>
</span>        <span class="tok-n">metric_name</span> <span class="tok-o">=</span> <span class="tok-s2">"hosts_up_perc"</span><span class="tok-p">,</span>
        <span class="tok-n">label</span><span class="tok-o">=</span><span class="tok-s2">"UP hosts"</span><span class="tok-p">,</span>
        <span class="tok-n">boundaries</span> <span class="tok-o">=</span> <span class="tok-p">(</span><span class="tok-mi">0</span><span class="tok-p">,</span> <span class="tok-mi">100</span><span class="tok-p">),</span>
        <span class="tok-n">notice_only</span> <span class="tok-o">=</span> <span class="tok-kc">True</span><span class="tok-p">,</span>
    <span class="tok-p">)</span>
    <span class="tok-n">services_ok_perc</span> <span class="tok-o">=</span> <span class="tok-mf">100.0</span> <span class="tok-o">*</span> <span class="tok-n">num_services_ok</span> <span class="tok-o">/</span> <span class="tok-n">num_services</span>
    <span class="tok-k">yield from</span> <span class="tok-n">check_levels</span><span class="tok-p">(</span>
        <span class="tok-n">services_ok_perc</span><span class="tok-p">,</span>
<span class="hll">        <span class="tok-n">levels_lower</span> <span class="tok-o">=</span> <span class="tok-p">(</span><span class="tok-n">services_ok_lower</span><span class="tok-p">),</span>
</span>        <span class="tok-n">metric_name</span> <span class="tok-o">=</span> <span class="tok-s2">"services_ok_perc"</span><span class="tok-p">,</span>
        <span class="tok-n">label</span> <span class="tok-o">=</span> <span class="tok-s2">"OK services"</span><span class="tok-p">,</span>
        <span class="tok-n">boundaries</span> <span class="tok-o">=</span> <span class="tok-p">(</span><span class="tok-mi">0</span><span class="tok-p">,</span> <span class="tok-mi">100</span><span class="tok-p">),</span>
        <span class="tok-n">notice_only</span> <span class="tok-o">=</span> <span class="tok-kc">True</span><span class="tok-p">,</span>
    <span class="tok-p">)</span></code></pre></div>
</div>
<div class="paragraph"><p>Falls eine Regel konfiguriert ist, können Sie nun die Host-Gruppen des Beispiels mit den über die GUI gesetzten Schwellwerten überwachen.
Wenn allerdings keine Regel definiert ist, wird diese Check-Funktion abstürzen:
Da die Default-Parameter des Check-Plugins nicht befüllt sind, wird das Plugin bei Abwesenheit einer Regel einen <code>KeyError</code> erzeugen.</p></div>
<div class="paragraph" id="ruleset_defaults"><p>Dieses Problem kann aber behoben werden, wenn bei der Registrierung die Standardwerte gesetzt sind:</p></div>
<div class="listingblock">
<div class="title">~/local/lib/check_mk/base/plugins/agent_based/myhostgroups.py</div>
<div class="content"><pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-n">register</span><span class="tok-o">.</span><span class="tok-n">check_plugin</span><span class="tok-p">(</span>
    <span class="tok-n">name</span> <span class="tok-o">=</span> <span class="tok-s2">"myhostgroups_advanced"</span><span class="tok-p">,</span>
    <span class="tok-n">sections</span> <span class="tok-o">=</span> <span class="tok-p">[</span><span class="tok-s2">"myhostgroups"</span><span class="tok-p">],</span>
    <span class="tok-n">service_name</span> <span class="tok-o">=</span> <span class="tok-s2">"Host group </span><span class="tok-si">%s</span><span class="tok-s2">"</span><span class="tok-p">,</span>
    <span class="tok-n">discovery_function</span> <span class="tok-o">=</span> <span class="tok-n">discover_myhostgroups_advanced</span><span class="tok-p">,</span>
    <span class="tok-n">check_function</span> <span class="tok-o">=</span> <span class="tok-n">check_myhostgroups_advanced</span><span class="tok-p">,</span>
<span class="hll">    <span class="tok-n">check_default_parameters</span> <span class="tok-o">=</span> <span class="tok-p">{</span><span class="tok-s2">"hosts_up_lower"</span><span class="tok-p">:</span> <span class="tok-p">(</span><span class="tok-mi">90</span><span class="tok-p">,</span> <span class="tok-mi">80</span><span class="tok-p">),</span> <span class="tok-s2">"services_ok_lower"</span><span class="tok-p">:</span> <span class="tok-p">(</span><span class="tok-mi">90</span><span class="tok-p">,</span> <span class="tok-mi">80</span><span class="tok-p">)},</span>
</span>    <span class="tok-n">check_ruleset_name</span> <span class="tok-o">=</span> <span class="tok-s2">"myhostgroups_advanced"</span><span class="tok-p">,</span>
<span class="tok-p">)</span></code></pre></div>
</div>
<div class="paragraph"><p>Sie sollten Standardwerte immer auf diese Weise übergeben (und den Fall fehlender Parameter nicht im Check-Plugin abfangen), da diese Standardwerte auch in der <span class="guihint">Setup</span>-Oberfläche angezeigt werden können.
Dazu gibt es zum Beispiel bei der Service-Erkennung eines Hosts, auf der Seite <span class="guihint">Services of host</span>, im Menü <span class="guihint">Display</span> den Eintrag <span class="guihint">Show check parameters.</span></p></div>
<div class="paragraph"><p><strong>Hinweis:</strong> Auf GitHub finden Sie sowohl die Datei mit dem
<a href="https://github.com/Checkmk/checkmk-docs/blob/2.2.0/examples/devel_check_plugins/check_plugin_advanced_myhostgroups_parameters.py" target="_blank">Regelsatz</a>
als auch das um den Regelsatz erweiterte
<a href="https://github.com/Checkmk/checkmk-docs/blob/2.2.0/examples/devel_check_plugins/check_plugin_advanced_myhostgroups.py" target="_blank">Check-Plugin.</a></p></div>
</div>
<div class="sect3">
<h4 id="heading_reuse_ruleset">
<span class="hidden-anchor sr-only" id="reuse_ruleset"></span>Vorhandenen Regelsatz verwenden</h4>
<div class="paragraph"><p>Unwahrscheinlich, doch nicht ausgeschlossen ist es, dass ein mit Checkmk ausgelieferter Regelsatz zu Ihrer Check-Funktion passt.
Das kann eigentlich nur dann der Fall sein, wenn der Check etwas prüft, für das Checkmk in gleicher Form bereits Check-Plugins hat, zum Beispiel das Überwachen einer Temperatur oder anderer mit Sensoren gemessener Werte.
Wenn aber so ein Regelsatz zu Ihrem Check-Plugin passt, dann können Sie sich die Erstellung eines eigenen Regelsatzes sparen.</p></div>
<div class="paragraph"><p>Die ausgelieferten Regelsätze für Parameter von Checks finden Sie im Verzeichnis <code>~/lib/check_mk/gui/plugins/wato/check_parameters/</code>.</p></div>
<div class="paragraph"><p>Nehmen Sie als Beispiel die Datei <code>memory_simple.py</code>.
Diese deklariert einen Regelsatz mit folgendem Abschnitt:</p></div>
<div class="listingblock">
<div class="title">~/lib/check_mk/gui/plugins/wato/check_parameters/memory_simple.py</div>
<div class="content"><pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-n">rulespec_registry</span><span class="tok-o">.</span><span class="tok-n">register</span><span class="tok-p">(</span>
    <span class="tok-n">CheckParameterRulespecWithItem</span><span class="tok-p">(</span>
<span class="hll">        <span class="tok-n">check_group_name</span> <span class="tok-o">=</span> <span class="tok-s2">"memory_simple"</span><span class="tok-p">,</span>
</span>        <span class="tok-n">group</span> <span class="tok-o">=</span> <span class="tok-n">RulespecGroupCheckParametersOperatingSystem</span><span class="tok-p">,</span>
        <span class="tok-n">item_spec</span> <span class="tok-o">=</span> <span class="tok-n">_item_spec_memory_simple</span><span class="tok-p">,</span>
        <span class="tok-n">match_type</span> <span class="tok-o">=</span> <span class="tok-s2">"dict"</span><span class="tok-p">,</span>
        <span class="tok-n">parameter_valuespec</span> <span class="tok-o">=</span> <span class="tok-n">_parameter_valuespec_memory_simple</span><span class="tok-p">,</span>
        <span class="tok-n">title</span> <span class="tok-o">=</span> <span class="tok-k">lambda</span><span class="tok-p">:</span> <span class="tok-n">_</span><span class="tok-p">(</span><span class="tok-s2">"Main memory usage of simple devices"</span><span class="tok-p">),</span>
    <span class="tok-p">)</span>
<span class="tok-p">)</span></code></pre></div>
</div>
<div class="paragraph"><p>Entscheidend ist dabei, wie beim selbst geschriebenen Regelsatz, das Schlüsselwort <code>check_group_name</code>, welches hier auf <code>"memory_simple"</code> gesetzt ist.
Damit wird die Verbindung zum Check-Plugin hergestellt.
Das machen Sie beim Registrieren des Check-Plugins mit dem Schlüsselwort <code>check_ruleset_name</code>, zum Beispiel so:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-n">register</span><span class="tok-o">.</span><span class="tok-n">check_plugin</span><span class="tok-p">(</span>
    <span class="tok-n">name</span> <span class="tok-o">=</span> <span class="tok-s2">"foobar"</span><span class="tok-p">,</span>
    <span class="tok-n">service_name</span> <span class="tok-o">=</span> <span class="tok-s2">"Foobar </span><span class="tok-si">%s</span><span class="tok-s2">"</span><span class="tok-p">,</span>
    <span class="tok-n">discovery_function</span> <span class="tok-o">=</span> <span class="tok-n">discover_foobar</span><span class="tok-p">,</span>
    <span class="tok-n">check_function</span> <span class="tok-o">=</span> <span class="tok-n">check_foobar</span><span class="tok-p">,</span>
<span class="hll">    <span class="tok-n">check_ruleset_name</span> <span class="tok-o">=</span> <span class="tok-s2">"memory_simple"</span><span class="tok-p">,</span>
</span>    <span class="tok-n">check_default_parameters</span> <span class="tok-o">=</span> <span class="tok-p">{},</span>
<span class="tok-p">)</span></code></pre></div></div>
<div class="paragraph"><p>Notwendig ist auch hier die Definition von Standardwerten über das Schlüsselwort <code>check_default_parameters</code>.</p></div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="heading_metrics_advanced">
<span class="hidden-anchor sr-only" id="metrics_advanced"></span>5. Darstellung von Metriken anpassen</h2>
<div class="sectionbody">
<div class="paragraph"><p>Im <a href="#metrics">obigen Beispiel</a> haben Sie das Check-Plugin <code>myhostgroups_advanced</code> Metriken für alle gemessenen und berechneten Werte erzeugen lassen.
Dazu haben wir zwei Wege vorgestellt.
Zuerst wurden die Metriken der berechneten Werte als Bestandteil der Funktion <code>check_levels()</code> mit dem Argument <code>metric_name</code> erstellt, zum Beispiel so:</p></div>
<div class="listingblock">
<div class="title">~/local/lib/check_mk/base/plugins/agent_based/myhostgroups.py</div>
<div class="content"><pre class="pygments highlight"><code data-lang="python"><span></span>    <span class="tok-k">yield from</span> <span class="tok-n">check_levels</span><span class="tok-p">(</span>
        <span class="tok-n">services_ok_perc</span><span class="tok-p">,</span>
        <span class="tok-n">levels_lower</span> <span class="tok-o">=</span> <span class="tok-p">(</span><span class="tok-n">services_ok_lower</span><span class="tok-p">),</span>
        <span class="tok-n">metric_name</span> <span class="tok-o">=</span> <span class="tok-s2">"services_ok_perc"</span><span class="tok-p">,</span>
        <span class="tok-n">label</span> <span class="tok-o">=</span> <span class="tok-s2">"OK services"</span><span class="tok-p">,</span>
        <span class="tok-n">boundaries</span> <span class="tok-o">=</span> <span class="tok-p">(</span><span class="tok-mf">0.0</span><span class="tok-p">,</span> <span class="tok-mf">100.0</span><span class="tok-p">),</span>
        <span class="tok-n">notice_only</span> <span class="tok-o">=</span> <span class="tok-kc">True</span><span class="tok-p">,</span>
    <span class="tok-p">)</span></code></pre></div>
</div>
<div class="paragraph"><p>Dann haben wir die gemessenen Metriken direkt mit dem Objekt <code>Metric()</code> erzeugt — für die Anzahl der Services im Zustand <span class="state0">OK</span> zum Beispiel so:</p></div>
<div class="listingblock">
<div class="title">~/local/lib/check_mk/base/plugins/agent_based/myhostgroups.py</div>
<div class="content"><pre class="pygments highlight"><code data-lang="python"><span></span>    <span class="tok-k">yield</span> <span class="tok-n">Metric</span><span class="tok-p">(</span><span class="tok-n">name</span><span class="tok-o">=</span><span class="tok-s2">"num_services_ok"</span><span class="tok-p">,</span> <span class="tok-n">value</span><span class="tok-o">=</span><span class="tok-n">num_services_ok</span><span class="tok-p">)</span></code></pre></div>
</div>
<div class="paragraph"><p>Metriken werden in der grafischen Benutzeroberfläche von Checkmk zwar sofort sichtbar, ohne dass Sie etwas dafür tun müssen.
Allerdings gibt es dabei ein paar Einschränkungen:</p></div>
<div class="ulist"><ul>
<li><p>Es werden nicht automatisch passende Metriken in einem Graphen kombiniert, sondern jede erscheint einzeln.</p></li>
<li><p>Die Metrik hat keinen richtigen Titel, sondern es wird der interne Variablenname der Metrik gezeigt.</p></li>
<li><p>Es wird keine Einheit verwendet, die eine sinnvolle Darstellung erlaubt (zum Beispiel GB anstelle von einzelnen Bytes).</p></li>
<li><p>Es wird zufällig eine Farbe ausgewählt.</p></li>
<li><p>Es erscheint nicht automatisch ein „Perf-O-Meter“, also die grafische Vorschau der Metrik als Balken in der Service-Liste (zum Beispiel in der Ansicht, die alle Services eines Hosts darstellt).</p></li>
</ul></div>
<div class="paragraph"><p>Um die Darstellung Ihrer Metriken in diesen Belangen zu vervollständigen, benötigen Sie <em>Metrikdefinitionen.</em></p></div>
<div class="paragraph"><p><strong>Hinweis:</strong> Beachten Sie, dass die in diesem Kapitel vorgestellten Beispiele <em>nicht</em> durch die Check-API abgedeckt sind.</p></div>
<div class="sect2">
<h3 id="heading_reuse_metricdefinition">
<span class="hidden-anchor sr-only" id="reuse_metricdefinition"></span>5.1. Vorhandene Metrikdefinitionen verwenden</h3>
<div class="paragraph"><p>Bevor Sie eine neue Metrikdefinition erstellen, sollten Sie zunächst prüfen, ob Checkmk nicht bereits eine geeignete Definition mitbringt.
Die vordefinierten Metrikdefinitionen finden Sie im Verzeichnis <code>~/lib/check_mk/gui/plugins/metrics/</code>.</p></div>
<div class="paragraph"><p>In der Datei <code>cpu.py</code> finden Sie beispielsweise die Metrik mit dem Namen <code>util</code> für die CPU-Auslastung (<em>CPU utilization</em>):</p></div>
<div class="listingblock">
<div class="title">~/lib/check_mk/gui/plugins/metrics/cpu.py</div>
<div class="content"><pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-n">metric_info</span><span class="tok-p">[</span><span class="tok-s2">"util"</span><span class="tok-p">]</span> <span class="tok-o">=</span> <span class="tok-p">{</span>
    <span class="tok-s2">"title"</span><span class="tok-p">:</span> <span class="tok-n">_l</span><span class="tok-p">(</span><span class="tok-s2">"CPU utilization"</span><span class="tok-p">),</span>
    <span class="tok-s2">"unit"</span><span class="tok-p">:</span> <span class="tok-s2">"%"</span><span class="tok-p">,</span>
    <span class="tok-s2">"color"</span><span class="tok-p">:</span> <span class="tok-s2">"26/a"</span><span class="tok-p">,</span>
<span class="tok-p">}</span></code></pre></div>
</div>
<div class="paragraph"><p>Falls Ihr Check-Plugin die CPU-Auslastung in Prozent misst, können Sie diese Metrikdefinition problemlos verwenden.
Sie müssen lediglich in Ihrer Check-Funktion <code>"util"</code> als den Namen für die Metrik einsetzen.
Alles andere leitet sich dann automatisch davon ab.</p></div>
</div>
<div class="sect2">
<h3 id="heading_new_metricdefinition">
<span class="hidden-anchor sr-only" id="new_metricdefinition"></span>5.2. Neue Metrikdefinition erstellen</h3>
<div class="paragraph"><p>Falls keine passende Metrikdefinition dabei ist, legen Sie einfach selbst eine an.</p></div>
<div class="paragraph"><p>Für unser Beispiel definieren Sie nun eine eigene Metrik für die Anzahl der Services im Zustand <span class="state0">OK</span>.
Dazu legen Sie eine Datei in <code>~/local/share/check_mk/web/plugins/metrics</code> an:</p></div>
<div class="listingblock">
<div class="title">~/local/share/check_mk/web/plugins/metrics/myhostgroups_advanced_metrics.py</div>
<div class="content"><pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-kn">from</span> <span class="tok-nn">cmk.gui.i18n</span> <span class="tok-kn">import</span> <span class="tok-n">_</span>

<span class="tok-kn">from</span> <span class="tok-nn">cmk.gui.plugins.metrics</span> <span class="tok-kn">import</span> <span class="tok-n">metric_info</span>

<span class="tok-n">metric_info</span><span class="tok-p">[</span><span class="tok-s2">"num_services_ok"</span><span class="tok-p">]</span> <span class="tok-o">=</span> <span class="tok-p">{</span>
    <span class="tok-s2">"title"</span><span class="tok-p">:</span> <span class="tok-n">_</span><span class="tok-p">(</span><span class="tok-s2">"Services in OK status"</span><span class="tok-p">),</span>
    <span class="tok-s2">"unit"</span><span class="tok-p">:</span> <span class="tok-s2">"count"</span><span class="tok-p">,</span>
    <span class="tok-s2">"color"</span><span class="tok-p">:</span> <span class="tok-s2">"15/a"</span><span class="tok-p">,</span>
<span class="tok-p">}</span></code></pre></div>
</div>
<div class="paragraph"><p>Hier die Erklärung dazu:</p></div>
<div class="ulist"><ul>
<li><p>Das Importieren und Verwenden des Unterstrichs (<code>_</code>) für die Internationalisierung ist optional, wie bereits bei der Erstellung von <a href="#new_ruleset">Regelsätzen</a> besprochen.</p></li>
<li><p>Der Schlüssel (hier <code>"num_services_ok"</code>) ist der Metrikname und muss dem entsprechen, was die Check-Funktion ausgibt.
Wählen Sie einen eindeutigen Namen, so dass keine vorhandene Metrik „überschrieben“ wird.</p></li>
<li><p>Der <code>title</code> ist die Überschrift im Metrikgraphen und ersetzt den bisher verwendeten internen Variablennamen.</p></li>
<li><p>Welche Definitionen es für Einheiten (<code>unit</code>) gibt, erfahren Sie in der Datei <code>~/lib/check_mk/gui/plugins/metrics/unit.py</code>.</p></li>
<li><p>Die Farbdefinition <code>color</code> verwendet eine Palette.
Zu jeder Palettenfarbe gibt es <code>/a</code> und <code>/b</code>.
Dies sind zwei Schattierungen der gleichen Farbe.
In den vorhandenen Metrikdefinitionen werden Sie auch viele direkte Farbkodierungen wie <code>"#ff8800"</code> finden.
Diese werden nach und nach abgeschafft und durch Palettenfarben ersetzt, da diese ein einheitlicheres Aussehen bieten und auch leichter an die Farbthemen der GUI angepasst werden können.</p></li>
</ul></div>
<div class="paragraph"><p>Diese Definition in der Metrikdatei sorgt jetzt dafür, dass Titel, Einheit und Farbe der Metrik angepasst dargestellt werden.</p></div>
<div class="paragraph"><p>Analog zur Erstellung einer <a href="#test_ruleset">Regelsatzdatei</a> muss die Metrikdatei erst gelesen werden, bevor die Änderung in der GUI sichtbar ist.
Das macht der Neustart des Apache der Instanz:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="console"><span></span><span class="tok-gp">OMD[mysite]:~$ </span>omd<span class="tok-w"> </span>restart<span class="tok-w"> </span>apache</code></pre></div></div>
<div class="paragraph"><p>Der Metrikgraph sieht dann in der Checkmk-GUI ungefähr so aus:</p></div>
<div class="imageblock"><div class="content"><img src="../images/devel_cpi_new_metric.png" alt="Die neue Metrikdefinition in den Service-Details."></div></div>
</div>
<div class="sect2">
<h3 id="heading_graph_multiple_metrics">
<span class="hidden-anchor sr-only" id="graph_multiple_metrics"></span>5.3. Graph mit mehreren Metriken</h3>
<div class="paragraph"><p>Möchten Sie mehrere Metriken in einem Graphen kombinieren (was oft sehr sinnvoll ist), benötigen Sie eine Graphdefinition, die Sie der im vorherigen Abschnitt erstellten Metrikdatei hinzufügen können.
Dies geschieht über das globale Dictionary <code>graph_info</code>.</p></div>
<div class="paragraph"><p>Für unser Beispiel sollen die beiden Metriken <code>num_services_ok</code> und <code>num_services</code> in einem Graphen dargestellt werden.
Die Metrikdefinitionen dazu sehen wie folgt aus:</p></div>
<div class="listingblock">
<div class="title">~/local/share/check_mk/web/plugins/metrics/myhostgroups_advanced_metrics.py</div>
<div class="content"><pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-kn">from</span> <span class="tok-nn">cmk.gui.i18n</span> <span class="tok-kn">import</span> <span class="tok-n">_</span>

<span class="tok-kn">from</span> <span class="tok-nn">cmk.gui.plugins.metrics</span> <span class="tok-kn">import</span> <span class="tok-p">(</span>
    <span class="tok-n">metric_info</span><span class="tok-p">,</span>
    <span class="tok-n">graph_info</span><span class="tok-p">,</span>
<span class="tok-p">)</span>

<span class="tok-n">metric_info</span><span class="tok-p">[</span><span class="tok-s2">"num_services_ok"</span><span class="tok-p">]</span> <span class="tok-o">=</span> <span class="tok-p">{</span>
    <span class="tok-s2">"title"</span><span class="tok-p">:</span> <span class="tok-n">_</span><span class="tok-p">(</span><span class="tok-s2">"Services in OK status"</span><span class="tok-p">),</span>
    <span class="tok-s2">"unit"</span><span class="tok-p">:</span> <span class="tok-s2">"count"</span><span class="tok-p">,</span>
    <span class="tok-s2">"color"</span><span class="tok-p">:</span> <span class="tok-s2">"15/a"</span><span class="tok-p">,</span>
<span class="tok-p">}</span>

<span class="tok-n">metric_info</span><span class="tok-p">[</span><span class="tok-s2">"num_services"</span><span class="tok-p">]</span> <span class="tok-o">=</span> <span class="tok-p">{</span>
    <span class="tok-s2">"title"</span><span class="tok-p">:</span> <span class="tok-n">_</span><span class="tok-p">(</span><span class="tok-s2">"Number of services"</span><span class="tok-p">),</span>
    <span class="tok-s2">"unit"</span><span class="tok-p">:</span> <span class="tok-s2">"count"</span><span class="tok-p">,</span>
    <span class="tok-s2">"color"</span><span class="tok-p">:</span> <span class="tok-s2">"24/a"</span><span class="tok-p">,</span>
<span class="tok-p">}</span></code></pre></div>
</div>
<div class="paragraph"><p>Fügen Sie nun einen Graphen an, der diese beiden Metriken als Linien einzeichnet:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-n">graph_info</span><span class="tok-p">[</span><span class="tok-s2">"num_services_combined"</span><span class="tok-p">]</span> <span class="tok-o">=</span> <span class="tok-p">{</span>
    <span class="tok-s2">"metrics"</span><span class="tok-p">:</span> <span class="tok-p">[</span>
        <span class="tok-p">(</span><span class="tok-s2">"num_services_ok"</span><span class="tok-p">,</span> <span class="tok-s2">"line"</span><span class="tok-p">),</span>
        <span class="tok-p">(</span><span class="tok-s2">"num_services"</span><span class="tok-p">,</span> <span class="tok-s2">"line"</span><span class="tok-p">),</span>
    <span class="tok-p">],</span>
<span class="tok-p">}</span></code></pre></div></div>
<div class="paragraph"><p>Der erste Eintrag unter <code>metrics</code> legt fest, welche Metrik für den Titel des Graphen genommen wird.
Das Resultat ist der kombinierte Graph in der Checkmk-GUI:</p></div>
<div class="imageblock"><div class="content"><img src="../images/devel_cpi_graph_two_metrics.png" alt="Der Graph zeigt beide Metriken in den Service-Details."></div></div>
</div>
<div class="sect2">
<h3 id="heading_perfometer">
<span class="hidden-anchor sr-only" id="perfometer"></span>5.4. Metriken im Perf-O-Meter</h3>
<div class="paragraph"><p>Möchten Sie zu einer Metrik noch ein Perf-O-Meter in der Zeile der Service-Liste anzeigen?
Das könnte zum Beispiel so aussehen:</p></div>
<div class="imageblock">
<div class="content"><img src="../images/devel_cpi_perfometer_logarithmic.png" alt="Das Perf-O-Meter zeigt die Anzahl der Services im Status 'OK'."></div>
<div class="title">Das Perf-O-Meter zeigt die absolute Zahl der Services</div>
</div>
<div class="paragraph"><p>Um so ein Perf-O-Meter zu erstellen, benötigen Sie eine weitere Datei, diesmal im Verzeichnis <code>~/local/share/check_mk/web/plugins/perfometer</code>:</p></div>
<div class="listingblock">
<div class="title">~/local/share/check_mk/web/plugins/perfometer/myhostgroups_advanced_perfometer.py</div>
<div class="content"><pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-kn">from</span> <span class="tok-nn">cmk.gui.plugins.metrics</span> <span class="tok-kn">import</span> <span class="tok-n">perfometer_info</span>

<span class="tok-n">perfometer_info</span><span class="tok-o">.</span><span class="tok-n">append</span><span class="tok-p">(</span>
    <span class="tok-p">{</span>
        <span class="tok-s2">"type"</span><span class="tok-p">:</span> <span class="tok-s2">"logarithmic"</span><span class="tok-p">,</span>
        <span class="tok-s2">"metric"</span><span class="tok-p">:</span> <span class="tok-s2">"num_services_ok"</span><span class="tok-p">,</span>
        <span class="tok-s2">"half_value"</span><span class="tok-p">:</span> <span class="tok-mi">25</span><span class="tok-p">,</span>
        <span class="tok-s2">"exponent"</span><span class="tok-p">:</span> <span class="tok-mf">2.0</span><span class="tok-p">,</span>
    <span class="tok-p">}</span>
<span class="tok-p">)</span></code></pre></div>
</div>
<div class="paragraph"><p>Perf-O-Meter sind etwas trickreicher als Graphen, da es keine Legende gibt.
Daher ist die Darstellung des Wertebereichs schwierig.
Da das Perf-O-Meter nicht wissen kann, welche Werte denn überhaupt möglich sind, und der Platz sehr begrenzt ist, verwenden viele eingebaute Check-Plugins eine logarithmische Darstellung.
Dies ist auch im obigen Beispiel der Fall:</p></div>
<div class="ulist"><ul>
<li><p><code>type</code> wählt die Darstellungsform der Werte, hier die logarithmische Darstellung.</p></li>
<li><p><code>metric</code> bezeichnet den Namen der Metrik, hier die Anzahl der Services im Zustand <span class="state0">OK</span>.</p></li>
<li><p><code>half_value</code> ist der Messwert, welcher genau in der Mitte des Perf-O-Meters angezeigt wird. Bei einem Wert von <code>25</code> ist der Balken also halb gefüllt.</p></li>
<li><p><code>exponent</code> legt den Faktor fest, welcher notwendig ist, damit weitere 10 % des Bereichs gefüllt werden.
Also würde im Beispiel ein Messwert von <code>50</code> den Balken bis 60 % füllen, und einer von <code>100</code> bis 70 %.</p></li>
</ul></div>
<div class="paragraph"><p>Der Vorteil dieser Methode:
Wenn Sie eine Liste von Services gleicher Art mit gleichartigen Perf-O-Metern ausstatten, können Sie die Perf-O-Meter untereinander optisch schnell vergleichen, da alle die gleiche Skala nutzen.
Und trotz der kleinen Darstellungsform können Sie sowohl bei sehr kleinen als auch bei sehr großen Werten die Unterschiede gut erkennen.
Dafür sind die Werte allerdings nicht maßstabsgetreu.</p></div>
<div class="paragraph"><p>Das obige Perf-O-Meter zeigt zwar eine Metrik, aber nicht diejenige, die für den Zustand des Services verantwortlich ist.
Nicht die Anzahl der Services im Zustand <span class="state0">OK</span>, sondern ihr Prozentsatz bestimmt den Zustand des gezeigten Services der Host-Gruppe.</p></div>
<div class="paragraph"><p>Um die Metrik des Prozentsatzes (<code>services_ok_perc</code>) darzustellen, können Sie ein lineares Perf-O-Meter verwenden.
Das ist immer dann sinnvoll, wenn es einen bekannten Maximalwert gibt.
Das sähe dann zum Beispiel in der Datei so aus:</p></div>
<div class="listingblock">
<div class="title">~/local/share/check_mk/web/plugins/perfometer/myhostgroups_advanced_perfometer.py</div>
<div class="content"><pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-n">perfometer_info</span><span class="tok-o">.</span><span class="tok-n">append</span><span class="tok-p">(</span>
    <span class="tok-p">{</span>
        <span class="tok-s2">"type"</span><span class="tok-p">:</span> <span class="tok-s2">"linear"</span><span class="tok-p">,</span>
        <span class="tok-s2">"segments"</span><span class="tok-p">:</span> <span class="tok-p">[</span><span class="tok-s2">"services_ok_perc"</span><span class="tok-p">],</span>
        <span class="tok-s2">"total"</span><span class="tok-p">:</span> <span class="tok-mf">100.0</span><span class="tok-p">,</span>
    <span class="tok-p">}</span>
<span class="tok-p">)</span></code></pre></div>
</div>
<div class="paragraph"><p>Und so in der GUI:</p></div>
<div class="imageblock">
<div class="content"><img src="../images/devel_cpi_perfometer_linear.png" alt="Das Perf-O-Meter zeigt den Prozentsatz der Services im Status 'OK'."></div>
<div class="title">Hier wird der Prozentsatz der Services dargestellt</div>
</div>
<div class="paragraph"><p>Das ist schon einmal eine Verbesserung.
Allerdings wird der Zustand des Services nicht nur durch den Prozentsatz der Services im Zustand <span class="state0">OK</span>, sondern auch durch den Prozentsatz der Hosts im Zustand <span class="hstate0">UP</span> bestimmt.
Um mehrere Metriken in einem Perf-O-Meter zu kombinieren, gibt es verschiedene Möglichkeiten.
Eine davon sieht so aus:</p></div>
<div class="listingblock">
<div class="title">~/local/share/check_mk/web/plugins/perfometer/myhostgroups_advanced_perfometer.py</div>
<div class="content"><pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-n">perfometer_info</span><span class="tok-o">.</span><span class="tok-n">append</span><span class="tok-p">(</span>
    <span class="tok-p">{</span>
        <span class="tok-s2">"type"</span><span class="tok-p">:</span> <span class="tok-s2">"dual"</span><span class="tok-p">,</span>
        <span class="tok-s2">"perfometers"</span><span class="tok-p">:</span> <span class="tok-p">[</span>
            <span class="tok-p">{</span>
                <span class="tok-s2">"type"</span><span class="tok-p">:</span> <span class="tok-s2">"linear"</span><span class="tok-p">,</span>
                <span class="tok-s2">"segments"</span><span class="tok-p">:</span> <span class="tok-p">[</span><span class="tok-s2">"hosts_up_perc"</span><span class="tok-p">],</span>
                <span class="tok-s2">"total"</span><span class="tok-p">:</span> <span class="tok-mf">100.0</span><span class="tok-p">,</span>
            <span class="tok-p">},</span>
            <span class="tok-p">{</span>
                <span class="tok-s2">"type"</span><span class="tok-p">:</span> <span class="tok-s2">"linear"</span><span class="tok-p">,</span>
                <span class="tok-s2">"segments"</span><span class="tok-p">:</span> <span class="tok-p">[</span><span class="tok-s2">"services_ok_perc"</span><span class="tok-p">],</span>
                <span class="tok-s2">"total"</span><span class="tok-p">:</span> <span class="tok-mf">100.0</span><span class="tok-p">,</span>
            <span class="tok-p">},</span>
        <span class="tok-p">],</span>
    <span class="tok-p">}</span>
<span class="tok-p">)</span></code></pre></div>
</div>
<div class="paragraph"><p>Dies sorgt dafür, dass sich die beiden Metriken den Balken des Perf-O-Meters teilen und nebeneinander angezeigt werden:</p></div>
<div class="imageblock">
<div class="content"><img src="../images/devel_cpi_perfometer_linear_combined.png" alt="Das Perf-O-Meter zeigt zwei Prozentsätze nebeneinander an."></div>
<div class="title">Hier werden zwei Prozentsätze nebeneinander angezeigt</div>
</div>
<div class="paragraph"><p>Auch zu diesem Thema finden Sie viele Beispiele in den von Checkmk ausgelieferten Check-Plugins — in der Datei <code>~/lib/check_mk/gui/plugins/metrics/perfometers.py</code>.</p></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="heading_format_numbers">
<span class="hidden-anchor sr-only" id="format_numbers"></span>6. Zahlen formatieren</h2>
<div class="sectionbody">
<div class="paragraph"><p>Im <span class="guihint">Summary</span> und den <span class="guihint">Details</span> eines Services werden oft Zahlen ausgegeben.
Um Ihnen eine schöne und korrekte Formatierung möglichst einfach zu machen,
und auch um die Ausgaben von allen Check-Plugins zu vereinheitlichen, gibt es Hilfsfunktionen für die Darstellung von verschiedenen Arten von Größen.
All diese sind Unterfunktionen vom Modul <code>render</code> und werden folglich mit <code>render.</code> aufgerufen.
Zum Beispiel ergibt <code>render.bytes(2000)</code> den Text <code>1.95 KiB</code>.</p></div>
<div class="paragraph"><p>All diesen Funktionen ist gemein, dass Sie ihren Wert in einer sogenannten <em>kanonischen</em> oder natürlichen Einheit bekommen.
So muss man nie nachdenken und es gibt keine Schwierigkeiten oder Fehler bei der Umrechnung.
Beispielsweise werden Zeiten immer in Sekunden angegeben und Größen von Festplatten, Dateien etc. immer in Bytes und nicht in Kilobytes, Kibibytes, Blöcken oder sonstigem Durcheinander.</p></div>
<div class="paragraph"><p>Verwenden Sie diese Funktionen auch dann, wenn Ihnen die Darstellung nicht so gut gefällt.
Immerhin ist diese dann für den Benutzer einheitlich.
Und zukünftige Versionen von Checkmk können die Darstellung möglicherweise ändern oder sogar konfigurierbar für den Benutzer machen, wie es zum Beispiel bereits bei der Anzeige der Temperatur der Fall ist.
Davon wird dann Ihr Check-Plugin auch profitieren.</p></div>
<div class="paragraph"><p>Bevor Sie die <code>render</code>-Funktion in Ihrem Check-Plugin nutzen können, müssen Sie sie zusätzlich importieren:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-kn">from</span> <span class="tok-nn">.agent_based_api.v1</span> <span class="tok-kn">import</span> <span class="tok-n">check_levels</span><span class="tok-p">,</span> <span class="tok-n">Metric</span><span class="tok-p">,</span> <span class="tok-n">register</span><span class="tok-p">,</span> <span class="tok-n">render</span><span class="tok-p">,</span> <span class="tok-n">Result</span><span class="tok-p">,</span> <span class="tok-n">Service</span><span class="tok-p">,</span> <span class="tok-n">State</span></code></pre></div></div>
<div class="paragraph"><p>Nach der ausführlichen Beschreibung aller Darstellungsfunktionen (Render-Funktionen) finden Sie eine <a href="#numbers_summary">Zusammenfassung</a> in Form einer übersichtlichen Tabelle.</p></div>
<div class="sect2">
<h3 id="heading_time">
<span class="hidden-anchor sr-only" id="time"></span>6.1. Zeiten, Zeiträume, Frequenzen</h3>
<div class="paragraph"><p>Absolute Zeitangaben (Zeitstempel) werden mit <code>render.date()</code> oder <code>render.datetime()</code> formatiert.
Die Angaben erfolgen immer als <em>Unix-Zeit,</em> also in Sekunden ab dem 1. Januar 1970, 00:00:00 UTC — dem Beginn der <em>Unix-Epoche.</em>
Dies ist auch das Format, mit dem die Python-Funktion <code>time.time()</code> arbeitet.</p></div>
<div class="paragraph"><p>Vorteil an dieser Darstellung ist, dass sich damit sehr einfach rechnen lässt, also zum Beispiel die Berechnung des Zeitraums, wenn Start- und Endzeit bekannt sind.
Die Formel ist dann einfach <code>duration = end - start</code>.
Und diese Berechnungen funktionieren unabhängig von der Zeitzone, Sommerzeitumstellungen oder Schaltjahren.</p></div>
<div class="paragraph"><p><code>render.date()</code> gibt nur das Datum aus, <code>render.datetime()</code> fügt noch die Uhrzeit hinzu.
Die Ausgabe erfolgt dabei gemäß der aktuellen Zeitzone desjenigen Checkmk-Servers, welcher den Check ausführt.
Beispiele:</p></div>
<table class="table-responsive table-bordered table tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead><tr>
<th class="tableblock halign-left valign-top">Aufruf</th>
<th class="tableblock halign-left valign-top">Ausgabe</th>
</tr></thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>render.date(0)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Jan 01 1970</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>render.datetime(0)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Jan 01 1970 01:00:00</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>render.date(1700000000)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Nov 14 2023</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>render.datetime(1700000000)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Nov 14 2023 23:13:20</code></p></td>
</tr>
</tbody>
</table>
<div class="paragraph"><p>Wundern Sie sich jetzt nicht, dass <code>render.datetime(0)</code> als Uhrzeit nicht <code>00:00</code>, sondern <code>01:00</code> ausgibt.
Das liegt daran, dass wir dieses Handbuch in der Zeitzone von Deutschland schreiben — und die ist der Standardzeit UTC eine Stunde voraus (zumindest während der Normalzeit, denn der 1. Januar liegt ja bekanntlich nicht in der Sommerzeit).</p></div>
<div class="paragraph"><p>Für Zeiträume (oder <em>Zeitspannen</em>) gibt es noch die Funktion <code>render.timespan()</code>.
Diese bekommt eine Dauer in Sekunden und gibt das menschenlesbar aus.
Bei größeren Zeitspannen werden Sekunden oder Minuten weggelassen.
Wenn Sie eine Zeitspanne in einem <code>TimeDelta</code>-Objekt vorliegen haben, lesen Sie aus diesem mit der Funktion <code>total_seconds()</code> die Zahl der Sekunden als Fließkommazahl aus.</p></div>
<table class="table-responsive table-bordered table tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead><tr>
<th class="tableblock halign-left valign-top">Aufruf</th>
<th class="tableblock halign-left valign-top">Ausgabe</th>
</tr></thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>render.timespan(1)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>1 second</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>render.timespan(123)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>2 minutes 3 seconds</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>render.timespan(12345)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>3 hours 25 minutes</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>render.timespan(1234567)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>14 days 6 hours</code></p></td>
</tr>
</tbody>
</table>
<div class="paragraph"><p>Eine <em>Frequenz</em> ist quasi der Kehrwert der Zeit.
Die kanonische Einheit ist <em>Hz</em>, was das gleiche bedeutet wie 1 / sec.
Einsatzgebiet ist zum Beispiel die Taktrate einer CPU:</p></div>
<table class="table-responsive table-bordered table tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead><tr>
<th class="tableblock halign-left valign-top">Aufruf</th>
<th class="tableblock halign-left valign-top">Ausgabe</th>
</tr></thead>
<tbody><tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>render.frequency(111222333444)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>111 GHz</code></p></td>
</tr></tbody>
</table>
</div>
<div class="sect2">
<h3 id="heading_byte">
<span class="hidden-anchor sr-only" id="byte"></span>6.2. Bytes</h3>
<div class="paragraph"><p>Überall wo es um Arbeitsspeicher, Dateien, Festplatten, Dateisysteme und dergleichen geht, ist die kanonische Einheit das <em>Byte.</em>
Da Computer so etwas meist in Zweierpotenzen organisieren, also zum Beispiel in Einheiten zu 512, 1024 oder 65 536 Bytes, hatte sich dabei von Beginn an eingebürgert,
dass ein <em>Kilobyte</em> nicht 1000, und damit das Tausendfache der Einheit ist, sondern 1024 (2 hoch 10) Bytes.
Das ist zwar unlogisch, aber sehr praktisch, weil so meist runde Zahlen herauskommen.
Der legendäre Commodore C64 hatte eben 64 Kilobyte Speicher und nicht 65,536.</p></div>
<div class="paragraph"><p>Leider kamen irgendwann Festplattenhersteller auf die Idee, die Größen ihrer Platten in 1000er-Einheiten anzugeben.
Da bei jeder Größenordnung der Unterschied zwischen 1000 und 1024 immerhin 2,4 % ausmacht, und diese sich aufmultiplizieren,
wird so aus einer Platte der Größe 1 GB (1024 mal 1024 mal 1024) auf einmal 1,07 GB.
Das verkauft sich besser.</p></div>
<div class="paragraph"><p>Diese lästige Verwirrung besteht bis heute und sorgt immer wieder für Fehler.
Als Linderung wurden von der internationalen elektrotechnischen Kommission (IEC) neue Präfixe auf Grundlage des Binärsystems festgelegt.
Demnach ist heute offiziell ein Kilobyte 1000 Bytes und ein <em>Kibibyte</em> 1024 Bytes (2 hoch 10).
Außerdem soll man <em>Mebibyte,</em> <em>Gibibyte</em> und <em>Tebibyte</em> sagen.
Die Abkürzungen lauten dann KiB, MiB, GiB und TiB.</p></div>
<div class="paragraph"><p>Checkmk passt sich an diesen Standard an und hilft Ihnen mit mehreren angepassten Render-Funktionen dabei, dass Sie immer korrekte Ausgaben machen.
So gibt es speziell für Festplatten und Dateisysteme die Funktion <code>render.disksize()</code>, welche die Ausgabe in 1000er-Potenzen macht.</p></div>
<table class="table-responsive table-bordered table tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead><tr>
<th class="tableblock halign-left valign-top">Aufruf</th>
<th class="tableblock halign-left valign-top">Ausgabe</th>
</tr></thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>render.disksize(1000)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>1.00 kB</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>render.disksize(1024)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>1.02 kB</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>render.disksize(2000000)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>2.00 MB</code></p></td>
</tr>
</tbody>
</table>
<div class="paragraph"><p>Bei der Größe von Dateien ist es oft üblich, die genaue Größe in Bytes <em>ohne Rundung</em> anzugeben.
Dies hat den Vorteil, dass man so sehr schnell sehen kann, wenn sich eine Datei auch nur minimal geändert hat oder dass zwei Dateien (wahrscheinlich) gleich sind.
Hierfür ist die Funktion <code>render.filesize()</code> verantwortlich:</p></div>
<table class="table-responsive table-bordered table tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead><tr>
<th class="tableblock halign-left valign-top">Aufruf</th>
<th class="tableblock halign-left valign-top">Ausgabe</th>
</tr></thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>render.filesize(1000)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>1,000 B</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>render.filesize(1024)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>1,024 B</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>render.filesize(2000000)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>2,000,000 B</code></p></td>
</tr>
</tbody>
</table>
<div class="paragraph"><p>Wenn Sie eine Größe ausgeben möchten, die keine Festplatten- oder Dateigröße ist, dann verwenden Sie einfach das generische <code>render.bytes()</code>.
Hier bekommen Sie die Ausgabe in klassischen 1024er-Potenzen in der offiziellen Schreibweise:</p></div>
<table class="table-responsive table-bordered table tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead><tr>
<th class="tableblock halign-left valign-top">Aufruf</th>
<th class="tableblock halign-left valign-top">Ausgabe</th>
</tr></thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>render.bytes(1000)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>1000 B</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>render.bytes(1024)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>1.00 KiB</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>render.bytes(2000000)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>1.91 MiB</code></p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect2">
<h3 id="heading_bandwith">
<span class="hidden-anchor sr-only" id="bandwith"></span>6.3. Bandbreiten, Datenraten</h3>
<div class="paragraph"><p>Die Netzwerker haben ihre eigenen Begriffe und Arten, Dinge auszudrücken.
Und wie immer gibt sich Checkmk Mühe, in jeder Domäne die dort übliche Art zu kommunizieren, zu übernehmen.
Deswegen gibt es für Datenraten und Geschwindigkeiten gleich drei verschiedene Render-Funktionen.
Alle haben gemeinsam, dass die Raten in <em>Bytes pro Sekunde</em> übergeben werden, selbst dann, wenn die Ausgabe in Bits erfolgt!</p></div>
<div class="paragraph"><p><code>render.nicspeed()</code> stellt die Maximalgeschwindigkeit einer Netzwerkkarte oder eines Switchports dar.
Da es keine Messwerte sind, muss auch nicht gerundet werden.
Obwohl kein Port einzelne Bits versenden kann, sind die Angaben aus historischen Gründen in Bits.</p></div>
<div class="paragraph"><p><strong>Wichtig:</strong> Trotzdem müssen Sie auch hier Bytes pro Sekunde übergeben!</p></div>
<table class="table-responsive table-bordered table tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead><tr>
<th class="tableblock halign-left valign-top">Aufruf</th>
<th class="tableblock halign-left valign-top">Ausgabe</th>
</tr></thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>render.nicspeed(12500000)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>100 MBit/s</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>render.nicspeed(100000000)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>800 MBit/s</code></p></td>
</tr>
</tbody>
</table>
<div class="paragraph"><p><code>render.networkbandwidth()</code> ist gedacht für eine tatsächlich gemessene Übertragungsgeschwindigkeit im Netzwerk.
Eingabewert ist wieder Bytes pro Sekunde:</p></div>
<table class="table-responsive table-bordered table tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead><tr>
<th class="tableblock halign-left valign-top">Aufruf</th>
<th class="tableblock halign-left valign-top">Ausgabe</th>
</tr></thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>render.networkbandwidth(123)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>984 Bit/s</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>render.networkbandwidth(123456)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>988 kBit/s</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>render.networkbandwidth(123456789)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>988 MBit/s</code></p></td>
</tr>
</tbody>
</table>
<div class="paragraph"><p>Wo es nicht ums Netzwerk geht und dennoch Datenraten ausgegeben werden, sind wieder Bytes üblich.
Prominentester Fall sind IO-Raten von Festplatten.
Dafür gibt es die Funktion <code>render.iobandwidth()</code>, die in Checkmk mit 1000er-Potenzen arbeitet:</p></div>
<table class="table-responsive table-bordered table tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead><tr>
<th class="tableblock halign-left valign-top">Aufruf</th>
<th class="tableblock halign-left valign-top">Ausgabe</th>
</tr></thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>render.iobandwidth(123)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>123 B/s</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>render.iobandwidth(123456)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>123 kB/s</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>render.iobandwidth(123456789)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>123 MB/s</code></p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect2">
<h3 id="heading_percentage">
<span class="hidden-anchor sr-only" id="percentage"></span>6.4. Prozentsätze</h3>
<div class="paragraph"><p>Die Funktion <code>render.percent()</code> stellt einen Prozentsatz dar — auf zwei Nachkommastellen gerundet.
Sie ist insofern eine Ausnahme zu den anderen Funktionen, als hier nicht der eigentlich natürliche Wert — also das Verhältnis — übergeben wird, sondern wirklich die Prozentzahl.
Wenn also etwas zum Beispiel zur Hälfte voll ist, müssen Sie nicht <code>0.5</code> sondern <code>50</code> übergeben.</p></div>
<div class="paragraph"><p>Weil es manchmal interessant sein kann, zu wissen, ob ein Wert beinahe Null oder exakt Null ist, werden Werte durch Anfügen eines „<code>&lt;</code>“ Zeichens markiert,
die größer als Null, aber kleiner als 0,01 Prozent sind.</p></div>
<table class="table-responsive table-bordered table tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead><tr>
<th class="tableblock halign-left valign-top">Aufruf</th>
<th class="tableblock halign-left valign-top">Ausgabe</th>
</tr></thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>render.percent(0.004)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>&lt;0.01%</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>render.percent(18.5)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>18.50%</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>render.percent(123)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>123.00%</code></p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect2">
<h3 id="heading_numbers_summary">
<span class="hidden-anchor sr-only" id="numbers_summary"></span>6.5. Zusammenfassung</h3>
<div class="paragraph"><p>Hier folgt zum Abschluss die Übersicht über alle Render-Funktionen:</p></div>
<table class="table-responsive table-bordered table tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 20%;">
<col style="width: 20%;">
<col style="width: 40%;">
<col style="width: 20%;">
</colgroup>
<thead><tr>
<th class="tableblock halign-left valign-top">Funktion</th>
<th class="tableblock halign-left valign-top">Eingabe</th>
<th class="tableblock halign-left valign-top">Beschreibung</th>
<th class="tableblock halign-left valign-top">Beispielausgabe</th>
</tr></thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>date()</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Unix-Zeit</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Datum</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Nov 14 2023</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>datetime()</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Unix-Zeit</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Datum und Uhrzeit</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Nov 14 2023 23:13:20</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>timespan()</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Sekunden</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Dauer / Alter</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>3 hours 25 minutes</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>frequency()</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Hz</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Frequenz (z. B. Taktrate)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>111 GHz</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>disksize()</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Bytes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Größe einer Festplatte, Basis 1000</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>1,234 GB</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>filesize()</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Bytes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Größe einer Datei, volle Genauigkeit</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>1,334,560 B</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>bytes()</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Bytes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Größe, Basis 1024</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>23,4 KiB</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>nicspeed()</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Bytes pro Sekunde</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Geschwindigkeit von Netzwerkkarten</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>100 MBit/s</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>networkbandwidth()</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Bytes pro Sekunde</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Übertragungsgeschwindigkeit</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>23.50 GBit/s</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>iobandwidth()</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Bytes pro Sekunde</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">IO-Bandbreiten</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>124 MB/s</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>percent()</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Prozentzahl</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Prozentsatz, sinnvoll gerundet</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>99.997%</code></p></td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="heading_errors">
<span class="hidden-anchor sr-only" id="errors"></span>7. Fehler beheben</h2>
<div class="sectionbody">
<div class="paragraph"><p>Die korrekte Behandlung von Fehlern nimmt (leider) einen großen Teil der Programmierarbeit ein.
Dabei ist die gute Nachricht, dass Ihnen die Check-API hinsichtlich der Fehlerbehandlung bereits viel Arbeit abnimmt.
Bei einigen Arten von Fehlern ist es daher richtig, diese gar nicht selbst zu behandeln.</p></div>
<div class="paragraph"><p>Wenn Python in eine Situation kommt, die in irgendeiner Form <em>unerwartet</em> ist, reagiert es mit einer sogenannten Ausnahme (<em>Exception</em>).
Hier sind ein paar Beispiele:</p></div>
<div class="ulist"><ul>
<li><p>Sie konvertieren mit <code>int()</code> einen String in eine Zahl, aber der String enthält keine Zahl, zum Beispiel <code>int("foo")</code>.</p></li>
<li><p>Sie greifen mit <code>bar[4]</code> auf das fünfte Element von <code>bar</code> zu, aber das hat nur vier Elemente.</p></li>
<li><p>Sie rufen eine Funktion auf, die es nicht gibt.</p></li>
</ul></div>
<div class="paragraph"><p>Um entscheiden zu können, wie Sie Fehler angehen, ist es zunächst wichtig, die exakte Stelle im Code zu kennen, an der ein Fehler auftritt.
Hierfür können Sie sowohl die GUI als auch die Kommandozeile verwenden — je nachdem, wo Sie gerade arbeiten.</p></div>
<div class="sect2">
<h3 id="heading_error_exception_gui">
<span class="hidden-anchor sr-only" id="error_exception_gui"></span>7.1. Exceptions und Absturzberichte in der GUI</h3>
<div class="paragraph"><p>Tritt eine Exception im Monitoring oder während der Service-Erkennung im <span class="guihint">Setup</span> auf, enthält das <span class="guihint">Summary</span> Hinweise auf den eben erstellten Absturzbericht (<em>crash report</em>).
Das sieht dann zum Beispiel so aus:</p></div>
<div class="imageblock"><div class="content"><img src="../images/devel_cpi_service_crash_report.png" alt="Ein Service, dessen Check-Plugin abgestürzt ist."></div></div>
<div class="paragraph"><p>Durch einen Klick auf das Icon <span class="image-inline"><img src="../images/icons/icon_crash.png" alt="Symbol für ein abgestürztes Check-Plugin."></span> wird eine Seite mit Details angezeigt, auf der Sie:</p></div>
<div class="ulist"><ul>
<li><p>die Datei angezeigt bekommen, in der der Absturz stattgefunden hat,</p></li>
<li><p>alle Informationen über den Absturz erhalten, wie die Auflistung der aufgetretenen Fehler im Programm (<em>Traceback</em>), aktuelle Werte lokaler Variablen, Agentenausgabe und vieles mehr sowie</p></li>
<li><p>den Report zu uns (Checkmk GmbH) als Feedback einsenden können.</p></li>
</ul></div>
<div class="paragraph"><p>Der Traceback hilft Ihnen als Programmierer zu entscheiden, ob ein Fehler im Programm vorliegt (beispielsweise der Aufruf einer nicht vorhandenen Funktion) oder Agentendaten vorliegen, die nicht wie erwartet verarbeitet werden konnten.
Im ersten Fall werden Sie den Fehler beheben wollen, im zweiten Fall ist es häufig sinnvoll, nichts zu tun.</p></div>
<div class="paragraph"><p>Das Einsenden des Reports ist natürlich nur für Check-Plugins sinnvoll, die offiziell Teil von Checkmk sind.
Falls Sie eigene Plugins Dritten zugänglich machen, können Sie Ihre Anwender bitten, Ihnen die Daten zukommen zu lassen.</p></div>
</div>
<div class="sect2">
<h3 id="heading_error_exception_cli">
<span class="hidden-anchor sr-only" id="error_exception_cli"></span>7.2. Exceptions auf der Kommandozeile ansehen</h3>
<div class="paragraph"><p>Wenn Sie Ihr Check-Plugin auf der Kommandozeile ausführen, erhalten Sie keinen Hinweis auf die ID des erzeugten Absturzberichts.
Sie sehen nur die zusammengefasste Fehlermeldung:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="console"><span></span><span class="tok-gp">OMD[mysite]:~$ </span>cmk<span class="tok-w"> </span>--detect-plugins<span class="tok-o">=</span>myhostgroups_advanced<span class="tok-w"> </span>localhost
<span class="tok-go">Error in agent based plugin myhostgroups: invalid syntax (myhostgroups.py, line 11)</span></code></pre></div></div>
<div class="paragraph"><p>Hängen Sie die Option <code>--debug</code> als zusätzlichen Aufrufparameter an, dann bekommen Sie den Traceback des Python-Interpreters:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="console"><span></span><span class="tok-gp">OMD[mysite]:~$ </span>cmk<span class="tok-w"> </span>--debug<span class="tok-w"> </span>--detect-plugins<span class="tok-o">=</span>myhostgroups_advanced<span class="tok-w"> </span>localhost
<span class="tok-go">Traceback (most recent call last):</span>
<span class="tok-go">  File "/omd/sites/mysite/bin/cmk", line 97, in &lt;module&gt;</span>
<span class="tok-go">    errors = config.load_all_agent_based_plugins(</span>
<span class="tok-go">             <sup>^</sup><sup>^</sup><sup>^</sup><sup>^</sup><sup>^</sup><sup>^</sup><sup>^</sup><sup>^</sup><sup>^</sup><sup>^</sup><sup>^</sup><sup>^</sup></span>
<span class="tok-go">  File "/omd/sites/mysite/lib/python3/cmk/base/config.py", line 1673, in load_all_agent_based_plugins</span>
<span class="tok-go">    errors = agent_based_register.load_all_plugins()</span>
<span class="tok-go">             <sup>^</sup><sup>^</sup><sup>^</sup><sup>^</sup><sup>^</sup><sup>^</sup><sup>^</sup><sup>^</sup><sup>^</sup><sup>^</sup><sup>^</sup><sup>^</sup><sup>^</sup></span>
<span class="tok-go">  File "/omd/sites/mysite/lib/python3/cmk/base/api/agent_based/register/<em>init</em>.py", line 48, in load_all_plugins</span>
<span class="tok-go">    raise exception</span>
<span class="tok-go">  File "/omd/sites/mysite/lib/python3/cmk/utils/plugin_loader.py", line 49, in load_plugins_with_exceptions</span>
<span class="tok-go">    importlib.import_module(full_name)</span>
<span class="tok-go">  File "/omd/sites/mysite/lib/python3.11/importlib/<em>init</em>.py", line 126, in import_module</span>
<span class="tok-go">    return _bootstrap._gcd_import(name[level:], package, level)</span>
<span class="tok-go">           <sup>^</sup><sup>^</sup><sup>^</sup><sup>^</sup><sup>^</sup><sup>^</sup><sup>^</sup><sup>^</sup><sup>^</sup><sup>^</sup><sup>^</sup><sup>^</sup><sup>^</sup><sup>^</sup><sup>^</sup><sup>^</sup><sup>^</sup>^</span>
<span class="tok-go">  File "&lt;frozen importlib._bootstrap&gt;", line 1206, in _gcd_import</span>
<span class="tok-go">  File "&lt;frozen importlib._bootstrap&gt;", line 1178, in _find_and_load</span>
<span class="tok-go">  File "&lt;frozen importlib._bootstrap&gt;", line 1149, in _find_and_load_unlocked</span>
<span class="tok-go">  File "&lt;frozen importlib._bootstrap&gt;", line 690, in _load_unlocked</span>
<span class="tok-go">  File "&lt;frozen importlib._bootstrap_external&gt;", line 936, in exec_module</span>
<span class="tok-go">  File "&lt;frozen importlib._bootstrap_external&gt;", line 1074, in get_code</span>
<span class="tok-go">  File "&lt;frozen importlib._bootstrap_external&gt;", line 1004, in source_to_code</span>
<span class="tok-go">  File "&lt;frozen importlib._bootstrap&gt;", line 241, in _call_with_frames_removed</span>
<span class="tok-go">  File "/omd/sites/mysite/local/lib/python3/cmk/base/plugins/agent_based/myhostgroups.py", line 11</span>
<span class="tok-go">    parsed =</span>
<span class="tok-go">            ^</span>
<span class="tok-go">SyntaxError: invalid syntax</span></code></pre></div></div>
<div class="paragraph"><p>Tritt der Fehler beim Aufruf mit <code>--debug</code> beim nächsten Mal nicht mehr auf, zum Beispiel, weil eine neue Agentenausgabe bereitsteht, können Sie die letzten Absturzberichte auch im Dateisystem einsehen:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="console"><span></span><span class="tok-gp">OMD[mysite]:~$ </span>ls<span class="tok-w"> </span>-lhtr<span class="tok-w"> </span>~/var/check_mk/crashes/check/<span class="tok-w"> </span><span class="tok-p">|</span><span class="tok-w"> </span>tail<span class="tok-w"> </span>-n<span class="tok-w"> </span><span class="tok-m">5</span>
<span class="tok-go">drwx------ 1 mysite mysite 44 Sep  3 05:15 f47550fc-4a18-11ee-a46c-001617122312/</span>
<span class="tok-go">drwx------ 1 mysite mysite 44 Sep  3 05:17 38657652-4a19-11ee-a46c-001617122312/</span>
<span class="tok-go">drwx------ 1 mysite mysite 44 Sep  3 09:31 9e716690-4a3c-11ee-9eaf-001617122312/</span>
<span class="tok-go">drwx------ 1 mysite mysite 44 Sep  3 10:40 479b20ea-4a46-11ee-9eaf-001617122312/</span>
<span class="tok-go">drwx------ 1 mysite mysite 44 Sep  4 14:11 fdec3ef6-4b2c-11ee-9eaf-001617122312/</span></code></pre></div></div>
<div class="paragraph"><p>In jedem dieser Ordner liegen zwei Dateien:</p></div>
<div class="olist arabic"><ol class="arabic">
<li><p><code>crash.info</code> enthält ein Python-Dictionary mit Traceback und vielen weiteren Informationen. Oft genügt der Blick in die Datei mit dem Pager.</p></li>
<li><p><code>agent_output</code> enthält die vollständige Agentenausgabe, die zum Zeitpunkt des Absturzes aktuell war.</p></li>
</ol></div>
</div>
<div class="sect2">
<h3 id="heading_custom_debug">
<span class="hidden-anchor sr-only" id="custom_debug"></span>7.3. Eigene Debug-Ausgabe</h3>
<div class="paragraph"><p>In den oben gezeigten Beispielen verwenden wir die Funktion <code>print()</code>, um für Sie als Programmierer den Inhalt von Variablen oder die Struktur von Objekten auszugeben.
Diese Funktionen für Debug-Ausgaben müssen aus dem fertigen Check-Plugin wieder entfernt werden.</p></div>
<div class="paragraph"><p>Alternativ zur Entfernung können Sie Ihre Debug-Ausgabe auch nur ausgeben lassen, wenn das Check-Plugin in der Konsole im Debug-Modus aufgerufen wird.
Dafür importieren Sie das Debug-Objekt aus der Checkmk-Werkzeugkiste und gegebenenfalls die Formatierungshilfe <code>pprint()</code>.
Sie können nun Debug-Ausgaben abhängig vom Wert des Debug-Objektes vornehmen:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-kn">from</span> <span class="tok-nn">cmk.utils</span> <span class="tok-kn">import</span> <span class="tok-n">debug</span>

<span class="tok-kn">from</span> <span class="tok-nn">pprint</span> <span class="tok-kn">import</span> <span class="tok-n">pprint</span>

<span class="tok-k">def</span> <span class="tok-nf">check_mystuff</span><span class="tok-p">(</span><span class="tok-n">section</span><span class="tok-p">):</span>
    <span class="tok-k">if</span> <span class="tok-n">debug</span><span class="tok-o">.</span><span class="tok-n">enabled</span><span class="tok-p">():</span>
        <span class="tok-n">pprint</span><span class="tok-p">(</span><span class="tok-n">section</span><span class="tok-p">)</span></code></pre></div></div>
<div class="paragraph"><p>Beachten Sie, dass verbleibende Debug-Ausgaben sparsam verwendet und auf Hinweise beschränkt sein sollten, die den späteren Benutzern bei der Fehlersuche helfen.
Offensichtliche und abzusehende Fehler des Benutzers (zum Beispiel, dass die Inhalte der Agentensektion darauf hindeuten, dass das Agentenplugin falsch konfiguriert ist) sollten Sie mit dem Zustand <span class="state3">UNKNOWN</span> und aussagekräftigen Hinweisen im Summary beantworten.</p></div>
</div>
<div class="sect2">
<h3 id="heading_error_invalid_agent">
<span class="hidden-anchor sr-only" id="error_invalid_agent"></span>7.4. Ungültige Agentenausgabe</h3>
<div class="paragraph"><p>Die Frage ist, wie Sie reagieren sollen, wenn die Ausgaben vom Agenten nicht die Form haben, die Sie eigentlich erwarten — egal ob vom Checkmk-Agenten oder per <a href="devel_check_plugins_snmp.html">SNMP</a> erhalten.
Angenommen, Sie erwarten pro Zeile immer drei Worte.
Was sollen Sie tun, falls nur zwei kommen?</p></div>
<div class="paragraph"><p>Nun, wenn das ein <em>erlaubtes und bekanntes</em> Verhalten des Agenten ist, dann müssen Sie das natürlich abfangen und mit einer Fallunterscheidung arbeiten.
Falls das aber eigentlich nicht sein darf, dann tun Sie am besten so, als ob die Zeile immer aus drei Worten besteht, also zum Beispiel mit folgender Parse-Funktion:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">def</span> <span class="tok-nf">parse_foobar</span><span class="tok-p">(</span><span class="tok-n">string_table</span><span class="tok-p">):</span>
    <span class="tok-k">for</span> <span class="tok-n">foo</span><span class="tok-p">,</span> <span class="tok-n">bar</span><span class="tok-p">,</span> <span class="tok-n">baz</span> <span class="tok-ow">in</span> <span class="tok-n">string_table</span><span class="tok-p">:</span>
        <span class="tok-c1"># ...</span></code></pre></div></div>
<div class="paragraph"><p>Sollte jetzt mal eine Zeile dabei sein, die nicht aus genau drei Worten besteht, wird eine Exception erzeugt und Sie bekommen den gerade erwähnten sehr hilfreichen Absturzbericht.</p></div>
<div class="paragraph"><p>Falls Sie auf Schlüssel in einem Dictionary zugreifen, die gelegentlich erwartbar fehlen, kann es natürlich sinnvoll sein, darauf entsprechend zu reagieren.
Das kann erfolgen, indem <em>Sie</em> den Service auf <span class="state2">CRIT</span> oder <span class="state3">UNKNOWN</span> setzen und im Summary einen Hinweis auf die nicht auswertbare Agentenausgabe unterbringen.
In jedem Fall ist es besser, Sie verwenden hierfür die <code>get()</code>-Funktion des Dictionaries als die <code>KeyError</code> Exception abzufangen.
Denn <code>get()</code> liefert bei Nichtvorhandensein des Schlüssels ein Objekt vom Typ <code>None</code> oder einen optional als zweiten Parameter zu übergebenden Ersatz:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">def</span> <span class="tok-nf">check_foobar</span><span class="tok-p">(</span><span class="tok-n">section</span><span class="tok-p">):</span>
    <span class="tok-n">foo</span> <span class="tok-o">=</span> <span class="tok-n">section</span><span class="tok-o">.</span><span class="tok-n">get</span><span class="tok-p">(</span><span class="tok-s2">"bar"</span><span class="tok-p">)</span>
    <span class="tok-k">if</span> <span class="tok-ow">not</span> <span class="tok-n">foo</span><span class="tok-p">:</span>
        <span class="tok-k">yield</span> <span class="tok-n">Result</span><span class="tok-p">(</span><span class="tok-n">state</span><span class="tok-o">=</span><span class="tok-n">State</span><span class="tok-o">.</span><span class="tok-n">CRIT</span><span class="tok-p">,</span> <span class="tok-n">summary</span><span class="tok-o">=</span><span class="tok-s2">"Missing key in section: bar"</span><span class="tok-p">)</span>
        <span class="tok-k">return</span>
    <span class="tok-c1"># ...</span></code></pre></div></div>
</div>
<div class="sect2">
<h3 id="heading_error_missing_item">
<span class="hidden-anchor sr-only" id="error_missing_item"></span>7.5. Fehlende Items</h3>
<div class="paragraph"><p>Was ist, wenn der Agent korrekte Daten ausgibt, aber das Item fehlt, das überprüft werden soll?
Also zum Beispiel auf diese Art:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">def</span> <span class="tok-nf">check_foobar</span><span class="tok-p">(</span><span class="tok-n">item</span><span class="tok-p">,</span> <span class="tok-n">section</span><span class="tok-p">):</span>
    <span class="tok-c1"># Try to access the item as key in the section:</span>
    <span class="tok-n">foo</span> <span class="tok-o">=</span> <span class="tok-n">section</span><span class="tok-o">.</span><span class="tok-n">get</span><span class="tok-p">(</span><span class="tok-n">item</span><span class="tok-p">)</span>
    <span class="tok-k">if</span> <span class="tok-n">foo</span><span class="tok-p">:</span>
        <span class="tok-k">yield</span> <span class="tok-n">Result</span><span class="tok-p">(</span><span class="tok-n">state</span><span class="tok-o">=</span><span class="tok-n">State</span><span class="tok-o">.</span><span class="tok-n">OK</span><span class="tok-p">,</span> <span class="tok-n">summary</span><span class="tok-o">=</span><span class="tok-s2">"Item found in monitoring data"</span><span class="tok-p">)</span>
    <span class="tok-c1"># If foo is None, nothing is yielded here</span></code></pre></div></div>
<div class="paragraph"><p>Ist das gesuchte Item nicht dabei, so wird die Schleife durchlaufen und Python fällt am Ende der Funktion einfach hinten raus, ohne dass ein Resultat per <code>yield</code> zurückgegeben wurde.
Und das ist genau das Richtige!
Denn daran erkennt Checkmk, dass das zu überwachende Item fehlt und erzeugt mit <span class="state3">UNKNOWN</span> den richtigen Status und einen passenden Standardtext dazu.</p></div>
</div>
<div class="sect2">
<h3 id="heading_error_spool">
<span class="hidden-anchor sr-only" id="error_spool"></span>7.6. Test mit Spool-Dateien</h3>
<div class="paragraph"><p>Wenn Sie bestimmte Agentenausgaben simulieren wollen, sind <a href="spool_directory.html">Spool-Dateien</a> sehr hilfreich.
Diese können Sie nutzen, um sonst schwer nachzustellende Grenzfälle zu testen.
Oder Sie verwenden direkt die Agentenausgabe, welche zu einem Absturzbericht geführt hat, zur Prüfung von Änderungen an einem Check-Plugin.</p></div>
<div class="paragraph"><p>Deaktivieren Sie zunächst Ihr reguläres Agentenplugin, beispielsweise indem Sie ihm die Ausführungsberechtigung entziehen.
Erstellen Sie dann eine Datei im Verzeichnis <code>/var/lib/check_mk_agent/spool/</code>, welche die von Ihrem Check-Plugin erwartete Agentensektion (oder erwarteten <em>Agentensektionen</em>) inklusive Sektions-Header enthält und auf Newline endet.
Beim nächsten Aufruf des Agenten wird dann der Inhalt der Spool-Datei statt der Ausgabe des Agentenplugins übertragen.</p></div>
</div>
<div class="sect2">
<h3 id="heading_performance">
<span class="hidden-anchor sr-only" id="performance"></span>7.7. Alte Check-Plugins werden bei vielen Services langsam</h3>
<div class="paragraph"><p>Bei einigen Check-Plugins, die Items nutzen, ist es auf größeren Servern durchaus möglich, dass einige hundert Services erzeugt werden.
Wenn keine eigene Parse-Funktion verwendet wird, hat dies zur Folge, dass für jedes der hunderten Items die gesamte Liste von hunderten Zeilen durchlaufen werden muss.
Die zum Suchen benötigte Zeit steigt also im Quadrat mit der Zahl der Listenelemente, bei hunderten Services bedeutet das zigtausende Vergleiche.
Ist dagegen die geschachtelte Liste in ein Dictionary überführt, steigt der Aufwand für die Suche eines Elements nur linear mit der Größe des Dictionaries.</p></div>
<div class="paragraph"><p>Im Python-Wiki finden Sie eine <a href="https://wiki.python.org/moin/TimeComplexity" target="_blank">Übersicht der Kosten</a> für die Suche in verschiedenen Datentypen, inklusive Erläuterung und <em>O-Notation.</em>
Mit der Parse-Funktion reduzieren die Komplexität der Suche von <em>O(n)</em> auf <em>O(1)</em>.</p></div>
<div class="paragraph"><p>Da ältere Versionen dieses Artikels keinen Gebrauch von der Parse-Funktion gemacht haben, sollten Sie derartige Check-Plugins identifizieren und diese auf Verwendung einer Parse-Funktion umschreiben.</p></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="heading_files">
<span class="hidden-anchor sr-only" id="files"></span>8. Dateien und Verzeichnisse</h2>
<div class="sectionbody"><table class="table-responsive table-bordered table tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 45%;">
<col style="width: 55%;">
</colgroup>
<thead><tr>
<th class="tableblock halign-left valign-top">Pfad</th>
<th class="tableblock halign-left valign-top">Bedeutung</th>
</tr></thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>~/local/lib/check_mk/base/plugins/agent_based/</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Ablageort für selbst geschriebene Check-Plugins.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>~/local/share/check_mk/web/plugins/wato/</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Ablageort für Ihre Regelsätze für Check-Parameter.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>~/local/share/check_mk/web/plugins/metrics/</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Ablageort für eigene Metrikdefinitionen.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>~/local/share/check_mk/web/plugins/perfometer/</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Ablageort für eigene Definitionen von Perf-O-Metern.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>~/lib/check_mk/gui/plugins/wato/check_parameters/</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Hier finden Sie die Regelsatzdefinitionen von allen mitgelieferten Check-Plugins von Checkmk.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>~/lib/check_mk/gui/plugins/wato/utils/__init__.py</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">In dieser Datei sind die Gruppen der <span class="guihint">Setup</span>-Oberfläche definiert, in welchen Sie neue Regelsätze ablegen können.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>~/lib/check_mk/gui/plugins/metrics/</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Hier finden Sie die Metrikdefinitionen der mitgelieferten Plugins.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>~/lib/check_mk/gui/plugins/metrics/unit.py</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">In dieser Datei stehen die vordefinierten Einheiten für Metriken.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>/usr/lib/check_mk_agent/plugins/</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Dieses Verzeichnis bezieht sich auf einen überwachten Linux-Host. Hier erwartet der Checkmk-Agent für Linux Erweiterungen des Agenten (Agentenplugins).</p></td>
</tr>
</tbody>
</table></div>
</div>
</div></main><div id="toc" class="toc2">
<div id="toctitle">Auf dieser Seite</div>
<ul class="sectlevel1">
<li>
<a href="#intro">1. Einleitung</a><ul class="sectlevel1">
<li><a href="#check_api_doc">1.1. Die Check-API-Dokumentation</a></li>
<li><a href="#_voraussetzungen">1.2. Voraussetzungen</a></li>
<li><a href="#_begriffe">1.3. Begriffe</a></li>
</ul>
</li>
<li>
<a href="#agentplugin">2. Ein Agentenplugin schreiben</a><ul class="sectlevel1">
<li><a href="#right_command">2.1. Informationen auslesen und filtern</a></li>
<li><a href="#command_in_agent">2.2. Den Befehl in den Agenten einbauen</a></li>
<li><a href="#test_agent">2.3. Agent ausprobieren</a></li>
</ul>
</li>
<li>
<a href="#write_check_plugin">3. Ein einfaches Check-Plugin schreiben</a><ul class="sectlevel1">
<li><a href="#scaffold">3.1. Die Datei vorbereiten</a></li>
<li><a href="#parsefunction">3.2. Die Parse-Funktion schreiben</a></li>
<li><a href="#_die_agentensektion_registrieren">3.3. Die Agentensektion registrieren</a></li>
<li><a href="#register_check_plug-in">3.4. Das Check-Plugin registrieren</a></li>
<li><a href="#discovery_function">3.5. Die Discovery-Funktion schreiben</a></li>
<li><a href="#check_function">3.6. Die Check-Funktion schreiben</a></li>
<li><a href="#test">3.7. Das Check-Plugin testen und aktivieren</a></li>
</ul>
</li>
<li>
<a href="#extend">4. Das Check-Plugin erweitern</a><ul class="sectlevel1">
<li>
<a href="#prepare">4.1. Vorbereitungen</a><ul class="sectlevel2">
<li><a href="#_agentenplugin_erweitern">Agentenplugin erweitern</a></li>
<li><a href="#_parse_funktion_erweitern">Parse-Funktion erweitern</a></li>
</ul>
</li>
<li><a href="#discovery">4.2. Service-Erkennung</a></li>
<li><a href="#summary_details">4.3. Summary und Details</a></li>
<li><a href="#partial_results">4.4. Mehrere Teilresultate pro Service</a></li>
<li><a href="#metrics">4.5. Metriken</a></li>
<li>
<a href="#rule_set">4.6. Check-Parameter für Regelsätze</a><ul class="sectlevel2">
<li><a href="#new_ruleset">Neuen Regelsatz definieren</a></li>
<li><a href="#test_ruleset">Regelsatz testen</a></li>
<li><a href="#use_ruleset">Regelsatz im Check-Plugin benutzen</a></li>
<li><a href="#reuse_ruleset">Vorhandenen Regelsatz verwenden</a></li>
</ul>
</li>
</ul>
</li>
<li>
<a href="#metrics_advanced">5. Darstellung von Metriken anpassen</a><ul class="sectlevel1">
<li><a href="#reuse_metricdefinition">5.1. Vorhandene Metrikdefinitionen verwenden</a></li>
<li><a href="#new_metricdefinition">5.2. Neue Metrikdefinition erstellen</a></li>
<li><a href="#graph_multiple_metrics">5.3. Graph mit mehreren Metriken</a></li>
<li><a href="#perfometer">5.4. Metriken im Perf-O-Meter</a></li>
</ul>
</li>
<li>
<a href="#format_numbers">6. Zahlen formatieren</a><ul class="sectlevel1">
<li><a href="#time">6.1. Zeiten, Zeiträume, Frequenzen</a></li>
<li><a href="#byte">6.2. Bytes</a></li>
<li><a href="#bandwith">6.3. Bandbreiten, Datenraten</a></li>
<li><a href="#percentage">6.4. Prozentsätze</a></li>
<li><a href="#numbers_summary">6.5. Zusammenfassung</a></li>
</ul>
</li>
<li>
<a href="#errors">7. Fehler beheben</a><ul class="sectlevel1">
<li><a href="#error_exception_gui">7.1. Exceptions und Absturzberichte in der GUI</a></li>
<li><a href="#error_exception_cli">7.2. Exceptions auf der Kommandozeile ansehen</a></li>
<li><a href="#custom_debug">7.3. Eigene Debug-Ausgabe</a></li>
<li><a href="#error_invalid_agent">7.4. Ungültige Agentenausgabe</a></li>
<li><a href="#error_missing_item">7.5. Fehlende Items</a></li>
<li><a href="#error_spool">7.6. Test mit Spool-Dateien</a></li>
<li><a href="#performance">7.7. Alte Check-Plugins werden bei vielen Services langsam</a></li>
</ul>
</li>
<li><a href="#files">8. Dateien und Verzeichnisse</a></li>
</ul>
</div>
<script src="../../assets/js/manifest.js?id=7db827d654313dce4250"></script>
<script src="../../assets/js/vendor.js?id=581a3d4a61b7156d04df"></script>
<script src="../../assets/js/app.js?id=959ccd04b1f8b7b78c5e"></script>
<script src="../../assets/js/lunr.js"></script>
<script src="../../assets/js/lunr.stemmer.support.js"></script>
<script src="../../assets/js/lunr.de.js"></script>
<script src="../lunr.index.de.js"></script>
<script src="../../assets/js/lunr.client.js"></script>
</body>
</html>
