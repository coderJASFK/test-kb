<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="UTF-8">
<!--[if IE]><meta http-equiv="X-UA-Compatible" content="IE=edge"><![endif]--><meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.10">
<link rel="icon" href="/favicon.png">
<meta name="description" content="The Linux agent of Checkmk version 2.1.0 adds the Agent Controller and new features to the agent script. You can learn how to use the agent here.">
<meta name="og:locale" content="en">
<meta name="og:site_name" content="Checkmk Docs">
<meta name="og:title" content="Monitoring Linux - The new agent for Linux in detail">
<meta name="og:description" content="The Linux agent of Checkmk version 2.1.0 adds the Agent Controller and new features to the agent script. You can learn how to use the agent here.">
<meta name="og:image" content="https://docs.checkmk.com/assets/images/share_image.png">
<meta name="twitter:site" content="@checkmk">
<meta name="twitter:creator" content="@checkmk">
<title>Monitoring Linux - The new agent for Linux in detail</title>
<link rel="stylesheet" href="../../assets/css/checkmk.css?id=4473d2acbb1ea6136428">
<link rel="stylesheet" href="../../assets/css/pygments-monokai.css">
<link rel="stylesheet" href="../../assets/css/addons.css">
<link rel="stylesheet" href="../../assets/css/SourceCodePro.css">
<link rel="search" href="./opensearch.xml" type="application/opensearchdescription+xml" title="Search docs.checkmk.com">
<!-- Google Tag Manager -->
<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
        new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
    j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
    'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-NJ3VGL8');</script>
<!-- End Google Tag Manager --><style>
#staticinfo { font-style: italic; }
</style>
</head>
<body class="article toc2 toc-right">
<!-- Cookie Consent (GDPR Compliance) -->

<!-- End Cookie Consent (GDPR Compliance) -->
<!-- Google Tag Manager (noscript) -->
<noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-NJ3VGL8" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
<!-- End Google Tag Manager (noscript) --><div class="header-top">
<div class="header-top__left">
<a class="header-top__logo d-none d-xl-inline-block" href="/latest/en"><img src="../../assets/images/docs_logo.png" alt="Checkmk"></a><a class="header-top__icon d-inline-block d-xl-none" href="/latest/en"><img src="../../assets/images/logo_icon.svg" alt="Checkmk"></a>
</div>
<div class="header-top__center">
<input type="text" class="header-top__search" placeholder="Search the checkmk docs"><div class="header-top__search__results"></div>
</div>
<div class="header-top__right d-block">
<button class="header-top__search__toggle d-inline-block d-md-none"><img class="header-top__search__toggle__icon" src="../../assets/images/search.svg" alt="Search"></button><div class="dropdown dropdown__language">
                    <button class="btn dropdown-toggle" type="button" id="languageMenuButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">en</button>
                    <div class="dropdown-menu  dropdown-menu-right" aria-labelledby="languageMenuButton"><a class="dropdown-item" href="../../latest/de/agent_linux.html">Deutsch</a></div>
</div>
<div class="dropdown dropdown__branch">
                        <button class="btn dropdown-toggle" type="button" id="branchMenuButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">latest (2.3.0)</button>
                        <div class="dropdown-menu dropdown-menu-right" aria-labelledby="branchMenuButton">
<a class="dropdown-item" href="../../2.1.0/en/agent_linux.html">2.1.0</a><a class="dropdown-item" href="../../2.2.0/en/agent_linux.html">2.2.0</a>
</div>
</div>
<a class="header-top__back d-none d-lg-inline-block" href="https://checkmk.com">to checkmk.com</a><button class="header-top__toggle d-inline-block d-lg-none"><span class="header-top__toggle__icon"></span></button>
</div>
</div>
<aside><div class="main-nav">
<div class="main-nav__content"><div id="content">
<div class="sect1">
<h2 id="_welcome_to_checkmk">
<a class="anchor" href="#_welcome_to_checkmk"></a>1. Welcome to Checkmk</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p><a href="welcome.html">Welcome to the Checkmk User Guide</a></p>
</li>
<li>
<p><a href="release_notes.html">Release notes</a></p>
</li>
<li>
<p><a href="glossar.html">Glossary</a></p>
</li>
<li>
<p><a href="search.html">Searching docs.checkmk.com</a></p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_beginners_guide">
<a class="anchor" href="#_beginners_guide"></a>2. Beginner’s Guide</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p><a href="intro_setup.html">Setting up Checkmk</a></p>
</li>
<li>
<p><a href="intro_gui.html">The Checkmk user interface</a></p>
</li>
<li>
<p><a href="intro_setup_monitor.html">Setting up monitoring</a></p>
</li>
<li>
<p><a href="intro_tools.html">The monitoring tools</a></p>
</li>
<li>
<p><a href="intro_monitor.html">Checkmk in monitoring</a></p>
</li>
<li>
<p><a href="intro_finetune.html">Fine-tuning the monitoring</a></p>
</li>
<li>
<p><a href="intro_users.html">Working with multiple users</a></p>
</li>
<li>
<p><a href="intro_notifications.html">Switching on notifications</a></p>
</li>
<li>
<p><a href="intro_extend.html">Extending the monitoring system further</a></p>
</li>
<li>
<p><a href="intro_bestpractise.html">Best practices, tips &amp; tricks</a></p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_installation">
<a class="anchor" href="#_installation"></a>3. Installation</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p><a href="install_packages.html">Basic information on the installation of Checkmk</a></p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="_server_and_vms">
<a class="anchor" href="#_server_and_vms"></a>3.1. Server and VMs</h3>
<div class="ulist">
<ul>
<li>
<p><a href="install_packages_debian.html">Installation on Debian and Ubuntu</a></p>
</li>
<li>
<p><a href="install_packages_redhat.html">Installation on Red Hat and derivatives</a></p>
</li>
<li>
<p><a href="install_packages_sles.html">Installation on SUSE Linux Enterprise Server</a></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_appliance_container_cloud">
<a class="anchor" href="#_appliance_container_cloud"></a>3.2. Appliance, container, cloud</h3>
<div class="ulist">
<ul>
<li>
<p><a href="install_appliance_cmk.html">Installation of Checkmk in the appliance</a></p>
</li>
<li>
<p><a href="introduction_docker.html">Installation as a Docker container</a></p>
</li>
<li>
<p><a href="install_azure.html">Installation from Azure Marketplace</a></p>
</li>
<li>
<p><a href="install_aws.html">Installation from AWS Marketplace</a></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_updates">
<a class="anchor" href="#_updates"></a>3.3. Updates</h3>
<div class="ulist">
<ul>
<li>
<p><a href="update.html">Updates and Upgrades</a></p>
</li>
<li>
<p><a href="update_major.html">Update to version <span class="new">2.3.0</span></a></p>
</li>
<li>
<p><a href="update_matrix.html">Update matrix for version <span class="new">2.3.0</span></a></p>
</li>
<li>
<p><a href="release_upgrade.html">Linux upgrade on the Checkmk server</a></p>
</li>
<li>
<p><a href="cmk_versions.html">Checkmk versions</a></p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_administration_of_checkmk">
<a class="anchor" href="#_administration_of_checkmk"></a>4. Administration of Checkmk</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_server">
<a class="anchor" href="#_server"></a>4.1. Server</h3>
<div class="ulist">
<ul>
<li>
<p><a href="saml.html">Authentication with SAML</a></p>
</li>
<li>
<p><a href="kerberos.html">Single sign-on with Kerberos</a></p>
</li>
<li>
<p><a href="managing_docker.html">Checkmk server in a Docker container</a></p>
</li>
<li>
<p><a href="security.html">Security</a></p>
</li>
<li>
<p><a href="ports.html">Ports</a></p>
</li>
<li>
<p><a href="omd_https.html">Securing the web interface with HTTPS</a></p>
</li>
<li>
<p><a href="support_diagnostics.html">Support diagnostics</a></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_sites">
<a class="anchor" href="#_sites"></a>4.2. Sites</h3>
<div class="ulist">
<ul>
<li>
<p><a href="omd_basics.html">Site administration with omd</a></p>
</li>
<li>
<p><a href="cmk_commandline.html">Checkmk on the command line</a></p>
</li>
<li>
<p><a href="license.html">Managing licenses</a></p>
</li>
<li>
<p><a href="distributed_monitoring.html">Distributed monitoring</a></p>
</li>
<li>
<p><a href="backup.html">Backups</a></p>
</li>
<li>
<p><a href="password_store.html">Password store</a></p>
</li>
<li>
<p><a href="analyze_configuration.html">Analyzing the Checkmk site configuration</a></p>
</li>
<li>
<p><a href="mkps.html">Checkmk extension packages (MKPs)</a></p>
</li>
<li>
<p><a href="mkp_viewables.html">MKPs for GUI extensions</a></p>
</li>
<li>
<p><a href="simulation_mode.html">Simulation mode</a></p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_configuration">
<a class="anchor" href="#_configuration"></a>5. Configuration</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p><a href="wato.html">Configuring Checkmk</a></p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="_hosts">
<a class="anchor" href="#_hosts"></a>5.1. Hosts</h3>
<div class="ulist">
<ul>
<li>
<p><a href="hosts_setup.html">Host administration</a></p>
</li>
<li>
<p><a href="hosts_structure.html">Host structuring</a></p>
</li>
<li>
<p><a href="host_tags.html">Host tags</a></p>
</li>
<li>
<p><a href="dcd.html">Dynamic host configuration</a></p>
</li>
<li>
<p><a href="hosts_autoregister.html">Automated host creation</a></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_services">
<a class="anchor" href="#_services"></a>5.2. Services</h3>
<div class="ulist">
<ul>
<li>
<p><a href="wato_services.html">Understanding and configuring services</a></p>
</li>
<li>
<p><a href="clustered_services.html">Monitoring cluster services</a></p>
</li>
<li>
<p><a href="piggyback.html">The piggyback mechanism</a></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_rules">
<a class="anchor" href="#_rules"></a>5.3. Rules</h3>
<div class="ulist">
<ul>
<li>
<p><a href="wato_rules.html">Rules</a></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_supporting_configurations">
<a class="anchor" href="#_supporting_configurations"></a>5.4. Supporting configurations</h3>
<div class="ulist">
<ul>
<li>
<p><a href="timeperiods.html">Time periods</a></p>
</li>
<li>
<p><a href="labels.html">Labels</a></p>
</li>
<li>
<p><a href="regexes.html">Regular expressions in Checkmk</a></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_users_and_permissions">
<a class="anchor" href="#_users_and_permissions"></a>5.5. Users and permissions</h3>
<div class="ulist">
<ul>
<li>
<p><a href="wato_user.html">Users, roles and permissions</a></p>
</li>
<li>
<p><a href="ldap.html">User management with LDAP/Active Directory</a></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_notifications">
<a class="anchor" href="#_notifications"></a>5.6. Notifications</h3>
<div class="ulist">
<ul>
<li>
<p><a href="notifications.html">Notifications</a></p>
</li>
<li>
<p><a href="notifications_webex.html">Notifications via Cisco Webex Teams</a></p>
</li>
<li>
<p><a href="notifications_ilert.html">Notifications via ilert</a></p>
</li>
<li>
<p><a href="notifications_jira.html">Notifications via Jira</a></p>
</li>
<li>
<p><a href="notifications_mattermost.html">Notifications via Mattermost</a></p>
</li>
<li>
<p><a href="notifications_teams.html">Notifications via Microsoft Teams</a></p>
</li>
<li>
<p><a href="notifications_pagerduty.html">Notifications via PagerDuty</a></p>
</li>
<li>
<p><a href="notifications_pushover.html">Notifications via Pushover</a></p>
</li>
<li>
<p><a href="notifications_opsgenie.html">Notifications via Opsgenie</a></p>
</li>
<li>
<p><a href="notifications_servicenow.html">Notifications via ServiceNow</a></p>
</li>
<li>
<p><a href="notifications_signl4.html">Notifications via SIGNL4</a></p>
</li>
<li>
<p><a href="notifications_slack.html">Notifications via Slack</a></p>
</li>
<li>
<p><a href="notifications_splunkoncall.html">Notifications via Splunk On-Call</a></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_events">
<a class="anchor" href="#_events"></a>5.7. Events</h3>
<div class="ulist">
<ul>
<li>
<p><a href="ec.html">The Event Console</a></p>
</li>
<li>
<p><a href="alert_handlers.html">Alert handlers</a></p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_monitoring_systems">
<a class="anchor" href="#_monitoring_systems"></a>6. Monitoring systems</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p><a href="wato_monitoringagents.html">Monitoring agents</a></p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="_checkmk_agents_and_snmp">
<a class="anchor" href="#_checkmk_agents_and_snmp"></a>6.1. Checkmk agents and SNMP</h3>
<div class="ulist">
<ul>
<li>
<p><a href="agent_deployment.html">Automatic agent updates</a></p>
</li>
<li>
<p><a href="agent_linux.html">Monitoring Linux</a></p>
</li>
<li>
<p><a href="agent_linux_legacy.html">Monitoring Linux in legacy mode</a></p>
</li>
<li>
<p><a href="agent_windows.html">Monitoring Windows</a></p>
</li>
<li>
<p><a href="agent_freebsd.html">Monitoring FreeBSD</a></p>
</li>
<li>
<p><a href="snmp.html">Monitoring via SNMP</a></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_agent_extensions">
<a class="anchor" href="#_agent_extensions"></a>6.2. Agent extensions</h3>
<div class="ulist">
<ul>
<li>
<p><a href="inventory.html">The HW/SW inventory</a></p>
</li>
<li>
<p><a href="mk_filestats.html">Monitoring files</a></p>
</li>
<li>
<p><a href="monitoring_logfiles.html">Monitoring log files</a></p>
</li>
<li>
<p><a href="monitoring_oracle.html">Monitoring Oracle databases</a></p>
</li>
<li>
<p><a href="monitoring_mysql.html">Monitoring MySQL</a></p>
</li>
<li>
<p><a href="monitoring_mssql.html">Monitoring MSSQL</a></p>
</li>
<li>
<p><a href="monitoring_mssql_legacy.html">Monitoring MSSQL with the legacy plug-in</a></p>
</li>
<li>
<p><a href="monitoring_jobs.html">Monitoring time-based processes (Cronjobs)</a></p>
</li>
<li>
<p><a href="spool_directory.html">The spool directory</a></p>
</li>
<li>
<p><a href="localchecks.html">Local checks</a></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_vm_cloud_container">
<a class="anchor" href="#_vm_cloud_container"></a>6.3. VM, cloud, container</h3>
<div class="ulist">
<ul>
<li>
<p><a href="datasource_programs.html">Datasource programs</a></p>
</li>
<li>
<p><a href="monitoring_vmware.html">Monitoring VMware ESXi</a></p>
</li>
<li>
<p><a href="monitoring_aws.html">Monitoring Amazon Web Services (AWS)</a></p>
</li>
<li>
<p><a href="monitoring_azure.html">Monitoring Microsoft Azure</a></p>
</li>
<li>
<p><a href="monitoring_gcp.html">Monitoring Google Cloud Platform (GCP)</a></p>
</li>
<li>
<p><a href="monitoring_kubernetes.html">Monitoring Kubernetes</a></p>
</li>
<li>
<p><a href="monitoring_openshift.html">Monitoring OpenShift</a></p>
</li>
<li>
<p><a href="monitoring_docker.html">Monitoring Docker</a></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_endpoints">
<a class="anchor" href="#_endpoints"></a>6.4. Endpoints</h3>
<div class="ulist">
<ul>
<li>
<p><a href="active_checks.html">Monitoring network services (Active checks)</a></p>
</li>
<li>
<p><a href="robotmk.html">Checkmk Synthetic Monitoring with Robotmk</a></p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_dashboards_views_metrics">
<a class="anchor" href="#_dashboards_views_metrics"></a>7. Dashboards, views, metrics</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p><a href="user_interface.html">The user interface</a></p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="_general">
<a class="anchor" href="#_general"></a>7.1. General</h3>
<div class="ulist">
<ul>
<li>
<p><a href="views.html">Host and service views</a></p>
</li>
<li>
<p><a href="dashboards.html">Dashboards</a></p>
</li>
<li>
<p><a href="graphing.html">Measured values and graphing</a></p>
</li>
<li>
<p><a href="custom_notes.html">Custom notes</a></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_commands_in_views">
<a class="anchor" href="#_commands_in_views"></a>7.2. Commands in views</h3>
<div class="ulist">
<ul>
<li>
<p><a href="commands.html">Commands</a></p>
</li>
<li>
<p><a href="basics_ackn.html">Acknowledging problems</a></p>
</li>
<li>
<p><a href="basics_downtimes.html">Scheduled downtimes</a></p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_analysis_and_prognosis">
<a class="anchor" href="#_analysis_and_prognosis"></a>8. Analysis and prognosis</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_analysis">
<a class="anchor" href="#_analysis"></a>8.1. Analysis</h3>
<div class="ulist">
<ul>
<li>
<p><a href="availability.html">Availability</a></p>
</li>
<li>
<p><a href="sla.html">Extended availability (SLAs)</a></p>
</li>
<li>
<p><a href="bi.html">Business Intelligence (BI)</a></p>
</li>
<li>
<p><a href="reporting.html">Reports</a></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_prognosis">
<a class="anchor" href="#_prognosis"></a>8.2. Prognosis</h3>
<div class="ulist">
<ul>
<li>
<p><a href="predictive_monitoring.html">Predictive monitoring</a></p>
</li>
<li>
<p><a href="forecast_graphs.html">Forecast graphs</a></p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_connection_of_other_applications">
<a class="anchor" href="#_connection_of_other_applications"></a>9. Connection of other applications</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p><a href="monitoring_prometheus.html">Integrating Prometheus</a></p>
</li>
<li>
<p><a href="integrating_datadog.html">Integrating Datadog</a></p>
</li>
<li>
<p><a href="nagvis.html">NagVis: status data on maps and diagrams</a></p>
</li>
<li>
<p><a href="ntop.html">Integrating ntopng in Checkmk</a></p>
</li>
<li>
<p><a href="grafana.html">Integrating Checkmk in Grafana</a></p>
</li>
<li>
<p><a href="metrics_exporter.html">Sending metrics to InfluxDB and Graphite</a></p>
</li>
<li>
<p><a href="nagstamon.html">Integrating Checkmk in Nagstamon</a></p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_specifics_to_the_editions">
<a class="anchor" href="#_specifics_to_the_editions"></a>10. Specifics to the editions</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p><a href="cse.html">Checkmk Enterprise</a></p>
</li>
<li>
<p><a href="cce.html">Checkmk Cloud</a></p>
</li>
<li>
<p><a href="managed.html">Checkmk MSP</a></p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_automation_and_development">
<a class="anchor" href="#_automation_and_development"></a>11. Automation and development</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p><a href="apis_intro.html">Overview of API resources</a></p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="_apis_for_automation">
<a class="anchor" href="#_apis_for_automation"></a>11.1. APIs for automation</h3>
<div class="ulist">
<ul>
<li>
<p><a href="rest_api.html">The Checkmk REST API</a></p>
</li>
<li>
<p><a href="livestatus.html">Retrieving status data via Livestatus</a></p>
</li>
<li>
<p><a href="livestatus_references.html">Livestatus command reference</a></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_apis_for_development">
<a class="anchor" href="#_apis_for_development"></a>11.2. APIs for development</h3>
<div class="ulist">
<ul>
<li>
<p><a href="bakery_api.html">The Bakery-API</a></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_development_of_check_plug_ins">
<a class="anchor" href="#_development_of_check_plug_ins"></a>11.3. Development of check plug-ins</h3>
<div class="ulist">
<ul>
<li>
<p><a href="devel_intro.html">Developing extensions for Checkmk</a></p>
</li>
<li>
<p><a href="devel_check_plugins.html">Writing agent-based check plug-ins</a></p>
</li>
<li>
<p><a href="devel_check_plugins_snmp.html">Writing SNMP-based check plug-ins</a></p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_concepts">
<a class="anchor" href="#_concepts"></a>12. Concepts</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p><a href="monitoring_basics.html">Basic principles of monitoring with Checkmk</a></p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="_the_checkmk_micro_core_cmc">
<a class="anchor" href="#_the_checkmk_micro_core_cmc"></a>12.1. The Checkmk Micro Core (CMC)</h3>
<div class="ulist">
<ul>
<li>
<p><a href="cmc.html">The Checkmk Micro Core (CMC)</a></p>
</li>
<li>
<p><a href="cmc_differences.html">Special characteristics of the CMC</a></p>
</li>
<li>
<p><a href="cmc_migration.html">Migration to the CMC</a></p>
</li>
<li>
<p><a href="cmc_files.html">CMC files and directories</a></p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_the_checkmk_appliance">
<a class="anchor" href="#_the_checkmk_appliance"></a>13. The Checkmk appliance</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p><a href="appliance_rack1_quick_start.html">Quick start guide for Checkmk racks</a></p>
</li>
<li>
<p><a href="appliance_virt1_quick_start.html">Quick start guide for Checkmk virt1</a></p>
</li>
<li>
<p><a href="appliance_install_virt1.html">Installation of the virtual appliance</a></p>
</li>
<li>
<p><a href="appliance_usage.html">Configuring and using the appliance</a></p>
</li>
<li>
<p><a href="appliance_backup.html">Backup in the appliance</a></p>
</li>
<li>
<p><a href="appliance_cluster.html">Appliance in cluster operation</a></p>
</li>
<li>
<p><a href="appliance_rack_config.html">Special features of the hardware appliance</a></p>
</li>
</ul>
</div>
</div>
</div>
</div></div>
<div class="main-nav__utils">
<div class="dropup dropdown__utils">
<button class="btn dropdown-toggle" type="button" id="aboutMenuButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">About Checkmk</button><div class="dropdown-menu dropup" aria-labelledby="aboutMenuButton">
<a class="dropdown-item" href="https://checkmk.com/product/features" target="_blank">Features</a><a class="dropdown-item" href="https://checkmk.com/product/editions" target="_blank">Editions</a><a class="dropdown-item" href="https://checkmk.com/integrations" target="_blank">Integrations</a><a class="dropdown-item" href="https://checkmk.com/imprint" target="_blank">Imprint</a><a class="dropdown-item" href="copyright.html" target="_blank">Copyright</a>
</div>
</div>
<div class="dropup dropdown__utils">
<button class="btn dropdown-toggle" type="button" id="learnMenuButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Learn</button><div class="dropdown-menu dropup" aria-labelledby="learnMenuButton">
<a class="dropdown-item" href="https://checkmk.com/videos">Videos</a><a class="dropdown-item" href="https://checkmk.com/webinars">Webinars</a><a class="dropdown-item" href="https://checkmk.com/trainings/classes">Trainings</a>
</div>
</div>
<a class="main-nav__utils__link" href="https://forum.checkmk.com">Forum</a>
</div>
</div></aside><main><div id="header">
<h1>Monitoring Linux</h1>
<div class="details">
<span id="revdate">Last modified on 28-Feb-2024</span><a class="edit-document" href="https://github.com/Checkmk/checkmk-docs/edit/2.3.0/src/common/en/agent_linux.asciidoc">Edit this page on GitHub</a>
</div>
</div>
<div id="content">
<div id="preamble">
<div id="staticinfo">This page was exported for offline usage on 2025-01-07 22:12:14 +0000. It may not reflect the current state of the Checkmk documentation. To view a daily updated version, visit <a href="https://docs.checkmk.com/" target="_blank">docs.checkmk.com</a>.</div>
<div class="sectionbody"><div class="paragraph">
<p></p>
<div class="dropdown dropdown__related">
<button class="btn btn-primary dropdown-toggle" type="button" id="relatedMenuButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Related Articles</button><div class="dropdown-menu dropdown-menu-right" aria-labelledby="relatedMenuButton">
<a href="agent_linux_legacy.html">Monitoring Linux in legacy mode</a>
<a href="wato_monitoringagents.html">Monitoring agents</a>
<a href="agent_deployment.html">Automatic Agent Updates</a>
</div>
</div>
</div></div>
</div>
<div class="sect1">
<h2 id="heading_intro">
<span class="hidden-anchor sr-only" id="intro"></span>1. The Linux agent</h2>
<div class="sectionbody">
<div class="imageblock inline-image"><div class="content"><img src="../images/linux.png" alt="Linux-Logo." width="120"></div></div>
<div class="paragraph"><p>You can monitor Linux systems particularly well with Checkmk.
This is not so much because the Checkmk development team feels 'at home' on Linux, but is rather due to Linux being a very open system which provides numerous well documented and easy to query interfaces to support a detailed monitoring system.</p></div>
<div class="paragraph"><p>Since most of the interfaces are not actually accessible via the network, the installation of a monitoring agent is required.
That is why Checkmk has its own agent for monitoring Linux.
This agent is a simple shell script that is minimalistic, transparent and secure.</p></div>
<div class="paragraph"><p>In Checkmk version <span class="new">2.1.0</span>, with the <strong>Agent Controller</strong> a new component has been added to this <strong>agent script</strong>.
The Agent Controller handles networking connections and runs the agent script when called.
To do this, it registers with the <strong>Agent Receiver</strong>, a process that runs on the Checkmk server.</p></div>
<div class="paragraph"><p>So, on the one hand, the Linux agent keeps the agent script, and thus also its advantages.
On the other hand, it provides more flexibility than the previous method of running the agent script by an internet super-server, such as TLS encryption of communication or data compression.</p></div>
<div class="paragraph"><p>The registered, encrypted and compressed <a href="glossar.html#pull_mode">pull mode</a> with the Agent Controller is available for all Checkmk editions — provided both Checkmk server and agent have at least version <span class="new">2.1.0</span>.
The <a href="glossar.html#push_mode">push mode</a> is available from <span class="image-inline"><img src="../images/icons/CSE.png" alt="CSE" width="20" title="Checkmk Cloud"></span> <strong>Checkmk Cloud</strong> onwards, i.e. in Checkmk Cloud and Checkmk MSP.
Reversing the communication direction makes it easier to monitor hosts that are located behind firewalls.
Push mode is usually combined with <a href="hosts_autoregister.html">automatic registration</a> of the Checkmk agent, which is also available from Checkmk Cloud onwards.</p></div>
<div class="admonitionblock tip"><table><tr>
<td class="icon"><img src="../images/icons/tip.png" alt="Tip"></td>
<td class="content"><div class="paragraph"><p>Agent packages that use the default configuration open port 6556 immediately following installation.
They will output unencrypted agent data via this port to anyone requesting it.
For hosts that are accessible from the internet, you should therefore ensure <em>prior to</em> installation via firewall settings that only selected hosts are allowed to access this port.
Carry out the registration and the associated activation of TLS encryption promptly after installation.</p></div></td>
</tr></table></div>
<div class="paragraph"><p>The Agent Controller is started as a background process (<em>daemon</em>) by the <code>systemd</code> init system, so the agent will require a Linux distribution that includes <code>systemd</code>.
This requirement will probably be met on your host, as since 2015 most Linux distributions have adopted <code>systemd</code> as their init system.</p></div>
<div class="paragraph"><p>However, the agent also masters a so-called <strong>legacy mode</strong> to support Linux systems with a different computer architecture than x86_64, without RPM or DEB package management and without the <code>systemd</code> init system.
In this legacy mode, the agent works only as an agent script, i.e. without an Agent Controller and thus without registration on the Checkmk server.</p></div>
<div class="paragraph"><p>The article you are reading here covers the installation, configuration and extending of the Linux agent <strong>with</strong> the Agent Controller.
It also shows you how to find out whether the agent needs to be set up in the legacy mode on your Linux system without an Agent Controller.
In the <a href="agent_linux_legacy.html">Monitoring Linux in legacy mode</a> article you will will find all of the information on this subject.</p></div>
</div>
</div>
<div class="sect1">
<h2 id="heading_agent_architecture">
<span class="hidden-anchor sr-only" id="agent_architecture"></span>2. Architecture of the agent</h2>
<div class="sectionbody">
<div class="paragraph"><p>The Checkmk agent consists of the agent script and the Agent Controller, which communicates with the Agent Receiver on the Checkmk server.
See the general article on <a href="wato_monitoringagents.html#agents">monitoring agents</a> for details on the common architecture of Linux agent and <a href="agent_windows.html">Windows agent</a>.
This chapter is about the Linux specific implementation.</p></div>
<div class="paragraph"><p>The <strong>agent script</strong> <code>check_mk_agent</code> is responsible for the collection of the monitoring data and calls existing system commands for the data collection in sequence.
In order to obtain such information the agent also requires <code>root</code> privileges, so the <code>check_mk_agent</code> must be executed as the user <code>root</code>.</p></div>
<div class="paragraph"><p>The agent script is minimalistic, secure, easily extensible, and transparent because it is a shell script where you can see what commands it calls.</p></div>
<div class="paragraph"><p>The <strong>Agent Controller</strong> <code>cmk-agent-ctl</code> is the component within the agent that is responsible for transporting the data collected by the agent script.
The controller is executed using the <code>cmk-agent</code> user, which has limited privileges, e.g. no login shell, and is used only for data transfer.
The <code>cmk-agent</code> user is created during the installation of the agent package.
The Agent Controller is started as a daemon of <code>systemd</code> and is coupled to it as a service.
In pull mode, it listens on TCP port 6556 for incoming connections from the Checkmk <a href="glossar.html#site">site</a> and queries the agent script via a Unix socket (of a <code>systemd</code> unit).</p></div>
</div>
</div>
<div class="sect1">
<h2 id="heading_install">
<span class="hidden-anchor sr-only" id="install"></span>3. Installation</h2>
<div class="sectionbody">
<div class="paragraph"><p>Checkmk provides several ways of installing the Linux agent — from a manual installation of the software package to the fully automated deployment including its update function.
Some of these installation methods are only available in the commercial editions:</p></div>
<table class="table-responsive table-bordered table tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 30%;">
<col style="width: 50%;">
<col style="width: 10%;">
<col style="width: 10%;">
</colgroup>
<thead><tr>
<th class="tableblock halign-left valign-top">Method</th>
<th class="tableblock halign-left valign-top">Description</th>
<th class="tableblock halign-left valign-top">Checkmk Raw</th>
<th class="tableblock halign-left valign-top">Commercial editions</th>
</tr></thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Supplied RPM/DEB package</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Simple installation of a standard agent with manual configuration via configuration files.
The installation routine checks and configures <code>systemd</code> and <code>xinetd</code> in all editions — in this order.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">X</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">X</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">RPM/DEB package from <a href="glossar.html#agent_bakery">Agent Bakery</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Configuration via GUI, individual configuration per host possible.</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">X</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="agent_deployment.html">Automatic updates</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The package from the Agent Bakery is installed for the first time by hand or by script and will from then on be automatically updated.</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">X</p></td>
</tr>
</tbody>
</table>
<div class="sect2">
<h3 id="heading_download">
<span class="hidden-anchor sr-only" id="download"></span>3.1. Downloading RPM/DEB packages</h3>
<div class="paragraph"><p>You install the Linux agent by installing the RPM or the DEB package.
Whether you need RPM or DEB depends on the Linux distribution on which you want to install the package:</p></div>
<table class="table-responsive table-bordered table tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 10%;">
<col style="width: 10%;">
<col style="width: 80%;">
</colgroup>
<thead><tr>
<th class="tableblock halign-left valign-top">Package</th>
<th class="tableblock halign-left valign-top">Extension</th>
<th class="tableblock halign-left valign-top">Install on</th>
</tr></thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">RPM</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>.rpm</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Red Hat Enterprise Linux (RHEL) based systems, SLES, Fedora, openSUSE, derivatives thereof</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">DEB</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>.deb</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Debian, Ubuntu, all other DEB based distributions</p></td>
</tr>
</tbody>
</table>
<div class="paragraph"><p>Before installation you will need to get the package and bring it to the host (for example with <code>scp</code> or WinSCP) where you want the agent to run.</p></div>
<div class="sect3">
<h4 id="heading_download_gui">
<span class="hidden-anchor sr-only" id="download_gui"></span>Getting a package via Checkmk GUI</h4>
<div class="paragraph"><p>In <span class="image-inline"><img src="../images/icons/CRE.png" alt="CRE" width="20" title="Checkmk Raw"></span> <strong>Checkmk Raw</strong> you can find the agent’s Linux packages via <span class="guihint">Setup &gt; Agents &gt; Linux</span>.
In the commercial editions, you first get to the <a href="wato_monitoringagents.html#bakery">Agent Bakery</a> in the <span class="guihint">Setup</span> menu via <span class="guihint">Agents &gt; Windows, Linux, Solaris, AIX</span>, where you find the individually prepared packages.
From there, the <span class="guihint">Related &gt; Linux, Solaris, AIX files</span> menu item will take you to the list of agent files:</p></div>
<div class="imageblock">
<div class="content"><img src="../images/agent_linux_agent_files.png" alt="Download page with the RPM/DEB packages."></div>
<div class="title">You will find the RPM and DEB packages on the download page</div>
</div>
<div class="paragraph"><p>Everything you need can be found right in the first box named <span class="guihint">Packaged Agents</span>:
the ready-made RPM and DEB package files for installing the Linux agent with its default settings.</p></div>
</div>
<div class="sect3">
<h4 id="heading__getting_a_package_via_http">
<span class="hidden-anchor sr-only" id="_getting_a_package_via_http"></span>Getting a package via HTTP</h4>
<div class="paragraph"><p>Sometimes downloading to a machine and then copying to the target machine using <code>scp</code> or WinSCP can be very cumbersome.
You can also download the package from the Checkmk server directly to the target system via HTTP.
For this purpose, the agent file downloads are intentionally available <em>without needing to log in</em>, after all, the files do not contain any secrets.
Anyone can download and install Checkmk themselves and thus access the files.</p></div>
<div class="paragraph"><p>The easiest way to do this is with <code>wget</code>.
You can get the URL from the browser.
If you already know the name of the package, you can easily compose the URL yourself.
Put <code>/mysite/check_mk/agents/</code> in front of the filename, in the following example for the RPM package:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="console"><span></span><span class="tok-gp">root@linux# </span>wget<span class="tok-w"> </span>http://mycmkserver/mysite/check_mk/agents/check-mk-agent-2.3.0p16-1.noarch.rpm</code></pre></div></div>
<div class="paragraph"><p><strong>Tip:</strong> RPM even has a built-in <code>wget</code>.
Here you can download and <a href="#install_package">install</a> with a single command:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="console"><span></span><span class="tok-gp">root@linux# </span>rpm<span class="tok-w"> </span>-U<span class="tok-w"> </span>http://mycmkserver/mysite/check_mk/agents/check-mk-agent-2.3.0p16-1.noarch.rpm</code></pre></div></div>
</div>
<div class="sect3">
<h4 id="heading__getting_a_package_via_the_rest_api">
<span class="hidden-anchor sr-only" id="_getting_a_package_via_the_rest_api"></span>Getting a package via the REST API</h4>
<div class="paragraph"><p>Checkmk’s <a href="rest_api.html">REST API</a> provides the following methods for downloading agent packages from the Checkmk server:</p></div>
<div class="ulist"><ul>
<li><p>Downloading the provided agent.</p></li>
<li><p>Downloading an individually prepared agent by host name and operating system.</p></li>
<li><p>Downloading an individually prepared agent by hash of the agent and operating system.</p></li>
</ul></div>
<div class="paragraph"><p>Via REST API you have the option to fetch the package from the Checkmk server directly to the target machine.
For example, the DEB package with the Linux agent can be fetched with the following <code>curl</code> command:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="console"><span></span><span class="tok-gp">root@linux# </span>curl<span class="tok-w"> </span>-OJG<span class="tok-w"> </span><span class="tok-s2">"http://mycmkserver/mysite/check_mk/api/1.0/domain-types/agent/actions/download/invoke"</span><span class="tok-w"> </span><span class="tok-se">\</span>
--header<span class="tok-w"> </span><span class="tok-s1">'Accept: application/octet-stream'</span><span class="tok-w"> </span><span class="tok-se">\</span>
--header<span class="tok-w"> </span><span class="tok-s1">'Authorization: Bearer automation myautomationsecret'</span><span class="tok-w"> </span><span class="tok-se">\</span>
--data-urlencode<span class="tok-w"> </span><span class="tok-s1">'os_type=linux_deb'</span></code></pre></div></div>
<div class="paragraph"><p><strong>Note:</strong> The above command has been split into four lines for readability.</p></div>
<div class="paragraph"><p>This is just a simple example to demonstrate how this particular REST API endpoint works to download the agent.
For details on this and other REST API endpoints, see the API documentation available in Checkmk via <span class="guihint">Help &gt; Developer resources &gt; REST API documentation</span>.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="heading_install_package">
<span class="hidden-anchor sr-only" id="install_package"></span>3.2. Package installation</h3>
<div class="paragraph"><p>After you have fetched the RPM or the DEB package and — if necessary — copied it to the host to be monitored using <code>scp</code>, WinSCP or other means, the installation is accomplished with a single command.</p></div>
<div class="paragraph"><p>The RPM package is installed as user <code>root</code> with the command <code>rpm -U</code>:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="console"><span></span><span class="tok-gp">root@linux# </span>rpm<span class="tok-w"> </span>-U<span class="tok-w"> </span>check-mk-agent-2.3.0p16-1.noarch.rpm</code></pre></div></div>
<div class="paragraph"><p>By the way, the <code>-U</code> option stands for 'update', but it can also perform an initial installation correctly.
This also means that you can use this command to update an existing agent to the current version — and also use the same command for future updates of the agent package.</p></div>
<div class="paragraph"><p>The installation of the DEB package — and an update — is done as user <code>root</code> with the command <code>dpkg -i</code>:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="console"><span></span><span class="tok-gp">root@linux# </span>dpkg<span class="tok-w"> </span>-i<span class="tok-w"> </span>check-mk-agent_2.3.0p16-1_all.deb
<span class="tok-gp tok-gp-VirtualEnv">(Reading database ... 739920 files and directories currently installed.)</span>
<span class="tok-go">Preparing to unpack .../check-mk-agent_2.3.0p16-1_all.deb ...</span>
<span class="tok-go">Unpacking check-mk-agent (2.3.0p16-1) ...</span>
<span class="tok-go">Setting up check-mk-agent (2.3.0p16-1) ...</span>

<span class="tok-go">Deploying systemd units: check-mk-agent.socket check-mk-agent-async.service cmk-agent-ctl-daemon.service check-mk-agent@.service</span>
<span class="tok-go">Deployed systemd</span>
<span class="tok-go">Creating/updating cmk-agent user account ...</span>

<span class="tok-go">WARNING: The Agent Controller is operating in an insecure mode! To secure the connection run <code>cmk-agent-ctl register</code>.</span>

<span class="tok-go">Reloading xinetd</span>
<span class="tok-go">Activating systemd unit 'check-mk-agent.socket'...</span>
<span class="tok-go">Created symlink /etc/systemd/system/sockets.target.wants/check-mk-agent.socket → /lib/systemd/system/check-mk-agent.socket.</span>
<span class="tok-go">Activating systemd unit 'check-mk-agent-async.service'...</span>
<span class="tok-go">Created symlink /etc/systemd/system/multi-user.target.wants/check-mk-agent-async.service → /lib/systemd/system/check-mk-agent-async.service.</span>
<span class="tok-go">Activating systemd unit 'cmk-agent-ctl-daemon.service'...</span>
<span class="tok-go">Created symlink /etc/systemd/system/multi-user.target.wants/cmk-agent-ctl-daemon.service → /lib/systemd/system/cmk-agent-ctl-daemon.service.</span></code></pre></div></div>
<div class="paragraph"><p>Here the package was installed for the first time on a previously agentless host.
The <code>cmk-agent</code> user has been created and <code>systemd</code> has been configured.
We address the interim warning about <code>insecure mode</code>, i.e. legacy pull mode, <a href="#post_install">in a moment</a>.</p></div>
</div>
<div class="sect2">
<h3 id="heading__installation_using_the_agent_bakery">
<span class="hidden-anchor sr-only" id="_installation_using_the_agent_bakery"></span>3.3. Installation using the Agent Bakery</h3>
<div class="paragraph"><p><span class="image-inline"><img src="../images/CEE.svg" alt="CEE" class="icon-left"></span>
The commercial editions have a software module, the <a href="glossar.html#agent_bakery">Agent Bakery</a>, for automatically packaging customized agents.
A detailed description of this can be found in the general article on the <a href="wato_monitoringagents.html">agents</a>.
Installation of the baked packages is done in the same way as described <a href="#install_package">above</a> for the included packages.</p></div>
<div class="paragraph"><p>From Checkmk Cloud onwards you can additionally use the Agent Bakery to provide agent packages with a configuration for auto-registration,
which facilitates the <a href="hosts_autoregister.html">automatic creation of hosts</a>.
In this case, the agent registration is done automatically after the agent package is installed
and manual registration, as described in the following <a href="#registration">chapter</a>, is <em>no</em> longer necessary.</p></div>
</div>
<div class="sect2">
<h3 id="heading__automatic_updates">
<span class="hidden-anchor sr-only" id="_automatic_updates"></span>3.4. Automatic updates</h3>
<div class="paragraph"><p><span class="image-inline"><img src="../images/CEE.svg" alt="CEE" class="icon-left"></span>
If you use the Agent Bakery, you can also set up automatic updates of the agent.
These updates are described in their <a href="agent_deployment.html">own article</a>.</p></div>
</div>
<div class="sect2">
<h3 id="heading_post_install">
<span class="hidden-anchor sr-only" id="post_install"></span>3.5. What follows after the installation?</h3>
<div class="paragraph"><p>If the Agent Controller could be configured with <code>systemd</code> during installation, the next step is the <a href="#registration">registration</a>, which sets up TLS encryption so that the encrypted agent output can be decrypted by the Checkmk server and then displayed in the monitoring.</p></div>
<div class="paragraph"><p>There is a special feature when the agent was installed with the Agent Controller for the first time.
Then the agent switches to the unencrypted <strong>legacy pull mode</strong> so that the Checkmk server is not cut off from the monitoring data and can continue to display it.
This applies to a new installation as well as to an update of an agent of version <span class="new">2.0.0</span> and older.</p></div>
<div class="paragraph"><p>You will receive a notice of the activated legacy pull mode in the command output during the <a href="#install_package">installation of the agent</a>.
It will look like this in the monitoring:</p></div>
<div class="imageblock">
<div class="content"><img src="../images/agent_linux_service_legacy_pull_mode.png" alt="The WARN state of the 'Check_MK' service due to missing encryption."></div>
<div class="title">Warning in Checkmk monitoring that TLS is not yet active</div>
</div>
<div class="paragraph"><p>The Checkmk site recognizes from the agent output that the Agent Controller is present and thus TLS encryption is possible — but not yet enabled.
The <span class="guihint">Check_MK Agent</span> service changes to the <span class="state1">WARN</span> state and remains so until you register it.
After registration, only encrypted pull mode is used for communication.
The legacy pull mode is switched off and will remain so.
However, it can be switched on again <a href="#deregister">by command</a> if necessary.</p></div>
<div class="paragraph"><p>The case is different if the Agent Controller could not be registered as a daemon with <code>systemd</code> during the installation.
Without Agent Controller, registration is not possible and the only communication path remains the <strong>legacy mode</strong>.</p></div>
<div class="paragraph"><p>In the next chapter, you can determine whether you can proceed with registration by <a href="#test_environment">testing the Agent Controller and system environment</a>.</p></div>
<div class="paragraph"><p><strong>Note:</strong> In the <span class="guihint">Checkmk Agent installation auditing</span> rule set you will find various settings to check the state of the agent and make it visible in monitoring.
Among other things, you can specify here which state the <span class="guihint">Check_MK Agent</span> service should have if TLS configuration has not yet been performed.</p></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="heading_registration">
<span class="hidden-anchor sr-only" id="registration"></span>4. Registration</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="heading_overview">
<span class="hidden-anchor sr-only" id="overview"></span>4.1. Overview and prerequisites</h3>
<div class="paragraph"><p>Immediately following the agent installation (also as an update of an agent of version <span class="new">2.0.0</span> and older), only unencrypted communication is possible in the legacy pull mode.
An exclusively encrypted data transmission can only be activated once a trust relationship has been established.</p></div>
<div class="paragraph"><p>An exception to this are the packages preconfigured for the <a href="hosts_autoregister.html">auto-registration</a> and downloaded via the Agent Bakery.
These packages perform the registration automatically after installation.</p></div>
<div class="paragraph"><p>In all other cases, you perform the manual registration promptly after installing the agent.
This chapter shows how to perform the registration.</p></div>
<div class="paragraph"><p>The registration and thus the establishment of the mutual trust relationship is performed as a Checkmk user with access to the <a href="rest_api.html">REST-API</a>.
For this, a good choice is the <a href="glossar.html#automation_user">automation user</a> <code>agent_registration</code> which only has the permission to register agents and is automatically created with every Checkmk installation.
You can randomize the corresponding automation password (<em>automation secret</em>) with the <span class="image-inline"><img src="../images/icons/icon_random.png" alt="Icon for rolling a password."></span> icon.</p></div>
<div class="sect3">
<h4 id="heading__requirements_for_the_host">
<span class="hidden-anchor sr-only" id="_requirements_for_the_host"></span>Requirements for the host</h4>
<div class="paragraph"><p>Registering with the Agent Controller requires a Linux system with an init system <code>systemd</code> version 219 or later and an x86_64 computer architecture.
See the <a href="#test_environment">Testing Agent Controller and system environment</a> section to learn how to verify these prerequisites.</p></div>
</div>
<div class="sect3">
<h4 id="heading__requirements_for_the_server">
<span class="hidden-anchor sr-only" id="_requirements_for_the_server"></span>Requirements for the server</h4>
<div class="paragraph"><p>To register a host for monitoring, this host must be able to reach the REST API of the Checkmk server (port 443 or 80) and the Agent Receiver (port 8000 for the first site, 8001 for the second…​).
Read the section <a href="#networkrequirements">Network environment for registration</a>, in case your infrastructure cannot fulfill one of these requirements.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="heading__adding_a_host_to_the_setup">
<span class="hidden-anchor sr-only" id="_adding_a_host_to_the_setup"></span>4.2. Adding a host to the Setup</h3>
<div class="paragraph"><p>First create the new host via <span class="guihint">Setup &gt; Hosts &gt; Add host.</span>
A host must exist in the <a href="glossar.html#configuration_environment">configuration environment</a> before it can be registered.</p></div>
<div class="paragraph"><p>From Checkmk Cloud onwards you will find the <span class="guihint">Checkmk agent connection mode</span> option in the properties of the host in the section on <a href="hosts_setup.html#monitoring_agents">monitoring agents</a>.
Here you can activate the push mode for the Checkmk agent as an alternative to the pull mode, which is available in all editions.</p></div>
</div>
<div class="sect2">
<h3 id="heading_test_environment">
<span class="hidden-anchor sr-only" id="test_environment"></span>4.3. Testing the Agent Controller and system environment</h3>
<div class="paragraph"><p>The agent with the Agent Controller requires a Linux distribution with <code>systemd</code>, more precisely <code>systemd</code> in a version 219 or newer.</p></div>
<div class="paragraph"><p>There is a good chance that this requirement is met on your host, since from 2015 most Linux distributions have adopted <code>systemd</code> as their init system, replacing other init systems such as SysVinit, e.g. SUSE Linux Enterprise Server from version 12, openSUSE from version 12.1, Red Hat Enterprise Linux from version 7, Fedora from version 15, Debian from version 8 and Ubuntu from version 15.04.
Unfortunately, comparing the version number alone does not bring certainty, since <code>systemd</code> may be missing even on a current Linux system if it has 'only' been updated over the years.</p></div>
<div class="paragraph"><p>In addition to the version of <code>systemd</code>, some further prerequisites must be fulfilled, which will be explained in this chapter.</p></div>
<div class="paragraph"><p><strong>Attention:</strong> The push mode and auto-registration are necessarily dependent on the Agent Controller and are therefore not usable in the legacy mode, a matter to which we refer several times in this chapter.</p></div>
<div class="paragraph"><p>Therefore, first check on the host on which the agent is to be installed whether <code>systemd</code> is running and in which version:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="console"><span></span><span class="tok-gp">root@linux# </span>systemctl<span class="tok-w"> </span>--version
<span class="tok-go">systemd 245 (245.4-4ubuntu3.15)</span></code></pre></div></div>
<div class="paragraph"><p>The above command output shows that <code>systemd</code> is installed in the correct version.
If <code>systemd</code> is not running, or is running in a version that is too old, the Agent Controller cannot be used.
Complete the setup as described in the article <a href="agent_linux_legacy.html">Monitoring Linux in legacy mode</a>.</p></div>
<div class="paragraph"><p>Now check whether the Agent Controller can be started:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="console"><span></span><span class="tok-gp">root@linux# </span>cmk-agent-ctl<span class="tok-w"> </span>--version</code></pre></div></div>
<div class="paragraph"><p>The version number should be shown in the output, for example:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="console"><span></span><span class="tok-go">cmk-agent-ctl 2.3.0p16</span></code></pre></div></div>
<div class="paragraph"><p>In rare cases, the following error message may appear:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="console"><span></span><span class="tok-go">bash: /usr/bin/cmk-agent-ctl: cannot execute binary file: Exec format error</span></code></pre></div></div>
<div class="paragraph"><p>The reason for this is that your Linux uses a different computer architecture than <em>x86_64</em>, for example the older <em>32-bit x86</em> or <em>ARM</em>.
In this case, the Agent Controller cannot be used.
Complete the setup as described in the article <a href="agent_linux_legacy.html">Monitoring Linux in legacy mode</a>.</p></div>
<div class="paragraph"><p>The next step is to find out which program is waiting for requests on port 6556:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="console"><span></span><span class="tok-gp">root@linux# </span>ss<span class="tok-w"> </span>-tulpn<span class="tok-w"> </span><span class="tok-p">|</span><span class="tok-w"> </span>grep<span class="tok-w"> </span><span class="tok-m">6556</span>
<span class="tok-go">tcp	LISTEN	0	1024	0.0.0.0:6556	0.0.0.0:*	users:(("cmk-agent-ctl",pid=1861810,fd=9))</span></code></pre></div></div>
<div class="paragraph"><p>Here it is <code>cmk-agent-ctl</code>.
Thus the requirements for an encrypted communication have been fulfilled.
If however <code>systemd</code>, <code>xinetd</code> or <code>inetd</code> are within the parentheses the prerequisites for using the Agent Controller are not met.
In such a case, also complete the setup as described in the article <a href="agent_linux_legacy.html">Monitor Linux in legacy mode</a>.</p></div>
</div>
<div class="sect2">
<h3 id="heading__registering_a_host_with_the_server">
<span class="hidden-anchor sr-only" id="_registering_a_host_with_the_server"></span>4.4. Registering a host with the server</h3>
<div class="paragraph"><p>The registration is done using the Agent Controller <code>cmk-agent-ctl</code>, which provides a command interface for configuring the connections.
You can display command help with <code>cmk-agent-ctl help</code>, also for specific available subcommands, with <code>cmk-agent-ctl help register</code> for example.</p></div>
<div class="paragraph"><p>Whether the host is configured for the pull mode or the push mode makes no difference for the command examples.
The Agent Receiver tells the Agent Controller in which mode it should operate during registration.</p></div>
<div class="paragraph"><p>Now go to the host that is to be registered.
Here, with <code>root</code> privileges, make a request to the Checkmk <a href="glossar.html#site">site</a>:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="console"><span></span><span class="tok-gp">root@linux# </span>cmk-agent-ctl<span class="tok-w"> </span>register<span class="tok-w"> </span>--hostname<span class="tok-w"> </span>mynewhost<span class="tok-w"> </span><span class="tok-se">\</span>
<span class="tok-w">    </span>--server<span class="tok-w"> </span>cmkserver<span class="tok-w"> </span>--site<span class="tok-w"> </span>mysite<span class="tok-w"> </span><span class="tok-se">\</span>
<span class="tok-w">    </span>--user<span class="tok-w"> </span>agent_registration<span class="tok-w"> </span>--password<span class="tok-w"> </span><span class="tok-s1">'PTEGDYXBFXVGNDPRL'</span></code></pre></div></div>
<div class="paragraph"><p>The host name following the <code>--hostname</code> option must be exactly the same as it was when it was created in the Setup.
The <code>--server</code> and <code>--site</code> options specify the name of the Checkmk server and the site.
The server name may also be the IP address, the site name (here <code>mysite</code>) corresponds to the one you see in the URL path for the web interface.
The options are completed by the name and password used by the automation user.
If you omit the <code>--password</code> option, the password will be requested interactively.</p></div>
<div class="paragraph"><p>If the specified values were correct, you will be asked to confirm the identity of the Checkmk site to which you want to connect.
For clarity here, we have abbreviated the server certificate to be confirmed:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="console"><span></span><span class="tok-go">Attempting to register at cmkserver:8000/mysite. Server certificate details:</span>

<span class="tok-go">PEM-encoded certificate:</span>
<span class="tok-go">---BEGIN CERTIFICATE---</span>
<span class="tok-go">MIIC6zCCAdOgAwIBAgIUXbSE8FXQfmFqoRNhG9NpHhlRJ40wDQYJKoZIhvcNAQEL</span>
<span class="tok-go">[...]</span>
<span class="tok-go">nS+9hN5ILfRI+wkdrQLC0vkHVYY8hGIEq+xTpG/Pxw==</span>
<span class="tok-go">---END CERTIFICATE---</span>

<span class="tok-go">Issued by:</span>
<span class="tok-go">	Site 'mysite' local CA</span>
<span class="tok-go">Issued to:</span>
<span class="tok-go">	localhost</span>
<span class="tok-go">Validity:</span>
<span class="tok-go">	From Thu, 10 Feb 2022 15:13:22 +0000</span>
<span class="tok-go">	To   Tue, 13 Jun 3020 15:13:22 +0000</span>

<span class="tok-go">Do you want to establish this connection? [Y/n]</span>
<span class="tok-go">&gt; <mark>Y</mark></span></code></pre></div></div>
<div class="paragraph"><p>Confirm with <code>Y</code> to complete the process.</p></div>
<div class="paragraph"><p>If no error message is displayed, the encrypted connection will have been established.
All data will now be transmitted in compressed form via this connection.</p></div>
<div class="paragraph"><p>If you want to disable the interactive check of the certificate—​for example to fully automate the registration—​you might use the additional parameter <code>--trust-cert</code>.
The transferred certificate will be automatically trusted in this case.
Keep in mind that you should take other measures to verify the integrity of the certificate.
This can be performed (manually or scripted) by inspecting the <a href="#files">file</a> <code>/var/lib/cmk-agent/registered_connections.json</code>.</p></div>
</div>
<div class="sect2">
<h3 id="heading_autoregister">
<span class="hidden-anchor sr-only" id="autoregister"></span>4.5. Registering a host automatically with the server</h3>
<div class="paragraph"><p>From Checkmk Cloud onwards, Checkmk offers the facility to create hosts automatically at registration.
For the <a href="hosts_autoregister.html">auto-registration</a>, in addition to a user with permission to register hosts, you need at least one folder configured to hold the hosts to be created automatically.</p></div>
<div class="paragraph"><p>If these conditions have been met, you can also carry out the registration including automatic host creation via the command line.</p></div>
<div class="paragraph"><p>Usually you will use the <a href="hosts_autoregister.html#rule_autoregister_bakery">Agent Bakery settings</a> procedure,
which includes the <code>/var/lib/cmk-agent/pre_configured_connections.json</code> configuration file in the agent package and which performs the registration automatically during installation.
The command line call presented here is therefore primarily for testing and debugging, for example trying out your own <em>agent labels</em> with the <code>--agent-labels &lt;KEY=VALUE&gt;</code> option.</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="console"><span></span><span class="tok-gp">root@linux# </span>cmk-agent-ctl<span class="tok-w"> </span>register-new<span class="tok-w"> </span><span class="tok-se">\</span>
<span class="tok-w">    </span>--server<span class="tok-w"> </span>cmkserver<span class="tok-w"> </span>--site<span class="tok-w"> </span>mysite<span class="tok-w"> </span><span class="tok-se">\</span>
<span class="tok-w">    </span>--agent-labels<span class="tok-w"> </span>testhost:true<span class="tok-w"> </span><span class="tok-se">\</span>
<span class="tok-w">    </span>--user<span class="tok-w"> </span>agent_registration<span class="tok-w"> </span>--password<span class="tok-w"> </span><span class="tok-s1">'PTEGDYXBFXVGNDPRL'</span></code></pre></div></div>
<div class="paragraph"><p>The biggest difference here is the modified <code>register-new</code> sub-command, which is used to request registration <em>and</em> creation of a new host in the Checkmk site.
The name of the host is the one stored in the <code>$HOSTNAME</code> environment variable.
The subsequent confirmation of the certificate is the same as shown in the last section.</p></div>
<div class="paragraph"><p>Whether the host is created in pull mode, push mode or not at all is defined by your settings in the <span class="guihint">Agent registration</span> rule set.
Following a successful registration, it may take several minutes before the host appears in the monitoring.</p></div>
</div>
<div class="sect2">
<h3 id="heading__verifying_the_trust_relationship">
<span class="hidden-anchor sr-only" id="_verifying_the_trust_relationship"></span>4.6. Verifying the trust relationship</h3>
<div class="paragraph"><p>The <code>cmk-agent-ctl status</code> command now shows exactly one trust relationship with the Checkmk server:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="console"><span></span><span class="tok-gp">root@linux# </span>cmk-agent-ctl<span class="tok-w"> </span>status
<span class="tok-go">Connection: 12.34.56.78:8000/mysite</span>
<span class="tok-go">	UUID: d38e7e53-9f0b-4f11-bbcf-d19617971595</span>
<span class="tok-go">	Local:</span>
<span class="tok-go">		Connection type: pull-agent</span>
<span class="tok-go">		Certificate issuer: Site 'mysite' local CA</span>
<span class="tok-go">		Certificate validity: Mon, 21 Feb 2022 11:23:57 +0000 - Sat, 24 Jun 3020 11:23:57 +0000</span>
<span class="tok-go">	Remote:</span>
<span class="tok-go">		Connection type: pull-agent</span>
<span class="tok-go">		Host name: mynewhost</span></code></pre></div></div>
<div class="paragraph"><p>In case the information is needed in a machine-readable format, append the additional parameter <code>--json</code> to retrieve the output formatted as a JSON object.</p></div>
<div class="paragraph"><p><strong>Note:</strong> There can only ever be one trust relationship between host and site.
For example, if you register an already registered host <code>mynewhost</code> under a different name (<code>mynewhost2</code>) but with the same IP address, then the new connection will replace the existing one.
The connection from <code>mynewhost</code> to the site will be disconnected and no more agent data will be supplied to the host for monitoring.</p></div>
</div>
<div class="sect2">
<h3 id="heading_proxyregister">
<span class="hidden-anchor sr-only" id="proxyregister"></span>4.7. Registration by proxy</h3>
<div class="paragraph"><p>For easier registration of multiple hosts, any host on which the agent is installed can perform a registration on behalf of other hosts.
The registration process exports a JSON file, which can then be transferred to the target host and imported there.
Again, as before, the host registered in the job must already be set up on the site.</p></div>
<div class="paragraph"><p>First, on any host in the Setup, the registration is performed by proxy.
Here, of course, the Checkmk server comes in handy, as it is usually the first host to be set up.
As with the example above, you can pass the password by option or be asked for it interactively if you omit the <code>--password</code> option.
We redirect the JSON output to a file in the example:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="console"><span></span><span class="tok-gp">root@linux# </span>cmk-agent-ctl<span class="tok-w"> </span>proxy-register<span class="tok-w"> </span><span class="tok-se">\</span>
<span class="tok-w">    </span>--hostname<span class="tok-w"> </span>mynewhost3<span class="tok-w"> </span><span class="tok-se">\</span>
<span class="tok-w">    </span>--server<span class="tok-w"> </span>cmkserver<span class="tok-w"> </span>--site<span class="tok-w"> </span>mysite<span class="tok-w"> </span><span class="tok-se">\</span>
<span class="tok-w">    </span>--user<span class="tok-w"> </span>agent_registration<span class="tok-w"> </span>&gt;<span class="tok-w"> </span>/tmp/mynewhost3.json</code></pre></div></div>
<div class="paragraph"><p>Next we transfer the <code>/tmp/mynewhost3.json</code> file to the host we registered for and import that file:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="console"><span></span><span class="tok-gp">root@linux# </span>cmk-agent-ctl<span class="tok-w"> </span>import<span class="tok-w"> </span>/tmp/mynewhost3.json</code></pre></div></div>
<div class="paragraph"><p>This process is also possible in a single step using a pipeline where the output of <code>cmk-agent-ctl proxy-register</code> is handed over as input to <code>ssh hostname cmk-agent-ctl import</code>:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="console"><span></span><span class="tok-gp">root@linux# </span>cmk-agent-ctl<span class="tok-w"> </span>proxy-register<span class="tok-w"> </span>--hostname<span class="tok-w"> </span>mynewhost3<span class="tok-w"> </span><span class="tok-se">\</span>
<span class="tok-w">    </span>--server<span class="tok-w"> </span>cmkserver<span class="tok-w"> </span>--site<span class="tok-w"> </span>mysite<span class="tok-w"> </span><span class="tok-se">\</span>
<span class="tok-w">    </span>--user<span class="tok-w"> </span>agent_registration<span class="tok-w"> </span>--password<span class="tok-w"> </span><span class="tok-s1">'PTEGDYXBFXVGNDPRL'</span><span class="tok-w"> </span><span class="tok-p">|</span><span class="tok-w"> </span><span class="tok-se">\</span>
<span class="tok-w">    </span>ssh<span class="tok-w"> </span>root@mynewhost3<span class="tok-w"> </span>cmk-agent-ctl<span class="tok-w"> </span>import</code></pre></div></div>
</div>
<div class="sect2">
<h3 id="heading__adding_the_host_to_the_monitoring">
<span class="hidden-anchor sr-only" id="_adding_the_host_to_the_monitoring"></span>4.8. Adding the host to the monitoring</h3>
<div class="paragraph"><p>Once the registration is complete, perform a <a href="wato_monitoringagents.html#diagnosticpage">connection test</a> and a <a href="wato_services.html#discovery">service discovery</a> in the Checkmk server Setup.
Then, as the last step include the discovered services in the monitoring by <a href="wato.html#activate_changes">activating the changes</a>.</p></div>
<div class="paragraph"><p>If the connection test fails, refer to the <a href="#test">following chapter</a> for testing and troubleshooting information.</p></div>
</div>
<div class="sect2">
<h3 id="heading_deregister">
<span class="hidden-anchor sr-only" id="deregister"></span>4.9. Deregistering a host</h3>
<div class="paragraph"><p>You can also deregister a host.</p></div>
<div class="paragraph"><p>On a host connected to the Checkmk server, you can revoke the trust.
Here, in the following command, the Universally Unique Identifier (UUID) to specify is the one output by the <code>cmk-agent-ctl status</code> command:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="console"><span></span><span class="tok-gp">root@linux# </span>cmk-agent-ctl<span class="tok-w"> </span>delete<span class="tok-w"> </span>d38e7e53-9f0b-4f11-bbcf-d19617971595</code></pre></div></div>
<div class="paragraph"><p>To delete all connections from the host <strong>and</strong> additionally restore legacy pull mode, enter the following command:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="console"><span></span><span class="tok-gp">root@linux# </span>cmk-agent-ctl<span class="tok-w"> </span>delete-all<span class="tok-w"> </span>--enable-insecure-connections</code></pre></div></div>
<div class="paragraph"><p>After that, the agent behaves as it did after the initial installation and before the first registration and sends its data unencrypted.</p></div>
<div class="paragraph"><p>Complete the deregistration on the Checkmk server:
In the Setup, on the <span class="guihint">Properties of host</span> page, select the <span class="guihint">Host &gt; Remove TLS registration</span> menu item and confirm the prompt.</p></div>
<div class="paragraph"><p>In case you prefer the command line:
On the Checkmk server, for each connection of a host that is in monitoring, there is a soft link with the UUID that points to the folder with the agent output:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="console"><span></span><span class="tok-gp">OMD[mysite]:~$ </span><span class="tok-nb">cd</span><span class="tok-w"> </span>~/var/agent-receiver/received-outputs
<span class="tok-gp">OMD[mysite]:~$ </span>ls<span class="tok-w"> </span>-l<span class="tok-w"> </span>d38e7e53-9f0b-4f11-bbcf-d19617971595
<span class="tok-go">lrwxrwxrwx 1 mysite mysite 67 Feb 23 07:18 d38e7e53-9f0b-4f11-bbcf-d19617971595 -&gt; /omd/sites/mysite/tmp/check_mk/data_source_cache/push-agent/mynewhost</span></code></pre></div></div>
</div>
<div class="sect2">
<h3 id="heading_changepush">
<span class="hidden-anchor sr-only" id="changepush"></span>4.10. Switching between the push and pull modes</h3>
<div class="paragraph"><p>From <span class="image-inline"><img src="../images/icons/CSE.png" alt="CSE" width="20" title="Checkmk Cloud"></span> <strong>Checkmk Cloud</strong> onwards you can switch hosts from push to pull mode and vice versa.
This may be necessary in individual cases if changes to the network topology are pending, or a downgrade to <span class="image-inline"><img src="../images/icons/CSE.png" alt="CSE" width="20" title="Checkmk Enterprise"></span> <strong>Checkmk Enterprise</strong> — in which only the pull mode is possible — is to be carried out.</p></div>
<div class="paragraph"><p>First specify the access mode in the Setup, in the properties of the host, with the <span class="guihint">Checkmk agent connection mode</span> option.
Within the next minute, all services will assume the <span class="state3">UNKNOWN</span> status since no monitoring data is being received.
Then perform a new registration.
During this re-registration, the Checkmk server’s Agent Receiver tells the Agent Controller whether it expects data in pull or push mode.
A subsequent check using <code>cmk-agent-ctl status</code> will then show a new UUID and a mode consistent with the change made in the Setup.</p></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="heading_test">
<span class="hidden-anchor sr-only" id="test"></span>5. Testing and troubleshooting</h2>
<div class="sectionbody">
<div class="paragraph"><p>A modular system may not work as intended in many situations.
Since the agent introduced with version <span class="new">2.1.0</span> the two components, the Agent Controller on the host and the Agent Receiver on the Checkmk server, the number of points where something can go wrong has increased.</p></div>
<div class="paragraph"><p>When troubleshooting, a structured approach is thus recommended.
You can of course also use the step-by-step analysis described here to get to know the data collection and communication provided by Checkmk in more detail.</p></div>
<div class="paragraph"><p>All of the diagnostic options that are available from the Checkmk server side are described in the general article on <a href="wato_monitoringagents.html#diagnostics">monitoring agents</a>.
But, of course, there are other diagnostics available when logged in directly to the monitored host itself.</p></div>
<div class="paragraph"><p>We’ll work our way from the agent script, through the Agent Controller and TCP port 6556, to the Checkmk site in the following sections.
With the Agent Controller in push mode, bypass any tests on port 6556 — even if port 6556 is open before the registration, it will be closed following a registration in the push mode.
In most cases, after correcting any errors, you can restart the service discovery and complete the inclusion in the monitoring.</p></div>
<div class="admonitionblock important"><table><tr>
<td class="icon"><img src="../images/icons/important.png" alt="Important"></td>
<td class="content"><div class="paragraph"><p>When the agent script is called directly in a shell, other <a href="https://wiki.debian.org/EnvironmentVariables" target="_blank">environment variables</a> may be available than when called by the Agent Controller.
To analyze the output of the agent script, you should therefore use the <a href="#agent_ctl_dump">Agent Controller in dump mode</a> if possible.</p></div></td>
</tr></table></div>
<div class="sect2">
<h3 id="heading_script_output">
<span class="hidden-anchor sr-only" id="script_output"></span>5.1. Output from the agent script</h3>
<div class="paragraph"><p>The agent script is a simple shell script that obtains data on your system and outputs it as loosely formatted text.
You can call this script directly from the command line.
Since the output can be a bit long, the option <code>less</code> to scroll the output is very handy here.
You can exit it with the Q key:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="console"><span></span><span class="tok-gp">root@linux# </span>check_mk_agent<span class="tok-w"> </span><span class="tok-p">|</span><span class="tok-w"> </span>less
<span class="tok-go">&lt;&lt;&lt;check_mk&gt;&gt;&gt;</span>
<span class="tok-go">Version: 2.3.0p16</span>
<span class="tok-go">AgentOS: linux</span>
<span class="tok-go">Hostname: mynewhost</span>
<span class="tok-go">AgentDirectory: /etc/check_mk</span>
<span class="tok-go">DataDirectory: /var/lib/check_mk_agent</span>
<span class="tok-go">SpoolDirectory: /var/lib/check_mk_agent/spool</span>
<span class="tok-go">PluginsDirectory: /usr/lib/check_mk_agent/plugins</span>
<span class="tok-go">LocalDirectory: /usr/lib/check_mk_agent/local</span>
<span class="tok-go">AgentController: cmk-agent-ctl 0.1.0</span></code></pre></div></div>
<div class="paragraph"><p>This allows you to test whether the agent script and your plug-ins and local checks are installed correctly.</p></div>
<div class="paragraph"><p>By the way, you do not have to be <code>root</code> to call the agent.
However, the output will then lack some information that requires <code>root</code> privileges to obtain (e.g. multipath information and the outputs of <code>ethtool</code>).</p></div>
</div>
<div class="sect2">
<h3 id="heading__the_agent_script_in_debug_mode">
<span class="hidden-anchor sr-only" id="_the_agent_script_in_debug_mode"></span>5.2. The agent script in debug mode</h3>
<div class="paragraph"><p>To prevent any error output from inactive plug-ins or commands from 'contaminating' the required data, the agent script generally suppresses the standard error channel (STDERR).
If you are looking for a specific problem, you can re-enable the STDERR by calling the agent script in a special debug mode.</p></div>
<div class="paragraph"><p>Beforehand, you should check whether the agent script and the Agent Controller in <a href="#agent_ctl_dump">dump mode</a> deliver identical output and, if necessary, ensure an identical environment.
This can be done by setting variables in a plug-in/local check or in the shell.
You can create a dump of the environment by adding the line</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="console"><span></span><span class="tok-go">env &gt; /tmp/cmk_agent_environment.txt</span></code></pre></div></div>
<div class="paragraph"><p>to a plug-in file and then checking the contents of the file after execution by the Agent Controller.</p></div>
<div class="paragraph"><p>The additional debug information is then output using the <code>-d</code> option.
All shell commands executed by the script will also be output.
So that you can work with <code>less</code> here, you must combine standard output (STDOUT) and error channel with <code>2&gt;&amp;1</code>:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="console"><span></span><span class="tok-gp">root@linux# </span>check_mk_agent<span class="tok-w"> </span>-d<span class="tok-w"> </span><span class="tok-m">2</span>&gt;<span class="tok-p">&amp;</span><span class="tok-m">1</span><span class="tok-w"> </span><span class="tok-p">|</span><span class="tok-w"> </span>less</code></pre></div></div>
</div>
<div class="sect2">
<h3 id="heading_networkrequirements">
<span class="hidden-anchor sr-only" id="networkrequirements"></span>5.3. Network environment for registration</h3>
<div class="paragraph"><p>If registering a host fails even before a certificate is presented, knowledge about the ways of communication can help identifying the problem — and of course solving it.</p></div>
<div class="paragraph"><p>After entering the <code>cmk-agent-ctl register</code> command, the Agent Controller first asks the Checkmk server for the Agent Receiver port using the REST API.
As second step a connection to the Agent Receiver is established to request the certificate.
You can simulate the first request on the host with a program like <code>curl</code>:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="console"><span></span><span class="tok-gp">root@linux# </span>curl<span class="tok-w"> </span>-v<span class="tok-w"> </span>--insecure<span class="tok-w"> </span>https://mycmkserver/mysite/check_mk/api/1.0/domain-types/internal/actions/discover-receiver/invoke</code></pre></div></div>
<div class="paragraph"><p>The parameter <code>--insecure</code> instructs <code>curl</code> to skip the certificate check.
This behavior reflects the behavior of the Agent Controller in this step.
The response is only a few bytes, containing the port number of the Agent Receiver.
For the first site this is usually just <code>8000</code>, for the second <code>8001</code> and so on.
Common problems regarding this request are:</p></div>
<div class="ulist"><ul>
<li><p>The Checkmk server is unreachable from the host.</p></li>
<li><p>The port used by the REST API differs from the default ports 443 (https) or 80 (http).</p></li>
</ul></div>
<div class="paragraph"><p>When the curl command fails you might change routing or firewall settings to enable access.</p></div>
<div class="paragraph"><p>In case the host you are trying to register uses an HTTP proxy, <code>curl</code> will use it, but <code>cmk-agent-ctl</code> won’t do so with default settings.
Use the additional <code>--detect-proxy</code> option to instruct <code>cmk-agent-ctl</code> to use a proxy configured via system settings.</p></div>
<div class="paragraph"><p>However often it may be easier to find out the port of the Agent Receiver and note it down.
To do so, on the Checkmk server run, logged in as site user:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="console"><span></span><span class="tok-gp">OMD[mysite]:~$ </span>omd<span class="tok-w"> </span>config<span class="tok-w"> </span>show<span class="tok-w"> </span><span class="tok-p">|</span><span class="tok-w"> </span>grep<span class="tok-w"> </span>AGENT_RECEIVER
<span class="tok-go">AGENT_RECEIVER: on</span>
<span class="tok-go">AGENT_RECEIVER_PORT: 8000</span></code></pre></div></div>
<div class="paragraph"><p>Now you can specify the port when entering the command for registration.
This skips the first request to the REST API.
Communication then takes place directly with the Agent Receiver without any detours:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="console"><span></span><span class="tok-gp">root@linux# </span>cmk-agent-ctl<span class="tok-w"> </span>register<span class="tok-w"> </span>--hostname<span class="tok-w"> </span>mynewhost<span class="tok-w"> </span><span class="tok-se">\</span>
<span class="tok-w">    </span>--server<span class="tok-w"> </span>mycmkserver:8000<span class="tok-w"> </span>--site<span class="tok-w"> </span>mysite<span class="tok-w"> </span><span class="tok-se">\</span>
<span class="tok-w">    </span>--user<span class="tok-w"> </span>agent_registration<span class="tok-w"> </span>--password<span class="tok-w"> </span><span class="tok-s1">'PTEGDYXBFXVGNDPRL'</span></code></pre></div></div>
<div class="paragraph"><p>Port 8000 also must be reachable from the host.
In case it is not, you will get this error message:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="console"><span></span><span class="tok-go">ERROR [cmk_agent_ctl] Connection refused (os error 111)</span></code></pre></div></div>
<div class="paragraph"><p>Equivalent to port 443 (respectively 80) mentioned above, you can now adjust routing or firewall settings so that the host to be registered can reach the Checkmk server on the Agent Receiver’s port (8000 or 8001…​)</p></div>
<div class="paragraph"><p>In the case of a registration in push mode the following applies:
If the registration has worked, the minute-by-minute transfer of the agent output will also be successful.</p></div>
<div class="paragraph"><p>Should security policies prohibit access to the Agent Receiver, there is still the possibility to use <a href="#proxyregister">registration by proxy</a> on the Checkmk server.</p></div>
</div>
<div class="sect2">
<h3 id="heading_agent_ctl_dump">
<span class="hidden-anchor sr-only" id="agent_ctl_dump"></span>5.4. The Agent Controller in dump mode</h3>
<div class="paragraph"><p>The Agent Controller provides its own <code>dump</code> subcommand that displays the full agent output as it arrives in the monitoring:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="console"><span></span><span class="tok-gp">root@linux# </span>cmk-agent-ctl<span class="tok-w"> </span>dump<span class="tok-w"> </span><span class="tok-p">|</span><span class="tok-w"> </span>less
<span class="tok-go">&lt;&lt;&lt;check_mk&gt;&gt;&gt;</span>
<span class="tok-go">Version: 2.3.0p16</span>
<span class="tok-go">AgentOS: linux</span>
<span class="tok-go">Hostname: mynewhost</span></code></pre></div></div>
<div class="paragraph"><p>This allows you to verify that the data from the agent script has arrived at the Agent Controller.
This output does not yet prove that the agent is also accessible over the network.</p></div>
<div class="paragraph"><p>In some cases, the output will look like this:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="console"><span></span><span class="tok-go">ERROR [cmk_agent_ctl] Error collecting monitoring data.</span>

<span class="tok-go">Caused by:</span>
<span class="tok-go">    Connection refused (os error 111)</span></code></pre></div></div>
<div class="paragraph"><p>This would be the case when the agent socket is not running in the background — immediately following an update, for example.
Restart this background process:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="console"><span></span><span class="tok-gp">root@linux# </span>systemctl<span class="tok-w"> </span>restart<span class="tok-w"> </span>check-mk-agent.socket</code></pre></div></div>
<div class="paragraph"><p>If <code>cmk-agent-ctl dump</code> fails again, check if and which program is listening on port 6556:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="console"><span></span><span class="tok-gp">root@linux# </span>ss<span class="tok-w"> </span>-tulpn<span class="tok-w"> </span><span class="tok-p">|</span><span class="tok-w"> </span>grep<span class="tok-w"> </span><span class="tok-m">6556</span>
<span class="tok-go">tcp	LISTEN	0	1024	0.0.0.0:6556 0.0.0.0:*	users:(("cmk-agent-ctl",pid=1861810,fd=9))</span></code></pre></div></div>
<div class="paragraph"><p>If the output is empty or there is a command other than <code>cmk-agent-ctl</code> within the parentheses, the system requirements for using the Agent Controller have not been met.
In this case, complete the setup as described in the article <a href="agent_linux_legacy.html">Monitor Linux in legacy mode</a>.</p></div>
</div>
<div class="sect2">
<h3 id="heading__remote_connection_test">
<span class="hidden-anchor sr-only" id="_remote_connection_test"></span>5.5. Remote connection test</h3>
<div class="paragraph"><p>If in pull mode it has been verified that the agent script and its installed plug-ins are executed correctly,
you can next check via <code>netcat</code> (or <code>nc</code>) whether port 6556 is reachable via the external IP address of the host:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="console"><span></span><span class="tok-gp">root@linux# </span><span class="tok-nb">echo</span><span class="tok-w"> </span><span class="tok-p">|</span><span class="tok-w"> </span>nc<span class="tok-w"> </span><span class="tok-m">10</span>.76.23.189<span class="tok-w"> </span><span class="tok-m">6556</span>
<span class="tok-go">16</span></code></pre></div></div>
<div class="paragraph"><p>The output <code>16</code> indicates that the connection was successfully established and that the TLS handshake can now take place.
Since everything else here is TLS encrypted, no more detailed check is possible.</p></div>
<div class="paragraph"><p>If a remote connection test fails, it is usually due to the firewall setting.
In this case, configure <code>iptables</code> or <code>nftables</code> to allow access to TCP port 6556 from the Checkmk server.</p></div>
<div class="paragraph"><p>If the communication between agent and Checkmk server is <em>still</em> unencrypted (as in legacy pull mode), or is and will remain unencrypted (as in <a href="agent_linux_legacy.html">legacy mode</a>),
this command will give you the full unencrypted agent output instead of the <code>16</code>.</p></div>
<div class="paragraph"><p><strong>Note:</strong> For more diagnostics to run on the Checkmk server, see the general article on <a href="wato_monitoringagents.html#diagnostics">monitoring agents</a>.</p></div>
</div>
<div class="sect2">
<h3 id="heading_debugpush">
<span class="hidden-anchor sr-only" id="debugpush"></span>5.6. Troubleshooting the agent in push mode</h3>
<div class="paragraph"><p>In your Checkmk site’s <code>~/var/agent-receiver/received-outputs/</code> folder, for each registered host you will find a soft link that uses the host’s UUID as its name.
For hosts in push mode this soft link points to the folder with the agent output, for pull hosts it points to a non-existent file with the name of the host as used in the monitoring.</p></div>
<div class="paragraph"><p>Based on the age of the cached agent output, you can determine whether the regular transmission was successful or is being interrupted by sporadic network problems, for example.</p></div>
<div class="paragraph"><p>Furthermore, you can display the status of the latest transmissions and transmission attempts on the host with the <code>systemctl status cmk-agent-ctl-daemon</code> command.
Lines such as the following indicate connection problems:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="console"><span></span><span class="tok-go">Dez 15 17:59:49 myhost23 cmk-agent-ctl[652648]: WARN [cmk_agent_ctl::modes::push] https://mycmkserver:8000/mysite: Error pushing agent output.</span></code></pre></div></div>
</div>
<div class="sect2">
<h3 id="heading_lostconnections">
<span class="hidden-anchor sr-only" id="lostconnections"></span>5.7. Connections are being lost</h3>
<div class="paragraph"><p>If a host has been configured for <a href="hosts_autoregister.html#rule_autoregister_bakery">auto-registration</a> with the <span class="guihint">Agent controller auto-registration</span> rule set and the <span class="guihint">Keep existing connections</span> option is set to <span class=" guihint">no</span>, whenever the <code>cmk-agent-ctl-daemon</code> service is restarted (for example, when a host is restarted), all other connections will be removed — except the connection configured for auto-registration.
This affects, for example, hosts where connections to multiple sites were set up before the baked agent package was installed, or connections were manually added after the agent package was installed.</p></div>
<div class="paragraph"><p>You can temporarily override this behavior by setting the <code>keep_existing_connections</code> variable to <code>true</code> in the <code>C:\ProgramData\checkmk\agent\pre_configured_connections.json</code> file on the host.
You can achieve a permanent change across an agent package update by setting <span class="guihint">Keep existing connections</span> to <span class="guihint">yes</span> in the above rule set.</p></div>
</div>
<div class="sect2">
<h3 id="heading_howlong">
<span class="hidden-anchor sr-only" id="howlong"></span>5.8. Waiting time until changes become visible</h3>
<div class="paragraph"><p>When auto-registering a host, typically about two minutes pass before the host appears in the monitoring.</p></div>
<div class="paragraph"><p>If a connection in pull mode to another site was subsequently added to a host that was initially configured for push mode, up to five minutes will pass before port 6556 is opened.
You can open the port immediately by restarting the <code>cmk-agent-ctl-daemon</code> service.</p></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="heading_security">
<span class="hidden-anchor sr-only" id="security"></span>6. Security</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="heading__preliminary_considerations">
<span class="hidden-anchor sr-only" id="_preliminary_considerations"></span>6.1. Preliminary considerations</h3>
<div class="paragraph"><p>Security is an important criterion for any software, and monitoring is no exception.
Since the monitoring agent is installed on every monitored server, a security problem here would have particularly serious consequences.</p></div>
<div class="paragraph"><p>This is why security was emphasized in the design of Checkmk and has been an absolute principle since the earliest days of Checkmk:
<em>The agent does not read data from the network. Period.</em>
This means that it is impossible for an attacker to inject any commands or script components via the monitoring port 6556.</p></div>
</div>
<div class="sect2">
<h3 id="heading_security_tls">
<span class="hidden-anchor sr-only" id="security_tls"></span>6.2. Transport Layer Security (TLS)</h3>
<div class="paragraph"><p>For an attacker, however, even a process list can be a first approach for drawing conclusions about worthwhile targets.
Therefore, transport encryption between agent and Checkmk server with Transport Layer Security (TLS) is mandatory from Checkmk version <span class="new">2.1.0</span>.
Here, the Checkmk server 'pings' the monitored host, which then establishes the TLS connection to the Checkmk server and transmits the agent output over it.
Since only Checkmk servers with which a trust relationship exists can initiate this data transfer, there is no risk of data falling into the wrong hands.</p></div>
<div class="paragraph"><p>To secure the TLS connection, Checkmk uses a self-signed certificate that is automatically replaced shortly before its validity expires.
The Agent Controller takes care of renewing the certificate in time before it expires.
Only agents that have been inactive for a longer period of time, i.e., without a running Agent Controller, can lose their registration upon expiration and must then be registered again.
The lifetime of the certificate can be specified via the <span class="guihint">Agent Certificates &gt; Lifetime of certificates</span> global setting.</p></div>
</div>
<div class="sect2">
<h3 id="heading__restricting_access_via_ip_addresses">
<span class="hidden-anchor sr-only" id="_restricting_access_via_ip_addresses"></span>6.3. Restricting access via IP addresses</h3>
<div class="paragraph"><p>Since only authorized Checkmk servers can retrieve data and unauthorized servers fail after a few bytes of handshake, the risk of a <em>Denial of Service (DoS)</em> attack is very low.
For this reason, no further access restriction is currently planned.
Of course you can block port 6556 against unauthorized access via <code>iptables</code>.
Any rule that may exist and which has been transferred to clients via the Agent Bakery to restrict access to certain IP addresses is ignored by the Agent Controller.</p></div>
</div>
<div class="sect2">
<h3 id="heading__disabling_built_in_encryption">
<span class="hidden-anchor sr-only" id="_disabling_built_in_encryption"></span>6.4. Disabling built-in encryption</h3>
<div class="paragraph"><p>Especially when updating the agent, it may be that the <a href="agent_linux_legacy.html#encryption">built-in (symmetric) encryption</a> is active, which is performed by the agent script itself.
If TLS encryption and built-in encryption are active at the same time, then the entropy of the transmitted data is so high that compression, which is active from version <span class="new">2.1.0</span> onwards, will not save any transmitted data — and will burden the CPUs of both the host and the Checkmk server with additional encryption and decryption processes.</p></div>
<div class="paragraph"><p>For this reason, you should deactivate the built-in encryption promptly after switching to TLS.</p></div>
<div class="paragraph"><p>In the first step, deactivate the encryption in the existing rule under <span class="guihint">Setup &gt; Agents &gt; Access to agents &gt; Checkmk agent &gt; Symmetric encryption (Linux, Windows)</span>.</p></div>
<div class="paragraph"><p>In the second step, rename the <code>/etc/check_mk/encryption.cfg</code> configuration file on the agent’s host.</p></div>
<div class="paragraph"><p>In the third and last step, use the <span class="guihint">Enforce agent data encryption</span> rule to specify that the Checkmk server only accepts data encrypted via TLS.
To do this, select the <span class="guihint">Accept TLS encrypted connections only</span> value in the rule.</p></div>
<div class="paragraph"><p><span class="image-inline"><img src="../images/CEE.svg" alt="CEE" class="icon-left"></span>
Turning off encryption with the Agent Bakery proceeds like this:
With the first step, changing the <span class="guihint">Symmetric encryption (Linux, Windows)</span> rule, you are almost done.
You only need to package and distribute new agents.
The configuration file <code>/etc/check_mk/encryption.cfg</code> will be automatically changed for you and included in the agent packages.
All that remains is the third step, i.e. modifying the <span class="guihint">Enforce agent data encryption</span> rule.</p></div>
<div class="paragraph"><p>Following the next automatic agent update, the encryption of the agent script is disabled, but encryption is guaranteed by the Agent Controller.
Note that after the automatic agent update, only registered hosts will be able to provide monitoring data.</p></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="heading_disabled_sections">
<span class="hidden-anchor sr-only" id="disabled_sections"></span>7. Disabling sections</h2>
<div class="sectionbody">
<div class="paragraph"><p>The output from the Checkmk agent is divided into sections.
Each of these sections contains related information and is usually simply the output of a diagnostic command.
Sections always start with a section header.
This is a line enclosed in <code>&lt;&lt;&lt;</code> and <code>&gt;&gt;&gt;</code>.</p></div>
<div class="paragraph"><p>Except for Checkmk’s own sections, you can individually disable any of the 30+ sections that the agent generates by default.
Specifically, this means that the corresponding commands will just not be executed by the agent, possibly saving computation time.
Other reasons for disabling could be that you are simply not interested in certain information from a certain group of hosts, or that a certain host is providing erroneous values and you want to temporarily suspend retrieval of that data.</p></div>
<div class="paragraph"><p>As a user of one of the commercial editions you can simply create a rule via <span class="guihint">Setup &gt; Agents &gt; Windows, Linux, Solaris, AIX &gt; Agent rules &gt; Disabled sections (Linux agent)</span>, this rule will then be taken into account by the <a href="glossar.html#agent_bakery">Agent Bakery</a>.</p></div>
<div class="imageblock">
<div class="content"><img src="../images/agent_linux_disabled_sections.png" alt="List of agent rules for the Linux agent."></div>
<div class="title">In the commercial editions you can disable sections by rule</div>
</div>
<div class="paragraph"><p>You will generally find a separate checkbox for each section that can be disabled.
For each selected checkbox you will then find — after the newly packaged agent has been installed on the selected hosts — a separate entry in the Agent Bakery configuration file <code>/etc/check_mk/exclude_sections.cfg</code>.
For example, if you were to select <code>Running processes</code> and <code>Systemd services</code>, the appropriate configuration file would look like the following:</p></div>
<div class="listingblock">
<div class="title">/etc/check_mk/exclude_sections.cfg</div>
<div class="content"><pre class="pygments highlight"><code><span></span>MK_SKIP_PS=yes
MK_SKIP_SYSTEMD=yes</code></pre></div>
</div>
<div class="paragraph"><p>Users of <span class="image-inline"><img src="../images/icons/CRE.png" alt="CRE" width="20" title="Checkmk Raw"></span> <strong>Checkmk Raw</strong> can manually create the above <code>/etc/check_mk/exclude_sections.cfg</code> file and there enter the sections that should be disabled.
All sections that can be disabled are listed in the <code>~/share/check_mk/agents/cfg_examples/exclude_sections.cfg</code> file.</p></div>
</div>
</div>
<div class="sect1">
<h2 id="heading_plugins">
<span class="hidden-anchor sr-only" id="plugins"></span>8. Extending the agent with plug-ins</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="heading__what_are_agent_plug_ins">
<span class="hidden-anchor sr-only" id="_what_are_agent_plug_ins"></span>8.1. What are agent plug-ins?</h3>
<div class="paragraph"><p>The <code>/usr/bin/check_mk_agent</code> agent script contains a whole set of sections which provide monitoring data for various check plug-ins which are then automatically found by the service discovery.
This includes all of the important monitoring for the operating system.</p></div>
<div class="paragraph"><p>In addition, there is the possibility of extending the agent with <em>agent plug-ins</em>.
These are small scripts or programs that are called by the agent and extend it with additional sections containing additional monitoring data.
The Checkmk project delivers a whole series of such plug-ins, which — if they are correctly installed and configured — automatically deliver new services through a service discovery.</p></div>
<div class="paragraph"><p>Why aren’t these plug-ins simply hard-coded into the agent?
For each of the plug-ins there will be one of the following reasons:</p></div>
<div class="ulist"><ul>
<li><p>The plug-in is written in a programming language other than shell and therefore cannot be implemented inline (example: <code>mk_logwatch</code>).</p></li>
<li><p>The plug-in in any case needs a configuration, without which it would not work (example: <code>mk_oracle</code>).</p></li>
<li><p>The plug-in is so specialized that very few users would need it (example: <code>plesk_domains</code>).</p></li>
</ul></div>
</div>
<div class="sect2">
<h3 id="heading_manualplugins">
<span class="hidden-anchor sr-only" id="manualplugins"></span>8.2. Manual installation</h3>
<div class="paragraph"><p>The plug-ins included with Linux and Unix can all be found on the Checkmk server in <code>~/share/check_mk/agents/plugins</code>.</p></div>
<div class="paragraph"><p>They are also available from the agents download page in the Setup menu (as described in the <a href="#download_gui">installation</a> chapter) in the <span class="guihint">Plugins</span> box:</p></div>
<div class="imageblock">
<div class="content"><img src="../images/agent_linux_files_agent_plugins.png" alt="Download page with agent plug-ins."></div>
<div class="title">The beginning of the long list of available agent plug-ins</div>
</div>
<div class="paragraph"><p>For all of the agent plug-ins we provide, there are matching check plug-ins that can evaluate the agent’s data and create services.
These are already installed, so that newly found services can be detected and configured immediately.</p></div>
<div class="paragraph"><p><strong>Note:</strong> Before you install a plug-in on a host, take a look at its corresponding file.
Often you will find important information there about the correct use of the plug-in.</p></div>
<div class="paragraph"><p>The actual installation is then simple:
Copy the file to <code>/usr/lib/check_mk_agent/plugins</code>.
Make sure that it is executable.
If not, use a <code>chmod 755</code>, otherwise the agent will not execute the plug-in.
Note that especially if you do not transfer the files via <code>scp</code> but fetch them via HTTP from the download page, the execution permission will be lost.</p></div>
<div class="paragraph"><p>Once the plug-in is executable and located in the correct directory, it will be automatically invoked by the agent and a new section will be created in the agent output.
This section usually has the same name as the plug-in.
Complex plug-ins, such as <code>mk_oracle</code> for example, even create a whole series of new sections.</p></div>
</div>
<div class="sect2">
<h3 id="heading_pluginconfig">
<span class="hidden-anchor sr-only" id="pluginconfig"></span>8.3. Configuration</h3>
<div class="paragraph"><p>Some plug-ins will require a configuration file in <code>/etc/check_mk/</code> in order to work.
For others, a configuration is optional and enables special features or customizations.
Still others will work simply as they are.
There are several sources of information on a plug-in:</p></div>
<div class="ulist"><ul>
<li><p>The documentation for the associated check plug-ins in your Checkmk site, which you can access via <span class="guihint">Setup &gt; Services &gt; Catalog of check plugins</span>.</p></li>
<li><p>Comments in the plug-in itself (often very helpful!).</p></li>
<li><p>A suitable article in this manual, on monitoring <a href="monitoring_oracle.html">Oracle</a> for example.</p></li>
</ul></div>
</div>
<div class="sect2">
<h3 id="heading_async_plugins">
<span class="hidden-anchor sr-only" id="async_plugins"></span>8.4. Asynchronous execution</h3>
<div class="paragraph"><p>Just as with <a href="#mrpe">MRPE</a>, you can also run plug-ins asynchronously.
This is very useful if the plug-ins have a long runtime and the obtained status data does not need to be regenerated every minute anyway.</p></div>
<div class="paragraph"><p>Asynchronous execution is not configured via a file, instead you create a subdirectory within <code>/usr/lib/check_mk_agent/plugins</code> whose name is a number: a number of seconds.
Plug-ins in this directory are not only executed asynchronously, but at the same time you specify a minimum waiting time with the number of seconds before the plug-in should be executed again.
If the agent is queried again before the time expires, it uses cached data from the last time the plug-in was executed.
This allows you to configure a longer interval for the plug-in than the typical one minute.</p></div>
<div class="paragraph"><p>The following example shows how to change the <code>my_foo_plugin</code> plug-in from synchronous execution to asynchronous execution with an interval of 5 minutes (or 300 seconds):</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="console"><span></span><span class="tok-gp">root@linux# </span><span class="tok-nb">cd</span><span class="tok-w"> </span>/usr/lib/check_mk_agent/plugins
<span class="tok-gp">root@linux# </span>mkdir<span class="tok-w"> </span><span class="tok-m">300</span>
<span class="tok-gp">root@linux# </span>mv<span class="tok-w"> </span>my_foo_plugin<span class="tok-w"> </span><span class="tok-m">300</span></code></pre></div></div>
<div class="paragraph"><p><strong>Note:</strong> Some plug-ins automatically implement asynchronous execution.
This includes <code>mk_oracle</code>.
Install such plug-ins directly to <code>/usr/lib/check_mk_agent/plugins</code>.</p></div>
</div>
<div class="sect2">
<h3 id="heading_install_plugins_using_bakery">
<span class="hidden-anchor sr-only" id="install_plugins_using_bakery"></span>8.5. Installation using the Agent Bakery</h3>
<div class="paragraph"><p><span class="image-inline"><img src="../images/CEE.svg" alt="CEE" class="icon-left"></span>
In the commercial editions, the included plug-ins can be configured via the <a href="glossar.html#agent_bakery">Agent Bakery</a>.
This takes care of both the installation of the actual plug-in  and the correct creation of its configuration file, should one be needed.</p></div>
<div class="paragraph"><p>Each plug-in is configured via an agent rule.
You can find the appropriate rule sets in <span class="guihint">Setup &gt; Agents &gt; Windows, Linux, Solaris, AIX &gt; Agent rules &gt; Agent Plugins</span>:</p></div>
<div class="imageblock">
<div class="content"><img src="../images/agent_linux_rules_agent_plugins.png" alt="Page with rules for configuring agent plug-ins in the commercial editions."></div>
<div class="title">List of rules for the commercial editions agent plug-ins</div>
</div>
</div>
<div class="sect2">
<h3 id="heading__manual_execution">
<span class="hidden-anchor sr-only" id="_manual_execution"></span>8.6. Manual execution</h3>
<div class="paragraph"><p>Since agent plug-ins are executable programs, you can also run them manually for testing and diagnostic purposes.
However, there are plug-ins that need certain environment variables set by the agent to find their configuration file, for example.
Set these variables manually before execution:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="console"><span></span><span class="tok-gp">root@linux# </span><span class="tok-nb">export</span><span class="tok-w"> </span><span class="tok-nv">MK_LIBDIR</span><span class="tok-o">=</span>/usr/lib/check_mk_agent
<span class="tok-gp">root@linux# </span><span class="tok-nb">export</span><span class="tok-w"> </span><span class="tok-nv">MK_CONFDIR</span><span class="tok-o">=</span>/etc/check_mk
<span class="tok-gp">root@linux# </span><span class="tok-nb">export</span><span class="tok-w"> </span><span class="tok-nv">MK_VARDIR</span><span class="tok-o">=</span>/var/lib/check_mk_agent
<span class="tok-gp">root@linux# </span>/usr/lib/check_mk_agent/plugins/mk_foobar
<span class="tok-go">&lt;&lt;&lt;foobar&gt;&gt;&gt;</span>
<span class="tok-go">FOO BAR BLA BLUBB 17 47 11</span></code></pre></div></div>
<div class="paragraph"><p>Some plug-ins also use special call options for debugging.
Simply take a look at the plug-in file.</p></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="heading_e2e_monitoring">
<span class="hidden-anchor sr-only" id="e2e_monitoring"></span>9. Integrating Legacy Nagios check plug-ins</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="heading_mrpe">
<span class="hidden-anchor sr-only" id="mrpe"></span>9.1. Running plug-ins via MRPE</h3>
<div class="paragraph"><p>There are two good reasons to continue using Nagios plug-ins on Checkmk.
If you have migrated your monitoring from a Nagios based solution to Checkmk, you can continue to use older check plug-ins for which there is no Checkmk equivalent yet.
In many cases these are self-written plug-ins in Perl or shell.</p></div>
<div class="paragraph"><p>The second reason is true end-to-end monitoring.
Let’s assume you have your Checkmk server, a web server and a database server distributed over a large data center.
In such a case, the database server response times measured from the Checkmk server are not very meaningful.
It is far more important to know these values for the connection between the web server and the database server.</p></div>
<div class="paragraph"><p>The Checkmk agent provides a simple mechanism to meet these two requirements:
<em>MK’s Remote Plugin Executor</em> or <em>MRPE</em> for short.
The name is deliberately an analogy to the <em>NRPE</em> of Nagios, which performs the same task there.</p></div>
<div class="paragraph"><p>The MRPE is built into the agent and is configured with a simple text file, which you create as <code>/etc/check_mk/mrpe.cfg</code>.
There you specify one plug-in call per line — along with the name you want Checkmk to use for the service it automatically creates for it.
Here is an example:</p></div>
<div class="listingblock">
<div class="title">/etc/check_mk/mrpe.cfg</div>
<div class="content"><pre class="pygments highlight"><code><span></span>Foo_Application /usr/local/bin/check_foo -w 60 -c 80
Bar_Extender /usr/local/bin/check_bar -s -X -w 4:5</code></pre></div>
</div>
<div class="paragraph"><p><strong>Note:</strong> The Nagios plugins may not be placed in the directory <code>/usr/lib/check_mk_agent/plugins</code>.
This directory is reserved for the <a href="#plugins">agent plug-ins</a>.
Apart from this directory, you are free to choose as long as the agent can find and run the plugins there.</p></div>
<div class="paragraph"><p>If you now run the agent locally, you will find a new section for each plug-in called <code>&lt;&lt;mrpe&gt;&gt;</code> which contains the name, exit code and output from the plug-in.
You can check this with the following handy <code>grep</code> command:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="console"><span></span><span class="tok-gp">root@linux# </span>check_mk_agent<span class="tok-w"> </span><span class="tok-p">|</span><span class="tok-w"> </span>grep<span class="tok-w"> </span>-A1<span class="tok-w"> </span><span class="tok-s1">'^...mrpe'</span>
<span class="tok-go">&lt;&lt;&lt;mrpe&gt;&gt;&gt;</span>
<span class="tok-gp tok-gp-VirtualEnv">(check_foo)</span> <span class="tok-go">Foo_Application 0 OK - Foo server up and running</span>
<span class="tok-go">&lt;&lt;&lt;mrpe&gt;&gt;&gt;</span>
<span class="tok-gp tok-gp-VirtualEnv">(check_bar)</span> <span class="tok-go">Bar_Extender 1 WARN - Bar extender overload 6.012|bar_load=6.012</span></code></pre></div></div>
<div class="paragraph"><p>The <code>0</code> and <code>1</code> in the output stand for the exit codes of the plug-ins and follow the conventional scheme:
<code>0</code> = <span class="state0">OK</span>, <code>1</code> = <span class="state1">WARN</span>, <code>2</code> = <span class="state2">CRIT</span> and <code>3</code> = <span class="state3">UNKNOWN</span>.</p></div>
<div class="paragraph"><p>The rest will now be done automatically by Checkmk.
Once you invoke a service discovery for the host, the two new services will show up as <a href="wato_services.html#available">available</a>.
It will look like this:</p></div>
<div class="imageblock">
<div class="content"><img src="../images/agent_linux_mrpe_checks.png" alt="List of detected services for the plug-ins set up via MRPE."></div>
<div class="title">One service is detected for each of the two MRPE plug-ins</div>
</div>
<div class="paragraph"><p>By the way, due to the syntax of the file, the name cannot contain spaces.
However, you can replace a space with <code>%20</code> using the same syntax as in URLs (ASCII code 32 for space is hexadecimal 20):</p></div>
<div class="listingblock">
<div class="title">/etc/check_mk/mrpe.cfg</div>
<div class="content"><pre class="pygments highlight"><code><span></span>Foo%20Application /usr/local/bin/check_foo -w 60 -c 80
Bar%20Extender /usr/local/bin/check_bar -s -X -w 4:5</code></pre></div>
</div>
</div>
<div class="sect2">
<h3 id="heading__asynchronous_execution">
<span class="hidden-anchor sr-only" id="_asynchronous_execution"></span>9.2. Asynchronous execution</h3>
<div class="paragraph"><p>Note that all plug-ins you list in <code>mrpe.cfg</code> will be executed synchronously in order.
For this reason, the plug-ins should not have a too long execution time.
If one plug-in needs too long, the execution of all others will be delayed.
This can lead to the complete execution of the agent script running into a timeout and preventing the host from being reliably monitored.</p></div>
<div class="paragraph"><p>If you really need longer running plug-ins, you should switch them to asynchronous execution and thus avoid such problems.
This can be achieved by specifying a time in seconds during which a calculated result should remain valid.
To configure a timeout of five minutes, set the expression <code>(interval=300)</code> after the service name in <code>mrpe.cfg</code>:</p></div>
<div class="listingblock">
<div class="title">/etc/check_mk/mrpe.cfg</div>
<div class="content"><pre class="pygments highlight"><code><span></span>Foo_Application (interval=300) /usr/local/bin/check_foo -w 60 -c 80
Bar_Extender /usr/local/bin/check_bar -s -X -w 4:5</code></pre></div>
</div>
<div class="paragraph"><p>This facility has several benefits:</p></div>
<div class="ulist"><ul>
<li><p>The plug-in will run in a background process and will no longer slow down the execution of the agent.</p></li>
<li><p>Because the agent does not wait for execution, the result is not delivered until the <em>next</em> call of the agent.</p></li>
<li><p>At the earliest after 300 seconds the plug-in will be executed again.
Until then, the old result is reused.</p></li>
</ul></div>
<div class="paragraph"><p>So this allows you to run tests that need a bit more computing time as well as over longer intervals, without having to configure anything on the Checkmk server.</p></div>
</div>
<div class="sect2">
<h3 id="heading__mrpe_with_the_agent_bakery">
<span class="hidden-anchor sr-only" id="_mrpe_with_the_agent_bakery"></span>9.3. MRPE with the Agent Bakery</h3>
<div class="paragraph"><p><span class="image-inline"><img src="../images/CEE.svg" alt="CEE" class="icon-left"></span>
Users of the commercial editions can also configure MRPE with the <a href="glossar.html#agent_bakery">Agent Bakery</a>.
Responsible for this is the rule set <span class="guihint">Setup &gt; Agents &gt; Windows, Linux Solaris, AIX &gt; Agent Rules &gt; Generic Options &gt; Execute MRPE checks</span>.
There you can configure the same things as described above.
The file <code>mrpe.cfg</code> will then be generated automatically by the Agent Bakery.</p></div>
<div class="imageblock">
<div class="content"><img src="../images/agent_linux_mrpe_rule.png" alt="Rule for MRPE configuration in the Agent Bakery."></div>
<div class="title">MRPEs can be conveniently configured using a rule in the commercial editions</div>
</div>
<div class="sect3">
<h4 id="heading__baking_the_plug_ins">
<span class="hidden-anchor sr-only" id="_baking_the_plug_ins"></span>Baking the plug-ins</h4>
<div class="paragraph"><p>You can also have the check plug-ins included in the package being delivered.
With this, the agent is then complete and does not need any manual installation of additional files.
The whole thing works like this:</p></div>
<div class="olist arabic"><ol class="arabic">
<li><p>Create the directory <code>local/share/check_mk/agents/custom</code> on the Checkmk server.</p></li>
<li><p>Create a subdirectory there — e.g. <code>my_mrpe_plugins</code>.</p></li>
<li><p>Again, create the subdirectory <code>bin</code> in it.</p></li>
<li><p>Copy your plug-ins into the <code>bin</code> folder.</p></li>
<li><p>Create a rule in <span class="guihint">Setup &gt; Agents &gt; Windows, Linux, Solaris, AIX &gt; Agent rules &gt; Generic Options &gt; Deploy custom files with agent</span> .</p></li>
<li><p>Select <code>my_mrpe_plugins</code>, save the changed settings and press the button <span class="guihint">Bake</span>!</p></li>
</ol></div>
<div class="paragraph"><p>The check plug-ins will now be installed into the default <code>bin</code> directory of your agent.
By default this is <code>/usr/bin</code>.
So when configuring the MRPE checks, use <code>/usr/bin/check_foo</code> instead of <code>/usr/local/bin/check_foo</code>.</p></div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="heading_hw_monitoring">
<span class="hidden-anchor sr-only" id="hw_monitoring"></span>10. Monitoring hardware</h2>
<div class="sectionbody">
<div class="paragraph"><p>Monitoring a Linux server as completely as possible of course also includes monitoring its hardware.
The monitoring is done partly using the Checkmk agent directly, and partly via special <a href="#plugins">plug-ins</a>.
In addition, there are still cases where you can implement monitoring via SNMP or even via a separate management board.</p></div>
<div class="sect2">
<h3 id="heading__monitoring_smart_values">
<span class="hidden-anchor sr-only" id="_monitoring_smart_values"></span>10.1. Monitoring SMART values</h3>
<div class="paragraph"><p>Modern hard drives almost always have <em>S.M.A.R.T.</em> (Self-Monitoring, Analysis and Reporting Technology).
This system continuously records data on the state of the HDD or SSD and Checkmk can retrieve these values with the <code>smart</code> plug-in and evaluate the most important of them.
For the plug-in to work after installation, the following requirements must be met:</p></div>
<div class="ulist"><ul>
<li><p>The <code>smartmontools</code> package must be installed. You can install this on all modern distributions via the respective package manager.</p></li>
<li><p>If the hard disks are connected to a RAID controller and this allows access to the SMART values, the respective tool must also be installed. Supported are <code>tw_cli</code> (3ware) and <code>megacli</code> (LSI).</p></li>
</ul></div>
<div class="paragraph"><p>If these requirements are met and the plug-in is installed, the data is automatically retrieved and appended to the agent’s output.
In Checkmk you can then also activate the <a href="wato_services.html#available">new services</a> directly:</p></div>
<div class="imageblock">
<div class="content"><img src="../images/agent_linux_smart_stats.png" alt="List of SMART services found in service discovery."></div>
<div class="title">SMART services found by service discovery</div>
</div>
<div class="paragraph"><p>As seen in the screenshot, if <code>cmd_timeout</code> occasionally occurs, switch the plug-in to asynchronous execution at intervals of a few minutes.</p></div>
</div>
<div class="sect2">
<h3 id="heading__monitoring_by_means_of_ipmi">
<span class="hidden-anchor sr-only" id="_monitoring_by_means_of_ipmi"></span>10.2. Monitoring by means of IPMI</h3>
<div class="paragraph"><p>IPMI (Intelligent Platform Management Interface) is an interface for hardware management which also enables monitoring of the hardware.
Checkmk uses <code>freeipmi</code> for this purpose to access the hardware directly and without a network.
<code>freeipmi</code> is installed from the package sources and is then ready for immediate use, so that the data will be transmitted the very next time Checkmk is called.</p></div>
<div class="paragraph"><p>If <code>freeipmi</code> is not available or there are other reasons not to install it, <code>ipmitool</code> can also be used.
<code>ipmitool</code> is often already present on the system and only needs to be supplied with an IPMI device driver, such as that provided by the <code>openipmi</code> package.
Again, you do not need to do anything else after an installation, and the data will be collected automatically by Checkmk.</p></div>
<div class="paragraph"><p>For error diagnosis you can also run the tools manually in a host shell.
Once you have installed the <code>freeipmi</code> package, you can check its functions with this:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="console"><span></span><span class="tok-gp">root@linux# </span>ipmi-sensors<span class="tok-w"> </span>Temperature
<span class="tok-go">32 Temperature_Ambient 20.00_C_(1.00/42.00) [OK]</span>
<span class="tok-go">96 Temperature_Systemboard 23.00_C_(1.00/65.00) [OK]</span>
<span class="tok-go">160 Temperature_CPU_1 31.00_C_(1.00/90.00) [OK]</span>
<span class="tok-go">224 Temperature_CPU_2 NA(1.00/78.00) [Unknown]</span>
<span class="tok-go">288 Temperature_DIMM-1A 54.00_C_(NA/115.00) [OK]</span>
<span class="tok-go">352 Temperature_DIMM-1B 56.00_C_(NA/115.00) [OK]</span>
<span class="tok-go">416 Temperature_DIMM-2A NA(NA/115.00) [Unknown]</span>
<span class="tok-go">480 Temperature_DIMM-2B NA(NA/115.00) [Unknown]</span></code></pre></div></div>
<div class="paragraph"><p>If <code>ipmitool</code> has been installed, you can check the output of its data with the following command:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="console"><span></span><span class="tok-gp">root@linux# </span>ipmitool<span class="tok-w"> </span>sensor<span class="tok-w"> </span>list
<span class="tok-go">UID_Light 0.000 unspecified ok na na 0.000 na na na</span>
<span class="tok-go">Int._Health_LED 0.000 unspecified ok na na 0.000 na na na</span>
<span class="tok-go">Ext._Health_LED 0.000 unspecified ok na na 0.000 na na na</span>
<span class="tok-go">Power_Supply_1 0.000 unspecified nc na na 0.000 na na na</span>
<span class="tok-go">Fan_Block_1 34.888 unspecified nc na na 75.264 na na na</span>
<span class="tok-go">Fan_Block_2 29.792 unspecified nc na na 75.264 na na na</span>
<span class="tok-go">Temp_1 39.000 degrees_C ok na na -64.000 na na na</span>
<span class="tok-go">Temp_2 16.000 degrees_C ok na na -64.000 na na na</span>
<span class="tok-go">Power_Meter 180.000 Watts cr na na 384.00</span></code></pre></div></div>
</div>
<div class="sect2">
<h3 id="heading__manufacturer_specific_tools">
<span class="hidden-anchor sr-only" id="_manufacturer_specific_tools"></span>10.3. Manufacturer-specific tools</h3>
<div class="paragraph"><p>Many large server manufacturers also provide their own tools for collecting the hardware information and making it available via SNMP.
The following prerequisites must be met in order to retrieve this data and provide it to Checkmk:</p></div>
<div class="ulist"><ul>
<li><p>An SNMP server is set up on the Linux host.</p></li>
<li><p>The manufacturer’s tool is installed (e.g. Dell’s <em>OpenManage</em> or Supermicro’s <em>SuperDoctor</em>).</p></li>
<li><p>The host is configured in Checkmk for monitoring via SNMP <strong>in addition</strong> to the Checkmk agent.
See the article on <a href="snmp.html#snmp_cmk_agent">monitoring with SNMP</a> to learn how to do this.</p></li>
</ul></div>
<div class="paragraph"><p>The new services for hardware monitoring supported by this are then automatically detected and no further plug-ins are required.</p></div>
</div>
<div class="sect2">
<h3 id="heading__additional_monitoring_via_the_management_board">
<span class="hidden-anchor sr-only" id="_additional_monitoring_via_the_management_board"></span>10.4. Additional monitoring via the management board</h3>
<div class="paragraph"><p>A management board can be configured for each host and additional data can be retrieved via SNMP.
The services detected in this way are then also assigned to the host.</p></div>
<div class="paragraph"><p>Setting up the management board is very simple.
Simply enter the protocol, the IP address and the access data for SNMP in the host’s properties and save these new settings:</p></div>
<div class="imageblock">
<div class="content"><img src="../images/agent_linux_snmp_management_board.png" alt="The configuration of the management board for SNMP in the properties of the host."></div>
<div class="title">The management board is configured for SNMP in the properties of the host in the Setup</div>
</div>
<div class="paragraph"><p>With a service discovery, the newly discovered services will then be then enabled as usual.</p></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="heading_uninstall">
<span class="hidden-anchor sr-only" id="uninstall"></span>11. Uninstallation</h2>
<div class="sectionbody">
<div class="paragraph"><p>As with an <a href="#install">installation</a>, uninstalling the agent is also done using the operating system’s package manager.
Specify the name of the installed package here, not the filename of the original RPM/DEB file.</p></div>
<div class="paragraph"><p>This is how you find out which DEB package is installed:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="console"><span></span><span class="tok-gp">root@linux# </span>dpkg<span class="tok-w"> </span>-l<span class="tok-w"> </span><span class="tok-p">|</span><span class="tok-w"> </span>grep<span class="tok-w"> </span>check-mk-agent
<span class="tok-go">ii  check-mk-agent          2.3.0p16-1          all          Checkmk Agent for Linux</span></code></pre></div></div>
<div class="paragraph"><p>The uninstallation of the DEB package is then done using <code>dpkg --purge</code>:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="console"><span></span><span class="tok-gp">root@linux# </span>dpkg<span class="tok-w"> </span>--purge<span class="tok-w"> </span>check-mk-agent
<span class="tok-gp tok-gp-VirtualEnv">(Reading database ... 739951 files and directories currently installed.)</span>
<span class="tok-go">Removing check-mk-agent (2.3.0p16-1) ...</span>
<span class="tok-go">Removing systemd units: check-mk-agent.socket, check-mk-agent-async.service, cmk-agent-ctl-daemon.service, check-mk-agent@.service</span>
<span class="tok-go">Deactivating systemd unit 'check-mk-agent.socket'...</span>
<span class="tok-go">Deactivating systemd unit 'check-mk-agent-async.service'...</span>
<span class="tok-go">Deactivating systemd unit 'cmk-agent-ctl-daemon.service'...</span>
<span class="tok-go">Reloading xinetd</span>
<span class="tok-go">Purging configuration files for check-mk-agent (2.3.0p16-1) ...</span></code></pre></div></div>
<div class="paragraph"><p>How to find out which RPM package is installed:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="console"><span></span><span class="tok-gp">root@linux# </span>rpm<span class="tok-w"> </span>-qa<span class="tok-w"> </span><span class="tok-p">|</span><span class="tok-w"> </span>grep<span class="tok-w"> </span>check-mk</code></pre></div></div>
<div class="paragraph"><p>Uninstallation of the RPM package is done as <code>root</code> with the command <code>rpm -e</code>.</p></div>
<div class="sect2">
<h3 id="heading_reenable_legacy_pull">
<span class="hidden-anchor sr-only" id="reenable_legacy_pull"></span>11.1. Re-enabling legacy pull mode</h3>
<div class="paragraph"><p>When the agent is uninstalled, the <code>cmk-agent</code> user created by the install script will be preserved.
This serves as an indicator to the post-install script that the agent was already installed on this system.
If this is the case, no legacy pull mode will be activated during a subsequent reinstall.
As a result, after running <code>cmk-agent-ctl delete-all</code> and later reinstalling the agent, no connection will be possible on port 6556.</p></div>
<div class="paragraph"><p>If it is desired to re-enable the unencrypted legacy pull mode, for example, to allow communication of a <span class="new">2.0.0</span> site with a <span class="new">2.2.0</span> agent, you will have to explicitly <a href="#deregister">enable this mode</a>.</p></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="heading_files">
<span class="hidden-anchor sr-only" id="files"></span>12. Files and directories</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="heading__paths_on_the_monitored_host">
<span class="hidden-anchor sr-only" id="_paths_on_the_monitored_host"></span>12.1. Paths on the monitored host</h3>
<table class="table-responsive table-bordered table tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 45%;">
<col style="width: 55%;">
</colgroup>
<thead><tr>
<th class="tableblock halign-left valign-top">Path</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr></thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>/usr/bin/</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Installation directory for the agent script <code>check_mk_agent</code> and the Agent Controller <code>cmk-agent-ctl</code> on the target system.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>/usr/lib/check_mk_agent</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Base directory for extensions to the agent.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>/usr/lib/check_mk_agent/plugins</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Directory for plug-ins which should be automatically executed by the agent and extend its output with additional monitoring data. Plug-ins can be written in any available programming language.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>/usr/lib/check_mk_agent/local</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Directory for custom <a href="localchecks.html">local checks</a>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>/var/lib/check_mk_agent</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Base directory for agent data.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>/var/lib/check_mk_agent/cache</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Here cache data of individual sections is stored and appended back to the agent on each execution as long as the cache data is valid.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>/var/lib/check_mk_agent/job</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Directory for monitored jobs. These will be appended to the agent output on each execution.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>/var/lib/check_mk_agent/spool</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Contains data created e.g. by log files which have their own section. These are also appended to the agent output. You can read more about this in the article <a href="spool_directory.html">The spool directory</a>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>/var/lib/cmk-agent/registered_connections.json</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Contains a list of connections registered with the Agent Controller.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>/var/lib/cmk-agent/pre_configured_connections.json</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Contains a pre-configured connection to a site for the <a href="hosts_autoregister.html">auto-registration</a>, integrated into the agent package via Agent Bakery.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>/etc/check_mk</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Storage of configuration files for the agent.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>/etc/check_mk/mrpe.cfg</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Configuration file for <a href="#mrpe">MRPE</a> — for running Legacy Nagios compatible check plug-ins.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>/etc/check_mk/encryption.cfg</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Configuration for <a href="agent_linux_legacy.html#encryption">built-in encryption</a> of agent data.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>/etc/check_mk/exclude_sections.cfg</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Configuration file for the <a href="#disabled_sections">disabling certain sections</a> of the agent.</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect2">
<h3 id="heading__paths_on_the_checkmk_server">
<span class="hidden-anchor sr-only" id="_paths_on_the_checkmk_server"></span>12.2. Paths on the Checkmk server</h3>
<table class="table-responsive table-bordered table tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 45%;">
<col style="width: 55%;">
</colgroup>
<thead><tr>
<th class="tableblock halign-left valign-top">Path</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr></thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>~/local/share/check_mk/agents/custom</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Base directory for custom files to be delivered with a baked agent.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>~/share/check_mk/agents/cfg_examples/exclude_sections.cfg</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Example configuration file for disabling sections.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>~/var/agent-receiver/received-outputs</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Contains for each connection its UUID as a soft link pointing to the folder with the name of the host. In push mode, this folder contains the agent output.</p></td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
</div></main><div id="toc" class="toc2">
<div id="toctitle">On this page</div>
<ul class="sectlevel1">
<li><a href="#intro">1. The Linux agent</a></li>
<li><a href="#agent_architecture">2. Architecture of the agent</a></li>
<li>
<a href="#install">3. Installation</a><ul class="sectlevel1">
<li>
<a href="#download">3.1. Downloading RPM/DEB packages</a><ul class="sectlevel2">
<li><a href="#download_gui">Getting a package via Checkmk GUI</a></li>
<li><a href="#_getting_a_package_via_http">Getting a package via HTTP</a></li>
<li><a href="#_getting_a_package_via_the_rest_api">Getting a package via the REST API</a></li>
</ul>
</li>
<li><a href="#install_package">3.2. Package installation</a></li>
<li><a href="#_installation_using_the_agent_bakery">3.3. Installation using the Agent Bakery</a></li>
<li><a href="#_automatic_updates">3.4. Automatic updates</a></li>
<li><a href="#post_install">3.5. What follows after the installation?</a></li>
</ul>
</li>
<li>
<a href="#registration">4. Registration</a><ul class="sectlevel1">
<li>
<a href="#overview">4.1. Overview and prerequisites</a><ul class="sectlevel2">
<li><a href="#_requirements_for_the_host">Requirements for the host</a></li>
<li><a href="#_requirements_for_the_server">Requirements for the server</a></li>
</ul>
</li>
<li><a href="#_adding_a_host_to_the_setup">4.2. Adding a host to the Setup</a></li>
<li><a href="#test_environment">4.3. Testing the Agent Controller and system environment</a></li>
<li><a href="#_registering_a_host_with_the_server">4.4. Registering a host with the server</a></li>
<li><a href="#autoregister">4.5. Registering a host automatically with the server</a></li>
<li><a href="#_verifying_the_trust_relationship">4.6. Verifying the trust relationship</a></li>
<li><a href="#proxyregister">4.7. Registration by proxy</a></li>
<li><a href="#_adding_the_host_to_the_monitoring">4.8. Adding the host to the monitoring</a></li>
<li><a href="#deregister">4.9. Deregistering a host</a></li>
<li><a href="#changepush">4.10. Switching between the push and pull modes</a></li>
</ul>
</li>
<li>
<a href="#test">5. Testing and troubleshooting</a><ul class="sectlevel1">
<li><a href="#script_output">5.1. Output from the agent script</a></li>
<li><a href="#_the_agent_script_in_debug_mode">5.2. The agent script in debug mode</a></li>
<li><a href="#networkrequirements">5.3. Network environment for registration</a></li>
<li><a href="#agent_ctl_dump">5.4. The Agent Controller in dump mode</a></li>
<li><a href="#_remote_connection_test">5.5. Remote connection test</a></li>
<li><a href="#debugpush">5.6. Troubleshooting the agent in push mode</a></li>
<li><a href="#lostconnections">5.7. Connections are being lost</a></li>
<li><a href="#howlong">5.8. Waiting time until changes become visible</a></li>
</ul>
</li>
<li>
<a href="#security">6. Security</a><ul class="sectlevel1">
<li><a href="#_preliminary_considerations">6.1. Preliminary considerations</a></li>
<li><a href="#security_tls">6.2. Transport Layer Security (TLS)</a></li>
<li><a href="#_restricting_access_via_ip_addresses">6.3. Restricting access via IP addresses</a></li>
<li><a href="#_disabling_built_in_encryption">6.4. Disabling built-in encryption</a></li>
</ul>
</li>
<li><a href="#disabled_sections">7. Disabling sections</a></li>
<li>
<a href="#plugins">8. Extending the agent with plug-ins</a><ul class="sectlevel1">
<li><a href="#_what_are_agent_plug_ins">8.1. What are agent plug-ins?</a></li>
<li><a href="#manualplugins">8.2. Manual installation</a></li>
<li><a href="#pluginconfig">8.3. Configuration</a></li>
<li><a href="#async_plugins">8.4. Asynchronous execution</a></li>
<li><a href="#install_plugins_using_bakery">8.5. Installation using the Agent Bakery</a></li>
<li><a href="#_manual_execution">8.6. Manual execution</a></li>
</ul>
</li>
<li>
<a href="#e2e_monitoring">9. Integrating Legacy Nagios check plug-ins</a><ul class="sectlevel1">
<li><a href="#mrpe">9.1. Running plug-ins via MRPE</a></li>
<li><a href="#_asynchronous_execution">9.2. Asynchronous execution</a></li>
<li>
<a href="#_mrpe_with_the_agent_bakery">9.3. MRPE with the Agent Bakery</a><ul class="sectlevel2"><li><a href="#_baking_the_plug_ins">Baking the plug-ins</a></li></ul>
</li>
</ul>
</li>
<li>
<a href="#hw_monitoring">10. Monitoring hardware</a><ul class="sectlevel1">
<li><a href="#_monitoring_smart_values">10.1. Monitoring SMART values</a></li>
<li><a href="#_monitoring_by_means_of_ipmi">10.2. Monitoring by means of IPMI</a></li>
<li><a href="#_manufacturer_specific_tools">10.3. Manufacturer-specific tools</a></li>
<li><a href="#_additional_monitoring_via_the_management_board">10.4. Additional monitoring via the management board</a></li>
</ul>
</li>
<li>
<a href="#uninstall">11. Uninstallation</a><ul class="sectlevel1"><li><a href="#reenable_legacy_pull">11.1. Re-enabling legacy pull mode</a></li></ul>
</li>
<li>
<a href="#files">12. Files and directories</a><ul class="sectlevel1">
<li><a href="#_paths_on_the_monitored_host">12.1. Paths on the monitored host</a></li>
<li><a href="#_paths_on_the_checkmk_server">12.2. Paths on the Checkmk server</a></li>
</ul>
</li>
</ul>
</div>
<script src="../../assets/js/manifest.js?id=7db827d654313dce4250"></script>
<script src="../../assets/js/vendor.js?id=581a3d4a61b7156d04df"></script>
<script src="../../assets/js/app.js?id=959ccd04b1f8b7b78c5e"></script>
<script src="../../assets/js/lunr.js"></script>
<script src="../../assets/js/lunr.stemmer.support.js"></script>
<script src="../lunr.index.en.js"></script>
<script src="../../assets/js/lunr.client.js"></script>
</body>
</html>
