<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="UTF-8">
<!--[if IE]><meta http-equiv="X-UA-Compatible" content="IE=edge"><![endif]--><meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.10">
<link rel="icon" href="/favicon.png">
<meta name="description" content="Here you can find out how to develop agent-based Checkmk plug-ins - with everything that this involves, especially with the newly developed Check API in version 2.0.0.">
<meta name="og:locale" content="en">
<meta name="og:site_name" content="Checkmk Docs">
<meta name="og:title" content="Writing agent-based check plug-ins">
<meta name="og:description" content="Here you can find out how to develop agent-based Checkmk plug-ins - with everything that this involves, especially with the newly developed Check API in version 2.0.0.">
<meta name="og:image" content="https://docs.checkmk.com/assets/images/share_image.png">
<meta name="twitter:site" content="@checkmk">
<meta name="twitter:creator" content="@checkmk">
<title>Writing agent-based check plug-ins</title>
<link rel="stylesheet" href="../../assets/css/checkmk.css?id=4473d2acbb1ea6136428">
<link rel="stylesheet" href="../../assets/css/pygments-monokai.css">
<link rel="stylesheet" href="../../assets/css/addons.css">
<link rel="stylesheet" href="../../assets/css/SourceCodePro.css">
<link rel="search" href="./opensearch.xml" type="application/opensearchdescription+xml" title="Search docs.checkmk.com">
<!-- Google Tag Manager -->
<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
        new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
    j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
    'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-NJ3VGL8');</script>
<!-- End Google Tag Manager --><style>
#staticinfo { font-style: italic; }
</style>
</head>
<body class="article toc2 toc-right">
<!-- Cookie Consent (GDPR Compliance) -->

<!-- End Cookie Consent (GDPR Compliance) -->
<!-- Google Tag Manager (noscript) -->
<noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-NJ3VGL8" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
<!-- End Google Tag Manager (noscript) --><div class="header-top">
<div class="header-top__left">
<a class="header-top__logo d-none d-xl-inline-block" href="/latest/en"><img src="../../assets/images/docs_logo.png" alt="Checkmk"></a><a class="header-top__icon d-inline-block d-xl-none" href="/latest/en"><img src="../../assets/images/logo_icon.svg" alt="Checkmk"></a>
</div>
<div class="header-top__center">
<input type="text" class="header-top__search" placeholder="Search the checkmk docs"><div class="header-top__search__results"></div>
</div>
<div class="header-top__right d-block">
<button class="header-top__search__toggle d-inline-block d-md-none"><img class="header-top__search__toggle__icon" src="../../assets/images/search.svg" alt="Search"></button><div class="dropdown dropdown__language">
                    <button class="btn dropdown-toggle" type="button" id="languageMenuButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">en</button>
                    <div class="dropdown-menu  dropdown-menu-right" aria-labelledby="languageMenuButton"><a class="dropdown-item" href="../../latest/de/devel_check_plugins.html">Deutsch</a></div>
</div>
<div class="dropdown dropdown__branch">
                        <button class="btn dropdown-toggle" type="button" id="branchMenuButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">latest (2.3.0)</button>
                        <div class="dropdown-menu dropdown-menu-right" aria-labelledby="branchMenuButton">
<a class="dropdown-item" href="../../2.1.0/en/devel_check_plugins.html">2.1.0</a><a class="dropdown-item" href="../../2.2.0/en/devel_check_plugins.html">2.2.0</a>
</div>
</div>
<a class="header-top__back d-none d-lg-inline-block" href="https://checkmk.com">to checkmk.com</a><button class="header-top__toggle d-inline-block d-lg-none"><span class="header-top__toggle__icon"></span></button>
</div>
</div>
<aside><div class="main-nav">
<div class="main-nav__content"><div id="content">
<div class="sect1">
<h2 id="_welcome_to_checkmk">
<a class="anchor" href="#_welcome_to_checkmk"></a>1. Welcome to Checkmk</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p><a href="welcome.html">Welcome to the Checkmk User Guide</a></p>
</li>
<li>
<p><a href="release_notes.html">Release notes</a></p>
</li>
<li>
<p><a href="glossar.html">Glossary</a></p>
</li>
<li>
<p><a href="search.html">Searching docs.checkmk.com</a></p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_beginners_guide">
<a class="anchor" href="#_beginners_guide"></a>2. Beginner’s Guide</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p><a href="intro_setup.html">Setting up Checkmk</a></p>
</li>
<li>
<p><a href="intro_gui.html">The Checkmk user interface</a></p>
</li>
<li>
<p><a href="intro_setup_monitor.html">Setting up monitoring</a></p>
</li>
<li>
<p><a href="intro_tools.html">The monitoring tools</a></p>
</li>
<li>
<p><a href="intro_monitor.html">Checkmk in monitoring</a></p>
</li>
<li>
<p><a href="intro_finetune.html">Fine-tuning the monitoring</a></p>
</li>
<li>
<p><a href="intro_users.html">Working with multiple users</a></p>
</li>
<li>
<p><a href="intro_notifications.html">Switching on notifications</a></p>
</li>
<li>
<p><a href="intro_extend.html">Extending the monitoring system further</a></p>
</li>
<li>
<p><a href="intro_bestpractise.html">Best practices, tips &amp; tricks</a></p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_installation">
<a class="anchor" href="#_installation"></a>3. Installation</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p><a href="install_packages.html">Basic information on the installation of Checkmk</a></p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="_server_and_vms">
<a class="anchor" href="#_server_and_vms"></a>3.1. Server and VMs</h3>
<div class="ulist">
<ul>
<li>
<p><a href="install_packages_debian.html">Installation on Debian and Ubuntu</a></p>
</li>
<li>
<p><a href="install_packages_redhat.html">Installation on Red Hat and derivatives</a></p>
</li>
<li>
<p><a href="install_packages_sles.html">Installation on SUSE Linux Enterprise Server</a></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_appliance_container_cloud">
<a class="anchor" href="#_appliance_container_cloud"></a>3.2. Appliance, container, cloud</h3>
<div class="ulist">
<ul>
<li>
<p><a href="install_appliance_cmk.html">Installation of Checkmk in the appliance</a></p>
</li>
<li>
<p><a href="introduction_docker.html">Installation as a Docker container</a></p>
</li>
<li>
<p><a href="install_azure.html">Installation from Azure Marketplace</a></p>
</li>
<li>
<p><a href="install_aws.html">Installation from AWS Marketplace</a></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_updates">
<a class="anchor" href="#_updates"></a>3.3. Updates</h3>
<div class="ulist">
<ul>
<li>
<p><a href="update.html">Updates and Upgrades</a></p>
</li>
<li>
<p><a href="update_major.html">Update to version <span class="new">2.3.0</span></a></p>
</li>
<li>
<p><a href="update_matrix.html">Update matrix for version <span class="new">2.3.0</span></a></p>
</li>
<li>
<p><a href="release_upgrade.html">Linux upgrade on the Checkmk server</a></p>
</li>
<li>
<p><a href="cmk_versions.html">Checkmk versions</a></p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_administration_of_checkmk">
<a class="anchor" href="#_administration_of_checkmk"></a>4. Administration of Checkmk</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_server">
<a class="anchor" href="#_server"></a>4.1. Server</h3>
<div class="ulist">
<ul>
<li>
<p><a href="saml.html">Authentication with SAML</a></p>
</li>
<li>
<p><a href="kerberos.html">Single sign-on with Kerberos</a></p>
</li>
<li>
<p><a href="managing_docker.html">Checkmk server in a Docker container</a></p>
</li>
<li>
<p><a href="security.html">Security</a></p>
</li>
<li>
<p><a href="ports.html">Ports</a></p>
</li>
<li>
<p><a href="omd_https.html">Securing the web interface with HTTPS</a></p>
</li>
<li>
<p><a href="support_diagnostics.html">Support diagnostics</a></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_sites">
<a class="anchor" href="#_sites"></a>4.2. Sites</h3>
<div class="ulist">
<ul>
<li>
<p><a href="omd_basics.html">Site administration with omd</a></p>
</li>
<li>
<p><a href="cmk_commandline.html">Checkmk on the command line</a></p>
</li>
<li>
<p><a href="license.html">Managing licenses</a></p>
</li>
<li>
<p><a href="distributed_monitoring.html">Distributed monitoring</a></p>
</li>
<li>
<p><a href="backup.html">Backups</a></p>
</li>
<li>
<p><a href="password_store.html">Password store</a></p>
</li>
<li>
<p><a href="analyze_configuration.html">Analyzing the Checkmk site configuration</a></p>
</li>
<li>
<p><a href="mkps.html">Checkmk extension packages (MKPs)</a></p>
</li>
<li>
<p><a href="mkp_viewables.html">MKPs for GUI extensions</a></p>
</li>
<li>
<p><a href="simulation_mode.html">Simulation mode</a></p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_configuration">
<a class="anchor" href="#_configuration"></a>5. Configuration</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p><a href="wato.html">Configuring Checkmk</a></p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="_hosts">
<a class="anchor" href="#_hosts"></a>5.1. Hosts</h3>
<div class="ulist">
<ul>
<li>
<p><a href="hosts_setup.html">Host administration</a></p>
</li>
<li>
<p><a href="hosts_structure.html">Host structuring</a></p>
</li>
<li>
<p><a href="host_tags.html">Host tags</a></p>
</li>
<li>
<p><a href="dcd.html">Dynamic host configuration</a></p>
</li>
<li>
<p><a href="hosts_autoregister.html">Automated host creation</a></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_services">
<a class="anchor" href="#_services"></a>5.2. Services</h3>
<div class="ulist">
<ul>
<li>
<p><a href="wato_services.html">Understanding and configuring services</a></p>
</li>
<li>
<p><a href="clustered_services.html">Monitoring cluster services</a></p>
</li>
<li>
<p><a href="piggyback.html">The piggyback mechanism</a></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_rules">
<a class="anchor" href="#_rules"></a>5.3. Rules</h3>
<div class="ulist">
<ul>
<li>
<p><a href="wato_rules.html">Rules</a></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_supporting_configurations">
<a class="anchor" href="#_supporting_configurations"></a>5.4. Supporting configurations</h3>
<div class="ulist">
<ul>
<li>
<p><a href="timeperiods.html">Time periods</a></p>
</li>
<li>
<p><a href="labels.html">Labels</a></p>
</li>
<li>
<p><a href="regexes.html">Regular expressions in Checkmk</a></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_users_and_permissions">
<a class="anchor" href="#_users_and_permissions"></a>5.5. Users and permissions</h3>
<div class="ulist">
<ul>
<li>
<p><a href="wato_user.html">Users, roles and permissions</a></p>
</li>
<li>
<p><a href="ldap.html">User management with LDAP/Active Directory</a></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_notifications">
<a class="anchor" href="#_notifications"></a>5.6. Notifications</h3>
<div class="ulist">
<ul>
<li>
<p><a href="notifications.html">Notifications</a></p>
</li>
<li>
<p><a href="notifications_webex.html">Notifications via Cisco Webex Teams</a></p>
</li>
<li>
<p><a href="notifications_ilert.html">Notifications via ilert</a></p>
</li>
<li>
<p><a href="notifications_jira.html">Notifications via Jira</a></p>
</li>
<li>
<p><a href="notifications_mattermost.html">Notifications via Mattermost</a></p>
</li>
<li>
<p><a href="notifications_teams.html">Notifications via Microsoft Teams</a></p>
</li>
<li>
<p><a href="notifications_pagerduty.html">Notifications via PagerDuty</a></p>
</li>
<li>
<p><a href="notifications_pushover.html">Notifications via Pushover</a></p>
</li>
<li>
<p><a href="notifications_opsgenie.html">Notifications via Opsgenie</a></p>
</li>
<li>
<p><a href="notifications_servicenow.html">Notifications via ServiceNow</a></p>
</li>
<li>
<p><a href="notifications_signl4.html">Notifications via SIGNL4</a></p>
</li>
<li>
<p><a href="notifications_slack.html">Notifications via Slack</a></p>
</li>
<li>
<p><a href="notifications_splunkoncall.html">Notifications via Splunk On-Call</a></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_events">
<a class="anchor" href="#_events"></a>5.7. Events</h3>
<div class="ulist">
<ul>
<li>
<p><a href="ec.html">The Event Console</a></p>
</li>
<li>
<p><a href="alert_handlers.html">Alert handlers</a></p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_monitoring_systems">
<a class="anchor" href="#_monitoring_systems"></a>6. Monitoring systems</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p><a href="wato_monitoringagents.html">Monitoring agents</a></p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="_checkmk_agents_and_snmp">
<a class="anchor" href="#_checkmk_agents_and_snmp"></a>6.1. Checkmk agents and SNMP</h3>
<div class="ulist">
<ul>
<li>
<p><a href="agent_deployment.html">Automatic agent updates</a></p>
</li>
<li>
<p><a href="agent_linux.html">Monitoring Linux</a></p>
</li>
<li>
<p><a href="agent_linux_legacy.html">Monitoring Linux in legacy mode</a></p>
</li>
<li>
<p><a href="agent_windows.html">Monitoring Windows</a></p>
</li>
<li>
<p><a href="agent_freebsd.html">Monitoring FreeBSD</a></p>
</li>
<li>
<p><a href="snmp.html">Monitoring via SNMP</a></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_agent_extensions">
<a class="anchor" href="#_agent_extensions"></a>6.2. Agent extensions</h3>
<div class="ulist">
<ul>
<li>
<p><a href="inventory.html">The HW/SW inventory</a></p>
</li>
<li>
<p><a href="mk_filestats.html">Monitoring files</a></p>
</li>
<li>
<p><a href="monitoring_logfiles.html">Monitoring log files</a></p>
</li>
<li>
<p><a href="monitoring_oracle.html">Monitoring Oracle databases</a></p>
</li>
<li>
<p><a href="monitoring_mysql.html">Monitoring MySQL</a></p>
</li>
<li>
<p><a href="monitoring_mssql.html">Monitoring MSSQL</a></p>
</li>
<li>
<p><a href="monitoring_mssql_legacy.html">Monitoring MSSQL with the legacy plug-in</a></p>
</li>
<li>
<p><a href="monitoring_jobs.html">Monitoring time-based processes (Cronjobs)</a></p>
</li>
<li>
<p><a href="spool_directory.html">The spool directory</a></p>
</li>
<li>
<p><a href="localchecks.html">Local checks</a></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_vm_cloud_container">
<a class="anchor" href="#_vm_cloud_container"></a>6.3. VM, cloud, container</h3>
<div class="ulist">
<ul>
<li>
<p><a href="datasource_programs.html">Datasource programs</a></p>
</li>
<li>
<p><a href="monitoring_vmware.html">Monitoring VMware ESXi</a></p>
</li>
<li>
<p><a href="monitoring_aws.html">Monitoring Amazon Web Services (AWS)</a></p>
</li>
<li>
<p><a href="monitoring_azure.html">Monitoring Microsoft Azure</a></p>
</li>
<li>
<p><a href="monitoring_gcp.html">Monitoring Google Cloud Platform (GCP)</a></p>
</li>
<li>
<p><a href="monitoring_kubernetes.html">Monitoring Kubernetes</a></p>
</li>
<li>
<p><a href="monitoring_openshift.html">Monitoring OpenShift</a></p>
</li>
<li>
<p><a href="monitoring_docker.html">Monitoring Docker</a></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_endpoints">
<a class="anchor" href="#_endpoints"></a>6.4. Endpoints</h3>
<div class="ulist">
<ul>
<li>
<p><a href="active_checks.html">Monitoring network services (Active checks)</a></p>
</li>
<li>
<p><a href="robotmk.html">Checkmk Synthetic Monitoring with Robotmk</a></p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_dashboards_views_metrics">
<a class="anchor" href="#_dashboards_views_metrics"></a>7. Dashboards, views, metrics</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p><a href="user_interface.html">The user interface</a></p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="_general">
<a class="anchor" href="#_general"></a>7.1. General</h3>
<div class="ulist">
<ul>
<li>
<p><a href="views.html">Host and service views</a></p>
</li>
<li>
<p><a href="dashboards.html">Dashboards</a></p>
</li>
<li>
<p><a href="graphing.html">Measured values and graphing</a></p>
</li>
<li>
<p><a href="custom_notes.html">Custom notes</a></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_commands_in_views">
<a class="anchor" href="#_commands_in_views"></a>7.2. Commands in views</h3>
<div class="ulist">
<ul>
<li>
<p><a href="commands.html">Commands</a></p>
</li>
<li>
<p><a href="basics_ackn.html">Acknowledging problems</a></p>
</li>
<li>
<p><a href="basics_downtimes.html">Scheduled downtimes</a></p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_analysis_and_prognosis">
<a class="anchor" href="#_analysis_and_prognosis"></a>8. Analysis and prognosis</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_analysis">
<a class="anchor" href="#_analysis"></a>8.1. Analysis</h3>
<div class="ulist">
<ul>
<li>
<p><a href="availability.html">Availability</a></p>
</li>
<li>
<p><a href="sla.html">Extended availability (SLAs)</a></p>
</li>
<li>
<p><a href="bi.html">Business Intelligence (BI)</a></p>
</li>
<li>
<p><a href="reporting.html">Reports</a></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_prognosis">
<a class="anchor" href="#_prognosis"></a>8.2. Prognosis</h3>
<div class="ulist">
<ul>
<li>
<p><a href="predictive_monitoring.html">Predictive monitoring</a></p>
</li>
<li>
<p><a href="forecast_graphs.html">Forecast graphs</a></p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_connection_of_other_applications">
<a class="anchor" href="#_connection_of_other_applications"></a>9. Connection of other applications</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p><a href="monitoring_prometheus.html">Integrating Prometheus</a></p>
</li>
<li>
<p><a href="integrating_datadog.html">Integrating Datadog</a></p>
</li>
<li>
<p><a href="nagvis.html">NagVis: status data on maps and diagrams</a></p>
</li>
<li>
<p><a href="ntop.html">Integrating ntopng in Checkmk</a></p>
</li>
<li>
<p><a href="grafana.html">Integrating Checkmk in Grafana</a></p>
</li>
<li>
<p><a href="metrics_exporter.html">Sending metrics to InfluxDB and Graphite</a></p>
</li>
<li>
<p><a href="nagstamon.html">Integrating Checkmk in Nagstamon</a></p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_specifics_to_the_editions">
<a class="anchor" href="#_specifics_to_the_editions"></a>10. Specifics to the editions</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p><a href="cse.html">Checkmk Enterprise</a></p>
</li>
<li>
<p><a href="cce.html">Checkmk Cloud</a></p>
</li>
<li>
<p><a href="managed.html">Checkmk MSP</a></p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_automation_and_development">
<a class="anchor" href="#_automation_and_development"></a>11. Automation and development</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p><a href="apis_intro.html">Overview of API resources</a></p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="_apis_for_automation">
<a class="anchor" href="#_apis_for_automation"></a>11.1. APIs for automation</h3>
<div class="ulist">
<ul>
<li>
<p><a href="rest_api.html">The Checkmk REST API</a></p>
</li>
<li>
<p><a href="livestatus.html">Retrieving status data via Livestatus</a></p>
</li>
<li>
<p><a href="livestatus_references.html">Livestatus command reference</a></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_apis_for_development">
<a class="anchor" href="#_apis_for_development"></a>11.2. APIs for development</h3>
<div class="ulist">
<ul>
<li>
<p><a href="bakery_api.html">The Bakery-API</a></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_development_of_check_plug_ins">
<a class="anchor" href="#_development_of_check_plug_ins"></a>11.3. Development of check plug-ins</h3>
<div class="ulist">
<ul>
<li>
<p><a href="devel_intro.html">Developing extensions for Checkmk</a></p>
</li>
<li>
<p><a href="devel_check_plugins.html">Writing agent-based check plug-ins</a></p>
</li>
<li>
<p><a href="devel_check_plugins_snmp.html">Writing SNMP-based check plug-ins</a></p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_concepts">
<a class="anchor" href="#_concepts"></a>12. Concepts</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p><a href="monitoring_basics.html">Basic principles of monitoring with Checkmk</a></p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="_the_checkmk_micro_core_cmc">
<a class="anchor" href="#_the_checkmk_micro_core_cmc"></a>12.1. The Checkmk Micro Core (CMC)</h3>
<div class="ulist">
<ul>
<li>
<p><a href="cmc.html">The Checkmk Micro Core (CMC)</a></p>
</li>
<li>
<p><a href="cmc_differences.html">Special characteristics of the CMC</a></p>
</li>
<li>
<p><a href="cmc_migration.html">Migration to the CMC</a></p>
</li>
<li>
<p><a href="cmc_files.html">CMC files and directories</a></p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_the_checkmk_appliance">
<a class="anchor" href="#_the_checkmk_appliance"></a>13. The Checkmk appliance</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p><a href="appliance_rack1_quick_start.html">Quick start guide for Checkmk racks</a></p>
</li>
<li>
<p><a href="appliance_virt1_quick_start.html">Quick start guide for Checkmk virt1</a></p>
</li>
<li>
<p><a href="appliance_install_virt1.html">Installation of the virtual appliance</a></p>
</li>
<li>
<p><a href="appliance_usage.html">Configuring and using the appliance</a></p>
</li>
<li>
<p><a href="appliance_backup.html">Backup in the appliance</a></p>
</li>
<li>
<p><a href="appliance_cluster.html">Appliance in cluster operation</a></p>
</li>
<li>
<p><a href="appliance_rack_config.html">Special features of the hardware appliance</a></p>
</li>
</ul>
</div>
</div>
</div>
</div></div>
<div class="main-nav__utils">
<div class="dropup dropdown__utils">
<button class="btn dropdown-toggle" type="button" id="aboutMenuButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">About Checkmk</button><div class="dropdown-menu dropup" aria-labelledby="aboutMenuButton">
<a class="dropdown-item" href="https://checkmk.com/product/features" target="_blank">Features</a><a class="dropdown-item" href="https://checkmk.com/product/editions" target="_blank">Editions</a><a class="dropdown-item" href="https://checkmk.com/integrations" target="_blank">Integrations</a><a class="dropdown-item" href="https://checkmk.com/imprint" target="_blank">Imprint</a><a class="dropdown-item" href="copyright.html" target="_blank">Copyright</a>
</div>
</div>
<div class="dropup dropdown__utils">
<button class="btn dropdown-toggle" type="button" id="learnMenuButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Learn</button><div class="dropdown-menu dropup" aria-labelledby="learnMenuButton">
<a class="dropdown-item" href="https://checkmk.com/videos">Videos</a><a class="dropdown-item" href="https://checkmk.com/webinars">Webinars</a><a class="dropdown-item" href="https://checkmk.com/trainings/classes">Trainings</a>
</div>
</div>
<a class="main-nav__utils__link" href="https://forum.checkmk.com">Forum</a>
</div>
</div></aside><main><div id="header">
<h1>Writing agent-based check plug-ins</h1>
<div class="details">
<span id="revdate">Last modified on 09-Oct-2024</span><a class="edit-document" href="https://github.com/Checkmk/checkmk-docs/edit/2.3.0/src/onprem/en/devel_check_plugins.asciidoc">Edit this page on GitHub</a>
</div>
</div>
<div id="content">
<div id="preamble">
<div id="staticinfo">This page was exported for offline usage on 2025-01-07 22:12:14 +0000. It may not reflect the current state of the Checkmk documentation. To view a daily updated version, visit <a href="https://docs.checkmk.com/" target="_blank">docs.checkmk.com</a>.</div>
<div class="sectionbody"><div class="paragraph">
<p></p>
<div class="dropdown dropdown__related">
<button class="btn btn-primary dropdown-toggle" type="button" id="relatedMenuButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Related Articles</button><div class="dropdown-menu dropdown-menu-right" aria-labelledby="relatedMenuButton">
<a href="devel_intro.html">Developing extensions for Checkmk</a>
<a href="devel_check_plugins_snmp.html">Writing SNMP-based check plug-ins</a>
<a href="wato_monitoringagents.html">Monitoring agents</a>
<a href="agent_linux.html">Monitoring Linux</a>
<a href="agent_windows.html">Monitoring Windows</a>
<a href="wato_services.html">Understanding and configuring services</a>
<a href="cmk_commandline.html">Checkmk on the command line</a>
<a href="mkps.html">Checkmk extension packages (MKPs)</a>
</div>
</div>
</div></div>
</div>
<div class="sect1">
<h2 id="heading_intro">
<span class="hidden-anchor sr-only" id="intro"></span>1. Introduction</h2>
<div class="sectionbody">
<div class="paragraph"><p>Check plug-ins are software modules written in Python that are executed on a Checkmk <a href="glossar.html#site">site</a> and which create and evaluate the <a href="glossar.html#service">services</a> on a <a href="glossar.html#host">host</a>.</p></div>
<div class="paragraph"><p>Checkmk includes over 2000 ready-made check plug-ins for all conceivable hardware and software.
These plug-ins are maintained by the Checkmk team and new ones are added every week.
In addition, there are further plug-ins on the <a href="https://exchange.checkmk.com" target="_blank">Checkmk Exchange</a> that are contributed by our users.</p></div>
<div class="paragraph"><p>And yet it can always be the case that a device, an application or simply a certain <a href="glossar.html#metric">metric</a>, that is important to you is not yet covered by any of these existing plug-ins — perhaps simply because it is something that was developed in your organization and therefore no one else could have it.
In the article on the introduction to <a href="devel_intro.html">developing extensions</a> for Checkmk, you can find out what options are available to you.</p></div>
<div class="paragraph"><p>This article shows you how to develop real check plug-ins for the Checkmk agent — including everything that goes with it.
There is a <a href="devel_check_plugins_snmp.html">separate article</a> for SNMP-based check plug-ins.</p></div>
<div class="admonitionblock tip"><table><tr>
<td class="icon"><img src="../images/icons/tip.png" alt="Tip"></td>
<td class="content"><div class="paragraph"><p>When developing an agent-based check plug-in, you generally need <em>two</em> plug-ins:
the <a href="glossar.html#agent_plugin">agent plug-in</a> on the monitored host, which provides the data, and the <a href="glossar.html#check_plugin">check plug-in</a> on the Checkmk server, which evaluates this data.
Both must be written together and optimized for each other.
This is the only way they will work smoothly afterwards.</p></div></td>
</tr></table></div>
<div class="sect2">
<h3 id="heading_check_api_doc">
<span class="hidden-anchor sr-only" id="check_api_doc"></span>1.1. The Check API documentation</h3>
<div class="paragraph"><p>Since Checkmk version <span class="new">2.0.0</span>, there has been a newly developed <strong>Check API</strong> for programming the check plug-ins.
In Checkmk version <span class="new">2.3.0</span>, the Check API V2 is the current version.
In this article, we will show you how to use Check API version 2 for the programming of plug-ins.
You can find information on migrating to Check API version 2 at the end of this article in the <a href="#migration">Migration</a> chapter.</p></div>
<div class="paragraph"><p>You can access the Check API documentation at any time via the Checkmk user interface: <span class="guihint">Help &gt; Developer resources &gt; Plugin API references</span>.
In the new browser window, select <span class="guihint">Agent based ("Check API") &gt; Version 2</span> in the left- side navigation bar:</p></div>
<div class="imageblock border"><div class="content"><img src="../images/devel_cpi_checkapi_doc.png" alt="“Page to access the Check API version 2 documentation.”"></div></div>
<div class="paragraph"><p>Here you will not only find the documentation for the Check API in all supported versions, but also the documentation of all other APIs relevant for the creation of check plug-ins.
In this article, we not only use the Check API, but also the <strong>Rulesets API</strong> V1 when creating a <a href="#rule_set">rule set</a> and the <strong>Graphing API</strong> V1 when creating <a href="#metrics_advanced">metric definitions</a>.</p></div>
</div>
<div class="sect2">
<h3 id="heading_prerequisites">
<span class="hidden-anchor sr-only" id="prerequisites"></span>1.2. Prerequisites</h3>
<div class="paragraph"><p>If you are interested in programming check plug-ins, you will need the following:</p></div>
<div class="ulist"><ul>
<li><p>Knowledge of the Python programming language.</p></li>
<li><p>Experience with Checkmk, especially when it comes to agents and checks.</p></li>
<li><p>Practice using Linux from the command line.</p></li>
</ul></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="heading_agentplugin">
<span class="hidden-anchor sr-only" id="agentplugin"></span>2. Writing an agent plug-in</h2>
<div class="sectionbody">
<div class="paragraph"><p>If you are interested in programming plug-ins for Checkmk, it is very likely that you have already set up a Checkmk server.
If you have done this, you have probably also monitored your Checkmk server itself as a host.</p></div>
<div class="paragraph"><p>Here we will create a scenario in which it is useful if the Checkmk server and the host being monitored are identical.
This allows us to use <a href="glossar.html#livestatus">Livestatus</a> queries from the host to obtain information about host groups provided by the Checkmk server.</p></div>
<div class="paragraph"><p>In the example described, we will assume an organization with several locations:</p></div>
<div class="ulist"><ul>
<li><p>Each of these locations is represented in Checkmk by a <a href="glossar.html#host_group">host group</a>.</p></li>
<li><p>Each location has its own service team.</p></li>
</ul></div>
<div class="paragraph"><p>To ensure that the correct service team can be notified in the event of problems, each host must be assigned to a location — i.e. also to a host group.
The aim of this example is to set up a check to ensure that no host has forgotten to assign a host group.</p></div>
<div class="paragraph"><p>The whole process comprises two steps:</p></div>
<div class="olist arabic"><ol class="arabic">
<li><p>Read information for monitoring from the host.
This is what this chapter is about.</p></li>
<li><p>Writing a check plug-in in the Checkmk site that evaluates this data.
We will show this in the <a href="#write_check_plugin">next chapter</a>.</p></li>
</ol></div>
<div class="paragraph"><p>So, let’s go …​</p></div>
<div class="sect2">
<h3 id="heading_right_command">
<span class="hidden-anchor sr-only" id="right_command"></span>2.1. Retrieving and filtering information</h3>
<div class="paragraph"><p>The first step before writing any plug-in program is research!
This means one needs to find out how to get the information you need for the monitoring.</p></div>
<div class="paragraph"><p>For the example chosen, we use the fact that the Checkmk server is also the host.
This means that initially it is sufficient to <a href="livestatus.html">retrieve the status data via Livestatus</a>, i.e. the data organized in tables that Checkmk holds about the monitored hosts and services in volatile memory.</p></div>
<div class="paragraph"><p>Log in as an site user and query the information on the host groups with the following command:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="console"><span></span><span class="tok-gp">OMD[mysite]:~$ </span>lq<span class="tok-w"> </span><span class="tok-s2">"GET hostgroups"</span>
<span class="tok-go">action_url;alias;members;members_with_state;name;notes;notes_url;num_hosts;num_hosts_down;num_hosts_handled_problems;num_hosts_pending;num_hosts_unhandled_problems;num_hosts_unreach;num_hosts_up;num_services;num_services_crit;num_services_handled_problems;num_services_hard_crit;num_services_hard_ok;num_services_hard_unknown;num_services_hard_warn;num_services_ok;num_services_pending;num_services_unhandled_problems;num_services_unknown;num_services_warn;worst_host_state;worst_service_hard_state;worst_service_state</span>
<span class="tok-go">;Hamburg;myhost11,myhost22,myhost33;myhost11|0|1,myhost22|0|1,myhost33|0|1;Hamburg;;;3;0;0;0;0;0;3;123;10;0;10;99;0;14;99;0;24;0;14;0;2;2</span>
<span class="tok-go">;Munich;myhost1,myhost2,myhost3;myhost1|0|1,myhost2|0|1,myhost3|0|1;Munich;;;3;0;0;0;0;0;3;123;10;0;10;99;0;14;99;0;24;0;14;0;2;2</span>
<span class="tok-go">;check_mk;localhost;localhost|0|1;check_mk;;;1;0;0;0;0;0;1;66;0;0;0;4;0;1;4;61;1;0;1;0;1;1</span></code></pre></div></div>
<div class="paragraph"><p>The first line of the output contains the column names from the queried <code>hostgroups</code> table.
The semicolon acts as a separator.
The following lines then contain the contents of all columns, also separated by semicolons.</p></div>
<div class="paragraph"><p>The output is already relatively confusing in this small example and contains information that is not relevant for our example.
In general, you should leave the interpretation of the data to Checkmk.
However, pre-filtering on the host can reduce the volume of data to be transferred if not all of it is actually required.
So in this case, restrict the query to the relevant columns (<code>Columns</code>), to the names of the host groups (<code>name</code>) and the hosts in those groups (<code>members</code>):</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="console"><span></span><span class="tok-gp">OMD[mysite]:~$ </span>lq<span class="tok-w"> </span><span class="tok-s2">"GET hostgroups\nColumns: name members"</span>
<span class="tok-go">Hamburg;myhost11,myhost22,myhost33</span>
<span class="tok-go">Munich;myhost1,myhost2,myhost3</span>
<span class="tok-go">check_mk;localhost</span></code></pre></div></div>
<div class="paragraph"><p>The Livestatus interface expects to receive all commands and headers in their own separate line.
The necessary line breaks are indicated by <code>\n</code>.</p></div>
<div class="paragraph"><p>In this example, there are currently three host groups: two groups for the locations, and one for the <code>check_mk</code> group.
This contains a host called <code>localhost</code>.</p></div>
<div class="paragraph"><p>The <code>check_mk</code> host group is a special feature within the host groups.
You have not created it yourself.
And you cannot actively add a host to this group.
So where does this host group come from?
As by definition every host in Checkmk must belong to a group, Checkmk assigns every host that you do not specifically assign to a group to the 'special' <code>check_mk</code> group as the default.
As soon as you have assigned a host to one of your own host groups, it will be removed by Checkmk from the <code>check_mk</code> group.
There is also no way to reassign a host to the <code>check_mk</code> host group.</p></div>
<div class="paragraph"><p>Exactly these properties of the <code>check_mk</code> group are now used for our example:
Since each host should be assigned to a location, the host group <code>check_mk</code> should be empty.
If it is not empty, action is required, i.e. the hosts in it must be assigned to the host groups and thus to their appropriate locations.</p></div>
</div>
<div class="sect2">
<h3 id="heading_command_in_agent">
<span class="hidden-anchor sr-only" id="command_in_agent"></span>2.2. Incorporate the command into the agent</h3>
<div class="paragraph"><p>Up until now, as a site user, you have used the <code>lq</code> command to display the information.
This is helpful for getting an understanding of the data.</p></div>
<div class="paragraph"><p>However, in order to retrieve this data from the Checkmk server, the new command must become part of the Checkmk agent on the monitored host.
Theoretically, you could now directly edit the Checkmk agent in the <code>/usr/bin/check_mk_agent</code> file and include this part.
This method would however have the disadvantage that your new command would disappear again when the agent software is updated because this file will be overwritten during the update.</p></div>
<div class="paragraph"><p>It is therefore better to create an <a href="glossar.html#agent_plugin">agent plug-in</a>.
All you need for this is an executable file that contains the command and which is located in the <code>/usr/lib/check_mk_agent/plugins/</code> directory.</p></div>
<div class="paragraph"><p>And one more thing is important:
The data cannot be simply output.
You will still need a <strong>section header</strong>.
This is a specially formatted line that contains the name of the new agent plug-in.
This section header allows Checkmk to later recognize where the data from the new agent plug-in begins and where the data from the preceding plug-in ends.
It is easiest when the agent plug-in, section header and check plug-in have the same name — even if this is not mandatory.</p></div>
<div class="paragraph"><p>So first of all, you will need a meaningful name for your new check plug-in.
This name may only contain lower case letters (only <em>a-z</em>, no umlauts, no accents), underscores and digits and must be unique.
Avoid name conflicts with existing check plug-ins.
If you are curious which names already exist, in a Checkmk site on the command line you can list these with <code>cmk -L</code>:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="console"><span></span><span class="tok-gp">OMD[mysite]:~$ </span>cmk<span class="tok-w"> </span>-L
<span class="tok-go">3par_capacity               agent      HPE 3PAR: Capacity</span>
<span class="tok-go">3par_cpgs                   agent      HPE 3PAR: CPGs</span>
<span class="tok-go">3par_cpgs_usage             agent      HPE 3PAR: CPGs Usage</span>
<span class="tok-go">3par_hosts                  agent      HPE 3PAR: Hosts</span>
<span class="tok-go">3par_ports                  agent      HPE 3PAR: Ports</span>
<span class="tok-go">3par_remotecopy             agent      HPE 3PAR: Remote Copy</span>
<span class="tok-go">3par_system                 agent      HPE 3PAR: System</span>
<span class="tok-go">3par_volumes                agent      HPE 3PAR: Volumes</span>
<span class="tok-go">3ware_disks                 agent      3ware ATA RAID Controller: State of Disks</span>
<span class="tok-go">3ware_info                  agent      3ware ATA RAID Controller: General Information</span>
<span class="tok-go">3ware_units                 agent      3ware ATA RAID Controller: State of Units</span>
<span class="tok-go">acme_agent_sessions         snmp       ACME Devices: Agent Sessions</span>
<span class="tok-go">acme_certificates           snmp       ACME Devices: Certificates</span></code></pre></div></div>
<div class="paragraph"><p>The output here only shows the first lines of the very long list. By using prefixes, the assignment of many check plug-ins can already be easily recognized here.
The use of prefixes is therefore also recommended for your own check plug-ins.
Incidentally, the second column shows how the respective check plug-in obtains its data.</p></div>
<div class="paragraph"><p>A suitable name for the new check plug-in for our example is <code>myhostgroups</code>.</p></div>
<div class="paragraph"><p>Now you have all of the information you need to create the script for the agent plug-in.
Create a new file <code>myhostgroups</code> as the <code>root</code> user in the <code>/usr/lib/check_mk_agent/plugins/</code> directory:</p></div>
<div class="listingblock">
<div class="title">/usr/lib/check_mk_agent/plugins/myhostgroups</div>
<div class="content"><pre class="pygments highlight"><code><span></span>#!/bin/bash

columns="name members"
site="mysite"

echo '&lt;&lt;&lt;myhostgroups:sep(59)&gt;&gt;&gt;'
su - ${site} lq "GET hostgroups\nColumns: ${columns}"</code></pre></div>
</div>
<div class="paragraph"><p>What does this mean in detail?</p></div>
<div class="paragraph"><p>The first line contains the 'shebang' (this is an abbreviation for <em>sharp</em> and <em>bang</em>, the latter being an abbreviation for the exclamation mark), by which Linux recognizes that it should execute the script with the specified shell.</p></div>
<div class="paragraph"><p>To keep the script adaptable, two variables are introduced next:</p></div>
<div class="ulist"><ul>
<li><p>the <code>columns</code> variable, which currently contains the group names and the associated members,</p></li>
<li><p>the <code>site</code> variable, which contains the name of the Checkmk site.</p></li>
</ul></div>
<div class="paragraph"><p>Use the <code>echo</code> command to output the section header.
As the table columns are separated by a semicolon, use the addition <code>sep(59)</code> to specify that the semicolon is used as a separator for the data in the agent output.
The 59 stands for the <a href="https://en.wikipedia.org/wiki/ASCII#Printable_characters" target="_blank">ASCII</a> character code 59, the semicolon.
Without this addition, the space character (ASCII character 32) would be used as a separator by default.</p></div>
<div class="paragraph"><p>To be able to use the <code>lq</code> command, which is available to you as site user, in a script that is executed by the <code>root</code> user, prefix it with <code>su</code>.</p></div>
<div class="admonitionblock tip"><table><tr>
<td class="icon"><img src="../images/icons/tip.png" alt="Tip"></td>
<td class="content"><div class="paragraph"><p>It is possible that accessing <code>lq</code> via <code>su</code> can cause problems.
Alternatively, as a <code>root</code> user, you can also access Livestatus directly in the shell with <code>printf</code> or <code>echo -e</code> via a Unix socket.
The article on <a href="livestatus.html#lql_shell">Livestatus</a> explains how to do this.</p></div></td>
</tr></table></div>
<div class="paragraph"><p>One more point is important once you have created the file — make the file executable:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="console"><span></span><span class="tok-gp">root@linux# </span>chmod<span class="tok-w"> </span>+x<span class="tok-w"> </span>/usr/lib/check_mk_agent/plugins/myhostgroups</code></pre></div></div>
<div class="paragraph"><p>You can try out the agent plug-in directly by hand by entering the complete path as a command:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="console"><span></span><span class="tok-gp">root@linux# </span>/usr/lib/check_mk_agent/plugins/myhostgroups
<span class="tok-go">&lt;&lt;&lt;myhostgroups:sep(59)&gt;&gt;&gt;</span>
<span class="tok-go">Hamburg;myhost11,myhost22,myhost33</span>
<span class="tok-go">Munich;myhost1,myhost2,myhost3</span>
<span class="tok-go">check_mk;localhost</span></code></pre></div></div>
<div class="paragraph"><p>Host groups that do not contain any hosts are not listed here.</p></div>
</div>
<div class="sect2">
<h3 id="heading_test_agent">
<span class="hidden-anchor sr-only" id="test_agent"></span>2.3. Testing the agent</h3>
<div class="paragraph"><p>Testing and troubleshooting are the most important tasks when creating a functioning agent plug-in.
It is best to proceed in three steps:</p></div>
<div class="olist arabic"><ol class="arabic">
<li><p>Try out the agent plug-in 'standalone'.
You have just done this in the previous section.</p></li>
<li><p>Test the agent as a whole locally.</p></li>
<li><p>Retrieve the agent from the Checkmk server.</p></li>
</ol></div>
<div class="paragraph"><p>Testing the agent locally is very simple.
As <code>root</code>, call the <code>check_mk_agent</code> command:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="console"><span></span><span class="tok-gp">root@linux# </span>check_mk_agent</code></pre></div></div>
<div class="paragraph"><p>The new section must appear somewhere in the very long output.
Agent plug-ins are output by the agent at the end of processing.</p></div>
<div class="paragraph"><p>You can scroll through the output by appending <code>less</code> (press the space bar to scroll, <code>/</code> to search and <code>q</code> to exit):</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="console"><span></span><span class="tok-gp">root@linux# </span>check_mk_agent<span class="tok-w"> </span><span class="tok-p">|</span><span class="tok-w"> </span>less</code></pre></div></div>
<div class="paragraph"><p>Or you can search the output for the interesting lines.
For example, <code>grep</code> with <code>-A</code> has an option to output a few more lines after each hit.
This allows you to conveniently search and output the section:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="console"><span></span><span class="tok-gp">root@linux# </span>check_mk_agent<span class="tok-w"> </span><span class="tok-p">|</span><span class="tok-w"> </span>grep<span class="tok-w"> </span>-A3<span class="tok-w"> </span><span class="tok-s1">'^&lt;&lt;&lt;myhostgroups'</span>
<span class="tok-go">&lt;&lt;&lt;myhostgroups:sep(59)&gt;&gt;&gt;</span>
<span class="tok-go">Hamburg;myhost11,myhost22,myhost33</span>
<span class="tok-go">Munich;myhost1,myhost2,myhost3</span>
<span class="tok-go">check_mk;localhost</span></code></pre></div></div>
<div class="paragraph"><p>The third and final test is then directly from the Checkmk site.
Include the <a href="intro_setup_monitor.html#linux">host in the monitoring</a> (for example as <code>localhost</code>), log in as the site user and then retrieve the agent data with <code>cmk -d</code>:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="console"><span></span><span class="tok-gp">OMD[mysite]:~$ </span>cmk<span class="tok-w"> </span>-d<span class="tok-w"> </span>localhost<span class="tok-w"> </span><span class="tok-p">|</span><span class="tok-w"> </span>grep<span class="tok-w"> </span>-A3<span class="tok-w"> </span><span class="tok-s1">'^&lt;&lt;&lt;myhostgroups'</span></code></pre></div></div>
<div class="paragraph"><p>This should produce the same output as the previous command.</p></div>
<div class="paragraph"><p>If this works, your agent is ready.
And what have you done for this?
You have created a short script under the path <code>/usr/lib/check_mk_agent/plugins/myhostgroups</code> and made it executable.</p></div>
<div class="paragraph"><p>Everything that follows now only takes place on the Checkmk server:
There you write the check plug-in.</p></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="heading_write_check_plugin">
<span class="hidden-anchor sr-only" id="write_check_plugin"></span>3. Writing a simple check plug-in</h2>
<div class="sectionbody">
<div class="paragraph"><p>Preparing the agent is only half the fun.
Now you need to teach Checkmk how to handle the information from the new agent section, which services it should generate, when they should go to <span class="state1">WARN</span> or <span class="state2">CRIT</span>, etc.
You can do all this by programming a check plug-in using Python.</p></div>
<div class="sect2">
<h3 id="heading_scaffold">
<span class="hidden-anchor sr-only" id="scaffold"></span>3.1. Preparing the file</h3>
<div class="paragraph"><p>For your own check plug-ins you will find the base directory already prepared in the <code>local</code> hierarchy of the <a href="cmk_commandline.html#sitedir">site directory</a>.
This is <code>~/local/lib/python3/cmk_addons/plugins/</code>.
The directory belongs to the site user and is therefore writable for you.</p></div>
<div class="paragraph"><p>In this directory, the plug-ins are organized in <em>plug-in families</em>, whose directory names can be freely defined.
For example, all plug-ins relating to Cisco devices are stored in the <code>cisco</code> folder, likewise all plug-ins relating to your host groups are stored in the <code>myhostgroups</code> folder.
This convention allows all plug-ins belonging to the same family to share code — and is used in exactly the same way by the plug-ins that are delivered with Checkmk.</p></div>
<div class="paragraph"><p>In this subdirectory <code>&lt;plug-in_family&gt;</code>, further subdirectories with predefined names are then created as required for the various APIs, e.g. <code>agent_based</code> for the Check API of agent-based check plug-ins.
In turn we will introduce further subdirectories for the <a href="#rule_set">Rulesets API</a> and the <a href="#metrics_advanced">Graphing API</a> later.</p></div>
<div class="paragraph"><p>Create the two subdirectories for the new agent-based check plug-in and then switch to them to work:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="console"><span></span><span class="tok-gp">OMD[mysite]:~$ </span>mkdir<span class="tok-w"> </span>-p<span class="tok-w"> </span>local/lib/python3/cmk_addons/plugins/myhostgroups/agent_based
<span class="tok-gp">OMD[mysite]:~$ </span><span class="tok-nb">cd</span><span class="tok-w"> </span>local/lib/python3/cmk_addons/plugins/myhostgroups/agent_based</code></pre></div></div>
<div class="paragraph"><p>You can edit your check plug-in with any text editor installed on the Linux system.</p></div>
<div class="paragraph"><p>Create the file <code>myhostgroups.py</code> for the check plug-in here.
The convention is that the file name reflects the name of the agent section.
It is <em>mandatory</em> that the file ends with <code>.py</code>, because from Checkmk version <span class="new">2.0.0</span> the check plug-ins are always real Python modules.</p></div>
<div class="paragraph"><p>An executable basic framework (<a href="https://github.com/Checkmk/checkmk-docs/blob/master/examples/devel_check_plugins/check_plugin_simple_myhostgroups_bare_minimum.py" target="_blank">Download at GitHub</a>), which you will expand step by step in the following, looks like this:</p></div>
<div class="listingblock">
<div class="title">~/local/lib/python3/cmk_addons/plugins/myhostgroups/agent_based/myhostgroups.py</div>
<div class="content"><pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-ch">#!/usr/bin/env python3</span>

<span class="tok-kn">from</span> <span class="tok-nn">cmk.agent_based.v2</span> <span class="tok-kn">import</span> <span class="tok-n">AgentSection</span><span class="tok-p">,</span> <span class="tok-n">CheckPlugin</span><span class="tok-p">,</span> <span class="tok-n">Service</span><span class="tok-p">,</span> <span class="tok-n">Result</span><span class="tok-p">,</span> <span class="tok-n">State</span><span class="tok-p">,</span> <span class="tok-n">Metric</span><span class="tok-p">,</span> <span class="tok-n">check_levels</span>

<span class="tok-k">def</span> <span class="tok-nf">parse_myhostgroups</span><span class="tok-p">(</span><span class="tok-n">string_table</span><span class="tok-p">):</span>
    <span class="tok-n">parsed</span> <span class="tok-o">=</span> <span class="tok-p">{}</span>
    <span class="tok-k">return</span> <span class="tok-n">parsed</span>

<span class="tok-k">def</span> <span class="tok-nf">discover_myhostgroups</span><span class="tok-p">(</span><span class="tok-n">section</span><span class="tok-p">):</span>
    <span class="tok-k">yield</span> <span class="tok-n">Service</span><span class="tok-p">()</span>

<span class="tok-k">def</span> <span class="tok-nf">check_myhostgroups</span><span class="tok-p">(</span><span class="tok-n">section</span><span class="tok-p">):</span>
    <span class="tok-k">yield</span> <span class="tok-n">Result</span><span class="tok-p">(</span><span class="tok-n">state</span><span class="tok-o">=</span><span class="tok-n">State</span><span class="tok-o">.</span><span class="tok-n">OK</span><span class="tok-p">,</span> <span class="tok-n">summary</span><span class="tok-o">=</span><span class="tok-s2">"Everything is fine"</span><span class="tok-p">)</span>

<span class="tok-n">agent_section_myhostgroups</span> <span class="tok-o">=</span> <span class="tok-n">AgentSection</span><span class="tok-p">(</span>
    <span class="tok-n">name</span> <span class="tok-o">=</span> <span class="tok-s2">"myhostgroups"</span><span class="tok-p">,</span>
    <span class="tok-n">parse_function</span> <span class="tok-o">=</span> <span class="tok-n">parse_myhostgroups</span><span class="tok-p">,</span>
<span class="tok-p">)</span>

<span class="tok-n">check_plugin_myhostgroups</span> <span class="tok-o">=</span> <span class="tok-n">CheckPlugin</span><span class="tok-p">(</span>
    <span class="tok-n">name</span> <span class="tok-o">=</span> <span class="tok-s2">"myhostgroups"</span><span class="tok-p">,</span>
    <span class="tok-n">service_name</span> <span class="tok-o">=</span> <span class="tok-s2">"Host group check_mk"</span><span class="tok-p">,</span>
    <span class="tok-n">discovery_function</span> <span class="tok-o">=</span> <span class="tok-n">discover_myhostgroups</span><span class="tok-p">,</span>
    <span class="tok-n">check_function</span> <span class="tok-o">=</span> <span class="tok-n">check_myhostgroups</span><span class="tok-p">,</span>
<span class="tok-p">)</span></code></pre></div>
</div>
<div class="paragraph"><p>First, you need to import the functions and classes required for the check plug-ins from Python modules.
For our example, we will only import what will be required or may be useful in the rest of this article.
Here, <code>cmk.agent_based.v2</code> is used to specify that the modules from the Check API <strong>V2</strong> are imported:</p></div>
<div class="listingblock">
<div class="title">~/local/lib/python3/cmk_addons/plugins/myhostgroups/agent_based/myhostgroups.py</div>
<div class="content"><pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-kn">from</span> <span class="tok-nn">cmk.agent_based.v2</span> <span class="tok-kn">import</span> <span class="tok-n">AgentSection</span><span class="tok-p">,</span> <span class="tok-n">CheckPlugin</span><span class="tok-p">,</span> <span class="tok-n">Service</span><span class="tok-p">,</span> <span class="tok-n">Result</span><span class="tok-p">,</span> <span class="tok-n">State</span><span class="tok-p">,</span> <span class="tok-n">Metric</span><span class="tok-p">,</span> <span class="tok-n">check_levels</span></code></pre></div>
</div>
</div>
<div class="sect2">
<h3 id="heading_parse_function">
<span class="hidden-anchor sr-only" id="parse_function"></span>3.2. Writing the parse function</h3>
<div class="paragraph"><p>The parse function has the task of 'parsing' the 'raw' agent data, i.e. analyzing and splitting it up, and putting this data into a logically-structured form that is easy for all subsequent steps to process.</p></div>
<div class="paragraph"><p>As shown in the section on <a href="#test_agent">testing the agent</a>, the section supplied by the agent plug-in has the following structure:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="console"><span></span><span class="tok-go">&lt;&lt;&lt;myhostgroups:sep(59)&gt;&gt;&gt;</span>
<span class="tok-go">Hamburg;myhost11,myhost22,myhost33</span>
<span class="tok-go">Munich;myhost1,myhost2,myhost3</span>
<span class="tok-go">check_mk;localhost</span></code></pre></div></div>
<div class="paragraph"><p>Checkmk already splits the lines of the section supplied by the agent plug-in into a list of lines based on the separator in the section header (in the example <code>;</code>), these lines in turn are lists of words.
The following data structure is therefore available in Checkmk instead of the raw data from the agent plug-in:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-p">[</span>
    <span class="tok-p">[</span><span class="tok-s1">'Hamburg'</span><span class="tok-p">,</span> <span class="tok-s1">'myhost11,myhost22,myhost33'</span><span class="tok-p">],</span>
    <span class="tok-p">[</span><span class="tok-s1">'Munich'</span><span class="tok-p">,</span> <span class="tok-s1">'myhost1,myhost2,myhost3'</span><span class="tok-p">],</span>
    <span class="tok-p">[</span><span class="tok-s1">'check_mk'</span><span class="tok-p">,</span> <span class="tok-s1">'localhost'</span><span class="tok-p">]</span>
<span class="tok-p">]</span></code></pre></div></div>
<div class="paragraph"><p>In the inner list, the first element contains the name of the host group and the second the names of the hosts belonging to the group.</p></div>
<div class="paragraph"><p>You can address all of this information, but only via its position in the data set.
You would therefore always need to specify the number of square brackets and the 'sequence' number of the desired content(s) within each bracket.
With larger volumes of data, this becomes increasingly complex and it becomes more and more difficult to maintain an overview.</p></div>
<div class="paragraph"><p>At this point, a parse function offers clear advantages thanks to the structure it creates.
It makes the code easier to read, the accesses are more performant and it is much easier to maintain an overview.
It transforms the data structure supplied by Checkmk in such a way that you can address each of the individual values by name (or key) at will, and not be dependent on repeatedly searching through the <em>array</em> to find what you are looking for:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-p">{</span>
    <span class="tok-s1">'Hamburg'</span><span class="tok-p">:</span> <span class="tok-p">{</span><span class="tok-s1">'members'</span><span class="tok-p">:</span> <span class="tok-s1">'myhost11,myhost22,myhost33'</span><span class="tok-p">},</span>
    <span class="tok-s1">'Munich'</span><span class="tok-p">:</span> <span class="tok-p">{</span><span class="tok-s1">'members'</span><span class="tok-p">:</span> <span class="tok-s1">'myhost1,myhost2,myhost3'</span><span class="tok-p">},</span>
    <span class="tok-s1">'check_mk'</span><span class="tok-p">:</span> <span class="tok-p">{</span><span class="tok-s1">'members'</span><span class="tok-p">:</span> <span class="tok-s1">'localhost'</span><span class="tok-p">}</span>
<span class="tok-p">}</span></code></pre></div></div>
<div class="paragraph"><p>The convention is that the parse function is named after the agent section and begins with <code>parse_</code>.
It receives <code>string_table</code> as its only argument.
Note that you are not free to choose the argument here — it <em>must</em> be called exactly that.</p></div>
<div class="listingblock">
<div class="title">~/local/lib/python3/cmk_addons/plugins/myhostgroups/agent_based/myhostgroups.py</div>
<div class="content"><pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">def</span> <span class="tok-nf">parse_myhostgroups</span><span class="tok-p">(</span><span class="tok-n">string_table</span><span class="tok-p">):</span>
    <span class="tok-c1"># print(string_table)</span>
    <span class="tok-n">parsed</span> <span class="tok-o">=</span> <span class="tok-p">{}</span>
    <span class="tok-k">for</span> <span class="tok-n">line</span> <span class="tok-ow">in</span> <span class="tok-n">string_table</span><span class="tok-p">:</span>
        <span class="tok-n">parsed</span><span class="tok-p">[</span><span class="tok-n">line</span><span class="tok-p">[</span><span class="tok-mi">0</span><span class="tok-p">]]</span> <span class="tok-o">=</span> <span class="tok-p">{</span><span class="tok-s2">"members"</span><span class="tok-p">:</span> <span class="tok-n">line</span><span class="tok-p">[</span><span class="tok-mi">1</span><span class="tok-p">]}</span>
    <span class="tok-c1"># print(parsed)</span>
    <span class="tok-k">return</span> <span class="tok-n">parsed</span></code></pre></div>
</div>
<div class="paragraph"><p>With <code>def</code> you specify in Python that a function is to be defined below.
<code>parsed = {}</code> creates the <em>dictionary</em> with the improved data structure.
In our example, we will go through each line, element by element.
The host group followed by the members of the host group is taken from each line and assembled into an entry for the dictionary.</p></div>
<div class="paragraph"><p>The dictionary is then returned with <code>return parsed</code>.</p></div>
<div class="admonitionblock tip"><table><tr>
<td class="icon"><img src="../images/icons/tip.png" alt="Tip"></td>
<td class="content"><div class="paragraph"><p>In the example shown above, you will find two commented-out lines.
If you comment these later when <a href="#test">testing the check plug-in</a>, the data before and after executing the parse function will be displayed on the command line.
This allows you to check whether the function really does what it is supposed to do.</p></div></td>
</tr></table></div>
</div>
<div class="sect2">
<h3 id="heading_agent_section">
<span class="hidden-anchor sr-only" id="agent_section"></span>3.3. Creating the agent section</h3>
<div class="paragraph"><p>For this whole procedure to have any effect, you must create the new agent section with the new parse function.
This is the only way it will be recognized and taken into account by Checkmk.
To do this, create the agent section as an instance of the <code>AgentSection</code> class:</p></div>
<div class="listingblock">
<div class="title">~/local/lib/python3/cmk_addons/plugins/myhostgroups/agent_based/myhostgroups.py</div>
<div class="content"><pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-n">agent_section_myhostgroups</span> <span class="tok-o">=</span> <span class="tok-n">AgentSection</span><span class="tok-p">(</span>
    <span class="tok-n">name</span> <span class="tok-o">=</span> <span class="tok-s2">"myhostgroups"</span><span class="tok-p">,</span>
    <span class="tok-n">parse_function</span> <span class="tok-o">=</span> <span class="tok-n">parse_myhostgroups</span><span class="tok-p">,</span>
<span class="tok-p">)</span></code></pre></div>
</div>
<div class="paragraph"><p>Here it is important that the name of the section exactly matches the section header in the agent output.
From this moment on, every check plug-in that uses the <code>myhostgroups</code> section receives the return value from the parse function.
As a rule, this will be the check plug-in of the same name.
But other check plug-ins can also subscribe to this section, as we will show in the <a href="#discovery">extension of the check plug-in</a>.</p></div>
<div class="paragraph"><p>By the way: If you want to know exactly, you can take a look at the <a href="#check_api_doc">Check API documentation</a> at this point.
There you will find a detailed description of this class — and also of the classes, functions and objects that will be used later in this article.</p></div>
<div class="imageblock border"><div class="content"><img src="../images/devel_cpi_checkapi_doc_agent_section.png" alt="“Check API documentation for the ‘AgentSection’ class.”"></div></div>
</div>
<div class="sect2">
<h3 id="heading_check_plug-in">
<span class="hidden-anchor sr-only" id="check_plug-in"></span>3.4. Creating a check plug-in</h3>
<div class="paragraph"><p>In order for Checkmk to recognize that there is a new check plug-in, it must be created.
This is done by creating an instance of the class <code>CheckPlugin</code>.</p></div>
<div class="paragraph"><p>You must always specify at least four things:</p></div>
<div class="olist arabic"><ol class="arabic">
<li><p><code>name</code>: The name of the check plug-in.
The easiest way to do this is to use the same name as your new agent section.
This way, the check defined later in the check function automatically knows which section it should evaluate.</p></li>
<li><p><code>service_name</code>:
The name of the service as it should then appear in the monitoring.</p></li>
<li><p><code>discovery_function</code>:
The function for discovering services of this type (more on this in a moment).</p></li>
<li><p><code>check_function</code>:
The function for performing the actual check (more on this in a moment).</p></li>
</ol></div>
<div class="paragraph"><p>The name of the instance must begin with <code>check_plugin_</code>.
It then looks like this:</p></div>
<div class="listingblock">
<div class="title">~/local/lib/python3/cmk_addons/plugins/myhostgroups/agent_based/myhostgroups.py</div>
<div class="content"><pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-n">check_plugin_myhostgroups</span> <span class="tok-o">=</span> <span class="tok-n">CheckPlugin</span><span class="tok-p">(</span>
    <span class="tok-n">name</span> <span class="tok-o">=</span> <span class="tok-s2">"myhostgroups"</span><span class="tok-p">,</span>
    <span class="tok-n">service_name</span> <span class="tok-o">=</span> <span class="tok-s2">"Host group check_mk"</span><span class="tok-p">,</span>
    <span class="tok-n">discovery_function</span> <span class="tok-o">=</span> <span class="tok-n">discover_myhostgroups</span><span class="tok-p">,</span>
    <span class="tok-n">check_function</span> <span class="tok-o">=</span> <span class="tok-n">check_myhostgroups</span><span class="tok-p">,</span>
<span class="tok-p">)</span></code></pre></div>
</div>
<div class="paragraph"><p>It is best not to try this out just yet, as you first need to write the <code>discover_myhostgroups</code> and <code>check_myhostgroups</code> functions.
These must appear in the source code <em>before</em> the creation of the agent section and check plug-in as described above.</p></div>
</div>
<div class="sect2">
<h3 id="heading_discovery_function">
<span class="hidden-anchor sr-only" id="discovery_function"></span>3.5. Writing the discovery function</h3>
<div class="paragraph"><p>A special feature of Checkmk is the automatic discovery of services to be monitored.
For this to work, each check plug-in must define a function that uses the agent output to recognize <em>whether</em> a service of this type or <em>which</em> services of this type should be created for the host in question.</p></div>
<div class="paragraph"><p>The discovery function is always called when a service discovery is carried out for a host.
It then decides whether or which services should be created.
In the standard case, it receives exactly one argument with the name <code>section</code>.
This contains the agent section data in a format prepared by the <a href="#parse_function">parse function</a>.</p></div>
<div class="paragraph"><p>Therefore, implement the following simple logic:
<em>If</em> the <code>myhostgroups</code> agent section exists, then also create a suitable service.
This will then automatically appear on all hosts on which the agent plug-in is deployed.</p></div>
<div class="paragraph"><p>For check plug-ins that only create one service per host, no further information is required:</p></div>
<div class="listingblock">
<div class="title">~/local/lib/python3/cmk_addons/plugins/myhostgroups/agent_based/myhostgroups.py</div>
<div class="content"><pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">def</span> <span class="tok-nf">discover_myhostgroups</span><span class="tok-p">(</span><span class="tok-n">section</span><span class="tok-p">):</span>
    <span class="tok-k">yield</span> <span class="tok-n">Service</span><span class="tok-p">()</span></code></pre></div>
</div>
<div class="paragraph"><p>The discovery function must return an object of the <code>service</code> type for each service to be created using <code>yield</code> (not with <code>return</code>).
In Python, <code>yield</code> has the same function as <code>return</code> — both return a value to the calling function.
The decisive difference is that <code>yield</code> remembers how far the function has come in data processing.
The next call continues <em>after</em> the last <code>yield</code> statement — and does not start at the beginning again.
This means that not only the first hit is read out (as would be the case with <code>return</code>), but all hits in sequence (this advantage will become relevant later in our example with <a href="#discovery">service discovery</a>).</p></div>
</div>
<div class="sect2">
<h3 id="heading_check_function">
<span class="hidden-anchor sr-only" id="check_function"></span>3.6. Writing the check function</h3>
<div class="paragraph"><p>You can now move on to the actual check function, which uses the current agent output to decide which state the service should assume and can output further information.</p></div>
<div class="paragraph"><p>The aim of the check function is to set up a check that can be used to verify whether a host group has been assigned for any host.
To do this, it checks whether the <code>check_mk</code> host group contains hosts.
If this is the case, the service should receive the <span class="state2">CRIT</span> state.
If not, everything is <span class="state0">OK</span> and so is the state of the service.</p></div>
<div class="paragraph"><p>Here is the implementation:</p></div>
<div class="listingblock">
<div class="title">~/local/lib/python3/cmk_addons/plugins/myhostgroups/agent_based/myhostgroups.py</div>
<div class="content"><pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">def</span> <span class="tok-nf">check_myhostgroups</span><span class="tok-p">(</span><span class="tok-n">section</span><span class="tok-p">):</span>
    <span class="tok-n">attr</span> <span class="tok-o">=</span> <span class="tok-n">section</span><span class="tok-o">.</span><span class="tok-n">get</span><span class="tok-p">(</span><span class="tok-s2">"check_mk"</span><span class="tok-p">)</span>
    <span class="tok-n">hosts</span> <span class="tok-o">=</span> <span class="tok-n">attr</span><span class="tok-p">[</span><span class="tok-s2">"members"</span><span class="tok-p">]</span> <span class="tok-k">if</span> <span class="tok-n">attr</span> <span class="tok-k">else</span> <span class="tok-s2">""</span>
    <span class="tok-k">if</span> <span class="tok-n">hosts</span><span class="tok-p">:</span>
        <span class="tok-k">yield</span> <span class="tok-n">Result</span><span class="tok-p">(</span><span class="tok-n">state</span><span class="tok-o">=</span><span class="tok-n">State</span><span class="tok-o">.</span><span class="tok-n">CRIT</span><span class="tok-p">,</span> <span class="tok-n">summary</span><span class="tok-o">=</span><span class="tok-sa">f</span><span class="tok-s2">"Default group is not empty; Current member list: </span><span class="tok-si">{</span><span class="tok-n">hosts</span><span class="tok-si">}</span><span class="tok-s2">"</span><span class="tok-p">)</span>
    <span class="tok-k">else</span><span class="tok-p">:</span>
        <span class="tok-k">yield</span> <span class="tok-n">Result</span><span class="tok-p">(</span><span class="tok-n">state</span><span class="tok-o">=</span><span class="tok-n">State</span><span class="tok-o">.</span><span class="tok-n">OK</span><span class="tok-p">,</span> <span class="tok-n">summary</span><span class="tok-o">=</span><span class="tok-s2">"Everything is fine"</span><span class="tok-p">)</span></code></pre></div>
</div>
<div class="paragraph"><p>And now the explanation:
The <code>check_myhostgroups()</code> function first fetches the value belonging to the <code>check_mk</code> key into the <code>attr</code> variable.
Then the <code>hosts</code> variable is linked to the <code>members</code> value if it exists.
If there are no <code>members</code>, <code>hosts</code> remains empty.</p></div>
<div class="paragraph"><p>This is followed by an <code>if</code> query for the actual evaluation:</p></div>
<div class="ulist"><ul>
<li><p>If the <code>hosts</code> variable has content, i.e. the <code>check_mk</code> host group is not empty, the state of the service goes to <span class="state2">CRIT</span> and an advisory text is output.
This text also contains a list of the host names of all hosts that are in the <code>check_mk</code> host group.
The Python <a href="https://docs.python.org/3/tutorial/inputoutput.html#formatted-string-literals" target="_blank">F-String</a> is used to output the text with expressions, which is so named because the string is preceded by the letter <code>f</code>.</p></li>
<li><p>If the <code>hosts</code> variable is empty, i.e. there are no hosts in the <code>check_mk</code> host group, the state of the service instead changes to <span class="state0">OK</span>.
In this case, an appropriate message text is also output.</p></li>
</ul></div>
<div class="paragraph"><p>Once the check function has been created, the check plug-in is ready.</p></div>
<div class="paragraph"><p>The <a href="https://github.com/Checkmk/checkmk-docs/blob/master/examples/devel_check_plugins/check_plugin_simple_myhostgroups.py" target="_blank">check plug-in</a>
and as well as the <a href="https://github.com/Checkmk/checkmk-docs/blob/master/examples/devel_check_plugins/agent_plugin_simple_myhostgroups" target="_blank">agent plug-in</a>
have been made available on GitHub.</p></div>
</div>
<div class="sect2">
<h3 id="heading_test">
<span class="hidden-anchor sr-only" id="test"></span>3.7. Testing and activating the check plug-in</h3>
<div class="paragraph"><p>Testing and activation are carried out on the command line with the <code>cmk</code> command.</p></div>
<div class="paragraph"><p>First try the <a href="wato_services.html#commandline">service discovery</a> with the option <code>-I</code>.
By adding the <code>v</code> option (for <em>verbose</em>), detailed output is requested.
The <code>--detect-plugins</code> restricts the command execution to this check plug-in and through <code>localhost</code> to this host:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="console"><span></span><span class="tok-gp">OMD[mysite]:~$ </span>cmk<span class="tok-w"> </span>-vI<span class="tok-w"> </span>--detect-plugins<span class="tok-o">=</span>myhostgroups<span class="tok-w"> </span>localhost
<span class="tok-go">Discovering services and host labels on: localhost</span>
<span class="tok-go">localhost:</span>
<span class="tok-go">+ FETCHING DATA</span>
<span class="tok-go">No piggyback files for 'localhost'. Skip processing.</span>
<span class="tok-go">Get piggybacked data</span>
<span class="tok-go">+ ANALYSE DISCOVERED HOST LABELS</span>
<span class="tok-go">SUCCESS - Found no new host labels</span>
<span class="tok-go">+ ANALYSE DISCOVERED SERVICES</span>
<span class="hll"><span class="tok-go">+ EXECUTING DISCOVERY PLUGINS (1)</span>
</span><span class="hll"><span class="tok-go">  1 myhostgroups</span>
</span><span class="hll"><span class="tok-go">SUCCESS - Found 1 services</span>
</span></code></pre></div></div>
<div class="paragraph"><p>As planned, the service discovery recognizes a new service in the <code>myhostgroups</code> check plug-in.</p></div>
<div class="paragraph"><p>Now you can <a href="cmk_commandline.html#execute_checks">try out the check</a> contained in the check plug-in:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="console"><span></span><span class="tok-gp">OMD[mysite]:~$ </span>cmk<span class="tok-w"> </span>--detect-plugins<span class="tok-o">=</span>myhostgroups<span class="tok-w"> </span>-v<span class="tok-w"> </span>localhost
<span class="tok-go">+ FETCHING DATA</span>
<span class="tok-go">No piggyback files for 'localhost'. Skip processing.</span>
<span class="tok-go">Get piggybacked data</span>
<span class="hll"><span class="tok-go">Host group check_mk  <span class="red">Default group is not empty; Current member list: localhost</span></span>
</span><span class="tok-go">No piggyback files for 'localhost'. Skip processing.</span>
<span class="tok-go">[agent] Success, [piggyback] Success (but no data found for this host), execution time 1.8 sec | execution_time=1.800 user_time=0.030 system_time=0.000 children_user_time=0.000 children_system_time=0.000 cmk_time_agent=1.780</span></code></pre></div></div>
<div class="paragraph"><p>By executing the check, the state of the service found previously will be determined.</p></div>
<div class="paragraph"><p>If everything went as expected, you can activate the changes.
If not, you will find helpful information in the chapter on <a href="#errors">troubleshooting</a>.</p></div>
<div class="paragraph"><p>Finally, activate the changes by <a href="cmk_commandline.html#commands_core">restarting the monitoring core</a>:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="console"><span></span><span class="tok-gp">OMD[mysite]:~$ </span>cmk<span class="tok-w"> </span>-R
<span class="tok-go">Generating configuration for core (type nagios)...</span>
<span class="tok-go">Precompiling host checks...OK</span>
<span class="tok-go">Validating Nagios configuration...OK</span>
<span class="tok-go">Restarting monitoring core...OK</span></code></pre></div></div>
<div class="paragraph"><p>In the Checkmk monitoring, you will now find the new service <span class="guihint">Host group check_mk</span> at the host <code>localhost</code>:</p></div>
<div class="imageblock">
<div class="content"><img src="../images/devel_cpi_service_simple.png" alt="The new service created in the monitoring by the check plug-in."></div>
<div class="title">Since the host group <code>check_mk</code> is not empty, the service is <span class="state2">CRIT</span>
</div>
</div>
<div class="paragraph"><p>Congratulations on the successful creation of your first check plug-in!</p></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="heading_extend">
<span class="hidden-anchor sr-only" id="extend"></span>4. Extending the check plug-in</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="heading_prepare">
<span class="hidden-anchor sr-only" id="prepare"></span>4.1. Preparatory work</h3>
<div class="paragraph"><p>The recently completed first check plug-in is now to be extended step by step.
So far, the agent plug-in has only provided information on the names and members within the host groups.
In order to be able to evaluate the status of the hosts and the services running on them, for example, more data is required.</p></div>
<div class="sect3">
<h4 id="heading__extending_the_agent_plug_in">
<span class="hidden-anchor sr-only" id="_extending_the_agent_plug_in"></span>Extending the agent plug-in</h4>
<div class="paragraph"><p>You will first extend the agent plug-in <em>once</em> to collect all of the information that will be needed to extend the check plug-in in the following sections.</p></div>
<div class="paragraph"><p>To find out what information Checkmk provides for host groups,
you can query all available columns of the host group table with the <a href="livestatus.html#columns">following command</a> as site user:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="console"><span></span><span class="tok-gp">OMD[mysite]:~$ </span>lq<span class="tok-w"> </span><span class="tok-s2">"GET columns\nFilter: table = hostgroups\nColumns: name"</span>
<span class="tok-go">action_url</span>
<span class="tok-go">alias</span>
<span class="tok-go">members</span>
<span class="tok-go">members_with_state</span>
<span class="tok-go">name</span>
<span class="tok-go">notes</span>
<span class="tok-go">notes_url</span>
<span class="tok-go">num_hosts</span>
<span class="tok-go">...</span></code></pre></div></div>
<div class="paragraph"><p>The output goes even further.
The table has almost 30 columns - and most of the columns even have names that are meaningful.
The following columns are of interest here:
Number of hosts per group (column <code>num_hosts</code>), number of hosts in the <span class="hstate0">UP</span> state (<code>num_hosts_up</code>), number of services of all hosts in the group (<code>num_services</code>) and number of services in the <span class="state0">OK</span> state (<code>num_services_ok</code>).</p></div>
<div class="paragraph"><p>Now these new columns only need to be supplied by the agent.
You can achieve this by extending the <a href="#agentplugin">agent plug-in</a> created in the previous chapter.</p></div>
<div class="paragraph"><p>As the root user, edit the agent plug-in’s script.
Since the script has already put the configurable values into variables, it is sufficient to only change the line beginning with <code>columns</code> and enter the four additional columns retrieved there:</p></div>
<div class="listingblock">
<div class="title">/usr/lib/check_mk_agent/plugins/myhostgroups</div>
<div class="content"><pre class="pygments highlight"><code><span></span>#!/bin/bash

<span class="hll">columns="name members num_hosts num_hosts_up num_services num_services_ok"
</span>site="mysite"

echo '&lt;&lt;&lt;myhostgroups:sep(59)&gt;&gt;&gt;'
su - ${site} lq "GET hostgroups\nColumns: ${columns}"</code></pre></div>
</div>
<div class="paragraph"><p>Run the script to verify this:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="console"><span></span><span class="tok-gp">root@linux# </span>/usr/lib/check_mk_agent/plugins/myhostgroups
<span class="tok-go">&lt;&lt;&lt;myhostgroups:sep(59)&gt;&gt;&gt;</span>
<span class="tok-go">Munich;myhost3,myhost2,myhost1;3;3;180;144</span>
<span class="tok-go">Hamburg;myhost22,myhost33,myhost11;3;2;132;105</span>
<span class="tok-go">check_mk;localhost;1;1;62;45</span></code></pre></div></div>
<div class="paragraph"><p>The four new values — each separated by a semicolon — now appear at the end of each line.</p></div>
<div class="paragraph"><p>With this change, the agent plug-in now provides different data than before.
At this point, it is important to make sure that with the changed data, the check plug-in still does what it is supposed to do.</p></div>
</div>
<div class="sect3">
<h4 id="heading__extending_the_parse_function">
<span class="hidden-anchor sr-only" id="_extending_the_parse_function"></span>Extending the parse function</h4>
<div class="paragraph"><p>In a check plug-in, the parse function is responsible for converting the data supplied by the agent plug-in.
With <a href="#parse_function">writing the parse function</a>, you have only considered two columns of the host group table.
Now six columns are supplied instead of two.
The parse function must therefore be customized to process the additional four columns.</p></div>
<div class="paragraph"><p>As the site user, change the parse function in the <code>myhostgroups.py</code> file, which contains the check plug-in:</p></div>
<div class="listingblock">
<div class="title">~/local/lib/python3/cmk_addons/plugins/myhostgroups/agent_based/myhostgroups.py</div>
<div class="content"><pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">def</span> <span class="tok-nf">parse_myhostgroups</span><span class="tok-p">(</span><span class="tok-n">string_table</span><span class="tok-p">):</span>
    <span class="tok-n">parsed</span> <span class="tok-o">=</span> <span class="tok-p">{}</span>
<span class="hll">    <span class="tok-n">column_names</span> <span class="tok-o">=</span> <span class="tok-p">[</span>
</span><span class="hll">        <span class="tok-s2">"name"</span><span class="tok-p">,</span>
</span><span class="hll">        <span class="tok-s2">"members"</span><span class="tok-p">,</span>
</span><span class="hll">        <span class="tok-s2">"num_hosts"</span><span class="tok-p">,</span>
</span><span class="hll">        <span class="tok-s2">"num_hosts_up"</span><span class="tok-p">,</span>
</span><span class="hll">        <span class="tok-s2">"num_services"</span><span class="tok-p">,</span>
</span><span class="hll">        <span class="tok-s2">"num_services_ok"</span><span class="tok-p">,</span>
</span><span class="hll">    <span class="tok-p">]</span>
</span><span class="hll">    <span class="tok-k">for</span> <span class="tok-n">line</span> <span class="tok-ow">in</span> <span class="tok-n">string_table</span><span class="tok-p">:</span>
</span><span class="hll">        <span class="tok-n">parsed</span><span class="tok-p">[</span><span class="tok-n">line</span><span class="tok-p">[</span><span class="tok-mi">0</span><span class="tok-p">]]</span> <span class="tok-o">=</span> <span class="tok-p">{}</span>
</span><span class="hll">        <span class="tok-k">for</span> <span class="tok-n">n</span> <span class="tok-ow">in</span> <span class="tok-nb">range</span><span class="tok-p">(</span><span class="tok-mi">1</span><span class="tok-p">,</span> <span class="tok-nb">len</span><span class="tok-p">(</span><span class="tok-n">column_names</span><span class="tok-p">)):</span>
</span><span class="hll">            <span class="tok-n">parsed</span><span class="tok-p">[</span><span class="tok-n">line</span><span class="tok-p">[</span><span class="tok-mi">0</span><span class="tok-p">]][</span><span class="tok-n">column_names</span><span class="tok-p">[</span><span class="tok-n">n</span><span class="tok-p">]]</span> <span class="tok-o">=</span> <span class="tok-n">line</span><span class="tok-p">[</span><span class="tok-n">n</span><span class="tok-p">]</span>
</span>    <span class="tok-k">return</span> <span class="tok-n">parsed</span></code></pre></div>
</div>
<div class="paragraph"><p>Everything between <code>parsed = {}</code> and <code>return parsed</code> has been changed here.
First, the columns to be processed are defined under their names as a <code>column_names</code> list.
A dictionary is then created in the <code>for</code> loop by generating the key-value pairs in each line from the column name and the value read.</p></div>
<div class="paragraph"><p>This extension is not critical for the existing <a href="#check_function">check function</a>, as the data structure in the first two columns remains unchanged.
Only additional columns are being provided, which are not (yet) evaluated in the check function.</p></div>
<div class="paragraph"><p>Now that the new data can be processed, you will also use this data.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="heading_discovery">
<span class="hidden-anchor sr-only" id="discovery"></span>4.2. Service discovery</h3>
<div class="paragraph"><p>In the <a href="#check_function">previous chapter</a> you have built a very simple check that creates a service on a host.
However, it is also very common for there to be several services from a single check on a host.</p></div>
<div class="paragraph"><p>The most common example of this is a service for a file system on a host.
The check plug-in with the name <code>df</code> creates one service per file system on the host.
In order to distinguish these services, the mount point of the file system (for example <code>/var</code>) or the drive letter (for example <code>C:</code>) is incorporated into the name of the service.
This results in a service name such as <code>Filesystem /var</code> or <code>Filesystem C:</code>.
The word <code>/var</code> or <code>C:</code> is referred to here as an <em>item</em>.
We are therefore also talking about a <em>check with items</em>.</p></div>
<div class="paragraph"><p>If you want to build a check with items, you must implement the following functions:</p></div>
<div class="ulist"><ul>
<li><p>The discovery function must generate a service for each of the items that should be monitored on the host.</p></li>
<li><p>You must include the item in the service name using the placeholder <code>%s</code> (e.g. <code>"Filesystem %s"</code>).</p></li>
<li><p>The check function is called once, separately for each item, and receives this as an argument.
From the agent data it must then fish out the relevant data for this item.</p></li>
</ul></div>
<div class="paragraph"><p>To test this in practice, you will create a separate service for each existing host group.</p></div>
<div class="paragraph"><p>Since the <code>myhostgroups</code> check plug-in created in the previous chapter for checking the standard <code>check_mk</code> group should continue to function, this check plug-in remains as it is.
For the extension, create the new check plug-in <code>myhostgroups_advanced</code> in the existing file <code>myhostgroups.py</code>. — in the first step as <a href="#check_plug-in">previously</a> by creating an instance of the class <code>CheckPlugin</code>.</p></div>
<div class="paragraph"><p>Here you can find the old code and the new code highlighted:</p></div>
<div class="listingblock">
<div class="title">~/local/lib/python3/cmk_addons/plugins/myhostgroups/agent_based/myhostgroups.py</div>
<div class="content"><pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-n">check_plugin_myhostgroups</span> <span class="tok-o">=</span> <span class="tok-n">CheckPlugin</span><span class="tok-p">(</span>
    <span class="tok-n">name</span> <span class="tok-o">=</span> <span class="tok-s2">"myhostgroups"</span><span class="tok-p">,</span>
    <span class="tok-n">service_name</span> <span class="tok-o">=</span> <span class="tok-s2">"Host group check_mk"</span><span class="tok-p">,</span>
    <span class="tok-n">discovery_function</span> <span class="tok-o">=</span> <span class="tok-n">discover_myhostgroups</span><span class="tok-p">,</span>
    <span class="tok-n">check_function</span> <span class="tok-o">=</span> <span class="tok-n">check_myhostgroups</span><span class="tok-p">,</span>
<span class="tok-p">)</span>
<span class="hll">
</span><span class="hll"><span class="tok-n">check_plugin_myhostgroups_advanced</span> <span class="tok-o">=</span> <span class="tok-n">CheckPlugin</span><span class="tok-p">(</span>
</span><span class="hll">    <span class="tok-n">name</span> <span class="tok-o">=</span> <span class="tok-s2">"myhostgroups_advanced"</span><span class="tok-p">,</span>
</span><span class="hll">    <span class="tok-n">sections</span> <span class="tok-o">=</span> <span class="tok-p">[</span> <span class="tok-s2">"myhostgroups"</span> <span class="tok-p">],</span>
</span><span class="hll">    <span class="tok-n">service_name</span> <span class="tok-o">=</span> <span class="tok-s2">"Host group </span><span class="tok-si">%s</span><span class="tok-s2">"</span><span class="tok-p">,</span>
</span><span class="hll">    <span class="tok-n">discovery_function</span> <span class="tok-o">=</span> <span class="tok-n">discover_myhostgroups_advanced</span><span class="tok-p">,</span>
</span><span class="hll">    <span class="tok-n">check_function</span> <span class="tok-o">=</span> <span class="tok-n">check_myhostgroups_advanced</span><span class="tok-p">,</span>
</span><span class="hll"><span class="tok-p">)</span>
</span></code></pre></div>
</div>
<div class="paragraph"><p>So that the new check plug-in can be distinguished from the old one, it is given a unique name with <code>myhostgroups_advanced</code>.
The <code>sections</code> parameter determines the sections of the agent output that the check plug-in subscribes to.
Here, <code>myhostgroups</code> is used to specify that the new check plug-in uses the same data as the old one: the section of the agent plug-in prepared by the parse function.
The service name now contains the placeholder <code>%s</code>.
The name of the item is later inserted at this point by Checkmk.
In the last two lines, the names for the new discovery function and the new check function are defined, both of which still need to be written.</p></div>
<div class="paragraph"><p>First to the discovery function, which now has the task of determining the items to be monitored - this is also entered <em>in addition</em> to the existing one:</p></div>
<div class="listingblock">
<div class="title">~/local/lib/python3/cmk_addons/plugins/myhostgroups/agent_based/myhostgroups.py</div>
<div class="content"><pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">def</span> <span class="tok-nf">discover_myhostgroups_advanced</span><span class="tok-p">(</span><span class="tok-n">section</span><span class="tok-p">):</span>
    <span class="tok-k">for</span> <span class="tok-n">group</span> <span class="tok-ow">in</span> <span class="tok-n">section</span><span class="tok-p">:</span>
        <span class="tok-k">if</span> <span class="tok-n">group</span> <span class="tok-o">!=</span> <span class="tok-s2">"check_mk"</span><span class="tok-p">:</span>
            <span class="tok-k">yield</span> <span class="tok-n">Service</span><span class="tok-p">(</span><span class="tok-n">item</span><span class="tok-o">=</span><span class="tok-n">group</span><span class="tok-p">)</span></code></pre></div>
</div>
<div class="paragraph"><p>As with <a href="#discovery_function">previously</a>, the discovery function receives the <code>section</code> argument.
The individual host groups are run through in a loop.
All host groups are of interest here — with the exception of <code>check_mk</code>, as this special host group has already been taken care of by the existing <code>myhostgroups</code> check plug-in.
Whenever an item is found, it is returned with <code>yield</code>, which creates an object of the type <code>Service</code>, that in turn receives the host group name as an item.</p></div>
<div class="paragraph"><p>If the host is monitored later, the check function is called separately for each service — and therefore for each item.
This brings you to the definition of the check function for the new <code>myhostgroups_advanced</code> check plug-in.
The check function receives the <code>item</code> argument in addition to the section.
The first line of the function then looks like this:</p></div>
<div class="listingblock">
<div class="title">~/local/lib/python3/cmk_addons/plugins/myhostgroups/agent_based/myhostgroups.py</div>
<div class="content"><pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">def</span> <span class="tok-nf">check_myhostgroups_advanced</span><span class="tok-p">(</span><span class="tok-n">item</span><span class="tok-p">,</span> <span class="tok-n">section</span><span class="tok-p">):</span></code></pre></div>
</div>
<div class="paragraph"><p>The algorithm for the check function is simple:
If the host group exists, the service is set to <span class="state0">OK</span> and the number and names of the hosts in the group are listed.
The complete function for this:</p></div>
<div class="listingblock">
<div class="title">~/local/lib/python3/cmk_addons/plugins/myhostgroups/agent_based/myhostgroups.py</div>
<div class="content"><pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">def</span> <span class="tok-nf">check_myhostgroups_advanced</span><span class="tok-p">(</span><span class="tok-n">item</span><span class="tok-p">,</span> <span class="tok-n">section</span><span class="tok-p">):</span>
    <span class="tok-n">attr</span> <span class="tok-o">=</span> <span class="tok-n">section</span><span class="tok-o">.</span><span class="tok-n">get</span><span class="tok-p">(</span><span class="tok-n">item</span><span class="tok-p">)</span>
    <span class="tok-k">if</span> <span class="tok-n">attr</span><span class="tok-p">:</span>
        <span class="tok-k">yield</span> <span class="tok-n">Result</span><span class="tok-p">(</span><span class="tok-n">state</span><span class="tok-o">=</span><span class="tok-n">State</span><span class="tok-o">.</span><span class="tok-n">OK</span><span class="tok-p">,</span> <span class="tok-n">summary</span><span class="tok-o">=</span><span class="tok-sa">f</span><span class="tok-s2">"</span><span class="tok-si">{</span><span class="tok-n">attr</span><span class="tok-p">[</span><span class="tok-s1">'num_hosts'</span><span class="tok-p">]</span><span class="tok-si">}</span><span class="tok-s2"> hosts in this group: </span><span class="tok-si">{</span><span class="tok-n">attr</span><span class="tok-p">[</span><span class="tok-s1">'members'</span><span class="tok-p">]</span><span class="tok-si">}</span><span class="tok-s2">"</span><span class="tok-p">)</span></code></pre></div>
</div>
<div class="paragraph"><p>The check result is delivered by returning an object of the class <code>Result</code> via <code>yield</code>.
This requires the parameters <code>state</code> and <code>summary</code>.
Here, <code>state</code> defines the state of the service (in the example <code>OK</code>) and <code>summary</code> the text that is displayed in the <span class="guihint">Summary</span> of the service.
This is purely informative and is not evaluated further by Checkmk.
You can find out more about this in <a href="#summary_details">next section</a>.</p></div>
<div class="paragraph"><p>So far, so good.
But what happens if the item you are looking for is not found?
This can happen if a service has already been created for a host group in the past, but this host group has now disappeared — either because the host group still exists in Checkmk but no longer contains a host, or because it has been deleted completely.
In both cases, this host group will no longer be present in the agent output.</p></div>
<div class="paragraph"><p>The good news:
Checkmk takes care of this!
If a searched for item is not found, Checkmk automatically generates the result <code>UNKNOWN - Item not found in monitoring data</code> for the service.
This is intentional and a good thing.
If a searched item is not found, you can simply run Python out of the function and let Checkmk do its work.</p></div>
<div class="paragraph"><p>Checkmk only knows that the item that was there before is now gone.
Checkmk does not know the reason for this — but you do.
It is therefore appropriate to not keep such knowledge to yourself and to intercept this condition in the check function and to display a helpful message.</p></div>
<div class="listingblock">
<div class="title">~/local/lib/python3/cmk_addons/plugins/myhostgroups/agent_based/myhostgroups.py</div>
<div class="content"><pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">def</span> <span class="tok-nf">check_myhostgroups_advanced</span><span class="tok-p">(</span><span class="tok-n">item</span><span class="tok-p">,</span> <span class="tok-n">section</span><span class="tok-p">):</span>
    <span class="tok-n">attr</span> <span class="tok-o">=</span> <span class="tok-n">section</span><span class="tok-o">.</span><span class="tok-n">get</span><span class="tok-p">(</span><span class="tok-n">item</span><span class="tok-p">)</span>
<span class="hll">    <span class="tok-k">if</span> <span class="tok-ow">not</span> <span class="tok-n">attr</span><span class="tok-p">:</span>
</span><span class="hll">        <span class="tok-k">yield</span> <span class="tok-n">Result</span><span class="tok-p">(</span><span class="tok-n">state</span><span class="tok-o">=</span><span class="tok-n">State</span><span class="tok-o">.</span><span class="tok-n">CRIT</span><span class="tok-p">,</span> <span class="tok-n">summary</span><span class="tok-o">=</span><span class="tok-s2">"Group is empty or has been deleted"</span><span class="tok-p">)</span>
</span><span class="hll">        <span class="tok-k">return</span>
</span>
    <span class="tok-k">yield</span> <span class="tok-n">Result</span><span class="tok-p">(</span><span class="tok-n">state</span><span class="tok-o">=</span><span class="tok-n">State</span><span class="tok-o">.</span><span class="tok-n">OK</span><span class="tok-p">,</span> <span class="tok-n">summary</span><span class="tok-o">=</span><span class="tok-sa">f</span><span class="tok-s2">"</span><span class="tok-si">{</span><span class="tok-n">attr</span><span class="tok-p">[</span><span class="tok-s1">'num_hosts'</span><span class="tok-p">]</span><span class="tok-si">}</span><span class="tok-s2"> hosts in this group: </span><span class="tok-si">{</span><span class="tok-n">attr</span><span class="tok-p">[</span><span class="tok-s1">'members'</span><span class="tok-p">]</span><span class="tok-si">}</span><span class="tok-s2">"</span><span class="tok-p">)</span></code></pre></div>
</div>
<div class="paragraph"><p>What has changed?
The error condition is now handled first.
Therefore, check in the <code>if</code> branch if the item really <em>does not</em> exist, set the state to <span class="state2">CRIT</span> and exit the function with <code>return</code>.
In all other cases, return <span class="state0">OK</span> as before.</p></div>
<div class="paragraph"><p>This means that you have adopted the disappearing host groups situation into the check function.
Instead of <span class="state3">UNKNOWN</span>, the associated service will now be <span class="state2">CRIT</span> and contain information on the cause of the critical state.</p></div>
<div class="paragraph"><p>This completes the new check plug-in as an extension of the old one.
The extended <a href="https://github.com/Checkmk/checkmk-docs/blob/master/examples/devel_check_plugins/agent_plugin_advanced_myhostgroups" target="_blank">agent plug-in</a>
and the extended file for the <a href="https://github.com/Checkmk/checkmk-docs/blob/master/examples/devel_check_plugins/check_plugin_advanced_myhostgroups_step01.py" target="_blank">check plug-ins</a>
can again be found on GitHub.
The latter contains the simple check plug-in <code>myhostgroups</code> from the <a href="#write_check_plugin">previous chapter</a>, the advanced parse function and the components of the new check plug-in <code>myhostgroups_advanced</code> with the creation of the check plug-in, the discovery function and the check function.
Note that the functions must always be defined before the creation of check plug-ins or agent sections so that there are no errors due to undefined function names.</p></div>
<div class="paragraph"><p>As the new <code>myhostgroups_advanced</code> check plug-in provides new services, you must perform a service discovery for this check plug-in and activate the changes in order to see these services in the monitoring:</p></div>
<div class="imageblock">
<div class="content"><img src="../images/devel_cpi_service_advanced_01.png" alt="The two new services created by the advanced check plug-in in the monitoring."></div>
<div class="title">Two new services in the monitoring:</div>
</div>
<div class="paragraph"><p>Proceed as described in the <a href="#test">simple check plug-in</a> chapter.
Do not execute the first two commands for <code>myhostgroups</code>, instead execute them for the new <code>myhostgroups_advanced</code> check plug-in.</p></div>
</div>
<div class="sect2">
<h3 id="heading_summary_details">
<span class="hidden-anchor sr-only" id="summary_details"></span>4.3. Summary and details</h3>
<div class="paragraph"><p>In the monitoring of Checkmk, each service has a state — <span class="state0">OK</span>, <span class="state1">WARN</span>, etc.. — as well as a line of text.
This text is located in the <span class="guihint">Summary</span> column — as can be seen in the previous screenshot — and therefore has the task of providing a brief summary of the service’s state.
The concept is that this text should not exceed a length of 60 characters.
That ensures a concise table display without annoying line breaks.</p></div>
<div class="paragraph"><p>There is also the <span class="guihint">Details</span> field, in which all details on the state of the service are displayed, which also includes all of the summary information.
Clicking on the service opens the service page, in which the two fields <span class="guihint">Summary</span> and <span class="guihint">Details</span> can be seen alongside many others.</p></div>
<div class="paragraph"><p>When calling <code>yield Result(...)</code>, you can determine which information is so important that it should be displayed in the summary, and for which it is sufficient for it to appear in the details.</p></div>
<div class="paragraph"><p>In our example, you have always used a call of the following type:</p></div>
<div class="listingblock">
<div class="title">~/local/lib/python3/cmk_addons/plugins/myhostgroups/agent_based/myhostgroups.py</div>
<div class="content"><pre class="pygments highlight"><code data-lang="python"><span></span>    <span class="tok-k">yield</span> <span class="tok-n">Result</span><span class="tok-p">(</span><span class="tok-n">state</span><span class="tok-o">=</span><span class="tok-n">State</span><span class="tok-o">.</span><span class="tok-n">OK</span><span class="tok-p">,</span> <span class="tok-n">summary</span><span class="tok-o">=</span><span class="tok-sa">f</span><span class="tok-s2">"</span><span class="tok-si">{</span><span class="tok-n">attr</span><span class="tok-p">[</span><span class="tok-s1">'num_hosts'</span><span class="tok-p">]</span><span class="tok-si">}</span><span class="tok-s2"> hosts in this group: </span><span class="tok-si">{</span><span class="tok-n">attr</span><span class="tok-p">[</span><span class="tok-s1">'members'</span><span class="tok-p">]</span><span class="tok-si">}</span><span class="tok-s2">"</span><span class="tok-p">)</span></code></pre></div>
</div>
<div class="paragraph"><p>This means that the text defined as <code>summary</code> always appears in the <span class="guihint">Summary</span> — and also in the <span class="guihint">Details</span>.
You should therefore only use this for important information.
If a host group contains many hosts, the summary list can become very long — longer than the recommended 60 characters.
If a piece of information is of secondary importance, you can use <code>details</code> to specify that its text <em>only</em> appears in the details:</p></div>
<div class="listingblock" id="summary_details_yield">
<div class="title">~/local/lib/python3/cmk_addons/plugins/myhostgroups/agent_based/myhostgroups.py</div>
<div class="content"><pre class="pygments highlight"><code data-lang="python"><span></span>    <span class="tok-k">yield</span> <span class="tok-n">Result</span><span class="tok-p">(</span>
        <span class="tok-n">state</span> <span class="tok-o">=</span> <span class="tok-n">State</span><span class="tok-o">.</span><span class="tok-n">OK</span><span class="tok-p">,</span>
        <span class="tok-n">summary</span> <span class="tok-o">=</span> <span class="tok-sa">f</span><span class="tok-s2">"</span><span class="tok-si">{</span><span class="tok-n">attr</span><span class="tok-p">[</span><span class="tok-s1">'num_hosts'</span><span class="tok-p">]</span><span class="tok-si">}</span><span class="tok-s2"> hosts in this group"</span><span class="tok-p">,</span>
        <span class="tok-n">details</span> <span class="tok-o">=</span> <span class="tok-sa">f</span><span class="tok-s2">"</span><span class="tok-si">{</span><span class="tok-n">attr</span><span class="tok-p">[</span><span class="tok-s1">'num_hosts'</span><span class="tok-p">]</span><span class="tok-si">}</span><span class="tok-s2"> hosts in this group: </span><span class="tok-si">{</span><span class="tok-n">attr</span><span class="tok-p">[</span><span class="tok-s1">'members'</span><span class="tok-p">]</span><span class="tok-si">}</span><span class="tok-s2">"</span><span class="tok-p">,</span>
    <span class="tok-p">)</span></code></pre></div>
</div>
<div class="paragraph"><p>In the example above, the list of hosts is therefore only displayed in the <span class="guihint">Details</span>.
The <span class="guihint">Summary</span> then only shows the number of hosts in the group:</p></div>
<div class="imageblock">
<div class="content"><img src="../images/devel_cpi_service_summary_details.png" alt="'Summary' and 'Details' shown in the service details."></div>
<div class="title">Different content for summary and details in the monitoring</div>
</div>
<div class="paragraph" id="notice"><p>In addition to <code>summary</code> and <code>details</code>, there is a third parameter.
With <code>notice</code> you specify that a text for a service in the <span class="state0">OK</span> is <em>only</em> displayed in the details — but also in the summary for all other states.
This makes it immediately clear from the summary why the service is not <span class="state0">OK</span>.
The <code>notice</code> parameter is not particularly useful if texts are permanently bound to states, as in our example so far.</p></div>
<div class="paragraph"><p>In summary, this means:</p></div>
<div class="ulist"><ul>
<li><p>The total text for the summary should not be longer than 60 characters for services that are <span class="state0">OK</span>.</p></li>
<li><p>Always use <em>either</em> <code>summary</code> or <code>notice</code> — at least one or the other, but <em>not</em> both.</p></li>
<li><p>If required, add <code>details</code> if the text for the details is to be an alternative.</p></li>
</ul></div>
</div>
<div class="sect2">
<h3 id="heading_partial_results">
<span class="hidden-anchor sr-only" id="partial_results"></span>4.4. Multiple partial results per service</h3>
<div class="paragraph"><p>To prevent the number of services on a host from increasing excessively, several partial results are often combined in one service.
For example, the <span class="guihint">Memory</span> service under Linux not only checks RAM and swap usage, but also shared memory, page tables and all sorts of other things.</p></div>
<div class="paragraph"><p>The Check API provides a very convenient interface for this.
A check function can simply generate a result with <code>yield</code> as often as required.
The overall state of the service is then based on the worst partial result in the order <span class="state0">OK</span> → <span class="state1">WARN</span> → <span class="state3">UNKNOWN</span> → <span class="state2">CRIT</span>.</p></div>
<div class="paragraph"><p>In the example, use this option to define two additional results for each service of the host groups in addition to the existing result.
These evaluate the percentage of hosts in the <span class="hstate0">UP</span> state and the services in the <span class="state0">OK</span> state.
You use the additional columns of the host group table <a href="#prepare">previously</a> defined in the agent output and the parse function.</p></div>
<div class="paragraph"><p>Now expand the check function in stages from top to bottom:</p></div>
<div class="listingblock">
<div class="title">~/local/lib/python3/cmk_addons/plugins/myhostgroups/agent_based/myhostgroups.py</div>
<div class="content"><pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">def</span> <span class="tok-nf">check_myhostgroups_advanced</span><span class="tok-p">(</span><span class="tok-n">item</span><span class="tok-p">,</span> <span class="tok-n">section</span><span class="tok-p">):</span>
    <span class="tok-n">attr</span> <span class="tok-o">=</span> <span class="tok-n">section</span><span class="tok-o">.</span><span class="tok-n">get</span><span class="tok-p">(</span><span class="tok-n">item</span><span class="tok-p">)</span>
    <span class="tok-k">if</span> <span class="tok-ow">not</span> <span class="tok-n">attr</span><span class="tok-p">:</span>
        <span class="tok-k">yield</span> <span class="tok-n">Result</span><span class="tok-p">(</span><span class="tok-n">state</span><span class="tok-o">=</span><span class="tok-n">State</span><span class="tok-o">.</span><span class="tok-n">CRIT</span><span class="tok-p">,</span> <span class="tok-n">summary</span><span class="tok-o">=</span><span class="tok-s2">"Group is empty or has been deleted"</span><span class="tok-p">)</span>
        <span class="tok-k">return</span>

    <span class="tok-n">members</span> <span class="tok-o">=</span> <span class="tok-n">attr</span><span class="tok-p">[</span><span class="tok-s2">"members"</span><span class="tok-p">]</span>
    <span class="tok-n">num_hosts</span> <span class="tok-o">=</span> <span class="tok-nb">int</span><span class="tok-p">(</span><span class="tok-n">attr</span><span class="tok-p">[</span><span class="tok-s2">"num_hosts"</span><span class="tok-p">])</span>
    <span class="tok-n">num_hosts_up</span> <span class="tok-o">=</span> <span class="tok-nb">int</span><span class="tok-p">(</span><span class="tok-n">attr</span><span class="tok-p">[</span><span class="tok-s2">"num_hosts_up"</span><span class="tok-p">])</span>
    <span class="tok-n">num_services</span> <span class="tok-o">=</span> <span class="tok-nb">int</span><span class="tok-p">(</span><span class="tok-n">attr</span><span class="tok-p">[</span><span class="tok-s2">"num_services"</span><span class="tok-p">])</span>
    <span class="tok-n">num_services_ok</span> <span class="tok-o">=</span> <span class="tok-nb">int</span><span class="tok-p">(</span><span class="tok-n">attr</span><span class="tok-p">[</span><span class="tok-s2">"num_services_ok"</span><span class="tok-p">])</span></code></pre></div>
</div>
<div class="paragraph"><p>The <code>if</code> branch remains unchanged, i.e. the new partial results only apply to host groups that also exist.
You then define five variables for the columns in the host group table contained in the section.
On the one hand, this increases readability and, on the other hand, you can convert the strings read into numbers with <code>int()</code> for the four columns that are still to be used for the calculation.</p></div>
<div class="paragraph"><p>The only existing result remains (almost) unchanged:</p></div>
<div class="listingblock">
<div class="title">~/local/lib/python3/cmk_addons/plugins/myhostgroups/agent_based/myhostgroups.py</div>
<div class="content"><pre class="pygments highlight"><code data-lang="python"><span></span>    <span class="tok-k">yield</span> <span class="tok-n">Result</span><span class="tok-p">(</span>
        <span class="tok-n">state</span> <span class="tok-o">=</span> <span class="tok-n">State</span><span class="tok-o">.</span><span class="tok-n">OK</span><span class="tok-p">,</span>
        <span class="tok-n">summary</span> <span class="tok-o">=</span> <span class="tok-sa">f</span><span class="tok-s2">"</span><span class="tok-si">{</span><span class="tok-n">num_hosts</span><span class="tok-si">}</span><span class="tok-s2"> hosts in this group"</span><span class="tok-p">,</span>
        <span class="tok-n">details</span> <span class="tok-o">=</span> <span class="tok-sa">f</span><span class="tok-s2">"</span><span class="tok-si">{</span><span class="tok-n">num_hosts</span><span class="tok-si">}</span><span class="tok-s2"> hosts in this group: </span><span class="tok-si">{</span><span class="tok-n">members</span><span class="tok-si">}</span><span class="tok-s2">"</span><span class="tok-p">,</span>
    <span class="tok-p">)</span></code></pre></div>
</div>
<div class="paragraph"><p>Only the access in the Python 'F-String' to the expression that returns the value is now easier than <a href="#summary_details_yield">previously</a>, since the <code>attr</code> is already in the variable definitions.</p></div>
<div class="paragraph"><p>Now to the actual core of the extension, the definition of a result that implements the following statement:
"The service of the host group is <span class="state1">WARN</span> when 90 % of the hosts are <span class="hstate0">UP</span>, and <span class="state2">CRIT</span> when 80 % of the hosts are <span class="hstate0">UP</span>."
The convention here is that the check goes to <span class="state1">WARN</span> or <span class="state2">CRIT</span> as soon as the threshold is <em>reached</em> - and not only when it is exceeded.
The Check API provides the auxiliary <code>check_levels</code> function for comparing a determined value with threshold values.</p></div>
<div class="listingblock">
<div class="title">~/local/lib/python3/cmk_addons/plugins/myhostgroups/agent_based/myhostgroups.py</div>
<div class="content"><pre class="pygments highlight"><code data-lang="python"><span></span>    <span class="tok-n">hosts_up_perc</span> <span class="tok-o">=</span> <span class="tok-mf">100.0</span> <span class="tok-o">*</span> <span class="tok-n">num_hosts_up</span> <span class="tok-o">/</span> <span class="tok-n">num_hosts</span>
    <span class="tok-k">yield from</span> <span class="tok-n">check_levels</span><span class="tok-p">(</span>
        <span class="tok-n">hosts_up_perc</span><span class="tok-p">,</span>
        <span class="tok-n">levels_lower</span> <span class="tok-o">=</span> <span class="tok-p">(</span><span class="tok-s2">"fixed"</span><span class="tok-p">,</span> <span class="tok-p">(</span><span class="tok-mf">90.0</span><span class="tok-p">,</span> <span class="tok-mf">80.0</span><span class="tok-p">)),</span>
        <span class="tok-n">label</span> <span class="tok-o">=</span> <span class="tok-s2">"UP hosts"</span><span class="tok-p">,</span>
        <span class="tok-n">notice_only</span> <span class="tok-o">=</span> <span class="tok-kc">True</span><span class="tok-p">,</span>
    <span class="tok-p">)</span></code></pre></div>
</div>
<div class="paragraph"><p>In the first line, the percentage is calculated from the total number and number of hosts in the <span class="hstate0">UP</span> state and stored in the <code>hosts_up_perc</code> variable.
The single slash (<code>/</code>) executes a floating point division, which ensures that the result is a float value.
This is useful because some of the functions used later on expect float as input.</p></div>
<div class="paragraph"><p>In the second line, the result of the <code>check_levels</code> function is then returned as an object of the type <code>Result</code>, which can be found in the API documentation.
This function is fed with the percentage just calculated as a value (<code>hosts_up_perc</code>), the two lower threshold values (<code>levels_lower</code>), a label that precedes the output (<code>label</code>) and finally with <code>notice_only=True</code>.</p></div>
<div class="paragraph"><p>The last parameter makes use of the <code>notice</code> parameter already introduced in the <a href="#notice">previous section</a> for the <code>Result()</code> object.
With <code>notice_only=True</code> you specify that the text for the service is only displayed in the <span class="guihint">Summary</span> if the state is not <span class="state0">OK</span>.
However, partial results that lead to a <span class="state1">WARN</span> or <span class="state2">CRIT</span> will in any case <em>always</em> be visible in the summary — regardless of the value of <code>notice_only</code>.</p></div>
<div class="paragraph"><p>Finally, you define the third result in the same way as the second, which evaluates the percentage of services in the <span class="state0">OK</span> state:</p></div>
<div class="listingblock">
<div class="title">~/local/lib/python3/cmk_addons/plugins/myhostgroups/agent_based/myhostgroups.py</div>
<div class="content"><pre class="pygments highlight"><code data-lang="python"><span></span>    <span class="tok-n">services_ok_perc</span> <span class="tok-o">=</span> <span class="tok-mf">100.0</span> <span class="tok-o">*</span> <span class="tok-n">num_services_ok</span> <span class="tok-o">/</span> <span class="tok-n">num_services</span>
    <span class="tok-k">yield from</span> <span class="tok-n">check_levels</span><span class="tok-p">(</span>
        <span class="tok-n">services_ok_perc</span><span class="tok-p">,</span>
        <span class="tok-n">levels_lower</span> <span class="tok-o">=</span> <span class="tok-p">(</span><span class="tok-s2">"fixed"</span><span class="tok-p">,</span> <span class="tok-p">(</span><span class="tok-mf">90.0</span><span class="tok-p">,</span> <span class="tok-mf">80.0</span><span class="tok-p">)),</span>
        <span class="tok-n">label</span> <span class="tok-o">=</span> <span class="tok-s2">"OK services"</span><span class="tok-p">,</span>
        <span class="tok-n">notice_only</span> <span class="tok-o">=</span> <span class="tok-kc">True</span><span class="tok-p">,</span>
    <span class="tok-p">)</span></code></pre></div>
</div>
<div class="paragraph"><p>This completes the check function.</p></div>
<div class="paragraph"><p>The service for a host group now evaluates three results and displays the worst state from these in the monitoring, as in the following example:</p></div>
<div class="imageblock">
<div class="content"><img src="../images/devel_cpi_service_partial_results.png" alt="The summary shows the text for the critical state."></div>
<div class="title">The summary displays the text for the critical state</div>
</div>
</div>
<div class="sect2">
<h3 id="heading_metrics">
<span class="hidden-anchor sr-only" id="metrics"></span>4.5. Metrics</h3>
<div class="paragraph"><p>Not always, but often, checks deal with numbers — and these numbers are very often measured or calculated values.
In our example, the number of hosts in the host group (<code>num_hosts</code>) and the number of hosts in the <span class="hstate0">UP</span> state (<code>num_hosts_up</code>) are the measured values.
The percentage of hosts in the <span class="hstate0">UP</span> state (<code>hosts_up_perc</code>) is a value calculated from these values.
If such a value can then be displayed over a time range, it is also referred to as a <a href="glossar.html#metric">metric</a>.</p></div>
<div class="paragraph"><p>With its built-in <a href="graphing.html">graphing system</a>, Checkmk has a component for storing, evaluating and displaying such values.
This is completely independent of the calculation of the <span class="state0">OK</span>, <span class="state1">WARN</span> and <span class="state2">CRIT</span> states.</p></div>
<div class="paragraph"><p>In this example, you will define the two calculated values, <code>hosts_up_perc</code> and <code>services_ok_perc</code>, as metrics.
Metrics will be immediately visible in  Checkmk’s graphical user interface without you having to do anything.
A graph is automatically generated for each metric.</p></div>
<div class="paragraph"><p>Metrics are determined by the check function and returned as an additional result.
The easiest way is to add the metrics information to the <code>check_levels()</code> function in the call.</p></div>
<div class="paragraph"><p>As a reminder, the lines with the <code>check_levels()</code> function call from the <a href="#partial_results">previous section</a> follow here:</p></div>
<div class="listingblock">
<div class="title">~/local/lib/python3/cmk_addons/plugins/myhostgroups/agent_based/myhostgroups.py</div>
<div class="content"><pre class="pygments highlight"><code data-lang="python"><span></span>    <span class="tok-k">yield from</span> <span class="tok-n">check_levels</span><span class="tok-p">(</span>
        <span class="tok-n">hosts_up_perc</span><span class="tok-p">,</span>
        <span class="tok-n">levels_lower</span> <span class="tok-o">=</span> <span class="tok-p">(</span><span class="tok-s2">"fixed"</span><span class="tok-p">,</span> <span class="tok-p">(</span><span class="tok-mf">90.0</span><span class="tok-p">,</span> <span class="tok-mf">80.0</span><span class="tok-p">)),</span>
        <span class="tok-n">label</span> <span class="tok-o">=</span> <span class="tok-s2">"UP hosts"</span><span class="tok-p">,</span>
        <span class="tok-n">notice_only</span> <span class="tok-o">=</span> <span class="tok-kc">True</span><span class="tok-p">,</span>
    <span class="tok-p">)</span></code></pre></div>
</div>
<div class="paragraph"><p>The two new arguments for the metric are <code>metric_name</code> and <code>boundaries</code>:</p></div>
<div class="listingblock">
<div class="title">~/local/lib/python3/cmk_addons/plugins/myhostgroups/agent_based/myhostgroups.py</div>
<div class="content"><pre class="pygments highlight"><code data-lang="python"><span></span>    <span class="tok-k">yield from</span> <span class="tok-n">check_levels</span><span class="tok-p">(</span>
        <span class="tok-n">hosts_up_perc</span><span class="tok-p">,</span>
        <span class="tok-n">levels_lower</span> <span class="tok-o">=</span> <span class="tok-p">(</span><span class="tok-s2">"fixed"</span><span class="tok-p">,</span> <span class="tok-p">(</span><span class="tok-mf">90.0</span><span class="tok-p">,</span> <span class="tok-mf">80.0</span><span class="tok-p">)),</span>
<span class="hll">        <span class="tok-n">metric_name</span> <span class="tok-o">=</span> <span class="tok-s2">"hosts_up_perc"</span><span class="tok-p">,</span>
</span>        <span class="tok-n">label</span> <span class="tok-o">=</span> <span class="tok-s2">"UP hosts"</span><span class="tok-p">,</span>
<span class="hll">        <span class="tok-n">boundaries</span> <span class="tok-o">=</span> <span class="tok-p">(</span><span class="tok-mf">0.0</span><span class="tok-p">,</span> <span class="tok-mf">100.0</span><span class="tok-p">),</span>
</span>        <span class="tok-n">notice_only</span> <span class="tok-o">=</span> <span class="tok-kc">True</span><span class="tok-p">,</span>
    <span class="tok-p">)</span></code></pre></div>
</div>
<div class="paragraph"><p>To keep things nice and simple and meaningful, for the name of the metric use the name of the variable in which the percentage is stored as a value.</p></div>
<div class="paragraph"><p>You can use <code>boundaries</code> to provide the graphing system with information about the range of possible values.
This refers to the smallest and largest possible value.
In the case of a percentage, the limits of <code>0.0</code> and <code>100.0</code> are not too difficult to determine.
Both floating point numbers and integers (which are converted internally into floating point numbers) are permitted, but not strings.
If only one limit of the value range is defined, simply enter <code>None</code> for the other, for example <code>boundaries = (0.0, None)</code>.</p></div>
<div class="paragraph"><p>With this extension, the <code>check_levels</code> function now also returns an object of the type <code>Metric</code> via <code>yield</code> in addition to the <code>Result</code>.</p></div>
<div class="paragraph"><p>You can now define the metric <code>services_ok_perc</code> in the same way.
The last lines of the check function will then look like this:</p></div>
<div class="listingblock">
<div class="title">~/local/lib/python3/cmk_addons/plugins/myhostgroups/agent_based/myhostgroups.py</div>
<div class="content"><pre class="pygments highlight"><code data-lang="python"><span></span>    <span class="tok-n">hosts_up_perc</span> <span class="tok-o">=</span> <span class="tok-mf">100.0</span> <span class="tok-o">*</span> <span class="tok-n">num_hosts_up</span> <span class="tok-o">/</span> <span class="tok-n">num_hosts</span>
    <span class="tok-k">yield from</span> <span class="tok-n">check_levels</span><span class="tok-p">(</span>
        <span class="tok-n">hosts_up_perc</span><span class="tok-p">,</span>
        <span class="tok-n">levels_lower</span> <span class="tok-o">=</span> <span class="tok-p">(</span><span class="tok-s2">"fixed"</span><span class="tok-p">,</span> <span class="tok-p">(</span><span class="tok-mf">90.0</span><span class="tok-p">,</span> <span class="tok-mf">80.0</span><span class="tok-p">)),</span>
        <span class="tok-n">metric_name</span> <span class="tok-o">=</span> <span class="tok-s2">"hosts_up_perc"</span><span class="tok-p">,</span>
        <span class="tok-n">label</span> <span class="tok-o">=</span> <span class="tok-s2">"UP hosts"</span><span class="tok-p">,</span>
        <span class="tok-n">boundaries</span> <span class="tok-o">=</span> <span class="tok-p">(</span><span class="tok-mf">0.0</span><span class="tok-p">,</span> <span class="tok-mf">100.0</span><span class="tok-p">),</span>
        <span class="tok-n">notice_only</span> <span class="tok-o">=</span> <span class="tok-kc">True</span><span class="tok-p">,</span>
    <span class="tok-p">)</span>
    <span class="tok-n">services_ok_perc</span> <span class="tok-o">=</span> <span class="tok-mf">100.0</span> <span class="tok-o">*</span> <span class="tok-n">num_services_ok</span> <span class="tok-o">/</span> <span class="tok-n">num_services</span>
    <span class="tok-k">yield from</span> <span class="tok-n">check_levels</span><span class="tok-p">(</span>
        <span class="tok-n">services_ok_perc</span><span class="tok-p">,</span>
        <span class="tok-n">levels_lower</span> <span class="tok-o">=</span> <span class="tok-p">(</span><span class="tok-s2">"fixed"</span><span class="tok-p">,</span> <span class="tok-p">(</span><span class="tok-mf">90.0</span><span class="tok-p">,</span> <span class="tok-mf">80.0</span><span class="tok-p">)),</span>
        <span class="tok-n">metric_name</span> <span class="tok-o">=</span> <span class="tok-s2">"services_ok_perc"</span><span class="tok-p">,</span>
        <span class="tok-n">label</span> <span class="tok-o">=</span> <span class="tok-s2">"OK services"</span><span class="tok-p">,</span>
        <span class="tok-n">boundaries</span> <span class="tok-o">=</span> <span class="tok-p">(</span><span class="tok-mf">0.0</span><span class="tok-p">,</span> <span class="tok-mf">100.0</span><span class="tok-p">),</span>
        <span class="tok-n">notice_only</span> <span class="tok-o">=</span> <span class="tok-kc">True</span><span class="tok-p">,</span>
    <span class="tok-p">)</span></code></pre></div>
</div>
<div class="paragraph"><p>With the extended check function, both graphs are visible in the monitoring.
In the service list, the <span class="image-inline"><img src="../images/icons/icon_service_graph.png" alt="Icon for displaying the graphs for a service."></span> icon now shows that there are graphs for the service.
If you point to the icon with the mouse, the graphs will be displayed as a preview.</p></div>
<div class="imageblock">
<div class="content"><img src="../images/devel_cpi_service_graphs.png" alt="The service list with 2 graphs as a preview."></div>
<div class="title">The names of the metrics are used as the titles for the graphs</div>
</div>
<div class="paragraph"><p>An overview of all graphs including their legends and more can be found in the service details.</p></div>
<div class="paragraph"><p>But what do you do if the value for the desired metric has not been defined with the <code>check_levels()</code> function?
You can, of course, define a metric independently of a function call.
The <code>Metric()</code> object, which you can also create directly via its constructor, is used for this purpose.
The alternative definition of a metric for the value <code>hosts_up_perc</code> looks like this:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="python"><span></span>    <span class="tok-k">yield</span> <span class="tok-n">Metric</span><span class="tok-p">(</span>
        <span class="tok-n">name</span> <span class="tok-o">=</span> <span class="tok-s2">"hosts_up_perc"</span><span class="tok-p">,</span>
        <span class="tok-n">value</span> <span class="tok-o">=</span> <span class="tok-n">hosts_up_perc</span><span class="tok-p">,</span>
        <span class="tok-n">levels</span> <span class="tok-o">=</span> <span class="tok-p">(</span><span class="tok-mf">80.0</span><span class="tok-p">,</span> <span class="tok-mf">90.0</span><span class="tok-p">),</span>
        <span class="tok-n">boundaries</span> <span class="tok-o">=</span> <span class="tok-p">(</span><span class="tok-mf">0.0</span><span class="tok-p">,</span> <span class="tok-mf">100.0</span><span class="tok-p">),</span>
    <span class="tok-p">)</span></code></pre></div></div>
<div class="paragraph"><p>The arguments in <code>Metric()</code> are very similar to those in the function call shown above:
Mandatory are the first two arguments for the metric name and the value.
In addition, there are two optional arguments: <code>levels</code> for the threshold values <span class="state1">WARN</span> and <span class="state2">CRIT</span> and <code>boundaries</code> for the value range.</p></div>
<div class="admonitionblock tip"><table><tr>
<td class="icon"><img src="../images/icons/tip.png" alt="Tip"></td>
<td class="content"><div class="paragraph"><p>The specification of <code>levels</code> is only used here as information for displaying the graph.
In the graph, the threshold values are usually drawn as yellow and red lines.
The <code>check_levels</code> function with its specified threshold values is responsible for the actual <em>checking</em>.</p></div></td>
</tr></table></div>
<div class="paragraph"><p>Now use the option of defining not only the two calculated values, but <em>all</em> measured values as metrics using <code>Metric()</code> — in our example, the four measured values from the host group table.
Limit yourself to the two obligatory specifications of metric name and value.
The four new lines complete the extension of the check function for metrics:</p></div>
<div class="listingblock">
<div class="title">~/local/lib/python3/cmk_addons/plugins/myhostgroups/agent_based/myhostgroups.py</div>
<div class="content"><pre class="pygments highlight"><code data-lang="python"><span></span>    <span class="tok-n">hosts_up_perc</span> <span class="tok-o">=</span> <span class="tok-mf">100.0</span> <span class="tok-o">*</span> <span class="tok-n">num_hosts_up</span> <span class="tok-o">/</span> <span class="tok-n">num_hosts</span>
    <span class="tok-k">yield from</span> <span class="tok-n">check_levels</span><span class="tok-p">(</span>
        <span class="tok-n">hosts_up_perc</span><span class="tok-p">,</span>
        <span class="tok-n">levels_lower</span> <span class="tok-o">=</span> <span class="tok-p">(</span><span class="tok-mf">90.0</span><span class="tok-p">,</span> <span class="tok-mf">80.0</span><span class="tok-p">),</span>
        <span class="tok-n">metric_name</span> <span class="tok-o">=</span> <span class="tok-s2">"hosts_up_perc"</span><span class="tok-p">,</span>
        <span class="tok-n">label</span> <span class="tok-o">=</span> <span class="tok-s2">"UP hosts"</span><span class="tok-p">,</span>
        <span class="tok-n">boundaries</span> <span class="tok-o">=</span> <span class="tok-p">(</span><span class="tok-mf">0.0</span><span class="tok-p">,</span> <span class="tok-mf">100.0</span><span class="tok-p">),</span>
        <span class="tok-n">notice_only</span> <span class="tok-o">=</span> <span class="tok-kc">True</span><span class="tok-p">,</span>
    <span class="tok-p">)</span>
    <span class="tok-n">services_ok_perc</span> <span class="tok-o">=</span> <span class="tok-mf">100.0</span> <span class="tok-o">*</span> <span class="tok-n">num_services_ok</span> <span class="tok-o">/</span> <span class="tok-n">num_services</span>
    <span class="tok-k">yield from</span> <span class="tok-n">check_levels</span><span class="tok-p">(</span>
        <span class="tok-n">services_ok_perc</span><span class="tok-p">,</span>
        <span class="tok-n">levels_lower</span> <span class="tok-o">=</span> <span class="tok-p">(</span><span class="tok-mf">90.0</span><span class="tok-p">,</span> <span class="tok-mf">80.0</span><span class="tok-p">),</span>
        <span class="tok-n">metric_name</span> <span class="tok-o">=</span> <span class="tok-s2">"services_ok_perc"</span><span class="tok-p">,</span>
        <span class="tok-n">label</span> <span class="tok-o">=</span> <span class="tok-s2">"OK services"</span><span class="tok-p">,</span>
        <span class="tok-n">boundaries</span> <span class="tok-o">=</span> <span class="tok-p">(</span><span class="tok-mf">0.0</span><span class="tok-p">,</span> <span class="tok-mf">100.0</span><span class="tok-p">),</span>
        <span class="tok-n">notice_only</span> <span class="tok-o">=</span> <span class="tok-kc">True</span><span class="tok-p">,</span>
    <span class="tok-p">)</span>

    <span class="tok-k">yield</span> <span class="tok-n">Metric</span><span class="tok-p">(</span><span class="tok-n">name</span><span class="tok-o">=</span><span class="tok-s2">"num_hosts"</span><span class="tok-p">,</span> <span class="tok-n">value</span><span class="tok-o">=</span><span class="tok-n">num_hosts</span><span class="tok-p">)</span>
    <span class="tok-k">yield</span> <span class="tok-n">Metric</span><span class="tok-p">(</span><span class="tok-n">name</span><span class="tok-o">=</span><span class="tok-s2">"num_hosts_up"</span><span class="tok-p">,</span> <span class="tok-n">value</span><span class="tok-o">=</span><span class="tok-n">num_hosts_up</span><span class="tok-p">)</span>
    <span class="tok-k">yield</span> <span class="tok-n">Metric</span><span class="tok-p">(</span><span class="tok-n">name</span><span class="tok-o">=</span><span class="tok-s2">"num_services"</span><span class="tok-p">,</span> <span class="tok-n">value</span><span class="tok-o">=</span><span class="tok-n">num_services</span><span class="tok-p">)</span>
    <span class="tok-k">yield</span> <span class="tok-n">Metric</span><span class="tok-p">(</span><span class="tok-n">name</span><span class="tok-o">=</span><span class="tok-s2">"num_services_ok"</span><span class="tok-p">,</span> <span class="tok-n">value</span><span class="tok-o">=</span><span class="tok-n">num_services_ok</span><span class="tok-p">)</span></code></pre></div>
</div>
<div class="paragraph"><p>This increases the number of graphs per service, but also gives you the option of combining multiple metrics in a single graph, for example.
We show these and other options in the section <a href="#metrics_advanced">Customizing the display of metrics</a> below.</p></div>
<div class="paragraph"><p>In the example file at
<a href="https://github.com/Checkmk/checkmk-docs/blob/master/examples/devel_check_plugins/check_plugin_advanced_myhostgroups_step02.py" target="_blank">GitHub</a>
you can find the entire check function again.</p></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="heading_rule_set">
<span class="hidden-anchor sr-only" id="rule_set"></span>5. Rule sets for check parameters</h2>
<div class="sectionbody">
<div class="paragraph"><p>In the extended <code>myhostgroups_advanced</code> check plug-in you will have generated the <span class="state1">WARN</span> state if only 90 % of the hosts are <span class="hstate0">UP</span>, and <span class="state2">CRIT</span> for 80 %.
In this case, the numbers <code>90</code> and <code>80</code> are defined explicitly in the check function, or, as programmers would say, <em>hard-coded</em>.
In Checkmk, however, users are used to being able to configure such threshold values and other check parameters via <a href="glossar.html#rule">rules</a>.
For example, if a host group only has four members, then the two threshold values of 90 % and 80 % do not really fit well,
since the percentage will drop to 75 % as soon as the first host fails and the state will go directly to <span class="state2">CRIT</span> — without an intermediate <span class="state1">WARN</span> state.</p></div>
<div class="paragraph"><p>Therefore, the check plug-in should now be modified so that it can be configured via the <span class="guihint">Setup</span> interface.
To do this, you will need a <a href="glossar.html#rule_set">rule set</a>.</p></div>
<div class="paragraph"><p>To create a rule set <em>for</em> a check plug-in you exit from the check plug-in development and switch the directory, file and API.
From Checkmk <span class="new">2.3.0</span> the <strong>Rulesets API</strong> supports you in creating such rule sets for check plug-ins.
The API documentation for rule sets can be found in your Checkmk site on the same page as the <a href="#check_api_doc">Check API</a> under <span class="guihint">Rulesets &gt; Version 1</span>.</p></div>
<div class="sect2">
<h3 id="heading_new_ruleset">
<span class="hidden-anchor sr-only" id="new_ruleset"></span>5.1. Defining a new rule set</h3>
<div class="paragraph"><p>To create a new rule set, first create a new subdirectory in the plug-in family’s directory <code>~/local/lib/python3/cmk_addons/plugins/myhostgroups/</code>.
The name <code>rulesets</code> is predefined for this subdirectory:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="console"><span></span><span class="tok-gp">OMD[mysite]:~$ </span>mkdir<span class="tok-w"> </span>-p<span class="tok-w"> </span>local/lib/python3/cmk_addons/plugins/myhostgroups/rulesets
<span class="tok-gp">OMD[mysite]:~$ </span><span class="tok-nb">cd</span><span class="tok-w"> </span>local/lib/python3/cmk_addons/plugins/myhostgroups/rulesets</code></pre></div></div>
<div class="paragraph"><p>In this directory, you then create a file for the definition of the rule set.
The name of the file should be based on that of the check plug-in and, like all plug-in files, must have the <code>py</code> extension.
For our example, the file name <code>ruleset_myhostgroups.py</code> is suitable.</p></div>
<div class="paragraph"><p>Let’s take a step by step look at the structure of this file.
First there are some import commands:</p></div>
<div class="listingblock">
<div class="title">~/local/lib/python3/cmk_addons/plugins/myhostgroups/rulesets/ruleset_myhostgroups.py</div>
<div class="content"><pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-kn">from</span> <span class="tok-nn">cmk.rulesets.v1</span> <span class="tok-kn">import</span> <span class="tok-n">Label</span><span class="tok-p">,</span> <span class="tok-n">Title</span>
<span class="tok-kn">from</span> <span class="tok-nn">cmk.rulesets.v1.form_specs</span> <span class="tok-kn">import</span> <span class="tok-n">BooleanChoice</span><span class="tok-p">,</span> <span class="tok-n">DefaultValue</span><span class="tok-p">,</span> <span class="tok-n">DictElement</span><span class="tok-p">,</span> <span class="tok-n">Dictionary</span><span class="tok-p">,</span> <span class="tok-n">Float</span><span class="tok-p">,</span> <span class="tok-n">LevelDirection</span><span class="tok-p">,</span> <span class="tok-n">SimpleLevels</span>
<span class="tok-kn">from</span> <span class="tok-nn">cmk.rulesets.v1.rule_specs</span> <span class="tok-kn">import</span> <span class="tok-n">CheckParameters</span><span class="tok-p">,</span> <span class="tok-n">HostAndItemCondition</span><span class="tok-p">,</span> <span class="tok-n">Topic</span></code></pre></div>
</div>
<div class="paragraph"><p>First, the classes for the texts are imported.</p></div>
<div class="paragraph"><p>The second line makes a selection from the <em>form specs</em>, i.e. the basic elements for the GUI that are used in the rule set, for example, the binary selection (<code>BooleanChoice</code>), the multiple selection (<code>Dictionary</code>, <code>DictElement</code>), the definition of threshold values (<code>SimpleLevel</code>, <code>LevelDirection</code>, <code>DefaultValue</code>) and the input of floating point numbers (<code>Float</code>).
You only request the logical form elements here and leave the design of the GUI to Checkmk.</p></div>
<div class="paragraph"><p>The last line imports the <em>rule specs</em>, which determine the area of application of the rule in Checkmk, i.e. here the definition of check parameters, the assignment to hosts and items and the storage under a <em>topic</em>.
As your check plug-in <code>myhostgroups_advanced</code> generates several services, import <code>HostAndItemCondition</code> here.
If your check does not generate a service, in other words does not have an item, import <code>HostCondition</code> instead.</p></div>
<div class="paragraph"><p>Now come the actual definitions of the form for entering the check parameters.
The user should be able to separately define the two threshold values for <span class="state1">WARN</span> and <span class="state2">CRIT</span> for both the number of hosts in the <span class="hstate0">UP</span> state and for the number of services in the <span class="state0">OK</span> state:</p></div>
<div class="listingblock">
<div class="title">~/local/lib/python3/cmk_addons/plugins/myhostgroups/rulesets/ruleset_myhostgroups.py</div>
<div class="content"><pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">def</span> <span class="tok-nf">_parameter_form</span><span class="tok-p">():</span>
    <span class="tok-k">return</span> <span class="tok-n">Dictionary</span><span class="tok-p">(</span>
        <span class="tok-n">elements</span> <span class="tok-o">=</span> <span class="tok-p">{</span>
            <span class="tok-s2">"hosts_up_lower"</span><span class="tok-p">:</span> <span class="tok-n">DictElement</span><span class="tok-p">(</span>
                <span class="tok-n">parameter_form</span> <span class="tok-o">=</span> <span class="tok-n">SimpleLevels</span><span class="tok-p">(</span>
                    <span class="tok-n">title</span> <span class="tok-o">=</span> <span class="tok-n">Title</span><span class="tok-p">(</span><span class="tok-s2">"Lower percentage threshold for host in UP status"</span><span class="tok-p">),</span>
                    <span class="tok-n">form_spec_template</span> <span class="tok-o">=</span> <span class="tok-n">Float</span><span class="tok-p">(),</span>
                    <span class="tok-n">level_direction</span> <span class="tok-o">=</span> <span class="tok-n">LevelDirection</span><span class="tok-o">.</span><span class="tok-n">LOWER</span><span class="tok-p">,</span>
                    <span class="tok-n">prefill_fixed_levels</span> <span class="tok-o">=</span> <span class="tok-n">DefaultValue</span><span class="tok-p">(</span><span class="tok-n">value</span><span class="tok-o">=</span><span class="tok-p">(</span><span class="tok-mf">90.0</span><span class="tok-p">,</span> <span class="tok-mf">80.0</span><span class="tok-p">)),</span>
                <span class="tok-p">),</span>
                <span class="tok-n">required</span> <span class="tok-o">=</span> <span class="tok-kc">True</span><span class="tok-p">,</span>
            <span class="tok-p">),</span>
            <span class="tok-s2">"services_ok_lower"</span><span class="tok-p">:</span> <span class="tok-n">DictElement</span><span class="tok-p">(</span>
                <span class="tok-n">parameter_form</span> <span class="tok-o">=</span> <span class="tok-n">SimpleLevels</span><span class="tok-p">(</span>
                    <span class="tok-n">title</span> <span class="tok-o">=</span> <span class="tok-n">Title</span><span class="tok-p">(</span><span class="tok-s2">"Lower percentage threshold for services in OK status"</span><span class="tok-p">),</span>
                    <span class="tok-n">form_spec_template</span> <span class="tok-o">=</span> <span class="tok-n">Float</span><span class="tok-p">(),</span>
                    <span class="tok-n">level_direction</span> <span class="tok-o">=</span> <span class="tok-n">LevelDirection</span><span class="tok-o">.</span><span class="tok-n">LOWER</span><span class="tok-p">,</span>
                    <span class="tok-n">prefill_fixed_levels</span> <span class="tok-o">=</span> <span class="tok-n">DefaultValue</span><span class="tok-p">(</span><span class="tok-n">value</span><span class="tok-o">=</span><span class="tok-p">(</span><span class="tok-mf">90.0</span><span class="tok-p">,</span> <span class="tok-mf">80.0</span><span class="tok-p">)),</span>
                <span class="tok-p">),</span>
                <span class="tok-n">required</span> <span class="tok-o">=</span> <span class="tok-kc">True</span><span class="tok-p">,</span>
            <span class="tok-p">),</span>
        <span class="tok-p">}</span>
    <span class="tok-p">)</span></code></pre></div>
</div>
<div class="paragraph"><p>To do this, create a function that generates the dictionary.
You can freely choose the name of the function; it is only required when creating the rule below.
The name should begin with an underscore so that the function is not visible beyond the module boundary.</p></div>
<div class="paragraph"><p>The <code>return Dictionary()</code> is mandatory.
Within it, use <code>elements={}</code> to create the elements of the dictionary, in the example <code>hosts_up_lower</code> and <code>services_ok_lower</code>.
The <code>SimpleLevels</code> parameter form is used to enter fixed threshold values.
In the form, you first define the <code>title</code> and floating point numbers for the values to be entered (<code>form_spec_template</code>).
Use <code>LevelDirection.LOWER</code> to specify that the status will change if the values fall <em>below</em> this level.</p></div>
<div class="paragraph"><p>Finally, you can use <code>prefill_fixed_levels</code> to provide the users of the rule set with values instead of just empty input fields.
Note that these values displayed in the GUI are <em>not</em> the default values that are set further down in the <a href="#ruleset_defaults">creation of the check plug-in</a> via <code>check_default_parameters</code>.
If you want to display the same default values in the GUI that also apply to the check function, you must keep the values consistent in both places.</p></div>
<div class="paragraph"><p>Finally, create the new rule set using the imported and self-defined items.
This is done by creating a new instance of the <code>CheckParameters</code> class.
The name of this instance must begin with <code>rule_spec_</code>:</p></div>
<div class="listingblock">
<div class="title">~/local/lib/python3/cmk_addons/plugins/myhostgroups/rulesets/ruleset_myhostgroups.py</div>
<div class="content"><pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-n">rule_spec_myhostgroups</span> <span class="tok-o">=</span> <span class="tok-n">CheckParameters</span><span class="tok-p">(</span>
    <span class="tok-n">name</span> <span class="tok-o">=</span> <span class="tok-s2">"myhostgroups_advanced"</span><span class="tok-p">,</span>
    <span class="tok-n">title</span> <span class="tok-o">=</span> <span class="tok-n">Title</span><span class="tok-p">(</span><span class="tok-s2">"Host group status"</span><span class="tok-p">),</span>
    <span class="tok-n">topic</span> <span class="tok-o">=</span> <span class="tok-n">Topic</span><span class="tok-o">.</span><span class="tok-n">GENERAL</span><span class="tok-p">,</span>
    <span class="tok-n">parameter_form</span> <span class="tok-o">=</span> <span class="tok-n">_parameter_form</span><span class="tok-p">,</span>
    <span class="tok-n">condition</span> <span class="tok-o">=</span> <span class="tok-n">HostAndItemCondition</span><span class="tok-p">(</span><span class="tok-n">item_title</span><span class="tok-o">=</span><span class="tok-n">Title</span><span class="tok-p">(</span><span class="tok-s2">"Host group name"</span><span class="tok-p">)),</span>
<span class="tok-p">)</span></code></pre></div>
</div>
<div class="paragraph"><p>The following explanations apply:</p></div>
<div class="ulist"><ul>
<li><p>The rule set’s <code>name</code> establishes its connection to the check plug-ins.
A check plug-in that wants to use this rule set must use this name as the <code>check_ruleset_name</code> when it is created.
In order to keep track of a number of new rule sets, it is advisable to use a prefix in the name.</p></li>
<li><p><code>title</code> defines the title of the rule set as it appears in the Checkmk GUI.</p></li>
<li><p>The <code>topic</code> determines where the rule set should appear in the <span class="guihint">Setup</span>.
With the value selected in the example, you will find the rule set under <span class="guihint">Setup &gt; Services &gt; Service monitoring rules</span> in the box <span class="guihint">Various</span>, where it is usually in good hands.</p></li>
<li><p>Enter the name of the previously created function as <code>parameter_form</code>.</p></li>
<li><p>If your check does not use an item, the condition is <code>HostCondition</code> and not <code>HostAndItemCondition</code>, as in the example above.
With the title <code>"Host group name"</code> of the item, you define the label in the GUI with which you can restrict the rule to certain host groups.</p></li>
</ul></div>
</div>
<div class="sect2">
<h3 id="heading_test_ruleset">
<span class="hidden-anchor sr-only" id="test_ruleset"></span>5.2. Testing a rule set</h3>
<div class="paragraph"><p>Once you have created the file for the rule set, you should test whether everything works so far — still without a connection to the check plug-in.
To do this, you must first restart the site’s Apache so that the new file can be read.
This is performed with the command:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="console"><span></span><span class="tok-gp">OMD[mysite]:~$ </span>omd<span class="tok-w"> </span>restart<span class="tok-w"> </span>apache</code></pre></div></div>
<div class="paragraph"><p>The rule set should then be found in <span class="guihint">Setup</span> on the page mentioned above.
You can also find the rule set using the search function in the setup menu — but only after restarting Redis:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="console"><span></span><span class="tok-gp">OMD[mysite]:~$ </span>omd<span class="tok-w"> </span>restart<span class="tok-w"> </span>redis</code></pre></div></div>
<div class="paragraph"><p>The rule set you have just defined will look like this in the GUI:</p></div>
<div class="imageblock"><div class="content"><img src="../images/devel_cpi_ruleset.png" alt="“The newly created rule set in the setup.”"></div></div>
<div class="paragraph"><p>In the <span class="guihint">Conditions</span> box, you will find the <span class="guihint">Host group name</span> input field defined via the <code>HostAndItemCondition</code> for restricting the rule for host groups.</p></div>
<div class="paragraph"><p>Create a rule and try out different values, as shown in the screenshot above.
If this works without errors, you can now use the check parameters in the check function.</p></div>
</div>
<div class="sect2">
<h3 id="heading_use_ruleset">
<span class="hidden-anchor sr-only" id="use_ruleset"></span>5.3. Connecting the rule set with the check plug-in</h3>
<div class="paragraph"><p>The freshly created rule set is now connected to the check plug-in provisionally completed in the <a href="#extend">previous chapter</a>.
In order for the rule to take effect, you must allow the check plug-in to accept check parameters and tell it which rule should be used.
To do this, add two new lines to the check plug-in file when creating the <code>myhostgroups_advanced</code> check plug-in:</p></div>
<div class="listingblock">
<div class="title">~/local/lib/python3/cmk_addons/plugins/myhostgroups/agent_based/myhostgroups.py</div>
<div class="content"><pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-n">check_plugin_myhostgroups_advanced</span> <span class="tok-o">=</span> <span class="tok-n">CheckPlugin</span><span class="tok-p">(</span>
    <span class="tok-n">name</span> <span class="tok-o">=</span> <span class="tok-s2">"myhostgroups_advanced"</span><span class="tok-p">,</span>
    <span class="tok-n">sections</span> <span class="tok-o">=</span> <span class="tok-p">[</span> <span class="tok-s2">"myhostgroups"</span> <span class="tok-p">],</span>
    <span class="tok-n">service_name</span> <span class="tok-o">=</span> <span class="tok-s2">"Host group </span><span class="tok-si">%s</span><span class="tok-s2">"</span><span class="tok-p">,</span>
    <span class="tok-n">discovery_function</span> <span class="tok-o">=</span> <span class="tok-n">discover_myhostgroups_advanced</span><span class="tok-p">,</span>
    <span class="tok-n">check_function</span> <span class="tok-o">=</span> <span class="tok-n">check_myhostgroups_advanced</span><span class="tok-p">,</span>
<span class="hll">    <span class="tok-n">check_default_parameters</span> <span class="tok-o">=</span> <span class="tok-p">{},</span>
</span><span class="hll">    <span class="tok-n">check_ruleset_name</span> <span class="tok-o">=</span> <span class="tok-s2">"myhostgroups_advanced"</span><span class="tok-p">,</span>
</span><span class="tok-p">)</span></code></pre></div>
</div>
<div class="paragraph"><p>With the <code>check_default_parameters</code> entry, you can define the default values that apply as long as no rule has actually been created.
When converting the check plug-in for check parameters, this line must be present.
In the simplest case, pass an empty dictionary <code>{}</code>.</p></div>
<div class="paragraph"><p>Secondly, enter <code>check_ruleset_name</code>, i.e. the name of the rule set.
This way Checkmk knows from which rule set the parameters are to be determined.</p></div>
<div class="paragraph"><p>Now Checkmk will try to pass parameters to the check function.
For this to work, you must extend the check function so that it expects the <code>params</code> argument, which is inserted between <code>item</code> and <code>section</code>:</p></div>
<div class="listingblock">
<div class="title">~/local/lib/python3/cmk_addons/plugins/myhostgroups/agent_based/myhostgroups.py</div>
<div class="content"><pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">def</span> <span class="tok-nf">check_myhostgroups_advanced</span><span class="tok-p">(</span><span class="tok-n">item</span><span class="tok-p">,</span> <span class="tok-n">params</span><span class="tok-p">,</span> <span class="tok-n">section</span><span class="tok-p">):</span></code></pre></div>
</div>
<div class="paragraph"><p>If you are building a check without an item, the <code>item</code> is omitted and <code>params</code> is at the beginning.</p></div>
<div class="paragraph"><p>It is highly recommended to have the content of the variable <code>params</code> output with a <code>print</code> as a first test:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">def</span> <span class="tok-nf">check_myhostgroups_advanced</span><span class="tok-p">(</span><span class="tok-n">item</span><span class="tok-p">,</span> <span class="tok-n">params</span><span class="tok-p">,</span> <span class="tok-n">section</span><span class="tok-p">):</span>
    <span class="tok-nb">print</span><span class="tok-p">(</span><span class="tok-n">params</span><span class="tok-p">)</span></code></pre></div></div>
<div class="paragraph"><p>When the check plug-in is executed, the printed lines (one for each service) with the values defined by a rule will then look something like this:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="console"><span></span><span class="tok-gp">OMD[mysite]:~$ </span>cmk<span class="tok-w"> </span>--detect-plugins<span class="tok-o">=</span>myhostgroups_advanced<span class="tok-w"> </span>-v<span class="tok-w"> </span>localhost
<span class="tok-go">Parameters({'hosts_up_lower': ('fixed', (75.0, 60.0)), 'services_ok_lower': ('fixed', (75.0, 60.0))})</span>
<span class="tok-go">Parameters({'hosts_up_lower': ('fixed', (75.0, 60.0)), 'services_ok_lower': ('fixed', (75.0, 60.0))})</span>
<span class="tok-go">Parameters({'hosts_up_lower': ('fixed', (75.0, 60.0)), 'services_ok_lower': ('fixed', (75.0, 60.0))})</span></code></pre></div></div>
<div class="admonitionblock important"><table><tr>
<td class="icon"><img src="../images/icons/important.png" alt="Important"></td>
<td class="content"><div class="paragraph"><p>When everything is ready and working correctly, remove the <code>print</code> calls, as these can mess up the internal communication within Checkmk.
Alternatively, you can restrict the output of debug information to a <a href="#custom_debug">explicit request</a>.</p></div></td>
</tr></table></div>
<div class="paragraph"><p>Now customize your check function further so that the passed parameters can take effect.
Get the two dictionary elements defined in the rule with the name selected there from the parameters:</p></div>
<div class="listingblock">
<div class="title">~/local/lib/python3/cmk_addons/plugins/myhostgroups/agent_based/myhostgroups.py</div>
<div class="content"><pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">def</span> <span class="tok-nf">check_myhostgroups_advanced</span><span class="tok-p">(</span><span class="tok-n">item</span><span class="tok-p">,</span> <span class="tok-n">params</span><span class="tok-p">,</span> <span class="tok-n">section</span><span class="tok-p">):</span>
    <span class="tok-n">hosts_up_lower</span> <span class="tok-o">=</span> <span class="tok-n">params</span><span class="tok-p">[</span><span class="tok-s2">"hosts_up_lower"</span><span class="tok-p">]</span>
    <span class="tok-n">services_ok_lower</span> <span class="tok-o">=</span> <span class="tok-n">params</span><span class="tok-p">[</span><span class="tok-s2">"services_ok_lower"</span><span class="tok-p">]</span></code></pre></div>
</div>
<div class="paragraph"><p>Further down in the check function, the previously hard-coded threshold values <code>"fixed", (90.0, 80.0)</code> are then replaced by the variables <code>hosts_up_lower</code> and <code>services_ok_lower</code>:</p></div>
<div class="listingblock">
<div class="title">~/local/lib/python3/cmk_addons/plugins/myhostgroups/agent_based/myhostgroups.py</div>
<div class="content"><pre class="pygments highlight"><code data-lang="python"><span></span>    <span class="tok-n">hosts_up_perc</span> <span class="tok-o">=</span> <span class="tok-mf">100.0</span> <span class="tok-o">*</span> <span class="tok-n">num_hosts_up</span> <span class="tok-o">/</span> <span class="tok-n">num_hosts</span>
    <span class="tok-k">yield from</span> <span class="tok-n">check_levels</span><span class="tok-p">(</span>
        <span class="tok-n">hosts_up_perc</span><span class="tok-p">,</span>
<span class="hll">        <span class="tok-n">levels_lower</span> <span class="tok-o">=</span> <span class="tok-p">(</span><span class="tok-n">hosts_up_lower</span><span class="tok-p">),</span>
</span>        <span class="tok-n">metric_name</span> <span class="tok-o">=</span> <span class="tok-s2">"hosts_up_perc"</span><span class="tok-p">,</span>
        <span class="tok-n">label</span> <span class="tok-o">=</span> <span class="tok-s2">"UP hosts"</span><span class="tok-p">,</span>
        <span class="tok-n">boundaries</span> <span class="tok-o">=</span> <span class="tok-p">(</span><span class="tok-mf">0.0</span><span class="tok-p">,</span> <span class="tok-mf">100.0</span><span class="tok-p">),</span>
        <span class="tok-n">notice_only</span> <span class="tok-o">=</span> <span class="tok-kc">True</span><span class="tok-p">,</span>
    <span class="tok-p">)</span>
    <span class="tok-n">services_ok_perc</span> <span class="tok-o">=</span> <span class="tok-mf">100.0</span> <span class="tok-o">*</span> <span class="tok-n">num_services_ok</span> <span class="tok-o">/</span> <span class="tok-n">num_services</span>
    <span class="tok-k">yield from</span> <span class="tok-n">check_levels</span><span class="tok-p">(</span>
        <span class="tok-n">services_ok_perc</span><span class="tok-p">,</span>
<span class="hll">        <span class="tok-n">levels_lower</span> <span class="tok-o">=</span> <span class="tok-p">(</span><span class="tok-n">services_ok_lower</span><span class="tok-p">),</span>
</span>        <span class="tok-n">metric_name</span> <span class="tok-o">=</span> <span class="tok-s2">"services_ok_perc"</span><span class="tok-p">,</span>
        <span class="tok-n">label</span> <span class="tok-o">=</span> <span class="tok-s2">"OK services"</span><span class="tok-p">,</span>
        <span class="tok-n">boundaries</span> <span class="tok-o">=</span> <span class="tok-p">(</span><span class="tok-mf">0.0</span><span class="tok-p">,</span> <span class="tok-mf">100.0</span><span class="tok-p">),</span>
        <span class="tok-n">notice_only</span> <span class="tok-o">=</span> <span class="tok-kc">True</span><span class="tok-p">,</span>
    <span class="tok-p">)</span></code></pre></div>
</div>
<div class="paragraph"><p>If a rule has been configured, you can now monitor the host groups of the example with the threshold values set via the GUI.
However, if no rule has been defined, this check function will crash, since the default parameters in the check plug-in will have not been filled, and the plug-in will generate a <code>KeyError</code> in the absence of a rule.</p></div>
<div class="paragraph" id="ruleset_defaults"><p>However, this problem can be solved if the default values are defined when the check plug-in is created:</p></div>
<div class="listingblock">
<div class="title">~/local/lib/python3/cmk_addons/plugins/myhostgroups/agent_based/myhostgroups.py</div>
<div class="content"><pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-n">check_plugin_myhostgroups_advanced</span> <span class="tok-o">=</span> <span class="tok-n">CheckPlugin</span><span class="tok-p">(</span>
    <span class="tok-n">name</span> <span class="tok-o">=</span> <span class="tok-s2">"myhostgroups_advanced"</span><span class="tok-p">,</span>
    <span class="tok-n">sections</span> <span class="tok-o">=</span> <span class="tok-p">[</span> <span class="tok-s2">"myhostgroups"</span> <span class="tok-p">],</span>
    <span class="tok-n">service_name</span> <span class="tok-o">=</span> <span class="tok-s2">"Host group </span><span class="tok-si">%s</span><span class="tok-s2">"</span><span class="tok-p">,</span>
    <span class="tok-n">discovery_function</span> <span class="tok-o">=</span> <span class="tok-n">discover_myhostgroups_advanced</span><span class="tok-p">,</span>
    <span class="tok-n">check_function</span> <span class="tok-o">=</span> <span class="tok-n">check_myhostgroups_advanced</span><span class="tok-p">,</span>
<span class="hll">    <span class="tok-n">check_default_parameters</span> <span class="tok-o">=</span> <span class="tok-p">{</span><span class="tok-s2">"hosts_up_lower"</span><span class="tok-p">:</span> <span class="tok-p">(</span><span class="tok-s2">"fixed"</span><span class="tok-p">,</span> <span class="tok-p">(</span><span class="tok-mi">90</span><span class="tok-p">,</span> <span class="tok-mi">80</span><span class="tok-p">)),</span> <span class="tok-s2">"services_ok_lower"</span><span class="tok-p">:</span> <span class="tok-p">(</span><span class="tok-s2">"fixed"</span><span class="tok-p">,</span> <span class="tok-p">(</span><span class="tok-mi">90</span><span class="tok-p">,</span> <span class="tok-mi">80</span><span class="tok-p">))},</span>
</span>    <span class="tok-n">check_ruleset_name</span> <span class="tok-o">=</span> <span class="tok-s2">"myhostgroups_advanced"</span><span class="tok-p">,</span>
<span class="tok-p">)</span></code></pre></div>
</div>
<div class="paragraph"><p>You should always pass default values in this way (and not intercept the case of missing parameters in the check plug-in), as these default values can also be displayed in the <span class="guihint">Setup</span> interface.
For example, in the service discovery of a host, on the <span class="guihint">Services of host</span> page, in the <span class="guihint">Display</span> menu, there is the <span class="guihint">Show check parameters</span> switch.</p></div>
<div class="admonitionblock tip"><table><tr>
<td class="icon"><img src="../images/icons/tip.png" alt="Tip"></td>
<td class="content"><div class="paragraph"><p>On GitHub you can find both the file with the
<a href="https://github.com/Checkmk/checkmk-docs/blob/master/examples/devel_check_plugins/ruleset_myhostgroups.py" target="_blank">rule set</a>
as well as the
<a href="https://github.com/Checkmk/checkmk-docs/blob/master/examples/devel_check_plugins/check_plugin_advanced_myhostgroups.py" target="_blank">check plug-in</a> extended by the rule set.</p></div></td>
</tr></table></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="heading_metrics_advanced">
<span class="hidden-anchor sr-only" id="metrics_advanced"></span>6. Customizing the metric displays</h2>
<div class="sectionbody">
<div class="paragraph"><p>In the <a href="#metrics">example above</a>, you had the check plug-in <code>myhostgroups_advanced</code> generate <a href="glossar.html#metric">metrics</a> for all measured and calculated values.
We have presented two ways of doing this.
First, the metrics of the calculated values were created as part of the <code>check_levels()</code> function with the <code>metric_name</code> argument, for example like this:</p></div>
<div class="listingblock">
<div class="title">~/local/lib/python3/cmk_addons/plugins/myhostgroups/agent_based/myhostgroups.py</div>
<div class="content"><pre class="pygments highlight"><code data-lang="python"><span></span>    <span class="tok-k">yield from</span> <span class="tok-n">check_levels</span><span class="tok-p">(</span>
        <span class="tok-n">services_ok_perc</span><span class="tok-p">,</span>
        <span class="tok-n">levels_lower</span> <span class="tok-o">=</span> <span class="tok-p">(</span><span class="tok-s2">"fixed"</span><span class="tok-p">,</span> <span class="tok-p">(</span><span class="tok-mf">90.0</span><span class="tok-p">,</span> <span class="tok-mf">80.0</span><span class="tok-p">)),</span>
        <span class="tok-n">metric_name</span> <span class="tok-o">=</span> <span class="tok-s2">"services_ok_perc"</span><span class="tok-p">,</span>
        <span class="tok-n">label</span> <span class="tok-o">=</span> <span class="tok-s2">"OK services"</span><span class="tok-p">,</span>
        <span class="tok-n">boundaries</span> <span class="tok-o">=</span> <span class="tok-p">(</span><span class="tok-mf">0.0</span><span class="tok-p">,</span> <span class="tok-mf">100.0</span><span class="tok-p">),</span>
        <span class="tok-n">notice_only</span> <span class="tok-o">=</span> <span class="tok-kc">True</span><span class="tok-p">,</span>
    <span class="tok-p">)</span></code></pre></div>
</div>
<div class="paragraph"><p>Then you have generated the measured metrics directly with the <code>Metric()</code> object — for the number of services in the <span class="state0">OK</span> state, for example, like this:</p></div>
<div class="listingblock">
<div class="title">~/local/lib/python3/cmk_addons/plugins/myhostgroups/agent_based/myhostgroups.py</div>
<div class="content"><pre class="pygments highlight"><code data-lang="python"><span></span>    <span class="tok-k">yield</span> <span class="tok-n">Metric</span><span class="tok-p">(</span><span class="tok-n">name</span><span class="tok-o">=</span><span class="tok-s2">"num_services_ok"</span><span class="tok-p">,</span> <span class="tok-n">value</span><span class="tok-o">=</span><span class="tok-n">num_services_ok</span><span class="tok-p">)</span></code></pre></div>
</div>
<div class="paragraph"><p>Metrics will become immediately visible in the Checkmk graphical user interface without you having to do anything.
There are, however, a few restrictions:</p></div>
<div class="ulist"><ul>
<li><p>Matching metrics are not automatically combined in a graph, but each appears individually.</p></li>
<li><p>The metric will not have a proper title, instead the internal variable name of the metric is shown.</p></li>
<li><p>No unit is used that allows a meaningful representation (e.g. GB instead of individual bytes).</p></li>
<li><p>A color is selected at random.</p></li>
<li><p>A 'Perf-O-Meter', i.e. the graphic preview of the metric as a bar, does not automatically appear in the service list (for example in the view that shows all services of a host).</p></li>
</ul></div>
<div class="paragraph"><p>To complete the display of your metrics with such details, you will require <em>metric definitions</em>.</p></div>
<div class="paragraph"><p>Just as for <a href="#rule_set">rule sets</a>, as of Checkmk <span class="new">2.3.0</span> there is also a separate API for metrics, graphs and Perf-O-Meters with the <strong>Graphing API</strong>.
The documentation for the Graphing API can be found in your Checkmk site on the same page as the <a href="#check_api_doc">Check API</a>, under <span class="guihint">Graphing &gt; Version 1</span>.</p></div>
<div class="sect2">
<h3 id="heading_new_metricdefinition">
<span class="hidden-anchor sr-only" id="new_metricdefinition"></span>6.1. Creating a new metric definitions</h3>
<div class="paragraph"><p>The procedures for creating <a href="#new_ruleset">rule sets</a> and metric definitions are very similar.
First create a new subdirectory with the default name <code>graphing</code> in your plug-in family directory <code>~/local/lib/python3/cmk_addons/plugins/myhostgroups/</code>.</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="console"><span></span><span class="tok-gp">OMD[mysite]:~$ </span>mkdir<span class="tok-w"> </span>-p<span class="tok-w"> </span>local/lib/python3/cmk_addons/plugins/myhostgroups/graphing
<span class="tok-gp">OMD[mysite]:~$ </span><span class="tok-nb">cd</span><span class="tok-w"> </span>local/lib/python3/cmk_addons/plugins/myhostgroups/graphing</code></pre></div></div>
<div class="paragraph"><p>Then create a graphing file in this directory, e.g. <code>graphing_myhostgroups.py</code>.</p></div>
<div class="paragraph"><p>First there are again some import commands:</p></div>
<div class="listingblock">
<div class="title">~/local/lib/python3/cmk_addons/plugins/myhostgroups/graphing/graphing_myhostgroups.py</div>
<div class="content"><pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-kn">from</span> <span class="tok-nn">cmk.graphing.v1</span> <span class="tok-kn">import</span> <span class="tok-n">Title</span>
<span class="tok-kn">from</span> <span class="tok-nn">cmk.graphing.v1.graphs</span> <span class="tok-kn">import</span> <span class="tok-n">Graph</span><span class="tok-p">,</span> <span class="tok-n">MinimalRange</span>
<span class="tok-kn">from</span> <span class="tok-nn">cmk.graphing.v1.metrics</span> <span class="tok-kn">import</span> <span class="tok-n">Color</span><span class="tok-p">,</span> <span class="tok-n">DecimalNotation</span><span class="tok-p">,</span> <span class="tok-n">Metric</span><span class="tok-p">,</span> <span class="tok-n">Unit</span>
<span class="tok-kn">from</span> <span class="tok-nn">cmk.graphing.v1.perfometers</span> <span class="tok-kn">import</span> <span class="tok-n">Closed</span><span class="tok-p">,</span> <span class="tok-n">FocusRange</span><span class="tok-p">,</span> <span class="tok-n">Open</span><span class="tok-p">,</span> <span class="tok-n">Perfometer</span></code></pre></div>
</div>
<div class="paragraph"><p>For our example, you now define your own metric for the percentage of services in the <span class="state0">OK</span> state.
This is done by creating an instance of the class <code>Metric</code>.
This instance’s name must begin with <code>metric_</code></p></div>
<div class="listingblock">
<div class="title">~/local/lib/python3/cmk_addons/plugins/myhostgroups/graphing/graphing_myhostgroups.py</div>
<div class="content"><pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-n">metric_myhostgroups_services_ok_perc</span> <span class="tok-o">=</span> <span class="tok-n">Metric</span><span class="tok-p">(</span>
    <span class="tok-n">name</span> <span class="tok-o">=</span> <span class="tok-s2">"services_ok_perc"</span><span class="tok-p">,</span>
    <span class="tok-n">title</span> <span class="tok-o">=</span> <span class="tok-n">Title</span><span class="tok-p">(</span><span class="tok-s2">"Percentage of services in OK state"</span><span class="tok-p">),</span>
    <span class="tok-n">unit</span> <span class="tok-o">=</span> <span class="tok-n">Unit</span><span class="tok-p">(</span><span class="tok-n">DecimalNotation</span><span class="tok-p">(</span><span class="tok-s2">"%"</span><span class="tok-p">)),</span>
    <span class="tok-n">color</span> <span class="tok-o">=</span> <span class="tok-n">Color</span><span class="tok-o">.</span><span class="tok-n">ORANGE</span><span class="tok-p">,</span>
<span class="tok-p">)</span></code></pre></div>
</div>
<div class="paragraph"><p>Here is the explanation:</p></div>
<div class="ulist"><ul>
<li><p>The metric name (here <code>services_ok_perc</code>) must correspond to what the check function outputs.</p></li>
<li><p>The <code>title</code> is the heading in the metric graph and replaces the previously used internal variable name.</p></li>
<li><p>The available units (<code>unit</code>) can be found in the API documentation, these all end in <code>Notation</code>, e.g. <code>DecimalNotation</code>, <code>EngineeringScientificNotation</code> or <code>TimeNotation</code>.</p></li>
<li><p>The color names used in Checkmk for the <code>color</code> definition can be found at <a href="https://github.com/Checkmk/checkmk/blob/master/packages/cmk-graphing/cmk/graphing/v1/metrics.py" target="_blank">GitHub.</a></p></li>
</ul></div>
<div class="paragraph"><p>This definition in the graphing file now ensures that the metric’s title, unit and color are displayed appropriately.</p></div>
<div class="paragraph"><p>Similar to the creation of a <a href="#test_ruleset">rule set file</a>, the graphing file must first be read before the change will be visible in the GUI.
This is achieved by restarting the site’s Apache:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="console"><span></span><span class="tok-gp">OMD[mysite]:~$ </span>omd<span class="tok-w"> </span>restart<span class="tok-w"> </span>apache</code></pre></div></div>
<div class="paragraph"><p>The metric graph will then look something like this in the Checkmk GUI:</p></div>
<div class="imageblock"><div class="content"><img src="../images/devel_cpi_new_metric.png" alt="“The new metric definition in the service details.”"></div></div>
</div>
<div class="sect2">
<h3 id="heading_graph_multiple_metrics">
<span class="hidden-anchor sr-only" id="graph_multiple_metrics"></span>6.2. Graphs with multiple metrics</h3>
<div class="paragraph"><p>If you want to combine several metrics in one graph (which is often very useful), you will need a graph definition that you can add to the graphing file created in the previous section.</p></div>
<div class="paragraph"><p>For our example, the two metrics <code>num_services</code> and <code>num_services_ok</code> are to be displayed in a single graph.
The metric definitions for this are created in the same way as in the previous section for <code>services_ok_perc</code> and look as follows:</p></div>
<div class="listingblock">
<div class="title">~/local/lib/python3/cmk_addons/plugins/myhostgroups/graphing/graphing_myhostgroups.py</div>
<div class="content"><pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-n">metric_myhostgroups_services</span> <span class="tok-o">=</span> <span class="tok-n">Metric</span><span class="tok-p">(</span>
    <span class="tok-n">name</span> <span class="tok-o">=</span> <span class="tok-s2">"num_services"</span><span class="tok-p">,</span>
    <span class="tok-n">title</span> <span class="tok-o">=</span> <span class="tok-n">Title</span><span class="tok-p">(</span><span class="tok-s2">"Number of services in group"</span><span class="tok-p">),</span>
    <span class="tok-n">unit</span> <span class="tok-o">=</span> <span class="tok-n">Unit</span><span class="tok-p">(</span><span class="tok-n">DecimalNotation</span><span class="tok-p">(</span><span class="tok-s2">""</span><span class="tok-p">)),</span>
    <span class="tok-n">color</span> <span class="tok-o">=</span> <span class="tok-n">Color</span><span class="tok-o">.</span><span class="tok-n">PINK</span><span class="tok-p">,</span>
<span class="tok-p">)</span>

<span class="tok-n">metric_myhostgroups_services_ok</span> <span class="tok-o">=</span> <span class="tok-n">Metric</span><span class="tok-p">(</span>
    <span class="tok-n">name</span> <span class="tok-o">=</span> <span class="tok-s2">"num_services_ok"</span><span class="tok-p">,</span>
    <span class="tok-n">title</span> <span class="tok-o">=</span> <span class="tok-n">Title</span><span class="tok-p">(</span><span class="tok-s2">"Number of services in OK state"</span><span class="tok-p">),</span>
    <span class="tok-n">unit</span> <span class="tok-o">=</span> <span class="tok-n">Unit</span><span class="tok-p">(</span><span class="tok-n">DecimalNotation</span><span class="tok-p">(</span><span class="tok-s2">""</span><span class="tok-p">)),</span>
    <span class="tok-n">color</span> <span class="tok-o">=</span> <span class="tok-n">Color</span><span class="tok-o">.</span><span class="tok-n">BLUE</span><span class="tok-p">,</span>
<span class="tok-p">)</span></code></pre></div>
</div>
<div class="paragraph"><p>Now add a graph that draws these two metrics as lines.
This is done via an instance of the class <code>Graph</code>, whereby the instance’s name must again begin with a predefined prefix (<code>graph_</code>):</p></div>
<div class="listingblock">
<div class="title">~/local/lib/python3/cmk_addons/plugins/myhostgroups/graphing/graphing_myhostgroups.py</div>
<div class="content"><pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-n">graph_myhostgroups_combined</span> <span class="tok-o">=</span> <span class="tok-n">Graph</span><span class="tok-p">(</span>
    <span class="tok-n">name</span> <span class="tok-o">=</span> <span class="tok-s2">"services_ok_comparison"</span><span class="tok-p">,</span>
    <span class="tok-n">title</span> <span class="tok-o">=</span> <span class="tok-n">Title</span><span class="tok-p">(</span><span class="tok-s2">"Services in OK state out of total"</span><span class="tok-p">),</span>
    <span class="tok-n">simple_lines</span><span class="tok-o">=</span><span class="tok-p">[</span> <span class="tok-s2">"num_services"</span><span class="tok-p">,</span> <span class="tok-s2">"num_services_ok"</span> <span class="tok-p">],</span>
    <span class="tok-n">minimal_range</span><span class="tok-o">=</span><span class="tok-n">MinimalRange</span><span class="tok-p">(</span><span class="tok-mi">0</span><span class="tok-p">,</span> <span class="tok-mi">50</span><span class="tok-p">),</span>
<span class="tok-p">)</span></code></pre></div>
</div>
<div class="paragraph"><p>The parameter <code>minimal_range</code> describes the minimum range covered by the vertical axis of the graph, regardless of the actual values of the metric.
The vertical axis will be extended if the values exceed the minimum range, but it will never be smaller.</p></div>
<div class="paragraph"><p>The result is the combined graph in the Checkmk GUI:</p></div>
<div class="imageblock"><div class="content"><img src="../images/devel_cpi_graph_two_metrics.png" alt="“The graph shows both metrics in the service details.”"></div></div>
</div>
<div class="sect2">
<h3 id="heading_perfometer">
<span class="hidden-anchor sr-only" id="perfometer"></span>6.3. Metrics in the Perf-O-Meter</h3>
<div class="paragraph"><p>Would you like to display a Perf-O-Meter for a metric in the row of the service list?
It could look like this, for example:</p></div>
<div class="imageblock">
<div class="content"><img src="../images/devel_cpi_perfometer_percentage.png" alt="“The Perf-O-Meter shows the percentage of services in ‘OK’ state.”"></div>
<div class="title">The Perf-O-Meter shows the percentage of services in <span class="state0">OK</span> state</div>
</div>
<div class="paragraph"><p>To create such a Perf-O-Meter, you will need another instance, this time of the class <code>Perfometer</code>, whose name begins with the prefix <code>perfometer_</code>:</p></div>
<div class="listingblock">
<div class="title">~/local/lib/python3/cmk_addons/plugins/myhostgroups/graphing/graphing_myhostgroups.py</div>
<div class="content"><pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-n">perfometer_myhostgroups_advanced</span> <span class="tok-o">=</span> <span class="tok-n">Perfometer</span><span class="tok-p">(</span>
    <span class="tok-n">name</span> <span class="tok-o">=</span> <span class="tok-s2">"myhostgroups_advanced"</span><span class="tok-p">,</span>
    <span class="tok-n">focus_range</span> <span class="tok-o">=</span> <span class="tok-n">FocusRange</span><span class="tok-p">(</span><span class="tok-n">Closed</span><span class="tok-p">(</span><span class="tok-mi">0</span><span class="tok-p">),</span> <span class="tok-n">Closed</span><span class="tok-p">(</span><span class="tok-mi">100</span><span class="tok-p">)),</span>
    <span class="tok-n">segments</span> <span class="tok-o">=</span> <span class="tok-p">[</span> <span class="tok-s2">"services_ok_perc"</span> <span class="tok-p">],</span>
<span class="tok-p">)</span></code></pre></div>
</div>
<div class="paragraph"><p>Perf-O-Meters are a little trickier than graphs, as they have no legend.
It is therefore difficult to display a range of values, especially when absolute values are being displayed.
It is easier to display a percentage.
This is also the case in the above example:</p></div>
<div class="ulist"><ul>
<li><p>The metric names are entered in <code>segments</code>, in this example the percentage of services in the <span class="state0">OK</span> state.</p></li>
<li><p>The lower and upper limits are entered in <code>focus_range</code>.
<code>Closed</code> limits are intended for metrics that can only accept values between the specified limits (here <code>0</code> and <code>100</code>).</p></li>
</ul></div>
<div class="paragraph"><p>Further, even more sophisticated options for implementing metrics in Perf-O-Meters can be found in the Graphing API documentation, for example, with the classes <code>Bidirectional</code> and <code>Stacked</code>, which allow several Perf-O-Meters to be displayed in one.</p></div>
<div class="paragraph"><p>The graphing file for this chapter can be found at <a href="https://github.com/Checkmk/checkmk-docs/blob/master/examples/devel_check_plugins/graphing_myhostgroups.py" target="_blank">GitHub</a>.
Among other things, this file contains the metric definitions for the four measured values and the two calculated values.</p></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="heading_format_numbers">
<span class="hidden-anchor sr-only" id="format_numbers"></span>7. Formatting numbers</h2>
<div class="sectionbody">
<div class="paragraph"><p>Numbers are often output in the <span class="guihint">Summary</span> and the <span class="guihint">Details</span> of a service.
To make neat and correct formatting as easy as possible for you,
and also to standardize the output of all check plug-ins, there are helper functions for displaying the various types of sizes.
All of these are subfunctions of the <code>render</code> module and are therefore called with <code>render.</code>.
For example, <code>render.bytes(2000)</code> results in the text <code>1.95 KiB</code>.</p></div>
<div class="paragraph"><p>What all of these functions have in common is that their value is shown in a so-called <em>canonical</em> or natural unit.
This means you never have to think and there are no difficulties or errors when converting.
For example, times are always given in seconds, and the sizes of hard disks, files, etc., are always given in bytes and not in kilobytes, kibibytes, blocks or other such confusion.</p></div>
<div class="paragraph"><p>Use these functions even if you do not like the display that much.
In any case, it will be standardized for the user.
Future versions of Checkmk may be able to change the display or even make it configurable by the user, as is already the case with the temperature display, for example.
Your check plug-in will then also benefit from this.</p></div>
<div class="paragraph"><p>Before you can use the <code>render</code> function in your check plug-in, you must also import it:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-kn">from</span> <span class="tok-nn">cmk.agent_based.v2</span> <span class="tok-kn">import</span> <span class="tok-n">render</span></code></pre></div></div>
<div class="paragraph"><p>Following this detailed description of all display functions (render functions), you will find a <a href="#numbers_summary">summary</a> in the form of an easy to read table.</p></div>
<div class="sect2">
<h3 id="heading_time">
<span class="hidden-anchor sr-only" id="time"></span>7.1. Times, time ranges, frequencies</h3>
<div class="paragraph"><p>Absolute time specifications (timestamps) are formatted with <code>render.date()</code> or <code>render.datetime()</code>.
The information is always given as <em>Unix time</em>, i.e. in seconds from January 1, 1970, 00:00:00 UTC — the beginning of the <em>Unix epoch</em>.
This is also the format used by the Python function <code>time.time()</code>.</p></div>
<div class="paragraph"><p>The advantage with this representation is that it is very easy to calculate, for example the calculation of a time range, when the start and end times are known.
The formula is then simply <code>duration = end - start</code>.
These calculations work regardless of the time zone, daylight saving time changes, or leap years.</p></div>
<div class="paragraph"><p><code>render.date()</code> only outputs the date, <code>render.datetime()</code> adds the time.
The output is according to the current time zone in which the Checkmk server that is executing the check is located.
Examples:</p></div>
<table class="table-responsive table-bordered table tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead><tr>
<th class="tableblock halign-left valign-top">Call</th>
<th class="tableblock halign-left valign-top">Output</th>
</tr></thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>render.date(0)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>1970-01-01</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>render.datetime(0)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>1970-01-01 01:00:00</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>render.date(1700000000)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>2023-11-14</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>render.datetime(1700000000)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>2023-11-14 23:13:20</code></p></td>
</tr>
</tbody>
</table>
<div class="paragraph"><p>Do not be surprised that <code>render.datetime(0)</code> does not output <code>00:00</code> as the time, but <code>01:00</code>.
This is because we are writing this User Guide in the time zone for Germany — which is one hour ahead of standard UTC time (at least during standard time, because January 1st is not in daylight saving time).</p></div>
<div class="paragraph"><p>For time ranges (or <em>time spans</em>) there is also the <code>render.timespan()</code> function.
This is given a duration in seconds and outputs it in human-readable form.
For larger time spans, seconds or minutes are omitted.
If you have a time span in a <code>TimeDelta</code> object, use the <code>total_seconds()</code> function to read out the number of seconds as a floating point number.</p></div>
<table class="table-responsive table-bordered table tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead><tr>
<th class="tableblock halign-left valign-top">Call</th>
<th class="tableblock halign-left valign-top">Output</th>
</tr></thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>render.timespan(1)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>1 second</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>render.timespan(123)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>2 minutes 3 seconds</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>render.timespan(12345)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>3 hours 25 minutes</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>render.timespan(1234567)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>14 days 6 hours</code></p></td>
</tr>
</tbody>
</table>
<div class="paragraph"><p>A <em>frequency</em> is effectively the reciprocal of time.
The canonical unit is <em>Hz</em>, which means the same as 1 / sec (the reciprocal of one second).
An example of its use is the clock rate of a CPU:</p></div>
<table class="table-responsive table-bordered table tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead><tr>
<th class="tableblock halign-left valign-top">Call</th>
<th class="tableblock halign-left valign-top">Output</th>
</tr></thead>
<tbody><tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>render.frequency(111222333444)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>111 GHz</code></p></td>
</tr></tbody>
</table>
</div>
<div class="sect2">
<h3 id="heading_byte">
<span class="hidden-anchor sr-only" id="byte"></span>7.2. Bytes</h3>
<div class="paragraph"><p>Wherever working memory, files, hard disks, file systems and the like are concerned, the canonical unit is the <em>byte</em>.
Since computers usually organize such things in powers of two, for example in units of 512, 1024 or 65,536 bytes, it became established right from the beginning,
that a <em>kilobyte</em> is not 1000, and therefore a thousand times the unit, but 1024 (2 to the power of 10) bytes.
This is admittedly illogical, but very practical because it usually results in round numbers.
The legendary Commodore C64 had 64 kilobytes of memory and not 65.536.</p></div>
<div class="paragraph"><p>Unfortunately, at some point hard disk manufacturers came up with the idea of specifying the sizes of their disks in units of 1000.
Since the difference between 1000 and 1024 is 2.4 % for each size, and these are multiplied,
a disk of size 1 GB (1024 times 1024 times 1024) suddenly becomes 1.07 GB.
That sells better.</p></div>
<div class="paragraph"><p>This annoying confusion still exists today and continues to produce errors.
To alleviate this, the International Electrotechnical Commission (IEC) has defined new prefixes based on the binary system.
Accordingly, today a kilobyte is officially 1000 bytes and a <em>kibibyte</em> is 1024 bytes (2 to the power of 10).
In addition, one should say <em>mebibyte</em>, <em>gibibyte</em> and <em>tebibyte</em>.
The abbreviations are then KiB, MiB, GiB and TiB.</p></div>
<div class="paragraph"><p>Checkmk conforms to this standard and helps you with a number of customized render functions to ensure that you always produce the correct output.
For example, there is the <code>render.disksize()</code> function especially for hard disks and file systems, which produces its output in powers of 1000.</p></div>
<table class="table-responsive table-bordered table tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead><tr>
<th class="tableblock halign-left valign-top">Call</th>
<th class="tableblock halign-left valign-top">Output</th>
</tr></thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>render.disksize(1000)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>1.00 kB</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>render.disksize(1024)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>1.02 kB</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>render.disksize(2000000)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>2.00 MB</code></p></td>
</tr>
</tbody>
</table>
<div class="paragraph"><p>When it comes to the sizes of files, it is often customary to specify the exact size in bytes <em>without rounding</em>.
This has the advantage that you can see very quickly if a file has changed even minimally or that two files are (probably) the same.
The <code>render.filesize()</code> function is used for this:</p></div>
<table class="table-responsive table-bordered table tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead><tr>
<th class="tableblock halign-left valign-top">Call</th>
<th class="tableblock halign-left valign-top">Output</th>
</tr></thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>render.filesize(1000)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>1,000 B</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>render.filesize(1024)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>1,024 B</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>render.filesize(2000000)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>2,000,000 B</code></p></td>
</tr>
</tbody>
</table>
<div class="paragraph"><p>If you want to output a value that is not the size of a hard disk or file, simply use the generic <code>render.bytes()</code>.
With this you get the output in the 'classic' 1024 powers in the official notation:</p></div>
<table class="table-responsive table-bordered table tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead><tr>
<th class="tableblock halign-left valign-top">Call</th>
<th class="tableblock halign-left valign-top">Output</th>
</tr></thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>render.bytes(1000)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>1000 B</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>render.bytes(1024)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>1.00 KiB</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>render.bytes(2000000)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>1.91 MiB</code></p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect2">
<h3 id="heading_bandwith">
<span class="hidden-anchor sr-only" id="bandwith"></span>7.3. Bandwidths, data rates</h3>
<div class="paragraph"><p>Networkers have their own terms and ways of expressing things.
And as always, Checkmk makes every effort to adopt the conventional way of communicating in each domain.
That is why there are three different render functions for data rates and speeds.
What these all have in common is that the rates are passed in <em>bytes per second</em>, even if the actual output is in bits!</p></div>
<div class="paragraph"><p><code>render.nicspeed()</code> represents the maximum speed of a network card or a switch port.
As these are not measured values, there is no need for rounding.
Although no port can send individual bits, the data is in bits for historical reasons.</p></div>
<div class="paragraph"><p><strong>Important:</strong> Nevertheless, you must also pass bytes per second here!</p></div>
<table class="table-responsive table-bordered table tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead><tr>
<th class="tableblock halign-left valign-top">Call</th>
<th class="tableblock halign-left valign-top">Output</th>
</tr></thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>render.nicspeed(12500000)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>100 MBit/s</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>render.nicspeed(100000000)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>800 MBit/s</code></p></td>
</tr>
</tbody>
</table>
<div class="paragraph"><p><code>render.networkbandwidth()</code> is intended for an actually measured transmission speed in the network.
The input value is again bytes per second:</p></div>
<table class="table-responsive table-bordered table tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead><tr>
<th class="tableblock halign-left valign-top">Call</th>
<th class="tableblock halign-left valign-top">Output</th>
</tr></thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>render.networkbandwidth(123)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>984 Bit/s</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>render.networkbandwidth(123456)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>988 kBit/s</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>render.networkbandwidth(123456789)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>988 MBit/s</code></p></td>
</tr>
</tbody>
</table>
<div class="paragraph"><p>Where a network is not involved and data rates are still output, bytes are again common.
The most prominent case is the IO rates of hard disks.
The <code>render.iobandwidth()</code> function, which works with powers of 1000 in Checkmk, is used for this:</p></div>
<table class="table-responsive table-bordered table tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead><tr>
<th class="tableblock halign-left valign-top">Call</th>
<th class="tableblock halign-left valign-top">Output</th>
</tr></thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>render.iobandwidth(123)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>123 B/s</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>render.iobandwidth(123456)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>123 kB/s</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>render.iobandwidth(123456789)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>123 MB/s</code></p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect2">
<h3 id="heading_percentage">
<span class="hidden-anchor sr-only" id="percentage"></span>7.4. Percentages</h3>
<div class="paragraph"><p>The <code>render.percent()</code> function represents a percentage — rounded to two decimal places.
It is an exception to the other functions in that it does not pass the actual natural value — i.e. the ratio — but the real percentage.
For example, if something is half full, you do not have to pass <code>0.5</code> but <code>50</code>.</p></div>
<div class="paragraph"><p>Because it can sometimes be interesting to know whether a value is almost zero or exactly zero, values are marked by appending a ‘&lt;’ character, for values
that are greater than zero but less than 0.01 percent.</p></div>
<table class="table-responsive table-bordered table tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead><tr>
<th class="tableblock halign-left valign-top">Call</th>
<th class="tableblock halign-left valign-top">Output</th>
</tr></thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>render.percent(0.004)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>&lt;0.01%</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>render.percent(18.5)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>18.50%</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>render.percent(123)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>123.00%</code></p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect2">
<h3 id="heading_numbers_summary">
<span class="hidden-anchor sr-only" id="numbers_summary"></span>7.5. Summary</h3>
<div class="paragraph"><p>In conclusion, here is an overview of all render functions:</p></div>
<table class="table-responsive table-bordered table tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 20%;">
<col style="width: 20%;">
<col style="width: 40%;">
<col style="width: 20%;">
</colgroup>
<thead><tr>
<th class="tableblock halign-left valign-top">Function</th>
<th class="tableblock halign-left valign-top">Input</th>
<th class="tableblock halign-left valign-top">Description</th>
<th class="tableblock halign-left valign-top">Output example</th>
</tr></thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>date()</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Unix time</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Date</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>2023-11-14</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>datetime()</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Unix time</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Date and time</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>2023-11-14 23:13:20</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>timespan()</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Seconds</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Duration / age</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>3 hours 25 minutes</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>frequency()</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Hz</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Frequency (e.g. clock rate)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>111 GHz</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>disksize()</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Bytes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Size of a hard disk, base 1000</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>1.234 GB</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>filesize()</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Bytes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Size of a file, full precision</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>1,334,560 B</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>bytes()</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Bytes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Size, base 1024</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>23.4 KiB</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>nicspeed()</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Bytes per second</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Network card speed</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>100 MBit/s</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>networkbandwidth()</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Bytes per second</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Transmission speed</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>23.50 GBit/s</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>iobandwidth()</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Bytes per second</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">IO bandwidths</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>124 MB/s</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>percent()</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Percentage number</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Percentage, meaningfully-rounded</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>99.997%</code></p></td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="heading_errors">
<span class="hidden-anchor sr-only" id="errors"></span>8. Troubleshooting</h2>
<div class="sectionbody">
<div class="paragraph"><p>The correct handling of errors (unfortunately) takes up a large part of any programming work.
The good news is that the Check API already takes a lot of the work out of error handling.
For some types of errors, it is therefore better not to handle them at all yourself.</p></div>
<div class="paragraph"><p>If Python encounters a situation that is in any way <em>unexpected</em>, it reacts with a so-called <em>exception</em>.
Here are a few examples:</p></div>
<div class="ulist"><ul>
<li><p>You convert a string to a number with <code>int()</code>, but the string does not contain a number, for example <code>int("foo")</code>.</p></li>
<li><p>You use <code>bar[4]</code> to access the fifth element of <code>bar</code>, but it only has four elements.</p></li>
<li><p>You are calling a function that does not exist.</p></li>
</ul></div>
<div class="paragraph"><p>In order to decide how to tackle errors, it is first important to know the exact point in the code where an error occurs.
You can use either the GUI or the command line for this — depending on where you are currently working.</p></div>
<div class="sect2">
<h3 id="heading_error_exception_gui">
<span class="hidden-anchor sr-only" id="error_exception_gui"></span>8.1. Exceptions and crash reports in the GUI</h3>
<div class="paragraph"><p>If an exception occurs in monitoring or during service discovery in the <span class="guihint">Setup</span>, the <span class="guihint">Summary</span> contains references to the <em>crash report</em> that has just been created.
It will look like this, for example:</p></div>
<div class="imageblock"><div class="content"><img src="../images/devel_cpi_service_crash_report.png" alt="A service whose check plug-in has crashed."></div></div>
<div class="paragraph"><p>Clicking on the <span class="image-inline"><img src="../images/icons/icon_crash.png" alt="Icon for a crashed check plug-in."></span> icon displays a page with details in which you:</p></div>
<div class="ulist"><ul>
<li><p>can see the file in which the crash occurred,</p></li>
<li><p>receive all information about the crash, such as a list of the errors that occurred in the program (<em>traceback</em>), the current values of local variables, the agent output and much more, and</p></li>
<li><p>can send the report to us (Checkmk GmbH) as feedback.</p></li>
</ul></div>
<div class="paragraph"><p>The traceback helps you as a developer to decide whether there is an error in the program (e.g. the call of a non-existent function) or agent data that could not be processed as expected.
In the first case you will want to correct the error, in the second case it often makes sense to do nothing.</p></div>
<div class="paragraph"><p>Submitting the report is of course only useful for check plug-ins that are officially part of Checkmk.
If you make your own plug-ins available to third parties, you can ask your users to send you the data.</p></div>
</div>
<div class="sect2">
<h3 id="heading_error_exception_cli">
<span class="hidden-anchor sr-only" id="error_exception_cli"></span>8.2. Viewing exceptions on the command line</h3>
<div class="paragraph"><p>If you run your check plug-in using the command line, you will not receive any indication of the ID of any crash report generated.
You will only see the summarized error message:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="console"><span></span><span class="tok-gp">OMD[mysite]:~$ </span>cmk<span class="tok-w"> </span>--detect-plugins<span class="tok-o">=</span>myhostgroups_advanced<span class="tok-w"> </span>localhost
<span class="tok-go">Error in agent based plugin myhostgroups: invalid syntax (myhostgroups.py, line 11)</span></code></pre></div></div>
<div class="paragraph"><p>If you append the <code>--debug</code> option as an additional call parameter, you will receive the traceback from the Python interpreter:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="console"><span></span><span class="tok-gp">OMD[mysite]:~$ </span>cmk<span class="tok-w"> </span>--debug<span class="tok-w"> </span>--detect-plugins<span class="tok-o">=</span>myhostgroups_advanced<span class="tok-w"> </span>localhost
<span class="tok-go">Traceback (most recent call last):</span>
<span class="tok-go">  File "/omd/sites/mysite/lib/python3/cmk/discover_plugins/_python_plugins.py", line 195, in add_from_module</span>
<span class="tok-go">    module = importer(mod_name, raise_errors=True)</span>
<span class="tok-go">             <sup>^</sup><sup>^</sup><sup>^</sup><sup>^</sup><sup>^</sup><sup>^</sup><sup>^</sup><sup>^</sup><sup>^</sup><sup>^</sup><sup>^</sup><sup>^</sup>^</span>
<span class="tok-go">  File "/omd/sites/mysite/lib/python3/cmk/discover_plugins/_python_plugins.py", line 156, in _import_optionally</span>
<span class="tok-go">    return importlib.import_module(module_name)</span>
<span class="tok-go">           <sup>^</sup><sup>^</sup><sup>^</sup><sup>^</sup><sup>^</sup><sup>^</sup><sup>^</sup><sup>^</sup><sup>^</sup><sup>^</sup><sup>^</sup><sup>^</sup></span>
<span class="tok-go">  File "/omd/sites/mysite/lib/python3.12/importlib/<em>init</em>.py", line 90, in import_module</span>
<span class="tok-go">    return _bootstrap._gcd_import(name[level:], package, level)</span>
<span class="tok-go">           <sup>^</sup><sup>^</sup><sup>^</sup><sup>^</sup><sup>^</sup><sup>^</sup><sup>^</sup><sup>^</sup><sup>^</sup><sup>^</sup><sup>^</sup><sup>^</sup><sup>^</sup><sup>^</sup><sup>^</sup><sup>^</sup><sup>^</sup>^</span>
<span class="tok-go">  File "&lt;frozen importlib._bootstrap&gt;", line 1387, in _gcd_import</span>
<span class="tok-go">  File "&lt;frozen importlib._bootstrap&gt;", line 1360, in _find_and_load</span>
<span class="tok-go">  File "&lt;frozen importlib._bootstrap&gt;", line 1331, in _find_and_load_unlocked</span>
<span class="tok-go">  File "&lt;frozen importlib._bootstrap&gt;", line 935, in _load_unlocked</span>
<span class="tok-go">  File "&lt;frozen importlib._bootstrap_external&gt;", line 995, in exec_module</span>
<span class="tok-go">  File "&lt;frozen importlib._bootstrap&gt;", line 488, in _call_with_frames_removed</span>
<span class="tok-go">  File "/omd/sites/mysite/local/lib/python3/cmk_addons/plugins/myhostgroups/agent_based/myhostgroups.py", line 110, in &lt;module&gt;</span>
<span class="tok-go">    agent_section_myhostgroups == AgentSection(</span>
<span class="tok-go">    <sup>^</sup><sup>^</sup><sup>^</sup><sup>^</sup><sup>^</sup><sup>^</sup><sup>^</sup><sup>^</sup>^^</span>
<span class="tok-go">NameError: name 'agent_section_myhostgroups' is not defined</span></code></pre></div></div>
<div class="paragraph"><p>If the error does not occur again the next time you call <code>--debug</code>, for example because a new agent output is available, you can also view the last crash reports in the file system:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="console"><span></span><span class="tok-gp">OMD[mysite]:~$ </span>ls<span class="tok-w"> </span>-lhtr<span class="tok-w"> </span>~/var/check_mk/crashes/check/<span class="tok-w"> </span><span class="tok-p">|</span><span class="tok-w"> </span>tail<span class="tok-w"> </span>-n<span class="tok-w"> </span><span class="tok-m">5</span>
<span class="tok-go">drwxrwxr-x 2 mysite mysite 4.0K Aug  6 17:56 7b59a49e-540c-11ef-9595-7574c603ce8d/</span>
<span class="tok-go">drwxrwxr-x 2 mysite mysite 4.0K Aug  6 17:56 7c8870c0-540c-11ef-9595-7574c603ce8d/</span>
<span class="tok-go">drwxrwxr-x 2 mysite mysite 4.0K Aug  6 17:56 7cf9626c-540c-11ef-9595-7574c603ce8d/</span>
<span class="tok-go">drwxrwxr-x 2 mysite mysite 4.0K Aug  6 17:56 7d192d68-540c-11ef-9595-7574c603ce8d/</span>
<span class="tok-go">drwxrwxr-x 2 mysite mysite 4.0K Aug  6 17:56 7e2d5ec2-540c-11ef-9595-7574c603ce8d/</span></code></pre></div></div>
<div class="paragraph"><p>There are two files in each of these folders:</p></div>
<div class="olist arabic"><ol class="arabic">
<li><p><code>crash.info</code> contains a Python dictionary with traceback and much more information. A glance at the file with the Pager is often sufficient.</p></li>
<li><p><code>agent_output</code> contains the complete agent output that was current at the time of the crash.</p></li>
</ol></div>
</div>
<div class="sect2">
<h3 id="heading_custom_debug">
<span class="hidden-anchor sr-only" id="custom_debug"></span>8.3. Custom debug output</h3>
<div class="paragraph"><p>In the examples shown above, we use the <code>print()</code> function to output the content of variables or the structure of objects for you as a developer.
These functions for debug output must be removed from the finished check plug-in.</p></div>
<div class="paragraph"><p>As an alternative to removal, you can also have your debug output displayed only when the check plug-in is called from the console in debug mode.
To do this, import the debug object from the Checkmk toolbox and, if necessary, the <code>pprint()</code> formatting aid.
You can now produce debug output depending on the value of the debug object:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-kn">from</span> <span class="tok-nn">cmk.utils</span> <span class="tok-kn">import</span> <span class="tok-n">debug</span>

<span class="tok-kn">from</span> <span class="tok-nn">pprint</span> <span class="tok-kn">import</span> <span class="tok-n">pprint</span>

<span class="tok-k">def</span> <span class="tok-nf">check_mystuff</span><span class="tok-p">(</span><span class="tok-n">section</span><span class="tok-p">):</span>
    <span class="tok-k">if</span> <span class="tok-n">debug</span><span class="tok-o">.</span><span class="tok-n">enabled</span><span class="tok-p">():</span>
        <span class="tok-n">pprint</span><span class="tok-p">(</span><span class="tok-n">section</span><span class="tok-p">)</span></code></pre></div></div>
<div class="paragraph"><p>Note that any remaining debug output should be used sparingly and limited to hints that will help subsequent users with debugging.
Obvious and foreseeable user errors (for example, that the contents of the agent section indicate that the agent plug-in has been incorrectly configured) should be answered with the <span class="state3">UNKNOWN</span> state and include explanatory notes in the summary.</p></div>
</div>
<div class="sect2">
<h3 id="heading_error_invalid_agent">
<span class="hidden-anchor sr-only" id="error_invalid_agent"></span>8.4. Invalid agent output</h3>
<div class="paragraph"><p>The question is how you should react if the output from the agent is not in the form you actually expect — whether from the Checkmk agent or received via <a href="devel_check_plugins_snmp.html">SNMP</a>.
Suppose you always expect three words per line, what should you do if you only get two words?</p></div>
<div class="paragraph"><p>Well, if this is a <em>permitted and known</em> behavior by the agent, then of course you need to intercept this and work with a case distinction.
However, if this is not actually allowed, then it is best to act as if the line always consists of three words, for example with the following parse function:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">def</span> <span class="tok-nf">parse_foobar</span><span class="tok-p">(</span><span class="tok-n">string_table</span><span class="tok-p">):</span>
    <span class="tok-k">for</span> <span class="tok-n">foo</span><span class="tok-p">,</span> <span class="tok-n">bar</span><span class="tok-p">,</span> <span class="tok-n">baz</span> <span class="tok-ow">in</span> <span class="tok-n">string_table</span><span class="tok-p">:</span>
        <span class="tok-c1"># ...</span></code></pre></div></div>
<div class="paragraph"><p>If there is a line that does not consist of exactly three words, an exception is generated and you receive the very helpful crash report just mentioned.</p></div>
<div class="paragraph"><p>If you access keys in a dictionary that are expected to be missing occasionally, it can of course make sense to react accordingly.
This can be done by setting the service to <span class="state2">CRIT</span> or <span class="state3">UNKNOWN</span> and placing a note in the summary about the agent output that cannot be evaluated.
In any case, it is better to use the <code>get()</code> function of the dictionary for this than to catch the <code>KeyError</code> exception.
This is because <code>get()</code> returns an object of type <code>None</code> or an optional replacement to be passed as the second parameter if the key is not available:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">def</span> <span class="tok-nf">check_foobar</span><span class="tok-p">(</span><span class="tok-n">section</span><span class="tok-p">):</span>
    <span class="tok-n">foo</span> <span class="tok-o">=</span> <span class="tok-n">section</span><span class="tok-o">.</span><span class="tok-n">get</span><span class="tok-p">(</span><span class="tok-s2">"bar"</span><span class="tok-p">)</span>
    <span class="tok-k">if</span> <span class="tok-ow">not</span> <span class="tok-n">foo</span><span class="tok-p">:</span>
        <span class="tok-k">yield</span> <span class="tok-n">Result</span><span class="tok-p">(</span><span class="tok-n">state</span><span class="tok-o">=</span><span class="tok-n">State</span><span class="tok-o">.</span><span class="tok-n">CRIT</span><span class="tok-p">,</span> <span class="tok-n">summary</span><span class="tok-o">=</span><span class="tok-s2">"Missing key in section: bar"</span><span class="tok-p">)</span>
        <span class="tok-k">return</span>
    <span class="tok-c1"># ...</span></code></pre></div></div>
</div>
<div class="sect2">
<h3 id="heading_error_missing_item">
<span class="hidden-anchor sr-only" id="error_missing_item"></span>8.5. Missing items</h3>
<div class="paragraph"><p>What if the agent outputs correct data, but the item to be checked is missing?
Like this, for example:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">def</span> <span class="tok-nf">check_foobar</span><span class="tok-p">(</span><span class="tok-n">item</span><span class="tok-p">,</span> <span class="tok-n">section</span><span class="tok-p">):</span>
    <span class="tok-c1"># Try to access the item as key in the section:</span>
    <span class="tok-n">foo</span> <span class="tok-o">=</span> <span class="tok-n">section</span><span class="tok-o">.</span><span class="tok-n">get</span><span class="tok-p">(</span><span class="tok-n">item</span><span class="tok-p">)</span>
    <span class="tok-k">if</span> <span class="tok-n">foo</span><span class="tok-p">:</span>
        <span class="tok-k">yield</span> <span class="tok-n">Result</span><span class="tok-p">(</span><span class="tok-n">state</span><span class="tok-o">=</span><span class="tok-n">State</span><span class="tok-o">.</span><span class="tok-n">OK</span><span class="tok-p">,</span> <span class="tok-n">summary</span><span class="tok-o">=</span><span class="tok-s2">"Item found in monitoring data"</span><span class="tok-p">)</span>
    <span class="tok-c1"># If foo is None, nothing is yielded here</span></code></pre></div></div>
<div class="paragraph"><p>If the item you are looking for is not included, the loop is run through and Python simply drops out at the end of the function without returning a result via <code>yield</code>.
And that is exactly the right approach!
Because Checkmk recognizes that the item to be monitored is missing and generates the correct status and a suitable standard text with <span class="state3">UNKNOWN</span>.</p></div>
</div>
<div class="sect2">
<h3 id="heading_error_spool">
<span class="hidden-anchor sr-only" id="error_spool"></span>8.6. Testing with spool files</h3>
<div class="paragraph"><p>If you want to simulate particular agent outputs, files in the <a href="spool_directory.html">spool directory</a> are very helpful.
You can use these to test borderline cases that are otherwise difficult to recreate.
Or you can directly use the agent output that led to a crash report to test changes to a check plug-in.</p></div>
<div class="paragraph"><p>First deactivate your regular agent plug-in, for example by revoking its execution authorization.
Then create a file in the <code>/var/lib/check_mk_agent/spool/</code> directory that contains the agent section (or expected <em>agent sections</em>) that your check plug-in expects, including the section header, and ends with Newline.
The next time the agent is called, the content of the spool file will be transferred instead of the output from the agent plug-in.</p></div>
</div>
<div class="sect2">
<h3 id="heading_performance">
<span class="hidden-anchor sr-only" id="performance"></span>8.7. Old check plug-ins become slow for many services</h3>
<div class="paragraph"><p>With some check plug-ins that use items, it is quite possible that on larger servers several hundred services will be generated.
If no separate parse function is used, this means that the entire list of hundreds of lines must be run through for each of the hundreds of items.
The time required to search therefore increases by the square of the number of listed items, which means tens of thousands of comparisons for hundreds of services.
If, on the other hand, the nested list is transferred to a dictionary, the time required to search for an element increases only linearly with the size of the dictionary.</p></div>
<div class="paragraph"><p>In the Python wiki you will find an <a href="https://wiki.python.org/moin/TimeComplexity" target="_blank">overview of costs</a> for searching in different data types, including an explanation and <em>O notation</em>.
Using the parse function reduces the complexity of the search from <em>O(n)</em> to <em>O(1)</em>.</p></div>
<div class="paragraph"><p>As older versions of this article did not make use of the parse function, you should identify such check plug-ins and rewrite them to use a parse function.</p></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="heading_migration">
<span class="hidden-anchor sr-only" id="migration"></span>9. Migration</h2>
<div class="sectionbody">
<div class="paragraph"><p>The Check API V1 introduced in Checkmk version <span class="new">2.0.0</span> will continue to be supported in version <span class="new">2.3.0</span>, but no longer in the next version <span class="new">2.4.0</span>.
We therefore recommend using the time until the release of version <span class="new">2.4.0</span> and migrating all check plug-ins to the new APIs.</p></div>
<div class="paragraph"><p>The following information will help you with the migration of check plug-ins from Check API V1 to V2:</p></div>
<div class="ulist"><ul>
<li><p>The new directory structure and naming convention for storing the files for all plug-in APIs can be found in the <a href="#check_api_doc">API documentation</a> on the main page <span class="guihint">Checkmk’s Plug-in APIs</span>.</p></li>
<li><p>The summary of the changes in the Check API V2 can also be found in the API documentation under <span class="guihint">Checkmk’s Plug-in APIs &gt; Agent based ('Check API') &gt; Version 2 &gt; New in this version</span>.
There you will also find the link to a GitHub commit that migrates the existing check plug-in <code>apt</code> to Check API V2.</p></li>
<li><p>On <a href="https://github.com/Checkmk/checkmk/tree/master/doc/treasures/migration_helpers/" target="_blank">GitHub</a> you will find scripts in the <code>treasures</code> directory of Checkmk that will help you migrate to the new APIs.</p></li>
</ul></div>
<div class="paragraph"><p>A final note for users who still have check plug-ins that were developed with the old Check API that was valid up to Checkmk version <span class="new">1.6.0</span>.
These check plug-ins are no longer officially supported in Checkmk version <span class="new">2.3.0</span>.
Details can be found in <a href="https://checkmk.com/de/werk/16689" target="_blank">Werk #16689</a>.
You can find out how to migrate such outdated check plug-ins to the Check API V1 in the <a href="https://checkmk.com/de/blog/migrating-check-plug-ins-to-checkmk-2-0" target="_blank">blog post on migration</a>.</p></div>
</div>
</div>
<div class="sect1">
<h2 id="heading_files">
<span class="hidden-anchor sr-only" id="files"></span>10. Files and directories</h2>
<div class="sectionbody"><table class="table-responsive table-bordered table tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead><tr>
<th class="tableblock halign-left valign-top">File path</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr></thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>~/local/lib/python3/cmk_addons/plugins/</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Base directory for storing plug-in files.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>~/local/lib/python3/cmk_addons/plugins/&lt;plug-in_family&gt;/agent_based/</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Storage location for check plug-ins written according to the Check API V2.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>~/local/lib/python3/cmk_addons/plugins/&lt;plug-in_family&gt;/rulesets/</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Storage location for rule set files created according to the Rulesets API.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>~/local/lib/python3/cmk_addons/plugins/&lt;plug-in_family&gt;/graphing/</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Storage location for graphing files created according to the Graphing API.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>/usr/lib/check_mk_agent/plugins/</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">This directory is located on a monitored Linux host. The Checkmk agent for Linux expects extensions of the agent (agent plug-ins) here.</p></td>
</tr>
</tbody>
</table></div>
</div>
</div></main><div id="toc" class="toc2">
<div id="toctitle">On this page</div>
<ul class="sectlevel1">
<li>
<a href="#intro">1. Introduction</a><ul class="sectlevel1">
<li><a href="#check_api_doc">1.1. The Check API documentation</a></li>
<li><a href="#prerequisites">1.2. Prerequisites</a></li>
</ul>
</li>
<li>
<a href="#agentplugin">2. Writing an agent plug-in</a><ul class="sectlevel1">
<li><a href="#right_command">2.1. Retrieving and filtering information</a></li>
<li><a href="#command_in_agent">2.2. Incorporate the command into the agent</a></li>
<li><a href="#test_agent">2.3. Testing the agent</a></li>
</ul>
</li>
<li>
<a href="#write_check_plugin">3. Writing a simple check plug-in</a><ul class="sectlevel1">
<li><a href="#scaffold">3.1. Preparing the file</a></li>
<li><a href="#parse_function">3.2. Writing the parse function</a></li>
<li><a href="#agent_section">3.3. Creating the agent section</a></li>
<li><a href="#check_plug-in">3.4. Creating a check plug-in</a></li>
<li><a href="#discovery_function">3.5. Writing the discovery function</a></li>
<li><a href="#check_function">3.6. Writing the check function</a></li>
<li><a href="#test">3.7. Testing and activating the check plug-in</a></li>
</ul>
</li>
<li>
<a href="#extend">4. Extending the check plug-in</a><ul class="sectlevel1">
<li>
<a href="#prepare">4.1. Preparatory work</a><ul class="sectlevel2">
<li><a href="#_extending_the_agent_plug_in">Extending the agent plug-in</a></li>
<li><a href="#_extending_the_parse_function">Extending the parse function</a></li>
</ul>
</li>
<li><a href="#discovery">4.2. Service discovery</a></li>
<li><a href="#summary_details">4.3. Summary and details</a></li>
<li><a href="#partial_results">4.4. Multiple partial results per service</a></li>
<li><a href="#metrics">4.5. Metrics</a></li>
</ul>
</li>
<li>
<a href="#rule_set">5. Rule sets for check parameters</a><ul class="sectlevel1">
<li><a href="#new_ruleset">5.1. Defining a new rule set</a></li>
<li><a href="#test_ruleset">5.2. Testing a rule set</a></li>
<li><a href="#use_ruleset">5.3. Connecting the rule set with the check plug-in</a></li>
</ul>
</li>
<li>
<a href="#metrics_advanced">6. Customizing the metric displays</a><ul class="sectlevel1">
<li><a href="#new_metricdefinition">6.1. Creating a new metric definitions</a></li>
<li><a href="#graph_multiple_metrics">6.2. Graphs with multiple metrics</a></li>
<li><a href="#perfometer">6.3. Metrics in the Perf-O-Meter</a></li>
</ul>
</li>
<li>
<a href="#format_numbers">7. Formatting numbers</a><ul class="sectlevel1">
<li><a href="#time">7.1. Times, time ranges, frequencies</a></li>
<li><a href="#byte">7.2. Bytes</a></li>
<li><a href="#bandwith">7.3. Bandwidths, data rates</a></li>
<li><a href="#percentage">7.4. Percentages</a></li>
<li><a href="#numbers_summary">7.5. Summary</a></li>
</ul>
</li>
<li>
<a href="#errors">8. Troubleshooting</a><ul class="sectlevel1">
<li><a href="#error_exception_gui">8.1. Exceptions and crash reports in the GUI</a></li>
<li><a href="#error_exception_cli">8.2. Viewing exceptions on the command line</a></li>
<li><a href="#custom_debug">8.3. Custom debug output</a></li>
<li><a href="#error_invalid_agent">8.4. Invalid agent output</a></li>
<li><a href="#error_missing_item">8.5. Missing items</a></li>
<li><a href="#error_spool">8.6. Testing with spool files</a></li>
<li><a href="#performance">8.7. Old check plug-ins become slow for many services</a></li>
</ul>
</li>
<li><a href="#migration">9. Migration</a></li>
<li><a href="#files">10. Files and directories</a></li>
</ul>
</div>
<script src="../../assets/js/manifest.js?id=7db827d654313dce4250"></script>
<script src="../../assets/js/vendor.js?id=581a3d4a61b7156d04df"></script>
<script src="../../assets/js/app.js?id=959ccd04b1f8b7b78c5e"></script>
<script src="../../assets/js/lunr.js"></script>
<script src="../../assets/js/lunr.stemmer.support.js"></script>
<script src="../lunr.index.en.js"></script>
<script src="../../assets/js/lunr.client.js"></script>
</body>
</html>
