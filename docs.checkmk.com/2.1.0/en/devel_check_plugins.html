<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="UTF-8">
<!--[if IE]><meta http-equiv="X-UA-Compatible" content="IE=edge"><![endif]--><meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.10">
<link rel="icon" href="/favicon.png">
<meta name="robots" content="noindex">
<meta name="description" content="Here you will learn how to develop Checkmk plug-ins — with everything that goes with it, especially with the new Check API developed in version 2.0.0.">
<meta name="og:locale" content="en">
<meta name="og:site_name" content="Checkmk Docs">
<meta name="og:title" content="Writing your own check plug-ins">
<meta name="og:description" content="Here you will learn how to develop Checkmk plug-ins — with everything that goes with it, especially with the new Check API developed in version 2.0.0.">
<meta name="og:image" content="https://docs.checkmk.com/assets/images/share_image.png">
<meta name="twitter:site" content="@checkmk">
<meta name="twitter:creator" content="@checkmk">
<title>Writing your own check plug-ins</title>
<link rel="stylesheet" href="../../assets/css/checkmk.css?id=4473d2acbb1ea6136428">
<link rel="stylesheet" href="../../assets/css/pygments-monokai.css">
<link rel="stylesheet" href="../../assets/css/addons.css">
<link rel="stylesheet" href="../../assets/css/SourceCodePro.css">
<link rel="search" href="./opensearch.xml" type="application/opensearchdescription+xml" title="Search docs.checkmk.com">
<!-- Google Tag Manager -->
<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
        new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
    j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
    'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-NJ3VGL8');</script>
<!-- End Google Tag Manager --><style>
#staticinfo { font-style: italic; }
</style>
</head>
<body class="article toc2 toc-right">
<!-- Cookie Consent (GDPR Compliance) -->

<!-- End Cookie Consent (GDPR Compliance) -->
<!-- Google Tag Manager (noscript) -->
<noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-NJ3VGL8" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
<!-- End Google Tag Manager (noscript) --><div class="header-top">
<div class="header-top__left">
<a class="header-top__logo d-none d-xl-inline-block" href="/2.1.0/en"><img src="../../assets/images/docs_logo.png" alt="Checkmk"></a><a class="header-top__icon d-inline-block d-xl-none" href="/2.1.0/en"><img src="../../assets/images/logo_icon.svg" alt="Checkmk"></a>
</div>
<div class="header-top__center">
<input type="text" class="header-top__search" placeholder="Search the checkmk docs"><div class="header-top__search__results"></div>
</div>
<div class="header-top__right d-block">
<button class="header-top__search__toggle d-inline-block d-md-none"><img class="header-top__search__toggle__icon" src="../../assets/images/search.svg" alt="Search"></button><div class="dropdown dropdown__language">
                    <button class="btn dropdown-toggle" type="button" id="languageMenuButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">en</button>
                    <div class="dropdown-menu  dropdown-menu-right" aria-labelledby="languageMenuButton"><a class="dropdown-item" href="../../2.1.0/de/devel_check_plugins.html">Deutsch</a></div>
</div>
<div class="dropdown dropdown__branch">
                        <button class="btn dropdown-toggle" type="button" id="branchMenuButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">2.1.0</button>
                        <div class="dropdown-menu dropdown-menu-right" aria-labelledby="branchMenuButton">
<a class="dropdown-item" href="../../2.2.0/en/devel_check_plugins.html">2.2.0</a><a class="dropdown-item" href="../../latest/en/devel_check_plugins.html">latest (2.3.0)</a>
</div>
</div>
<a class="header-top__back d-none d-lg-inline-block" href="https://checkmk.com">to checkmk.com</a><button class="header-top__toggle d-inline-block d-lg-none"><span class="header-top__toggle__icon"></span></button>
</div>
</div>
<aside><div class="main-nav">
<div class="main-nav__content"><div id="content">
<div class="sect1">
<h2 id="_welcome_to_checkmk">
<a class="anchor" href="#_welcome_to_checkmk"></a>1. Welcome to Checkmk</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p><a href="welcome.html">Welcome to the Checkmk User Guide</a></p>
</li>
<li>
<p><a href="glossar.html">Glossary</a></p>
</li>
<li>
<p><a href="search.html">Searching docs.checkmk.com</a></p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_beginners_guide">
<a class="anchor" href="#_beginners_guide"></a>2. Beginner’s Guide</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p><a href="intro_setup.html">Setting up Checkmk</a></p>
</li>
<li>
<p><a href="intro_gui.html">The Checkmk user interface</a></p>
</li>
<li>
<p><a href="intro_setup_monitor.html">Setting up monitoring</a></p>
</li>
<li>
<p><a href="intro_tools.html">The monitoring tools</a></p>
</li>
<li>
<p><a href="intro_monitor.html">Checkmk in monitoring</a></p>
</li>
<li>
<p><a href="intro_finetune.html">Fine-tuning the monitoring</a></p>
</li>
<li>
<p><a href="intro_users.html">Working with multiple users</a></p>
</li>
<li>
<p><a href="intro_notifications.html">Switching on notifications</a></p>
</li>
<li>
<p><a href="intro_extend.html">Extending the monitoring system further</a></p>
</li>
<li>
<p><a href="intro_bestpractise.html">Best practices, tips &amp; tricks</a></p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_installation">
<a class="anchor" href="#_installation"></a>3. Installation</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p><a href="install_packages.html">Basic information on the installation of Checkmk</a></p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="_server_and_vms">
<a class="anchor" href="#_server_and_vms"></a>3.1. Server and VMs</h3>
<div class="ulist">
<ul>
<li>
<p><a href="install_packages_debian.html">Installation on Debian and Ubuntu</a></p>
</li>
<li>
<p><a href="install_packages_redhat.html">Installation on Red Hat and CentOS</a></p>
</li>
<li>
<p><a href="install_packages_sles.html">Installation on SUSE Linux Enterprise Server</a></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_appliance_container_cloud">
<a class="anchor" href="#_appliance_container_cloud"></a>3.2. Appliance, container, cloud</h3>
<div class="ulist">
<ul>
<li>
<p><a href="install_appliance_cmk.html">Installation of Checkmk in the appliance</a></p>
</li>
<li>
<p><a href="introduction_docker.html">Installation as a Docker container</a></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_updates">
<a class="anchor" href="#_updates"></a>3.3. Updates</h3>
<div class="ulist">
<ul>
<li>
<p><a href="update.html">Updates and upgrades</a></p>
</li>
<li>
<p><a href="update_major.html">Update to version <span class="new">2.1.0</span></a></p>
</li>
<li>
<p><a href="update_matrix.html">Update matrix for version <span class="new">2.1.0</span></a></p>
</li>
<li>
<p><a href="release_upgrade.html">Linux upgrade on the Checkmk server</a></p>
</li>
<li>
<p><a href="cmk_versions.html">Checkmk versions</a></p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_administration_of_checkmk">
<a class="anchor" href="#_administration_of_checkmk"></a>4. Administration of Checkmk</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_server">
<a class="anchor" href="#_server"></a>4.1. Server</h3>
<div class="ulist">
<ul>
<li>
<p><a href="saml.html">Authentication with SAML</a></p>
</li>
<li>
<p><a href="kerberos.html">Single sign-on with Kerberos</a></p>
</li>
<li>
<p><a href="managing_docker.html">Checkmk server in a Docker container</a></p>
</li>
<li>
<p><a href="security.html">Security</a></p>
</li>
<li>
<p><a href="ports.html">Ports</a></p>
</li>
<li>
<p><a href="omd_https.html">Securing the web interface with HTTPS</a></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_sites">
<a class="anchor" href="#_sites"></a>4.2. Sites</h3>
<div class="ulist">
<ul>
<li>
<p><a href="omd_basics.html">Site administration with omd</a></p>
</li>
<li>
<p><a href="cmk_commandline.html">Checkmk on the command line</a></p>
</li>
<li>
<p><a href="license.html">Managing licenses</a></p>
</li>
<li>
<p><a href="distributed_monitoring.html">Distributed monitoring</a></p>
</li>
<li>
<p><a href="backup.html">Backups</a></p>
</li>
<li>
<p><a href="analyze_configuration.html">Analyzing the Checkmk site configuration</a></p>
</li>
<li>
<p><a href="mkps.html">Checkmk extension packages (MKPs)</a></p>
</li>
<li>
<p><a href="simulation_mode.html">Simulation mode</a></p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_configuration">
<a class="anchor" href="#_configuration"></a>5. Configuration</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p><a href="wato.html">Configuring Checkmk</a></p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="_hosts">
<a class="anchor" href="#_hosts"></a>5.1. Hosts</h3>
<div class="ulist">
<ul>
<li>
<p><a href="hosts_setup.html">Host administration</a></p>
</li>
<li>
<p><a href="hosts_structure.html">Host structuring</a></p>
</li>
<li>
<p><a href="host_tags.html">Host tags</a></p>
</li>
<li>
<p><a href="dcd.html">Dynamic host configuration</a></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_services">
<a class="anchor" href="#_services"></a>5.2. Services</h3>
<div class="ulist">
<ul>
<li>
<p><a href="wato_services.html">Understanding and configuring services</a></p>
</li>
<li>
<p><a href="clustered_services.html">Monitoring cluster services</a></p>
</li>
<li>
<p><a href="piggyback.html">The piggyback mechanism</a></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_rules">
<a class="anchor" href="#_rules"></a>5.3. Rules</h3>
<div class="ulist">
<ul>
<li>
<p><a href="wato_rules.html">Host and service parameters</a></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_supporting_configurations">
<a class="anchor" href="#_supporting_configurations"></a>5.4. Supporting configurations</h3>
<div class="ulist">
<ul>
<li>
<p><a href="timeperiods.html">Time periods</a></p>
</li>
<li>
<p><a href="labels.html">Labels</a></p>
</li>
<li>
<p><a href="regexes.html">Regular expressions in Checkmk</a></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_users_and_permissions">
<a class="anchor" href="#_users_and_permissions"></a>5.5. Users and permissions</h3>
<div class="ulist">
<ul>
<li>
<p><a href="wato_user.html">Users, roles and permissions</a></p>
</li>
<li>
<p><a href="ldap.html">User management with LDAP/Active Directory</a></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_notifications">
<a class="anchor" href="#_notifications"></a>5.6. Notifications</h3>
<div class="ulist">
<ul>
<li>
<p><a href="notifications.html">Introduction to notifications</a></p>
</li>
<li>
<p><a href="notifications_jira.html">Notifications via Jira</a></p>
</li>
<li>
<p><a href="notifications_mattermost.html">Notifications via Mattermost</a></p>
</li>
<li>
<p><a href="notifications_pagerduty.html">Notifications via PagerDuty</a></p>
</li>
<li>
<p><a href="notifications_pushover.html">Notifications via Pushover</a></p>
</li>
<li>
<p><a href="notifications_opsgenie.html">Notifications via Opsgenie</a></p>
</li>
<li>
<p><a href="notifications_servicenow.html">Notifications via ServiceNow</a></p>
</li>
<li>
<p><a href="notifications_slack.html">Notifications via Slack</a></p>
</li>
<li>
<p><a href="notifications_splunkoncall.html">Notifications via Splunk On-Call</a></p>
</li>
<li>
<p><a href="notifications_webex.html">Notifications via Cisco Webex Teams</a></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_events">
<a class="anchor" href="#_events"></a>5.7. Events</h3>
<div class="ulist">
<ul>
<li>
<p><a href="ec.html">The Event Console</a></p>
</li>
<li>
<p><a href="alert_handlers.html">Alert handlers</a></p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_monitoring_systems">
<a class="anchor" href="#_monitoring_systems"></a>6. Monitoring systems</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p><a href="wato_monitoringagents.html">Monitoring agents</a></p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="_checkmk_agents_and_snmp">
<a class="anchor" href="#_checkmk_agents_and_snmp"></a>6.1. Checkmk agents and SNMP</h3>
<div class="ulist">
<ul>
<li>
<p><a href="agent_deployment.html">Automatic agent updates</a></p>
</li>
<li>
<p><a href="agent_linux.html">Monitoring Linux</a></p>
</li>
<li>
<p><a href="agent_linux_legacy.html">Monitoring Linux in legacy mode</a></p>
</li>
<li>
<p><a href="agent_windows.html">Monitoring Windows</a></p>
</li>
<li>
<p><a href="agent_freebsd.html">Monitoring FreeBSD</a></p>
</li>
<li>
<p><a href="snmp.html">Monitoring via SNMP</a></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_agent_extensions">
<a class="anchor" href="#_agent_extensions"></a>6.2. Agent extensions</h3>
<div class="ulist">
<ul>
<li>
<p><a href="inventory.html">The HW/SW inventory</a></p>
</li>
<li>
<p><a href="mk_filestats.html">Monitoring files</a></p>
</li>
<li>
<p><a href="monitoring_oracle.html">Monitoring Oracle databases</a></p>
</li>
<li>
<p><a href="monitoring_mysql.html">Monitoring MySQL</a></p>
</li>
<li>
<p><a href="monitoring_mssql.html">Monitoring MSSQL</a></p>
</li>
<li>
<p><a href="monitoring_jobs.html">Monitoring time-based processes (Cronjobs)</a></p>
</li>
<li>
<p><a href="spool_directory.html">The spool directory</a></p>
</li>
<li>
<p><a href="localchecks.html">Local checks</a></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_vm_cloud_container">
<a class="anchor" href="#_vm_cloud_container"></a>6.3. VM, cloud, container</h3>
<div class="ulist">
<ul>
<li>
<p><a href="datasource_programs.html">Datasource programs</a></p>
</li>
<li>
<p><a href="monitoring_vmware.html">Monitoring VMWare ESXi</a></p>
</li>
<li>
<p><a href="monitoring_aws.html">Monitoring Amazon Web Services (AWS)</a></p>
</li>
<li>
<p><a href="monitoring_azure.html">Monitoring Microsoft Azure</a></p>
</li>
<li>
<p><a href="monitoring_kubernetes.html">Monitoring Kubernetes</a></p>
</li>
<li>
<p><a href="monitoring_docker.html">Monitoring Docker</a></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_endpoints">
<a class="anchor" href="#_endpoints"></a>6.4. Endpoints</h3>
<div class="ulist">
<ul>
<li>
<p><a href="active_checks.html">Monitoring network services (Active checks)</a></p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_dashboards_views_metrics">
<a class="anchor" href="#_dashboards_views_metrics"></a>7. Dashboards, views, metrics</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p><a href="user_interface.html">The user interface</a></p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="_general">
<a class="anchor" href="#_general"></a>7.1. General</h3>
<div class="ulist">
<ul>
<li>
<p><a href="views.html">Host and service views</a></p>
</li>
<li>
<p><a href="dashboards.html">Dashboards</a></p>
</li>
<li>
<p><a href="graphing.html">Performance data and graphing</a></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_commands_in_views">
<a class="anchor" href="#_commands_in_views"></a>7.2. Commands in views</h3>
<div class="ulist">
<ul>
<li>
<p><a href="commands.html">Commands</a></p>
</li>
<li>
<p><a href="basics_ackn.html">Acknowledging problems</a></p>
</li>
<li>
<p><a href="basics_downtimes.html">Scheduled downtimes</a></p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_analysis_and_prognosis">
<a class="anchor" href="#_analysis_and_prognosis"></a>8. Analysis and prognosis</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_analysis">
<a class="anchor" href="#_analysis"></a>8.1. Analysis</h3>
<div class="ulist">
<ul>
<li>
<p><a href="availability.html">Availability</a></p>
</li>
<li>
<p><a href="sla.html">Extended availability (SLAs)</a></p>
</li>
<li>
<p><a href="bi.html">Business Intelligence (BI)</a></p>
</li>
<li>
<p><a href="reporting.html">Reports</a></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_prognosis">
<a class="anchor" href="#_prognosis"></a>8.2. Prognosis</h3>
<div class="ulist">
<ul>
<li>
<p><a href="predictive_monitoring.html">Predictive monitoring</a></p>
</li>
<li>
<p><a href="forecast_graphs.html">Forecast graphs</a></p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_connection_of_other_applications">
<a class="anchor" href="#_connection_of_other_applications"></a>9. Connection of other applications</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p><a href="monitoring_prometheus.html">Integrating Prometheus</a></p>
</li>
<li>
<p><a href="integrating_datadog.html">Integrating Datadog</a></p>
</li>
<li>
<p><a href="nagvis.html">NagVis: status data on maps and diagrams</a></p>
</li>
<li>
<p><a href="ntop.html">Integrating ntopng in Checkmk</a></p>
</li>
<li>
<p><a href="grafana.html">Integrating Checkmk in Grafana</a></p>
</li>
<li>
<p><a href="metrics_exporter.html">Sending metrics to InfluxDB and Graphite</a></p>
</li>
<li>
<p><a href="nagstamon.html">Integrating Checkmk in Nagstamon</a></p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_specifics_to_the_editions">
<a class="anchor" href="#_specifics_to_the_editions"></a>10. Specifics to the editions</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p><a href="support_diagnostics.html">Support diagnostics</a></p>
</li>
<li>
<p><a href="managed.html">The Managed Services Edition</a></p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_automation_and_development">
<a class="anchor" href="#_automation_and_development"></a>11. Automation and development</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_apis_for_automation">
<a class="anchor" href="#_apis_for_automation"></a>11.1. APIs for automation</h3>
<div class="ulist">
<ul>
<li>
<p><a href="rest_api.html">Configuration via the Checkmk REST-API</a></p>
</li>
<li>
<p><a href="livestatus.html">Retrieving status data via Livestatus</a></p>
</li>
<li>
<p><a href="livestatus_references.html">Livestatus command reference</a></p>
</li>
<li>
<p><a href="web_api.html">Configuration via HTTP-API</a></p>
</li>
<li>
<p><a href="web_api_references.html">Command reference for the HTTP-API</a></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_apis_for_development">
<a class="anchor" href="#_apis_for_development"></a>11.2. APIs for development</h3>
<div class="ulist">
<ul>
<li>
<p><a href="bakery_api.html">The Bakery-API</a></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_development_of_check_plug_ins">
<a class="anchor" href="#_development_of_check_plug_ins"></a>11.3. Development of check plug-ins</h3>
<div class="ulist">
<ul>
<li>
<p><a href="devel_check_plugins.html">Writing your own check plug-ins</a></p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_concepts">
<a class="anchor" href="#_concepts"></a>12. Concepts</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p><a href="monitoring_basics.html">Basic principles of monitoring with Checkmk</a></p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="_the_checkmk_micro_core_cmc">
<a class="anchor" href="#_the_checkmk_micro_core_cmc"></a>12.1. The Checkmk Micro Core (CMC)</h3>
<div class="ulist">
<ul>
<li>
<p><a href="cmc.html">The Checkmk Micro Core (CMC)</a></p>
</li>
<li>
<p><a href="cmc_differences.html">Special characteristics of the CMC</a></p>
</li>
<li>
<p><a href="cmc_migration.html">Migration to the CMC</a></p>
</li>
<li>
<p><a href="cmc_files.html">CMC files and directories</a></p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_the_checkmk_appliance">
<a class="anchor" href="#_the_checkmk_appliance"></a>13. The Checkmk appliance</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p><a href="appliance_rack1_quick_start.html">Quick start guide for Checkmk racks</a></p>
</li>
<li>
<p><a href="appliance_virt1_quick_start.html">Quick start guide for Checkmk virt1</a></p>
</li>
<li>
<p><a href="appliance_install_virt1.html">Installation of the virtual appliance</a></p>
</li>
<li>
<p><a href="appliance_usage.html">Configuring and using the appliance</a></p>
</li>
<li>
<p><a href="appliance_backup.html">Backup in the appliance</a></p>
</li>
<li>
<p><a href="appliance_cluster.html">Appliance in cluster operation</a></p>
</li>
<li>
<p><a href="appliance_rack_config.html">Special features of the hardware appliance</a></p>
</li>
</ul>
</div>
</div>
</div>
</div></div>
<div class="main-nav__utils">
<div class="dropup dropdown__utils">
<button class="btn dropdown-toggle" type="button" id="aboutMenuButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">About Checkmk</button><div class="dropdown-menu dropup" aria-labelledby="aboutMenuButton">
<a class="dropdown-item" href="https://checkmk.com/product/features" target="_blank">Features</a><a class="dropdown-item" href="https://checkmk.com/product/editions" target="_blank">Editions</a><a class="dropdown-item" href="https://checkmk.com/integrations" target="_blank">Integrations</a><a class="dropdown-item" href="https://checkmk.com/imprint" target="_blank">Imprint</a><a class="dropdown-item" href="copyright.html" target="_blank">Copyright</a>
</div>
</div>
<div class="dropup dropdown__utils">
<button class="btn dropdown-toggle" type="button" id="learnMenuButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Learn</button><div class="dropdown-menu dropup" aria-labelledby="learnMenuButton">
<a class="dropdown-item" href="https://checkmk.com/videos">Videos</a><a class="dropdown-item" href="https://checkmk.com/webinars">Webinars</a><a class="dropdown-item" href="https://checkmk.com/trainings/classes">Trainings</a>
</div>
</div>
<a class="main-nav__utils__link" href="https://forum.checkmk.com">Forum</a>
</div>
</div></aside><main><div id="header">
<h1>Writing your own check plug-ins</h1>
<div class="details">
<span id="revdate">Last modified on 27-May-2021</span><a class="edit-document" href="https://github.com/Checkmk/checkmk-docs/edit/2.1.0/en/devel_check_plugins.asciidoc">Edit this page on GitHub</a>
</div>
</div>
<div id="content">
<div id="preamble">
<div id="staticinfo">This page was exported for offline usage on 2025-01-07 22:12:14 +0000. It may not reflect the current state of the Checkmk documentation. To view a daily updated version, visit <a href="https://docs.checkmk.com/" target="_blank">docs.checkmk.com</a>.</div>
<div class="sectionbody"><div class="paragraph">
<p></p>
<div class="dropdown dropdown__related">
<button class="btn btn-primary dropdown-toggle" type="button" id="relatedMenuButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Related Articles</button><div class="dropdown-menu dropdown-menu-right" aria-labelledby="relatedMenuButton">
<a href="localchecks.html">Local checks</a>
<a href="agent_linux.html">Monitoring Linux</a>
<a href="agent_windows.html">Monitoring Windows</a>
<a href="cmk_commandline.html">Checkmk on the command line</a>
<a href="mkps.html">Checkmk extension packages (MKPs)</a>
<a href="simulation_mode.html">{Simulation mode</a>
<a href="snmp.html">Monitoring via SNMP</a>
<a href="wato_monitoringagents.html">Monitoring agents</a>
<a href="wato_services.html">Understanding and configuring services</a>
</div>
</div>
</div></div>
</div>
<div class="sect1">
<h2 id="heading__introduction">
<span class="hidden-anchor sr-only" id="_introduction"></span>1. Introduction</h2>
<div class="sectionbody">
<div class="paragraph"><p>Checkmk includes nearly 2000 ready-made check plug-ins for all imaginable hardware and software.
These are maintained by the Checkmk team, and new plug-ins are added every week.
On the <a href="https://exchange.checkmk.com" target="_blank">Checkmk Exchange</a> there are also more plug-ins contributed by our users.</p></div>
<div class="paragraph"><p>And yet there are always situations where a device, an application,
or just a specific metric that is important to you is not covered by any of
these plug-ins — maybe because it is something that was developed within your
own company and is therefore not available to anyone else.</p></div>
<div class="sect2">
<h3 id="heading_real_plug-in">
<span class="hidden-anchor sr-only" id="real_plug-in"></span>1.1. Does it always have to be a real plug-in?</h3>
<div class="paragraph"><p>What options do you have for implementing an effective monitoring here?
Well, you could of course contact our <a href="https://checkmk.com/product/pricing#/" target="_blank">support team</a> and request that they develop a suitable plug-in for you — but naturally it is quicker if you can do it yourself.</p></div>
<div class="paragraph"><p>You have four options:</p></div>
<table class="table-responsive table-bordered table tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<thead><tr>
<th class="tableblock halign-left valign-top">Method</th>
<th class="tableblock halign-left valign-top">How to do it</th>
<th class="tableblock halign-left valign-top">Advantages</th>
<th class="tableblock halign-left valign-top">Disadvantages</th>
</tr></thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="localchecks.html">Local check</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Extend a Checkmk Agent with a simple script</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Is very simple, is possible in all programming languages offered by the monitored host’s operating system, and even supports service discovery</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Threshold configuration only for the agent itself, SNMP not possible or very cumbersome</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Nagios-compatible check plug-in</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Run the plug-in via <em>MRPE</em> from the <a href="agent_windows.html#mrpe">Windows</a> or <a href="agent_linux.html#mrpe">Linux</a> agent</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Access to all existing Nagios plug-ins, also free choice of the programming language</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Threshold configuration only for the agent itself, SNMP not possible or very cumbersome, no service discovery possible</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Evaluating log messages</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Monitor <em>messages</em> with the <a href="ec.html">Event Console</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No development necessary, but only need to set up rules in the Event Console</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Only works if suitable log messages are available, no verified current status, no recording of metrics, no configurable thresholds</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Genuine Checkmk plug-in</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Will be explained in this article</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Integrates 100% with Checkmk, automatic service detection, central configuration of thresholds via graphical interface, very high performance, supports <a href="snmp.html">SNMP</a>, automatic host and service labels are possible, supports <a href="inventory.html">HW/SW inventory</a>, supported by standard libraries from Checkmk</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Requires more training and knowledge of the Python programming language</p></td>
</tr>
</tbody>
</table>
<div class="paragraph"><p>This article will show you how to develop real Checkmk check plug-ins — along
with everything associated with them.
Here we show you how to use the <strong>newly-developed API</strong> for programming
plug-ins in version <span class="new">2.0.0</span> of Checkmk.</p></div>
</div>
<div class="sect2">
<h3 id="heading__what_has_changed_compared_to_the_old_api">
<span class="hidden-anchor sr-only" id="_what_has_changed_compared_to_the_old_api"></span>1.2. What has changed compared to the old API?</h3>
<div class="paragraph"><p>Do you already have experience with developing check plug-ins for Checkmk Version
<span class="new">1.6.0</span> or earlier? If so, here is a concise overview of all of the
changes introduced in the new Check API available from Version <span class="new">2.0.0</span>:</p></div>
<div class="ulist"><ul>
<li><p>Plug-ins are now Python 3 modules, and the file names must have the <code>.py</code> extension.</p></li>
<li><p>The custom plug-ins are now located in the <code>local/lib/check_mk/base/plugins/agent_based</code> directory.</p></li>
<li><p>At the beginning of the file you will now need at least one special <code>import</code> statement.</p></li>
<li><p>The sections and the actual checks are now stored separately. For this purpose there are the new <code>register.agent_section</code> and <code>register.check_plugin</code> functions.</p></li>
<li><p>Several function and argument names have been renamed. Among other things, <em>Discovery</em> is now always used consistently (previously <em>Inventory</em>).</p></li>
<li><p>The Discovery function (formerly Inventory function) and also the Check function must now <em>always</em> work as generators (so use <code>yield</code>).</p></li>
<li><p>The names for the declared functions' arguments are now fixed.</p></li>
<li><p>Instead of the SNMP scan function, write a <em>declaration</em> of which OIDs are expected with which values.</p></li>
<li><p>The functions for representing numbers have been restructured (e.g. <code>get_bytes_human_readable</code> becomes <code>render.bytes</code>).</p></li>
<li><p>There is now a separate method for checks to exclude others (<code>supersedes</code>). This is no longer done in the SNMP scan function.</p></li>
<li><p>The auxiliary functions for working with counters, rates and averages have changed.</p></li>
<li><p>Instead of magic return values such as <code>2</code> for <span class="state2">CRIT</span>, there are now constants (e.g. <code>State.CRIT</code>).</p></li>
<li><p>Many possible programming errors in your plug-in are now recognised by Checkmk at a very early stage and can be immediately highlighted for you.</p></li>
</ul></div>
</div>
<div class="sect2">
<h3 id="heading__will_the_old_api_still_be_supported">
<span class="hidden-anchor sr-only" id="_will_the_old_api_still_be_supported"></span>1.3. Will the old API still be supported?</h3>
<div class="paragraph"><p>Yes — the API for the development of check plug-ins valid up to version
<span class="new">1.6.0</span> of Checkmk will be supported with some minor restrictions for a few
more years, because a significant number of plug-ins have been developed
with it. During this time, Checkmk will offer both APIs in parallel.
Details can be found in the
<a href="https://checkmk.com/werk/10601" target="_blank">#10601</a> work.</p></div>
<div class="paragraph"><p>Nevertheless, we do recommend the new API for the development of new plug-ins,
as it is more consistent and logical, better documented and is the most
future-proof solution in the long term.</p></div>
</div>
<div class="sect2">
<h3 id="heading__the_different_types_of_agents">
<span class="hidden-anchor sr-only" id="_the_different_types_of_agents"></span>1.4. The different types of agents</h3>
<div class="paragraph"><p>Check plug-ins evaluate the data from the Checkmk agents. And that is why, before
we leap into action here, we should first look at an overview of the types of
agents that Checkmk actually recognises:</p></div>
<table class="table-responsive table-bordered table tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 20%;">
<col style="width: 80%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Checkmk Agent</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The ‘normal’ plug-ins evaluate data that the Checkmk agent sends for Linux, Windows or other operating systems. This agent monitors operating system parameters and applications, and sometimes also server hardware. Each new check plug-in requires an extension of the agent to provide the necessary data. Therefore you first develop an agent plug-in, and then one or more check plug-ins that evaluate this data.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Special Agent / API-Integration</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">You need a special agent if you do not receive the data that is relevant for monitoring from either the normal Checkmk agent or <a href="snmp.html">SNMP</a>. The most common application for Special Agent is querying HTTP-based APIs. Examples are, e.g. Monitoring <a href="monitoring_aws.html">AWS</a>, <a href="monitoring_azure.html">Azure</a>, or <a href="monitoring_vmware.html">VMware</a>. In this case you write a script that runs directly on the Checkmk server, connects to the API, and outputs data in the same format as an agent plug-in would. For this you write suitable check plug-ins in the same way as with the ‘agent-based’ monitoring.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">SNMP</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">When monitoring via <a href="snmp.html">SNMP</a> you do not need an extension of an agent, but simply evaluate the data retrieved from your device via SNMP, which provides this by default. Checkmk supports you and takes over all of the details and special features of the SNMP protocol. There is in fact an agent here as well — namely the SNMP agent which is pre-installed on the system being monitored.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Active Check</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">This check type forms a special role. Here you first write a classic Nagios-compatible plug-in which is intended for execution <em>on the Checkmk server</em>, and which from there uses a network protocol to directly query a service on the target device. The most prominent example is the <code>check_http</code> plug-in which allows you to monitor web servers and web pages. You can then integrate this plug-in into Checkmk so that it can be set up as usual via rules.</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect2">
<h3 id="heading__prerequisites">
<span class="hidden-anchor sr-only" id="_prerequisites"></span>1.5. Prerequisites</h3>
<div class="paragraph"><p>If you feel like programming check plug-ins, you need to satisfy the following prerequisites:</p></div>
<div class="ulist"><ul>
<li><p>Knowledge of the Python programming language</p></li>
<li><p>Experience with Checkmk, especially with regard to agents and checks</p></li>
<li><p>Experience with Linux on the command line</p></li>
</ul></div>
<div class="paragraph"><p>As preparation, the following articles are recommended:</p></div>
<div class="ulist"><ul>
<li><p><a href="wato_services.html">Understanding and configuring services</a></p></li>
<li><p><a href="wato_monitoringagents.html">Monitoring agents</a></p></li>
<li><p><a href="agent_windows.html">Monitoring Windows</a></p></li>
<li><p><a href="agent_linux.html">Monitoring Linux</a></p></li>
<li><p><a href="snmp.html">Monitoring via SNMP</a></p></li>
<li><p><a href="cmk_commandline.html">Checkmk on the command line</a></p></li>
<li><p><a href="mkps.html">Checkmk extension packages (MKPs)</a></p></li>
<li><p><a href="simulation_mode.html">Simulation mode</a></p></li>
</ul></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="heading_agentbased">
<span class="hidden-anchor sr-only" id="agentbased"></span>2. A first simple check plug-in</h2>
<div class="sectionbody">
<div class="paragraph"><p>After this long introduction, it’s time we programmed our first simple check
plug-in. As an example, let’s take a simple monitoring for Linux.
Since Checkmk itself runs on Linux, it is very likely that you also have access
to a Linux system.</p></div>
<div class="paragraph"><p>The check plug-in will create a new service that detects whether someone has
inserted a USB stick on a Linux server. In this case, this service should then
become critical. You might even find something like this useful, but it is really
only a simplified example and possibly also not programmed in a completely
watertight way — but for now that’s not what this exercise is really about.</p></div>
<div class="paragraph"><p>The whole procedure involves two steps:</p></div>
<div class="olist arabic"><ol class="arabic">
<li><p>We find out which Linux command can be used to determine whether a USB stick has been plugged in, and then extend the Linux agent with a small script that calls this command.</p></li>
<li><p>We then write a check plug-in in the Checkmk site that evaluates this data.</p></li>
</ol></div>
<div class="paragraph"><p>Here we go…​</p></div>
<div class="sect2">
<h3 id="heading__finding_the_right_command">
<span class="hidden-anchor sr-only" id="_finding_the_right_command"></span>2.1. Finding the right command</h3>
<div class="paragraph"><p>At the beginning of any check programming activity is the necessary research!
This means that we have to find out how we can get the information we need for
monitoring. With Linux, this will often involve command line commands.
In Windows, PowerShell, VBScript or WMI can help, and with <a href="snmp.html">SNMP</a> we have
to find the right OIDs (there is an <a href="#snmp">own chapter</a> for this).</p></div>
<div class="paragraph"><p>Unfortunately, there is no general procedure for determining the correct command,
so we do not want to spend too much time on the subject here, we will however briefly explain
how it works for a USB stick.</p></div>
<div class="paragraph"><p>First we log in to the host we want to monitor. Under Linux, the agent runs
as the <code>root</code> user by default — which is why we perform all our tests as <code>root</code>. For our task with the USB stick, there are convenient
symbolic links in the directory <code>/dev/disk/by-id</code>. These point to all the
Linux block devices. And a plugged-in USB stick is one such device. In addition,
you can tell by the ID of the prefix <code>usb-</code> when a block device is a USB
device.</p></div>
<div class="paragraph"><p>The following command lists all entries in this directory:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="console"><span></span><span class="tok-gp">root@linux# </span>ls<span class="tok-w"> </span>-l<span class="tok-w"> </span>/dev/disk/by-id/
<span class="tok-go">total 0</span>
<span class="tok-go">lrwxrwxrwx 1 root root  9 May 14 11:21 ata-APPLE_SSD_SM0512F_S1K5NYBF810191 -&gt; ../../sda</span>
<span class="tok-go">lrwxrwxrwx 1 root root 10 May 14 11:21 ata-APPLE_SSD_SM0512F_S1K5NYBF810191-part1 -&gt; ../../sda1</span>
<span class="tok-go">lrwxrwxrwx 1 root root 10 May 14 11:21 ata-APPLE_SSD_SM0512F_S1K5NYBF810191-part2 -&gt; ../../sda2</span>
<span class="tok-go">lrwxrwxrwx 1 root root 10 May 14 11:21 ata-APPLE_SSD_SM0512F_S1K5NYBF810191-part3 -&gt; ../../sda3</span>
<span class="tok-go">lrwxrwxrwx 1 root root 10 May 14 11:21 ata-APPLE_SSD_SM0512F_S1K5NYBF810191-part4 -&gt; ../../sda4</span>
<span class="tok-go">lrwxrwxrwx 1 root root 10 May 14 11:21 ata-APPLE_SSD_SM0512F_S1K5NYBF810191-part5 -&gt; ../../sda5</span>
<span class="tok-go">lrwxrwxrwx 1 root root  9 May 14 11:21 wwn-0x5002538655584d30 -&gt; ../../sda</span>
<span class="tok-go">lrwxrwxrwx 1 root root 10 May 14 11:21 wwn-0x5002538655584d30-part1 -&gt; ../../sda1</span>
<span class="tok-go">lrwxrwxrwx 1 root root 10 May 14 11:21 wwn-0x5002538655584d30-part2 -&gt; ../../sda2</span>
<span class="tok-go">lrwxrwxrwx 1 root root 10 May 14 11:21 wwn-0x5002538655584d30-part3 -&gt; ../../sda3</span>
<span class="tok-go">lrwxrwxrwx 1 root root 10 May 14 11:21 wwn-0x5002538655584d30-part4 -&gt; ../../sda4</span>
<span class="tok-go">lrwxrwxrwx 1 root root 10 May 14 11:21 wwn-0x5002538655584d30-part5 -&gt; ../../sda5</span></code></pre></div></div>
<div class="paragraph"><p>So — and now the whole thing with the plugged in USB stick:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="console"><span></span><span class="tok-gp">root@linux# </span>ls<span class="tok-w"> </span>-l<span class="tok-w"> </span>/dev/disk/by-id/
<span class="tok-go">total 0</span>
<span class="tok-go">lrwxrwxrwx 1 root root  9 Mai 14 11:21 ata-APPLE_SSD_SM0512F_S1K5NYBF810191 -&gt; ../../sda</span>
<span class="tok-go">lrwxrwxrwx 1 root root 10 Mai 14 11:21 ata-APPLE_SSD_SM0512F_S1K5NYBF810191-part1 -&gt; ../../sda1</span>
<span class="tok-go">lrwxrwxrwx 1 root root 10 Mai 14 11:21 ata-APPLE_SSD_SM0512F_S1K5NYBF810191-part2 -&gt; ../../sda2</span>
<span class="tok-go">lrwxrwxrwx 1 root root 10 Mai 14 11:21 ata-APPLE_SSD_SM0512F_S1K5NYBF810191-part3 -&gt; ../../sda3</span>
<span class="tok-go">lrwxrwxrwx 1 root root 10 Mai 14 11:21 ata-APPLE_SSD_SM0512F_S1K5NYBF810191-part4 -&gt; ../../sda4</span>
<span class="tok-go">lrwxrwxrwx 1 root root 10 Mai 14 11:21 ata-APPLE_SSD_SM0512F_S1K5NYBF810191-part5 -&gt; ../../sda5</span>
<span class="tok-go">lrwxrwxrwx 1 root root  9 Mai 14 12:15 usb-SCSI_DISK-0:0 -&gt; ../../sdc</span>
<span class="tok-go">lrwxrwxrwx 1 root root 10 Mai 14 12:15 usb-SCSI_DISK-0:0-part1 -&gt; ../../sdc1</span>
<span class="tok-go">lrwxrwxrwx 1 root root 10 Mai 14 12:15 usb-SCSI_DISK-0:0-part2 -&gt; ../../sdc2</span>
<span class="tok-go">lrwxrwxrwx 1 root root  9 Mai 14 11:21 wwn-0x5002538655584d30 -&gt; ../../sda</span>
<span class="tok-go">lrwxrwxrwx 1 root root 10 Mai 14 11:21 wwn-0x5002538655584d30-part1 -&gt; ../../sda1</span>
<span class="tok-go">lrwxrwxrwx 1 root root 10 Mai 14 11:21 wwn-0x5002538655584d30-part2 -&gt; ../../sda2</span>
<span class="tok-go">lrwxrwxrwx 1 root root 10 Mai 14 11:21 wwn-0x5002538655584d30-part3 -&gt; ../../sda3</span>
<span class="tok-go">lrwxrwxrwx 1 root root 10 Mai 14 11:21 wwn-0x5002538655584d30-part4 -&gt; ../../sda4</span>
<span class="tok-go">lrwxrwxrwx 1 root root 10 Mai 14 11:21 wwn-0x5002538655584d30-part5 -&gt; ../../sda5</span></code></pre></div></div>
</div>
<div class="sect2">
<h3 id="heading__purging_the_data">
<span class="hidden-anchor sr-only" id="_purging_the_data"></span>2.2. Purging the data</h3>
<div class="paragraph"><p>Actually, we would be finished with that and could transport this whole output
via the Checkmk agent to the Checkmk server and have it analysed there as well,
because in Checkmk the following recommendation always applies: always let the
server do the complex work, so keep the agent plug-in as simple as possible.</p></div>
<div class="paragraph"><p>But there is still too much hot air in here. Transferring unnecessary data is always undesirable. Avoiding unnecessary transfers saves network traffic, memory, computing time and also makes everything clearer. That is simply a better way of doing things!</p></div>
<div class="paragraph"><p>First, we can omit the <code>-l</code>.
This already makes the output of <code>ls</code> much leaner:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="console"><span></span><span class="tok-gp">root@linux# </span>ls<span class="tok-w"> </span>/dev/disk/by-id/
<span class="tok-go">ata-APPLE_SSD_SM0512F_S1K5NYBF810191        ata-APPLE_SSD_SM0512F_S1K5NYBF810191-part5  wwn-0x5002538655584d30-part3</span>
<span class="tok-go">ata-APPLE_SSD_SM0512F_S1K5NYBF810191-part1  wwn-0x5002538655584d30-part4                ata-APPLE_SSD_SM0512F_S1K5NYBF810191-part2</span>
<span class="tok-go">wwn-0x5002538655584d30                      wwn-0x5002538655584d30-part5                ata-APPLE_SSD_SM0512F_S1K5NYBF810191-part3</span>
<span class="tok-go">wwn-0x5002538655584d30-part1                ata-APPLE_SSD_SM0512F_S1K5NYBF810191-part4  wwn-0x5002538655584d30-part2</span></code></pre></div></div>
<div class="paragraph"><p>Now again, the multi-column structure is disturbing, but this is only because
the <code>ls</code> command recognises that it is running in an interactive terminal.
Later, as part of the agent, it will output the data in a single column.
But we can also easily force this here with the <code>-1</code> option (for output in <strong>one</strong> column):</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="console"><span></span><span class="tok-gp">root@linux# </span>ls<span class="tok-w"> </span>-1<span class="tok-w"> </span>/dev/disk/by-id/
<span class="tok-go">ata-APPLE_SSD_SM0512F_S1K5NYBF810191</span>
<span class="tok-go">ata-APPLE_SSD_SM0512F_S1K5NYBF810191-part1</span>
<span class="tok-go">ata-APPLE_SSD_SM0512F_S1K5NYBF810191-part2</span>
<span class="tok-go">ata-APPLE_SSD_SM0512F_S1K5NYBF810191-part3</span>
<span class="tok-go">ata-APPLE_SSD_SM0512F_S1K5NYBF810191-part4</span>
<span class="tok-go">ata-APPLE_SSD_SM0512F_S1K5NYBF810191-part5</span>
<span class="tok-go">wwn-0x5002538655584d30</span>
<span class="tok-go">wwn-0x5002538655584d30-part1</span>
<span class="tok-go">wwn-0x5002538655584d30-part2</span>
<span class="tok-go">wwn-0x5002538655584d30-part3</span>
<span class="tok-go">wwn-0x5002538655584d30-part4</span>
<span class="tok-go">wwn-0x5002538655584d30-part5</span></code></pre></div></div>
<div class="paragraph"><p>If you look closely, you will see not only the block devices themselves,
but also any partitions that exist there. These are the entries that end in
<code>-part1</code>, <code>-part2</code>, etc. We do not need these for our check and
can get rid of them quite easily with a <code>grep</code>. There we take the <code>-v</code> option for negative logic:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="console"><span></span><span class="tok-gp">root@linux# </span>ls<span class="tok-w"> </span>/dev/disk/by-id/<span class="tok-w"> </span><span class="tok-p">|</span><span class="tok-w"> </span>grep<span class="tok-w"> </span>-v<span class="tok-w"> </span>--<span class="tok-w"> </span>-part
<span class="tok-go">ata-APPLE_SSD_SM0512F_S1K5NYBF810191</span>
<span class="tok-go">usb-SCSI_DISK-0:0</span>
<span class="tok-go">wwn-0x5002538655584d30</span></code></pre></div></div>
<div class="paragraph"><p>Here you can now see much more clearly that in our
example there are in fact exactly three devices when the USB stick is plugged in.</p></div>
<div class="paragraph"><p>Perfect! We now have a clear list of all block devices which has been
compiled with a simple command. That’s all we need.</p></div>
<div class="paragraph"><p>We have again omitted the <code>-1</code> in the last command, because <code>ls</code> now writes into a pipe and outputs a single column by itself. And <code>grep</code> needs the
<code>--</code> because otherwise it would interpret the word <code>-part</code> as the
four options <code>-p</code>, <code>-a</code>, <code>-r</code> and <code>-t</code>.</p></div>
<div class="paragraph"><p>And by the way: Why don’t we simply 'grep' for <code>usb</code> in addition so that only USB devices are output? Well, of course we could do that.
But for one thing, our example then becomes increasingly boring, and besides, it is somehow more
reassuring to get <em>some</em> content in the section in a normal situation and not
simply nothing. In this way one can see immediately on the Checkmk server that the
agent plug-in is working correctly.</p></div>
</div>
<div class="sect2">
<h3 id="heading_includecommand">
<span class="hidden-anchor sr-only" id="includecommand"></span>2.3. Including the command in the agent</h3>
<div class="paragraph"><p>In order for us to be able to retrieve this data from the Checkmk server,
we need to make the new command part of the Checkmk agent on the system being
monitored. We could of course simply edit the <code>/usr/bin/check_mk_agent</code> file
there and include that. However, this would have the disadvantage that our
command would disappear again when we update the agent’s software because the
file will be replaced at that point.</p></div>
<div class="paragraph"><p>It is therefore better if we make an <strong>agent plug-in</strong>. This is even simpler.
All we need is an executable file with our command in the
<code>/usr/lib/check_mk_agent/plugins</code> directory.</p></div>
<div class="paragraph"><p>And one more point is important: we can’t just output our data like this.
What we still need is a <strong>section header</strong>. This is a specially-formatted
line that contains our new check’s name. By means of these section headers,
Checkmk can later recognise where this plug-in’s data begins and the previous
plug-in’s data ends.</p></div>
<div class="paragraph"><p>So now we need a meaningful name for our new check.
This name is limited to lower case letters (only <em>a-z</em>, no accents, no umlauts), underscores and numbers and must be unique.
Avoid name collisions with existing check plug-ins.
If you are curious about which names already exist, in a Checkmk site you can list them on the command line with <code>cmk -L</code>:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="console"><span></span><span class="tok-gp">OMD[mysite]:~$ </span>cmk<span class="tok-w"> </span>-L<span class="tok-w"> </span><span class="tok-p">|</span><span class="tok-w"> </span>head<span class="tok-w"> </span>-n<span class="tok-w"> </span><span class="tok-m">20</span>
<span class="tok-go">3par_capacity                agent      HPE 3PAR: Capacity</span>
<span class="tok-go">3par_cpgs                    agent      HPE 3PAR: CPGs</span>
<span class="tok-go">3par_cpgs_usage              agent      HPE 3PAR: CPGs Usage</span>
<span class="tok-go">3par_hosts                   agent      HPE 3PAR: Hosts</span>
<span class="tok-go">3par_ports                   agent      HPE 3PAR: Ports</span>
<span class="tok-go">3par_remotecopy              agent      HPE 3PAR: Remote Copy</span>
<span class="tok-go">3par_system                  agent      HPE 3PAR: System</span>
<span class="tok-go">3par_volumes                 agent      HPE 3PAR: Volumes</span>
<span class="tok-go">3ware_disks                  agent      3ware ATA RAID Controller: State of Disks</span>
<span class="tok-go">3ware_info                   agent      3ware ATA RAID Controller: General Information</span>
<span class="tok-go">3ware_units                  agent      3ware ATA RAID Controller: State of Units</span>
<span class="tok-go">acme_agent_sessions          snmp       ACME Devices: Agent Sessions</span>
<span class="tok-go">acme_certificates            snmp       ACME Devices: Certificates</span>
<span class="tok-go">acme_fan                     snmp       ACME Devices: Fans</span>
<span class="tok-go">acme_powersupply             snmp       ACME Devices: Power Supplies</span>
<span class="tok-go">acme_realm                   snmp       ACME Devices: Realm</span>
<span class="tok-go">acme_sbc                     agent      ACME SBC: Health</span>
<span class="tok-go">acme_sbc_settings            agent      ACME SBC: Health Settings</span>
<span class="tok-go">acme_sbc_snmp                snmp       ACME SBC: Health (via SNMP)</span>
<span class="tok-go">acme_temp                    snmp       ACME Devices: Temperature</span></code></pre></div></div>
<div class="paragraph"><p>The second column shows how the respective check plug-in obtains its data.</p></div>
<div class="paragraph"><p>For our example, let’s choose the name <code>linux_usbstick</code>.
In this example the section header must look like this:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code><span></span>&lt;&lt;&lt;linux_usbstick&gt;&gt;&gt;</code></pre></div></div>
<div class="paragraph"><p>We can simply output this with <code>echo</code>. If we then don’t forget the
'Shebang' (this is not a venomous sting from the desert planet but an
abbreviation for <em>sharp</em> and <em>bang</em> — the latter being an abbreviation
for the exclamation mark!), by which Linux recognises that it should execute the
script with the shell, in which case our plug-in will look like this:</p></div>
<div class="listingblock">
<div class="title">/usr/lib/check_mk_agent/plugins/linux_usbstick</div>
<div class="content"><pre class="pygments highlight"><code><span></span>#!/bin/sh
echo '&lt;&lt;&lt;linux_usbstick&gt;&gt;&gt;'
ls /dev/disk/by-id/ | grep -v -- -part</code></pre></div>
</div>
<div class="paragraph"><p>We have now simply used the file name <code>linux_usbstick</code>, even though it
doesn’t really matter.
But one thing is still very important: Make the file executable!</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="console"><span></span><span class="tok-gp">root@linux# </span>chmod<span class="tok-w"> </span>+x<span class="tok-w"> </span>/usr/lib/check_mk_agent/plugins/linux_usbstick</code></pre></div></div>
<div class="paragraph"><p>Of course, you can easily try out the plug-in by manually by entering the
complete path as a command:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="console"><span></span><span class="tok-gp">root@linux# </span>/usr/lib/check_mk_agent/plugins/linux_usbstick
<span class="tok-go">&lt;&lt;&lt;linux_usbstick&gt;&gt;&gt;</span>
<span class="tok-go">ata-APPLE_SSD_SM0512F_S1K5NYBF810191</span>
<span class="tok-go">wwn-0x5002538655584d30</span></code></pre></div></div>
</div>
<div class="sect2">
<h3 id="heading__testing_the_agent">
<span class="hidden-anchor sr-only" id="_testing_the_agent"></span>2.4. Testing the agent</h3>
<div class="paragraph"><p>As always, the next most important tasks are testing and troubleshooting.
It is best to proceed in three steps:</p></div>
<div class="olist arabic"><ol class="arabic">
<li><p>Try out the plug-in on its own. We have just done that.</p></li>
<li><p>From the agent test the whole process locally.</p></li>
<li><p>Retrieve the agent via the Checkmk server.</p></li>
</ol></div>
<div class="paragraph"><p>Testing the agent locally is very simple — as <code>root</code> user call
the command <code>check_mk_agent</code>.
The new section should appear somewhere in the output from this:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="console"><span></span><span class="tok-gp">root@linux# </span>check_mk_agent</code></pre></div></div>
<div class="paragraph"><p>Here is an excerpt from that output which contains the new section:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="console"><span></span><span class="tok-go">&lt;&lt;&lt;lnx_thermal:sep(124)&gt;&gt;&gt;</span>
<span class="tok-go">thermal_zone0|-|BAT0|35600</span>
<span class="tok-go">thermal_zone1|-|x86_pkg_temp|81000|0|passive|0|passive</span>
<span class="tok-go">&lt;&lt;&lt;local&gt;&gt;&gt;</span>
<span class="tok-go">&lt;&lt;&lt;linux_usbstick&gt;&gt;&gt;</span>
<span class="tok-go">ata-APPLE_SSD_SM0512F_S1K5NYBF810191</span>
<span class="tok-go">wwn-0x5002538655584d30</span>
<span class="tok-go">&lt;&lt;&lt;lnx_packages:sep(124):persist(1589463274)&gt;&gt;&gt;</span>
<span class="tok-go">accountsservice|0.6.45-1ubuntu1|amd64|deb|-||install ok installed</span>
<span class="tok-go">acl|2.2.52-3build1|amd64|deb|-||install ok installed</span>
<span class="tok-go">acpi|1.7-1.1|amd64|deb|-||install ok installed</span></code></pre></div></div>
<div class="paragraph"><p>By appending <code>less</code> you can scroll through the output (press the space
bar to scroll, <code>/</code> to search and <code>Q</code> to exit):</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="console"><span></span><span class="tok-gp">root@linux# </span>check_mk_agent<span class="tok-w"> </span><span class="tok-p">|</span><span class="tok-w"> </span>less</code></pre></div></div>
<div class="paragraph"><p>The third test is then performed directly from the Checkmk site. Include the
host in the monitoring (e.g. as <code>myserver01</code>) and then retrieve the agent
data with <code>cmk -d</code>. You should get the same output here:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="console"><span></span><span class="tok-gp">OMD[mysite]:~$ </span>cmk<span class="tok-w"> </span>-d<span class="tok-w"> </span>myserver01<span class="tok-w"> </span><span class="tok-p">|</span><span class="tok-w"> </span>less</code></pre></div></div>
<div class="paragraph"><p>By the way: <code>grep</code> has the <code>-A</code> option to output a few more lines
after each hit.  This allows you to conveniently search and output the section:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="console"><span></span><span class="tok-gp">root@linux# </span>cmk<span class="tok-w"> </span>-d<span class="tok-w"> </span>myserver01<span class="tok-w"> </span><span class="tok-p">|</span><span class="tok-w"> </span>grep<span class="tok-w"> </span>-A5<span class="tok-w"> </span><span class="tok-s1">'^&lt;&lt;&lt; linux_usbstick'</span>
<span class="tok-go">&lt;&lt;&lt;linux_usbstick&gt;&gt;&gt;</span>
<span class="tok-go">ata-APPLE_SSD_SM0512F_S1K5NYBF810191</span>
<span class="tok-go">wwn-0x5002538655584d30</span>
<span class="tok-go">&lt;&lt;&lt;lnx_packages:sep(124):persist(1589463559)&gt;&gt;&gt;</span>
<span class="tok-go">accountsservice|0.6.45-1ubuntu1|amd64|deb|-||install ok installed</span></code></pre></div></div>
<div class="paragraph"><p>If this works, your agent is now ready! And what have we done to achieve this?
We simply created a three-line script with the path
<code>/usr/lib/check_mk_agent/plugins/linux_usbstick</code> and made it executable!</p></div>
<div class="paragraph"><p>Everything that follows now only takes place on the Checkmk server:
There we will write the actual check plug-in.</p></div>
</div>
<div class="sect2">
<h3 id="heading__declaring_the_section">
<span class="hidden-anchor sr-only" id="_declaring_the_section"></span>2.5. Declaring the section</h3>
<div class="paragraph"><p>Preparing the agent is the most complicated part, but it is only half the battle.
Now we have to teach Checkmk how to handle the information and the new agent
section, which services it should generate, when they should go to <span class="state0">OK</span> or
<span class="state2">CRIT</span>, etc. We do all this by programming a check plug-in in Python.</p></div>
<div class="paragraph"><p>For your own check plug-ins you will find a directory prepared in the
<code>local</code> hierarchy of the <a href="cmk_commandline.html#sitedir">site directory</a>.
This is <code>local/lib/check_mk/base/plugins/agent_based/</code>.
Here in the path, <code>base</code> means the part of Checkmk that is responsible for
actually monitoring and alerting. The <code>agent_based</code> is for all plug-ins
that relate to the Checkmk agent (so not alerting plug-ins, for example).
The easiest way to work with this is to switch to it:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="console"><span></span><span class="tok-gp">OMD[mysite]:~$ </span><span class="tok-nb">cd</span><span class="tok-w"> </span>local/lib/check_mk/base/plugins/agent_based</code></pre></div></div>
<div class="paragraph"><p>This directory belongs to the site user and is therefore editable by you.
You can edit your plug-in with any text editor installed on the Linux system.</p></div>
<div class="paragraph"><p>So let’s create our plug-in here. The convention is that the file name reflects
the agent section’s name. <em>Mandatory</em> is that the file ends with
<code>.py</code>, since from Checkmk version <span class="new">2.0.0</span> onwards the plug-ins
will always be real Python modules.</p></div>
<div class="paragraph"><p>First, we need to import the functions needed for the plug-ins from other
Python modules. The simplest method for this is with a <code>*</code>. As you might
guess, there is also a version number of the API for plug-in programming here.
This will be version 1 until further notice,
and is abbreviated here to <code>v1</code>:</p></div>
<div class="listingblock">
<div class="title">local/lib/check_mk/base/plugins/agent_based/linux_usbstick.py</div>
<div class="content"><pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-kn">from</span> <span class="tok-nn">.agent_based_api.v1</span> <span class="tok-kn">import</span> <span class="tok-o">*</span></code></pre></div>
</div>
<div class="paragraph"><p>This versioning allows us to eventually provide future new versions of the API
<em>parallel</em> to the previous ones, so that existing check plug-ins continue
to work without problems.</p></div>
<div class="paragraph"><p>In the simplest case, you skip explicitly declaring the section.
If you want to implement a parse function (which professional developers would always advise you to do), see the <a href="#parsefunction">section on parse functions</a> for more information.</p></div>
</div>
<div class="sect2">
<h3 id="heading__registering_the_check">
<span class="hidden-anchor sr-only" id="_registering_the_check"></span>2.6. Registering the check</h3>
<div class="paragraph"><p>In order for Checkmk to know that the new check exists, it must be registered.
This is done by calling the function <code>register.check_plugin</code>.
In doing so, you must always specify at least four things:</p></div>
<div class="olist arabic"><ol class="arabic">
<li><p><code>name</code>: The name of the check plug-in. If you don’t want to get into trouble, take the same name here as for your new agent section. This way the check will automatically know which section to evaluate.</p></li>
<li><p><code>service_name</code>: The name of the service as it should then appear in the monitoring.</p></li>
<li><p><code>discovery_function</code>: The function that discovers services of this type (more on this in a moment).</p></li>
<li><p><code>check_function</code>: The function to perform the actual check (more on this in a moment).</p></li>
</ol></div>
<div class="paragraph"><p>So for our check the registration will look like this:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-n">register</span><span class="tok-o">.</span><span class="tok-n">check_plugin</span><span class="tok-p">(</span>
    <span class="tok-n">name</span><span class="tok-o">=</span><span class="tok-s2">"linux_usbstick"</span><span class="tok-p">,</span>
    <span class="tok-n">service_name</span><span class="tok-o">=</span><span class="tok-s2">"USB stick"</span><span class="tok-p">,</span>
    <span class="tok-n">discovery_function</span><span class="tok-o">=</span><span class="tok-n">discover_linux_usbstick</span><span class="tok-p">,</span>
    <span class="tok-n">check_function</span><span class="tok-o">=</span><span class="tok-n">check_linux_usbstick</span><span class="tok-p">,</span>
<span class="tok-p">)</span></code></pre></div></div>
<div class="paragraph"><p>It’s best not to try this out just yet, because of course we still have to write
the <code>discover_linux_usbstick</code> and <code>check_linux_usbstick</code> functions
beforehand, and these functions must appear in the source code <em>before</em>
the above declaration.</p></div>
</div>
<div class="sect2">
<h3 id="heading__writing_the_discovery_function">
<span class="hidden-anchor sr-only" id="_writing_the_discovery_function"></span>2.7. Writing the discovery function</h3>
<div class="paragraph"><p>A special feature of Checkmk is the automatic discovery of services to be monitored.
In order for this to work, each check plug-in must define a function that detects
<em>whether</em> a service of this type or <em>which</em> services of this type are
to be created for the host in question on the basis of the agent’s output.</p></div>
<div class="paragraph"><p>The discovery function is always called when the service discovery is carried
out for a host. This function then decides whether or which services are to be
created. In the standard procedure, it receives exactly one argument with the
name <code>section</code>. This contains the data of the agent section in a parsed
format (more on this later).</p></div>
<div class="paragraph"><p>We implement the following simple logic: <em>If</em> the agent section
<code>linux_usbstick</code> exists, then we also create a matching service.
This service will then automatically appear on all hosts where our agent plug-in
has been rolled out. We recognise the presence of the section simply by the fact
that our discovery has actually been invoked!</p></div>
<div class="paragraph"><p>The discovery function must return an object of the type <code>Service</code> for
each service to be created using <code>yield</code> (not with <code>return</code>).
For checks that can only occur once per host, no further information is needed:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">def</span> <span class="tok-nf">discover_linux_usbstick</span><span class="tok-p">(</span><span class="tok-n">section</span><span class="tok-p">):</span>
    <span class="tok-k">yield</span> <span class="tok-n">Service</span><span class="tok-p">()</span></code></pre></div></div>
</div>
<div class="sect2">
<h3 id="heading__writing_the_check_function">
<span class="hidden-anchor sr-only" id="_writing_the_check_function"></span>2.8. Writing the check function</h3>
<div class="paragraph"><p>So now we can come to the actual check function, which finally decides on the
basis of current agent outputs which state a service should assume. Since our
check has no parameters and there is only ever one per host, our function is
also called with the single argument <code>section</code>.</p></div>
<div class="paragraph"><p>Since we really need the content this time, we have to deal with the format of
this argument. Unless you have explicitly defined a
<a href="#parsefunction">parse function</a>
Checkmk will parse each line
of the section into a <em>list of words</em> using spaces. The whole thing then in
turn becomes a list of these word lists. So the end result is that we will
always have a list of lists.</p></div>
<div class="paragraph"><p>In the simple case in which our agent plug-in only finds two devices,
it will then look like this (here there is only one word per line):</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-p">[[</span><span class="tok-s1">'ata-APPLE_SSD_SM0512F_S1K5NYBF810191'</span><span class="tok-p">],</span> <span class="tok-p">[</span><span class="tok-s1">'wwn-0x5002538655584d30'</span><span class="tok-p">]]</span></code></pre></div></div>
<div class="paragraph"><p>The check function now goes through line by line and looks for a line whose
first (and only) word begins with <code>usb-SCSI_DISK</code>.
If this is found, the state will become <span class="state2">CRIT</span>. Here is the implementation:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">def</span> <span class="tok-nf">check_linux_usbstick</span><span class="tok-p">(</span><span class="tok-n">section</span><span class="tok-p">):</span>
    <span class="tok-k">for</span> <span class="tok-n">line</span> <span class="tok-ow">in</span> <span class="tok-n">section</span><span class="tok-p">:</span>
        <span class="tok-k">if</span> <span class="tok-n">line</span><span class="tok-p">[</span><span class="tok-mi">0</span><span class="tok-p">]</span><span class="tok-o">.</span><span class="tok-n">startswith</span><span class="tok-p">(</span><span class="tok-s2">"usb-SCSI_DISK"</span><span class="tok-p">):</span>
            <span class="tok-k">yield</span> <span class="tok-n">Result</span><span class="tok-p">(</span><span class="tok-n">state</span><span class="tok-o">=</span><span class="tok-n">State</span><span class="tok-o">.</span><span class="tok-n">CRIT</span><span class="tok-p">,</span> <span class="tok-n">summary</span><span class="tok-o">=</span><span class="tok-s2">"Found USB stick"</span><span class="tok-p">)</span>
            <span class="tok-k">return</span>
    <span class="tok-k">yield</span> <span class="tok-n">Result</span><span class="tok-p">(</span><span class="tok-n">state</span><span class="tok-o">=</span><span class="tok-n">State</span><span class="tok-o">.</span><span class="tok-n">OK</span><span class="tok-p">,</span> <span class="tok-n">summary</span><span class="tok-o">=</span><span class="tok-s2">"No USB stick found"</span><span class="tok-p">)</span></code></pre></div></div>
<div class="paragraph"><p>And here is the explanation:</p></div>
<div class="olist arabic"><ol class="arabic">
<li><p>With <code>for line in section</code> we loop through all of the lines in the agent’s output.</p></li>
<li><p>We then check whether the first word in the line — the respective device — begins with <code>usb-SCSI_DISK</code>.</p></li>
<li><p>If yes, we generate a check result with the status <span class="state2">CRIT</span> and the text <code>Found USB stick</code>. And we then end the function with a <code>return</code>.</p></li>
<li><p>If the loop is run without finding anything, it will generate the status <span class="state0">OK</span> and the text <code>No USB stick found</code>.</p></li>
</ol></div>
</div>
<div class="sect2">
<h3 id="heading__the_complete_plug_in_at_a_glance">
<span class="hidden-anchor sr-only" id="_the_complete_plug_in_at_a_glance"></span>2.9. The complete plug-in at a glance</h3>
<div class="paragraph"><p>And here is the complete plug-in one more time:</p></div>
<div class="listingblock">
<div class="title">local/lib/check_mk/base/plugins/agent_based/linux_usbstick.py</div>
<div class="content"><pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-kn">from</span> <span class="tok-nn">.agent_based_api.v1</span> <span class="tok-kn">import</span> <span class="tok-o">*</span>

<span class="tok-k">def</span> <span class="tok-nf">discover_linux_usbstick</span><span class="tok-p">(</span><span class="tok-n">section</span><span class="tok-p">):</span>
    <span class="tok-k">yield</span> <span class="tok-n">Service</span><span class="tok-p">()</span>

<span class="tok-k">def</span> <span class="tok-nf">check_linux_usbstick</span><span class="tok-p">(</span><span class="tok-n">section</span><span class="tok-p">):</span>
    <span class="tok-k">for</span> <span class="tok-n">line</span> <span class="tok-ow">in</span> <span class="tok-n">section</span><span class="tok-p">:</span>
        <span class="tok-k">if</span> <span class="tok-n">line</span><span class="tok-p">[</span><span class="tok-mi">0</span><span class="tok-p">]</span><span class="tok-o">.</span><span class="tok-n">startswith</span><span class="tok-p">(</span><span class="tok-s2">"usb-SCSI_DISK"</span><span class="tok-p">):</span>
            <span class="tok-k">yield</span> <span class="tok-n">Result</span><span class="tok-p">(</span><span class="tok-n">state</span><span class="tok-o">=</span><span class="tok-n">State</span><span class="tok-o">.</span><span class="tok-n">CRIT</span><span class="tok-p">,</span> <span class="tok-n">summary</span><span class="tok-o">=</span><span class="tok-s2">"Found USB stick"</span><span class="tok-p">)</span>
            <span class="tok-k">return</span>
    <span class="tok-k">yield</span> <span class="tok-n">Result</span><span class="tok-p">(</span><span class="tok-n">state</span><span class="tok-o">=</span><span class="tok-n">State</span><span class="tok-o">.</span><span class="tok-n">OK</span><span class="tok-p">,</span> <span class="tok-n">summary</span><span class="tok-o">=</span><span class="tok-s2">"No USB stick found"</span><span class="tok-p">)</span>

<span class="tok-n">register</span><span class="tok-o">.</span><span class="tok-n">check_plugin</span><span class="tok-p">(</span>
    <span class="tok-n">name</span> <span class="tok-o">=</span> <span class="tok-s2">"linux_usbstick"</span><span class="tok-p">,</span>
    <span class="tok-n">service_name</span> <span class="tok-o">=</span> <span class="tok-s2">"USB stick"</span><span class="tok-p">,</span>
    <span class="tok-n">discovery_function</span> <span class="tok-o">=</span> <span class="tok-n">discover_linux_usbstick</span><span class="tok-p">,</span>
    <span class="tok-n">check_function</span> <span class="tok-o">=</span> <span class="tok-n">check_linux_usbstick</span><span class="tok-p">,</span>
<span class="tok-p">)</span></code></pre></div>
</div>
<div class="paragraph"><p>And this is the plug-in for the Linux agent:</p></div>
<div class="listingblock">
<div class="title">/usr/lib/check_mk_agent/plugins/linux_usbstick</div>
<div class="content"><pre class="pygments highlight"><code><span></span>#!/bin/sh
echo '&lt;&lt;&lt;linux_usbstick&gt;&gt;&gt;'
ls /dev/disk/by-id/ | grep -v -- -part</code></pre></div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="heading__checks_with_more_than_one_service_items_per_host">
<span class="hidden-anchor sr-only" id="_checks_with_more_than_one_service_items_per_host"></span>3. Checks with more than one service (items) per host</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="heading__basic_principles">
<span class="hidden-anchor sr-only" id="_basic_principles"></span>3.1. Basic principles</h3>
<div class="paragraph"><p>In our example, we have built a very simple check that creates a service on a
host — or not. A very common situation is, of course, that there can be several
services with one check on one host.</p></div>
<div class="paragraph"><p>The most common example of this is the file systems for a host.
The plug-in named <code>df</code> creates one service per file system on the host.
To distinguish these services, the mount point of the file system
(e.g. <code>/var</code>), or the drive letter (e.g. <code>C:</code>) is built into the
service name.  This then results in the service name being,
e.g. <code>filesystem /var</code>, or <code>filesystem C:</code>.
The word <code>/var</code> or <code>C:</code> is referred to here as the <em>item</em>.
So we also speak of a check <em>with items</em>.</p></div>
<div class="paragraph"><p>If you want to build a check with multiple items,
you need to implement the following things:</p></div>
<div class="ulist"><ul>
<li><p>The discovery function must generate a service for each of the items that are to be meaningfully monitored on the host.</p></li>
<li><p>In the service name you must include this item using the <code>%s</code> wildcard (i.e. <code>"Filesystem %s"</code>).</p></li>
<li><p>The check function is invoked once separately for each item and receives this as an argument. It must then fish out the relevant data for this item from the agent data.</p></li>
</ul></div>
</div>
<div class="sect2">
<h3 id="heading__a_simple_example">
<span class="hidden-anchor sr-only" id="_a_simple_example"></span>3.2. A simple example</h3>
<div class="paragraph"><p>To be able to test the whole thing practically, we will simply build another
agent section that only outputs game data. A small shell script is sufficient
for this. The section should be called <code>foobar</code> in this example:</p></div>
<div class="listingblock">
<div class="title">/usr/lib/check_mk_agent/plugins/foobar</div>
<div class="content"><pre class="pygments highlight"><code><span></span>#!/bin/sh
echo "&lt;&lt;&lt;foobar&gt;&gt;&gt;"
echo "West 100 100"
echo "East 197 200"
echo "North 0 50"</code></pre></div>
</div>
<div class="paragraph"><p>From <em>foobar</em>, there are three sectors to be found here: <code>West</code>,
<code>East</code> and <code>North</code> (whatever that means).
In each sector there are a number of <em>seats</em>, some of which are occupied
(e.g. in <code>West</code> 100 of 100 seats are occupied).</p></div>
<div class="paragraph"><p>Now we will create a matching check plug-in for this.
The registration is as usual, but with the important difference that the service
name now contains exactly one <code>%s</code>.
At this position the item’s name will be inserted later by Checkmk:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-n">register</span><span class="tok-o">.</span><span class="tok-n">check_plugin</span><span class="tok-p">(</span>
    <span class="tok-n">name</span> <span class="tok-o">=</span> <span class="tok-s2">"foobar"</span><span class="tok-p">,</span>
    <span class="tok-n">service_name</span> <span class="tok-o">=</span> <span class="tok-s2">"Foobar Sector </span><span class="tok-si">%s</span><span class="tok-s2">"</span><span class="tok-p">,</span>
    <span class="tok-n">discovery_function</span> <span class="tok-o">=</span> <span class="tok-n">discover_foobar</span><span class="tok-p">,</span>
    <span class="tok-n">check_function</span> <span class="tok-o">=</span> <span class="tok-n">check_foobar</span><span class="tok-p">,</span>
<span class="tok-p">)</span></code></pre></div></div>
<div class="paragraph"><p>The discovery function now has the task of determining the items to be monitored.
As usual, it receives the <code>section</code> argument. And again, this is a list
of lines, which in turn are lists of words.</p></div>
<div class="paragraph"><p>In our example the list looks like this:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-p">[[</span><span class="tok-s1">'West'</span><span class="tok-p">,</span> <span class="tok-s1">'100'</span><span class="tok-p">,</span> <span class="tok-s1">'100'</span><span class="tok-p">],</span> <span class="tok-p">[</span><span class="tok-s1">'East'</span><span class="tok-p">,</span> <span class="tok-s1">'197'</span><span class="tok-p">,</span> <span class="tok-s1">'200'</span><span class="tok-p">],</span> <span class="tok-p">[</span><span class="tok-s1">'North'</span><span class="tok-p">,</span> <span class="tok-s1">'0'</span><span class="tok-p">,</span> <span class="tok-s1">'50'</span><span class="tok-p">]]</span></code></pre></div></div>
<div class="paragraph"><p>You can loop through such a list with Python and give meaningful names to these
three words grouped in each line:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">for</span> <span class="tok-n">sector</span><span class="tok-p">,</span> <span class="tok-n">_used</span><span class="tok-p">,</span> <span class="tok-n">_slots</span> <span class="tok-ow">in</span> <span class="tok-n">section</span><span class="tok-p">:</span>
    <span class="tok-o">...</span></code></pre></div></div>
<div class="paragraph"><p>In each line, the first word — here the sector — is our item.
Whenever we find an item, we return that with <code>yield</code>, creating an object
of type <code>Service</code> that gets the sector name as its item. The underscore
indicates that for now we don’t care about the other two columns in the output,
since in a discovery it ultimately doesn’t matter how many slots are occupied.</p></div>
<div class="paragraph"><p>Overall it looks like this:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">def</span> <span class="tok-nf">discover_foobar</span><span class="tok-p">(</span><span class="tok-n">section</span><span class="tok-p">):</span>
    <span class="tok-k">for</span> <span class="tok-n">sector</span><span class="tok-p">,</span> <span class="tok-n">_used</span><span class="tok-p">,</span> <span class="tok-n">_slots</span> <span class="tok-ow">in</span> <span class="tok-n">section</span><span class="tok-p">:</span>
        <span class="tok-k">yield</span> <span class="tok-n">Service</span><span class="tok-p">(</span><span class="tok-n">item</span><span class="tok-o">=</span><span class="tok-n">sector</span><span class="tok-p">)</span></code></pre></div></div>
<div class="paragraph"><p>Of course, it would be easy to omit some lines here on the basis of arbitrary
criteria. Maybe there are sectors which have a size of 0 and which you would
never want to monitor? Simply omit such rows so that no item will be generated
for them.</p></div>
<div class="paragraph"><p>Then later, when the host is being monitored, the check function is called
separately for each service — and thus for each item. Therefore, in addition to
the section, it also receives the <code>item</code> argument with the item it is
looking for. Now we go through all of the lines one after the other.
When doing so, we will find the line that corresponds to the desired item:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">def</span> <span class="tok-nf">check_foobar</span><span class="tok-p">(</span><span class="tok-n">item</span><span class="tok-p">,</span> <span class="tok-n">section</span><span class="tok-p">):</span>
    <span class="tok-k">for</span> <span class="tok-n">sector</span><span class="tok-p">,</span> <span class="tok-n">used</span><span class="tok-p">,</span> <span class="tok-n">slots</span> <span class="tok-ow">in</span> <span class="tok-n">section</span><span class="tok-p">:</span>
        <span class="tok-k">if</span> <span class="tok-n">sector</span> <span class="tok-o">==</span> <span class="tok-n">item</span><span class="tok-p">:</span>
            <span class="tok-o">...</span></code></pre></div></div>
<div class="paragraph"><p>Now all that is missing is the actual logic which determines when the item
should in fact be <span class="state0">OK</span>, <span class="state1">WARN</span> or <span class="state2">CRIT</span>. We do that here like this:</p></div>
<div class="ulist"><ul>
<li><p>When all slots have been used, the thing is to become <span class="state2">CRIT</span>.</p></li>
<li><p>If there are fewer than 10 slots free, then it will become <span class="state1">WARN</span>.</p></li>
<li><p>Otherwise <span class="state0">OK</span></p></li>
</ul></div>
<div class="paragraph"><p>The occupied and total slots always appear as the second and third words in each
line. However, here we are dealing with strings, not numbers — but we need
numbers to be able to compare and calculate. We therefore convert the strings
into numbers using <code>int()</code>.</p></div>
<div class="paragraph"><p>We then return the check result by supplying an object of type <code>result</code>
via <code>yield</code>. This takes the parameters <code>state</code> and <code>summary</code>:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">def</span> <span class="tok-nf">check_foobar</span><span class="tok-p">(</span><span class="tok-n">item</span><span class="tok-p">,</span> <span class="tok-n">section</span><span class="tok-p">):</span>
    <span class="tok-k">for</span> <span class="tok-n">sector</span><span class="tok-p">,</span> <span class="tok-n">used</span><span class="tok-p">,</span> <span class="tok-n">slots</span> <span class="tok-ow">in</span> <span class="tok-n">section</span><span class="tok-p">:</span>
        <span class="tok-k">if</span> <span class="tok-n">sector</span> <span class="tok-o">==</span> <span class="tok-n">item</span><span class="tok-p">:</span>
            <span class="tok-n">used</span> <span class="tok-o">=</span> <span class="tok-nb">int</span><span class="tok-p">(</span><span class="tok-n">used</span><span class="tok-p">)</span>   <span class="tok-c1"># convert string to int</span>
            <span class="tok-n">slots</span> <span class="tok-o">=</span> <span class="tok-nb">int</span><span class="tok-p">(</span><span class="tok-n">slots</span><span class="tok-p">)</span>   <span class="tok-c1"># convert string to int</span>
            <span class="tok-k">if</span> <span class="tok-n">used</span> <span class="tok-o">==</span> <span class="tok-n">slots</span><span class="tok-p">:</span>
                <span class="tok-n">s</span> <span class="tok-o">=</span> <span class="tok-n">State</span><span class="tok-o">.</span><span class="tok-n">CRIT</span>
            <span class="tok-k">elif</span> <span class="tok-n">slots</span> <span class="tok-o">-</span> <span class="tok-n">used</span> <span class="tok-o">&lt;=</span> <span class="tok-mi">10</span><span class="tok-p">:</span>
                <span class="tok-n">s</span> <span class="tok-o">=</span> <span class="tok-n">State</span><span class="tok-o">.</span><span class="tok-n">WARN</span>
            <span class="tok-k">else</span><span class="tok-p">:</span>
                <span class="tok-n">s</span> <span class="tok-o">=</span> <span class="tok-n">State</span><span class="tok-o">.</span><span class="tok-n">OK</span>
            <span class="tok-k">yield</span> <span class="tok-n">Result</span><span class="tok-p">(</span>
                <span class="tok-n">state</span> <span class="tok-o">=</span> <span class="tok-n">s</span><span class="tok-p">,</span>
                <span class="tok-n">summary</span> <span class="tok-o">=</span> <span class="tok-sa">f</span><span class="tok-s2">"Used </span><span class="tok-si">{</span><span class="tok-n">used</span><span class="tok-si">}</span><span class="tok-s2"> out of </span><span class="tok-si">{</span><span class="tok-n">slots</span><span class="tok-si">}</span><span class="tok-s2"> slots"</span><span class="tok-p">)</span>
            <span class="tok-k">return</span></code></pre></div></div>
<div class="paragraph"><p>In this context, please note the following:</p></div>
<div class="olist arabic"><ol class="arabic">
<li><p>The command <code>return</code> ensures that the check function is terminated immediately after processing the found item. There is nothing more to be done, after all.</p></li>
<li><p>If the loop is processed without finding the item being searched for, Checkmk <em>automatically</em> generates the result <code>UNKNOWN - Item not found in monitoring data</code>. This is intentional and a good thing. Do not handle this case yourself. If you don’t find an item you are looking for, just let Python run its course through the function and let Checkmk do its work.</p></li>
<li><p>With the argument <code>summary</code> you define the text that the service produces from the status output. This is purely informal and will not be evaluated further by Checkmk.</p></li>
</ol></div>
<div class="paragraph"><p>By the way, for the common situation where you want to check a simple metric for thresholds, there is a helper function called <code>check_levels</code>.
This helper function is explained in the Check API documentation, which you can access in Checkmk via <span class="guihint">Help &gt; Plugin API reference &gt; Agent based API ("Check API")</span>.</p></div>
<div class="paragraph"><p>Now let’s first try out the discovery. For the sake of clarity we will restrict
this action to our plug-in by using the <code>--detect-plugins=foobar</code> option:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="console"><span></span><span class="tok-gp">OMD[mysite]:~$ </span>cmk<span class="tok-w"> </span>--detect-plugins<span class="tok-o">=</span>foobar<span class="tok-w"> </span>-vI<span class="tok-w"> </span>myhost123
<span class="tok-go">  <span class="green">3</span> foobar</span>
<span class="tok-go">SUCCESS - Found 3 services, 1 host labels</span></code></pre></div></div>
<div class="paragraph"><p>And now right away we can test the checking process
(here also limited to <code>foobar</code>):</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="console"><span></span><span class="tok-gp">OMD[mysite]:~$ </span>cmk<span class="tok-w"> </span>--detect-plugins<span class="tok-o">=</span>foobar<span class="tok-w"> </span>-v<span class="tok-w"> </span>myhost123
<span class="tok-go">Foobar Sector East   <span class="yellow">WARN - used 197 out of 200 slots</span></span>
<span class="tok-go">Foobar Sector North  <span class="green">OK - used 0 out of 50 slots</span></span>
<span class="tok-go">Foobar Sector West   <span class="red">CRIT - used 100 out of 100 slots</span></span></code></pre></div></div>
</div>
<div class="sect2">
<h3 id="heading__the_examplea_recap">
<span class="hidden-anchor sr-only" id="_the_examplea_recap"></span>3.3. The example — a recap</h3>
<div class="paragraph"><p>And here again our example in full. To avoid errors due to undefined function
names, the functions must always be defined before registering.</p></div>
<div class="listingblock">
<div class="title">local/lib/check_mk/base/plugins/agent_based/foobar.py</div>
<div class="content"><pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-kn">from</span> <span class="tok-nn">.agent_based_api.v1</span> <span class="tok-kn">import</span> <span class="tok-o">*</span>
<span class="tok-kn">import</span> <span class="tok-nn">pprint</span>


<span class="tok-k">def</span> <span class="tok-nf">discover_foobar</span><span class="tok-p">(</span><span class="tok-n">section</span><span class="tok-p">):</span>
    <span class="tok-k">for</span> <span class="tok-n">sector</span><span class="tok-p">,</span> <span class="tok-n">used</span><span class="tok-p">,</span> <span class="tok-n">slots</span> <span class="tok-ow">in</span> <span class="tok-n">section</span><span class="tok-p">:</span>
        <span class="tok-k">yield</span> <span class="tok-n">Service</span><span class="tok-p">(</span><span class="tok-n">item</span><span class="tok-o">=</span><span class="tok-n">sector</span><span class="tok-p">)</span>


<span class="tok-k">def</span> <span class="tok-nf">check_foobar</span><span class="tok-p">(</span><span class="tok-n">item</span><span class="tok-p">,</span> <span class="tok-n">section</span><span class="tok-p">):</span>
    <span class="tok-k">for</span> <span class="tok-n">sector</span><span class="tok-p">,</span> <span class="tok-n">used</span><span class="tok-p">,</span> <span class="tok-n">slots</span> <span class="tok-ow">in</span> <span class="tok-n">section</span><span class="tok-p">:</span>
        <span class="tok-k">if</span> <span class="tok-n">sector</span> <span class="tok-o">==</span> <span class="tok-n">item</span><span class="tok-p">:</span>
            <span class="tok-n">used</span> <span class="tok-o">=</span> <span class="tok-nb">int</span><span class="tok-p">(</span><span class="tok-n">used</span><span class="tok-p">)</span>    <span class="tok-c1"># convert string to int</span>
            <span class="tok-n">slots</span> <span class="tok-o">=</span> <span class="tok-nb">int</span><span class="tok-p">(</span><span class="tok-n">slots</span><span class="tok-p">)</span>  <span class="tok-c1"># convert string to int</span>
            <span class="tok-k">if</span> <span class="tok-n">used</span> <span class="tok-o">==</span> <span class="tok-n">slots</span><span class="tok-p">:</span>
                <span class="tok-n">s</span> <span class="tok-o">=</span> <span class="tok-n">State</span><span class="tok-o">.</span><span class="tok-n">CRIT</span>
            <span class="tok-k">elif</span> <span class="tok-n">slots</span> <span class="tok-o">-</span> <span class="tok-n">used</span> <span class="tok-o">&lt;=</span> <span class="tok-mi">10</span><span class="tok-p">:</span>
                <span class="tok-n">s</span> <span class="tok-o">=</span> <span class="tok-n">State</span><span class="tok-o">.</span><span class="tok-n">WARN</span>
            <span class="tok-k">else</span><span class="tok-p">:</span>
                <span class="tok-n">s</span> <span class="tok-o">=</span> <span class="tok-n">State</span><span class="tok-o">.</span><span class="tok-n">OK</span>
            <span class="tok-k">yield</span> <span class="tok-n">Result</span><span class="tok-p">(</span>
                <span class="tok-n">state</span> <span class="tok-o">=</span> <span class="tok-n">s</span><span class="tok-p">,</span>
                <span class="tok-n">summary</span> <span class="tok-o">=</span> <span class="tok-sa">f</span><span class="tok-s2">"used </span><span class="tok-si">{</span><span class="tok-n">used</span><span class="tok-si">}</span><span class="tok-s2"> out of </span><span class="tok-si">{</span><span class="tok-n">slots</span><span class="tok-si">}</span><span class="tok-s2"> slots"</span><span class="tok-p">)</span>
            <span class="tok-k">return</span>


<span class="tok-n">register</span><span class="tok-o">.</span><span class="tok-n">check_plugin</span><span class="tok-p">(</span>
    <span class="tok-n">name</span> <span class="tok-o">=</span> <span class="tok-s2">"foobar"</span><span class="tok-p">,</span>
    <span class="tok-n">service_name</span> <span class="tok-o">=</span> <span class="tok-s2">"Foobar Sector </span><span class="tok-si">%s</span><span class="tok-s2">"</span><span class="tok-p">,</span>
    <span class="tok-n">discovery_function</span> <span class="tok-o">=</span> <span class="tok-n">discover_foobar</span><span class="tok-p">,</span>
    <span class="tok-n">check_function</span> <span class="tok-o">=</span> <span class="tok-n">check_foobar</span><span class="tok-p">,</span>
<span class="tok-p">)</span></code></pre></div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="heading__performance_values">
<span class="hidden-anchor sr-only" id="_performance_values"></span>4. Performance values</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="heading__determining_values_in_the_check_function">
<span class="hidden-anchor sr-only" id="_determining_values_in_the_check_function"></span>4.1. Determining values in the check function</h3>
<div class="paragraph"><p>Not always, but very often checks work with numbers.
With its <a href="graphing.html">graphing system</a> Checkmk has a component to store, evaluate and
display such numbers. This works completely independently from the generation of
any resulting <span class="state0">OK</span>, <span class="state1">WARN</span> or <span class="state2">CRIT</span> states.</p></div>
<div class="paragraph"><p>Such measured values — or metrics — are determined by the check function and
simply returned as an additional result. For this purpose the <code>Metric</code>
object is used, which requires at least the two arguments <code>name</code> and
<code>value</code>. Here is an example:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="python"><span></span>    <span class="tok-k">yield</span> <span class="tok-n">Metric</span><span class="tok-p">(</span><span class="tok-s2">"fooslots"</span><span class="tok-p">,</span> <span class="tok-n">used</span><span class="tok-p">)</span></code></pre></div></div>
</div>
<div class="sect2">
<h3 id="heading_thresholdinformation">
<span class="hidden-anchor sr-only" id="thresholdinformation"></span>4.2. Threshold information</h3>
<div class="paragraph"><p>Furthermore there are two optional arguments. With the argument <code>levels</code>
you can provide information about thresholds for <span class="state1">WARN</span> and <span class="state2">CRIT</span>,
in the form of a pair of two numbers. This is then usually plotted on the graph
as a yellow and a red line. The first number (yellow line) represents the warning
threshold, the second (red line) the critical one. The convention is that the
check already goes to <span class="state1">WARN</span> when the warning threshold is reached (analogous
for <span class="state2">CRIT</span>).</p></div>
<div class="paragraph"><p>The coding could then look like this (here with hard coded thresholds):</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="python"><span></span>    <span class="tok-k">yield</span> <span class="tok-n">Metric</span><span class="tok-p">(</span><span class="tok-s2">"fooslots"</span><span class="tok-p">,</span> <span class="tok-n">used</span><span class="tok-p">,</span> <span class="tok-n">levels</span><span class="tok-o">=</span><span class="tok-p">(</span><span class="tok-mi">190</span><span class="tok-p">,</span><span class="tok-mi">200</span><span class="tok-p">))</span></code></pre></div></div>
<div class="paragraph"><p>Notes:</p></div>
<div class="ulist"><ul>
<li><p>If only one of the two thresholds will be defined, simply enter <code>None</code> for the other threshold, e.g. <code>levels=(None, 200)</code>.</p></li>
<li><p>Floating point numbers are also allowed, but not strings.</p></li>
<li><p>Attention: the check function itself is responsible for the <em>check</em> of the thresholds .  The specification of <code>levels</code> serves only as marginal information for the graphing system!</p></li>
</ul></div>
</div>
<div class="sect2">
<h3 id="heading__the_values_range">
<span class="hidden-anchor sr-only" id="_the_values_range"></span>4.3. The values range</h3>
<div class="paragraph"><p>Analogous to the threshold values, you can also provide the graphing system with
information about a range of possible values. This denotes the smallest and
largest possible value. This is done in the <code>boundaries</code> argument, where
<code>None</code> can also be optionally used here for one of the two boundaries.</p></div>
<div class="paragraph"><p>Example:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="python"><span></span>    <span class="tok-k">yield</span> <span class="tok-n">Metric</span><span class="tok-p">(</span><span class="tok-n">name</span><span class="tok-o">=</span><span class="tok-s2">"fooslots"</span><span class="tok-p">,</span> <span class="tok-n">value</span><span class="tok-o">=</span><span class="tok-n">used</span><span class="tok-p">,</span> <span class="tok-n">boundaries</span><span class="tok-o">=</span><span class="tok-p">(</span><span class="tok-mi">0</span><span class="tok-p">,</span> <span class="tok-mi">200</span><span class="tok-p">))</span></code></pre></div></div>
<div class="paragraph"><p>And now once again our check function from the above example, but this time with
the return of metric information including threshold values and a value range
(this time of course not with fixed but with calculated values):</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">def</span> <span class="tok-nf">check_foobar</span><span class="tok-p">(</span><span class="tok-n">item</span><span class="tok-p">,</span> <span class="tok-n">section</span><span class="tok-p">):</span>
    <span class="tok-k">for</span> <span class="tok-n">sector</span><span class="tok-p">,</span> <span class="tok-n">used</span><span class="tok-p">,</span> <span class="tok-n">slots</span> <span class="tok-ow">in</span> <span class="tok-n">section</span><span class="tok-p">:</span>
        <span class="tok-k">if</span> <span class="tok-n">sector</span> <span class="tok-o">==</span> <span class="tok-n">item</span><span class="tok-p">:</span>
            <span class="tok-n">used</span> <span class="tok-o">=</span> <span class="tok-nb">int</span><span class="tok-p">(</span><span class="tok-n">used</span><span class="tok-p">)</span>    <span class="tok-c1"># convert string to int</span>
            <span class="tok-n">slots</span> <span class="tok-o">=</span> <span class="tok-nb">int</span><span class="tok-p">(</span><span class="tok-n">slots</span><span class="tok-p">)</span>  <span class="tok-c1"># convert string to int</span>

            <span class="tok-k">yield</span> <span class="tok-n">Metric</span><span class="tok-p">(</span>
                <span class="tok-s2">"fooslots"</span><span class="tok-p">,</span>
                <span class="tok-n">used</span><span class="tok-p">,</span>
                <span class="tok-n">levels</span><span class="tok-o">=</span><span class="tok-p">(</span><span class="tok-n">slots</span><span class="tok-o">-</span><span class="tok-mi">10</span><span class="tok-p">,</span> <span class="tok-n">slots</span><span class="tok-p">),</span>
                <span class="tok-n">boundaries</span><span class="tok-o">=</span><span class="tok-p">(</span><span class="tok-mi">0</span><span class="tok-p">,</span> <span class="tok-n">slots</span><span class="tok-p">))</span>

            <span class="tok-k">if</span> <span class="tok-n">used</span> <span class="tok-o">==</span> <span class="tok-n">slots</span><span class="tok-p">:</span>
                <span class="tok-n">s</span> <span class="tok-o">=</span> <span class="tok-n">State</span><span class="tok-o">.</span><span class="tok-n">CRIT</span>
            <span class="tok-k">elif</span> <span class="tok-n">slots</span> <span class="tok-o">-</span> <span class="tok-n">used</span> <span class="tok-o">&lt;=</span> <span class="tok-mi">10</span><span class="tok-p">:</span>
                <span class="tok-n">s</span> <span class="tok-o">=</span> <span class="tok-n">State</span><span class="tok-o">.</span><span class="tok-n">WARN</span>
            <span class="tok-k">else</span><span class="tok-p">:</span>
                <span class="tok-n">s</span> <span class="tok-o">=</span> <span class="tok-n">State</span><span class="tok-o">.</span><span class="tok-n">OK</span>
            <span class="tok-k">yield</span> <span class="tok-n">Result</span><span class="tok-p">(</span>
                <span class="tok-n">state</span> <span class="tok-o">=</span> <span class="tok-n">s</span><span class="tok-p">,</span>
                <span class="tok-n">summary</span> <span class="tok-o">=</span> <span class="tok-sa">f</span><span class="tok-s2">"used </span><span class="tok-si">{</span><span class="tok-n">used</span><span class="tok-si">}</span><span class="tok-s2"> out of </span><span class="tok-si">{</span><span class="tok-n">slots</span><span class="tok-si">}</span><span class="tok-s2"> slots"</span><span class="tok-p">)</span>
            <span class="tok-k">return</span></code></pre></div></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="heading__checks_with_multiple_partial_results">
<span class="hidden-anchor sr-only" id="_checks_with_multiple_partial_results"></span>5. Checks with multiple partial results</h2>
<div class="sectionbody">
<div class="paragraph"><p>In order to prevent the number of services on a host from growing out of all
control, several partial results are often combined in a single service.
For example, the <span class="guihint">Memory used</span> service under Linux checks not only RAM and swap
usage, but also shared memory, page tables and various other information.</p></div>
<div class="paragraph"><p>The API provided by Checkmk offers a very convenient interface for this. In this
way, a check function may simply generate a result with <code>yield</code> any
number of times. The overall status for the service is then based on the 'worst'
partial result according to the scheme <span class="state0">OK</span> → <span class="state1">WARN</span> → <span class="state3">UNKNOWN</span> → <span class="state2">CRIT</span>.</p></div>
<div class="paragraph"><p>Here is an abbreviated, fictitious example:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">def</span> <span class="tok-nf">check_foobar</span><span class="tok-p">(</span><span class="tok-n">section</span><span class="tok-p">):</span>
    <span class="tok-k">yield</span> <span class="tok-n">Result</span><span class="tok-p">(</span><span class="tok-n">state</span><span class="tok-o">=</span><span class="tok-n">State</span><span class="tok-o">.</span><span class="tok-n">OK</span><span class="tok-p">,</span> <span class="tok-n">summary</span><span class="tok-o">=</span><span class="tok-s2">"Knulf rate optimal"</span><span class="tok-p">)</span>
    <span class="tok-c1"># ...</span>
    <span class="tok-k">yield</span> <span class="tok-n">Result</span><span class="tok-p">(</span><span class="tok-n">state</span><span class="tok-o">=</span><span class="tok-n">State</span><span class="tok-o">.</span><span class="tok-n">WARN</span><span class="tok-p">,</span> <span class="tok-n">summary</span><span class="tok-o">=</span><span class="tok-s2">"Gnarz required"</span><span class="tok-p">)</span>
    <span class="tok-c1"># ...</span>
    <span class="tok-k">yield</span> <span class="tok-n">Result</span><span class="tok-p">(</span><span class="tok-n">state</span><span class="tok-o">=</span><span class="tok-n">State</span><span class="tok-o">.</span><span class="tok-n">OK</span><span class="tok-p">,</span> <span class="tok-n">summary</span><span class="tok-o">=</span><span class="tok-s2">"Last Szork was good"</span><span class="tok-p">)</span></code></pre></div></div>
<div class="paragraph"><p>The summary of the service in the GUI then looks like this:
"Knulf rate optimal, Gnarz required <span class="state1">WARN</span>, Last Szork was good".
And the overall status will be <span class="state1">WARN</span>.</p></div>
<div class="paragraph"><p>You can return multiple metrics in the same way.
Simply call <code>yield Metric(…​)</code> once for each metric.</p></div>
</div>
</div>
<div class="sect1">
<h2 id="heading__summary_and_details">
<span class="hidden-anchor sr-only" id="_summary_and_details"></span>6. Summary and Details</h2>
<div class="sectionbody">
<div class="paragraph"><p>In the Checkmk monitoring, each service also has a line of text in addition
to its status <span class="state0">OK</span>, <span class="state1">WARN</span>, and so on. Up until version <span class="new">1.6.0</span> this was
called <span class="guihint">Output of check plugin</span>. As of version <span class="new">2.0.0</span> this is now called
<span class="guihint">Summary</span> — so it has the task of providing a concise summary of the status.
The idea is that this text does not exceed a length of 60 characters,
so that it is always easy to read and ensures a clear table display without
annoying line breaks.</p></div>
<div class="paragraph"><p>Next to this there is the <span class="guihint">Details</span> field, which used to be called
<span class="guihint">Long output of check plugin (multiline)</span>. Here all of the details of the state
are displayed, the idea being that all of the summary information is included
here as well.</p></div>
<div class="paragraph"><p>When calling <code>yield Result(…​)</code> you can determine which information is
so important that it should be displayed in the summary and for which information
it is sufficient that it appears in the details. The default rule is that partial
results that lead to a <span class="state1">WARN</span>/<span class="state2">CRIT</span> will <em>always</em> be visible in the summary.</p></div>
<div class="paragraph"><p>In our examples so far we have always used the following call:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="python"><span></span>    <span class="tok-k">yield</span> <span class="tok-n">Result</span><span class="tok-p">(</span><span class="tok-n">state</span><span class="tok-o">=</span><span class="tok-n">State</span><span class="tok-o">.</span><span class="tok-n">OK</span><span class="tok-p">,</span> <span class="tok-n">summary</span><span class="tok-o">=</span><span class="tok-s2">"some important text"</span><span class="tok-p">)</span></code></pre></div></div>
<div class="paragraph"><p>This will cause <code>some important text</code> to always appear in the
<span class="guihint">Summary</span> — and additionally in the <span class="guihint">Details</span> — so you should only use
this for important information. If a partial result is of secondary importance,
replace <code>summary</code> with <code>notice</code> and the text will appear — if the service is <span class="state0">OK</span> <em>only</em> in the details.</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="python"><span></span>    <span class="tok-k">yield</span> <span class="tok-n">Result</span><span class="tok-p">(</span><span class="tok-n">state</span><span class="tok-o">=</span><span class="tok-n">State</span><span class="tok-o">.</span><span class="tok-n">OK</span><span class="tok-p">,</span> <span class="tok-n">notice</span><span class="tok-o">=</span><span class="tok-s2">"some additional text"</span><span class="tok-p">)</span></code></pre></div></div>
<div class="paragraph"><p>If the state is <span class="state1">WARN</span> or <span class="state2">CRIT</span>, the text will then automatically appear as an
addition in the summary:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="python"><span></span>    <span class="tok-k">yield</span> <span class="tok-n">Result</span><span class="tok-p">(</span><span class="tok-n">state</span><span class="tok-o">=</span><span class="tok-n">State</span><span class="tok-o">.</span><span class="tok-n">CRIT</span><span class="tok-p">,</span> <span class="tok-n">notice</span><span class="tok-o">=</span><span class="tok-s2">"some additional text"</span><span class="tok-p">)</span></code></pre></div></div>
<div class="paragraph"><p>Thus, in the summary it will be immediately clear why the service is not <span class="state0">OK</span>.</p></div>
<div class="paragraph"><p>Last but not least, you have — for both <code>summary</code> and <code>notice</code> — the possibility to specify an <em>alternative</em> text for the details,
which may contain more information about the partial result:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="python"><span></span>    <span class="tok-k">yield</span> <span class="tok-n">Result</span><span class="tok-p">(</span><span class="tok-n">state</span><span class="tok-o">=</span><span class="tok-n">State</span><span class="tok-o">.</span><span class="tok-n">OK</span><span class="tok-p">,</span>
                 <span class="tok-n">summary</span><span class="tok-o">=</span><span class="tok-s2">"55</span><span class="tok-si">% u</span><span class="tok-s2">sed space"</span><span class="tok-p">,</span>
                 <span class="tok-n">details</span><span class="tok-o">=</span><span class="tok-s2">"55.2</span><span class="tok-si">% o</span><span class="tok-s2">f 160 GB used (82 GB)"</span><span class="tok-p">)</span></code></pre></div></div>
<div class="paragraph"><p>To summarize, this means:</p></div>
<div class="ulist"><ul>
<li><p>The full text of the summary (for services that are <span class="state0">OK</span>) should not exceed 60 characters.</p></li>
<li><p>Always use either <code>summary</code> or <code>notice</code> — not both, and not neither.</p></li>
<li><p>Add <code>details</code> as necessary if you want the details text to be an alternative one.</p></li>
</ul></div>
</div>
</div>
<div class="sect1">
<h2 id="heading_errors">
<span class="hidden-anchor sr-only" id="errors"></span>7. Error handling</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="heading__exceptions_and_crash_reports">
<span class="hidden-anchor sr-only" id="_exceptions_and_crash_reports"></span>7.1. Exceptions and crash reports</h3>
<div class="paragraph"><p>The correct handling of errors (unfortunately) consumes a large chunk of the
programming work. The good news is that the Checkmk API already does most of the
work for you. Consequently, in most cases, it is important for you to simply
<strong>not</strong> deal with errors.</p></div>
<div class="paragraph"><p>When Python gets into a situation that is in some way <em>unexpected</em> ,
it responds with what is known as an <em>exception</em>. Here are a few examples:</p></div>
<div class="ulist"><ul>
<li><p>You convert a string into a number with <code>int(…​)</code>, but the string does not actually include a number, e.g. <code>int("foo")</code>.</p></li>
<li><p>You access the fifth element of <code>bar</code> with <code>bar[4]</code>, but this in fact has only four elements.</p></li>
<li><p>You are calling a function that does not exist.</p></li>
</ul></div>
<div class="paragraph"><p>Here the important general rule applies: <strong>Don’t capture exceptions yourself!</strong>
Checkmk will always do this for you in a consistent and efficient way — in most
cases accompanied by a <em>crash report</em>. Such a report will look like this, for
example:</p></div>
<div class="imageblock"><div class="content"><img src="../images/crash_report_1.png" alt="crash report 1"></div></div>
<div class="paragraph"><p>By clicking on the <span class="image-inline"><img src="../images/icons/icon_crash.png" alt="icon crash"></span> icon, the user is navigated to a page
where they can</p></div>
<div class="ulist"><ul>
<li><p>view a display of the file in which the crash took place.</p></li>
<li><p>get all information about the crash, for instance any error messages, call stack, agent output, the current values of local variables and much more.</p></li>
<li><p>send the report to us (Checkmk GmbH) as feedback.</p></li>
</ul></div>
<div class="paragraph"><p>Submitting the report to Checkmk GmbH of course only makes sense for check plug-ins
which are official Checkmk components. But you can also ask your users to simply
send you the data. The users can then help you to find the error. It is often
the case that a check plug-in works for you, but other users may experience
sporadic errors.
Working together you can then usually identify these problems very easily.</p></div>
<div class="paragraph"><p>But if you were to intercept the exception yourself, all of this information
would simply be unavailable. You would perhaps set the service to <span class="state3">UNKNOWN</span> and
issue an error message, but all of the background circumstances that led to an
error (e.g. the data from the agent) would simply be invisible.</p></div>
</div>
<div class="sect2">
<h3 id="heading__viewing_exceptions_on_the_command_line">
<span class="hidden-anchor sr-only" id="_viewing_exceptions_on_the_command_line"></span>7.2. Viewing exceptions on the command line</h3>
<div class="paragraph"><p>If you run your plug-in on the command line, no crash reports will be generated — you will only see the summarized error message:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="console"><span></span><span class="tok-gp">OMD[mysite]:~$ </span>cmk<span class="tok-w"> </span>-II<span class="tok-w"> </span>--detect-plugins<span class="tok-o">=</span>foobar<span class="tok-w"> </span>myhost123
<span class="tok-go">  WARNING: Exception in discovery function of check plugin 'foobar': invalid literal for int() with base 10: 'foo'</span></code></pre></div></div>
<div class="paragraph"><p>BUT: if you simply append the <code>--debug</code> option to this, you will then
receive the Python stack trace:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="console"><span></span><span class="tok-gp">OMD[mysite]:~$ </span>cmk<span class="tok-w"> </span>--debug<span class="tok-w"> </span>-II<span class="tok-w"> </span>--detect-plugins<span class="tok-o">=</span>foobar<span class="tok-w"> </span>myhost123
<span class="tok-go">Traceback (most recent call last):</span>
<span class="tok-go">  File "/omd/sites/myhost123/bin/cmk", line 82, in &lt;module&gt;</span>
<span class="tok-go">    exit_status = modes.call(mode_name, mode_args, opts, args)</span>
<span class="tok-go">  File "/omd/sites/myhost123/lib/python3/cmk/base/modes/<em>init</em>.py", line 68, in call</span>
<span class="tok-go">    return handler(*handler_args)</span>
<span class="tok-go">  File "/omd/sites/myhost123/lib/python3/cmk/base/modes/check_mk.py", line 1577, in mode_discover</span>
<span class="tok-go">    discovery.do_discovery(set(hostnames), options.get("checks"), options["discover"] == 1)</span>
<span class="tok-go">  File "/omd/sites/myhost123/lib/python3/cmk/base/discovery.py", line 345, in do_discovery</span>
<span class="tok-go">    _do_discovery_for(</span>
<span class="tok-go">  File "/omd/sites/myhost123/lib/python3/cmk/base/discovery.py", line 397, in _do_discovery_for</span>
<span class="tok-go">    discovered_services = _discover_services(</span>
<span class="tok-go">  File "/omd/sites/myhost123/lib/python3/cmk/base/discovery.py", line 1265, in _discover_services</span>
<span class="tok-go">    service_table.update({</span>
<span class="tok-go">  File "/omd/sites/myhost123/lib/python3/cmk/base/discovery.py", line 1265, in &lt;dictcomp&gt;</span>
<span class="tok-go">    service_table.update({</span>
<span class="tok-go">  File "/omd/sites/myhost123/lib/python3/cmk/base/discovery.py", line 1337, in _execute_discovery</span>
<span class="tok-go">    yield from _enriched_discovered_services(hostname, check_plugin.name, plugins_services)</span>
<span class="tok-go">  File "/omd/sites/myhost123/lib/python3/cmk/base/discovery.py", line 1351, in _enriched_discovered_services</span>
<span class="tok-go">    for service in plugins_services:</span>
<span class="tok-go">  File "/omd/sites/myhost123/lib/python3/cmk/base/api/agent_based/register/check_plugins.py", line 69, in filtered_generator</span>
<span class="tok-go">    for element in generator(*args, **kwargs):</span>
<span class="tok-go">  File "/omd/sites/myhost123/local/lib/python3/cmk/base/plugins/agent_based/foobar.py", line 5, in discover_foobar</span>
<span class="tok-go">    int("foo")</span>
<span class="tok-go">ValueError: invalid literal for int() with base 10: 'foo'</span></code></pre></div></div>
</div>
<div class="sect2">
<h3 id="heading__invalid_outputs_from_an_agent">
<span class="hidden-anchor sr-only" id="_invalid_outputs_from_an_agent"></span>7.3. Invalid outputs from an agent</h3>
<div class="paragraph"><p>The question is how to react when the output from the agent is not in the form
you would normally expect — whether it is from the 'real' agent or when the data
comes via <a href="snmp.html">SNMP</a>. Let’s assume that you always expect three words per line.
What should you do if only two words were to arrive?</p></div>
<div class="paragraph"><p>Now — if this is a <em>permitted and familiar</em> agent behaviour, then of course
you need to capture that and employ case discrimination.</p></div>
<div class="paragraph"><p>If, however, this is not actually allowed …​ then it is best to treat the line
as if it always contains three words, e.g. with:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">def</span> <span class="tok-nf">check_foobar</span><span class="tok-p">(</span><span class="tok-n">section</span><span class="tok-p">):</span>
    <span class="tok-k">for</span> <span class="tok-n">foo</span><span class="tok-p">,</span> <span class="tok-n">bar</span><span class="tok-p">,</span> <span class="tok-n">baz</span> <span class="tok-ow">in</span> <span class="tok-n">section</span><span class="tok-p">:</span>
        <span class="tok-c1"># ...</span></code></pre></div></div>
<div class="paragraph"><p>If there should ever be a line that does not consist of exactly three words,
a nice exception will be generated and you will receive the very helpful crash
report that was just mentioned.</p></div>
</div>
<div class="sect2">
<h3 id="heading__missing_items">
<span class="hidden-anchor sr-only" id="_missing_items"></span>7.4. Missing items</h3>
<div class="paragraph"><p>What if the agent outputs data correctly, but the item to be checked is missing?
So, like this, for example:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">def</span> <span class="tok-nf">check_foobar</span><span class="tok-p">(</span><span class="tok-n">item</span><span class="tok-p">,</span> <span class="tok-n">section</span><span class="tok-p">):</span>
    <span class="tok-k">for</span> <span class="tok-n">sector</span><span class="tok-p">,</span> <span class="tok-n">used</span><span class="tok-p">,</span> <span class="tok-n">slots</span> <span class="tok-ow">in</span> <span class="tok-n">section</span><span class="tok-p">:</span>
        <span class="tok-k">if</span> <span class="tok-n">item</span> <span class="tok-o">==</span> <span class="tok-n">sector</span><span class="tok-p">:</span>
            <span class="tok-c1"># ... Check state ...</span>
            <span class="tok-k">yield</span> <span class="tok-n">Result</span><span class="tok-p">(</span><span class="tok-o">...</span><span class="tok-p">)</span>
            <span class="tok-k">return</span></code></pre></div></div>
<div class="paragraph"><p>If the item you are looking for is not there, the loop is run and Python just
falls out of the back at the end of the function without 'yielding' a
result. And that’s exactly the correct procedure! Because Checkmk recognizes that
the item to be monitored is missing and with <span class="state3">UNKNOWN</span> generates the correct
status and a suitable standard text for it.</p></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="heading_snmp">
<span class="hidden-anchor sr-only" id="snmp"></span>8. SNMP-based checks</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="heading__the_fundamentals">
<span class="hidden-anchor sr-only" id="_the_fundamentals"></span>8.1. The fundamentals</h3>
<div class="paragraph"><p>Developing checks that work with SNMP is very similar to agent-based checks,
except that you still need to specify which SNMP ranges (OIDs) the check requires.
If you don’t as yet have any experience with SNMP, we strongly recommend reading
the article on <a href="snmp.html">Monitoring via SNMP</a> as preparation at this point.</p></div>
<div class="paragraph"><p>The process of discovery and checking via SNMP is somewhat different from that
for a normal agent. Because unlike there — where the agent sends all of the
relevant information on its own — with SNMP we have to say exactly which data
ranges we require. A complete dump of all data would be theoretically possible
(via SNMP walk), but this process can take minutes for fast devices and
over an hour for complex switches. Thus, this is not viable for checking or even
for discovery. Checkmk therefore proceeds in a more targeted manner.</p></div>
<div class="sect3">
<h4 id="heading__snmp_detection">
<span class="hidden-anchor sr-only" id="_snmp_detection"></span>SNMP detection</h4>
<div class="paragraph"><p>Service detection is divided into two phases. First, the <em>SNMP detection</em>
is performed. This determines which plug-ins on the respective device are of
actual interest. To do this, a few SNMP OIDs are retrieved — individually,
without a walk. The most important of these is the
<code>sysDescr</code> (OID: <code>1.3.6.1.2.1.1.0</code>). Under this OID, each SNMP
device holds a description of itself,
e.g. ‘Cisco NX-OS(tm) n5000, Software (n5000-uk9),…​’.</p></div>
<div class="paragraph"><p>Based on this text, you can already define for very many plug-ins whether they
can be useful for this application. If the text is still not specific enough,
further OIDs are fetched and checked. The result of the SNMP detection will then
be a list of candidates for check plug-ins.</p></div>
</div>
<div class="sect3">
<h4 id="heading__discovery">
<span class="hidden-anchor sr-only" id="_discovery"></span>Discovery</h4>
<div class="paragraph"><p>In the second step, the necessary monitoring data is fetched for each of these
candidates with SNMP walks. These are then combined into a table and provided to
the check’s discovery function with the <code>section</code> argument, which then as
usual determines the items to be monitored.</p></div>
</div>
<div class="sect3">
<h4 id="heading__checking">
<span class="hidden-anchor sr-only" id="_checking"></span>Checking</h4>
<div class="paragraph"><p>When running checks, it is already known which plug-ins are to be executed for
the device and the SNMP detection is now omitted. Here the monitoring data
needed for the plug-ins are fetched immediately by SNMP walks and from it the
<code>section</code> argument for the check function is filled.</p></div>
</div>
<div class="sect3">
<h4 id="heading__summary">
<span class="hidden-anchor sr-only" id="_summary"></span>Summary</h4>
<div class="paragraph"><p>So what do you need to do differently with an SNMP check compared to an
agent-based one?</p></div>
<div class="olist arabic"><ol class="arabic">
<li><p>You do not need a plug-in for the agent.</p></li>
<li><p>You must define the single OIDs and search texts required for an SNMP detection.</p></li>
<li><p>You have to define which SNMP areas must be fetched for monitoring.</p></li>
</ol></div>
</div>
</div>
<div class="sect2">
<h3 id="heading__a_word_about_the_mibs">
<span class="hidden-anchor sr-only" id="_a_word_about_the_mibs"></span>8.2. A word about the MIBs</h3>
<div class="paragraph"><p>Before we continue, we want to say a word about the infamous SNMP MIBs, because
there are many prejudices about these. Right at the beginning, some good news:
Checkmk doesn’t need them. Really! But they are an important aid in being able to
<em>develop</em> an SNMP check.</p></div>
<div class="paragraph"><p>So what is a MIB? Literally, the abbreviation means
<em>Management Information Base</em> — somewhat meaningless really.
To be concrete, a MIB is a quite easy to read text file which describes a
certain subtree in the SNMP world. Namely, it states which branch in the
tree — that is, which <em>OID</em> — has which meaning. This includes a name for
the OID, a comment on what values it can take (e.g. for enumerated data types,
where things like 1=up, 2=down, etc. are defined) and sometimes a useful comment.</p></div>
<div class="paragraph"><p>Checkmk provides a set of freely-available MIB files. These describe very general
areas in the global OID tree, but do not contain any vendor-specific areas.
Therefore they are of not much help for self-developed checks.</p></div>
<div class="paragraph"><p>So try to find the MIB files relevant for your particular device somewhere on
the manufacturer’s web pages or even on the device’s management interface,
and install these in the Checkmk site in <code>local/share/check_mk/mibs</code>.
You can then have SNMP walks convert OID numbers to names and can thus more
quickly find where the data of interest for your monitoring is located.
Also, MIBs, if done carefully, contain interesting information in their
comments, as we noted above. You can easily read an MIB file with a text editor
or with <code>less</code>.</p></div>
</div>
<div class="sect2">
<h3 id="heading_locating_oids">
<span class="hidden-anchor sr-only" id="locating_oids"></span>8.3. Locating the correct OIDs</h3>
<div class="paragraph"><p>The crucial prerequisite for developing a plug-in is, of course, that you know
which OIDs contain the necessary information. The first step in doing this (if
the device doesn’t refuse) is to perform a complete SNMP walk.
This will retrieve <em>all</em> of the available data via SNMP.</p></div>
<div class="paragraph"><p>Checkmk can accomplish this very easily for you. To do so, first include the
device (or one of the devices) for which you want to develop a plug-in into your
monitoring. Let’s say this device is called <code>mydevice01</code>. Check in the
device’s basic functions to make sure that it can be monitored.
As a minimum, the <span class="guihint">SNMP Info</span> and <span class="guihint">Uptime</span> services need to be found,
and probably at least one <span class="guihint">Interface</span> as well.
This is how you make sure that SNMP access works cleanly.</p></div>
<div class="paragraph"><p>Then switch to the command line in the Checkmk site. Here you can perform a
complete walk with the following command. We recommend using the <code>-v</code>
(verbose) option when doing this for the very first time:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="console"><span></span><span class="tok-gp">OMD[mysite]:~$ </span>cmk<span class="tok-w"> </span>-v<span class="tok-w"> </span>--snmpwalk<span class="tok-w"> </span>mydevice01
<span class="tok-go">mydevice01:</span>
<span class="tok-go">Walk on ".1.3.6.1.2.1"...3898 variables.</span>
<span class="tok-go">Walk on ".1.3.6.1.4.1"...6025 variables.</span>
<span class="tok-go">Wrote fetched data to /omd/sites/heute/var/check_mk/snmpwalks/mydevice01.</span></code></pre></div></div>
<div class="paragraph"><p>As mentioned earlier, such a complete walk can take minutes or even
hours — although the latter is rare. So don’t become nervous if it takes a
while to complete this process. The walk will be saved in the file
<code>var/check_mk/snmpwalks/mydevice01</code>.
This will be a easily-readable text file that starts something like this:</p></div>
<div class="listingblock">
<div class="title">var/check_mk/snmpwalks/mydevice01</div>
<div class="content"><pre class="pygments highlight"><code><span></span>.1.3.6.1.2.1.1.1.0 JetStream 24-Port Gigabit L2 Managed Switch with 4 Combo SFP Slots
.1.3.6.1.2.1.1.2.0 .1.3.6.1.4.1.11863.1.1.3
.1.3.6.1.2.1.1.3.0 546522419
.1.3.6.1.2.1.1.4.0 hh@example.com
.1.3.6.1.2.1.1.5.0 sw-ks-01
.1.3.6.1.2.1.1.6.0 Core Switch Serverraum klein
.1.3.6.1.2.1.1.7.0 3
.1.3.6.1.2.1.2.1.0 27</code></pre></div>
</div>
<div class="paragraph"><p>In each line there is an OID and then its value. And right there in the first
line you find the most important one, namely the <code>sysDescr</code>.</p></div>
<div class="paragraph"><p>Now the OIDs themselves are not very informative. If the correct MIBs are
installed, you can have them converted to names in a second step with
the <code>cmk --snmptranslate</code> command. It is best to redirect the result — which would otherwise appear in the terminal — to a file:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="console"><span></span><span class="tok-gp">OMD[heute]:~$ </span>cmk<span class="tok-w"> </span>--snmptranslate<span class="tok-w"> </span>mydevice01<span class="tok-w">  </span>&gt;<span class="tok-w"> </span>translated
<span class="tok-go">Processing 9923 lines.</span>
<span class="tok-go">finished.</span></code></pre></div></div>
<div class="paragraph"><p>The <code>translated</code> file reads like the original walk, but has a translated
value for the OID on each line after the <code>--&gt;</code>:</p></div>
<div class="listingblock">
<div class="title">translated</div>
<div class="content"><pre class="pygments highlight"><code><span></span>.1.3.6.1.2.1.1.1.0 JetStream 24-Port Gigabit L2 Managed Switch with 4 Combo SFP Slots --&gt; SNMPv2-MIB::sysDescr.0
.1.3.6.1.2.1.1.2.0 .1.3.6.1.4.1.11863.1.1.3 --&gt; SNMPv2-MIB::sysObjectID.0
.1.3.6.1.2.1.1.3.0 546522419 --&gt; DISMAN-EVENT-MIB::sysUpTimeInstance
.1.3.6.1.2.1.1.4.0 hh@example.com --&gt; SNMPv2-MIB::sysContact.0
.1.3.6.1.2.1.1.5.0 sw-ks-01 --&gt; SNMPv2-MIB::sysName.0
.1.3.6.1.2.1.1.6.0 Core Switch Serverraum klein --&gt; SNMPv2-MIB::sysLocation.0
.1.3.6.1.2.1.1.7.0 3 --&gt; SNMPv2-MIB::sysServices.0
.1.3.6.1.2.1.2.1.0 27 --&gt; IF-MIB::ifNumber.0
.1.3.6.1.2.1.2.2.1.1.1 1 --&gt; IF-MIB::ifIndex.1
.1.3.6.1.2.1.2.2.1.1.2 2 --&gt; IF-MIB::ifIndex.2</code></pre></div>
</div>
<div class="paragraph"><p>Example: the OID <code>.1.3.6.1.2.1.1.4.0</code> has the translated name
<code>SNMPv2-MIB::sysContact.0</code>. This is an important hint — the rest is then
practice, experience and of course experimentation.</p></div>
</div>
<div class="sect2">
<h3 id="heading__registering_the_snmp_section">
<span class="hidden-anchor sr-only" id="_registering_the_snmp_section"></span>8.4. Registering the SNMP section</h3>
<div class="paragraph"><p>So, once you have determined the necessary OIDs, it’s on to the actual
development of the plug-in. This is done in three steps:</p></div>
<div class="olist arabic"><ol class="arabic">
<li><p>For an SNMP detection, specify which OIDs must contain which texts for your plug-in to run.</p></li>
<li><p>Declare which OID branches need to be fetched for the monitoring.</p></li>
<li><p>Write a check plug-in analogous to those for agent-based checks.</p></li>
</ol></div>
<div class="paragraph"><p>The first two steps are performed by registering an SNMP section.
You do this by calling <code>register.snmp_section()</code>. Here you specify at
least three arguments: the name of the section (<code>name</code>), the details for
the SNMP detect <code>detect</code>, and the OID branches needed for actually
monitoring (<code>fetch</code>). Here is an example of a hypothetical check plug-in
with the name <code>foo</code>:</p></div>
<div class="listingblock">
<div class="title">local/lib/check_mk/base/plugins/agent_based/foo.py</div>
<div class="content"><pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-n">register</span><span class="tok-o">.</span><span class="tok-n">snmp_section</span><span class="tok-p">(</span>
    <span class="tok-n">name</span> <span class="tok-o">=</span> <span class="tok-s2">"foo"</span><span class="tok-p">,</span>
    <span class="tok-n">detect</span> <span class="tok-o">=</span> <span class="tok-n">startswith</span><span class="tok-p">(</span><span class="tok-s2">".1.3.6.1.2.1.1.1.0"</span><span class="tok-p">,</span> <span class="tok-s2">"foobar device"</span><span class="tok-p">),</span>
    <span class="tok-n">fetch</span> <span class="tok-o">=</span> <span class="tok-n">SNMPTree</span><span class="tok-p">(</span>
        <span class="tok-n">base</span> <span class="tok-o">=</span> <span class="tok-s1">'.1.3.6.1.4.1.35424.1.2'</span><span class="tok-p">,</span>
        <span class="tok-n">oids</span> <span class="tok-o">=</span> <span class="tok-p">[</span>
            <span class="tok-s1">'4.0'</span><span class="tok-p">,</span>
            <span class="tok-s1">'5.0'</span><span class="tok-p">,</span>
            <span class="tok-s1">'8.0'</span><span class="tok-p">,</span>
        <span class="tok-p">],</span>
    <span class="tok-p">),</span>
<span class="tok-p">)</span></code></pre></div>
</div>
<div class="sect3">
<h4 id="heading__the_snmp_detection">
<span class="hidden-anchor sr-only" id="_the_snmp_detection"></span>The SNMP detection</h4>
<div class="paragraph"><p>With the keyword <code>detect</code> you specify under which conditions the discovery
function should be executed. In our example, this is the case if the value of the
OID <code>.1.3.6.1.2.1.1.0</code> (i.e. the <code>sysDescr</code>) starts with the text
<code>foobar device</code> (case-insensitive in principle). In addition to
<code>startswith</code>, there are a number of other possible attributes. There is
also a negated form of each of these, which begins with <code>not_</code>:</p></div>
<table class="table-responsive table-bordered table tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 28%;">
<col style="width: 33%;">
<col style="width: 39%;">
</colgroup>
<thead><tr>
<th class="tableblock halign-left valign-top">Attribute</th>
<th class="tableblock halign-left valign-top">Negation</th>
<th class="tableblock halign-left valign-top">Function</th>
</tr></thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">equals(oid, needle)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">not_equals(oid, needle)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The value of the OID is equal to the text <code>needle</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">contains(oid, needle)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">not_contains(oid, needle)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The value of the OID at some point contains the text <code>needle</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">startswith(oid, needle)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">not_startswith(oid, needle)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The value of the OID starts with the text <code>needle</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">endswith(oid, needle)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">not_endswith(oid, needle)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The value of the OID ends with the text <code>needle</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">matches(oid, regex)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">not_matches(oid, regex)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The value of OID matches the <a href="regexes.html">regular expression</a> <code>regex</code>, anchored at the start and at the end — so with an exact match. If you only need a substring, just add another <code>.*</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">exists(oid)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">not_exists(oid)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Met if the OID is available on the device. The value may be empty.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph"><p>As well as the above, there is also the possibility of linking multiple tests with
<code>all_of</code> or <code>any_of</code>. The option <code>all_of</code> requires multiple
successful attributes for a positive discovery of the plug-in. The following
example finds the plug-in on a device if <code>sysDescr</code> starts with the text
<code>foo</code> (or <code>FOO</code> or <code>Foo</code>) <strong>and</strong> the
OID <code>.1.3.6.1.2.1.2.0</code> contains the text <code>.4.1.11863.</code>:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-n">detect</span> <span class="tok-o">=</span> <span class="tok-n">all_of</span><span class="tok-p">(</span>
    <span class="tok-n">startswith</span><span class="tok-p">(</span><span class="tok-s2">".1.3.6.1.2.1.1.1.0"</span><span class="tok-p">,</span> <span class="tok-s2">"foo"</span><span class="tok-p">),</span>
    <span class="tok-n">contains</span><span class="tok-p">(</span><span class="tok-s2">".1.3.6.1.2.1.1.2.0"</span><span class="tok-p">,</span> <span class="tok-s2">".4.1.11863."</span><span class="tok-p">)</span>
<span class="tok-p">)</span></code></pre></div></div>
<div class="paragraph"><p>The <code>any_of</code> option, on the other hand, is satisfied if any single one of
the criteria is met. Here is an example where different values are allowed for
the  <code>sysDescr</code> keyword:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-n">detect</span> <span class="tok-o">=</span> <span class="tok-n">any_of</span><span class="tok-p">(</span>
    <span class="tok-n">startswith</span><span class="tok-p">(</span><span class="tok-s2">".1.3.6.1.2.1.1.1.0"</span><span class="tok-p">,</span> <span class="tok-s2">"foo version 3 system"</span><span class="tok-p">),</span>
    <span class="tok-n">startswith</span><span class="tok-p">(</span><span class="tok-s2">".1.3.6.1.2.1.1.1.0"</span><span class="tok-p">,</span> <span class="tok-s2">"foo version 4 system"</span><span class="tok-p">),</span>
    <span class="tok-n">startswith</span><span class="tok-p">(</span><span class="tok-s2">".1.3.6.1.2.1.1.1.0"</span><span class="tok-p">,</span> <span class="tok-s2">"foo version 4.1 system"</span><span class="tok-p">),</span>
<span class="tok-p">)</span></code></pre></div></div>
<div class="paragraph"><p>By the way — are you familiar with <a href="regexes.html">regular expressions</a>? If so, with
these you would probably simplify this whole process and still get by with just
a single line:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-n">detect</span> <span class="tok-o">=</span> <span class="tok-n">matches</span><span class="tok-p">(</span><span class="tok-s2">".1.3.6.1.2.1.1.1.0"</span><span class="tok-p">,</span> <span class="tok-s2">"FOO Version (3|4|4.1) .*"</span><span class="tok-p">),</span></code></pre></div></div>
<div class="paragraph"><p>And one more important note: The OIDs you specify in the <code>detect</code>
declaration from a plug-in will, in case of doubt, be fetched from <strong>every</strong>
device that is monitored via SNMP. Therefore, be very sparing in your use of
vendor-specific OIDs. Try to make your discovery absolutely exclusive to the
<code>sysDescr</code> (<code>.1.3.6.1.2.1.1.1.0</code>) and the <code>sysObjectID</code>
(<code>.1.3.6.1.2.1.1.2.0</code>). If you still need another different OID, then
reduce the number of devices where it is requested to a minimum by excluding as
many devices as possible beforehand using the <code>sysDescr</code>, e.g. like this:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-n">detect</span> <span class="tok-o">=</span> <span class="tok-n">all_of</span><span class="tok-p">(</span>
    <span class="tok-n">startswith</span><span class="tok-p">(</span><span class="tok-s2">".1.3.6.1.2.1.1.1.0"</span><span class="tok-p">,</span> <span class="tok-s2">"foo"</span><span class="tok-p">),</span>   <span class="tok-c1"># first check sysDescr</span>
    <span class="tok-n">contains</span><span class="tok-p">(</span><span class="tok-s2">".1.3.6.1.4.1.4455.1.3"</span><span class="tok-p">,</span> <span class="tok-s2">"bar"</span><span class="tok-p">),</span>  <span class="tok-c1"># fetch vendor specific OID</span>
<span class="tok-p">)</span></code></pre></div></div>
<div class="paragraph"><p>The <code>all_of()</code> works in such a way that if the first condition fails,
the second is not even tried (and thus the OID in question is not fetched).
Here in the example, the OID <code>.1.3.6.1.4.1.4455.1.3</code> is fetched only for
those devices that have <code>foo</code> in their <code>sysDescr</code>.</p></div>
<div class="paragraph"><p>What happens if you have made the declaration incorrectly or at least not quite
on target?</p></div>
<div class="ulist"><ul>
<li><p>If the detection erroneously detects devices that do not have the necessary OIDs, your discovery function will not generate any services — so nothing 'bad' will happen. However, this will slow down the discovery on such devices, because now every time it will pointlessly try to retrieve the corresponding OIDs.</p></li>
<li><p>If the detection does <em>not</em> detect devices that are actually allowed, during the discovery no services will be found in the monitoring.</p></li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="heading__the_oid_ranges_for_monitoring">
<span class="hidden-anchor sr-only" id="_the_oid_ranges_for_monitoring"></span>8.5. The OID ranges for monitoring</h3>
<div class="paragraph"><p>The most important part of the SNMP declaration is the specification of which
OIDs are to be fetched for the monitoring. In almost all cases, a plug-in only
needs selected branches from a single table to do this.
Let’s consider the following example:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="python"><span></span>    <span class="tok-n">fetch</span> <span class="tok-o">=</span> <span class="tok-n">SNMPTree</span><span class="tok-p">(</span>
        <span class="tok-n">base</span> <span class="tok-o">=</span> <span class="tok-s1">'.1.3.6.1.4.1.35424.1.2'</span><span class="tok-p">,</span>
        <span class="tok-n">oids</span> <span class="tok-o">=</span> <span class="tok-p">[</span>
            <span class="tok-s1">'4.0'</span><span class="tok-p">,</span>
            <span class="tok-s1">'5.0'</span><span class="tok-p">,</span>
            <span class="tok-s1">'8.0'</span><span class="tok-p">,</span>
        <span class="tok-p">],</span>
    <span class="tok-p">),</span></code></pre></div></div>
<div class="paragraph"><p>The keyword <code>base</code> specifies an OID prefix here.
All necessary data is below. At <code>oids</code> you then specify a list of
sub-OIDs to be fetched from there. In the above example, a total of three SNMP
walks are then made, namely on starting from the OIDs
<code>.1.3.6.1.4.1.35424.1.2.4.0</code> and <code>.1.3.6.1.4.1.35424.1.2.5.0</code>
and <code>.1.3.6.1.4.1.35424.1.2.8.0</code>. It is important that these walks fetch
the same number of variables and that they also correspond to each other.
This means that, for example, the nth element from each of the walks corresponds
to the same monitored object.</p></div>
<div class="paragraph"><p>Here is an example from the check plug-in <code>snmp_quantum_storage_info</code>:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="python"><span></span>    <span class="tok-n">tree</span> <span class="tok-o">=</span> <span class="tok-n">SNMPTree</span><span class="tok-p">(</span>
       <span class="tok-n">base</span><span class="tok-o">=</span><span class="tok-s2">".1.3.6.1.4.1.2036.2.1.1"</span><span class="tok-p">,</span>  <span class="tok-c1"># qSystemInfo</span>
       <span class="tok-n">oids</span><span class="tok-o">=</span><span class="tok-p">[</span>
           <span class="tok-s2">"4"</span><span class="tok-p">,</span>   <span class="tok-c1"># qVendorID</span>
           <span class="tok-s2">"5"</span><span class="tok-p">,</span>   <span class="tok-c1"># qProdId</span>
           <span class="tok-s2">"6"</span><span class="tok-p">,</span>   <span class="tok-c1"># qProdRev</span>
           <span class="tok-s2">"12"</span><span class="tok-p">,</span>  <span class="tok-c1"># qSerialNumber</span>
       <span class="tok-p">],</span>
    <span class="tok-p">),</span>
<span class="tok-p">)</span></code></pre></div></div>
<div class="paragraph"><p>Here, the vendor ID, the product ID, the product revision and the serial number
are retrieved from each storage device.</p></div>
<div class="paragraph"><p>The discovery and check function is presented with this data as a table,
i.e. as a list of lists. The table is mirrored so that you have all of the data
for each item per entry in the outer list. Each entry has as many items as you
specified in <code>oids</code>.
This allows you to loop through the list in a very practical way, e.g.:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="python"><span></span>    <span class="tok-k">for</span> <span class="tok-n">vendor_id</span><span class="tok-p">,</span> <span class="tok-n">prod_id</span><span class="tok-p">,</span> <span class="tok-n">prod_rev</span><span class="tok-p">,</span> <span class="tok-n">serial_number</span> <span class="tok-ow">in</span> <span class="tok-n">section</span><span class="tok-p">:</span>
        <span class="tok-o">...</span></code></pre></div></div>
<div class="paragraph"><p>Please note:</p></div>
<div class="ulist"><ul>
<li><p>All entries are <em>strings</em>, even if the OIDs in question are actually numbers.</p></li>
<li><p>Missing OIDs are presented as empty strings.</p></li>
<li><p>Remember the ability to output formatted data during development with <code>pprint</code>.</p></li>
</ul></div>
</div>
<div class="sect2">
<h3 id="heading__other_snmp_special_features">
<span class="hidden-anchor sr-only" id="_other_snmp_special_features"></span>8.6. Other SNMP special features</h3>
<div class="paragraph"><p>We will describe here in the future:</p></div>
<div class="ulist"><ul>
<li><p>How to retrieve multiple independent SNMP areas.</p></li>
<li><p>What OIDEnd() is all about</p></li>
<li><p>Other special cases when dealing with SNMP</p></li>
</ul></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="heading_format_numbers">
<span class="hidden-anchor sr-only" id="format_numbers"></span>9. Formatting numbers</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="heading__the_basics">
<span class="hidden-anchor sr-only" id="_the_basics"></span>9.1. The basics</h3>
<div class="paragraph"><p>In the summary or details for a service, numbers are often output. To make it as
easy as possible for you to format them nicely and correctly, and also to
standardize the output from all check plug-ins, there are helper functions for
rendering different kinds of sizes. All of these are sub-functions of the
<code>render</code> module and are consequently called with <code>render.</code>.
For example, <code>render.bytes(2000)</code> results in the text <code>1.95 KiB</code>.</p></div>
<div class="paragraph"><p>What all of these functions have in common is that they get their values in a
so-called <em>canonical</em> or natural unit. Thus one must never think, and there
are no difficulties or errors with the conversion. For example, times are always
given in seconds, and the sizes of hard disks, files, etc. are always given in
bytes and not in kilobytes, kibibytes, blocks or any other confusion of units.</p></div>
<div class="paragraph"><p>Please use these functions even if you don’t like the display so much.
After all, this is then consistent for the user. And future versions of Checkmk
may be able to change the display or even make it configurable for the user.
Your check plug-in will then also benefit from this.</p></div>
<div class="paragraph"><p>Following the detailed description of all of the display functions
(render functions), you will find a summary of these in the form of a clear table.</p></div>
</div>
<div class="sect2">
<h3 id="heading__times_time_spans_frequencies">
<span class="hidden-anchor sr-only" id="_times_time_spans_frequencies"></span>9.2. Times, time spans, frequencies</h3>
<div class="paragraph"><p>Absolute time specifications (timestamps) are formatted with
<code>render.date()</code> or <code>render.datetime()</code>. The specifications are
always in <em>seconds from January 1, 1970, 00:00:00 UTC</em> — the so-called
epoch time. This is also the format used by the Python function
<code>time.time()</code>. The advantage of this representation is that it can be
used to calculate very easily, for example, the duration of an operation if the
start and end times are known. The formula is then simply
<code>duration = end - start</code>. These calculations also work independently of
the time zone, daylight saving time changes or leap years.</p></div>
<div class="paragraph"><p><code>render.date()</code> outputs only the date, <code>render.datetime()</code> adds
the time. The output is done according to the current time zone for the Checkmk server that is running the check!</p></div>
<div class="paragraph"><p>Examples:</p></div>
<table class="table-responsive table-bordered table tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead><tr>
<th class="tableblock halign-left valign-top">Call</th>
<th class="tableblock halign-left valign-top">Output</th>
</tr></thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">render.date(0)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Jan 01 1970</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">render.datetime(0)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Jan 01 1970 01:00:00</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">render.date(1600000000)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Sep 13 2020</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">render.datetime(1600000000)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Sep 13 2020 14:26:40</p></td>
</tr>
</tbody>
</table>
<div class="paragraph"><p>Now please don’t be surprised that <code>render.date(0)</code> outputs 01:00 as the
time instead of 00:00! This is because we are writing this manual in the time zone
for Germany, which is one hour ahead of UTC standard time (at least during
standard time, because, as you know, January 1 is not in (the European Summer)
daylight saving time)</p></div>
<div class="paragraph"><p>For <em>timespan</em> there is still the function <code>render.timespan()</code>.
This produces a duration in seconds and outputs it in a human readable form.
For larger time spans, seconds or minutes are omitted.</p></div>
<table class="table-responsive table-bordered table tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead><tr>
<th class="tableblock halign-left valign-top">Call</th>
<th class="tableblock halign-left valign-top">Output</th>
</tr></thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">render.timespan(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1 second</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">render.timespan(123)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2 minutes 3 seconds</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">render.timespan(12345)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3 hours 25 minutes</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">render.timespan(1234567)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">14 days 6 hours</p></td>
</tr>
</tbody>
</table>
<div class="paragraph"><p>A <em>frequency</em> is effectively the reciprocal of time.
The canonical unit is <em>Hz</em>, which is equivalent to once per second.
A field of application is, for example, for the clock rate of a CPU:</p></div>
<table class="table-responsive table-bordered table tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead><tr>
<th class="tableblock halign-left valign-top">Call</th>
<th class="tableblock halign-left valign-top">Output</th>
</tr></thead>
<tbody><tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">render.frequency(111222333444)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">111 GHz</p></td>
</tr></tbody>
</table>
</div>
<div class="sect2">
<h3 id="heading__bytes">
<span class="hidden-anchor sr-only" id="_bytes"></span>9.3. Bytes</h3>
<div class="paragraph"><p>Whenever memory, files, hard disks, file systems and the like are concerned,
the canonical unit is the <em>byte</em>. Since computers usually organize such
things in powers of two, e.g. in units of 512, 1024 or 65536 bytes, from the
beginning it has been accepted that a <em>kilobyte</em> is not 1000 but 1024 bytes.
This is in itself very practical, because in this way mostly round numbers
came out. The legendary Commodore C64 had a 64 kilobyte memory and not 65,536.</p></div>
<div class="paragraph"><p>Unfortunately, at some point hard disk manufacturers came up with the idea of
specifying the sizes of their disks in 1000’s of units. Since the difference
between 1000 and 1024 is 2.4% for each size, and these are multiplied,
a 1 GB disk (1024 times 1024 * 1024) suddenly becomes 1.07 GB. That sells better.</p></div>
<div class="paragraph"><p>This annoying confusion persists to this day and continues to cause errors.
As a remedy, new prefixes based on the binary system were defined by the
International Electrotechnical Commission. Accordingly, nowadays a kilobyte is
officially 1000 bytes, and a <em>kibibyte</em> is 1024 bytes (2 to the power of 10).
In addition one should say <em>Mebibyte</em> and <em>Gibitbyte</em> and
<em>Tebibyte</em> (ever heard of these?). The abbreviations are (attention,
here at once always <strong>i</strong>, instead of <strong>e</strong>!) <em>KiB</em>, <em>MiB</em>,
<em>GiB</em> and <em>TiB</em>.</p></div>
<div class="paragraph"><p>Checkmk adapts itself to this standard and helps you with multiple adapted render
functions so that you can always produce correct outputs. So specifically for
hard disks and file systems there is the <code>render.disksize()</code> function,
which gives the output in powers of 1000.</p></div>
<table class="table-responsive table-bordered table tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead><tr>
<th class="tableblock halign-left valign-top">Call</th>
<th class="tableblock halign-left valign-top">Output</th>
</tr></thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">render.disksize(1000)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1.00 kB</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">render.disksize(1024)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1.02 kB</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">render.disksize(2000000)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2.00 MB</p></td>
</tr>
</tbody>
</table>
<div class="paragraph"><p>For the sizes of <em>files</em> it is common to specify the exact size in
bytes <em>without rounding</em>. This has the advantage that you can see very
quickly if a file has changed even minimally or that two files are (probably)
the same. The <code>render.filesize()</code> function is responsible for this:</p></div>
<table class="table-responsive table-bordered table tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead><tr>
<th class="tableblock halign-left valign-top">Call</th>
<th class="tableblock halign-left valign-top">Output</th>
</tr></thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">render.filesize(1000)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1,000 B</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">render.filesize(1024)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1,024 B</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">render.filesize(2000000)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2,000,000 B</p></td>
</tr>
</tbody>
</table>
<div class="paragraph"><p>If you want to output a size that is not a disk or a file size, just use the
generic <code>render.bytes()</code>.
This will give you the output in the classic 1024’s in the new official notation:</p></div>
<table class="table-responsive table-bordered table tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead><tr>
<th class="tableblock halign-left valign-top">Call</th>
<th class="tableblock halign-left valign-top">Output</th>
</tr></thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">render.bytes(1000)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1000 B</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">render.bytes(1024)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1.00 KiB</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">render.bytes(2000000)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1.91 MiB</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect2">
<h3 id="heading__bandwidths_and_data_rates">
<span class="hidden-anchor sr-only" id="_bandwidths_and_data_rates"></span>9.4. Bandwidths and data rates</h3>
<div class="paragraph"><p>Networkers have their own terms and ways of expressing things. And as always,
in each domain Checkmk tries hard to adopt the way of communicating that is
customary there. That’s why there are three different rendering functions for
data rates and speeds. All of these have in common that the rates are passed in
<em>bytes per second</em>, even when the output is in bits!</p></div>
<div class="paragraph"><p><code>render.nicspeed()</code> represents the maximum speed of a network card or
switch port. Since they are not measured values, there is no need to do any
rounding. Although no port can send single bits, the specifications are in bits
for historical reasons. Attention: you must however always pass bytes per second
here as well!</p></div>
<div class="paragraph"><p>Examples:</p></div>
<table class="table-responsive table-bordered table tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead><tr>
<th class="tableblock halign-left valign-top">Call</th>
<th class="tableblock halign-left valign-top">Output</th>
</tr></thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">render.nicspeed(12500000)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">100 MBit/s</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">render.nicspeed(100000000)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">800 MBit/s</p></td>
</tr>
</tbody>
</table>
<div class="paragraph"><p><code>render.networkbandwidth()</code> is for an actual measured transmission speed
on the network. The input value is again bytes per second (or 'octets' as a
networker would say):</p></div>
<table class="table-responsive table-bordered table tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead><tr>
<th class="tableblock halign-left valign-top">Call</th>
<th class="tableblock halign-left valign-top">Output</th>
</tr></thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">render.networkbandwidth(123)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">984 Bit/s</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">render.networkbandwidth(123456)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">988 kBit/s</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">render.networkbandwidth(123456789)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">988 MBit/s</p></td>
</tr>
</tbody>
</table>
<div class="paragraph"><p>Where the network is not involved and data rates are nevertheless output,
bytes are again common. The most prominent examples are the IO rates of hard
disks. For this there is the render function <code>render.iobandwidth()</code>,
which in Checkmk works with powers of 1000:</p></div>
<table class="table-responsive table-bordered table tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead><tr>
<th class="tableblock halign-left valign-top">Call</th>
<th class="tableblock halign-left valign-top">Output</th>
</tr></thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">render.iobandwidth(123)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">123 B/s</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">render.iobandwidth(123456)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">123 kB/s</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">render.iobandwidth(123456789)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">123 MB/s</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect2">
<h3 id="heading__percentages">
<span class="hidden-anchor sr-only" id="_percentages"></span>9.5. Percentages</h3>
<div class="paragraph"><p>The <code>render.percent()</code> function represents a percentage value — rounded to two decimal places. It is an exception to the other functions in that the
actual natural value — that is, the ratio — is not passed here, but really the
percentage.
So if something is half full, for example, rather than 0.5. you must pass 50.</p></div>
<div class="paragraph"><p>Because it can sometimes be interesting to know whether a value is almost zero or exactly zero, values that are greater than zero but less than 0.01 are marked by adding a "&lt;" sign.</p></div>
<table class="table-responsive table-bordered table tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead><tr>
<th class="tableblock halign-left valign-top">Call</th>
<th class="tableblock halign-left valign-top">Output</th>
</tr></thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">render.percent(0.004)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">&lt;0.01%</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">render.percent(18.5)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">18.50%</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">render.percent(123)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">123.00%</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect2">
<h3 id="heading__summary_2">
<span class="hidden-anchor sr-only" id="_summary_2"></span>9.6. Summary</h3>
<div class="paragraph"><p>Here to recap is an overview of all of the render functions:</p></div>
<table class="table-responsive table-bordered table tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 10%;">
<col style="width: 10%;">
<col style="width: 40%;">
<col style="width: 40%;">
</colgroup>
<thead><tr>
<th class="tableblock halign-left valign-top">Function</th>
<th class="tableblock halign-left valign-top">Entry</th>
<th class="tableblock halign-left valign-top">Description</th>
<th class="tableblock halign-left valign-top">Output example</th>
</tr></thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">date</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Epoch</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Date</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Dec 18 1970</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">datetime</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Epoche</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Date and time</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Dec 18 1970 10:40:00</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">timespan</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Seconds</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Duration / Age</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3d 5m</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">frequency</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Hz</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Frequency (e.g. Clock rate)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">110 MHz</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">disksize</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Bytes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Hard disk size, Basis 1000</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1,234 GB</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">filesize</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Bytes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Size of files, exact</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1,334,560 B</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">bytes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Bytes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Size in bytes, base 1024</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">23,4 KiB</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">nicspeed</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Octets/sec</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Network card speed</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">100 MBit/s</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">networkbandwidth</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Octets/sec</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Transmission speed</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">23.50 GBit/s</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">iobandwidth</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Bytes/sec</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">IO-Bandwidth</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">124 MB/s</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">percent</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Prozent</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Percentage value, meaningfully rounded</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">99.997%</p></td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="heading_parameters">
<span class="hidden-anchor sr-only" id="parameters"></span>10. Thresholds and check parameters</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="heading__a_rule_set_for_the_setup">
<span class="hidden-anchor sr-only" id="_a_rule_set_for_the_setup"></span>10.1. A rule set for the setup</h3>
<div class="paragraph"><p>In one of our previous examples, we generated the state <span class="state1">WARN</span> if there were only 10 or fewer slots left. The number <code>10</code> was coded directly into the check function — hard-coded, as programmers would say. In Checkmk, however, users are more used to being able to configure such thresholds and parameters by <em>rule</em>. We will therefore take a look at how you can improve your check so that it can be configured via the setup interface.</p></div>
<div class="paragraph"><p>To do this, we need to distinguish between two scenarios:</p></div>
<div class="olist arabic"><ol class="arabic">
<li><p>There is already a suitable rule set. This can actually only be the case if your new check performs a check for which Checkmk already has check plug-ins of the same type, such as monitoring a temperature. There is already a rule set for this that you can use directly.</p></li>
<li><p>There is no matching rule set. In that case you will have to create a new one.</p></li>
</ol></div>
</div>
<div class="sect2">
<h3 id="heading__using_existing_rule_sets">
<span class="hidden-anchor sr-only" id="_using_existing_rule_sets"></span>10.2. Using existing rule sets</h3>
<div class="paragraph"><p>The rule sets supplied for the parameters of checks can be found in the <code>lib/check_mk/gui/plugins/wato/check_parameters/</code> directory. Let’s take the file <code>memory_simple.py</code> as an example. This defines a rule set with the following section:</p></div>
<div class="listingblock">
<div class="title">lib/check_mk/gui/plugins/wato/check_parameters/memory_simple.py</div>
<div class="content"><pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-n">rulespec_registry</span><span class="tok-o">.</span><span class="tok-n">register</span><span class="tok-p">(</span>
    <span class="tok-n">CheckParameterRulespecWithItem</span><span class="tok-p">(</span>
        <span class="tok-n">check_group_name</span><span class="tok-o">=</span><span class="tok-s2">"memory_simple"</span><span class="tok-p">,</span>
        <span class="tok-n">group</span><span class="tok-o">=</span><span class="tok-n">RulespecGroupCheckParametersOperatingSystem</span><span class="tok-p">,</span>
        <span class="tok-n">item_spec</span><span class="tok-o">=</span><span class="tok-n">_item_spec_memory_simple</span><span class="tok-p">,</span>
        <span class="tok-n">match_type</span><span class="tok-o">=</span><span class="tok-s2">"dict"</span><span class="tok-p">,</span>
        <span class="tok-n">parameter_valuespec</span><span class="tok-o">=</span><span class="tok-n">_parameter_valuespec_memory_simple</span><span class="tok-p">,</span>
        <span class="tok-n">title</span><span class="tok-o">=</span><span class="tok-k">lambda</span><span class="tok-p">:</span> <span class="tok-n">_</span><span class="tok-p">(</span><span class="tok-s2">"Main memory usage of simple devices"</span><span class="tok-p">),</span>
    <span class="tok-p">))</span></code></pre></div>
</div>
<div class="paragraph"><p>Here the important point for you is the keyword <code>check_group_name</code>, which is set here to <code>'memory_simple'</code>. This establishes the connection to the check plug-in. You do this when registering the check with the keyword <code>check_ruleset_name</code>, for example:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-n">register</span><span class="tok-o">.</span><span class="tok-n">check_plugin</span><span class="tok-p">(</span>
    <span class="tok-n">name</span> <span class="tok-o">=</span> <span class="tok-s2">"foobar"</span><span class="tok-p">,</span>
    <span class="tok-n">service_name</span> <span class="tok-o">=</span> <span class="tok-s2">"Foobar Sector </span><span class="tok-si">%s</span><span class="tok-s2">"</span><span class="tok-p">,</span>
    <span class="tok-n">discovery_function</span> <span class="tok-o">=</span> <span class="tok-n">discover_foobar</span><span class="tok-p">,</span>
    <span class="tok-n">check_function</span> <span class="tok-o">=</span> <span class="tok-n">check_foobar</span><span class="tok-p">,</span>
    <span class="tok-n">check_ruleset_name</span><span class="tok-o">=</span><span class="tok-s2">"memory_simple"</span><span class="tok-p">,</span>
    <span class="tok-n">check_default_parameters</span><span class="tok-o">=</span><span class="tok-p">{},</span>
<span class="tok-p">)</span></code></pre></div></div>
<div class="paragraph"><p>The definition of default parameters via the keyword <code>check_default_parameters</code> is also mandatory. These parameters apply to your check if the user has not yet created a rule. If there are no mandatory parameters, you can simply take the empty dictionary <code>{}</code> as the value.</p></div>
<div class="paragraph"><p>We will see below how the value configured by the user arrives at the check function.</p></div>
</div>
<div class="sect2">
<h3 id="heading__defining_your_own_rule_set">
<span class="hidden-anchor sr-only" id="_defining_your_own_rule_set"></span>10.3. Defining your own rule set</h3>
<div class="paragraph"><p>If there is no suitable rule set (which is probably the usual situation), we will have to create a new one ourselves. To do this, we create a file in the <code>local/share/check_mk/web/plugins/wato</code> directory. The name of the file should be based on that of the check and, like all plug-in files, it must have the extension '.py'.</p></div>
<div class="paragraph"><p>Let’s look at the structure of such a file step by step. First come some import commands. If you want the texts in your file to be translatable into other languages, import the <code>_</code> (underscore) function. This is an identifier for all translatable texts. For example, you can code calling the function <code>_("Threshold for warn")</code> instead of <code>"Threshold for warn"</code>. The translation system in Checkmk, which is based on <a href="https://docs.python.org/3/library/gettext.html#module-gettext">gettext</a>, finds such texts and includes them in the list of texts to be translated. If you only build the check for yourself, you can do without it and do not need the following import command:</p></div>
<div class="listingblock">
<div class="title">local/share/check_mk/web/plugins/wato/foobar_parameters.py</div>
<div class="content"><pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-kn">from</span> <span class="tok-nn">cmk.gui.i18n</span> <span class="tok-kn">import</span> <span class="tok-n">_</span></code></pre></div>
</div>
<div class="paragraph"><p>Next we import the so-called <em>ValueSpecs</em>. A ValueSpec is a very practical and universal tool that uses Checkmk in many places. It is used to generate customised input masks, to display and validate the entered values and to convert them into Python data structures. In the following example, <code>Dictionary</code>, <code>Integer</code> and <code>TextInput</code> will be imported.</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-kn">from</span> <span class="tok-nn">cmk.gui.valuespec</span> <span class="tok-kn">import</span> <span class="tok-p">(</span>
    <span class="tok-n">Dictionary</span><span class="tok-p">,</span>
    <span class="tok-n">Integer</span><span class="tok-p">,</span>
    <span class="tok-n">TextInput</span><span class="tok-p">,</span>
<span class="tok-p">)</span></code></pre></div></div>
<div class="paragraph"><p>You will definitely need the <code>Dictionary</code>.
Since version <span class="new">2.0.0</span> of Checkmk it is mandatory that check parameters are Python dictionaries. Previously, it could also be a pair (a tuple of two numbers), e.g. Warn/Crit.</p></div>
<div class="paragraph"><p><code>Integer</code> is responsible for the input of a number without decimal places and <code>TextInput</code> for a Unicode text.</p></div>
<div class="paragraph"><p>Next, symbols are imported that are needed for registration:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-kn">from</span> <span class="tok-nn">cmk.gui.plugins.wato</span> <span class="tok-kn">import</span> <span class="tok-p">(</span>
    <span class="tok-n">CheckParameterRulespecWithItem</span><span class="tok-p">,</span>
    <span class="tok-n">rulespec_registry</span><span class="tok-p">,</span>
    <span class="tok-n">RulespecGroupCheckParametersOperatingSystem</span><span class="tok-p">,</span>
<span class="tok-p">)</span></code></pre></div></div>
<div class="paragraph"><p>If your check does not have an item, import instead CheckParameterRulespecWithoutItem. About the <code>RulespecGroup</code>…​. we will explain more on this below.</p></div>
<div class="paragraph"><p>Now come the actual definitions. First we define an input field with which the user can specify the <em>item</em> for the check. This is necessary for the rule condition and also for the manual creation of checks that are to function without discovery. We do this with <code>TextInput</code>. This is assigned a title via <code>title</code>, which is then usually displayed as a heading for the input field:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">def</span> <span class="tok-nf">_item_valuespec_foobar</span><span class="tok-p">():</span>
    <span class="tok-k">return</span> <span class="tok-n">TextInput</span><span class="tok-p">(</span><span class="tok-n">title</span><span class="tok-o">=</span><span class="tok-n">_</span><span class="tok-p">(</span><span class="tok-s2">"Sector name"</span><span class="tok-p">))</span></code></pre></div></div>
<div class="paragraph"><p>You can freely choose the name of the function that returns this ValueSpec as it is only required at the point further down. So that it does not become visible beyond the module boundary, it should begin with an underscore.</p></div>
<div class="paragraph"><p>Next comes the ValueSpec for entering the actual check parameter. For this, as well, we create a function that generates it. The <code>return Dictionary(…​)</code> is mandatory. Within it, you create the list of sub-parameters for this check with <code>elements=[…​]</code>. In our example there is only one — the warning threshold for the free slots. This is required to be an integer, so we use <code>integer</code> here.</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">def</span> <span class="tok-nf">_parameter_valuespec_foobar</span><span class="tok-p">():</span>
    <span class="tok-k">return</span> <span class="tok-n">Dictionary</span><span class="tok-p">(</span>
        <span class="tok-n">elements</span><span class="tok-o">=</span><span class="tok-p">[</span>
            <span class="tok-p">(</span><span class="tok-s2">"warning_lower"</span><span class="tok-p">,</span> <span class="tok-n">Integer</span><span class="tok-p">(</span><span class="tok-n">title</span><span class="tok-o">=</span><span class="tok-n">_</span><span class="tok-p">(</span><span class="tok-s2">"Warning below free slots"</span><span class="tok-p">))),</span>
        <span class="tok-p">],</span>
    <span class="tok-p">)</span></code></pre></div></div>
<div class="paragraph"><p>Last but not least, we now register a new rule set using the imported and self-defined items. For this purpose there is the <code>rulespec_registry.register()</code> function:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-n">rulespec_registry</span><span class="tok-o">.</span><span class="tok-n">register</span><span class="tok-p">(</span>
    <span class="tok-n">CheckParameterRulespecWithItem</span><span class="tok-p">(</span>
        <span class="tok-n">check_group_name</span><span class="tok-o">=</span><span class="tok-s2">"foobar"</span><span class="tok-p">,</span>
        <span class="tok-n">group</span><span class="tok-o">=</span><span class="tok-n">RulespecGroupCheckParametersOperatingSystem</span><span class="tok-p">,</span>
        <span class="tok-n">match_type</span><span class="tok-o">=</span><span class="tok-s2">"dict"</span><span class="tok-p">,</span>
        <span class="tok-n">item_spec</span><span class="tok-o">=</span><span class="tok-n">_item_valuespec_foobar</span><span class="tok-p">,</span>
        <span class="tok-n">parameter_valuespec</span><span class="tok-o">=</span><span class="tok-n">_parameter_valuespec_foobar</span><span class="tok-p">,</span>
        <span class="tok-n">title</span><span class="tok-o">=</span><span class="tok-k">lambda</span><span class="tok-p">:</span> <span class="tok-n">_</span><span class="tok-p">(</span><span class="tok-s2">"Free slots for Foobar sectors"</span><span class="tok-p">),</span>
    <span class="tok-p">))</span></code></pre></div></div>
<div class="paragraph"><p>A few more notes on this:</p></div>
<div class="ulist"><ul>
<li><p>If your check does not use an item, the inner function is <code>CheckParameterRulespecWithoutItem</code>. The line <code>item_spec</code> is then omitted.</p></li>
<li><p>As mentioned above, the <code>check_group_name</code> provides the link to the checks that are to use this rule. It may not be identical with an already existing rule, because this would overwrite the existing rule.</p></li>
<li><p>The <code>group</code> determines in which category in the setup the rule set should appear. Most of these groups are defined in the file <code>lib/check_mk/gui/plugins/wato/utils/<em>init</em>.py</code>. There you will also find examples of how to create your own new group.</p></li>
<li><p>The <code>match_type</code> is always <code>"dict"</code>. In older Checkmk versions there were also parameter rules with other types.</p></li>
<li><p><code>title</code> defines the title of the rule set, but is not given directly as text, but as an executable function which returns the text (hence the <code>lambda:</code>).</p></li>
</ul></div>
<div class="sect3">
<h4 id="heading__testing">
<span class="hidden-anchor sr-only" id="_testing"></span>Testing</h4>
<div class="paragraph"><p>When you have created this file, you should first try out whether everything works so far and not immediately continue working with the check function. To do this, you must first restart the Apache for the site so that the new file will be read. This is performed using the command:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="console"><span></span><span class="tok-gp">OMD[mysite]:~$ </span>omd<span class="tok-w"> </span>restart<span class="tok-w"> </span>apache</code></pre></div></div>
<div class="paragraph"><p>After that, the rule set should be found in the setup. Create a rule in this chain and try out different values. If this functions without errors, you can now use the check parameters in the check function.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="heading__applying_the_rule_to_the_check_plug_in">
<span class="hidden-anchor sr-only" id="_applying_the_rule_to_the_check_plug_in"></span>10.4. Applying the rule to the check plug-in</h3>
<div class="paragraph"><p>In order for the rule to take effect, we must allow the check plug-in to accept check parameters and tell it which rule to use. To do this, the <code>check_default_parameters</code> entry must be present in the registration. In the simplest case, we pass an empty dictionary.</p></div>
<div class="paragraph"><p>Secondly, we pass the <code>check_ruleset_name</code> to the registration function, i.e. the name we gave to the rule set above using <code>check_group_name</code>. This way Checkmk knows from which rule set the parameters are to be determined.</p></div>
<div class="paragraph"><p>The whole thing will then look like this, for example:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-n">register</span><span class="tok-o">.</span><span class="tok-n">check_plugin</span><span class="tok-p">(</span>
    <span class="tok-n">name</span> <span class="tok-o">=</span> <span class="tok-s2">"foobar"</span><span class="tok-p">,</span>
    <span class="tok-n">service_name</span> <span class="tok-o">=</span> <span class="tok-s2">"Foobar Sector </span><span class="tok-si">%s</span><span class="tok-s2">"</span><span class="tok-p">,</span>
    <span class="tok-n">discovery_function</span> <span class="tok-o">=</span> <span class="tok-n">discover_foobar</span><span class="tok-p">,</span>
    <span class="tok-n">check_function</span> <span class="tok-o">=</span> <span class="tok-n">check_foobar</span><span class="tok-p">,</span>
    <span class="tok-n">check_default_parameters</span><span class="tok-o">=</span><span class="tok-p">{},</span>
    <span class="tok-n">check_ruleset_name</span><span class="tok-o">=</span><span class="tok-s2">"foobar"</span><span class="tok-p">,</span>
<span class="tok-p">)</span></code></pre></div></div>
<div class="paragraph"><p>Now Checkmk will try to pass parameters to the check function. For this to work, we need to extend the check function so that it expects the <code>params</code> argument as the second argument. This is inserted between <code>item</code> and <code>section</code> (If you build a check without an item, the <code>item</code> is of course omitted and <code>params</code> will be at the beginning):</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">def</span> <span class="tok-nf">check_foobar</span><span class="tok-p">(</span><span class="tok-n">item</span><span class="tok-p">,</span> <span class="tok-n">params</span><span class="tok-p">,</span> <span class="tok-n">section</span><span class="tok-p">):</span></code></pre></div></div>
<div class="paragraph"><p>It is highly recommended to now have the contents of the variable <code>params</code> printed out with a <code>print</code> command as a first test (or <code>pprint</code> if you want to have it a bit more convenient). Create different rules, and see which values arrive at <code>params</code>:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">def</span> <span class="tok-nf">check_foobar</span><span class="tok-p">(</span><span class="tok-n">item</span><span class="tok-p">,</span> <span class="tok-n">params</span><span class="tok-p">,</span> <span class="tok-n">section</span><span class="tok-p">):</span>
    <span class="tok-nb">print</span><span class="tok-p">(</span><span class="tok-n">params</span><span class="tok-p">)</span>
    <span class="tok-k">for</span> <span class="tok-n">sector</span><span class="tok-p">,</span> <span class="tok-n">used</span><span class="tok-p">,</span> <span class="tok-n">slots</span> <span class="tok-ow">in</span> <span class="tok-o">...</span></code></pre></div></div>
<div class="paragraph"><p><strong>Very important</strong>: When everything is ready, be sure to remove the <code>print</code> commands again! These can otherwise disrupt the internal communication in Checkmk.</p></div>
<div class="paragraph"><p>Now we adapt our check function so that the parameter passed can produce its desired effect. We get the value with the usually chosen key (here <code>"warning_lower"</code>) from the parameters:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">def</span> <span class="tok-nf">check_foobar</span><span class="tok-p">(</span><span class="tok-n">item</span><span class="tok-p">,</span> <span class="tok-n">params</span><span class="tok-p">,</span> <span class="tok-n">section</span><span class="tok-p">):</span>
    <span class="tok-n">warn</span> <span class="tok-o">=</span> <span class="tok-n">params</span><span class="tok-p">[</span><span class="tok-s2">"warning_lower"</span><span class="tok-p">]</span>
    <span class="tok-k">for</span> <span class="tok-n">sector</span><span class="tok-p">,</span> <span class="tok-n">used</span><span class="tok-p">,</span> <span class="tok-n">slots</span> <span class="tok-ow">in</span> <span class="tok-n">section</span><span class="tok-p">:</span>
        <span class="tok-k">if</span> <span class="tok-n">sector</span> <span class="tok-o">==</span> <span class="tok-n">item</span><span class="tok-p">:</span>
            <span class="tok-n">used</span> <span class="tok-o">=</span> <span class="tok-nb">int</span><span class="tok-p">(</span><span class="tok-n">used</span><span class="tok-p">)</span>    <span class="tok-c1"># convert string to int</span>
            <span class="tok-n">slots</span> <span class="tok-o">=</span> <span class="tok-nb">int</span><span class="tok-p">(</span><span class="tok-n">slots</span><span class="tok-p">)</span>  <span class="tok-c1"># convert string to int</span>
            <span class="tok-k">if</span> <span class="tok-n">used</span> <span class="tok-o">==</span> <span class="tok-n">slots</span><span class="tok-p">:</span>
                <span class="tok-n">s</span> <span class="tok-o">=</span> <span class="tok-n">State</span><span class="tok-o">.</span><span class="tok-n">CRIT</span>
            <span class="tok-k">elif</span> <span class="tok-n">slots</span> <span class="tok-o">-</span> <span class="tok-n">used</span> <span class="tok-o">&lt;=</span> <span class="tok-n">warn</span><span class="tok-p">:</span>
                <span class="tok-n">s</span> <span class="tok-o">=</span> <span class="tok-n">State</span><span class="tok-o">.</span><span class="tok-n">WARN</span>
            <span class="tok-k">else</span><span class="tok-p">:</span>
                <span class="tok-n">s</span> <span class="tok-o">=</span> <span class="tok-n">State</span><span class="tok-o">.</span><span class="tok-n">OK</span>
            <span class="tok-k">yield</span> <span class="tok-n">Result</span><span class="tok-p">(</span>
                <span class="tok-n">state</span> <span class="tok-o">=</span> <span class="tok-n">s</span><span class="tok-p">,</span>
                <span class="tok-n">summary</span> <span class="tok-o">=</span> <span class="tok-sa">f</span><span class="tok-s2">"used </span><span class="tok-si">{</span><span class="tok-n">used</span><span class="tok-si">}</span><span class="tok-s2"> out of </span><span class="tok-si">{</span><span class="tok-n">slots</span><span class="tok-si">}</span><span class="tok-s2"> slots"</span><span class="tok-p">)</span>
            <span class="tok-k">return</span></code></pre></div></div>
<div class="paragraph"><p>If a rule has been configured, we can now monitor the "free slots" in our example. However, if no rule has been defined, this check function will crash: Since the default parameters of the plug-in are not filled, in the absence of a rule the plug-in will generate a <code>KeyError</code>.</p></div>
<div class="paragraph"><p>We can fix this problem by inserting a suitable parameter during registration:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-n">register</span><span class="tok-o">.</span><span class="tok-n">check_plugin</span><span class="tok-p">(</span>
    <span class="tok-n">name</span> <span class="tok-o">=</span> <span class="tok-s2">"foobar"</span><span class="tok-p">,</span>
    <span class="tok-n">service_name</span> <span class="tok-o">=</span> <span class="tok-s2">"Foobar Sector </span><span class="tok-si">%s</span><span class="tok-s2">"</span><span class="tok-p">,</span>
    <span class="tok-n">discovery_function</span> <span class="tok-o">=</span> <span class="tok-n">discover_foobar</span><span class="tok-p">,</span>
    <span class="tok-n">check_function</span> <span class="tok-o">=</span> <span class="tok-n">check_foobar</span><span class="tok-p">,</span>
    <span class="tok-n">check_default_parameters</span> <span class="tok-o">=</span> <span class="tok-p">{</span><span class="tok-s2">"warning_lower"</span><span class="tok-p">:</span> <span class="tok-mi">10</span><span class="tok-p">},</span>
    <span class="tok-n">check_ruleset_name</span> <span class="tok-o">=</span> <span class="tok-s2">"foobar"</span><span class="tok-p">,</span>
<span class="tok-p">)</span></code></pre></div></div>
<div class="paragraph"><p>You should always pass default values in this way (and not use the check plug-in to catch missing parameters), as these default parameters can also be displayed in the setup interface. For this purpose, there is e.g. the entry <span class="guihint">Show check parameters</span> in the menu <span class="guihint">Display</span> on the service configuration page for a host.</p></div>
<div class="paragraph"><p>By the way, having a single value as a threshold is very uncommon in Checkmk. Since services can be in the states <span class="state0">OK</span>, <span class="state1">WARN</span>, <span class="state2">CRIT</span>, it is only logical to always define the parameters as <code>tuples</code> with two entries, i.e. as a pair of thresholds for <span class="state1">WARN</span> and <span class="state2">CRIT</span>. To do this, we adapt the rule set as follows:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">def</span> <span class="tok-nf">_parameter_valuespec_foobar</span><span class="tok-p">():</span>
    <span class="tok-k">return</span> <span class="tok-n">Dictionary</span><span class="tok-p">(</span>
        <span class="tok-n">elements</span><span class="tok-o">=</span><span class="tok-p">[</span>
            <span class="tok-p">(</span><span class="tok-s2">"warning_lower"</span><span class="tok-p">,</span> <span class="tok-n">Tuple</span><span class="tok-p">(</span>
                <span class="tok-n">title</span><span class="tok-o">=</span><span class="tok-n">_</span><span class="tok-p">(</span><span class="tok-s2">"Levels on free slots"</span><span class="tok-p">),</span>
                <span class="tok-n">elements</span><span class="tok-o">=</span><span class="tok-p">[</span>
                    <span class="tok-n">Integer</span><span class="tok-p">(</span><span class="tok-n">title</span><span class="tok-o">=</span><span class="tok-n">_</span><span class="tok-p">(</span><span class="tok-s2">"Warning below"</span><span class="tok-p">)),</span>
                    <span class="tok-n">Integer</span><span class="tok-p">(</span><span class="tok-n">title</span><span class="tok-o">=</span><span class="tok-n">_</span><span class="tok-p">(</span><span class="tok-s2">"Critical below"</span><span class="tok-p">)),</span>
                <span class="tok-p">],</span>
            <span class="tok-p">)),</span>
        <span class="tok-p">],</span>
    <span class="tok-p">)</span></code></pre></div></div>
<div class="paragraph"><p>Note that such a change of data type is an incompatible change: Existing rules can now no longer be loaded from the interface. And also the check function may run into problems if instead of an expected pair of numbers there is a single number in <code>params</code>. You can simply edit such rules. When you save them again, the new format will be used.</p></div>
</div>
<div class="sect2">
<h3 id="heading__further_valuespecs">
<span class="hidden-anchor sr-only" id="_further_valuespecs"></span>10.5. Further ValueSpecs</h3>
<div class="paragraph"><p>In Checkmk there are numerous ValueSpecs for all kinds of situations. Here are a few more useful ones:</p></div>
<div class="sect3">
<h4 id="heading__float">
<span class="hidden-anchor sr-only" id="_float"></span>Float</h4>
<div class="paragraph"><p><code>Float</code> is like <code>Integer</code> but allows the input of numbers with decimal places.</p></div>
</div>
<div class="sect3">
<h4 id="heading__percentage">
<span class="hidden-anchor sr-only" id="_percentage"></span>Percentage</h4>
<div class="paragraph"><p>Often one does not want to indicate thresholds in absolute numbers, but in percentages. For this purpose there is the <code>Percentage</code> ValueSpec:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">def</span> <span class="tok-nf">_parameter_valuespec_foobar</span><span class="tok-p">():</span>
    <span class="tok-k">return</span> <span class="tok-n">Dictionary</span><span class="tok-p">(</span>
        <span class="tok-n">elements</span><span class="tok-o">=</span><span class="tok-p">[</span>
            <span class="tok-p">(</span><span class="tok-s2">"levels_percent"</span><span class="tok-p">,</span> <span class="tok-n">Tuple</span><span class="tok-p">(</span>
                <span class="tok-n">title</span><span class="tok-o">=</span><span class="tok-n">_</span><span class="tok-p">(</span><span class="tok-s2">"Relative levels"</span><span class="tok-p">),</span>
                <span class="tok-n">elements</span><span class="tok-o">=</span><span class="tok-p">[</span>
                    <span class="tok-n">Percentage</span><span class="tok-p">(</span><span class="tok-n">title</span><span class="tok-o">=</span><span class="tok-n">_</span><span class="tok-p">(</span><span class="tok-s2">"Warning at"</span><span class="tok-p">),</span> <span class="tok-n">default_value</span><span class="tok-o">=</span><span class="tok-mi">80</span><span class="tok-p">),</span>
                    <span class="tok-n">Percentage</span><span class="tok-p">(</span><span class="tok-n">title</span><span class="tok-o">=</span><span class="tok-n">_</span><span class="tok-p">(</span><span class="tok-s2">"Critical at"</span><span class="tok-p">),</span> <span class="tok-n">default_value</span><span class="tok-o">=</span><span class="tok-mi">90</span><span class="tok-p">)</span>
                <span class="tok-p">],</span>
            <span class="tok-p">)),</span>
        <span class="tok-p">],</span>
    <span class="tok-p">)</span></code></pre></div></div>
<div class="paragraph"><p>With this ValueSpec, the check plug-in would receive the parameters <code>{"levels_percent": (80.0, 90.0)}</code>.</p></div>
</div>
<div class="sect3">
<h4 id="heading__monitoringstate">
<span class="hidden-anchor sr-only" id="_monitoringstate"></span>MonitoringState</h4>
<div class="paragraph"><p>The <code>MonitoringState</code> is useful if you want to allow the user to select one of the states <span class="state0">OK</span>, <span class="state1">WARN</span>, <span class="state2">CRIT</span> and <span class="state3">UNKNOWN</span> for each of various situations. It provides the user with a drop-down list of just these four options, which are then converted to one of the numbers <code>0</code>, <code>1</code>, <code>2</code> or <code>3</code>.</p></div>
<div class="paragraph"><p>Here you can set, for example, which status the service should have if no backup is configured or available:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">def</span> <span class="tok-nf">_parameter_valuespec_plesk_backups</span><span class="tok-p">():</span>
    <span class="tok-k">return</span> <span class="tok-n">Dictionary</span><span class="tok-p">(</span>
        <span class="tok-n">help</span><span class="tok-o">=</span><span class="tok-n">_</span><span class="tok-p">(</span><span class="tok-s2">"This check monitors backups configured for domains in plesk."</span><span class="tok-p">),</span>
        <span class="tok-n">elements</span><span class="tok-o">=</span><span class="tok-p">[</span>
            <span class="tok-p">(</span><span class="tok-s2">"no_backup_configured_state"</span><span class="tok-p">,</span>
             <span class="tok-n">MonitoringState</span><span class="tok-p">(</span><span class="tok-n">title</span><span class="tok-o">=</span><span class="tok-n">_</span><span class="tok-p">(</span><span class="tok-s2">"State when no backup is configured"</span><span class="tok-p">),</span> <span class="tok-n">default_value</span><span class="tok-o">=</span><span class="tok-mi">1</span><span class="tok-p">)),</span>
            <span class="tok-p">(</span><span class="tok-s2">"no_backup_found_state"</span><span class="tok-p">,</span>
             <span class="tok-n">MonitoringState</span><span class="tok-p">(</span><span class="tok-n">title</span><span class="tok-o">=</span><span class="tok-n">_</span><span class="tok-p">(</span><span class="tok-s2">"State when no backup can be found"</span><span class="tok-p">),</span> <span class="tok-n">default_value</span><span class="tok-o">=</span><span class="tok-mi">1</span><span class="tok-p">)),</span>
        <span class="tok-o">...</span></code></pre></div></div>
<div class="paragraph"><p>With this ValueSpec, the check plug-in would be passed the parameters <code>`{"no_backup_configured_state": 1, "no_backup_found_state": 1}</code> if in both cases the default of <span class="state1">WARN</span> (=1) was taken over. You can easily convert the number into a <code>State</code> object by passing it to the <code>State()</code> function:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="python"><span></span>    <span class="tok-k">yield</span> <span class="tok-n">Result</span><span class="tok-p">(</span>
        <span class="tok-n">state</span><span class="tok-o">=</span><span class="tok-n">State</span><span class="tok-p">(</span><span class="tok-n">params</span><span class="tok-p">[</span><span class="tok-s2">"no_backup_configured_state"</span><span class="tok-p">]),</span>
        <span class="tok-n">summary</span><span class="tok-o">=</span><span class="tok-s2">"No backup is configured!"</span><span class="tok-p">,</span>
    <span class="tok-p">)</span></code></pre></div></div>
</div>
<div class="sect3">
<h4 id="heading__age">
<span class="hidden-anchor sr-only" id="_age"></span>Age</h4>
<div class="paragraph"><p>The field <code>Age</code> allows the entry of an age, which is stored and transferred internally as a count of seconds:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">def</span> <span class="tok-nf">_parameter_valuespec_antivir_update_age</span><span class="tok-p">():</span>
    <span class="tok-k">return</span> <span class="tok-n">Tuple</span><span class="tok-p">(</span><span class="tok-n">elements</span><span class="tok-o">=</span><span class="tok-p">[</span>
        <span class="tok-n">Age</span><span class="tok-p">(</span><span class="tok-n">title</span><span class="tok-o">=</span><span class="tok-n">_</span><span class="tok-p">(</span><span class="tok-s2">"Warning level for time since last update"</span><span class="tok-p">)),</span>
        <span class="tok-n">Age</span><span class="tok-p">(</span><span class="tok-n">title</span><span class="tok-o">=</span><span class="tok-n">_</span><span class="tok-p">(</span><span class="tok-s2">"Critical level for time since last update"</span><span class="tok-p">)),</span>
    <span class="tok-p">],)</span></code></pre></div></div>
</div>
<div class="sect3">
<h4 id="heading__filesize">
<span class="hidden-anchor sr-only" id="_filesize"></span>Filesize</h4>
<div class="paragraph"><p>The ValueSpec <code>Filesize</code> allows the input of file (or hard disk) sizes. Internally, the calculation is done with bytes, but the user may choose from KB, MB, GB or TB:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="python"><span></span>    <span class="tok-n">Tuple</span><span class="tok-p">(</span>
        <span class="tok-n">title</span><span class="tok-o">=</span><span class="tok-n">_</span><span class="tok-p">(</span><span class="tok-s2">"Maximum size of all files on backup space"</span><span class="tok-p">),</span>
        <span class="tok-n">help</span><span class="tok-o">=</span><span class="tok-n">_</span><span class="tok-p">(</span><span class="tok-s2">"The maximum size of all files on the backup space. "</span>
               <span class="tok-s2">"This might be set to the allowed quotas on the configured "</span>
               <span class="tok-s2">"FTP server to be notified if the space limit is reached."</span><span class="tok-p">),</span>
        <span class="tok-n">elements</span><span class="tok-o">=</span><span class="tok-p">[</span>
            <span class="tok-n">Filesize</span><span class="tok-p">(</span><span class="tok-n">title</span><span class="tok-o">=</span><span class="tok-n">_</span><span class="tok-p">(</span><span class="tok-s2">"Warning at"</span><span class="tok-p">)),</span>
            <span class="tok-n">Filesize</span><span class="tok-p">(</span><span class="tok-n">title</span><span class="tok-o">=</span><span class="tok-n">_</span><span class="tok-p">(</span><span class="tok-s2">"Critical at"</span><span class="tok-p">)),</span>
        <span class="tok-p">],</span>
    <span class="tok-p">),</span></code></pre></div></div>
<div class="paragraph"><p>The topic of ValueSpecs is extremely flexible and extensive and would go beyond the scope of this article. Please have a look at the examples of the rule definitions supplied by Checkmk in <code>lib/check_mk/gui/plugins/wato/check_parameters/</code>. There are more than 500 files with examples.</p></div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="heading_metrics">
<span class="hidden-anchor sr-only" id="metrics"></span>11. Customised presentation of metrics</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="heading__the_significance_of_metric_definitions">
<span class="hidden-anchor sr-only" id="_the_significance_of_metric_definitions"></span>11.1. The significance of metric definitions</h3>
<div class="paragraph"><p>In our example above, we have let the <code>foobar</code> plug-in generate the metric <code>fooslots</code>. Metrics are immediately visible in the Checkmk graphical interface without you having to do anything. A graph for each metric will be automatically generated in the service details.</p></div>
<div class="paragraph"><p>However, there are a few limitations:</p></div>
<div class="ulist"><ul>
<li><p>A "Perf-O-Meter", i.e. the graphical bar-like preview of the measurement value, does not automatically appear when the service is displayed in the list view (e.g. in the view showing all services of a host).</p></li>
<li><p>Matching metrics are not automatically combined in a single graph, but each appears separately.</p></li>
<li><p>The metric does not have a proper title, but the internal variable name of the metric is shown.</p></li>
<li><p>No unit is used that allows a meaningful representation (e.g. GB instead of individual bytes).</p></li>
<li><p>A colour is randomly selected.
To have a clear representation of your metrics in these aspects, you will need some more definitions in another file.</p></li>
</ul></div>
</div>
<div class="sect2">
<h3 id="heading__using_existing_metric_definitions">
<span class="hidden-anchor sr-only" id="_using_existing_metric_definitions"></span>11.2. Using existing metric definitions</h3>
<div class="paragraph"><p>Before you do this, you should — as with the rule set for the parameters — first check whether Checkmk does not already come with a suitable metrics definition.  The predefined metrics definitions can be found in the <code>lib/check_mk/gui/plugins/metrics/</code> directory. For example, in the file <code>cpu.py</code> you will find a metric for the free space in a file system:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-n">metric_info</span><span class="tok-p">[</span><span class="tok-s2">"util"</span><span class="tok-p">]</span> <span class="tok-o">=</span> <span class="tok-p">{</span>
    <span class="tok-s2">"title"</span><span class="tok-p">:</span> <span class="tok-n">_</span><span class="tok-p">(</span><span class="tok-s2">"CPU utilization"</span><span class="tok-p">),</span>
    <span class="tok-s2">"unit"</span><span class="tok-p">:</span> <span class="tok-s2">"%"</span><span class="tok-p">,</span>
    <span class="tok-s2">"color"</span><span class="tok-p">:</span> <span class="tok-s2">"26/a"</span><span class="tok-p">,</span>
<span class="tok-p">}</span></code></pre></div></div>
<div class="paragraph"><p>If this is suitable for your plug-in, you only need to use the name <code>"util"</code> in your call to the <code>Metric()</code> class. Everything else will then be automatically derived from it.</p></div>
</div>
<div class="sect2">
<h3 id="heading_ownmetricdefinitions">
<span class="hidden-anchor sr-only" id="ownmetricdefinitions"></span>11.3. Own metric definitions</h3>
<div class="paragraph"><p>If there is no suitable metric, simply create one yourself. In our example we want to define our own metric for our <code>fooslots</code>. To do this, we create a file in <code>local/share/check_mk/web/plugins/metrics</code>:</p></div>
<div class="listingblock">
<div class="title">local/share/check_mk/web/plugins/metrics/foobar_metric.py</div>
<div class="content"><pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-kn">from</span> <span class="tok-nn">cmk.gui.i18n</span> <span class="tok-kn">import</span> <span class="tok-n">_</span>
<span class="tok-kn">from</span> <span class="tok-nn">cmk.gui.plugins.metrics</span> <span class="tok-kn">import</span> <span class="tok-n">metric_info</span>

<span class="tok-n">metric_info</span><span class="tok-p">[</span><span class="tok-s2">"fooslots"</span><span class="tok-p">]</span> <span class="tok-o">=</span> <span class="tok-p">{</span>
    <span class="tok-s2">"title"</span><span class="tok-p">:</span> <span class="tok-n">_</span><span class="tok-p">(</span><span class="tok-s2">"Used slots"</span><span class="tok-p">),</span>
    <span class="tok-s2">"unit"</span><span class="tok-p">:</span> <span class="tok-s2">"count"</span><span class="tok-p">,</span>
    <span class="tok-s2">"color"</span><span class="tok-p">:</span> <span class="tok-s2">"15/a"</span><span class="tok-p">,</span>
<span class="tok-p">}</span></code></pre></div>
</div>
<div class="paragraph"><p>Here are a few pointers:</p></div>
<div class="ulist"><ul>
<li><p>The key (here <code>'fooslots'</code>) is the metric name and must match what the check function outputs.</p></li>
<li><p>Importing and using the underscore for internationalisation is optional, as already discussed in the rules.</p></li>
<li><p>See the file <code>lib/check_mk/gui/plugins/metrics/unit.py</code> for the unit definitions.</p></li>
<li><p>The colour definition uses a palette. For each palette colour there are <code>/a</code> and <code>/b</code>. These are two shades of the same colour. In the existing definitions you will also find many direct colour codes like <code>'#ff8800'</code>. These will gradually be phased out and all replaced by palette colours as these provide a more uniform look and are also easier to match to the interface themes.</p></li>
</ul></div>
<div class="paragraph"><p>This definition now ensures that the colour, title and unit of the metric are displayed according to our requirements.</p></div>
</div>
<div class="sect2">
<h3 id="heading__graphs_with_multiple_metrics">
<span class="hidden-anchor sr-only" id="_graphs_with_multiple_metrics"></span>11.4. Graphs with multiple metrics</h3>
<div class="paragraph"><p>If you want to combine several metrics in one graph — which is often very useful — you need, simply in the same file, a graph definition. This is done via the global dictionary <code>graph_info</code>.</p></div>
<div class="paragraph"><p>For example, let’s assume our check has two metrics, <code>fooslots</code> and <code>fooslots_free</code>. The metric definitions would be, for example:</p></div>
<div class="listingblock">
<div class="title">local/share/check_mk/web/plugins/metrics/foobar_metric.py</div>
<div class="content"><pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-kn">from</span> <span class="tok-nn">cmk.gui.i18n</span> <span class="tok-kn">import</span> <span class="tok-n">_</span>
<span class="tok-kn">from</span> <span class="tok-nn">cmk.gui.plugins.metrics</span> <span class="tok-kn">import</span> <span class="tok-p">(</span>
    <span class="tok-n">metric_info</span><span class="tok-p">,</span>
    <span class="tok-n">graph_info</span><span class="tok-p">,</span>
<span class="tok-p">)</span>

<span class="tok-n">metric_info</span><span class="tok-p">[</span><span class="tok-s2">"fooslots"</span><span class="tok-p">]</span> <span class="tok-o">=</span> <span class="tok-p">{</span>
    <span class="tok-s2">"title"</span><span class="tok-p">:</span> <span class="tok-n">_</span><span class="tok-p">(</span><span class="tok-s2">"Used slots"</span><span class="tok-p">),</span>
    <span class="tok-s2">"unit"</span><span class="tok-p">:</span> <span class="tok-s2">"count"</span><span class="tok-p">,</span>
    <span class="tok-s2">"color"</span><span class="tok-p">:</span> <span class="tok-s2">"16/a"</span><span class="tok-p">,</span>
<span class="tok-p">}</span>

<span class="tok-n">metric_info</span><span class="tok-p">[</span><span class="tok-s2">"fooslots_free"</span><span class="tok-p">]</span> <span class="tok-o">=</span> <span class="tok-p">{</span>
    <span class="tok-s2">"title"</span><span class="tok-p">:</span> <span class="tok-n">_</span><span class="tok-p">(</span><span class="tok-s2">"Free slots"</span><span class="tok-p">),</span>
    <span class="tok-s2">"unit"</span><span class="tok-p">:</span> <span class="tok-s2">"count"</span><span class="tok-p">,</span>
    <span class="tok-s2">"color"</span><span class="tok-p">:</span> <span class="tok-s2">"24/a"</span><span class="tok-p">,</span>
<span class="tok-p">}</span></code></pre></div>
</div>
<div class="paragraph"><p>Now we add a graph that draws these two metrics as lines:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-n">graph_info</span><span class="tok-p">[</span><span class="tok-s2">"fooslots_combined"</span><span class="tok-p">]</span> <span class="tok-o">=</span> <span class="tok-p">{</span>
    <span class="tok-s2">"metrics"</span><span class="tok-p">:</span> <span class="tok-p">[</span>
        <span class="tok-p">(</span><span class="tok-s2">"fooslots"</span><span class="tok-p">,</span> <span class="tok-s2">"line"</span><span class="tok-p">),</span>
        <span class="tok-p">(</span><span class="tok-s2">"fooslots_free"</span><span class="tok-p">,</span> <span class="tok-s2">"line"</span><span class="tok-p">),</span>
    <span class="tok-p">],</span>
<span class="tok-p">}</span></code></pre></div></div>
<div class="paragraph"><p>Notes on this:</p></div>
<div class="ulist"><ul>
<li><p>Unfortunately, there is no description of the possibilities for this definition in the manual yet. But you will find many examples in the files in the directory <code>lib/check_mk/gui/plugins/metrics</code>.</p></li>
<li><p>Try <code>area</code> or <code>stack</code> instead of <code>line</code>.</p></li>
</ul></div>
</div>
<div class="sect2">
<h3 id="heading_perfometer">
<span class="hidden-anchor sr-only" id="perfometer"></span>11.5. Displaying the metrics in the Perf-O-Meter</h3>
<div class="paragraph"><p>If you would like to display a Perf-O-Meter in the service line in addition to our metric, you need another file, this time in the directory <code>local/share/check_mk/web/plugins/perfometer</code>.</p></div>
<div class="paragraph"><p>Example:</p></div>
<div class="listingblock">
<div class="title">local/share/check_mk/web/plugins/perfometer/foobar_perfometer.py</div>
<div class="content"><pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-kn">from</span> <span class="tok-nn">cmk.gui.plugins.metrics</span> <span class="tok-kn">import</span> <span class="tok-n">perfometer_info</span>

<span class="tok-n">perfometer_info</span><span class="tok-o">.</span><span class="tok-n">append</span><span class="tok-p">({</span>
    <span class="tok-s2">"type"</span><span class="tok-p">:</span> <span class="tok-s2">"logarithmic"</span><span class="tok-p">,</span>
    <span class="tok-s2">"metric"</span><span class="tok-p">:</span> <span class="tok-s2">"fooslots"</span><span class="tok-p">,</span>
    <span class="tok-s2">"half_value"</span><span class="tok-p">:</span> <span class="tok-mi">5</span><span class="tok-p">,</span>
    <span class="tok-s2">"exponent"</span><span class="tok-p">:</span> <span class="tok-mf">2.0</span><span class="tok-p">,</span>
<span class="tok-p">})</span></code></pre></div>
</div>
<div class="paragraph"><p>Perf-O-Meters are a bit trickier than graphs because they have no legend. And that’s why it’s difficult with the range of values. Since the poor Perf-O-Meter cannot know which readings are even possible and the space is very limited, many built-in check plug-ins use a logarithmic representation. This is also the case in our example, <code>half_value</code> is the measured value that is displayed exactly in the middle of the Perf-O-Meter. With a value of <code>5</code>, the bar would be half filled. And <code>exponent</code> describes the factor which is necessary so that another 10% of the range would be filled. So in this example, a reading of <code>10</code> would be displayed at 60% and one of <code>20</code> at 70%.</p></div>
<div class="paragraph"><p>The advantage of this method is that when you have a list of services of the same type, you can quickly compare all Perf-O-Meters visually because they all have the same scale. And despite the very small representations, you can easily see the differences in both very small and large readings. The values are NOT to scale, however.</p></div>
<div class="paragraph"><p>Alternatively, you can also use a linear Perf-O-Meter. This is always useful if there is a known maximum value. A typical situation would be measured values that represent percentages from 0 to 100. This would then look like this, for example:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-n">perfometer_info</span><span class="tok-o">.</span><span class="tok-n">append</span><span class="tok-p">({</span>
    <span class="tok-s2">"type"</span><span class="tok-p">:</span> <span class="tok-s2">"linear"</span><span class="tok-p">,</span>
    <span class="tok-s2">"segments"</span><span class="tok-p">:</span> <span class="tok-p">[</span><span class="tok-s2">"fooslots_used_percent"</span><span class="tok-p">],</span>
    <span class="tok-s2">"total"</span><span class="tok-p">:</span> <span class="tok-mf">100.0</span><span class="tok-p">,</span>
<span class="tok-p">})</span></code></pre></div></div>
<div class="paragraph"><p>There is another difference to the logarithmic representation — here <code>segments</code> is a list and allows multiple metrics to be displayed side by side.</p></div>
<div class="paragraph"><p>As always, you can find examples in the many plug-ins supplied by Checkmk. These are also in the files in the directory <code>lib/check_mk/gui/plugins/metrics</code>.</p></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="heading_old_api">
<span class="hidden-anchor sr-only" id="old_api"></span>12. Notes for users of the old API</h2>
<div class="sectionbody">
<div class="paragraph"><p>Are you already experienced in developing check plug-ins with the previous
API — the one up to version <span class="new">1.6.0</span> of Checkmk?
Then you will find some notes about important changes summarized here.</p></div>
<div class="sect2">
<h3 id="heading__saveint_and_savefloat">
<span class="hidden-anchor sr-only" id="_saveint_and_savefloat"></span>12.1. saveint() and savefloat()</h3>
<div class="paragraph"><p>The two functions <code>saveint()</code> and <code>savefloat()</code> have been dropped.
As a reminder, <code>saveint(x)</code> returns <code>0</code> if <code>x</code> cannot be reasonably converted to a number, e.g. because it is an empty string or does not consist only of digits.</p></div>
<div class="paragraph"><p>While there have been a few good use cases for this, it has been used incorrectly in the majority of cases, which in the past has resulted in many
<a href="#errors">errors</a> being obscured.</p></div>
<div class="paragraph"><p>In a situation in which you want to get a <code>0</code> on an empty string — which is the most common 'good' use case of <code>saveint(x)</code> — you can simply code the following:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-n">foo</span> <span class="tok-o">=</span> <span class="tok-nb">int</span><span class="tok-p">(</span><span class="tok-n">x</span><span class="tok-p">)</span> <span class="tok-k">if</span> <span class="tok-n">x</span> <span class="tok-k">else</span> <span class="tok-mi">0</span></code></pre></div></div>
<div class="paragraph"><p>For <code>savefloat()</code> everything applies analogously.</p></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="heading_parsefunction">
<span class="hidden-anchor sr-only" id="parsefunction"></span>13. Taming complex agent outputs using the parse function</h2>
<div class="sectionbody">
<div class="paragraph"><p>The next step is the so-called <em>parse function</em>. This has the task of parsing the 'raw' agent data and putting it into a logically-tidy form that is easy to process in all subsequent steps. The convention is that this is named after the agent section and begins with <code>parse_</code>. It gets <code>string_table</code> as its only argument. Please note that you are not free to choose the argument here. It really must be called that.</p></div>
<div class="paragraph"><p>For now, we write our parse function in such a way that we simply output the data it receives to the console. To do this, we simply use the <code>print</code> function (note: since Python 3, brackets are mandatory here):</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">def</span> <span class="tok-nf">parse_linux_usbstick</span><span class="tok-p">(</span><span class="tok-n">string_table</span><span class="tok-p">):</span>
    <span class="tok-nb">print</span><span class="tok-p">(</span><span class="tok-n">string_table</span><span class="tok-p">)</span></code></pre></div></div>
<div class="paragraph"><p>In order for this whole process to have any effect, we have to make our parse function and the new agent section known to Checkmk. To do this, we call up a registration function:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-n">register</span><span class="tok-o">.</span><span class="tok-n">agent_section</span><span class="tok-p">(</span>
    <span class="tok-n">name</span> <span class="tok-o">=</span> <span class="tok-s2">"linux_usbstick"</span><span class="tok-p">,</span>
    <span class="tok-n">parse_function</span> <span class="tok-o">=</span> <span class="tok-n">parse_linux_usbstick</span><span class="tok-p">,</span>
<span class="tok-p">)</span></code></pre></div></div>
<div class="paragraph"><p>Here it is important that the name of the section really does exactly match the section header in the agent output. Altogether, it now looks like this:</p></div>
<div class="listingblock">
<div class="title">local/lib/check_mk/base/plugins/agent_based/linux_usbstick.py</div>
<div class="content"><pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-kn">from</span> <span class="tok-nn">.agent_based_api.v1</span> <span class="tok-kn">import</span> <span class="tok-o">*</span>

<span class="tok-k">def</span> <span class="tok-nf">parse_linux_usbstick</span><span class="tok-p">(</span><span class="tok-n">string_table</span><span class="tok-p">):</span>
    <span class="tok-nb">print</span><span class="tok-p">(</span><span class="tok-n">string_table</span><span class="tok-p">)</span>
    <span class="tok-k">return</span> <span class="tok-n">string_table</span>

<span class="tok-n">register</span><span class="tok-o">.</span><span class="tok-n">agent_section</span><span class="tok-p">(</span>
    <span class="tok-n">name</span> <span class="tok-o">=</span> <span class="tok-s2">"linux_usbstick"</span><span class="tok-p">,</span>
    <span class="tok-n">parse_function</span> <span class="tok-o">=</span> <span class="tok-n">parse_linux_usbstick</span><span class="tok-p">,</span>
<span class="tok-p">)</span></code></pre></div>
</div>
<div class="paragraph"><p>From this point on, every plug-in that uses the section <code>linux_usbstick</code> gets the return value from the parse function. As a rule, this will be the check plug-in of the same name.</p></div>
<div class="paragraph"><p>In a way, we have now built the simplest possible plug-in, which although it has no real use yet, we can at least test it.  To do this, we trigger a service detection (option <code>-I</code>) on the command line from the host whose agent we prepared earlier. If its output really contains a section <code>linux_usbstick</code>, then we should see our debug output:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="console"><span></span><span class="tok-gp">OMD[mysite]:~$ </span>cmk<span class="tok-w"> </span>-I<span class="tok-w"> </span>myhost123
<span class="tok-go">[['ata-APPLE_SSD_SM0512F_S1K5NYBF810191'], ['wwn-0x5002538655584d30']]</span></code></pre></div></div>
<div class="paragraph"><p>The output becomes somewhat clearer if we replace the simple <code>print</code> with a Pretty-print from the module <code>pprint</code>. This is highly recommended for all further debugging output:</p></div>
<div class="listingblock">
<div class="title">local/lib/check_mk/base/plugins/agent_based/linux_usbstick.py</div>
<div class="content"><pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-kn">from</span> <span class="tok-nn">.agent_based_api.v1</span> <span class="tok-kn">import</span> <span class="tok-o">*</span>
<span class="tok-o">*</span><span class="tok-kn">import</span> <span class="tok-nn">pprint</span><span class="tok-o">*</span>

<span class="tok-k">def</span> <span class="tok-nf">parse_linux_usbstick</span><span class="tok-p">(</span><span class="tok-n">string_table</span><span class="tok-p">):</span>
    <span class="tok-o">*</span><span class="tok-n">pprint</span><span class="tok-o">.</span><span class="tok-n">pprint</span><span class="tok-p">(</span><span class="tok-n">string_table</span><span class="tok-p">)</span><span class="tok-o">*</span>
    <span class="tok-k">return</span> <span class="tok-n">string_table</span>

<span class="tok-n">register</span><span class="tok-o">.</span><span class="tok-n">agent_section</span><span class="tok-p">(</span>
    <span class="tok-n">name</span> <span class="tok-o">=</span> <span class="tok-s2">"linux_usbstick"</span><span class="tok-p">,</span>
    <span class="tok-n">parse_function</span> <span class="tok-o">=</span> <span class="tok-n">parse_linux_usbstick</span><span class="tok-p">,</span>
<span class="tok-p">)</span></code></pre></div>
</div>
<div class="paragraph"><p>It will look like this:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="console"><span></span><span class="tok-gp">OMD[mysite]:~$ </span>cmk<span class="tok-w"> </span>-I<span class="tok-w"> </span>myhost123
<span class="tok-go">[['ata-APPLE_SSD_SM0512F_S1K5NYBF810191'],</span>
<span class="tok-go"> ['wwn-0x5002538655584d30']]</span></code></pre></div></div>
<div class="sect2">
<h3 id="heading__composing_the_parse_function">
<span class="hidden-anchor sr-only" id="_composing_the_parse_function"></span>13.1. Composing the parse function</h3>
<div class="paragraph"><p>If you look closely, you will see that these are nested lists. In the argument <code>string_table</code> you get a list which contains a list of <em>words</em> <em>per line</em> of the agent output. The lines are separated by sequences of spaces. Since our section contains only one word per line, the inner lists consist of only one entry each.</p></div>
<div class="paragraph"><p>The following example makes the structure a little clearer:</p></div>
<div class="listingblock">
<div class="title">local/lib/check_mk/base/plugins/agent_based/linux_usbstick.py</div>
<div class="content"><pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-kn">from</span> <span class="tok-nn">.agent_based_api.v1</span> <span class="tok-kn">import</span> <span class="tok-o">*</span>
<span class="tok-kn">import</span> <span class="tok-nn">pprint</span>

<span class="tok-k">def</span> <span class="tok-nf">parse_linux_usbstick</span><span class="tok-p">(</span><span class="tok-n">string_table</span><span class="tok-p">):</span>
    <span class="tok-nb">print</span><span class="tok-p">(</span><span class="tok-s2">"Number of lines: </span><span class="tok-si">%d</span><span class="tok-s2">"</span> <span class="tok-o">%</span> <span class="tok-nb">len</span><span class="tok-p">(</span><span class="tok-n">string_table</span><span class="tok-p">))</span>
    <span class="tok-nb">print</span><span class="tok-p">(</span><span class="tok-s2">"Number of words in first line: </span><span class="tok-si">%d</span><span class="tok-s2">"</span> <span class="tok-o">%</span> <span class="tok-nb">len</span><span class="tok-p">(</span><span class="tok-n">string_table</span><span class="tok-p">[</span><span class="tok-mi">0</span><span class="tok-p">]))</span>
    <span class="tok-nb">print</span><span class="tok-p">(</span><span class="tok-s2">"Length of first word: </span><span class="tok-si">%d</span><span class="tok-s2">"</span> <span class="tok-o">%</span> <span class="tok-nb">len</span><span class="tok-p">(</span><span class="tok-n">string_table</span><span class="tok-p">[</span><span class="tok-mi">0</span><span class="tok-p">][</span><span class="tok-mi">0</span><span class="tok-p">]))</span>
    <span class="tok-k">return</span> <span class="tok-n">string_table</span>

<span class="tok-n">register</span><span class="tok-o">.</span><span class="tok-n">agent_section</span><span class="tok-p">(</span>
    <span class="tok-n">name</span> <span class="tok-o">=</span> <span class="tok-s2">"linux_usbstick"</span><span class="tok-p">,</span>
    <span class="tok-n">parse_function</span> <span class="tok-o">=</span> <span class="tok-n">parse_linux_usbstick</span><span class="tok-p">,</span>
<span class="tok-p">)</span></code></pre></div>
</div>
<div class="paragraph"><p>The output will look like this:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="console"><span></span><span class="tok-gp">OMD[mysite]:~$ </span>cmk<span class="tok-w"> </span>-I<span class="tok-w"> </span>myhost123
<span class="tok-go">Number of lines: 3</span>
<span class="tok-go">Number of words in first line: 1</span>
<span class="tok-go">Length of first word: 36</span></code></pre></div></div>
<div class="paragraph"><p>For our example, we just need a simple list of device names, so we make our parse function unpack the single word from each line and package it into a nice new list:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">def</span> <span class="tok-nf">parse_linux_usbstick</span><span class="tok-p">(</span><span class="tok-n">string_table</span><span class="tok-p">):</span>
    <span class="tok-n">parsed</span> <span class="tok-o">=</span> <span class="tok-p">[]</span>
    <span class="tok-k">for</span> <span class="tok-n">line</span> <span class="tok-ow">in</span> <span class="tok-n">string_table</span><span class="tok-p">:</span>
        <span class="tok-n">parsed</span><span class="tok-o">.</span><span class="tok-n">append</span><span class="tok-p">(</span><span class="tok-n">line</span><span class="tok-p">[</span><span class="tok-mi">0</span><span class="tok-p">])</span>
    <span class="tok-n">pprint</span><span class="tok-o">.</span><span class="tok-n">pprint</span><span class="tok-p">(</span><span class="tok-n">parsed</span><span class="tok-p">)</span>
    <span class="tok-k">return</span> <span class="tok-n">string_table</span></code></pre></div></div>
<div class="paragraph"><p>The debug output then looks like this (please look carefully, there are now only a single pair of square brackets):</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-p">[</span><span class="tok-s1">'ata-APPLE_SSD_SM0512F_S1K5NYBF810191'</span><span class="tok-p">,</span>
 <span class="tok-s1">'wwn-0x5002538655584d30'</span><span class="tok-p">]</span></code></pre></div></div>
<div class="paragraph"><p>For the parse function to be complete, we now need to remove the debug message and — very importantly — deliver the new result with <code>return</code>:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">def</span> <span class="tok-nf">parse_linux_usbstick</span><span class="tok-p">(</span><span class="tok-n">string_table</span><span class="tok-p">):</span>
    <span class="tok-n">parsed</span> <span class="tok-o">=</span> <span class="tok-p">[]</span>
    <span class="tok-k">for</span> <span class="tok-n">line</span> <span class="tok-ow">in</span> <span class="tok-n">string_table</span><span class="tok-p">:</span>
        <span class="tok-n">parsed</span><span class="tok-o">.</span><span class="tok-n">append</span><span class="tok-p">(</span><span class="tok-n">line</span><span class="tok-p">[</span><span class="tok-mi">0</span><span class="tok-p">])</span>
    <span class="tok-k">return</span> <span class="tok-n">parsed</span></code></pre></div></div>
<div class="paragraph"><p>Of course, from this point on, all of the relevant plug-ins must be able to work with the new data format.</p></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="heading_outlook">
<span class="hidden-anchor sr-only" id="outlook"></span>14. The outlook for the future</h2>
<div class="sectionbody">
<div class="paragraph"><p>There are many more aspects and topics around the development of own plug-ins. Checkmk has many interfaces for custom extensions and is therefore very flexible. We are working on progressively describing these interfaces in the manual.</p></div>
<div class="paragraph"><p>Should you have any questions or difficulties, our professional support and also the free forum are of course at your disposal.</p></div>
</div>
</div>
<div class="sect1">
<h2 id="heading_files">
<span class="hidden-anchor sr-only" id="files"></span>15. Files and directories</h2>
<div class="sectionbody"><table class="table-responsive table-bordered table tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">local/lib/check_mk/base/plugins/agent_based</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Location for self-written check plug-ins.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">local/share/check_mk/web/plugins/wato</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Storage location for your check parameter rule sets.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">local/share/check_mk/web/plugins/metrics</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Storage location for own metric definitions.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">local/share/check_mk/web/plugins/perfometer</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Storage location for own Perf-O-Meter definitions.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">local/share/check_mk/mibs</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Place SNMP MIB files here that are to be loaded automatically.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">lib/check_mk/gui/plugins/wato/check_parameters</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Here you will find the rule set definitions for all check plug-ins included in Checkmk.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">lib/check_mk/gui/plugins/wato/utils/<em>init</em>.py</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">This file defines the groups of the setup interface in which you can store new rule sets.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">lib/check_mk/gui/plugins/metrics/</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Here you will find the metric definitions for the supplied plug-ins.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">lib/check_mk/gui/plugins/metrics/unit.py</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The predefined units for the metrics are in this file.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">/usr/lib/check_mk_agent/plugins</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">This directory refers to a monitored Linux host. Here the Checkmk agent for Linux expects to find agent extensions (agent plug-ins).</p></td>
</tr>
</tbody>
</table></div>
</div>
</div></main><div id="toc" class="toc2">
<div id="toctitle">On this page</div>
<ul class="sectlevel1">
<li>
<a href="#_introduction">1. Introduction</a><ul class="sectlevel1">
<li><a href="#real_plug-in">1.1. Does it always have to be a real plug-in?</a></li>
<li><a href="#_what_has_changed_compared_to_the_old_api">1.2. What has changed compared to the old API?</a></li>
<li><a href="#_will_the_old_api_still_be_supported">1.3. Will the old API still be supported?</a></li>
<li><a href="#_the_different_types_of_agents">1.4. The different types of agents</a></li>
<li><a href="#_prerequisites">1.5. Prerequisites</a></li>
</ul>
</li>
<li>
<a href="#agentbased">2. A first simple check plug-in</a><ul class="sectlevel1">
<li><a href="#_finding_the_right_command">2.1. Finding the right command</a></li>
<li><a href="#_purging_the_data">2.2. Purging the data</a></li>
<li><a href="#includecommand">2.3. Including the command in the agent</a></li>
<li><a href="#_testing_the_agent">2.4. Testing the agent</a></li>
<li><a href="#_declaring_the_section">2.5. Declaring the section</a></li>
<li><a href="#_registering_the_check">2.6. Registering the check</a></li>
<li><a href="#_writing_the_discovery_function">2.7. Writing the discovery function</a></li>
<li><a href="#_writing_the_check_function">2.8. Writing the check function</a></li>
<li><a href="#_the_complete_plug_in_at_a_glance">2.9. The complete plug-in at a glance</a></li>
</ul>
</li>
<li>
<a href="#_checks_with_more_than_one_service_items_per_host">3. Checks with more than one service (items) per host</a><ul class="sectlevel1">
<li><a href="#_basic_principles">3.1. Basic principles</a></li>
<li><a href="#_a_simple_example">3.2. A simple example</a></li>
<li><a href="#_the_examplea_recap">3.3. The example — a recap</a></li>
</ul>
</li>
<li>
<a href="#_performance_values">4. Performance values</a><ul class="sectlevel1">
<li><a href="#_determining_values_in_the_check_function">4.1. Determining values in the check function</a></li>
<li><a href="#thresholdinformation">4.2. Threshold information</a></li>
<li><a href="#_the_values_range">4.3. The values range</a></li>
</ul>
</li>
<li><a href="#_checks_with_multiple_partial_results">5. Checks with multiple partial results</a></li>
<li><a href="#_summary_and_details">6. Summary and Details</a></li>
<li>
<a href="#errors">7. Error handling</a><ul class="sectlevel1">
<li><a href="#_exceptions_and_crash_reports">7.1. Exceptions and crash reports</a></li>
<li><a href="#_viewing_exceptions_on_the_command_line">7.2. Viewing exceptions on the command line</a></li>
<li><a href="#_invalid_outputs_from_an_agent">7.3. Invalid outputs from an agent</a></li>
<li><a href="#_missing_items">7.4. Missing items</a></li>
</ul>
</li>
<li>
<a href="#snmp">8. SNMP-based checks</a><ul class="sectlevel1">
<li>
<a href="#_the_fundamentals">8.1. The fundamentals</a><ul class="sectlevel2">
<li><a href="#_snmp_detection">SNMP detection</a></li>
<li><a href="#_discovery">Discovery</a></li>
<li><a href="#_checking">Checking</a></li>
<li><a href="#_summary">Summary</a></li>
</ul>
</li>
<li><a href="#_a_word_about_the_mibs">8.2. A word about the MIBs</a></li>
<li><a href="#locating_oids">8.3. Locating the correct OIDs</a></li>
<li>
<a href="#_registering_the_snmp_section">8.4. Registering the SNMP section</a><ul class="sectlevel2"><li><a href="#_the_snmp_detection">The SNMP detection</a></li></ul>
</li>
<li><a href="#_the_oid_ranges_for_monitoring">8.5. The OID ranges for monitoring</a></li>
<li><a href="#_other_snmp_special_features">8.6. Other SNMP special features</a></li>
</ul>
</li>
<li>
<a href="#format_numbers">9. Formatting numbers</a><ul class="sectlevel1">
<li><a href="#_the_basics">9.1. The basics</a></li>
<li><a href="#_times_time_spans_frequencies">9.2. Times, time spans, frequencies</a></li>
<li><a href="#_bytes">9.3. Bytes</a></li>
<li><a href="#_bandwidths_and_data_rates">9.4. Bandwidths and data rates</a></li>
<li><a href="#_percentages">9.5. Percentages</a></li>
<li><a href="#_summary_2">9.6. Summary</a></li>
</ul>
</li>
<li>
<a href="#parameters">10. Thresholds and check parameters</a><ul class="sectlevel1">
<li><a href="#_a_rule_set_for_the_setup">10.1. A rule set for the setup</a></li>
<li><a href="#_using_existing_rule_sets">10.2. Using existing rule sets</a></li>
<li>
<a href="#_defining_your_own_rule_set">10.3. Defining your own rule set</a><ul class="sectlevel2"><li><a href="#_testing">Testing</a></li></ul>
</li>
<li><a href="#_applying_the_rule_to_the_check_plug_in">10.4. Applying the rule to the check plug-in</a></li>
<li>
<a href="#_further_valuespecs">10.5. Further ValueSpecs</a><ul class="sectlevel2">
<li><a href="#_float">Float</a></li>
<li><a href="#_percentage">Percentage</a></li>
<li><a href="#_monitoringstate">MonitoringState</a></li>
<li><a href="#_age">Age</a></li>
<li><a href="#_filesize">Filesize</a></li>
</ul>
</li>
</ul>
</li>
<li>
<a href="#metrics">11. Customised presentation of metrics</a><ul class="sectlevel1">
<li><a href="#_the_significance_of_metric_definitions">11.1. The significance of metric definitions</a></li>
<li><a href="#_using_existing_metric_definitions">11.2. Using existing metric definitions</a></li>
<li><a href="#ownmetricdefinitions">11.3. Own metric definitions</a></li>
<li><a href="#_graphs_with_multiple_metrics">11.4. Graphs with multiple metrics</a></li>
<li><a href="#perfometer">11.5. Displaying the metrics in the Perf-O-Meter</a></li>
</ul>
</li>
<li>
<a href="#old_api">12. Notes for users of the old API</a><ul class="sectlevel1"><li><a href="#_saveint_and_savefloat">12.1. saveint() and savefloat()</a></li></ul>
</li>
<li>
<a href="#parsefunction">13. Taming complex agent outputs using the parse function</a><ul class="sectlevel1"><li><a href="#_composing_the_parse_function">13.1. Composing the parse function</a></li></ul>
</li>
<li><a href="#outlook">14. The outlook for the future</a></li>
<li><a href="#files">15. Files and directories</a></li>
</ul>
</div>
<script src="../../assets/js/manifest.js?id=7db827d654313dce4250"></script>
<script src="../../assets/js/vendor.js?id=581a3d4a61b7156d04df"></script>
<script src="../../assets/js/app.js?id=959ccd04b1f8b7b78c5e"></script>
<script src="../../assets/js/lunr.js"></script>
<script src="../../assets/js/lunr.stemmer.support.js"></script>
<script src="../lunr.index.en.js"></script>
<script src="../../assets/js/lunr.client.js"></script>
</body>
</html>
