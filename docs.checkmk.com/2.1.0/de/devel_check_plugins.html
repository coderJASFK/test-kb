<!DOCTYPE html>
<html lang="de">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="UTF-8">
<!--[if IE]><meta http-equiv="X-UA-Compatible" content="IE=edge"><![endif]--><meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.10">
<link rel="icon" href="/favicon.png">
<meta name="robots" content="noindex">
<meta name="description" content="Hier erfahren Sie, wie Sie Checkmk-Plugins entwickeln können - mit allem was dazugehört, insbesondere mit der in der Version 2.0.0 neu entwickelten Check-API.">
<meta name="og:locale" content="de">
<meta name="og:site_name" content="Checkmk Docs">
<meta name="og:title" content="Eigene Check-Plugins schreiben">
<meta name="og:description" content="Hier erfahren Sie, wie Sie Checkmk-Plugins entwickeln können - mit allem was dazugehört, insbesondere mit der in der Version 2.0.0 neu entwickelten Check-API.">
<meta name="og:image" content="https://docs.checkmk.com/assets/images/share_image.png">
<meta name="twitter:site" content="@checkmk">
<meta name="twitter:creator" content="@checkmk">
<title>Eigene Check-Plugins schreiben</title>
<link rel="stylesheet" href="../../assets/css/checkmk.css?id=4473d2acbb1ea6136428">
<link rel="stylesheet" href="../../assets/css/pygments-monokai.css">
<link rel="stylesheet" href="../../assets/css/addons.css">
<link rel="stylesheet" href="../../assets/css/SourceCodePro.css">
<link rel="search" href="./opensearch.xml" type="application/opensearchdescription+xml" title="Suche auf docs.checkmk.com">
<!-- Google Tag Manager -->
<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
        new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
    j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
    'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-NJ3VGL8');</script>
<!-- End Google Tag Manager --><style>
#staticinfo { font-style: italic; }
</style>
</head>
<body class="article toc2 toc-right">
<!-- Cookie Consent (GDPR Compliance) -->

<!-- End Cookie Consent (GDPR Compliance) -->
<!-- Google Tag Manager (noscript) -->
<noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-NJ3VGL8" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
<!-- End Google Tag Manager (noscript) --><div class="header-top">
<div class="header-top__left">
<a class="header-top__logo d-none d-xl-inline-block" href="/2.1.0/de"><img src="../../assets/images/docs_logo.png" alt="Checkmk"></a><a class="header-top__icon d-inline-block d-xl-none" href="/2.1.0/de"><img src="../../assets/images/logo_icon.svg" alt="Checkmk"></a>
</div>
<div class="header-top__center">
<input type="text" class="header-top__search" placeholder="Search the checkmk docs"><div class="header-top__search__results"></div>
</div>
<div class="header-top__right d-block">
<button class="header-top__search__toggle d-inline-block d-md-none"><img class="header-top__search__toggle__icon" src="../../assets/images/search.svg" alt="Search"></button><div class="dropdown dropdown__language">
                    <button class="btn dropdown-toggle" type="button" id="languageMenuButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">de</button>
                    <div class="dropdown-menu  dropdown-menu-right" aria-labelledby="languageMenuButton"><a class="dropdown-item" href="../../2.1.0/en/devel_check_plugins.html">English</a></div>
</div>
<div class="dropdown dropdown__branch">
                        <button class="btn dropdown-toggle" type="button" id="branchMenuButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">2.1.0</button>
                        <div class="dropdown-menu dropdown-menu-right" aria-labelledby="branchMenuButton">
<a class="dropdown-item" href="../../2.2.0/de/devel_check_plugins.html">2.2.0</a><a class="dropdown-item" href="../../latest/de/devel_check_plugins.html">latest (2.3.0)</a>
</div>
</div>
<a class="header-top__back d-none d-lg-inline-block" href="https://checkmk.com">to checkmk.com</a><button class="header-top__toggle d-inline-block d-lg-none"><span class="header-top__toggle__icon"></span></button>
</div>
</div>
<aside><div class="main-nav">
<div class="main-nav__content"><div id="content">
<div class="sect1">
<h2 id="_willkommen_bei_checkmk">
<a class="anchor" href="#_willkommen_bei_checkmk"></a>1. Willkommen bei Checkmk</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p><a href="welcome.html">Willkommen im Checkmk Handbuch</a></p>
</li>
<li>
<p><a href="glossar.html">Glossar</a></p>
</li>
<li>
<p><a href="search.html">Suchen in docs.checkmk.com</a></p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_leitfaden_für_einsteiger">
<a class="anchor" href="#_leitfaden_f%C3%BCr_einsteiger"></a>2. Leitfaden für Einsteiger</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p><a href="intro_setup.html">Checkmk aufsetzen</a></p>
</li>
<li>
<p><a href="intro_gui.html">Die Checkmk-Oberfläche</a></p>
</li>
<li>
<p><a href="intro_setup_monitor.html">Das Monitoring einrichten</a></p>
</li>
<li>
<p><a href="intro_tools.html">Die Monitoring-Werkzeuge</a></p>
</li>
<li>
<p><a href="intro_monitor.html">Checkmk im Monitoring</a></p>
</li>
<li>
<p><a href="intro_finetune.html">Das Monitoring feinjustieren</a></p>
</li>
<li>
<p><a href="intro_users.html">Mit mehreren Benutzern arbeiten</a></p>
</li>
<li>
<p><a href="intro_notifications.html">Benachrichtigungen einschalten</a></p>
</li>
<li>
<p><a href="intro_extend.html">Das Monitoring weiter ausbauen</a></p>
</li>
<li>
<p><a href="intro_bestpractise.html">Best Practices, Tipps &amp; Tricks</a></p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_installation">
<a class="anchor" href="#_installation"></a>3. Installation</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p><a href="install_packages.html">Grundsätzliches zur Installation von Checkmk</a></p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="_server_und_vms">
<a class="anchor" href="#_server_und_vms"></a>3.1. Server und VMs</h3>
<div class="ulist">
<ul>
<li>
<p><a href="install_packages_debian.html">Installation unter Debian und Ubuntu</a></p>
</li>
<li>
<p><a href="install_packages_redhat.html">Installation unter Red Hat und CentOS</a></p>
</li>
<li>
<p><a href="install_packages_sles.html">Installation unter SUSE Linux Enterprise Server</a></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_appliance_container_cloud">
<a class="anchor" href="#_appliance_container_cloud"></a>3.2. Appliance, Container, Cloud</h3>
<div class="ulist">
<ul>
<li>
<p><a href="install_appliance_cmk.html">Installation von Checkmk in der Appliance</a></p>
</li>
<li>
<p><a href="introduction_docker.html">Installation als Docker-Container</a></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_updates">
<a class="anchor" href="#_updates"></a>3.3. Updates</h3>
<div class="ulist">
<ul>
<li>
<p><a href="update.html">Updates und Upgrades</a></p>
</li>
<li>
<p><a href="update_major.html">Update auf Version <span class="new">2.1.0</span></a></p>
</li>
<li>
<p><a href="update_matrix.html">Update-Matrix für Version <span class="new">2.1.0</span></a></p>
</li>
<li>
<p><a href="release_upgrade.html">Linux-Upgrade auf dem Checkmk-Server</a></p>
</li>
<li>
<p><a href="cmk_versions.html">Checkmk-Versionen</a></p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_administration_von_checkmk">
<a class="anchor" href="#_administration_von_checkmk"></a>4. Administration von Checkmk</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_server">
<a class="anchor" href="#_server"></a>4.1. Server</h3>
<div class="ulist">
<ul>
<li>
<p><a href="saml.html">Anmeldung mit SAML</a></p>
</li>
<li>
<p><a href="kerberos.html">Single Sign-On mit Kerberos</a></p>
</li>
<li>
<p><a href="managing_docker.html">Checkmk-Server im Docker-Container</a></p>
</li>
<li>
<p><a href="security.html">Sicherheit (Security)</a></p>
</li>
<li>
<p><a href="ports.html">Ports</a></p>
</li>
<li>
<p><a href="omd_https.html">Weboberfläche mit HTTPS absichern</a></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_instanzen">
<a class="anchor" href="#_instanzen"></a>4.2. Instanzen</h3>
<div class="ulist">
<ul>
<li>
<p><a href="omd_basics.html">Instanzen (Sites) mit omd verwalten</a></p>
</li>
<li>
<p><a href="cmk_commandline.html">Checkmk auf der Kommandozeile</a></p>
</li>
<li>
<p><a href="license.html">Lizenzen verwalten</a></p>
</li>
<li>
<p><a href="distributed_monitoring.html">Verteiltes Monitoring</a></p>
</li>
<li>
<p><a href="backup.html">Backups</a></p>
</li>
<li>
<p><a href="analyze_configuration.html">Konfiguration der Checkmk Instanz analysieren</a></p>
</li>
<li>
<p><a href="mkps.html">Checkmk Erweiterungspakete (MKPs)</a></p>
</li>
<li>
<p><a href="simulation_mode.html">Der Simulationsmodus</a></p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_konfiguration">
<a class="anchor" href="#_konfiguration"></a>5. Konfiguration</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p><a href="wato.html">Die Konfiguration von Checkmk</a></p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="_hosts">
<a class="anchor" href="#_hosts"></a>5.1. Hosts</h3>
<div class="ulist">
<ul>
<li>
<p><a href="hosts_setup.html">Verwaltung der Hosts</a></p>
</li>
<li>
<p><a href="hosts_structure.html">Strukturierung der Hosts</a></p>
</li>
<li>
<p><a href="host_tags.html">Host-Merkmale</a></p>
</li>
<li>
<p><a href="dcd.html">Dynamische Host-Konfiguration</a></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_services">
<a class="anchor" href="#_services"></a>5.2. Services</h3>
<div class="ulist">
<ul>
<li>
<p><a href="wato_services.html">Services verstehen und konfigurieren</a></p>
</li>
<li>
<p><a href="clustered_services.html">Cluster-Services überwachen</a></p>
</li>
<li>
<p><a href="piggyback.html">Der Piggyback-Mechanismus</a></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_regeln">
<a class="anchor" href="#_regeln"></a>5.3. Regeln</h3>
<div class="ulist">
<ul>
<li>
<p><a href="wato_rules.html">Host- und Serviceparameter</a></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_unterstützende_konfigurationen">
<a class="anchor" href="#_unterst%C3%BCtzende_konfigurationen"></a>5.4. Unterstützende Konfigurationen</h3>
<div class="ulist">
<ul>
<li>
<p><a href="timeperiods.html">Zeitperioden (Time Periods)</a></p>
</li>
<li>
<p><a href="labels.html">Labels</a></p>
</li>
<li>
<p><a href="regexes.html">Reguläre Ausdrücke in Checkmk</a></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_benutzer_und_berechtigungen">
<a class="anchor" href="#_benutzer_und_berechtigungen"></a>5.5. Benutzer und Berechtigungen</h3>
<div class="ulist">
<ul>
<li>
<p><a href="wato_user.html">Benutzer, Zuständigkeiten, Berechtigungen</a></p>
</li>
<li>
<p><a href="ldap.html">Benutzerverwaltung mit LDAP/Active Directory</a></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_benachrichtigungen">
<a class="anchor" href="#_benachrichtigungen"></a>5.6. Benachrichtigungen</h3>
<div class="ulist">
<ul>
<li>
<p><a href="notifications.html">Einführung in die Benachrichtigungen</a></p>
</li>
<li>
<p><a href="notifications_jira.html">Benachrichtigungen per Jira</a></p>
</li>
<li>
<p><a href="notifications_mattermost.html">Benachrichtigungen per Mattermost</a></p>
</li>
<li>
<p><a href="notifications_pagerduty.html">Benachrichtigungen per PagerDuty</a></p>
</li>
<li>
<p><a href="notifications_pushover.html">Benachrichtigungen per Pushover</a></p>
</li>
<li>
<p><a href="notifications_opsgenie.html">Benachrichtigungen per Opsgenie</a></p>
</li>
<li>
<p><a href="notifications_servicenow.html">Benachrichtigungen per ServiceNow</a></p>
</li>
<li>
<p><a href="notifications_slack.html">Benachrichtigungen per Slack</a></p>
</li>
<li>
<p><a href="notifications_splunkoncall.html">Benachrichtigungen per Splunk On-Call</a></p>
</li>
<li>
<p><a href="notifications_webex.html">Benachrichtigungen per Cisco Webex Teams</a></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_events">
<a class="anchor" href="#_events"></a>5.7. Events</h3>
<div class="ulist">
<ul>
<li>
<p><a href="ec.html">Die Event Console</a></p>
</li>
<li>
<p><a href="alert_handlers.html">Alert Handler</a></p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_überwachung_von_systemen">
<a class="anchor" href="#_%C3%BCberwachung_von_systemen"></a>6. Überwachung von Systemen</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p><a href="wato_monitoringagents.html">Monitoring-Agenten</a></p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="_checkmk_agenten_und_snmp">
<a class="anchor" href="#_checkmk_agenten_und_snmp"></a>6.1. Checkmk-Agenten und SNMP</h3>
<div class="ulist">
<ul>
<li>
<p><a href="agent_deployment.html">Automatische Agenten-Updates</a></p>
</li>
<li>
<p><a href="agent_linux.html">Linux überwachen</a></p>
</li>
<li>
<p><a href="agent_linux_legacy.html">Linux überwachen im Legacy-Modus</a></p>
</li>
<li>
<p><a href="agent_windows.html">Windows überwachen</a></p>
</li>
<li>
<p><a href="agent_freebsd.html">FreeBSD überwachen</a></p>
</li>
<li>
<p><a href="snmp.html">Überwachen via SNMP</a></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_agentenerweiterungen">
<a class="anchor" href="#_agentenerweiterungen"></a>6.2. Agentenerweiterungen</h3>
<div class="ulist">
<ul>
<li>
<p><a href="inventory.html">Die HW/SW-Inventur</a></p>
</li>
<li>
<p><a href="mk_filestats.html">Dateien überwachen</a></p>
</li>
<li>
<p><a href="monitoring_oracle.html">Oracle-Datenbanken überwachen</a></p>
</li>
<li>
<p><a href="monitoring_mysql.html">MySQL überwachen</a></p>
</li>
<li>
<p><a href="monitoring_mssql.html">MSSQL überwachen</a></p>
</li>
<li>
<p><a href="monitoring_jobs.html">Zeitbasierte Prozesse (Cronjobs) überwachen</a></p>
</li>
<li>
<p><a href="spool_directory.html">Das Spool-Verzeichnis</a></p>
</li>
<li>
<p><a href="localchecks.html">Lokale Checks</a></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_vm_cloud_container">
<a class="anchor" href="#_vm_cloud_container"></a>6.3. VM, Cloud, Container</h3>
<div class="ulist">
<ul>
<li>
<p><a href="datasource_programs.html">Datenquellenprogramme</a></p>
</li>
<li>
<p><a href="monitoring_vmware.html">VMWare ESXi überwachen</a></p>
</li>
<li>
<p><a href="monitoring_aws.html">Amazon Web Services (AWS) überwachen</a></p>
</li>
<li>
<p><a href="monitoring_azure.html">Microsoft Azure überwachen</a></p>
</li>
<li>
<p><a href="monitoring_kubernetes.html">Kubernetes überwachen</a></p>
</li>
<li>
<p><a href="monitoring_docker.html">Docker überwachen</a></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_endpunkte">
<a class="anchor" href="#_endpunkte"></a>6.4. Endpunkte</h3>
<div class="ulist">
<ul>
<li>
<p><a href="active_checks.html">Netzwerkdienste überwachen (Aktive Checks)</a></p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_dashboards_views_metriken">
<a class="anchor" href="#_dashboards_views_metriken"></a>7. Dashboards, Views, Metriken</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p><a href="user_interface.html">Die Benutzeroberfläche</a></p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="_allgemein">
<a class="anchor" href="#_allgemein"></a>7.1. Allgemein</h3>
<div class="ulist">
<ul>
<li>
<p><a href="views.html">Ansichten von Hosts und Services (Views)</a></p>
</li>
<li>
<p><a href="dashboards.html">Dashboards</a></p>
</li>
<li>
<p><a href="graphing.html">Messwerte und Graphing</a></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_kommandos_in_ansichten">
<a class="anchor" href="#_kommandos_in_ansichten"></a>7.2. Kommandos in Ansichten</h3>
<div class="ulist">
<ul>
<li>
<p><a href="commands.html">Kommandos</a></p>
</li>
<li>
<p><a href="basics_ackn.html">Quittierung von Problemen</a></p>
</li>
<li>
<p><a href="basics_downtimes.html">Wartungszeiten</a></p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_auswertungen_und_prognosen">
<a class="anchor" href="#_auswertungen_und_prognosen"></a>8. Auswertungen und Prognosen</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_auswertungen">
<a class="anchor" href="#_auswertungen"></a>8.1. Auswertungen</h3>
<div class="ulist">
<ul>
<li>
<p><a href="availability.html">Verfügbarkeit (Availability)</a></p>
</li>
<li>
<p><a href="sla.html">Erweiterte Verfügbarkeiten (SLAs)</a></p>
</li>
<li>
<p><a href="bi.html">Business Intelligence (BI)</a></p>
</li>
<li>
<p><a href="reporting.html">Berichte (Reports)</a></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_prognosen">
<a class="anchor" href="#_prognosen"></a>8.2. Prognosen</h3>
<div class="ulist">
<ul>
<li>
<p><a href="predictive_monitoring.html">Prognosebasiertes Monitoring</a></p>
</li>
<li>
<p><a href="forecast_graphs.html">Vorhersagegraphen erstellen</a></p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_anbindung_anderer_applikationen">
<a class="anchor" href="#_anbindung_anderer_applikationen"></a>9. Anbindung anderer Applikationen</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p><a href="monitoring_prometheus.html">Prometheus integrieren</a></p>
</li>
<li>
<p><a href="integrating_datadog.html">Datadog integrieren</a></p>
</li>
<li>
<p><a href="nagvis.html">NagVis: Statusdaten auf Karten und Diagrammen</a></p>
</li>
<li>
<p><a href="ntop.html">ntopng in Checkmk integrieren</a></p>
</li>
<li>
<p><a href="grafana.html">Checkmk in Grafana integrieren</a></p>
</li>
<li>
<p><a href="metrics_exporter.html">Metriken an InfluxDB und Graphite senden</a></p>
</li>
<li>
<p><a href="nagstamon.html">Nagstamon mit Checkmk verbinden</a></p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_besonderheiten_in_den_editionen">
<a class="anchor" href="#_besonderheiten_in_den_editionen"></a>10. Besonderheiten in den Editionen</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p><a href="support_diagnostics.html">Support Diagnostics</a></p>
</li>
<li>
<p><a href="managed.html">Die Managed Services Edition</a></p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_automatisierung_und_programmierung">
<a class="anchor" href="#_automatisierung_und_programmierung"></a>11. Automatisierung und Programmierung</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_apis_zur_automatisierung">
<a class="anchor" href="#_apis_zur_automatisierung"></a>11.1. APIs zur Automatisierung</h3>
<div class="ulist">
<ul>
<li>
<p><a href="rest_api.html">Konfiguration via Checkmk REST-API</a></p>
</li>
<li>
<p><a href="livestatus.html">Statusdaten abrufen via Livestatus</a></p>
</li>
<li>
<p><a href="livestatus_references.html">Livestatus Befehlsreferenz</a></p>
</li>
<li>
<p><a href="web_api.html">Konfiguration via HTTP-API</a></p>
</li>
<li>
<p><a href="web_api_references.html">Befehlsreferenz der HTTP-API</a></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_apis_zur_programmierung">
<a class="anchor" href="#_apis_zur_programmierung"></a>11.2. APIs zur Programmierung</h3>
<div class="ulist">
<ul>
<li>
<p><a href="bakery_api.html">Die Bakery-API</a></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_programmierung_von_check_plugins">
<a class="anchor" href="#_programmierung_von_check_plugins"></a>11.3. Programmierung von Check-Plugins</h3>
<div class="ulist">
<ul>
<li>
<p><a href="devel_check_plugins.html">Eigene Check-Plugins schreiben</a></p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_konzepte">
<a class="anchor" href="#_konzepte"></a>12. Konzepte</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p><a href="monitoring_basics.html">Grundlagen des Monitorings mit Checkmk</a></p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="_der_checkmk_micro_core_cmc">
<a class="anchor" href="#_der_checkmk_micro_core_cmc"></a>12.1. Der Checkmk Micro Core (CMC)</h3>
<div class="ulist">
<ul>
<li>
<p><a href="cmc.html">Der Checkmk Micro Core (CMC)</a></p>
</li>
<li>
<p><a href="cmc_differences.html">Besonderheiten des CMC</a></p>
</li>
<li>
<p><a href="cmc_migration.html">Migration auf den CMC</a></p>
</li>
<li>
<p><a href="cmc_files.html">Dateien und Verzeichnisse des CMC</a></p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_die_checkmk_appliance">
<a class="anchor" href="#_die_checkmk_appliance"></a>13. Die Checkmk Appliance</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p><a href="appliance_rack1_quick_start.html">Schnellstart-Anleitung für Checkmk-Racks</a></p>
</li>
<li>
<p><a href="appliance_virt1_quick_start.html">Schnellstart-Anleitung für Checkmk virt1</a></p>
</li>
<li>
<p><a href="appliance_install_virt1.html">Virtuelle Appliance installieren</a></p>
</li>
<li>
<p><a href="appliance_usage.html">Appliance einrichten und nutzen</a></p>
</li>
<li>
<p><a href="appliance_backup.html">Backup in der Appliance</a></p>
</li>
<li>
<p><a href="appliance_cluster.html">Appliance im Cluster-Betrieb</a></p>
</li>
<li>
<p><a href="appliance_rack_config.html">Besonderheiten der Hardware-Appliance</a></p>
</li>
</ul>
</div>
</div>
</div>
</div></div>
<div class="main-nav__utils">
<div class="dropup dropdown__utils">
<button class="btn dropdown-toggle" type="button" id="aboutMenuButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">About Checkmk</button><div class="dropdown-menu dropup" aria-labelledby="aboutMenuButton">
<a class="dropdown-item" href="https://checkmk.com/product/features" target="_blank">Features</a><a class="dropdown-item" href="https://checkmk.com/product/editions" target="_blank">Editions</a><a class="dropdown-item" href="https://checkmk.com/integrations" target="_blank">Integrations</a><a class="dropdown-item" href="https://checkmk.com/imprint" target="_blank">Imprint</a><a class="dropdown-item" href="copyright.html" target="_blank">Copyright</a>
</div>
</div>
<div class="dropup dropdown__utils">
<button class="btn dropdown-toggle" type="button" id="learnMenuButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Learn</button><div class="dropdown-menu dropup" aria-labelledby="learnMenuButton">
<a class="dropdown-item" href="https://checkmk.com/videos">Videos</a><a class="dropdown-item" href="https://checkmk.com/webinars">Webinars</a><a class="dropdown-item" href="https://checkmk.com/trainings/classes">Trainings</a>
</div>
</div>
<a class="main-nav__utils__link" href="https://forum.checkmk.com">Forum</a>
</div>
</div></aside><main><div id="header">
<h1>Eigene Check-Plugins schreiben</h1>
<div class="details">
<span id="revdate">Last modified on 01-Mar-2021</span><a class="edit-document" href="https://github.com/Checkmk/checkmk-docs/edit/2.1.0/de/devel_check_plugins.asciidoc">Edit this page on GitHub</a>
</div>
</div>
<div id="content">
<div id="preamble">
<div id="staticinfo">Dies ist eine am 2025-01-07 22:12:14 +0000 für die Offline-Nutzung exportierte Seite. Sie spiegelt möglicherweise nicht den aktuellen Stand der Checkmk Dokumentation wider. Um eine täglich aktualisierte Version dieser Seite anzusehen, rufen Sie bitte <a href="https://docs.checkmk.com/" target="_blank">docs.checkmk.com</a> auf.</div>
<div class="sectionbody"><div class="paragraph">
<p></p>
<div class="dropdown dropdown__related">
<button class="btn btn-primary dropdown-toggle" type="button" id="relatedMenuButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Related Articles</button><div class="dropdown-menu dropdown-menu-right" aria-labelledby="relatedMenuButton">
<a href="localchecks.html">Lokale Checks</a>
<a href="agent_linux.html">Linux überwachen</a>
<a href="agent_windows.html">Windows überwachen</a>
<a href="cmk_commandline.html">Checkmk auf der Kommandozeile</a>
<a href="mkps.html">Checkmk Erweiterungspakete (MKPs)</a>
<a href="simulation_mode.html">Der Simulationsmodus</a>
<a href="snmp.html">Überwachen via SNMP</a>
<a href="wato_monitoringagents.html">Monitoring-Agenten</a>
<a href="wato_services.html">Services verstehen und konfigurieren</a>
</div>
</div>
</div></div>
</div>
<div class="sect1">
<h2 id="heading__einleitung">
<span class="hidden-anchor sr-only" id="_einleitung"></span>1. Einleitung</h2>
<div class="sectionbody">
<div class="paragraph"><p>Checkmk umfasst fast 2.000 fertige Checkplugins für alle nur denkbare Hardware und Software.
Diese werden vom Checkmk-Team gepflegt, und jede Woche kommen neue dazu.
Daneben gibt es auf der
<a href="https://exchange.checkmk.com" target="_blank">Checkmk Exchange</a> weitere Plugins, die von unseren
Anwendern beigesteuert werden.</p></div>
<div class="paragraph"><p>Und trotzdem gibt es immer wieder Situationen, in denen ein Gerät, eine
Anwendung oder einfach nur eine bestimmte Metrik, die für Sie wichtig ist,
noch von keinem dieser Plugins erfasst ist — vielleicht auch einfach
deshalb, weil es sich dabei um etwas handelt, dass in Ihrer Firma entwickelt
wurde und es daher niemand anders haben kann.</p></div>
<div class="sect2">
<h3 id="heading_real_plug-in">
<span class="hidden-anchor sr-only" id="real_plug-in"></span>1.1. Muss es immer ein echtes Plugin sein?</h3>
<div class="paragraph"><p>Welche Möglichkeiten haben Sie also, hier dennoch eine sinnvolle Überwachung
zu implementieren? Nun — natürlich können Sie sich an unseren
<a href="https://checkmk.com/de/produkt/preise#/" target="_blank">Support</a> wenden und ein geeignetes
Plugin entwickeln lassen. Aber Sie können sich auch
selbst helfen. Dabei haben Sie erst einmal vier Möglichkeiten:</p></div>
<table class="table-responsive table-bordered table tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<thead><tr>
<th class="tableblock halign-left valign-top">Methode</th>
<th class="tableblock halign-left valign-top">So geht’s</th>
<th class="tableblock halign-left valign-top">Vorteile</th>
<th class="tableblock halign-left valign-top">Nachteile</th>
</tr></thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="localchecks.html">Lokaler Check</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Checkmk-Agent um einfaches Skript erweitern</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Geht sehr einfach, ist in allen Programmiersprachen möglich, welche das Betriebssystem des überwachten Hosts anbietet, unterstützt sogar Serviceerkennung</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Konfiguration der Schwellwerte nur beim Agenten selbst, für komplexere Dinge unkomfortabel, keine Unterstützung für <a href="snmp.html">SNMP</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Nagios-kompatibles Checkplugin</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Plugin per <em>MRPE</em> vom <a href="agent_windows.html#mrpe">Windows-</a> oder <a href="agent_linux.html#mrpe">Linux-</a>Agenten aufrufen lassen</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Zugriff auf alle vorhandenen Nagios-Plugins, auch hier freie Wahl der Programmiersprache</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Konfiguration der Schwellwerte nur beim Agenten selbst, Keine <a href="snmp.html">SNMP</a>-Unterstützung durch Checkmk, keine Serviceerkennung möglich</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Logmeldungen auswerten</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>Meldungen</em> überwachen per <a href="ec.html">Event Console</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Keine Entwicklung notwendig sondern nur aufstellen von Regeln in der Event Console</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Geht nur, wenn passende Logmeldungen vorhanden sind, kein gesicherter aktueller Status, kein Erfassen von Metriken, keine konfigurierbaren Schwellwerte</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Echtes Checkmk-Plugin</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Wird in diesem Artikel erklärt</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Fügt sich zu 100% in Checkmk ein, automatische Serviceerkennung, zentrale Konfiguration der Schwellwerte über die grafische Oberfläche, sehr performant, unterstützt <a href="snmp.html">SNMP</a>, automatische Host- und Servicelabels möglich, unterstützt <a href="inventory.html">HW/SW-Inventur</a>, Unterstützung durch Standardbibliotheken von Checkmk</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Erfordert mehr Einarbeitungszeit sowie Kenntnisse in der Programmsprache Python</p></td>
</tr>
</tbody>
</table>
<div class="paragraph"><p>Dieser Artikel zeigt Ihnen, wie Sie echte Checkmk-Checkplugins entwickeln
können — mit allem was dazugehört. Dabei zeigen wir Ihnen, wie Sie
die in Version <span class="new">2.0.0</span> von Checkmk <strong>neu entwickelte API</strong> für die
Pluginprogrammierung nutzen.</p></div>
</div>
<div class="sect2">
<h3 id="heading__was_hat_sich_seit_der_alten_api_geändert">
<span class="hidden-anchor sr-only" id="_was_hat_sich_seit_der_alten_api_geändert"></span>1.2. Was hat sich seit der alten API geändert?</h3>
<div class="paragraph"><p>Haben Sie schon Erfahrung mit dem Entwickeln von Checkplugins für die
Checkmk-Version <span class="new">1.6.0</span> oder früher?  Dann finden Sie hier eine knappe
Übersicht über alle Änderungen, welche die ab <span class="new">2.0.0</span> verfügbare neue
Check-API mit sich bringt:</p></div>
<div class="ulist"><ul>
<li><p>Plugins sind jetzt Python-3-Module und die Dateien müssen mit <code>.py</code> enden.</p></li>
<li><p>Die eigenen Plugins liegen jetzt im Verzeichnis <code>local/lib/check_mk/base/plugins/agent_based</code>.</p></li>
<li><p>Am Anfang der Datei brauchen Sie nun mindestens eine spezielle <code>import</code>-Anweisung.</p></li>
<li><p>Die Sektionen und die eigentlichen Checks werden getrennt registriert. Dazu gibt es die neuen Funktionen <code>register.agent_section</code> und <code>register.check_plugin</code>.</p></li>
<li><p>Etliche Funktions- und Argumentnamen wurden umbenannt. Unter anderem wird jetzt immer konsequent von <em>Discovery</em> gesprochen (früher: <em>Inventory</em>).</p></li>
<li><p>Die Discovery-Funktion (vormals Inventory-Funktion) und auch die Check-Funktion müssen nun <em>immer</em> als Generatoren arbeiten (also <code>yield</code> verwenden).</p></li>
<li><p>Die Namen der Argumente der deklarierten Funktionen sind jetzt fest vorgegeben.</p></li>
<li><p>Anstelle der SNMP-Scanfunktion schreiben Sie eine <em>Deklaration</em>, welche OIDs mit welchen Werten erwartet werden.</p></li>
<li><p>Die Funktionen zum Darstellen von Zahlen wurden neu strukturiert (z.B. wird <code>get_bytes_human_readable</code> zu <code>render.bytes</code>).</p></li>
<li><p>Es gibt nun eine eigene Methode, mit der Checks andere ausschließen können (<code>superseeds</code>). Das wird nicht mehr in der SNMP-Scanfunktion gemacht.</p></li>
<li><p>Die Hilfsfunktionen für die Arbeit mit Countern, Raten und Durchschnitten haben sich geändert.</p></li>
<li><p>Anstelle von magischen Rückgabewerten wie z.B. <code>2</code> für <span class="state2">CRIT</span> gibt es jetzt Konstanten (z.B. <code>State.CRIT</code>).</p></li>
<li><p>Viele mögliche Programmierfehler in Ihrem Plugin erkennt Checkmk jetzt sehr früh und kann Sie gleich darauf hinweisen.</p></li>
</ul></div>
</div>
<div class="sect2">
<h3 id="heading__wird_die_alte_api_noch_unterstützt">
<span class="hidden-anchor sr-only" id="_wird_die_alte_api_noch_unterstützt"></span>1.3. Wird die alte API noch unterstützt</h3>
<div class="paragraph"><p>Ja, die bis zu Version <span class="new">1.6.0</span> von Checkmk gültige API für die
Entwicklung von Checkplugins wird mit einigen kleinen Einschränkungen noch
etliche Jahre unterstützt werden, da mit ihr sehr sehr viele Plugins
entwickelt wurden. Während dieser Zeit wird Checkmk beide APIs parallel anbieten.
Einzelheiten erfahren Sie in Werk <a href="https://checkmk.com/werk/10601" target="_blank">#10601</a>.</p></div>
<div class="paragraph"><p>Trotzdem empfehlen wir für die Entwicklung von neuen Plugins die neue API,
da diese konsistenter und logischer ist, besser dokumentiert und langfristig
zukunftssicher.</p></div>
</div>
<div class="sect2">
<h3 id="heading__verschiedene_arten_von_agenten">
<span class="hidden-anchor sr-only" id="_verschiedene_arten_von_agenten"></span>1.4. Verschiedene Arten von Agenten</h3>
<div class="paragraph"><p>Checkplugins werten die Daten der Checkmk-Agenten aus. Bevor wir uns ins Geschehen stürzen, sollten wir uns deshalb zunächst einen Überblick
darüber verschaffen, welche Arten von Agenten Checkmk eigentlich kennt:</p></div>
<table class="table-responsive table-bordered table tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 20%;">
<col style="width: 80%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Checkmk-Agent</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Hier werten die Plugins Daten aus, welcher der Checkmk-Agent für Linux, Windows oder andere Betriebssysteme sendet. Damit werden Betriebssystemparameter und Anwendungen überwacht und teilweise auch Serverhardware. Jedes neue Checkplugin erfordert eine Erweiterung des Agenten in Form eines Agentenplugins, damit dieser die nötigen Daten bereitstellt.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Spezialagent / API-Integration</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Einen Spezialagenten benötigen Sie, wenn Sie weder mit dem normalen Checkmk-Agenten noch per <a href="snmp.html">SNMP</a> an die Daten kommen, welche für das Monitoring relevant sind. Der häufigste Fall ist das Abfragen von HTTP-basierten APIs. Beispiele sind die Überwachung von <a href="monitoring_aws.html">AWS</a>, <a href="monitoring_azure.html">Azure</a> oder <a href="monitoring_vmware.html">VMware</a>. Hier schreiben Sie ein Skript, welches direkt auf dem Checkmk-Server läuft, sich mit der API verbindet, und Daten im gleichen Format ausgibt, wie dies ein Agentenplugin tun würde.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">SNMP</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Bei der Überwachung via <a href="snmp.html">SNMP</a> benötigen Sie keine Erweiterung eines Agenten sondern werten Daten aus, welche Checkmk von dem zu überwachenden Gerät per SNMP abruft, welche dieses standardmäßig bereitstellt. Checkmk unterstützt Sie dabei und übernimmt sämtliche Details und Sonderheiten des SNMP-Protokolls. Eigentlich gibt es auch hier einen Agenten: nämlich den auf dem überwachten System vorinstallierten SNMP-Agenten.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Aktiver Check</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Dieser Checktyp bildet eine Sonderrolle. Hier schreiben Sie zunächst ein klassisches Nagios-kompatibles Plugin, welches für die Ausführung <em>auf dem Checkmk-Server</em> bestimmt ist und von dort aus mit einem Netzwerkprotokoll direkt einen Dienst auf dem Zielgerät abfragt. Das prominenteste Beispiel ist das Plugin <code>check_http</code>, mit welchem Sie Webserver und Webseiten überwachen können. Dieses Plugin können Sie dann so in Checkmk integrieren, dass man es wie gewohnt per Regeln einrichten kann.</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect2">
<h3 id="heading__voraussetzungen">
<span class="hidden-anchor sr-only" id="_voraussetzungen"></span>1.5. Voraussetzungen</h3>
<div class="paragraph"><p>Wenn Sie Lust haben, sich mit dem Programmieren von Checkplugins zu befassen,
benötigen Sie folgendes:</p></div>
<div class="ulist"><ul>
<li><p>Kenntnisse in der Programmiersprache Python</p></li>
<li><p>Erfahrung mit Checkmk, vor allem was das Thema Agenten und Checks betrifft</p></li>
<li><p>etwas Übung mit Linux auf der Kommandozeile</p></li>
</ul></div>
<div class="paragraph"><p>Als Vorbereitung sind außerdem folgende Artikel gut:</p></div>
<div class="ulist"><ul>
<li><p><a href="wato_services.html">Services verstehen und konfigurieren</a></p></li>
<li><p><a href="wato_monitoringagents.html">Monitoring-Agenten</a></p></li>
<li><p><a href="agent_windows.html">Windows überwachen</a></p></li>
<li><p><a href="agent_linux.html">Linux überwachen</a></p></li>
<li><p><a href="snmp.html">Überwachen via SNMP</a></p></li>
<li><p><a href="cmk_commandline.html">Checkmk auf der Kommandozeile</a></p></li>
<li><p><a href="mkps.html">Checkmk Erweiterungspakete (MKPs)</a></p></li>
<li><p><a href="simulation_mode.html">Der Simulationsmodus</a></p></li>
</ul></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="heading_agentbased">
<span class="hidden-anchor sr-only" id="agentbased"></span>2. Ein erstes einfaches Checkplugin</h2>
<div class="sectionbody">
<div class="paragraph"><p>Nach dieser langen Einleitung wird es Zeit, dass wir unser erstes einfaches
Checkplugin programmieren. Als Beispiel nehmen wir eine einfache Überwachung
für Linux. Denn da Checkmk selbst auf Linux läuft, ist es sehr wahrscheinlich,
dass Sie auch auf ein Linux-System Zugriff haben.</p></div>
<div class="paragraph"><p>Das Checkplugin soll einen neuen Service anlegen, welcher erkennt, ob auf einem
Linux-Server jemand einen USB-Stick eingesteckt hat. In diesem Fall soll der Service
kritisch werden. Vielleicht werden Sie s etwas sogar nützlich finden, aber
es ist wirklich nur ein vereinfachtes Beispiel und möglicherweise auch
nicht ganz wasserdicht programmiert. Denn darum geht es hier erst einmal nicht.</p></div>
<div class="paragraph"><p>Das Ganze läuft in zwei Schritten:</p></div>
<div class="olist arabic"><ol class="arabic">
<li><p>Wir finden heraus, mit welchem Linux-Befehl man sehen kann, ob ein USB-Stick eingesteckt ist, und erweitern den Linux-Agenten um ein kleines Skript, welches diesen Befehl aufruft.</p></li>
<li><p>Wir schreiben in der Checkmk-Instanz ein Checkplugin, welches diese Daten auswertet.</p></li>
</ol></div>
<div class="paragraph"><p>Und los geht’s…​</p></div>
<div class="sect2">
<h3 id="heading__den_richtigen_befehl_finden">
<span class="hidden-anchor sr-only" id="_den_richtigen_befehl_finden"></span>2.1. Den richtigen Befehl finden</h3>
<div class="paragraph"><p>Am Anfang jeder Checkprogrammierung steht: die Recherche! Das bedeutet, dass
wir herausfinden, wie wir überhaupt an die Informationen kommen, die wir für
die Überwachung brauchen. Bei Linux sind das oft Kommandozeilenbefehle, bei
Windows hilft die PowerShell, VBScript oder WMI und bei <a href="snmp.html">SNMP</a> müssen wir die
richtigen OIDs finden (dazu gibt es ein <a href="#snmp">eigenes Kapitel</a>).</p></div>
<div class="paragraph"><p>Für das Herausfinden des richtigen Befehls gibt es leider kein allgemeines
Vorgehen und so wollen wir uns auch nicht all zulange mit dem Thema aufhalten,
erklären aber kurz, wie das mit dem USB-Stick funktioniert.</p></div>
<div class="paragraph"><p>Zunächst loggen wir uns also auf dem zu überwachenden Host ein.  Unter Linux
läuft der Agent per Default als <code>root</code>-Benutzer. Deswegen machen
wir auch alle unsere Tests als <code>root</code>.  Für unsere Aufgabe
mit dem USB-Stick gibt es praktischerweise symbolische Links im Verzeichnis
<code>/dev/disk/by-id</code>. Diese zeigen auf alle Linux-Block-Devices.  Und ein
solches ist auch ein eingesteckter USB-Stick. Außerdem kann man an der ID
am Präfix <code>usb-</code> erkennen, wenn ein Block-Device ein USB-Gerät ist.</p></div>
<div class="paragraph"><p>Folgender Befehl listet alle Einträge in diesem Verzeichnis auf:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="console"><span></span><span class="tok-gp">root@linux# </span>ls<span class="tok-w"> </span>-l<span class="tok-w"> </span>/dev/disk/by-id/
<span class="tok-go">total 0</span>
<span class="tok-go">lrwxrwxrwx 1 root root  9 May 14 11:21 ata-APPLE_SSD_SM0512F_S1K5NYBF810191 -&gt; ../../sda</span>
<span class="tok-go">lrwxrwxrwx 1 root root 10 May 14 11:21 ata-APPLE_SSD_SM0512F_S1K5NYBF810191-part1 -&gt; ../../sda1</span>
<span class="tok-go">lrwxrwxrwx 1 root root 10 May 14 11:21 ata-APPLE_SSD_SM0512F_S1K5NYBF810191-part2 -&gt; ../../sda2</span>
<span class="tok-go">lrwxrwxrwx 1 root root 10 May 14 11:21 ata-APPLE_SSD_SM0512F_S1K5NYBF810191-part3 -&gt; ../../sda3</span>
<span class="tok-go">lrwxrwxrwx 1 root root 10 May 14 11:21 ata-APPLE_SSD_SM0512F_S1K5NYBF810191-part4 -&gt; ../../sda4</span>
<span class="tok-go">lrwxrwxrwx 1 root root 10 May 14 11:21 ata-APPLE_SSD_SM0512F_S1K5NYBF810191-part5 -&gt; ../../sda5</span>
<span class="tok-go">lrwxrwxrwx 1 root root  9 May 14 11:21 wwn-0x5002538655584d30 -&gt; ../../sda</span>
<span class="tok-go">lrwxrwxrwx 1 root root 10 May 14 11:21 wwn-0x5002538655584d30-part1 -&gt; ../../sda1</span>
<span class="tok-go">lrwxrwxrwx 1 root root 10 May 14 11:21 wwn-0x5002538655584d30-part2 -&gt; ../../sda2</span>
<span class="tok-go">lrwxrwxrwx 1 root root 10 May 14 11:21 wwn-0x5002538655584d30-part3 -&gt; ../../sda3</span>
<span class="tok-go">lrwxrwxrwx 1 root root 10 May 14 11:21 wwn-0x5002538655584d30-part4 -&gt; ../../sda4</span>
<span class="tok-go">lrwxrwxrwx 1 root root 10 May 14 11:21 wwn-0x5002538655584d30-part5 -&gt; ../../sda5</span></code></pre></div></div>
<div class="paragraph"><p>So. Und das Ganze jetzt mit eingestecktem USB-Stick:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="console"><span></span><span class="tok-gp">root@linux# </span>ls<span class="tok-w"> </span>-l<span class="tok-w"> </span>/dev/disk/by-id/
<span class="tok-go">total 0</span>
<span class="tok-go">lrwxrwxrwx 1 root root  9 Mai 14 11:21 ata-APPLE_SSD_SM0512F_S1K5NYBF810191 -&gt; ../../sda</span>
<span class="tok-go">lrwxrwxrwx 1 root root 10 Mai 14 11:21 ata-APPLE_SSD_SM0512F_S1K5NYBF810191-part1 -&gt; ../../sda1</span>
<span class="tok-go">lrwxrwxrwx 1 root root 10 Mai 14 11:21 ata-APPLE_SSD_SM0512F_S1K5NYBF810191-part2 -&gt; ../../sda2</span>
<span class="tok-go">lrwxrwxrwx 1 root root 10 Mai 14 11:21 ata-APPLE_SSD_SM0512F_S1K5NYBF810191-part3 -&gt; ../../sda3</span>
<span class="tok-go">lrwxrwxrwx 1 root root 10 Mai 14 11:21 ata-APPLE_SSD_SM0512F_S1K5NYBF810191-part4 -&gt; ../../sda4</span>
<span class="tok-go">lrwxrwxrwx 1 root root 10 Mai 14 11:21 ata-APPLE_SSD_SM0512F_S1K5NYBF810191-part5 -&gt; ../../sda5</span>
<span class="tok-go">lrwxrwxrwx 1 root root  9 Mai 14 12:15 usb-SCSI_DISK-0:0 -&gt; ../../sdc</span>
<span class="tok-go">lrwxrwxrwx 1 root root 10 Mai 14 12:15 usb-SCSI_DISK-0:0-part1 -&gt; ../../sdc1</span>
<span class="tok-go">lrwxrwxrwx 1 root root 10 Mai 14 12:15 usb-SCSI_DISK-0:0-part2 -&gt; ../../sdc2</span>
<span class="tok-go">lrwxrwxrwx 1 root root  9 Mai 14 11:21 wwn-0x5002538655584d30 -&gt; ../../sda</span>
<span class="tok-go">lrwxrwxrwx 1 root root 10 Mai 14 11:21 wwn-0x5002538655584d30-part1 -&gt; ../../sda1</span>
<span class="tok-go">lrwxrwxrwx 1 root root 10 Mai 14 11:21 wwn-0x5002538655584d30-part2 -&gt; ../../sda2</span>
<span class="tok-go">lrwxrwxrwx 1 root root 10 Mai 14 11:21 wwn-0x5002538655584d30-part3 -&gt; ../../sda3</span>
<span class="tok-go">lrwxrwxrwx 1 root root 10 Mai 14 11:21 wwn-0x5002538655584d30-part4 -&gt; ../../sda4</span>
<span class="tok-go">lrwxrwxrwx 1 root root 10 Mai 14 11:21 wwn-0x5002538655584d30-part5 -&gt; ../../sda5</span></code></pre></div></div>
</div>
<div class="sect2">
<h3 id="heading__die_daten_entschlacken">
<span class="hidden-anchor sr-only" id="_die_daten_entschlacken"></span>2.2. Die Daten entschlacken</h3>
<div class="paragraph"><p>Eigentlich wären wir damit fertig und könnten diese ganze Ausgabe per Checkmk-Agent
zum Checkmk-Server transportieren und dort analysieren lassen. Denn im Checkmk gilt
immer folgende Empfehlung: lassen Sie die komplexe Arbeit immer den Server erledigen.
Halten Sie das Agentenplugin so einfach wie möglich.</p></div>
<div class="paragraph"><p>Aber: Hier ist trotzdem noch zu viel heiße Luft drin. Es ist immer gut,
unnötige Daten nicht zu übertragen. Das spart Netzwerkverkehr, Speicher,
Rechenzeit und macht alles auch übersichtlicher. Das geht besser!</p></div>
<div class="paragraph"><p>Als erstes können wir das <code>-l</code> weglassen. Damit ist die Ausgabe von
<code>ls</code> schon deutlich schlanker:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="console"><span></span><span class="tok-gp">root@linux# </span>ls<span class="tok-w"> </span>/dev/disk/by-id/
<span class="tok-go">ata-APPLE_SSD_SM0512F_S1K5NYBF810191        ata-APPLE_SSD_SM0512F_S1K5NYBF810191-part5  wwn-0x5002538655584d30-part3</span>
<span class="tok-go">ata-APPLE_SSD_SM0512F_S1K5NYBF810191-part1  wwn-0x5002538655584d30-part4                ata-APPLE_SSD_SM0512F_S1K5NYBF810191-part2</span>
<span class="tok-go">wwn-0x5002538655584d30                      wwn-0x5002538655584d30-part5                ata-APPLE_SSD_SM0512F_S1K5NYBF810191-part3</span>
<span class="tok-go">wwn-0x5002538655584d30-part1                ata-APPLE_SSD_SM0512F_S1K5NYBF810191-part4  wwn-0x5002538655584d30-part2</span></code></pre></div></div>
<div class="paragraph"><p>Jetzt wiederum stört der mehrspaltige Aufbau, der aber nur deshalb erfolgt, weil der <code>ls</code>-Befehl erkennt,
dass er in einem interaktiven Terminal läuft. Später als Teil vom Agenten wird er die Daten einspaltig ausgeben.
Das können wir aber auch ganz einfach hier mit der Option <code>-1</code> (für *ein*spaltige Ausgabe) erzwingen:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="console"><span></span><span class="tok-gp">root@linux# </span>ls<span class="tok-w"> </span>-1<span class="tok-w"> </span>/dev/disk/by-id/
<span class="tok-go">ata-APPLE_SSD_SM0512F_S1K5NYBF810191</span>
<span class="tok-go">ata-APPLE_SSD_SM0512F_S1K5NYBF810191-part1</span>
<span class="tok-go">ata-APPLE_SSD_SM0512F_S1K5NYBF810191-part2</span>
<span class="tok-go">ata-APPLE_SSD_SM0512F_S1K5NYBF810191-part3</span>
<span class="tok-go">ata-APPLE_SSD_SM0512F_S1K5NYBF810191-part4</span>
<span class="tok-go">ata-APPLE_SSD_SM0512F_S1K5NYBF810191-part5</span>
<span class="tok-go">wwn-0x5002538655584d30</span>
<span class="tok-go">wwn-0x5002538655584d30-part1</span>
<span class="tok-go">wwn-0x5002538655584d30-part2</span>
<span class="tok-go">wwn-0x5002538655584d30-part3</span>
<span class="tok-go">wwn-0x5002538655584d30-part4</span>
<span class="tok-go">wwn-0x5002538655584d30-part5</span></code></pre></div></div>
<div class="paragraph"><p>Wenn Sie genau hinsehen, werden Sie nicht nur die Blockgeräte selbst sehen,
sondern auch dort vorhandene Partitionen. Dies sind die Einträge, die
auf <code>-part1</code>, <code>-part2</code> usw. enden. Diese brauchen wir für unseren
Check nicht und bekommen sie ganz einfach weg mit einem <code>grep</code>. Dort
nehmen wir die Option <code>-v</code> für eine negative Logik:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="console"><span></span><span class="tok-gp">root@linux# </span>ls<span class="tok-w"> </span>/dev/disk/by-id/<span class="tok-w"> </span><span class="tok-p">|</span><span class="tok-w"> </span>grep<span class="tok-w"> </span>-v<span class="tok-w"> </span>--<span class="tok-w"> </span>-part
<span class="tok-go">ata-APPLE_SSD_SM0512F_S1K5NYBF810191</span>
<span class="tok-go">usb-SCSI_DISK-0:0</span>
<span class="tok-go">wwn-0x5002538655584d30</span></code></pre></div></div>
<div class="paragraph"><p>Hier sieht man jetzt auch viel deutlicher, dass es in unserem Beispiel genau drei Geräte sind, falls der USB-Stick eingesteckt ist:</p></div>
<div class="paragraph"><p>Perfekt! Jetzt haben wir eine übersichtliche Liste aller Blockgeräte, die
mit einem einfachen Befehl ermittelt wird. Mehr brauchen wir nicht.</p></div>
<div class="paragraph"><p>Das <code>-1</code> haben wir im letzten Kommando wieder weggelassen, weil <code>ls</code> jetzt in eine Pipe schreibt und von sich aus einspaltig ausgibt. Und
<code>grep</code> braucht das <code>--</code>, da es sonst das Wort <code>-part</code>
als die vier Optionen <code>-p</code>, <code>-a</code>, <code>-r</code> und <code>-t</code>
interpretieren würde.</p></div>
<div class="paragraph"><p>Übrigens: Warum „greppen“” wir nicht gleich noch nach <code>usb</code>? So dass
nur noch USB-Geräte ausgegeben werden? Nun, natürlich könnten wir
das tun. Aber zum einen wird dann unser Beispiel zunehmend langweilig und
außerdem ist es irgendwie beruhigender, im Normalfall <em>irgendeinen</em>
Inhalt in der Sektion zu bekommen und nicht einfach nur nichts. So kann
man auf dem Checkmk-Server sofort erkennen, dass das Agentenplugin korrekt
funktioniert.</p></div>
</div>
<div class="sect2">
<h3 id="heading_includecommand">
<span class="hidden-anchor sr-only" id="includecommand"></span>2.3. Den Befehl in den Agenten einbauen</h3>
<div class="paragraph"><p>Damit wir vom Checkmk-Server aus diese Daten abrufen können, müssen wir den
neuen Befehl Teil vom Checkmk-Agenten auf dem überwachten System machen. Wir
könnten dazu natürlich einfach dort die Datei <code>/usr/bin/check_mk_agent</code> editieren
und das einbauen. Das hätte dann aber den Nachteil, dass bei einem Softwareupdate
des Agenten unser Befehl wieder verschwindet, weil die Datei ersetzt wird.</p></div>
<div class="paragraph"><p>Besser ist daher, wenn wir ein <strong>Agentenplugin</strong> machen. Das ist sogar
noch einfacher. Alles was wir brauchen, ist eine ausführbare Datei mit unserem
Befehl im Verzeichnis <code>/usr/lib/check_mk_agent/plugins</code>.</p></div>
<div class="paragraph"><p>Und noch eins ist wichtig: Wir können unsere Daten nicht einfach so
ausgeben. Was wir noch brauchen, ist ein <strong>Sektionskopf</strong> (<em>section header</em>).
Das ist eine speziell formatierte Zeile, in der der Name unseres
neuen Checks steht. An diesen Sektionsköpfen kann Checkmk später erkennen, wo die
Daten des Plugins beginnen und die des vorherigen aufhören.</p></div>
<div class="paragraph"><p>Also brauchen wir jetzt erst einmal einen sinnvollen Namen für unseren neuen Check.
Dieser Name darf nur Kleinbuchstaben (nur <em>a-z</em>, keine Umlaute, keine Akzente), Unterstriche und Ziffern enthalten und muss eindeutig sein.
Vermeiden Sie  Namenskollisionen mit vorhandenen Check-Plugins.
Wenn Sie neugierig sind, welche Namen es schon gibt, können Sie diese in einer Checkmk-Instanz auf der Kommandozeile mit <code>cmk -L</code> auflisten lassen:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="console"><span></span><span class="tok-gp">OMD[mysite]:~$ </span>cmk<span class="tok-w"> </span>-L<span class="tok-w"> </span><span class="tok-p">|</span><span class="tok-w"> </span>head<span class="tok-w"> </span>-n<span class="tok-w"> </span><span class="tok-m">20</span>
<span class="tok-go">3par_capacity                agent      HPE 3PAR: Capacity</span>
<span class="tok-go">3par_cpgs                    agent      HPE 3PAR: CPGs</span>
<span class="tok-go">3par_cpgs_usage              agent      HPE 3PAR: CPGs Usage</span>
<span class="tok-go">3par_hosts                   agent      HPE 3PAR: Hosts</span>
<span class="tok-go">3par_ports                   agent      HPE 3PAR: Ports</span>
<span class="tok-go">3par_remotecopy              agent      HPE 3PAR: Remote Copy</span>
<span class="tok-go">3par_system                  agent      HPE 3PAR: System</span>
<span class="tok-go">3par_volumes                 agent      HPE 3PAR: Volumes</span>
<span class="tok-go">3ware_disks                  agent      3ware ATA RAID Controller: State of Disks</span>
<span class="tok-go">3ware_info                   agent      3ware ATA RAID Controller: General Information</span>
<span class="tok-go">3ware_units                  agent      3ware ATA RAID Controller: State of Units</span>
<span class="tok-go">acme_agent_sessions          snmp       ACME Devices: Agent Sessions</span>
<span class="tok-go">acme_certificates            snmp       ACME Devices: Certificates</span>
<span class="tok-go">acme_fan                     snmp       ACME Devices: Fans</span>
<span class="tok-go">acme_powersupply             snmp       ACME Devices: Power Supplies</span>
<span class="tok-go">acme_realm                   snmp       ACME Devices: Realm</span>
<span class="tok-go">acme_sbc                     agent      ACME SBC: Health</span>
<span class="tok-go">acme_sbc_settings            agent      ACME SBC: Health Settings</span>
<span class="tok-go">acme_sbc_snmp                snmp       ACME SBC: Health (via SNMP)</span>
<span class="tok-go">acme_temp                    snmp       ACME Devices: Temperature</span></code></pre></div></div>
<div class="paragraph"><p>Die zweite Spalte zeigt an, wie das jeweilige Checkplugin seine Daten bezieht.</p></div>
<div class="paragraph"><p>Wählen wir für unser Beispiel den Namen <code>linux_usbstick</code>. In diesem
Fall muss der Sektionskopf so aussehen:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code><span></span>&lt;&lt;&lt;linux_usbstick&gt;&gt;&gt;</code></pre></div></div>
<div class="paragraph"><p>Den können wir einfach mit <code>echo</code> ausgeben. Wenn wir dann noch den
„Shebang“ nicht vergessen (das ist kein giftiger Stachel aus dem Wüstenplaneten
sondern eine Abkürzung für <em>sharp</em> und <em>bang</em>, wobei letzteres
eine Abkürzung für das Ausrufezeichen ist!), an dem Linux erkennt, dass es
das Skript mit der Shell ausführen soll, dann sieht unser Plugin
so aus:</p></div>
<div class="listingblock">
<div class="title">/usr/lib/check_mk_agent/plugins/linux_usbstick</div>
<div class="content"><pre class="pygments highlight"><code><span></span>#!/bin/sh
echo '&lt;&lt;&lt;linux_usbstick&gt;&gt;&gt;'
ls /dev/disk/by-id/ | grep -v -- -part</code></pre></div>
</div>
<div class="paragraph"><p>Als Dateiname haben wir jetzt einfach auch <code>linux_usbstick</code> verwendet,
auch wenn der eigentlich egal ist. Aber eines ist noch sehr wichtig: Machen
Sie die Datei ausführbar!</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="console"><span></span><span class="tok-gp">root@linux# </span>chmod<span class="tok-w"> </span>+x<span class="tok-w"> </span>/usr/lib/check_mk_agent/plugins/linux_usbstick</code></pre></div></div>
<div class="paragraph"><p>Natürlich können Sie das Plugin ganz einfach von Hand ausprobieren, indem Sie den
kompletten Pfad als Befehl eingeben:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="console"><span></span><span class="tok-gp">root@linux# </span>/usr/lib/check_mk_agent/plugins/linux_usbstick
<span class="tok-go">&lt;&lt;&lt;linux_usbstick&gt;&gt;&gt;</span>
<span class="tok-go">ata-APPLE_SSD_SM0512F_S1K5NYBF810191</span>
<span class="tok-go">wwn-0x5002538655584d30</span></code></pre></div></div>
</div>
<div class="sect2">
<h3 id="heading__agent_ausprobieren">
<span class="hidden-anchor sr-only" id="_agent_ausprobieren"></span>2.4. Agent ausprobieren</h3>
<div class="paragraph"><p>Wie immer sind Test und Fehlersuche am wichtigsten. Am besten gehen Sie in drei Schritten vor:</p></div>
<div class="olist arabic"><ol class="arabic">
<li><p>Plugin solo ausprobieren. Das haben wir gerade gemacht.</p></li>
<li><p>Agent als ganzes lokal testen.</p></li>
<li><p>Agent vom Checkmk-Server aus abrufen.</p></li>
</ol></div>
<div class="paragraph"><p>Das lokale Testen des Agenten ist sehr einfach. Rufen Sie als <code>root</code>
den Befehl <code>check_mk_agent</code> auf. Irgendwo in der Ausgabe muss die neue
Sektion erscheinen:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="console"><span></span><span class="tok-gp">root@linux# </span>check_mk_agent</code></pre></div></div>
<div class="paragraph"><p>Hier ist ein Ausschnitt der Ausgabe, welcher die neue Sektion enthält:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="console"><span></span><span class="tok-go">&lt;&lt;&lt;lnx_thermal:sep(124)&gt;&gt;&gt;</span>
<span class="tok-go">thermal_zone0|-|BAT0|35600</span>
<span class="tok-go">thermal_zone1|-|x86_pkg_temp|81000|0|passive|0|passive</span>
<span class="tok-go">&lt;&lt;&lt;local&gt;&gt;&gt;</span>
<span class="tok-go">&lt;&lt;&lt;linux_usbstick&gt;&gt;&gt;</span>
<span class="tok-go">ata-APPLE_SSD_SM0512F_S1K5NYBF810191</span>
<span class="tok-go">wwn-0x5002538655584d30</span>
<span class="tok-go">&lt;&lt;&lt;lnx_packages:sep(124):persist(1589463274)&gt;&gt;&gt;</span>
<span class="tok-go">accountsservice|0.6.45-1ubuntu1|amd64|deb|-||install ok installed</span>
<span class="tok-go">acl|2.2.52-3build1|amd64|deb|-||install ok installed</span>
<span class="tok-go">acpi|1.7-1.1|amd64|deb|-||install ok installed</span></code></pre></div></div>
<div class="paragraph"><p>Durch Anhängen von <code>less</code> können Sie in der Ausgabe blättern
(drücken Sie die Leertaste zum Blättern,
<code>/</code> zum Suchen und <code>Q</code> zum Beenden):</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="console"><span></span><span class="tok-gp">root@linux# </span>check_mk_agent<span class="tok-w"> </span><span class="tok-p">|</span><span class="tok-w"> </span>less</code></pre></div></div>
<div class="paragraph"><p>Der dritte Test ist dann direkt von der Checkmk-Instanz aus. Nehmen Sie den Host ins Monitoring
auf (z.B. als <code>myserver01</code>) und rufen Sie die Agentendaten dann mit <code>cmk -d</code> ab.
Hier sollte die gleiche Ausgabe kommen:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="console"><span></span><span class="tok-gp">OMD[mysite]:~$ </span>cmk<span class="tok-w"> </span>-d<span class="tok-w"> </span>myserver01<span class="tok-w"> </span><span class="tok-p">|</span><span class="tok-w"> </span>less</code></pre></div></div>
<div class="paragraph"><p>Übrigens: <code>grep</code> hat mit <code>-A</code> eine Option, nach jedem Treffer
noch einige Zeilen mehr auszugeben.  Damit können Sie bequem die Sektion
suchen und ausgeben:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="console"><span></span><span class="tok-gp">root@linux# </span>cmk<span class="tok-w"> </span>-d<span class="tok-w"> </span>myserver01<span class="tok-w"> </span><span class="tok-p">|</span><span class="tok-w"> </span>grep<span class="tok-w"> </span>-A5<span class="tok-w"> </span><span class="tok-s1">'^&lt;&lt;&lt; linux_usbstick'</span>
<span class="tok-go">&lt;&lt;&lt;linux_usbstick&gt;&gt;&gt;</span>
<span class="tok-go">ata-APPLE_SSD_SM0512F_S1K5NYBF810191</span>
<span class="tok-go">wwn-0x5002538655584d30</span>
<span class="tok-go">&lt;&lt;&lt;lnx_packages:sep(124):persist(1589463559)&gt;&gt;&gt;</span>
<span class="tok-go">accountsservice|0.6.45-1ubuntu1|amd64|deb|-||install ok installed</span></code></pre></div></div>
<div class="paragraph"><p>Wenn das funktioniert, ist Ihr Agent vorbereitet! Und was haben wir
dafür gemacht? Wir haben lediglich ein dreizeiliges Skript mit dem Pfad
<code>/usr/lib/check_mk_agent/plugins/linux_usbstick</code> erzeugt und ausführbar
gemacht!</p></div>
<div class="paragraph"><p>Alles was nun folgt, geschieht nur noch auf dem Checkmk-Server: Dort schreiben
wir das eigentliche Checkplugin.</p></div>
</div>
<div class="sect2">
<h3 id="heading__die_sektion_deklarieren">
<span class="hidden-anchor sr-only" id="_die_sektion_deklarieren"></span>2.5. Die Sektion deklarieren</h3>
<div class="paragraph"><p>Das Vorbereiten des Agenten ist zwar der komplizierteste Teil, aber nur die
halbe Miete. Jetzt müssen wir Checkmk noch beibringen, wie es mit den Informationen
und der neuen Agentensektion umgehen soll, welche Services es erzeugen soll,
wann diese auf <span class="state0">OK</span> oder <span class="state2">CRIT</span> gehen sollen usw. All dies machen wir durch
die Programmierung eines Checkplugins in Python.</p></div>
<div class="paragraph"><p>Für Ihre eigenen Checkplugins finden Sie ein Verzeichnis vorbereitet
in der <code>local</code>-Hierarchie des
<a href="cmk_commandline.html#sitedir">Instanzverzeichnisses</a>. Dieses lautet
<code>local/lib/check_mk/base/plugins/agent_based/</code>. Hier im Pfad
bedeutet <code>base</code> den Teil von Checkmk, der für das eigentlich Monitoring
und die Alarmierung zuständig ist. Das <code>agent_based</code> ist
für alle Plugins, die sich auf den Checkmk-Agenten
beziehen (also z.B. nicht Alarmierungsplugins). Am einfachsten, Sie wechseln
zum Arbeiten dort hinein:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="console"><span></span><span class="tok-gp">OMD[mysite]:~$ </span><span class="tok-nb">cd</span><span class="tok-w"> </span>local/lib/check_mk/base/plugins/agent_based</code></pre></div></div>
<div class="paragraph"><p>Das Verzeichnis gehört dem Instanzbenutzer und ist daher für Sie schreibbar.
Sie können Ihr Plugin mit jedem auf dem Linux-System installierten Texteditor
bearbeiten.</p></div>
<div class="paragraph"><p>Legen wir also unser Plugin hier an. Konvention ist, dass der Dateiname
den Namen der Agentensektion wiedergibt. <em>Pflicht</em> ist, dass die Datei
mit <code>.py</code> endet, denn ab Version <span class="new">2.0.0</span> von Checkmk handelt es
sich bei den Plugins immer um echte Pythonmodule.</p></div>
<div class="paragraph"><p>Als erstes müssen wir die für die Plugins nötigen Funktionen aus
anderen Pythonmodulen importieren. Die einfachste Methode dafür ist die
mit einem <code>*</code>. Wie Sie vielleicht ahnen können, steckt hier auch
eine Versionsnummer der API für die Pluginprogrammierung. Diese ist bis
auf weiteres Version 1, was hier durch <code>v1</code> abgekürzt ist:</p></div>
<div class="listingblock">
<div class="title">local/lib/check_mk/base/plugins/agent_based/linux_usbstick.py</div>
<div class="content"><pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-kn">from</span> <span class="tok-nn">.agent_based_api.v1</span> <span class="tok-kn">import</span> <span class="tok-o">*</span></code></pre></div>
</div>
<div class="paragraph"><p>Diese Versionierung ermöglicht es uns in Zukunft eventuell neue
Versionen der API <em>parallel</em> zu den bisherigen bereitzustellen,
so dass bestehende Checkplugins weiterhin problemlos funktionieren.</p></div>
<div class="paragraph"><p>Im einfachsten Fall überspringen Sie das explizite deklarieren der Sektion.
Wenn Sie eine Parsefunktion implementieren möchten (wozu Ihnen professionelle
Entwickler immer raten würden), finden Sie im <a href="#parsefunction">Abschnitt über Parsefunktionen</a>
mehr Informationen.</p></div>
</div>
<div class="sect2">
<h3 id="heading__den_check_deklarieren">
<span class="hidden-anchor sr-only" id="_den_check_deklarieren"></span>2.6. Den Check deklarieren</h3>
<div class="paragraph"><p>Damit Checkmk weiß, dass es den neuen Check gibt, muss dieser
registriert werden. Dies geschieht durch den Aufruf
der Funktion <code>register.check_plugin</code>.
Dabei müssen Sie immer mindestens vier Dinge angeben:</p></div>
<div class="olist arabic"><ol class="arabic">
<li><p><code>name</code>: Der Name des Checkplugins. Wenn Sie keinen Ärger bekommen möchten, nehmen Sie hier den gleichen Namen wie bei Ihrer neuen Agentensektion. Damit weiß der Check automatisch, welche Sektion er auswerten soll.</p></li>
<li><p><code>service_name</code>: Der Name des Services wie er dann im Monitoring erscheinen soll.</p></li>
<li><p><code>discovery_function</code>: Die Funktion zum Erkennen von Services dieses Typs (dazu gleich mehr).</p></li>
<li><p><code>check_funktion</code>: Die Funktion zum Durchführen des eigentlichen Checks (auch dazu gleich mehr).</p></li>
</ol></div>
<div class="paragraph"><p>Für unseren Check sieht das dann also so aus:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-n">register</span><span class="tok-o">.</span><span class="tok-n">check_plugin</span><span class="tok-p">(</span>
    <span class="tok-n">name</span><span class="tok-o">=</span><span class="tok-s2">"linux_usbstick"</span><span class="tok-p">,</span>
    <span class="tok-n">service_name</span><span class="tok-o">=</span><span class="tok-s2">"USB stick"</span><span class="tok-p">,</span>
    <span class="tok-n">discovery_function</span><span class="tok-o">=</span><span class="tok-n">discover_linux_usbstick</span><span class="tok-p">,</span>
    <span class="tok-n">check_function</span><span class="tok-o">=</span><span class="tok-n">check_linux_usbstick</span><span class="tok-p">,</span>
<span class="tok-p">)</span></code></pre></div></div>
<div class="paragraph"><p>Versuchen Sie am besten noch nicht, das gleich auszuprobieren, denn natürlich
müssen wir die Funktionen <code>discover_linux_usbstick</code> und <code>check_linux_usbstick</code>
vorher noch schreiben. Und diese müssen im Quellcode <em>vor</em> obiger Deklaration
erscheinen.</p></div>
</div>
<div class="sect2">
<h3 id="heading__die_discovery_funktion_schreiben">
<span class="hidden-anchor sr-only" id="_die_discovery_funktion_schreiben"></span>2.7. Die Discovery-Funktion schreiben</h3>
<div class="paragraph"><p>Eine Besonderheit von Checkmk ist die automatische Erkennung von zu
überwachenden Services. Damit dies klappt, muss jedes Checkplugin eine
Funktion definieren, welche anhand der Agentenausgaben erkennt, <em>ob</em> ein Service
dieses Typs bzw. <em>welche</em> Services des Typs für den betreffenden Host
angelegt werden sollen.</p></div>
<div class="paragraph"><p>Die Discovery-Funktion wird immer dann aufgerufen, wenn für einen Host
die Serviceerkennung durchgeführt wird. Sie entscheidet dann ob, bzw.
welche Services angelegt werden sollen. In Standardfall bekommt sie genau
ein Argument mit dem Namen <code>section</code>. Dieses enthält die Daten
der Agentensektion in einem geparsten Format (dazu später mehr).</p></div>
<div class="paragraph"><p>Wir implementieren folgende simple Logik: <em>Wenn</em> die Agentensektion
<code>linux_usbstick</code> vorhanden ist, dann legen wir auch einen passenden
Service an. Dann erscheint dieser automatisch auf allen Hosts, wo unser
Agentenplugin ausgerollt ist. Das Vorhandensein der Sektion erkennen wir
ganz einfach daran, dass unsere Discovery überhaupt aufgerufen wird!</p></div>
<div class="paragraph"><p>Die Discovery-Funktion muss für jeden anzulegenden Service mittels
<code>yield</code> ein Objekt vom Typ <code>Service</code> zurückgeben (nicht mit
<code>return</code>). Bei Checks, die pro Host nur einmal auftreten können,
benötigt man keine weitere Angaben:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">def</span> <span class="tok-nf">discover_linux_usbstick</span><span class="tok-p">(</span><span class="tok-n">section</span><span class="tok-p">):</span>
    <span class="tok-k">yield</span> <span class="tok-n">Service</span><span class="tok-p">()</span></code></pre></div></div>
</div>
<div class="sect2">
<h3 id="heading__die_check_funktion_schreiben">
<span class="hidden-anchor sr-only" id="_die_check_funktion_schreiben"></span>2.8. Die Check-Funktion schreiben</h3>
<div class="paragraph"><p>Somit können wir nun zur eigentlichen Check-Funktion kommen, welche anhand
aktueller Agentenausgaben endlich entscheidet, welchen Zustand ein Service
annehmen soll. Da unser Check keine Parameter hat und es auch immer nur
einen pro Host gibt, wird unsere Funktion ebenfalls mit dem einzigen
Argument <code>section</code> aufgerufen.</p></div>
<div class="paragraph"><p>Da wir diesmal den Inhalt auch wirklich brauchen, müssen wir uns
mit dem Format dieses Arguments befassen. Solange Sie keine explizite
<a href="#parsefunction">Parsefunktion</a> definiert haben, zerlegt
Checkmk jede Zeile der Sektion anhand von Leerzeichen in eine <em>Liste von
Worten</em>. Das Ganze wird dann wiederum eine Liste dieser Wortlisten. Als
Endergebnis haben wir also immer eine Liste von Listen.</p></div>
<div class="paragraph"><p>Im einfachen Fall, in dem unser Agentenplugin nur zwei Devices findet,
sieht das dann z.B. so aus (hier gibt es pro Zeile nur ein Wort):</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-p">[[</span><span class="tok-s1">'ata-APPLE_SSD_SM0512F_S1K5NYBF810191'</span><span class="tok-p">],</span> <span class="tok-p">[</span><span class="tok-s1">'wwn-0x5002538655584d30'</span><span class="tok-p">]]</span></code></pre></div></div>
<div class="paragraph"><p>Die Check-Funktion geht nun Zeile für Zeile durch und sucht nach
einer Zeile, deren erstes (und einziges) Wort mit <code>usb-SCSI_DISK</code> beginnt.
Wenn das der Fall ist, wird der Zustand <span class="state2">CRIT</span>.
Hier ist die Implementierung:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">def</span> <span class="tok-nf">check_linux_usbstick</span><span class="tok-p">(</span><span class="tok-n">section</span><span class="tok-p">):</span>
    <span class="tok-k">for</span> <span class="tok-n">line</span> <span class="tok-ow">in</span> <span class="tok-n">section</span><span class="tok-p">:</span>
        <span class="tok-k">if</span> <span class="tok-n">line</span><span class="tok-p">[</span><span class="tok-mi">0</span><span class="tok-p">]</span><span class="tok-o">.</span><span class="tok-n">startswith</span><span class="tok-p">(</span><span class="tok-s2">"usb-SCSI_DISK"</span><span class="tok-p">):</span>
            <span class="tok-k">yield</span> <span class="tok-n">Result</span><span class="tok-p">(</span><span class="tok-n">state</span><span class="tok-o">=</span><span class="tok-n">State</span><span class="tok-o">.</span><span class="tok-n">CRIT</span><span class="tok-p">,</span> <span class="tok-n">summary</span><span class="tok-o">=</span><span class="tok-s2">"Found USB stick"</span><span class="tok-p">)</span>
            <span class="tok-k">return</span>
    <span class="tok-k">yield</span> <span class="tok-n">Result</span><span class="tok-p">(</span><span class="tok-n">state</span><span class="tok-o">=</span><span class="tok-n">State</span><span class="tok-o">.</span><span class="tok-n">OK</span><span class="tok-p">,</span> <span class="tok-n">summary</span><span class="tok-o">=</span><span class="tok-s2">"No USB stick found"</span><span class="tok-p">)</span></code></pre></div></div>
<div class="paragraph"><p>Und hier die Erklärung:</p></div>
<div class="olist arabic"><ol class="arabic">
<li><p>Mit <code>for line in section</code> gehen wir in einer Schleife alle Zeilen der Agentenausgabe durch.</p></li>
<li><p>Dann prüfen wir, ob das erste Wort der Zeile — das jeweilige Gerät — mit <code>usb-SCSI_DISK</code> beginnt.</p></li>
<li><p>Falls ja, erzeugen wir ein Check-Resultat mit dem Status <span class="state2">CRIT</span> und dem Text <code>Found USB stick</code>. Und wir beenden dann die Funktion mit einem <code>return</code>.</p></li>
<li><p>Falls die Schleife durchlaufen wird, ohne etwas zu finden, erzeugen wir den Status <span class="state0">OK</span> und den Text <code>No USB stick found</code>.</p></li>
</ol></div>
</div>
<div class="sect2">
<h3 id="heading__das_ganze_plugin_auf_einen_blick">
<span class="hidden-anchor sr-only" id="_das_ganze_plugin_auf_einen_blick"></span>2.9. Das ganze Plugin auf einen Blick</h3>
<div class="paragraph"><p>Und hier ist das ganze Plugin nochmal komplett:</p></div>
<div class="listingblock">
<div class="title">local/lib/check_mk/base/plugins/agent_based/linux_usbstick.py</div>
<div class="content"><pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-kn">from</span> <span class="tok-nn">.agent_based_api.v1</span> <span class="tok-kn">import</span> <span class="tok-o">*</span>

<span class="tok-k">def</span> <span class="tok-nf">discover_linux_usbstick</span><span class="tok-p">(</span><span class="tok-n">section</span><span class="tok-p">):</span>
    <span class="tok-k">yield</span> <span class="tok-n">Service</span><span class="tok-p">()</span>

<span class="tok-k">def</span> <span class="tok-nf">check_linux_usbstick</span><span class="tok-p">(</span><span class="tok-n">section</span><span class="tok-p">):</span>
    <span class="tok-k">for</span> <span class="tok-n">line</span> <span class="tok-ow">in</span> <span class="tok-n">section</span><span class="tok-p">:</span>
        <span class="tok-k">if</span> <span class="tok-n">line</span><span class="tok-p">[</span><span class="tok-mi">0</span><span class="tok-p">]</span><span class="tok-o">.</span><span class="tok-n">startswith</span><span class="tok-p">(</span><span class="tok-s2">"usb-SCSI_DISK"</span><span class="tok-p">):</span>
            <span class="tok-k">yield</span> <span class="tok-n">Result</span><span class="tok-p">(</span><span class="tok-n">state</span><span class="tok-o">=</span><span class="tok-n">State</span><span class="tok-o">.</span><span class="tok-n">CRIT</span><span class="tok-p">,</span> <span class="tok-n">summary</span><span class="tok-o">=</span><span class="tok-s2">"Found USB stick"</span><span class="tok-p">)</span>
            <span class="tok-k">return</span>
    <span class="tok-k">yield</span> <span class="tok-n">Result</span><span class="tok-p">(</span><span class="tok-n">state</span><span class="tok-o">=</span><span class="tok-n">State</span><span class="tok-o">.</span><span class="tok-n">OK</span><span class="tok-p">,</span> <span class="tok-n">summary</span><span class="tok-o">=</span><span class="tok-s2">"No USB stick found"</span><span class="tok-p">)</span>

<span class="tok-n">register</span><span class="tok-o">.</span><span class="tok-n">check_plugin</span><span class="tok-p">(</span>
    <span class="tok-n">name</span> <span class="tok-o">=</span> <span class="tok-s2">"linux_usbstick"</span><span class="tok-p">,</span>
    <span class="tok-n">service_name</span> <span class="tok-o">=</span> <span class="tok-s2">"USB stick"</span><span class="tok-p">,</span>
    <span class="tok-n">discovery_function</span> <span class="tok-o">=</span> <span class="tok-n">discover_linux_usbstick</span><span class="tok-p">,</span>
    <span class="tok-n">check_function</span> <span class="tok-o">=</span> <span class="tok-n">check_linux_usbstick</span><span class="tok-p">,</span>
<span class="tok-p">)</span></code></pre></div>
</div>
<div class="paragraph"><p>Und das hier war das Plugin für den Linux-Agenten:</p></div>
<div class="listingblock">
<div class="title">/usr/lib/check_mk_agent/plugins/linux_usbstick</div>
<div class="content"><pre class="pygments highlight"><code><span></span>#!/bin/sh
echo '&lt;&lt;&lt;linux_usbstick&gt;&gt;&gt;'
ls /dev/disk/by-id/ | grep -v -- -part</code></pre></div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="heading__checks_mit_mehr_als_einem_service_pro_host_items">
<span class="hidden-anchor sr-only" id="_checks_mit_mehr_als_einem_service_pro_host_items"></span>3. Checks mit mehr als einem Service pro Host (Items)</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="heading__grundprinzip">
<span class="hidden-anchor sr-only" id="_grundprinzip"></span>3.1. Grundprinzip</h3>
<div class="paragraph"><p>In unserem Beispiel haben wir einen sehr einfachen Check gebaut, der auf
einem Host einen Service erzeugt — oder eben nicht. Ein sehr üblicher Fall
ist aber natürlich auch, dass es von einem Check mehrere Services auf einem
Host geben kann.</p></div>
<div class="paragraph"><p>Das häufigste Beispiel dafür sind die Dateisysteme eines Hosts. Das Plugin
mit dem Namen <code>df</code> legt pro Dateisystem auf dem Host einen Service
an. Um diese Services zu unterscheiden, wird der Mountpunkt des Dateisystems
(z.B. <code>/var</code>) bzw. der Laufwerksbuchstabe (z.B. <code>C:</code>)
in den Namen des Services eingebaut.  Das ergibt dann als Servicename
z.B. <code>Filesystem /var</code> oder <code>Filesystem C:</code>. Das Wort
<code>/var</code> bzw. <code>C:</code> wird hier als <em>Item</em> bezeichnet. Wir
sprechen also auch von einem Check <em>mit Items</em>.</p></div>
<div class="paragraph"><p>Wenn Sie einen Check mit Items bauen möchten, müssen Sie folgende
Dinge umsetzen:</p></div>
<div class="ulist"><ul>
<li><p>Die Discovery-Funktion muss jedes der Items, die auf dem Host sinnvollerweise überwacht werden sollen, einen Service generieren.</p></li>
<li><p>Im Servicenamen müssen Sie das Item mithilfe des Platzhalters <code>%s</code> einbauen (also z.B. <code>"Filesystem %s"</code>).</p></li>
<li><p>Die Check-Funktion wird pro Item einmal separat aufgerufen und bekommt dieses als Argument. Sie muss dann aus den Agentendaten die für dieses Item relevanten Daten herausfischen.</p></li>
</ul></div>
</div>
<div class="sect2">
<h3 id="heading__ein_einfaches_beispiel">
<span class="hidden-anchor sr-only" id="_ein_einfaches_beispiel"></span>3.2. Ein einfaches Beispiel</h3>
<div class="paragraph"><p>Um das ganze praktisch ausprobieren zu können, bauen wir uns einfach
eine weitere Agentensektion, die nur Spieldaten ausgibt. Dazu genügt ein
kleines Shell-Skript. Die Sektion soll hier im Beispiel <code>foobar</code> heißen:</p></div>
<div class="listingblock">
<div class="title">/usr/lib/check_mk_agent/plugins/foobar</div>
<div class="content"><pre class="pygments highlight"><code><span></span>#!/bin/sh
echo "&lt;&lt;&lt;foobar&gt;&gt;&gt;"
echo "West 100 100"
echo "East 197 200"
echo "North 0 50"</code></pre></div>
</div>
<div class="paragraph"><p>Von <em>foobar</em> gibt es hier drei Sektoren: <code>West</code>, <code>East</code>
und <code>North</code> (was immer auch das bedeuten mag). In jedem Sektor gibt
es eine Anzahl von <em>Plätzen</em> von denen einige belegt sind (z.B. sind
in <code>West</code> 100 von 100 Plätzen belegt).</p></div>
<div class="paragraph"><p>Nun legen wir dazu ein passendes Checkplugin an. Die Registrierung ist wie
gehabt, allerdings mit dem wichtigen Unterschied, dass der Servicename jetzt
genau einmal ein <code>%s</code> enthält. An dieser Stelle wird später dann von
Checkmk der Name des Items eingesetzt:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-n">register</span><span class="tok-o">.</span><span class="tok-n">check_plugin</span><span class="tok-p">(</span>
    <span class="tok-n">name</span> <span class="tok-o">=</span> <span class="tok-s2">"foobar"</span><span class="tok-p">,</span>
    <span class="tok-n">service_name</span> <span class="tok-o">=</span> <span class="tok-s2">"Foobar Sector </span><span class="tok-si">%s</span><span class="tok-s2">"</span><span class="tok-p">,</span>
    <span class="tok-n">discovery_function</span> <span class="tok-o">=</span> <span class="tok-n">discover_foobar</span><span class="tok-p">,</span>
    <span class="tok-n">check_function</span> <span class="tok-o">=</span> <span class="tok-n">check_foobar</span><span class="tok-p">,</span>
<span class="tok-p">)</span></code></pre></div></div>
<div class="paragraph"><p>Die Discovery-Funktion hat jetzt die Aufgabe, die zu überwachenden Items zu
ermitteln. Wie gehabt bekommt sie das Argument <code>section</code>.  Und auch hier
handelt es sich um eine Liste von Zeilen, welche ihrerseits wiederum Listen
von Worten sind. Diese sieht in unserem Beispiel aus aus:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-p">[[</span><span class="tok-s1">'West'</span><span class="tok-p">,</span> <span class="tok-s1">'100'</span><span class="tok-p">,</span> <span class="tok-s1">'100'</span><span class="tok-p">],</span> <span class="tok-p">[</span><span class="tok-s1">'East'</span><span class="tok-p">,</span> <span class="tok-s1">'197'</span><span class="tok-p">,</span> <span class="tok-s1">'200'</span><span class="tok-p">],</span> <span class="tok-p">[</span><span class="tok-s1">'North'</span><span class="tok-p">,</span> <span class="tok-s1">'0'</span><span class="tok-p">,</span> <span class="tok-s1">'50'</span><span class="tok-p">]]</span></code></pre></div></div>
<div class="paragraph"><p>So eine Liste kann man mit Python prima in einer Schleife
durchlaufen und den drei Worten pro Zeile gleich sinnvolle Namen geben:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">for</span> <span class="tok-n">sector</span><span class="tok-p">,</span> <span class="tok-n">_used</span><span class="tok-p">,</span> <span class="tok-n">_slots</span> <span class="tok-ow">in</span> <span class="tok-n">section</span><span class="tok-p">:</span>
    <span class="tok-o">...</span></code></pre></div></div>
<div class="paragraph"><p>In jeder Zeile ist das erste Wort — hier der Sektor — unser Item.  Immer wenn
wir ein Item gefunden haben, geben wir das mit <code>yield</code> zurück, wobei
wir ein Objekt vom Typ <code>Service</code> erzeugen, welches den Sektornamen als
Item bekommt. Der Unterstrich zeigt an, dass uns die beiden andere Spalten
in der Ausgabe erst einmal egal sind, denn bei der Discovery ist es schließlich
unerheblich, wie viele Slots belegt sind. Insgesamt sieht das dann so aus:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">def</span> <span class="tok-nf">discover_foobar</span><span class="tok-p">(</span><span class="tok-n">section</span><span class="tok-p">):</span>
    <span class="tok-k">for</span> <span class="tok-n">sector</span><span class="tok-p">,</span> <span class="tok-n">_used</span><span class="tok-p">,</span> <span class="tok-n">_slots</span> <span class="tok-ow">in</span> <span class="tok-n">section</span><span class="tok-p">:</span>
        <span class="tok-k">yield</span> <span class="tok-n">Service</span><span class="tok-p">(</span><span class="tok-n">item</span><span class="tok-o">=</span><span class="tok-n">sector</span><span class="tok-p">)</span></code></pre></div></div>
<div class="paragraph"><p>Es wäre natürlich ein Leichtes, hier anhand von beliebigen Kriterien manche
Zeilen auszulassen. Vielleicht gibt es ja Sektoren, welche die Größe 0 haben
und die man grundsätzlich nie überwachen möchte? Lassen Sie solche Zeilen
einfach aus und „yielden“” Sie dafür kein Item.</p></div>
<div class="paragraph"><p>Wenn dann später der Host überwacht wird, dann wird die Check-Funktion
für jeden Service — und damit für jedes Item — separat aufgerufen. Sie
bekommt deswegen zusätzlich zur Sektion das Argument <code>item</code> mit dem
jeweils gesuchten Item. Jetzt gehen wir wieder alle Zeilen der Reihe nach
durch. Dabei suchen wir diejenige Zeile heraus, die zum gewünschten Item gehört:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">def</span> <span class="tok-nf">check_foobar</span><span class="tok-p">(</span><span class="tok-n">item</span><span class="tok-p">,</span> <span class="tok-n">section</span><span class="tok-p">):</span>
    <span class="tok-k">for</span> <span class="tok-n">sector</span><span class="tok-p">,</span> <span class="tok-n">used</span><span class="tok-p">,</span> <span class="tok-n">slots</span> <span class="tok-ow">in</span> <span class="tok-n">section</span><span class="tok-p">:</span>
        <span class="tok-k">if</span> <span class="tok-n">sector</span> <span class="tok-o">==</span> <span class="tok-n">item</span><span class="tok-p">:</span>
            <span class="tok-o">...</span></code></pre></div></div>
<div class="paragraph"><p>Jetzt fehlt nur noch die eigentliche Logik, welche festlegt, wann das Ding denn überhaupt <span class="state0">OK</span>,
<span class="state1">WARN</span> oder <span class="state2">CRIT</span> sein soll. Wir machen es hier so:</p></div>
<div class="ulist"><ul>
<li><p>Wenn alle Slots belegt sind, soll das Ding <span class="state2">CRIT</span> werden.</p></li>
<li><p>Wenn weniger als 10 Slots frei sind, dann wird es <span class="state1">WARN</span>.</p></li>
<li><p>Ansonsten <span class="state0">OK</span></p></li>
</ul></div>
<div class="paragraph"><p>Die belegten und die verfügbaren Slots kommen ja immer als Wort zwei und drei
in jeder Zeile vor. Aber: es handelt sich hier um Strings, nicht um Zahlen.
Diese brauchen wir aber, um vergleichen und rechnen zu können. Daher
wandeln wir die Strings mit <code>int()</code> in Zahlen um.</p></div>
<div class="paragraph"><p>Das Checkergebnis liefern wir dann, indem wir ein Objekt vom Typ <code>Result</code>
per <code>yield</code> liefern. Dieses benötigt die Parameter <code>state</code> und
<code>summary</code>:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">def</span> <span class="tok-nf">check_foobar</span><span class="tok-p">(</span><span class="tok-n">item</span><span class="tok-p">,</span> <span class="tok-n">section</span><span class="tok-p">):</span>
    <span class="tok-k">for</span> <span class="tok-n">sector</span><span class="tok-p">,</span> <span class="tok-n">used</span><span class="tok-p">,</span> <span class="tok-n">slots</span> <span class="tok-ow">in</span> <span class="tok-n">section</span><span class="tok-p">:</span>
        <span class="tok-k">if</span> <span class="tok-n">sector</span> <span class="tok-o">==</span> <span class="tok-n">item</span><span class="tok-p">:</span>
            <span class="tok-n">used</span> <span class="tok-o">=</span> <span class="tok-nb">int</span><span class="tok-p">(</span><span class="tok-n">used</span><span class="tok-p">)</span>   <span class="tok-c1"># convert string to int</span>
            <span class="tok-n">slots</span> <span class="tok-o">=</span> <span class="tok-nb">int</span><span class="tok-p">(</span><span class="tok-n">slots</span><span class="tok-p">)</span>   <span class="tok-c1"># convert string to int</span>
            <span class="tok-k">if</span> <span class="tok-n">used</span> <span class="tok-o">==</span> <span class="tok-n">slots</span><span class="tok-p">:</span>
                <span class="tok-n">s</span> <span class="tok-o">=</span> <span class="tok-n">State</span><span class="tok-o">.</span><span class="tok-n">CRIT</span>
            <span class="tok-k">elif</span> <span class="tok-n">slots</span> <span class="tok-o">-</span> <span class="tok-n">used</span> <span class="tok-o">&lt;=</span> <span class="tok-mi">10</span><span class="tok-p">:</span>
                <span class="tok-n">s</span> <span class="tok-o">=</span> <span class="tok-n">State</span><span class="tok-o">.</span><span class="tok-n">WARN</span>
            <span class="tok-k">else</span><span class="tok-p">:</span>
                <span class="tok-n">s</span> <span class="tok-o">=</span> <span class="tok-n">State</span><span class="tok-o">.</span><span class="tok-n">OK</span>
            <span class="tok-k">yield</span> <span class="tok-n">Result</span><span class="tok-p">(</span>
                <span class="tok-n">state</span> <span class="tok-o">=</span> <span class="tok-n">s</span><span class="tok-p">,</span>
                <span class="tok-n">summary</span> <span class="tok-o">=</span> <span class="tok-sa">f</span><span class="tok-s2">"Used </span><span class="tok-si">{</span><span class="tok-n">used</span><span class="tok-si">}</span><span class="tok-s2"> out of </span><span class="tok-si">{</span><span class="tok-n">slots</span><span class="tok-si">}</span><span class="tok-s2"> slots"</span><span class="tok-p">)</span>
            <span class="tok-k">return</span></code></pre></div></div>
<div class="paragraph"><p>Dazu noch folgende Hinweise:</p></div>
<div class="olist arabic"><ol class="arabic">
<li><p>Der Befehl <code>return</code> sorgt dafür, dass die Check-Funktion nach dem Bearbeiten des gefundenen Items sofort abgebrochen wird. Es gibt schließlich auch nichts mehr weiter zu tun.</p></li>
<li><p>Wird die Schleife durchlaufen, ohne das gesuchte Item zu finden, so erzeugt Checkmk <em>automatisch</em> das Resultat <code>UNKNOWN - Item not found in monitoring data</code>. Das ist so gewollt und gut so. Behandeln Sie diesen Fall nicht selbst. Wenn sie ein gesuchtes Item nicht finden, so lassen sie Python einfach aus der Funktion rauslaufen und Checkmk seine Arbeit erledigen.</p></li>
<li><p>Mit dem Argument <code>summary</code> definieren Sie den Text, den der Service als Statusausgabe produziert. Er ist rein informell und wird von Checkmk nicht weiter ausgewertet.</p></li>
</ol></div>
<div class="paragraph"><p>Übrigens gibt es für den häufigen Fall, dass Sie eine einfache Metrik auf Schwellwerte prüfen wollen, die Hilfsfunktion <code>check_levels</code>.
Diese Hilfsfunktion wird in der Check-API-Dokumentation erläutert, die Sie in Checkmk über <span class="guihint">Help &gt; Plugin API reference &gt; Agent based API (“Check API”)</span> aufrufen können.</p></div>
<div class="paragraph"><p>Probieren wir jetzt zunächst die Discovery aus. Der Übersicht halber beschränken wir das
ganze mit der Option <code>--detect-plugins=foobar</code> auf unser Plugin:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="console"><span></span><span class="tok-gp">OMD[mysite]:~$ </span>cmk<span class="tok-w"> </span>--detect-plugins<span class="tok-o">=</span>foobar<span class="tok-w"> </span>-vI<span class="tok-w"> </span>myhost123
<span class="tok-go">  <span class="green">3</span> foobar</span>
<span class="tok-go">SUCCESS - Found 3 services, 1 host labels</span></code></pre></div></div>
<div class="paragraph"><p>Und jetzt können wir auch gleich das Checken ausprobieren (ebenfalls auf
<code>foobar</code> begrenzt):</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="console"><span></span><span class="tok-gp">OMD[mysite]:~$ </span>cmk<span class="tok-w"> </span>--detect-plugins<span class="tok-o">=</span>foobar<span class="tok-w"> </span>-v<span class="tok-w"> </span>myhost123
<span class="tok-go">Foobar Sector East   <span class="yellow">WARN - used 197 out of 200 slots</span></span>
<span class="tok-go">Foobar Sector North  <span class="green">OK - used 0 out of 50 slots</span></span>
<span class="tok-go">Foobar Sector West   <span class="red">CRIT - used 100 out of 100 slots</span></span></code></pre></div></div>
</div>
<div class="sect2">
<h3 id="heading__beispiel_komplett">
<span class="hidden-anchor sr-only" id="_beispiel_komplett"></span>3.3. Beispiel komplett</h3>
<div class="paragraph"><p>Und hier nochmal das ganze Beispiel komplett. Damit es keine Fehler wegen nicht definierter Funktionsnamen gibt,
müssen die Funktionen immer vor dem Registrieren definiert werden.</p></div>
<div class="listingblock">
<div class="title">local/lib/check_mk/base/plugins/agent_based/foobar.py</div>
<div class="content"><pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-kn">from</span> <span class="tok-nn">.agent_based_api.v1</span> <span class="tok-kn">import</span> <span class="tok-o">*</span>
<span class="tok-kn">import</span> <span class="tok-nn">pprint</span>


<span class="tok-k">def</span> <span class="tok-nf">discover_foobar</span><span class="tok-p">(</span><span class="tok-n">section</span><span class="tok-p">):</span>
    <span class="tok-k">for</span> <span class="tok-n">sector</span><span class="tok-p">,</span> <span class="tok-n">used</span><span class="tok-p">,</span> <span class="tok-n">slots</span> <span class="tok-ow">in</span> <span class="tok-n">section</span><span class="tok-p">:</span>
        <span class="tok-k">yield</span> <span class="tok-n">Service</span><span class="tok-p">(</span><span class="tok-n">item</span><span class="tok-o">=</span><span class="tok-n">sector</span><span class="tok-p">)</span>


<span class="tok-k">def</span> <span class="tok-nf">check_foobar</span><span class="tok-p">(</span><span class="tok-n">item</span><span class="tok-p">,</span> <span class="tok-n">section</span><span class="tok-p">):</span>
    <span class="tok-k">for</span> <span class="tok-n">sector</span><span class="tok-p">,</span> <span class="tok-n">used</span><span class="tok-p">,</span> <span class="tok-n">slots</span> <span class="tok-ow">in</span> <span class="tok-n">section</span><span class="tok-p">:</span>
        <span class="tok-k">if</span> <span class="tok-n">sector</span> <span class="tok-o">==</span> <span class="tok-n">item</span><span class="tok-p">:</span>
            <span class="tok-n">used</span> <span class="tok-o">=</span> <span class="tok-nb">int</span><span class="tok-p">(</span><span class="tok-n">used</span><span class="tok-p">)</span>    <span class="tok-c1"># convert string to int</span>
            <span class="tok-n">slots</span> <span class="tok-o">=</span> <span class="tok-nb">int</span><span class="tok-p">(</span><span class="tok-n">slots</span><span class="tok-p">)</span>  <span class="tok-c1"># convert string to int</span>
            <span class="tok-k">if</span> <span class="tok-n">used</span> <span class="tok-o">==</span> <span class="tok-n">slots</span><span class="tok-p">:</span>
                <span class="tok-n">s</span> <span class="tok-o">=</span> <span class="tok-n">State</span><span class="tok-o">.</span><span class="tok-n">CRIT</span>
            <span class="tok-k">elif</span> <span class="tok-n">slots</span> <span class="tok-o">-</span> <span class="tok-n">used</span> <span class="tok-o">&lt;=</span> <span class="tok-mi">10</span><span class="tok-p">:</span>
                <span class="tok-n">s</span> <span class="tok-o">=</span> <span class="tok-n">State</span><span class="tok-o">.</span><span class="tok-n">WARN</span>
            <span class="tok-k">else</span><span class="tok-p">:</span>
                <span class="tok-n">s</span> <span class="tok-o">=</span> <span class="tok-n">State</span><span class="tok-o">.</span><span class="tok-n">OK</span>
            <span class="tok-k">yield</span> <span class="tok-n">Result</span><span class="tok-p">(</span>
                <span class="tok-n">state</span> <span class="tok-o">=</span> <span class="tok-n">s</span><span class="tok-p">,</span>
                <span class="tok-n">summary</span> <span class="tok-o">=</span> <span class="tok-sa">f</span><span class="tok-s2">"used </span><span class="tok-si">{</span><span class="tok-n">used</span><span class="tok-si">}</span><span class="tok-s2"> out of </span><span class="tok-si">{</span><span class="tok-n">slots</span><span class="tok-si">}</span><span class="tok-s2"> slots"</span><span class="tok-p">)</span>
            <span class="tok-k">return</span>


<span class="tok-n">register</span><span class="tok-o">.</span><span class="tok-n">check_plugin</span><span class="tok-p">(</span>
    <span class="tok-n">name</span> <span class="tok-o">=</span> <span class="tok-s2">"foobar"</span><span class="tok-p">,</span>
    <span class="tok-n">service_name</span> <span class="tok-o">=</span> <span class="tok-s2">"Foobar Sector </span><span class="tok-si">%s</span><span class="tok-s2">"</span><span class="tok-p">,</span>
    <span class="tok-n">discovery_function</span> <span class="tok-o">=</span> <span class="tok-n">discover_foobar</span><span class="tok-p">,</span>
    <span class="tok-n">check_function</span> <span class="tok-o">=</span> <span class="tok-n">check_foobar</span><span class="tok-p">,</span>
<span class="tok-p">)</span></code></pre></div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="heading__messwerte">
<span class="hidden-anchor sr-only" id="_messwerte"></span>4. Messwerte</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="heading__werte_in_der_check_funktion_ermitteln">
<span class="hidden-anchor sr-only" id="_werte_in_der_check_funktion_ermitteln"></span>4.1. Werte in der Check-Funktion ermitteln</h3>
<div class="paragraph"><p>Nicht immer, aber oft befassen sich Checks mit Zahlen. Mit seinem <a href="graphing.html">Graphingsystem</a>
hat Checkmk eine Komponente, um solche Zahlen zu speichern, auszuwerten und darzustellen. Das
geht dabei völlig unabhängig von der Berechnung der Zuständige <span class="state0">OK</span>, <span class="state1">WARN</span> und <span class="state2">CRIT</span>.</p></div>
<div class="paragraph"><p>Solche Messwerte — oder auch Metriken genannt — werden von der Check-Funktion ermittelt
und einfach als zusätzliches Ergebnis zurückgegeben. Dazu dient das Objekt <code>Metric</code>,
welches mindestens die beiden Argumente <code>name</code> und <code>value</code> benötigt.
Hier ist ein Beispiel:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="python"><span></span>    <span class="tok-k">yield</span> <span class="tok-n">Metric</span><span class="tok-p">(</span><span class="tok-s2">"fooslots"</span><span class="tok-p">,</span> <span class="tok-n">used</span><span class="tok-p">)</span></code></pre></div></div>
</div>
<div class="sect2">
<h3 id="heading_thresholdinformation">
<span class="hidden-anchor sr-only" id="thresholdinformation"></span>4.2. Informationen zu den Schwellwerten</h3>
<div class="paragraph"><p>Weiterhin gibt es noch zwei optionale Argumente. Mit dem Argument <code>levels</code> können Sie eine Information
zu Schwellwerten für <span class="state1">WARN</span> und <span class="state2">CRIT</span> mitgeben, und zwar in Form eines Paares von zwei Zahlen.
Diese wird dann üblicherweise im Graphen als gelbe und rote Linie eingezeichnet. Die erste Zahl
steht für die Warnschwelle, die zweite für die kritische.
Dabei gilt die Konvention, dass der Check beim Erreichen der Warnschwelle
bereits auf <span class="state1">WARN</span> geht (bei <span class="state2">CRIT</span> analog).</p></div>
<div class="paragraph"><p>Das sieht dann z.B. so aus (hier mit hartkodierten Schwellwerten):</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="python"><span></span>    <span class="tok-k">yield</span> <span class="tok-n">Metric</span><span class="tok-p">(</span><span class="tok-s2">"fooslots"</span><span class="tok-p">,</span> <span class="tok-n">used</span><span class="tok-p">,</span> <span class="tok-n">levels</span><span class="tok-o">=</span><span class="tok-p">(</span><span class="tok-mi">190</span><span class="tok-p">,</span><span class="tok-mi">200</span><span class="tok-p">))</span></code></pre></div></div>
<div class="paragraph"><p>Hinweise:</p></div>
<div class="ulist"><ul>
<li><p>Falls nur eine der beiden Schwellen definiert ist, tragen Sie für die andere einfach <code>None</code> ein, also z.B. <code>levels=(None, 200)</code>.</p></li>
<li><p>Es sind auch Fließkommazahlen erlaubt, aber keine Strings.</p></li>
<li><p>Achtung: für die <em>Überprüfung</em> der Schwellwerte ist die Check-Funktion selbst verantwortlich.  Die Angabe von <code>levels</code> dient lediglich als Randinformation für das Graphingsystem!</p></li>
</ul></div>
</div>
<div class="sect2">
<h3 id="heading__der_wertebereich">
<span class="hidden-anchor sr-only" id="_der_wertebereich"></span>4.3. Der Wertebereich</h3>
<div class="paragraph"><p>Analog zu den Schwellwerten können Sie dem Graphingsystem auch die Information über
den möglichen Wertebereich mitgeben. Damit ist der kleinste und größte mögliche Wert
gemeint. Das geschieht im Argument <code>boundaries</code>, wobei auch hier optional
für eine der beiden Grenzen <code>None</code> eingesetzt werden kann. Beispiel:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="python"><span></span>    <span class="tok-k">yield</span> <span class="tok-n">Metric</span><span class="tok-p">(</span><span class="tok-n">name</span><span class="tok-o">=</span><span class="tok-s2">"fooslots"</span><span class="tok-p">,</span> <span class="tok-n">value</span><span class="tok-o">=</span><span class="tok-n">used</span><span class="tok-p">,</span> <span class="tok-n">boundaries</span><span class="tok-o">=</span><span class="tok-p">(</span><span class="tok-mi">0</span><span class="tok-p">,</span> <span class="tok-mi">200</span><span class="tok-p">))</span></code></pre></div></div>
<div class="paragraph"><p>Und jetzt unsere Check-Funktion aus dem obigen Beispiel nochmal, aber
diesmal mit der Rückgabe von Metrikinformation inklusive Schwellwerte und
Wertebereich (diesmal natürlich nicht mit fixen sondern mit berechneten Werten):</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">def</span> <span class="tok-nf">check_foobar</span><span class="tok-p">(</span><span class="tok-n">item</span><span class="tok-p">,</span> <span class="tok-n">section</span><span class="tok-p">):</span>
    <span class="tok-k">for</span> <span class="tok-n">sector</span><span class="tok-p">,</span> <span class="tok-n">used</span><span class="tok-p">,</span> <span class="tok-n">slots</span> <span class="tok-ow">in</span> <span class="tok-n">section</span><span class="tok-p">:</span>
        <span class="tok-k">if</span> <span class="tok-n">sector</span> <span class="tok-o">==</span> <span class="tok-n">item</span><span class="tok-p">:</span>
            <span class="tok-n">used</span> <span class="tok-o">=</span> <span class="tok-nb">int</span><span class="tok-p">(</span><span class="tok-n">used</span><span class="tok-p">)</span>    <span class="tok-c1"># convert string to int</span>
            <span class="tok-n">slots</span> <span class="tok-o">=</span> <span class="tok-nb">int</span><span class="tok-p">(</span><span class="tok-n">slots</span><span class="tok-p">)</span>  <span class="tok-c1"># convert string to int</span>

            <span class="tok-k">yield</span> <span class="tok-n">Metric</span><span class="tok-p">(</span>
                <span class="tok-s2">"fooslots"</span><span class="tok-p">,</span>
                <span class="tok-n">used</span><span class="tok-p">,</span>
                <span class="tok-n">levels</span><span class="tok-o">=</span><span class="tok-p">(</span><span class="tok-n">slots</span><span class="tok-o">-</span><span class="tok-mi">10</span><span class="tok-p">,</span> <span class="tok-n">slots</span><span class="tok-p">),</span>
                <span class="tok-n">boundaries</span><span class="tok-o">=</span><span class="tok-p">(</span><span class="tok-mi">0</span><span class="tok-p">,</span> <span class="tok-n">slots</span><span class="tok-p">))</span>

            <span class="tok-k">if</span> <span class="tok-n">used</span> <span class="tok-o">==</span> <span class="tok-n">slots</span><span class="tok-p">:</span>
                <span class="tok-n">s</span> <span class="tok-o">=</span> <span class="tok-n">State</span><span class="tok-o">.</span><span class="tok-n">CRIT</span>
            <span class="tok-k">elif</span> <span class="tok-n">slots</span> <span class="tok-o">-</span> <span class="tok-n">used</span> <span class="tok-o">&lt;=</span> <span class="tok-mi">10</span><span class="tok-p">:</span>
                <span class="tok-n">s</span> <span class="tok-o">=</span> <span class="tok-n">State</span><span class="tok-o">.</span><span class="tok-n">WARN</span>
            <span class="tok-k">else</span><span class="tok-p">:</span>
                <span class="tok-n">s</span> <span class="tok-o">=</span> <span class="tok-n">State</span><span class="tok-o">.</span><span class="tok-n">OK</span>
            <span class="tok-k">yield</span> <span class="tok-n">Result</span><span class="tok-p">(</span>
                <span class="tok-n">state</span> <span class="tok-o">=</span> <span class="tok-n">s</span><span class="tok-p">,</span>
                <span class="tok-n">summary</span> <span class="tok-o">=</span> <span class="tok-sa">f</span><span class="tok-s2">"used </span><span class="tok-si">{</span><span class="tok-n">used</span><span class="tok-si">}</span><span class="tok-s2"> out of </span><span class="tok-si">{</span><span class="tok-n">slots</span><span class="tok-si">}</span><span class="tok-s2"> slots"</span><span class="tok-p">)</span>
            <span class="tok-k">return</span></code></pre></div></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="heading__checks_mit_mehreren_teilresultaten">
<span class="hidden-anchor sr-only" id="_checks_mit_mehreren_teilresultaten"></span>5. Checks mit mehreren Teilresultaten</h2>
<div class="sectionbody">
<div class="paragraph"><p>Um die Anzahl der Services auf einem Host nicht ins Unermessliche steigen zu
lassen, sind in einem Service oft mehrere Teilresultate zusammengefasst. So
prüft z.B. der Service <span class="guihint">Memory used</span> unter Linux nicht nur den RAM- und Swap-Nutzung,
sondern auch Shared memory, Page-Tabellen und alles mögliche Andere.</p></div>
<div class="paragraph"><p>Die API von Checkmk bietet dafür eine sehr komfortable Schnittstelle. So darf eine
Check-Funktion einfach beliebig oft ein Ergebnis mit <code>yield</code> erzeugen. Der
Gesamtstatus des Services richtet sich dann nach dem „schlechtesten“ Teilergebnis
nach dem Schema <span class="state0">OK</span> → <span class="state1">WARN</span> → <span class="state3">UNKNOWN</span> → <span class="state2">CRIT</span>.</p></div>
<div class="paragraph"><p>Hier ist ein gekürztes fingiertes Beispiel:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">def</span> <span class="tok-nf">check_foobar</span><span class="tok-p">(</span><span class="tok-n">section</span><span class="tok-p">):</span>
    <span class="tok-k">yield</span> <span class="tok-n">Result</span><span class="tok-p">(</span><span class="tok-n">state</span><span class="tok-o">=</span><span class="tok-n">State</span><span class="tok-o">.</span><span class="tok-n">OK</span><span class="tok-p">,</span> <span class="tok-n">summary</span><span class="tok-o">=</span><span class="tok-s2">"Knulf rate optimal"</span><span class="tok-p">)</span>
    <span class="tok-c1"># ...</span>
    <span class="tok-k">yield</span> <span class="tok-n">Result</span><span class="tok-p">(</span><span class="tok-n">state</span><span class="tok-o">=</span><span class="tok-n">State</span><span class="tok-o">.</span><span class="tok-n">WARN</span><span class="tok-p">,</span> <span class="tok-n">summary</span><span class="tok-o">=</span><span class="tok-s2">"Gnarz required"</span><span class="tok-p">)</span>
    <span class="tok-c1"># ...</span>
    <span class="tok-k">yield</span> <span class="tok-n">Result</span><span class="tok-p">(</span><span class="tok-n">state</span><span class="tok-o">=</span><span class="tok-n">State</span><span class="tok-o">.</span><span class="tok-n">OK</span><span class="tok-p">,</span> <span class="tok-n">summary</span><span class="tok-o">=</span><span class="tok-s2">"Last Szork was good"</span><span class="tok-p">)</span></code></pre></div></div>
<div class="paragraph"><p>Die Summary des Services in der GUI sieht dann so aus:
„Knulf rate optimal, Gnarz required <span class="state1">WARN</span>, Last Szork was good“.
Und der Gesamtstatus ist <span class="state1">WARN</span>.</p></div>
<div class="paragraph"><p>Auf die gleiche Art können Sie auch mehrere Metriken zurückgeben.
Rufen Sie einfach für jede Metrik einmal <code>yield Metric(…​)</code>
auf.</p></div>
</div>
</div>
<div class="sect1">
<h2 id="heading__summary_und_details">
<span class="hidden-anchor sr-only" id="_summary_und_details"></span>6. Summary und Details</h2>
<div class="sectionbody">
<div class="paragraph"><p>Im Monitoring von Checkmk hat jeder Service neben dem Status <span class="state0">OK</span>,
<span class="state1">WARN</span>, usw. auch eine Zeile Text. Diese hieß bis zur Version <span class="new">1.6.0</span>
<span class="guihint">Output of check plugin</span>. Ab <span class="new">2.0.0</span> heißt diese <span class="guihint">Summary</span> — hat also die Aufgabe einer knappen Zusammenfassung des Zustandes. Die Idee
ist, dass dieser Text eine Länge von 60 Zeichen nicht überschreitet.
Das sorgt dann immer für eine übersichtliche Tabellendarstellung ohne
störende Zeilenumbrüche.</p></div>
<div class="paragraph"><p>Daneben gibt es noch das Feld <span class="guihint">Details</span>, welches früher
<span class="guihint">Long output of check plugin (multiline)</span> hieß. Hier werden alle Details des Zustandes
angezeigt, wobei die Idee ist, dass alle Informationen des Summary hier auch
enthalten sind.</p></div>
<div class="paragraph"><p>Beim Aufruf von <code>yield Result(…​)</code> können Sie bestimmen, welche
Informationen so wichtig sind, dass sie in der Summary angezeigt werden
sollen und bei welchen es genügt, dass diese in den Details erscheinen.
Dabei gilt die Regel, dass Teilergebnisse, die zu einem <span class="state1">WARN</span>/<span class="state2">CRIT</span>
führen, <em>immer</em> in der Summary sichtbar werden.</p></div>
<div class="paragraph"><p>In unseren Beispielen bisher haben wir immer folgenden Aufruf
verwendet:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="python"><span></span>    <span class="tok-k">yield</span> <span class="tok-n">Result</span><span class="tok-p">(</span><span class="tok-n">state</span><span class="tok-o">=</span><span class="tok-n">State</span><span class="tok-o">.</span><span class="tok-n">OK</span><span class="tok-p">,</span> <span class="tok-n">summary</span><span class="tok-o">=</span><span class="tok-s2">"some important text"</span><span class="tok-p">)</span></code></pre></div></div>
<div class="paragraph"><p>Dieser führt dazu, dass <code>some important text</code> immer in der <span class="guihint">Summary</span>
erscheint — und zusätzlich auch in den <span class="guihint">Details</span>. Dies sollten sie
also nur für wichtige Informationen verwenden. Ist ein Teilergebnis eher
untergeordnet, so ersetzen Sie <code>summary</code> durch <code>notice</code> und
der Text erscheint — falls der Service <span class="state0">OK</span> ist <em>nur</em> in den Details.</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="python"><span></span>    <span class="tok-k">yield</span> <span class="tok-n">Result</span><span class="tok-p">(</span><span class="tok-n">state</span><span class="tok-o">=</span><span class="tok-n">State</span><span class="tok-o">.</span><span class="tok-n">OK</span><span class="tok-p">,</span> <span class="tok-n">notice</span><span class="tok-o">=</span><span class="tok-s2">"some additional text"</span><span class="tok-p">)</span></code></pre></div></div>
<div class="paragraph"><p>Falls der Zustand <span class="state1">WARN</span> oder <span class="state2">CRIT</span> ist, taucht der Text dann automatisch
zusätzlich in der Summary auf:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="python"><span></span>    <span class="tok-k">yield</span> <span class="tok-n">Result</span><span class="tok-p">(</span><span class="tok-n">state</span><span class="tok-o">=</span><span class="tok-n">State</span><span class="tok-o">.</span><span class="tok-n">CRIT</span><span class="tok-p">,</span> <span class="tok-n">notice</span><span class="tok-o">=</span><span class="tok-s2">"some additional text"</span><span class="tok-p">)</span></code></pre></div></div>
<div class="paragraph"><p>Somit wird aus der Summary sofort klar, warum der Service nicht <span class="state0">OK</span>
ist.</p></div>
<div class="paragraph"><p>Zu guter Letzt haben Sie noch — sowohl bei <code>summary</code> als auch bei
<code>notice</code> die Möglichkeit, für die Details einen <em>alternativen</em>
Text anzugeben, der evtl. mehr Informationen zu dem Teilergebnis enthält:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="python"><span></span>    <span class="tok-k">yield</span> <span class="tok-n">Result</span><span class="tok-p">(</span><span class="tok-n">state</span><span class="tok-o">=</span><span class="tok-n">State</span><span class="tok-o">.</span><span class="tok-n">OK</span><span class="tok-p">,</span>
                 <span class="tok-n">summary</span><span class="tok-o">=</span><span class="tok-s2">"55</span><span class="tok-si">% u</span><span class="tok-s2">sed space"</span><span class="tok-p">,</span>
                 <span class="tok-n">details</span><span class="tok-o">=</span><span class="tok-s2">"55.2</span><span class="tok-si">% o</span><span class="tok-s2">f 160 GB used (82 GB)"</span><span class="tok-p">)</span></code></pre></div></div>
<div class="paragraph"><p>Zusammengefasst bedeutet das:</p></div>
<div class="ulist"><ul>
<li><p>Der Gesamttext für die Summary sollte (bei Services, die <span class="state0">OK</span> sind) nicht länger als 60 Zeichen sein.</p></li>
<li><p>Verwenden Sie immer entweder <code>summary</code> oder <code>notice</code> — nicht beides und nicht keines davon.</p></li>
<li><p>Fügen Sie bei Bedarf <code>details</code> hinzu, wenn der Text für die Details ein alternativer sein soll.</p></li>
</ul></div>
</div>
</div>
<div class="sect1">
<h2 id="heading_errors">
<span class="hidden-anchor sr-only" id="errors"></span>7. Fehlerbehandlung</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="heading__exceptions_und_crashreports">
<span class="hidden-anchor sr-only" id="_exceptions_und_crashreports"></span>7.1. Exceptions und Crashreports</h3>
<div class="paragraph"><p>Die korrekte Behandlung von Fehlern nimmt (leider) einen großen Teil der
Programmierarbeit ein. Die gute Nachricht ist: die API von Checkmk erledigt dabei
bereits die meiste Arbeit. Meistens ist für Sie daher wichtig, dass Sie Fehler
einfach <strong>gar nicht</strong> behandeln.</p></div>
<div class="paragraph"><p>Wenn Python in eine Situation kommt, die in irgendeiner Form <em>unerwartet</em> ist,
reagiert es mit einer sogenannten <em>Exception</em>. Hier sind ein paar Beispiele:</p></div>
<div class="ulist"><ul>
<li><p>Sie konvertieren mit <code>int(…​)</code> einen String in eine Zahl, aber der String enthält keine Zahl, z.B. <code>int("foo")</code></p></li>
<li><p>Sie greifen mit <code>bar[4]</code> auf das fünfte Element von <code>bar</code> zu, aber das hat nur vier Elemente.</p></li>
<li><p>Sie rufen eine Funktion auf, die es nicht gibt.</p></li>
</ul></div>
<div class="paragraph"><p>Hier gilt die generelle wichtige Regel: <strong>Fangen Sie Exceptions nicht selbst ab!</strong> Denn Checkmk übernimmt das für
Sie in einer sinnvollen immer gleichen Art und Weise. Und zwar meist mit einem <em>Crashreport</em>. Das sieht
dann z.B. so aus:</p></div>
<div class="imageblock"><div class="content"><img src="../images/crash_report_1.png" alt="crash report 1"></div></div>
<div class="paragraph"><p>Durch einen Klick auf das Icon <span class="image-inline"><img src="../images/icons/icon_crash.png" alt="icon crash"></span> gelangt der Anwender dann auf eine Seite, auf der er:</p></div>
<div class="ulist"><ul>
<li><p>die Datei angezeigt bekommt, in der der Crash stattgefunden hat;</p></li>
<li><p>alle Informationen über den Crash angezeigt bekommt (wie Fehlermeldung, Aufrufstack, Agentenausgabe, aktuelle Werte von lokalen Variablen und vieles mehr);</p></li>
<li><p>den Report zu uns als Feedback einsenden kann.</p></li>
</ul></div>
<div class="paragraph"><p>Das Einsenden des Reports macht natürlich nur Sinn für Checkplugins,
welche offiziell Teil von Checkmk sind. Aber Sie können Ihre Anwender bitten,
Ihnen die Daten einfach zukommen zu lassen. Diese werden Ihnen beim Finden
des Fehlers helfen. Oft ist es ja so, dass das Checkplugin bei Ihnen selbst
funktioniert, aber es bei anderen Anwendern vielleicht sehr sporadisch zu
Fehlern kommt. Diese können Sie dann so meist sehr leicht finden.</p></div>
<div class="paragraph"><p>Falls Sie stattdessen die Exception selbst abfangen würden, wären diese ganzen
Informationen nicht verfügbar. Sie würden vielleicht den Service
auf <span class="state3">UNKNOWN</span> setzen und eine Fehlermeldung ausgeben. Aber die ganzen Umstände,
wie es dazu kam (z.B. die Daten vom Agenten), wäre verschleiert.</p></div>
</div>
<div class="sect2">
<h3 id="heading__exceptions_auf_der_kommandozeile_ansehen">
<span class="hidden-anchor sr-only" id="_exceptions_auf_der_kommandozeile_ansehen"></span>7.2. Exceptions auf der Kommandozeile ansehen</h3>
<div class="paragraph"><p>Falls Sie ihr Plugin auf der Kommandozeile ausführen, werden keine Crashreports
erzeugt. Sie sehen nur die zusammengefasste Fehlermeldung:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="console"><span></span><span class="tok-gp">OMD[mysite]:~$ </span>cmk<span class="tok-w"> </span>-II<span class="tok-w"> </span>--detect-plugins<span class="tok-o">=</span>foobar<span class="tok-w"> </span>myhost123
<span class="tok-go">  WARNING: Exception in discovery function of check plugin 'foobar': invalid literal for int() with base 10: 'foo'</span></code></pre></div></div>
<div class="paragraph"><p>Aber: hängen Sie einfach die Option <code>--debug</code> dran. Dann bekommt Sie den
Python-Stacktrace:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="console"><span></span><span class="tok-gp">OMD[mysite]:~$ </span>cmk<span class="tok-w"> </span>--debug<span class="tok-w"> </span>-II<span class="tok-w"> </span>--detect-plugins<span class="tok-o">=</span>foobar<span class="tok-w"> </span>myhost123
<span class="tok-go">Traceback (most recent call last):</span>
<span class="tok-go">  File "/omd/sites/myhost123/bin/cmk", line 82, in &lt;module&gt;</span>
<span class="tok-go">    exit_status = modes.call(mode_name, mode_args, opts, args)</span>
<span class="tok-go">  File "/omd/sites/myhost123/lib/python3/cmk/base/modes/<em>init</em>.py", line 68, in call</span>
<span class="tok-go">    return handler(*handler_args)</span>
<span class="tok-go">  File "/omd/sites/myhost123/lib/python3/cmk/base/modes/check_mk.py", line 1577, in mode_discover</span>
<span class="tok-go">    discovery.do_discovery(set(hostnames), options.get("checks"), options["discover"] == 1)</span>
<span class="tok-go">  File "/omd/sites/myhost123/lib/python3/cmk/base/discovery.py", line 345, in do_discovery</span>
<span class="tok-go">    _do_discovery_for(</span>
<span class="tok-go">  File "/omd/sites/myhost123/lib/python3/cmk/base/discovery.py", line 397, in _do_discovery_for</span>
<span class="tok-go">    discovered_services = _discover_services(</span>
<span class="tok-go">  File "/omd/sites/myhost123/lib/python3/cmk/base/discovery.py", line 1265, in _discover_services</span>
<span class="tok-go">    service_table.update({</span>
<span class="tok-go">  File "/omd/sites/myhost123/lib/python3/cmk/base/discovery.py", line 1265, in &lt;dictcomp&gt;</span>
<span class="tok-go">    service_table.update({</span>
<span class="tok-go">  File "/omd/sites/myhost123/lib/python3/cmk/base/discovery.py", line 1337, in _execute_discovery</span>
<span class="tok-go">    yield from _enriched_discovered_services(hostname, check_plugin.name, plugins_services)</span>
<span class="tok-go">  File "/omd/sites/myhost123/lib/python3/cmk/base/discovery.py", line 1351, in _enriched_discovered_services</span>
<span class="tok-go">    for service in plugins_services:</span>
<span class="tok-go">  File "/omd/sites/myhost123/lib/python3/cmk/base/api/agent_based/register/check_plugins.py", line 69, in filtered_generator</span>
<span class="tok-go">    for element in generator(*args, **kwargs):</span>
<span class="tok-go">  File "/omd/sites/myhost123/local/lib/python3/cmk/base/plugins/agent_based/foobar.py", line 5, in discover_foobar</span>
<span class="tok-go">    int("foo")</span>
<span class="tok-go">ValueError: invalid literal for int() with base 10: 'foo'</span></code></pre></div></div>
</div>
<div class="sect2">
<h3 id="heading__ungültige_ausgaben_vom_agenten">
<span class="hidden-anchor sr-only" id="_ungültige_ausgaben_vom_agenten"></span>7.3. Ungültige Ausgaben vom Agenten</h3>
<div class="paragraph"><p>Die Frage ist, wie Sie reagieren sollen, wenn die Ausgaben vom Agenten
nicht die Form haben, die Sie eigentlich erwarten würden - egal ob es der
„echte“ Agent ist oder die Daten per <a href="snmp.html">SNMP</a> kommen. Nehmen wir an, dass Sie
pro Zeile immer drei Worte erwarten. Was sollen Sie tun, falls nur zwei kommen?</p></div>
<div class="paragraph"><p>Nun — wenn das ein <em>erlaubtes und bekanntes</em> Verhalten des Agenten
ist, dann müssen Sie das natürlich abfangen und mit einer Fallunterscheidung
arbeiten.</p></div>
<div class="paragraph"><p>Falls das aber eigentlich nicht sein darf …​ dann tun Sie am besten so,
als ob die Zeile immer aus drei Worten besteht, also z.B. mit:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">def</span> <span class="tok-nf">check_foobar</span><span class="tok-p">(</span><span class="tok-n">section</span><span class="tok-p">):</span>
    <span class="tok-k">for</span> <span class="tok-n">foo</span><span class="tok-p">,</span> <span class="tok-n">bar</span><span class="tok-p">,</span> <span class="tok-n">baz</span> <span class="tok-ow">in</span> <span class="tok-n">section</span><span class="tok-p">:</span>
        <span class="tok-c1"># ...</span></code></pre></div></div>
<div class="paragraph"><p>Sollte jetzt mal eine Zeile dabei sein, die nicht aus genau drei Worten
besteht, wird eine hübsche Exception erzeugt und Sie bekommen den gerade
erwähnten sehr hilfreichen Crashreport.</p></div>
</div>
<div class="sect2">
<h3 id="heading__fehlende_items">
<span class="hidden-anchor sr-only" id="_fehlende_items"></span>7.4. Fehlende Items</h3>
<div class="paragraph"><p>Was ist, wenn der Agent korrekte Daten ausgibt, aber das Item fehlt, das
überprüft werden soll? Also z.B. auf diese Art:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">def</span> <span class="tok-nf">check_foobar</span><span class="tok-p">(</span><span class="tok-n">item</span><span class="tok-p">,</span> <span class="tok-n">section</span><span class="tok-p">):</span>
    <span class="tok-k">for</span> <span class="tok-n">sector</span><span class="tok-p">,</span> <span class="tok-n">used</span><span class="tok-p">,</span> <span class="tok-n">slots</span> <span class="tok-ow">in</span> <span class="tok-n">section</span><span class="tok-p">:</span>
        <span class="tok-k">if</span> <span class="tok-n">item</span> <span class="tok-o">==</span> <span class="tok-n">sector</span><span class="tok-p">:</span>
            <span class="tok-c1"># ... Check state ...</span>
            <span class="tok-k">yield</span> <span class="tok-n">Result</span><span class="tok-p">(</span><span class="tok-o">...</span><span class="tok-p">)</span>
            <span class="tok-k">return</span></code></pre></div></div>
<div class="paragraph"><p>Ist das gesuchte Item nicht dabei, so wird die Schleife durchlaufen und
Python fällt am Ende der Funktion einfach hinten raus, ohne dass ein
Resultat „geyieldet“ wurde. Und das ist genau das Richtige! Denn daran
erkennt Checkmk, dass das zu überwachende Item fehlt und erzeugt mit <span class="state3">UNKNOWN</span>
den richtigen Status und einen passenden Standardtext dazu.</p></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="heading_snmp">
<span class="hidden-anchor sr-only" id="snmp"></span>8. SNMP-basierte Checks</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="heading__grundsätzliches">
<span class="hidden-anchor sr-only" id="_grundsätzliches"></span>8.1. Grundsätzliches</h3>
<div class="paragraph"><p>Das Entwickeln von Checks, die mit SNMP arbeiten, läuft sehr ähnlich zu den
agentenbasierten, nur dass Sie hier noch angeben müssen, welche SNMP-Bereiche
(OIDs) der Check benötigt. Falls Sie noch keine Erfahrung mit SNMP haben,
so empfehlen wir Ihnen an dieser Stelle als Vorbereitung unbedingt den
Artikel über das <a href="snmp.html">Monitoring via SNMP</a>.</p></div>
<div class="paragraph"><p>Der Ablauf der Discovery und des Checkens via SNMP ist etwas anders als beim
normalen Agenten. Denn anders also dort — wo der Agent von sich aus alle
interessanten Informationen sendet — müssen wir bei SNMP selbst genau
sagen, welche Datenbereiche wir benötigen. Ein Komplettabzug aller Daten
wäre zwar theoretisch möglich (via SNMP-Walk), dauert aber bei schnellen
Geräten eher im Bereich von Minuten und bei komplexen Switches gern auch
über eine Stunde. Daher scheidet das beim Checken und sogar auch bei der
Discovery aus. Checkmk geht deswegen etwas zielgerichteter vor.</p></div>
<div class="sect3">
<h4 id="heading__snmp_detection">
<span class="hidden-anchor sr-only" id="_snmp_detection"></span>SNMP-Detection</h4>
<div class="paragraph"><p>Die Serviceerkennung teilt sich in zwei Phasen auf. Zunächst geschieht die
<em>SNMP-Detection</em>. Diese ermittelt, welche Plugins
denn überhaupt auf dem jeweiligen Gerät interessant sind. Dazu werden einige
wenige SNMP-OIDs abgerufen — und zwar einzelne, ohne Walk.  Die wichtigste
davon ist die <code>sysDescr</code> (OID: <code>1.3.6.1.2.1.1.1.0</code>). Unter dieser
OID hält jedes SNMP-Gerät eine Beschreibung von sich selbst bereit, z.B.
„<code>Cisco NX-OS(tm) n5000, Software (n5000-uk9),…​</code>“.</p></div>
<div class="paragraph"><p>Ausgehend von diesem Text kann man für sehr viele Plugins schon definitiv
entscheiden, ob diese hier Sinn ergeben. Wenn der Text noch nicht spezifisch
genug ist, werden weitere OIDs geholt und geprüft. Ergebnis der SNMP-Detection
ist dann eine Kandidaten-Liste von Checkplugins.</p></div>
</div>
<div class="sect3">
<h4 id="heading__discovery">
<span class="hidden-anchor sr-only" id="_discovery"></span>Discovery</h4>
<div class="paragraph"><p>Im zweiten Schritt werden für jeden dieser Kandidaten die jeweils nötigen
Monitoring-Daten mit SNMP-Walks geholt. Diese werden dann zu einer Tabelle
zusammengefasst und der Discovery-Funktion des Checks in dem Argument
<code>section</code> bereitgestellt, welche dann daraus wie gewohnt die zu
überwachenden Items ermittelt.</p></div>
</div>
<div class="sect3">
<h4 id="heading__checken">
<span class="hidden-anchor sr-only" id="_checken"></span>Checken</h4>
<div class="paragraph"><p>Beim Checken ist ja schon bekannt, welche Plugins für das Gerät ausgeführt
werden sollen und die SNMP-Detection entfällt. Hier werden gleich per
SNMP-Walks die für die Plugins benötigten Monitoring-Daten geholt und daraus
das Argument <code>section</code> für die Check-Funktion befüllt.</p></div>
</div>
<div class="sect3">
<h4 id="heading__zusammenfassung">
<span class="hidden-anchor sr-only" id="_zusammenfassung"></span>Zusammenfassung</h4>
<div class="paragraph"><p>Was müssen Sie also bei einem SNMP-Check anders machen als bei einem agentenbasierten?</p></div>
<div class="olist arabic"><ol class="arabic">
<li><p>Sie benötigen kein Plugin für den Agenten.</p></li>
<li><p>Sie müssen die für die SNMP-Detection nötigen Einzel-OIDs und Suchtexte festlegen.</p></li>
<li><p>Sie müssen festlegen, welche SNMP-Bereiche für das Monitoring geholt werden müssen.</p></li>
</ol></div>
</div>
</div>
<div class="sect2">
<h3 id="heading__ein_wort_zu_den_mibs">
<span class="hidden-anchor sr-only" id="_ein_wort_zu_den_mibs"></span>8.2. Ein Wort zu den MIBs</h3>
<div class="paragraph"><p>Bevor wir weitermachen wollen wir hier noch ein Wort zu den berüchtigten
SNMP-MIBs verlieren, denn über diese gibt es viele Vorurteile. Gleich zu
Beginn eine gute Nachricht: Checkmk benötigt sie nicht. Wirklich! Sie sind
aber eine wichtige Hilfe, um einen SNMP-Check <em>entwickeln</em> zu können.</p></div>
<div class="paragraph"><p>Was ist nun eine MIB? Wörtlich bedeutet die Abkürzung <em>Management
Information Base</em> — etwas nichtssagend. Konkret ist eine MIB eine
ganz gut lesbare Textdatei, welche einen bestimmten Teilbaum der SNMP-Welt
beschreibt. Und zwar steht hier, welcher Ast im Baum — also welche <em>OID</em> — welche Bedeutung hat. Das umfasst einen Namen für die OID, einen Hinweis,
welche Werte diese annehmen kann (z.B. bei enumerierten Datentypen, wo
dann Dinge wie 1=up, 2=down, etc. festgelegt sind) und manchmal auch noch
einen nützlichen Kommentar.</p></div>
<div class="paragraph"><p>Checkmk liefert eine Reihe von frei verfügbaren MIB-Dateien mit aus. Diese
beschreiben sehr allgemeine Bereiche im globalen OID-Baum, enthalten aber
keine herstellerspezifischen Bereiche. Daher helfen sie für selbst entwickelte
Checks nicht viel weiter.</p></div>
<div class="paragraph"><p>Versuchen Sie also, die für Ihr spezielle Gerät relevanten MIB-Dateien irgendwo
auf den Webseiten vom Hersteller oder sogar auf dem Management-Interface
des Geräts zu finden und installieren Sie diese in der Checkmk-Instanz nach
<code>local/share/check_mk/mibs</code>. Dann können Sie in SNMP-Walks OID-Nummern
in Namen umrechnen lassen und so schneller finden, wo die für das Monitoring
interessanten Daten sind. Wie gesagt, enthalten die MIBs außerdem interessante Informationen in den Kommentaren — wenn sie sorgfältig gemacht sind.
Sie können eine MIB-Datei einfach mit einem Texteditor oder mit <code>less</code> ansehen.</p></div>
</div>
<div class="sect2">
<h3 id="heading_locating_oids">
<span class="hidden-anchor sr-only" id="locating_oids"></span>8.3. Die richtigen OIDs finden</h3>
<div class="paragraph"><p>Die entscheidende Voraussetzung, um ein Plugin zu entwickeln, ist natürlich,
dass Sie wissen, welche OIDs die notwendigen Informationen enthalten. Der
erste Schritt dabei ist (falls das Gerät das nicht verweigert), einen kompletten
SNMP-Walk zu ziehen. Dabei werden <em>alle</em> per SNMP verfügbaren Daten
abgerufen.</p></div>
<div class="paragraph"><p>Checkmk kann das sehr einfach für Sie erledigen. Nehmen Sie dazu zunächst
das Gerät (oder eines der Geräte), für das Sie ein Plugin entwickeln wollen,
ins Monitoring auf. Sagen wir es heißt <code>mydevice01</code>. Stellen Sie sicher,
dass dieses in den Grundfunktionen überwacht werden kann. Zumindest müssen
die Services <span class="guihint">SNMP Info</span> und <span class="guihint">Uptime</span> gefunden werden und wahrscheinlich
auch noch mindestens ein <span class="guihint">Interface</span>. So stellen Sie sicher, dass der SNMP-Zugriff
sauber funktioniert.</p></div>
<div class="paragraph"><p>Wechseln Sie dann auf die Kommandozeile der Checkmk-Instanz. Hier können
Sie mit folgendem Befehl einen kompletten Walk ziehen. Dabei empfehlen wir,
gleich die Option <code>-v</code> (verbose) zu verwenden:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="console"><span></span><span class="tok-gp">OMD[mysite]:~$ </span>cmk<span class="tok-w"> </span>-v<span class="tok-w"> </span>--snmpwalk<span class="tok-w"> </span>mydevice01
<span class="tok-go">mydevice01:</span>
<span class="tok-go">Walk on ".1.3.6.1.2.1"...3898 variables.</span>
<span class="tok-go">Walk on ".1.3.6.1.4.1"...6025 variables.</span>
<span class="tok-go">Wrote fetched data to /omd/sites/heute/var/check_mk/snmpwalks/mydevice01.</span></code></pre></div></div>
<div class="paragraph"><p>Wie bereits erwähnt, kann so ein Komplettwalk Minuten oder sogar
Stunden dauern (auch wenn letzteres eher selten ist). Werden Sie also
nicht nervös, wenn es hier etwas dauert. Der Walk wurde nun in der Datei
<code>var/check_mk/snmpwalks/mydevice01</code> gespeichert. Es handelt sich
dabei um eine gut lesbare Textdatei, die etwa so beginnt:</p></div>
<div class="listingblock">
<div class="title">var/check_mk/snmpwalks/mydevice01</div>
<div class="content"><pre class="pygments highlight"><code><span></span>.1.3.6.1.2.1.1.1.0 JetStream 24-Port Gigabit L2 Managed Switch with 4 Combo SFP Slots
.1.3.6.1.2.1.1.2.0 .1.3.6.1.4.1.11863.1.1.3
.1.3.6.1.2.1.1.3.0 546522419
.1.3.6.1.2.1.1.4.0 hh@example.com
.1.3.6.1.2.1.1.5.0 sw-ks-01
.1.3.6.1.2.1.1.6.0 Core Switch Serverraum klein
.1.3.6.1.2.1.1.7.0 3
.1.3.6.1.2.1.2.1.0 27</code></pre></div>
</div>
<div class="paragraph"><p>In jeder Zeile steht eine OID und danach deren Wert. Und gleich in der ersten Zeile finden Sie die
wichtigste, nämlich die <code>sysDescr</code>.</p></div>
<div class="paragraph"><p>Nun sind die OIDs nicht sehr aussagekräftig. Wenn die richtigen MIBs installiert sind,
können Sie diese in einem zweiten Schritt mit dem Befehl <code>cmk --snmptranslate</code>
in Namen umrechnen lassen. Am besten leiten Sie das Ergebnis, was ansonsten im Terminal
käme, in eine Datei um:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="console"><span></span><span class="tok-gp">OMD[heute]:~$ </span>cmk<span class="tok-w"> </span>--snmptranslate<span class="tok-w"> </span>mydevice01<span class="tok-w">  </span>&gt;<span class="tok-w"> </span>translated
<span class="tok-go">Processing 9923 lines.</span>
<span class="tok-go">finished.</span></code></pre></div></div>
<div class="paragraph"><p>Die Datei <code>translated</code> liest sich wie der ursprüngliche Walk, hat aber in jeder
Zeile nach dem <code>--&gt;</code> einen übersetzten Wert für die OID:</p></div>
<div class="listingblock">
<div class="title">translated</div>
<div class="content"><pre class="pygments highlight"><code><span></span>.1.3.6.1.2.1.1.1.0 JetStream 24-Port Gigabit L2 Managed Switch with 4 Combo SFP Slots --&gt; SNMPv2-MIB::sysDescr.0
.1.3.6.1.2.1.1.2.0 .1.3.6.1.4.1.11863.1.1.3 --&gt; SNMPv2-MIB::sysObjectID.0
.1.3.6.1.2.1.1.3.0 546522419 --&gt; DISMAN-EVENT-MIB::sysUpTimeInstance
.1.3.6.1.2.1.1.4.0 hh@example.com --&gt; SNMPv2-MIB::sysContact.0
.1.3.6.1.2.1.1.5.0 sw-ks-01 --&gt; SNMPv2-MIB::sysName.0
.1.3.6.1.2.1.1.6.0 Core Switch Serverraum klein --&gt; SNMPv2-MIB::sysLocation.0
.1.3.6.1.2.1.1.7.0 3 --&gt; SNMPv2-MIB::sysServices.0
.1.3.6.1.2.1.2.1.0 27 --&gt; IF-MIB::ifNumber.0
.1.3.6.1.2.1.2.2.1.1.1 1 --&gt; IF-MIB::ifIndex.1
.1.3.6.1.2.1.2.2.1.1.2 2 --&gt; IF-MIB::ifIndex.2</code></pre></div>
</div>
<div class="paragraph"><p>Beispiel: die OID <code>.1.3.6.1.2.1.1.4.0</code> hat den übersetzten Namen
<code>SNMPv2-MIB::sysContact.0</code>. Dies ist ein wichtiger Hinweis, der Rest
ist dann Übung, Erfahrung und natürlich experimentieren.</p></div>
</div>
<div class="sect2">
<h3 id="heading__die_registrierung_der_snmp_sektion">
<span class="hidden-anchor sr-only" id="_die_registrierung_der_snmp_sektion"></span>8.4. Die Registrierung der SNMP-Sektion</h3>
<div class="paragraph"><p>Wenn Sie also die notwendigen OIDs herausgefunden haben, geht es an die
eigentliche Entwicklung des Plugins. Das geschieht in drei Schritten:</p></div>
<div class="olist arabic"><ol class="arabic">
<li><p>Legen Sie für die SNMP-Detection fest, welche OIDs welche Texte enthalten müssen, damit Ihr Plugin ausgeführt werden soll.</p></li>
<li><p>Deklarieren Sie, welche OID-Zweige für das Monitoring geholt werden müssen.</p></li>
<li><p>Schreiben Sie ein Checkplugin analog zu denjenigen für agentenbasierte Checks.</p></li>
</ol></div>
<div class="paragraph"><p>Die ersten beiden Schritte erfolgen durch die Registrierung einer SNMP-Sektion.
Dies erledigen Sie durch den Aufruf von <code>register.snmp_section()</code>. Hier
geben Sie mindestens drei Argumente an: den Namen der Sektion (<code>name</code>),
die Angaben für die SNMP-Detection <code>detect</code> und die benötigten
OID-Zweige für das eigentlich Monitoring (<code>fetch</code>). Hier ist ein Beispiel für ein
fiktives Checkplugin mit dem Namen <code>foo</code>:</p></div>
<div class="listingblock">
<div class="title">local/lib/check_mk/base/plugins/agent_based/foo.py</div>
<div class="content"><pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-n">register</span><span class="tok-o">.</span><span class="tok-n">snmp_section</span><span class="tok-p">(</span>
    <span class="tok-n">name</span> <span class="tok-o">=</span> <span class="tok-s2">"foo"</span><span class="tok-p">,</span>
    <span class="tok-n">detect</span> <span class="tok-o">=</span> <span class="tok-n">startswith</span><span class="tok-p">(</span><span class="tok-s2">".1.3.6.1.2.1.1.1.0"</span><span class="tok-p">,</span> <span class="tok-s2">"foobar device"</span><span class="tok-p">),</span>
    <span class="tok-n">fetch</span> <span class="tok-o">=</span> <span class="tok-n">SNMPTree</span><span class="tok-p">(</span>
        <span class="tok-n">base</span> <span class="tok-o">=</span> <span class="tok-s1">'.1.3.6.1.4.1.35424.1.2'</span><span class="tok-p">,</span>
        <span class="tok-n">oids</span> <span class="tok-o">=</span> <span class="tok-p">[</span>
            <span class="tok-s1">'4.0'</span><span class="tok-p">,</span>
            <span class="tok-s1">'5.0'</span><span class="tok-p">,</span>
            <span class="tok-s1">'8.0'</span><span class="tok-p">,</span>
        <span class="tok-p">],</span>
    <span class="tok-p">),</span>
<span class="tok-p">)</span></code></pre></div>
</div>
<div class="sect3">
<h4 id="heading__die_snmp_detection">
<span class="hidden-anchor sr-only" id="_die_snmp_detection"></span>Die SNMP-Detection</h4>
<div class="paragraph"><p>Mit dem Schlüsselwort <code>detect</code> geben Sie an, unter welchen Bedingungen
die Discovery-Funktion überhaupt ausgeführt werden soll. In unserem Beispiel
ist das der Fall, wenn der Wert der OID <code>.1.3.6.1.2.1.1.1.0</code> (also
die <code>sysDescr</code>) mit dem Text <code>foobar device</code> beginnt (wobei
Groß-/Kleinschreibung grundsätzlich nicht unterschieden wird). Neben
<code>startswith</code> gibt es noch eine ganze Reihe weiterer möglichen
Attribute. Dabei existiert von jedem auch eine negierte Form, welche mit
<code>not_</code> beginnt:</p></div>
<table class="table-responsive table-bordered table tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 28%;">
<col style="width: 33%;">
<col style="width: 39%;">
</colgroup>
<thead><tr>
<th class="tableblock halign-left valign-top">Attribut</th>
<th class="tableblock halign-left valign-top">Negation</th>
<th class="tableblock halign-left valign-top">Bedeutung</th>
</tr></thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">equals(oid, needle)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">not_equals(oid, needle)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Der Wert der OID ist gleich dem Text <code>needle</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">contains(oid, needle)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">not_contains(oid, needle)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Der Wert der OID enthält an irgendeiner Stelle den Text <code>needle</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">startswith(oid, needle)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">not_startswith(oid, needle)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Der Wert der OID beginnt mit dem Text <code>needle</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">endswith(oid, needle)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">not_endswith(oid, needle)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Der Wert der OID endet mit dem Text <code>needle</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">matches(oid, regex)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">not_matches(oid, regex)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Der Wert der OID matcht auf den <a href="regexes.html">regulären Ausdruck</a> <code>regex</code>, und zwar hinten und vorne geankert, also mit einem exakten Match. Wenn Sie nur einen Teilstring benötigen, ergänzen Sie einfach vorne bzw. hinten noch ein <code>.*</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">exists(oid)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">not_exists(oid)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Erfüllt, wenn die OID auf dem Gerät verfügbar ist. Der Wert darf leer sein.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph"><p>Daneben gibt es noch die Möglichkeit, mehrere Tests mit <code>all_of</code>
oder <code>any_of</code> zu verknüpfen. <code>all_of</code> erfordert mehrere
erfolgreiche Attribute für eine positive Erkennung des Plugins. Folgendes
Beispiel findet auf einem Gerät das Plugin, wenn in der <code>sysDescr</code> der Text mit <code>foo</code> (oder <code>FOO</code> oder <code>Foo</code>) beginnt <strong>und</strong>
die OID <code>.1.3.6.1.2.1.1.2.0</code> den Text <code>.4.1.11863.</code> enthält:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-n">detect</span> <span class="tok-o">=</span> <span class="tok-n">all_of</span><span class="tok-p">(</span>
    <span class="tok-n">startswith</span><span class="tok-p">(</span><span class="tok-s2">".1.3.6.1.2.1.1.1.0"</span><span class="tok-p">,</span> <span class="tok-s2">"foo"</span><span class="tok-p">),</span>
    <span class="tok-n">contains</span><span class="tok-p">(</span><span class="tok-s2">".1.3.6.1.2.1.1.2.0"</span><span class="tok-p">,</span> <span class="tok-s2">".4.1.11863."</span><span class="tok-p">)</span>
<span class="tok-p">)</span></code></pre></div></div>
<div class="paragraph"><p><code>any_of</code> hingegen ist damit zufrieden, wenn auch nur eines der Kriterien
erfüllt ist. Hier ist ein Beispiel, in dem verschiedene Werte für die <code>sysDescr</code>
erlaubt sind:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-n">detect</span> <span class="tok-o">=</span> <span class="tok-n">any_of</span><span class="tok-p">(</span>
    <span class="tok-n">startswith</span><span class="tok-p">(</span><span class="tok-s2">".1.3.6.1.2.1.1.1.0"</span><span class="tok-p">,</span> <span class="tok-s2">"foo version 3 system"</span><span class="tok-p">),</span>
    <span class="tok-n">startswith</span><span class="tok-p">(</span><span class="tok-s2">".1.3.6.1.2.1.1.1.0"</span><span class="tok-p">,</span> <span class="tok-s2">"foo version 4 system"</span><span class="tok-p">),</span>
    <span class="tok-n">startswith</span><span class="tok-p">(</span><span class="tok-s2">".1.3.6.1.2.1.1.1.0"</span><span class="tok-p">,</span> <span class="tok-s2">"foo version 4.1 system"</span><span class="tok-p">),</span>
<span class="tok-p">)</span></code></pre></div></div>
<div class="paragraph"><p>Übrigens: Kennen Sie sich gut mit <a href="regexes.html">regulären Ausdrücken</a> aus? Dann würden Sie wahrscheinlich
das ganze vereinfachen und doch wieder mit einer Zeile auskommen:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-n">detect</span> <span class="tok-o">=</span> <span class="tok-n">matches</span><span class="tok-p">(</span><span class="tok-s2">".1.3.6.1.2.1.1.1.0"</span><span class="tok-p">,</span> <span class="tok-s2">"FOO Version (3|4|4.1) .*"</span><span class="tok-p">),</span></code></pre></div></div>
<div class="paragraph"><p>Und noch ein wichtiger Hinweis: Die OIDs, die Sie bei der <code>detect</code>-Deklaration
von einem Plugin angeben, werden im Zweifel von <strong>jedem</strong> Gerät geholt, welches
per SNMP überwacht wird. Seien Sie daher sehr sparsam bei der Verwendung von herstellerspezifischen
OIDs. Versuchen Sie, Ihre Erkennung unbedingt so zu machen, dass ausschließlich
die <code>sysDescr</code> (<code>.1.3.6.1.2.1.1.1.0</code>) und die <code>sysObjectID</code>
(<code>.1.3.6.1.2.1.1.2.0</code>) verwendet werden. Falls Sie dennoch eine weitere
andere OID benötigen, dann reduzieren Sie die Anzahl der Geräte, wo diese angefragt
wird, auf ein Minimum, indem Sie zuvor mittels der <code>sysDescr</code> so viele Geräte
wie möglich bereits ausschließen, z.B. so:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-n">detect</span> <span class="tok-o">=</span> <span class="tok-n">all_of</span><span class="tok-p">(</span>
    <span class="tok-n">startswith</span><span class="tok-p">(</span><span class="tok-s2">".1.3.6.1.2.1.1.1.0"</span><span class="tok-p">,</span> <span class="tok-s2">"foo"</span><span class="tok-p">),</span>   <span class="tok-c1"># first check sysDescr</span>
    <span class="tok-n">contains</span><span class="tok-p">(</span><span class="tok-s2">".1.3.6.1.4.1.4455.1.3"</span><span class="tok-p">,</span> <span class="tok-s2">"bar"</span><span class="tok-p">),</span>  <span class="tok-c1"># fetch vendor specific OID</span>
<span class="tok-p">)</span></code></pre></div></div>
<div class="paragraph"><p>Das <code>all_of()</code> funktioniert so, dass bei einem Scheitern der ersten
Bedingung die zweite gar nicht erst probiert wird (und somit die betreffende
OID auch nicht geholt). Hier im Beispiel wird die OID <code>.1.3.6.1.4.1.4455.1.3</code> nur
bei solchen Geräten geholt, die <code>foo</code> in ihrer <code>sysDescr</code> haben.</p></div>
<div class="paragraph"><p>Was geschieht, wenn Sie die Deklaration falsch oder zumindest nicht ganz
zielsicher gemacht haben?</p></div>
<div class="ulist"><ul>
<li><p>Falls die Detection fälschlicherweise Geräte erkennt, auf denen die nötigen OIDs gar nicht vorhanden sind, wird Ihre Discovery-Funktion dann auch keine Services erzeugen. Es passiert also nichts „Schlimmes“. Allerdings wird das die Discovery auf solchen Geräten verlangsamen, da jetzt jedes mal nutzlos versucht wird, die entsprechenden OIDs abzufragen.</p></li>
<li><p>Falls die Detection eigentlich zulässige Geräte <em>nicht</em> erkennt, werden dort im Monitoring bei der Discovery auch keine Services gefunden.</p></li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="heading__die_oid_bereiche_für_das_monitoring">
<span class="hidden-anchor sr-only" id="_die_oid_bereiche_für_das_monitoring"></span>8.5. Die OID-Bereiche für das Monitoring</h3>
<div class="paragraph"><p>Die wichtigste Stelle der SNMP-Deklaration ist die Angabe, welche OIDs für
das Monitoring geholt werden sollen. In fast allen Fällen benötigt ein Plugin
dazu nur ausgewählte Äste aus einer einzigen Tabelle. Betrachten wir folgendes
Beispiel:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="python"><span></span>    <span class="tok-n">fetch</span> <span class="tok-o">=</span> <span class="tok-n">SNMPTree</span><span class="tok-p">(</span>
        <span class="tok-n">base</span> <span class="tok-o">=</span> <span class="tok-s1">'.1.3.6.1.4.1.35424.1.2'</span><span class="tok-p">,</span>
        <span class="tok-n">oids</span> <span class="tok-o">=</span> <span class="tok-p">[</span>
            <span class="tok-s1">'4.0'</span><span class="tok-p">,</span>
            <span class="tok-s1">'5.0'</span><span class="tok-p">,</span>
            <span class="tok-s1">'8.0'</span><span class="tok-p">,</span>
        <span class="tok-p">],</span>
    <span class="tok-p">),</span></code></pre></div></div>
<div class="paragraph"><p>Das Schlüsselwort <code>base</code> gibt hier einen OID-Präfix an. Alle
nötigen Daten liegen unterhalb. Bei <code>oids</code> geben Sie dann eine
Liste von Sub-OIDs an, die ab dort geholt werden sollen. In obigem
Beispiel werden dann insgesamt drei SNMP-Walks gemacht, nämlich
ausgehend von den OIDs <code>.1.3.6.1.4.1.35424.1.2.4.0</code>, <code>.1.3.6.1.4.1.35424.1.2.5.0</code>
und <code>.1.3.6.1.4.1.35424.1.2.8.0</code>. Dabei ist es wichtig, dass diese
Walks die gleiche Anzahl von Variablen holen und dass diese auch einander
entsprechen. Damit ist gemeint, dass z.B. das n-te Element aus jedem der
Walks dem selben überwachten Objekt entspricht.</p></div>
<div class="paragraph"><p>Hier ist ein Beispiel vom Checkplugin <code>snmp_quantum_storage_info</code>:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="python"><span></span>    <span class="tok-n">tree</span> <span class="tok-o">=</span> <span class="tok-n">SNMPTree</span><span class="tok-p">(</span>
       <span class="tok-n">base</span><span class="tok-o">=</span><span class="tok-s2">".1.3.6.1.4.1.2036.2.1.1"</span><span class="tok-p">,</span>  <span class="tok-c1"># qSystemInfo</span>
       <span class="tok-n">oids</span><span class="tok-o">=</span><span class="tok-p">[</span>
           <span class="tok-s2">"4"</span><span class="tok-p">,</span>   <span class="tok-c1"># qVendorID</span>
           <span class="tok-s2">"5"</span><span class="tok-p">,</span>   <span class="tok-c1"># qProdId</span>
           <span class="tok-s2">"6"</span><span class="tok-p">,</span>   <span class="tok-c1"># qProdRev</span>
           <span class="tok-s2">"12"</span><span class="tok-p">,</span>  <span class="tok-c1"># qSerialNumber</span>
       <span class="tok-p">],</span>
    <span class="tok-p">),</span>
<span class="tok-p">)</span></code></pre></div></div>
<div class="paragraph"><p>Hier wird pro Storage-Gerät jeweils die Vendor ID, die Product ID, die Product Revision
und die Seriennummer geholt.</p></div>
<div class="paragraph"><p>Der Discovery- und Check-Funktion werden diese Daten als Tabelle präsentiert, also
als Liste von Listen. Dabei wird die Tabelle so gespiegelt, dass Sie pro Eintrag
in der äußeren Liste alle Daten zu einem Item haben. Jeder Eintrag hat so viele
Elemente, wie Sie bei <code>oids</code> angegeben haben. So können Sie die Liste
sehr praktisch mit einer Schleife durchlaufen, z.B.</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="python"><span></span>    <span class="tok-k">for</span> <span class="tok-n">vendor_id</span><span class="tok-p">,</span> <span class="tok-n">prod_id</span><span class="tok-p">,</span> <span class="tok-n">prod_rev</span><span class="tok-p">,</span> <span class="tok-n">serial_number</span> <span class="tok-ow">in</span> <span class="tok-n">section</span><span class="tok-p">:</span>
        <span class="tok-o">...</span></code></pre></div></div>
<div class="paragraph"><p>Bitte beachten Sie:</p></div>
<div class="ulist"><ul>
<li><p>Alle Einträge sind <em>strings</em>, selbst wenn die betreffenden OIDs eigentlich Zahlen sind.</p></li>
<li><p>Fehlende OIDs werden als Leerstrings präsentiert</p></li>
<li><p>Denken Sie an die Möglichkeit, während der Entwicklung mit <code>pprint</code> die Daten formatiert auszugeben.</p></li>
</ul></div>
</div>
<div class="sect2">
<h3 id="heading__weitere_snmp_sonderheiten">
<span class="hidden-anchor sr-only" id="_weitere_snmp_sonderheiten"></span>8.6. Weitere SNMP-Sonderheiten</h3>
<div class="paragraph"><p>Hier beschreiben wir in Zukunft noch:</p></div>
<div class="ulist"><ul>
<li><p>Wie Sie mehrere unabhängige SNMP-Bereiche abrufen können</p></li>
<li><p>Was es mit OIDEnd() auf sich hat</p></li>
<li><p>Weitere Sonderfälle beim Umgang mit SNMP</p></li>
</ul></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="heading_format_numbers">
<span class="hidden-anchor sr-only" id="format_numbers"></span>9. Formatierung von Zahlen</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="heading__grundlegendes">
<span class="hidden-anchor sr-only" id="_grundlegendes"></span>9.1. Grundlegendes</h3>
<div class="paragraph"><p>In der Summary oder den Details eines Services werden oft Zahlen ausgegeben. Um Ihnen
eine schöne und korrekte Formatierung möglichst einfach zu machen, und um
auch die Ausgaben von allen Checkplugins zu vereinheitlichen, gibt es Hilfsfunktionen
für die Darstellung von verschiedenen Arten von Größen.
Alle diese sind Unterfunktionen vom Modul <code>render</code> und werden folglich
mit <code>render.</code> aufgerufen. Z.B. ergibt <code>render.bytes(2000)</code> den Text
<code>1.95 KiB</code>.</p></div>
<div class="paragraph"><p>Allen diesen Funktionen ist gemein, dass Sie ihren Wert in einer
sogenannten <em>kanonischen</em> oder natürlichen Einheit bekommen. So muss
man nie nachdenken und es gibt keine Schwierigkeiten oder Fehler bei der
Umrechnung. Z.B. werden Zeiten immer in Sekunden angegeben und Größen von
Festplatten, Dateien, etc. immer in Bytes und nicht in Kilobytes, Kibibytes,
Blöcken oder sonstigem Durcheinander.</p></div>
<div class="paragraph"><p>Bitte verwenden Sie diese Funktionen auch dann, wenn Ihnen die Darstellung
nicht so gut gefällt. Immerhin ist diese dann für den Benutzer einheitlich.
Und zukünftige Versionen von Checkmk können die Darstellung möglicherweise
ändern oder sogar konfigurierbar für den Benutzer machen. Davon wird dann
Ihr Checkplugin auch profitieren.</p></div>
<div class="paragraph"><p>Nach der ausführlichen Beschreibung aller Darstellungsfunktionen (Renderfunktionen) finden
Sie eine Zusammenfassung in Form einer übersichtlichen Tabelle.</p></div>
</div>
<div class="sect2">
<h3 id="heading__zeiten_zeitspannen_frequenzen">
<span class="hidden-anchor sr-only" id="_zeiten_zeitspannen_frequenzen"></span>9.2. Zeiten, Zeitspannen, Frequenzen</h3>
<div class="paragraph"><p>Absolute Zeitangaben (Zeitstempel) werden mit <code>render.date()</code> oder <code>render.datetime()</code>
formatiert. Die Angaben erfolgen immer in <em>Sekunden ab dem 1. Januar 1970, 00:00:00 UTC</em> — der
sogenannten Epochenzeit. Dies ist auch das Format, mit dem die Pythonfunktion <code>time.time()</code>
arbeitet. Vorteil an dieser Darstellung ist, dass sich damit sehr einfach rechnen lässt, also
z.B. die Dauer eines Vorgangs, wenn Start- und Endzeit bekannt sind. Die Formel ist dann
einfach <code>duration = end - start</code>. Und diese Berechnungen funktionieren unabhängig von
der Zeitzone, Sommerzeitumstellungen oder Schaltjahren.</p></div>
<div class="paragraph"><p><code>render.date()</code> gibt dabei nur das Datum aus, <code>render.datetime()</code> fügt noch die
Uhrzeit hinzu. Die Ausgabe erfolgt dabei gemäß der aktuellen Zeitzone desjenigen Checkmk-Servers,
welcher den Check ausführt! Beispiele:</p></div>
<table class="table-responsive table-bordered table tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead><tr>
<th class="tableblock halign-left valign-top">Aufruf</th>
<th class="tableblock halign-left valign-top">Ausgabe</th>
</tr></thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">render.date(0)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Jan 01 1970</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">render.datetime(0)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Jan 01 1970 01:00:00</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">render.date(1600000000)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Sep 13 2020</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">render.datetime(1600000000)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Sep 13 2020 14:26:40</p></td>
</tr>
</tbody>
</table>
<div class="paragraph"><p>Bitte wundern Sie sich jetzt nicht, dass <code>render.date(0)</code> als Uhrzeit
nicht 00:00, sondern 01:00 ausgibt! Das liegt daran, dass wir dieses Handbuch
in der Zeitzone von Deutschland schreiben, und die ist der Standardzeit UTC
eine Stunde voraus (zumindest während der Normalzeit, denn der 1. Januar liegt
ja bekanntlich nicht in der Sommerzeit).</p></div>
<div class="paragraph"><p>Für <em>Zeitspannen</em> gibt es noch die Funktion <code>render.timespan()</code>.
Diese bekommt eine Dauer in Sekunden und gibt das menschenlesbar aus. Bei
größeren Zeitspannen werden Sekunden oder Minuten weggelassen.</p></div>
<table class="table-responsive table-bordered table tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead><tr>
<th class="tableblock halign-left valign-top">Aufruf</th>
<th class="tableblock halign-left valign-top">Ausgabe</th>
</tr></thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">render.timespan(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1 second</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">render.timespan(123)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2 minutes 3 seconds</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">render.timespan(12345)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3 hours 25 minutes</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">render.timespan(1234567)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">14 days 6 hours</p></td>
</tr>
</tbody>
</table>
<div class="paragraph"><p>Eine <em>Frequenz</em> ist quasi der Kehrwert der Zeit. Die kanonische Einheit ist <em>Hz</em>, was
das gleiche bedeutet wie 1 / sec. Einsatzgebiet ist z.B. die Taktrate einer CPU:</p></div>
<table class="table-responsive table-bordered table tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead><tr>
<th class="tableblock halign-left valign-top">Aufruf</th>
<th class="tableblock halign-left valign-top">Ausgabe</th>
</tr></thead>
<tbody><tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">render.frequency(111222333444)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">111 GHz</p></td>
</tr></tbody>
</table>
</div>
<div class="sect2">
<h3 id="heading__bytes">
<span class="hidden-anchor sr-only" id="_bytes"></span>9.3. Bytes</h3>
<div class="paragraph"><p>Überall wo es um Arbeitsspeicher, Dateien, Festplatten, Dateisysteme und
dergleichen geht, ist die kanonische Einheit das <em>Byte</em>. Da Computer
so etwas meist in Zweierpotenzen organisieren, also z.B. in Einheiten zu
512, 1024 oder 65536 Bytes, hatte sich dabei von Beginn an eingebürgert,
dass ein <em>Kilobyte</em> nicht 1000, sondern 1024 Bytes ist. An sich
sehr praktisch, weil so meist runde Zahlen rauskamen. Der legendäre Commodore
C64 hatte eben 64 Kilobyte Speicher und nicht 65,536.</p></div>
<div class="paragraph"><p>Leider kamen irgendwann Festplattenhersteller auf die Idee, die Größen
ihrer Platten in 1000’er-Einheiten anzugeben. Da bei jeder Größenordnung
der Unterschied zwischen 1000 und 1024 immerhin 2,4% ausmacht, und diese sich
aufmultiplizieren, wird so aus einer Platte der Größe 1 GB (1024 mal 1024 *
1024) auf einmal 1,07 GB. Das verkauft sich besser.</p></div>
<div class="paragraph"><p>Diese lästige Verwirrung besteht bis heute und sorgt immer wieder für Fehler.
Als Linderung wurden von der internationalen elektrotechnischen Kommission
neue Präfixe auf Grundlage des Binärsystems festgelegt. Demnach ist heute
offiziell ein Kilobyte 1000 Byte und ein <em>Kibibyte</em> 1024 Byte (2 hoch 10).
Außerdem soll man <em>Mebibyte</em> und <em>Gibitbyte</em> und <em>Tebibyte</em>
sagen (schon mal gehört?). Die Abkürzungen lauten (Achtung, hier auf
einmal immer i, statt e!) <em>KiB</em>, <em>MiB</em>, <em>GiB</em> und <em>TiB</em>.</p></div>
<div class="paragraph"><p>Checkmk passt sich an diesen Standard an und hilft Ihnen mit mehreren angepassten
Renderfunktionen dabei, dass Sie immer korrekte Ausgaben machen. So
gibt es speziell für Festplatten und Dateisysteme die Funktion
<code>render.disksize()</code>, welche die Ausgabe in 1000’er-Potenzen macht.</p></div>
<table class="table-responsive table-bordered table tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead><tr>
<th class="tableblock halign-left valign-top">Aufruf</th>
<th class="tableblock halign-left valign-top">Ausgabe</th>
</tr></thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">render.disksize(1000)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1.00 kB</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">render.disksize(1024)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1.02 kB</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">render.disksize(2000000)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2.00 MB</p></td>
</tr>
</tbody>
</table>
<div class="paragraph"><p>Bei der Größe von <em>Dateien</em> ist es oft üblich, die genaue Größe in
Bytes <em>ohne Rundung</em> anzugeben. Dies hat den Vorteil, dass man so
sehr schnell sehen kann, wenn sich eine Datei auch nur minimal geändert
hat oder dass zwei Dateien (wahrscheinlich) gleich sind. Hierfür ist
die Funktion <code>render.filesize()</code> verantwortlich:</p></div>
<table class="table-responsive table-bordered table tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead><tr>
<th class="tableblock halign-left valign-top">Aufruf</th>
<th class="tableblock halign-left valign-top">Ausgabe</th>
</tr></thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">render.filesize(1000)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1,000 B</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">render.filesize(1024)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1,024 B</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">render.filesize(2000000)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2,000,000 B</p></td>
</tr>
</tbody>
</table>
<div class="paragraph"><p>Wenn Sie eine Größe ausgeben möchten, die keine Platten- oder Dateigröße ist,
dann verwenden Sie einfach das generische <code>render.bytes()</code>. Hier bekommen
sie die Ausgabe in klassischen 1024’er-Potenzen in der neuen offiziellen Schreibweise:</p></div>
<table class="table-responsive table-bordered table tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead><tr>
<th class="tableblock halign-left valign-top">Aufruf</th>
<th class="tableblock halign-left valign-top">Ausgabe</th>
</tr></thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">render.bytes(1000)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1000 B</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">render.bytes(1024)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1.00 KiB</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">render.bytes(2000000)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1.91 MiB</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect2">
<h3 id="heading__bandbreiten_datenraten">
<span class="hidden-anchor sr-only" id="_bandbreiten_datenraten"></span>9.4. Bandbreiten, Datenraten</h3>
<div class="paragraph"><p>Die Netzwerker haben ihre eigenen Begriffe und Arten, Dinge auszudrücken.
Und wie immer gibt sich Checkmk Mühe, in jeder Domäne, die dort übliche
Art zu kommunizieren, zu übernehmen. Deswegen gibt es für Datenraten
und Geschwindigkeiten gleich drei verschiedene Renderfunktionen. Alle
haben gemeinsam, dass die Raten in <em>Bytes pro Sekunde</em> übergeben
werden, selbst dann, wenn die Ausgabe in Bits erfolgt!</p></div>
<div class="paragraph"><p><code>render.nicspeed()</code> stellt die Maximalgeschwindigkeit einer
Netzwerkkarte oder eines Switchports dar. Da es keine Messwerte sind, muss
auch nicht gerundet werden. Obwohl kein Port einzelne Bits versenden
kann, sind die Angaben aus historischen Gründen in Bits. Achtung: trotzdem
müssen Sie auch hier Bytes pro Sekunde übergeben! Beispiele:</p></div>
<table class="table-responsive table-bordered table tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead><tr>
<th class="tableblock halign-left valign-top">Aufruf</th>
<th class="tableblock halign-left valign-top">Ausgabe</th>
</tr></thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">render.nicspeed(12500000)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">100 MBit/s</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">render.nicspeed(100000000)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">800 MBit/s</p></td>
</tr>
</tbody>
</table>
<div class="paragraph"><p><code>render.networkbandwidth()</code> ist für eine tatsächlich gemessene
Übertragungsgeschwindigkeit im Netzwerk. Eingabewert sind wieder Bytes pro
Sekunde (Oder „Oktette“, wie der Netzwerker sagen würde):</p></div>
<table class="table-responsive table-bordered table tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead><tr>
<th class="tableblock halign-left valign-top">Aufruf</th>
<th class="tableblock halign-left valign-top">Ausgabe</th>
</tr></thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">render.networkbandwidth(123)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">984 Bit/s</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">render.networkbandwidth(123456)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">988 kBit/s</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">render.networkbandwidth(123456789)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">988 MBit/s</p></td>
</tr>
</tbody>
</table>
<div class="paragraph"><p>Wo es nicht ums Netzwerk geht und dennoch Datenraten ausgegeben werden,
sind wieder Bytes üblich. Prominentester Fall sind IO-Raten von Festplatten.
Dafür gibt es die Renderfunktion <code>render.iobandwidth()</code>, die in
Checkmk mit 1000’er-Potzenzen arbeitet:</p></div>
<table class="table-responsive table-bordered table tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead><tr>
<th class="tableblock halign-left valign-top">Aufruf</th>
<th class="tableblock halign-left valign-top">Ausgabe</th>
</tr></thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">render.iobandwidth(123)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">123 B/s</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">render.iobandwidth(123456)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">123 kB/s</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">render.iobandwidth(123456789)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">123 MB/s</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect2">
<h3 id="heading__prozentwerte">
<span class="hidden-anchor sr-only" id="_prozentwerte"></span>9.5. Prozentwerte</h3>
<div class="paragraph"><p>Die Funktion <code>render.percent()</code> stellt einen Prozentwert dar — auf zwei Nachkommastellen gerundet. Es ist insofern eine Ausnahme zu
den anderen Funktionen, als hier nicht der eigentlich natürliche Wert — also das Verhältnis — übergeben wird, sondern wirklich die Prozentzahl.
Wenn also etwas z.B. zur Hälfte voll ist, müssen Sie nicht 0.5 sondern 50 übergeben.</p></div>
<div class="paragraph"><p>Weil es manchmal interessant sein kann zu wissen, ob ein Wert beinahe Null
oder exakt Null ist, werden Werte durch Anfügen eines „&lt;“ Zeichens markiert,
die größer als Null, aber kleiner als 0.01 sind.</p></div>
<table class="table-responsive table-bordered table tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead><tr>
<th class="tableblock halign-left valign-top">Aufruf</th>
<th class="tableblock halign-left valign-top">Ausgabe</th>
</tr></thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">render.percent(0.004)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">&lt;0.01%</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">render.percent(18.5)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">18.50%</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">render.percent(123)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">123.00%</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect2">
<h3 id="heading__zusammenfassung_2">
<span class="hidden-anchor sr-only" id="_zusammenfassung_2"></span>9.6. Zusammenfassung</h3>
<div class="paragraph"><p>Hier ist nochmal eine Übersicht über alle Renderfunktionen:</p></div>
<table class="table-responsive table-bordered table tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 10%;">
<col style="width: 10%;">
<col style="width: 40%;">
<col style="width: 40%;">
</colgroup>
<thead><tr>
<th class="tableblock halign-left valign-top">Funktion</th>
<th class="tableblock halign-left valign-top">Eingabe</th>
<th class="tableblock halign-left valign-top">Beschreibung</th>
<th class="tableblock halign-left valign-top">Beispielausgabe</th>
</tr></thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">date</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Epoche</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Datum</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Dec 18 1970</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">datetime</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Epoche</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Datum und Uhrzeit</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Dec 18 1970 10:40:00</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">timespan</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Sekunden</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Dauer / Alter</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3d 5m</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">frequency</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Hz</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Frequenz (z.B. Taktrate)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">110 MHz</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">disksize</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Bytes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Größe von Festplatte, Basis 1000</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1,234 GB</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">filesize</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Bytes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Größe von Dateien, volle Genauigkeit</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1,334,560 B</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">bytes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Bytes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Größe in Bytes, Basis 1024</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">23,4 KiB</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">nicspeed</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Octets/sec</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Geschwindigkeit von Netzwerkkarten</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">100 MBit/s</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">networkbandwidth</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Octets/sec</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Übertragungsgeschwindigkeit</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">23.50 GBit/s</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">iobandwidth</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Bytes/sec</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">IO-Bandbreiten</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">124 MB/s</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">percent</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Prozent</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Prozentwert, sinnvoll gerundet</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">99.997%</p></td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="heading_parameters">
<span class="hidden-anchor sr-only" id="parameters"></span>10. Schwellwerte und Checkparameter</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="heading__ein_regelsatz_für_das_setup">
<span class="hidden-anchor sr-only" id="_ein_regelsatz_für_das_setup"></span>10.1. Ein Regelsatz für das Setup</h3>
<div class="paragraph"><p>In einem unserer bisherigen Beispiele haben wir den Zustand <span class="state1">WARN</span>
erzeugt, falls nur noch 10 oder weniger Slots frei waren. Dabei war die
Zahl <code>10</code> direkt in der Checkfunktion fest einprogrammiert - hart codiert,
wie Programmierer sagen würden. In Checkmk ist man allerdings als Anwender
eher gewohnt, dass man solche Schwellwerte und Parameter per <em>Regel</em>
konfigurieren kann. Deswegen wollen wir uns als nächstes ansehen, wie
auch Sie Ihren Check so verbessern können, dass er über die Setup-Oberfläche
konfigurierbar ist.</p></div>
<div class="paragraph"><p>Dazu müssen wir zwei Fälle unterscheiden:</p></div>
<div class="olist arabic"><ol class="arabic">
<li><p>Es gibt bereits einen passenden Regelsatz. Das kann eigentlich nur dann der Fall sein, wenn Ihr neuer Check etwas prüft, für das Checkmk in gleicher Form bereits Checkplugins hat, z.B. das Überwachen einer Temperatur. Dafür gibt es bereits einen Regelsatz, den Sie direkt verwenden können.</p></li>
<li><p>Es gibt keinen passenden Regelsatz. Dann müssen Sie einen neuen anlegen.</p></li>
</ol></div>
</div>
<div class="sect2">
<h3 id="heading__verwenden_von_vorhandenen_regelsätzen">
<span class="hidden-anchor sr-only" id="_verwenden_von_vorhandenen_regelsätzen"></span>10.2. Verwenden von vorhandenen Regelsätzen</h3>
<div class="paragraph"><p>Die ausgelieferten Regelsätze für Parameter von Checks finden Sie
im Verzeichnis <code>lib/check_mk/gui/plugins/wato/check_parameters/</code>.
Nehmen wir als Beispiel die Datei <code>memory_simple.py</code>. Diese
deklariert einen Regelsatz mit folgendem Abschnitt:</p></div>
<div class="listingblock">
<div class="title">lib/check_mk/gui/plugins/wato/check_parameters/memory_simple.py</div>
<div class="content"><pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-n">rulespec_registry</span><span class="tok-o">.</span><span class="tok-n">register</span><span class="tok-p">(</span>
    <span class="tok-n">CheckParameterRulespecWithItem</span><span class="tok-p">(</span>
        <span class="tok-n">check_group_name</span><span class="tok-o">=</span><span class="tok-s2">"memory_simple"</span><span class="tok-p">,</span>
        <span class="tok-n">group</span><span class="tok-o">=</span><span class="tok-n">RulespecGroupCheckParametersOperatingSystem</span><span class="tok-p">,</span>
        <span class="tok-n">item_spec</span><span class="tok-o">=</span><span class="tok-n">_item_spec_memory_simple</span><span class="tok-p">,</span>
        <span class="tok-n">match_type</span><span class="tok-o">=</span><span class="tok-s2">"dict"</span><span class="tok-p">,</span>
        <span class="tok-n">parameter_valuespec</span><span class="tok-o">=</span><span class="tok-n">_parameter_valuespec_memory_simple</span><span class="tok-p">,</span>
        <span class="tok-n">title</span><span class="tok-o">=</span><span class="tok-k">lambda</span><span class="tok-p">:</span> <span class="tok-n">_</span><span class="tok-p">(</span><span class="tok-s2">"Main memory usage of simple devices"</span><span class="tok-p">),</span>
    <span class="tok-p">))</span></code></pre></div>
</div>
<div class="paragraph"><p>Entscheidend für Sie ist dabei das Schlüsselwort <code>check_group_name</code>,
welches hier auf <code>"memory_simple"</code> gesetzt ist. Damit wird die Verbindung
zum Checkplugin hergestellt. Das machen Sie beim Registrieren des Checks
mit dem Schlüsselwort <code>check_ruleset_name</code>, zum Beispiel:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-n">register</span><span class="tok-o">.</span><span class="tok-n">check_plugin</span><span class="tok-p">(</span>
    <span class="tok-n">name</span> <span class="tok-o">=</span> <span class="tok-s2">"foobar"</span><span class="tok-p">,</span>
    <span class="tok-n">service_name</span> <span class="tok-o">=</span> <span class="tok-s2">"Foobar Sector </span><span class="tok-si">%s</span><span class="tok-s2">"</span><span class="tok-p">,</span>
    <span class="tok-n">discovery_function</span> <span class="tok-o">=</span> <span class="tok-n">discover_foobar</span><span class="tok-p">,</span>
    <span class="tok-n">check_function</span> <span class="tok-o">=</span> <span class="tok-n">check_foobar</span><span class="tok-p">,</span>
    <span class="tok-n">check_ruleset_name</span><span class="tok-o">=</span><span class="tok-s2">"memory_simple"</span><span class="tok-p">,</span>
    <span class="tok-n">check_default_parameters</span><span class="tok-o">=</span><span class="tok-p">{},</span>
<span class="tok-p">)</span></code></pre></div></div>
<div class="paragraph"><p>Zwingend notwendig ist dabei auch die Definition von Defaultparametern
über das Schlüsselwort <code>check_default_parameters</code>. Diese Parameter
gelten für Ihren Check dann, wenn der Benutzer noch keine Regel angelegt
hat. Falls es keine verpflichtenden Parameter gibt, können Sie einfach
das leere Dictionary <code>{}</code> als Wert nehmen.</p></div>
<div class="paragraph"><p>Wie der jeweils vom Benutzer konfigurierte Wert dann bei der Checkfunktion
ankommt, werden wir dann weiter unten sehen.</p></div>
</div>
<div class="sect2">
<h3 id="heading__einen_eigenen_regelsatz_definieren">
<span class="hidden-anchor sr-only" id="_einen_eigenen_regelsatz_definieren"></span>10.3. Einen eigenen Regelsatz definieren</h3>
<div class="paragraph"><p>Falls es keinen passenden Regelsatz gibt (was wohl eher der Normalfall
ist), müssen wir uns selbst einen neuen erzeugen. Dazu legen wir
eine Datei im Verzeichnis <code>local/share/check_mk/web/plugins/wato</code>
an. Der Name der Datei sollte sich an dem des Checks orientieren und
er muss wie alle Plugindateien die Endung <code>.py</code> haben.</p></div>
<div class="paragraph"><p>Sehen wir uns den Aufbau so einer Datei Schritt für Schritt an.
Zunächst kommen einige Importbefehle. Falls die Texte in Ihrer
Datei in andere Sprachen übersetzbar sein sollen, importieren
Sie <code>_</code> (Unterstrich). Dies ist eine Funktion und fungiert als Markierung
für alle übersetzbaren
Texte. Im Weiteren schreiben Sie dann z.B. anstelle
von <code>"Threshold for warn"</code> ein <code>_("Threshold for warn")</code> für den Funktionsaufruf.</p></div>
<div class="paragraph"><p>Das Übersetzungssystem von Checkmk, welches auf
<a href="https://docs.python.org/3/library/gettext.html#module-gettext">gettext</a>
basiert, findet
solche Texte und übernimmt sie in die Liste der zu übersetzenden Texte
auf. Falls Sie den Check nur für sich selbst bauen, können Sie darauf
auch verzichten und brauchen den folgenden Importbefehl nicht:</p></div>
<div class="listingblock">
<div class="title">local/share/check_mk/web/plugins/wato/foobar_parameters.py</div>
<div class="content"><pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-kn">from</span> <span class="tok-nn">cmk.gui.i18n</span> <span class="tok-kn">import</span> <span class="tok-n">_</span></code></pre></div>
</div>
<div class="paragraph"><p>Als nächstes importieren wir sogenannte <em>ValueSpecs</em>. Ein ValueSpec
ist ein sehr praktisches und universelles Werkzeug, das Checkmk an vielen
Stellen verwendet. Es dient dem Generieren von angepassten Eingabemasken,
der Darstellung und Validierung der eingegebenen Werte und der Umwandlung
in Python-Datenstrukturen. In folgendem Beispiel werden <code>Dictionary</code>,
<code>Integer</code> und <code>TextInput</code> importiert.</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-kn">from</span> <span class="tok-nn">cmk.gui.valuespec</span> <span class="tok-kn">import</span> <span class="tok-p">(</span>
    <span class="tok-n">Dictionary</span><span class="tok-p">,</span>
    <span class="tok-n">Integer</span><span class="tok-p">,</span>
    <span class="tok-n">TextInput</span><span class="tok-p">,</span>
<span class="tok-p">)</span></code></pre></div></div>
<div class="paragraph"><p>Das <code>Dictionary</code> benötigen Sie auf jeden Fall. Denn seit Version
<span class="new">2.0.0</span> von Checkmk ist es zwingend vorgeschrieben, dass Checkparameter
Python-Dictionaries sein müssen. Früher konnte es z.B. auch ein Paar (Tupel
aus zwei Zahlen) sein (z.B. Warn/Crit).</p></div>
<div class="paragraph"><p><code>Integer</code> ist für die Eingabe einer Zahl ohne Kommastellen
verantwortlich und <code>TextInput</code> für einen Unicode-Text.</p></div>
<div class="paragraph"><p>Als nächstes werden noch Symbole importiert, die beim Registrieren
benötigt werden:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-kn">from</span> <span class="tok-nn">cmk.gui.plugins.wato</span> <span class="tok-kn">import</span> <span class="tok-p">(</span>
    <span class="tok-n">CheckParameterRulespecWithItem</span><span class="tok-p">,</span>
    <span class="tok-n">rulespec_registry</span><span class="tok-p">,</span>
    <span class="tok-n">RulespecGroupCheckParametersOperatingSystem</span><span class="tok-p">,</span>
<span class="tok-p">)</span></code></pre></div></div>
<div class="paragraph"><p>Falls Ihr Check kein Item hat, importieren Sie stattdessen
<code>CheckParameterRulespecWithoutItem</code>. Zur <code>RulespecGroup</code>…​.
schreiben wir weiter unten noch etwas.</p></div>
<div class="paragraph"><p>Nun kommen die eigentlichen Definitionen. Zunächst deklarieren wir
ein Eingabefeld, mit dem der Benutzer das <em>Item</em> des Checks angeben
kann. Dies ist für die Regelbedingung notwendig, und auch für das manuelle
Anlegen von Checks, welche ohne Discovery funktionieren sollen. Das erledigen
wir mit <code>TextInput</code>. Dieses bekommt per <code>title</code> einen Titel
zugewiesen, welcher dann in der Regel als Überschrift für das Eingabefeld
angezeigt wird:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">def</span> <span class="tok-nf">_item_valuespec_foobar</span><span class="tok-p">():</span>
    <span class="tok-k">return</span> <span class="tok-n">TextInput</span><span class="tok-p">(</span><span class="tok-n">title</span><span class="tok-o">=</span><span class="tok-n">_</span><span class="tok-p">(</span><span class="tok-s2">"Sector name"</span><span class="tok-p">))</span></code></pre></div></div>
<div class="paragraph"><p>Den Namen der Funktion, welche diese ValueSpec zurückgibt, können
Sie frei wählen, er wird nur an der Stelle weiter unten benötigt.
Damit er nicht über die Modulgrenze hinaus sichtbar wird, sollte er
mit einem Unterstrich beginnen.</p></div>
<div class="paragraph"><p>Als nächstes kommt das ValueSpec für die Eingabe des eigentlichen
Checkparameters. Auch hierfür legen wir eine Funktion an, welche
dieses erzeugt. Das <code>return Dictionary(…​)</code> ist vorgeschrieben.
Innerhalb dessen legen Sie mit <code>elements=[…​]</code> die Liste
der Unterparameter für diesen Check an. In unserem Beispiel gibt
es nur einen: die Warnschwelle für die freien Slots. Dies soll
eine Ganzzahl sein, also verwenden wir hier ein <code>Integer</code>.</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">def</span> <span class="tok-nf">_parameter_valuespec_foobar</span><span class="tok-p">():</span>
    <span class="tok-k">return</span> <span class="tok-n">Dictionary</span><span class="tok-p">(</span>
        <span class="tok-n">elements</span><span class="tok-o">=</span><span class="tok-p">[</span>
            <span class="tok-p">(</span><span class="tok-s2">"warning_lower"</span><span class="tok-p">,</span> <span class="tok-n">Integer</span><span class="tok-p">(</span><span class="tok-n">title</span><span class="tok-o">=</span><span class="tok-n">_</span><span class="tok-p">(</span><span class="tok-s2">"Warning below free slots"</span><span class="tok-p">))),</span>
        <span class="tok-p">],</span>
    <span class="tok-p">)</span></code></pre></div></div>
<div class="paragraph"><p>Zu guter Letzt registrieren wir jetzt mithilfe der importierten und
selbstdefinierten Dinge einen neuen Regelsatz. Dazu gibt es die
Funktion <code>rulespec_registry.register()</code>:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-n">rulespec_registry</span><span class="tok-o">.</span><span class="tok-n">register</span><span class="tok-p">(</span>
    <span class="tok-n">CheckParameterRulespecWithItem</span><span class="tok-p">(</span>
        <span class="tok-n">check_group_name</span><span class="tok-o">=</span><span class="tok-s2">"foobar"</span><span class="tok-p">,</span>
        <span class="tok-n">group</span><span class="tok-o">=</span><span class="tok-n">RulespecGroupCheckParametersOperatingSystem</span><span class="tok-p">,</span>
        <span class="tok-n">match_type</span><span class="tok-o">=</span><span class="tok-s2">"dict"</span><span class="tok-p">,</span>
        <span class="tok-n">item_spec</span><span class="tok-o">=</span><span class="tok-n">_item_valuespec_foobar</span><span class="tok-p">,</span>
        <span class="tok-n">parameter_valuespec</span><span class="tok-o">=</span><span class="tok-n">_parameter_valuespec_foobar</span><span class="tok-p">,</span>
        <span class="tok-n">title</span><span class="tok-o">=</span><span class="tok-k">lambda</span><span class="tok-p">:</span> <span class="tok-n">_</span><span class="tok-p">(</span><span class="tok-s2">"Free slots for Foobar sectors"</span><span class="tok-p">),</span>
    <span class="tok-p">))</span></code></pre></div></div>
<div class="paragraph"><p>Dazu noch einige Hinweise:</p></div>
<div class="ulist"><ul>
<li><p>Falls Ihr Check kein Item verwendet, lautet die innere Funktion <code>CheckParameterRulespecWithoutItem</code>. Die Zeile <code>item_spec</code> entfällt dann.</p></li>
<li><p>Wie oben erwähnt stellt der <code>check_group_name</code> die Verbindung zu den Checks her, welche diese Regel verwenden sollen. Er darf auf keinen Fall identisch sein mit einer bereits existierenden Regel, weil diese damit überschrieben würde.</p></li>
<li><p>Die <code>group</code> legt fest, in welcher Kategorie im Setup der Regelsatz auftauchen soll. Die meisten dieser Gruppen sind in der Datei <code>lib/check_mk/gui/plugins/wato/utils/<em>init</em>.py</code> definiert. Dort finden Sie auch Beispiele, wie Sie eine eigene neue Gruppe anlegen können.</p></li>
<li><p>Der <code>match_type</code> ist immer <code>"dict"</code>. In älteren Checkmk-Versionen gab es auch Parameterregeln mit anderen Typen.</p></li>
<li><p><code>title</code> legt den Titel des Regelsatzes fest, wird aber nicht direkt als Text, sondern als ausführbare Funktion angegeben, welche den Text zurückliefert (deswegen das <code>lambda:</code>).</p></li>
</ul></div>
<div class="sect3">
<h4 id="heading__test">
<span class="hidden-anchor sr-only" id="_test"></span>Test</h4>
<div class="paragraph"><p>Wenn Sie diese Datei angelegt haben, sollten Sie erstmal ausprobieren, ob alles soweit
funktioniert und nicht gleich mit der Checkfunktion weiterarbeiten. Dazu müssen
Sie erstmal den Apache der Instanz neu starten, damit die neue Datei gelesen wird.
Das macht der Befehl:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="console"><span></span><span class="tok-gp">OMD[mysite]:~$ </span>omd<span class="tok-w"> </span>restart<span class="tok-w"> </span>apache</code></pre></div></div>
<div class="paragraph"><p>Danach sollte der Regelsatz im Setup zu finden sein. Legen Sie eine Regel
in dieser Kette an und probieren Sie verschiedene Werte aus. Wenn
das ohne Fehler geht, können Sie die Checkparameter jetzt in der Checkfunktion
verwenden.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="heading__die_regel_im_checkplugin_benutzen">
<span class="hidden-anchor sr-only" id="_die_regel_im_checkplugin_benutzen"></span>10.4. Die Regel im Checkplugin benutzen</h3>
<div class="paragraph"><p>Damit die Regel zum Greifen kommt, müssen wir dem Checkplugin erlauben,
Checkparameter entgegenzunehmen und ihm sagen, welche Regel benutzt
werden soll. Dazu muss bei der Registrierung der Eintrag <code>check_default_parameters</code>
unbedingt vorhanden sein. Im einfachsten Fall übergeben wir ein leeres Dictionary.</p></div>
<div class="paragraph"><p>Als zweites übergeben wir der Registrierungsfunktion noch den
<code>check_ruleset_name</code>, also den Namen, den wir oben mittels
<code>check_group_name</code> an den Regelsatz vergeben haben. So weiß Checkmk
aus welchem Regelsatz die Parameter bestimmt werden sollen.</p></div>
<div class="paragraph"><p>Das Ganze sieht dann z.B. so aus:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-n">register</span><span class="tok-o">.</span><span class="tok-n">check_plugin</span><span class="tok-p">(</span>
    <span class="tok-n">name</span> <span class="tok-o">=</span> <span class="tok-s2">"foobar"</span><span class="tok-p">,</span>
    <span class="tok-n">service_name</span> <span class="tok-o">=</span> <span class="tok-s2">"Foobar Sector </span><span class="tok-si">%s</span><span class="tok-s2">"</span><span class="tok-p">,</span>
    <span class="tok-n">discovery_function</span> <span class="tok-o">=</span> <span class="tok-n">discover_foobar</span><span class="tok-p">,</span>
    <span class="tok-n">check_function</span> <span class="tok-o">=</span> <span class="tok-n">check_foobar</span><span class="tok-p">,</span>
    <span class="tok-n">check_default_parameters</span><span class="tok-o">=</span><span class="tok-p">{},</span>
    <span class="tok-n">check_ruleset_name</span><span class="tok-o">=</span><span class="tok-s2">"foobar"</span><span class="tok-p">,</span>
<span class="tok-p">)</span></code></pre></div></div>
<div class="paragraph"><p>Nun wird Checkmk versuchen, der Checkfunktion Parameter zu übergeben. Damit
das klappen kann, müssen wir die Checkfunktion so erweitern, dass sie als
zweites das Argument <code>params</code> erwartet. Diese schiebt sich zwischen
<code>item</code> und <code>section</code> (Falls Sie einen Check ohne Item bauen,
entfällt das <code>item</code> natürlich und <code>params</code> steht am Anfang):</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">def</span> <span class="tok-nf">check_foobar</span><span class="tok-p">(</span><span class="tok-n">item</span><span class="tok-p">,</span> <span class="tok-n">params</span><span class="tok-p">,</span> <span class="tok-n">section</span><span class="tok-p">):</span></code></pre></div></div>
<div class="paragraph"><p>Es ist sehr empfehlenswert, sich jetzt als ersten Test den
Inhalt der Variable <code>params</code> mit einem <code>print</code>
ausgeben zu lassen (oder <code>pprint</code>, wenn Sie es etwas
komfortabler haben wollen). Legen Sie verschiedene Regeln an, probieren
Sie, welche Werte bei <code>params</code> ankommen:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">def</span> <span class="tok-nf">check_foobar</span><span class="tok-p">(</span><span class="tok-n">item</span><span class="tok-p">,</span> <span class="tok-n">params</span><span class="tok-p">,</span> <span class="tok-n">section</span><span class="tok-p">):</span>
    <span class="tok-nb">print</span><span class="tok-p">(</span><span class="tok-n">params</span><span class="tok-p">)</span>
    <span class="tok-k">for</span> <span class="tok-n">sector</span><span class="tok-p">,</span> <span class="tok-n">used</span><span class="tok-p">,</span> <span class="tok-n">slots</span> <span class="tok-ow">in</span> <span class="tok-o">...</span></code></pre></div></div>
<div class="paragraph"><p>Und ganz wichtig: Wenn alles fertig ist, entfernen Sie unbedingt die
<code>print</code>-Befehle wieder! Diese können die interne Kommunikation
von Checkmk durcheinanderbringen.</p></div>
<div class="paragraph"><p>Nun passen wir unsere Checkfunktion an, so dass der übergebene Parameter
seine Wirkung entfalten kann. Wir holen uns den Wert mit dem in der Regel
gewählten Key (hier <code>"warning_lower"</code>) aus den Parametern:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">def</span> <span class="tok-nf">check_foobar</span><span class="tok-p">(</span><span class="tok-n">item</span><span class="tok-p">,</span> <span class="tok-n">params</span><span class="tok-p">,</span> <span class="tok-n">section</span><span class="tok-p">):</span>
    <span class="tok-n">warn</span> <span class="tok-o">=</span> <span class="tok-n">params</span><span class="tok-p">[</span><span class="tok-s2">"warning_lower"</span><span class="tok-p">]</span>
    <span class="tok-k">for</span> <span class="tok-n">sector</span><span class="tok-p">,</span> <span class="tok-n">used</span><span class="tok-p">,</span> <span class="tok-n">slots</span> <span class="tok-ow">in</span> <span class="tok-n">section</span><span class="tok-p">:</span>
        <span class="tok-k">if</span> <span class="tok-n">sector</span> <span class="tok-o">==</span> <span class="tok-n">item</span><span class="tok-p">:</span>
            <span class="tok-n">used</span> <span class="tok-o">=</span> <span class="tok-nb">int</span><span class="tok-p">(</span><span class="tok-n">used</span><span class="tok-p">)</span>    <span class="tok-c1"># convert string to int</span>
            <span class="tok-n">slots</span> <span class="tok-o">=</span> <span class="tok-nb">int</span><span class="tok-p">(</span><span class="tok-n">slots</span><span class="tok-p">)</span>  <span class="tok-c1"># convert string to int</span>
            <span class="tok-k">if</span> <span class="tok-n">used</span> <span class="tok-o">==</span> <span class="tok-n">slots</span><span class="tok-p">:</span>
                <span class="tok-n">s</span> <span class="tok-o">=</span> <span class="tok-n">State</span><span class="tok-o">.</span><span class="tok-n">CRIT</span>
            <span class="tok-k">elif</span> <span class="tok-n">slots</span> <span class="tok-o">-</span> <span class="tok-n">used</span> <span class="tok-o">&lt;=</span> <span class="tok-n">warn</span><span class="tok-p">:</span>
                <span class="tok-n">s</span> <span class="tok-o">=</span> <span class="tok-n">State</span><span class="tok-o">.</span><span class="tok-n">WARN</span>
            <span class="tok-k">else</span><span class="tok-p">:</span>
                <span class="tok-n">s</span> <span class="tok-o">=</span> <span class="tok-n">State</span><span class="tok-o">.</span><span class="tok-n">OK</span>
            <span class="tok-k">yield</span> <span class="tok-n">Result</span><span class="tok-p">(</span>
                <span class="tok-n">state</span> <span class="tok-o">=</span> <span class="tok-n">s</span><span class="tok-p">,</span>
                <span class="tok-n">summary</span> <span class="tok-o">=</span> <span class="tok-sa">f</span><span class="tok-s2">"used </span><span class="tok-si">{</span><span class="tok-n">used</span><span class="tok-si">}</span><span class="tok-s2"> out of </span><span class="tok-si">{</span><span class="tok-n">slots</span><span class="tok-si">}</span><span class="tok-s2"> slots"</span><span class="tok-p">)</span>
            <span class="tok-k">return</span></code></pre></div></div>
<div class="paragraph"><p>Falls eine Regel konfiguriert ist, können wir nun die „freien Slots“ in
unserem Beispiel überwachen. Wenn allerdings keine Regel definiert ist,
wird diese Checkfunktion crashen: Da die Default-Parameter des Plugins nicht
befüllt sind, wird das Plugin bei Abwesenheit einer Regel einen <code>KeyError</code>
erzeugen.</p></div>
<div class="paragraph"><p>Dieses Problem können wir beheben, indem wir bei der Registrierung einen
passenden Parameter einfügen:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-n">register</span><span class="tok-o">.</span><span class="tok-n">check_plugin</span><span class="tok-p">(</span>
    <span class="tok-n">name</span> <span class="tok-o">=</span> <span class="tok-s2">"foobar"</span><span class="tok-p">,</span>
    <span class="tok-n">service_name</span> <span class="tok-o">=</span> <span class="tok-s2">"Foobar Sector </span><span class="tok-si">%s</span><span class="tok-s2">"</span><span class="tok-p">,</span>
    <span class="tok-n">discovery_function</span> <span class="tok-o">=</span> <span class="tok-n">discover_foobar</span><span class="tok-p">,</span>
    <span class="tok-n">check_function</span> <span class="tok-o">=</span> <span class="tok-n">check_foobar</span><span class="tok-p">,</span>
    <span class="tok-n">check_default_parameters</span> <span class="tok-o">=</span> <span class="tok-p">{</span><span class="tok-s2">"warning_lower"</span><span class="tok-p">:</span> <span class="tok-mi">10</span><span class="tok-p">},</span>
    <span class="tok-n">check_ruleset_name</span> <span class="tok-o">=</span> <span class="tok-s2">"foobar"</span><span class="tok-p">,</span>
<span class="tok-p">)</span></code></pre></div></div>
<div class="paragraph"><p>Sie sollten Defaultwerte immer auf diese Weise übergeben (und den Fall
fehlender Parameter nicht im Checkplugin abfangen), da diese Defaultparameter
auch in der Setup-Oberfläche angezeigt werden können. Dazu gibt es z.B.
auf der Servicekonfigurationsseite eines Hosts im Menu <span class="guihint">Display</span> den Eintrag <span class="guihint">Show Check parameters</span>.</p></div>
<div class="paragraph"><p>Ein einzelner Wert als Schwellwert ist in Checkmk übrigens sehr unüblich. Da
Services in den Zuständen <span class="state0">OK</span>, <span class="state1">WARN</span>, <span class="state2">CRIT</span> sein können, ist es
naheliegend die Parameter immer als <code>Tuple</code> mit zwei Einträgen zu
definieren, also als Paar von Schwellen für <span class="state1">WARN</span> und <span class="state2">CRIT</span>. Dazu passen
wir den Regelsatz wie folgt an:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">def</span> <span class="tok-nf">_parameter_valuespec_foobar</span><span class="tok-p">():</span>
    <span class="tok-k">return</span> <span class="tok-n">Dictionary</span><span class="tok-p">(</span>
        <span class="tok-n">elements</span><span class="tok-o">=</span><span class="tok-p">[</span>
            <span class="tok-p">(</span><span class="tok-s2">"warning_lower"</span><span class="tok-p">,</span> <span class="tok-n">Tuple</span><span class="tok-p">(</span>
                <span class="tok-n">title</span><span class="tok-o">=</span><span class="tok-n">_</span><span class="tok-p">(</span><span class="tok-s2">"Levels on free slots"</span><span class="tok-p">),</span>
                <span class="tok-n">elements</span><span class="tok-o">=</span><span class="tok-p">[</span>
                    <span class="tok-n">Integer</span><span class="tok-p">(</span><span class="tok-n">title</span><span class="tok-o">=</span><span class="tok-n">_</span><span class="tok-p">(</span><span class="tok-s2">"Warning below"</span><span class="tok-p">)),</span>
                    <span class="tok-n">Integer</span><span class="tok-p">(</span><span class="tok-n">title</span><span class="tok-o">=</span><span class="tok-n">_</span><span class="tok-p">(</span><span class="tok-s2">"Critical below"</span><span class="tok-p">)),</span>
                <span class="tok-p">],</span>
            <span class="tok-p">)),</span>
        <span class="tok-p">],</span>
    <span class="tok-p">)</span></code></pre></div></div>
<div class="paragraph"><p>Beachten Sie, dass eine solche Änderung des Datentyps eine inkompatible
Änderung darstellt: Existierende Regeln können jetzt nicht mehr von der
Oberfläche geladen werden. Und auch die Checkfunktion kann auf Probleme
stoßen, wenn anstelle eines erwarteten Paar von zwei Zahlen eine einzelne
Zahl in <code>params</code> steht. Sie können solche Regeln einfach editieren.
Beim erneuten Speichern wird dann das neue Format verwendet.</p></div>
</div>
<div class="sect2">
<h3 id="heading__weitere_valuespecs">
<span class="hidden-anchor sr-only" id="_weitere_valuespecs"></span>10.5. Weitere ValueSpecs</h3>
<div class="paragraph"><p>In Checkmk gibt es zahlreiche ValueSpecs für alle möglichen Situationen.
Hier sind noch ein paar nützliche:</p></div>
<div class="sect3">
<h4 id="heading__float">
<span class="hidden-anchor sr-only" id="_float"></span>Float</h4>
<div class="paragraph"><p><code>Float</code> ist wie <code>Integer</code>, erlaubt aber die Eingabe
von Zahlen mit Nachkommastellen.</p></div>
</div>
<div class="sect3">
<h4 id="heading__percentage">
<span class="hidden-anchor sr-only" id="_percentage"></span>Percentage</h4>
<div class="paragraph"><p>Oft möchte man Schwellen nicht in absoluten Zahlen, sondern in Prozent angeben.
Dazu gibt es das ValueSpec <code>Percentage</code>:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">def</span> <span class="tok-nf">_parameter_valuespec_foobar</span><span class="tok-p">():</span>
    <span class="tok-k">return</span> <span class="tok-n">Dictionary</span><span class="tok-p">(</span>
        <span class="tok-n">elements</span><span class="tok-o">=</span><span class="tok-p">[</span>
            <span class="tok-p">(</span><span class="tok-s2">"levels_percent"</span><span class="tok-p">,</span> <span class="tok-n">Tuple</span><span class="tok-p">(</span>
                <span class="tok-n">title</span><span class="tok-o">=</span><span class="tok-n">_</span><span class="tok-p">(</span><span class="tok-s2">"Relative levels"</span><span class="tok-p">),</span>
                <span class="tok-n">elements</span><span class="tok-o">=</span><span class="tok-p">[</span>
                    <span class="tok-n">Percentage</span><span class="tok-p">(</span><span class="tok-n">title</span><span class="tok-o">=</span><span class="tok-n">_</span><span class="tok-p">(</span><span class="tok-s2">"Warning at"</span><span class="tok-p">),</span> <span class="tok-n">default_value</span><span class="tok-o">=</span><span class="tok-mi">80</span><span class="tok-p">),</span>
                    <span class="tok-n">Percentage</span><span class="tok-p">(</span><span class="tok-n">title</span><span class="tok-o">=</span><span class="tok-n">_</span><span class="tok-p">(</span><span class="tok-s2">"Critical at"</span><span class="tok-p">),</span> <span class="tok-n">default_value</span><span class="tok-o">=</span><span class="tok-mi">90</span><span class="tok-p">)</span>
                <span class="tok-p">],</span>
            <span class="tok-p">)),</span>
        <span class="tok-p">],</span>
    <span class="tok-p">)</span></code></pre></div></div>
<div class="paragraph"><p>Bei dieser ValueSpec würde das Checkplugin die Parameter <code>{"levels_percent":
(80.0, 90.0)}</code> übergeben bekommen.</p></div>
</div>
<div class="sect3">
<h4 id="heading__monitoringstate">
<span class="hidden-anchor sr-only" id="_monitoringstate"></span>MonitoringState</h4>
<div class="paragraph"><p>Der <code>MonitoringState</code> ist nützlich, wenn Sie dem Benutzer erlauben
wollen, für verschiedene Situationen jeweils einen der Zustände <span class="state0">OK</span>,
<span class="state1">WARN</span>, <span class="state2">CRIT</span> und <span class="state3">UNKNOWN</span> auszuwählen. Es bietet dem Benutzer ein
Dropdownfeld mit eben diesen vier Möglichkeiten, welche dann umgesetzt
werden in eine der Zahlen <code>0</code>, <code>1</code>, <code>2</code> oder <code>3</code>.</p></div>
<div class="paragraph"><p>Hier können Sie z.B.  einstellen, welchen Zustand der Service bekommen soll,
falls kein Backup konfiguriert bzw. vorhanden ist:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">def</span> <span class="tok-nf">_parameter_valuespec_plesk_backups</span><span class="tok-p">():</span>
    <span class="tok-k">return</span> <span class="tok-n">Dictionary</span><span class="tok-p">(</span>
        <span class="tok-n">help</span><span class="tok-o">=</span><span class="tok-n">_</span><span class="tok-p">(</span><span class="tok-s2">"This check monitors backups configured for domains in plesk."</span><span class="tok-p">),</span>
        <span class="tok-n">elements</span><span class="tok-o">=</span><span class="tok-p">[</span>
            <span class="tok-p">(</span><span class="tok-s2">"no_backup_configured_state"</span><span class="tok-p">,</span>
             <span class="tok-n">MonitoringState</span><span class="tok-p">(</span><span class="tok-n">title</span><span class="tok-o">=</span><span class="tok-n">_</span><span class="tok-p">(</span><span class="tok-s2">"State when no backup is configured"</span><span class="tok-p">),</span> <span class="tok-n">default_value</span><span class="tok-o">=</span><span class="tok-mi">1</span><span class="tok-p">)),</span>
            <span class="tok-p">(</span><span class="tok-s2">"no_backup_found_state"</span><span class="tok-p">,</span>
             <span class="tok-n">MonitoringState</span><span class="tok-p">(</span><span class="tok-n">title</span><span class="tok-o">=</span><span class="tok-n">_</span><span class="tok-p">(</span><span class="tok-s2">"State when no backup can be found"</span><span class="tok-p">),</span> <span class="tok-n">default_value</span><span class="tok-o">=</span><span class="tok-mi">1</span><span class="tok-p">)),</span>
        <span class="tok-o">...</span></code></pre></div></div>
<div class="paragraph"><p>Bei dieser ValueSpec würde das Checkplugin die Parameter
<code>{"no_backup_configured_state": 1, "no_backup_found_state": 1}</code> übergeben
bekommen, falls in beiden Fällen der Default von <span class="state1">WARN</span> (=1) übernommen wurde.
Sie können die Zahl einfach in ein <code>State</code> Objekt umwandeln, indem Sie es
der Funktion <code>State()</code> übergeben:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="python"><span></span>    <span class="tok-k">yield</span> <span class="tok-n">Result</span><span class="tok-p">(</span>
        <span class="tok-n">state</span><span class="tok-o">=</span><span class="tok-n">State</span><span class="tok-p">(</span><span class="tok-n">params</span><span class="tok-p">[</span><span class="tok-s2">"no_backup_configured_state"</span><span class="tok-p">]),</span>
        <span class="tok-n">summary</span><span class="tok-o">=</span><span class="tok-s2">"No backup is configured!"</span><span class="tok-p">,</span>
    <span class="tok-p">)</span></code></pre></div></div>
</div>
<div class="sect3">
<h4 id="heading__age">
<span class="hidden-anchor sr-only" id="_age"></span>Age</h4>
<div class="paragraph"><p>Das Feld <code>Age</code> erlaubt die Eingabe eines Alters, welches intern
als Anzahl von Sekunden gespeichert und übergeben wird:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">def</span> <span class="tok-nf">_parameter_valuespec_antivir_update_age</span><span class="tok-p">():</span>
    <span class="tok-k">return</span> <span class="tok-n">Tuple</span><span class="tok-p">(</span><span class="tok-n">elements</span><span class="tok-o">=</span><span class="tok-p">[</span>
        <span class="tok-n">Age</span><span class="tok-p">(</span><span class="tok-n">title</span><span class="tok-o">=</span><span class="tok-n">_</span><span class="tok-p">(</span><span class="tok-s2">"Warning level for time since last update"</span><span class="tok-p">)),</span>
        <span class="tok-n">Age</span><span class="tok-p">(</span><span class="tok-n">title</span><span class="tok-o">=</span><span class="tok-n">_</span><span class="tok-p">(</span><span class="tok-s2">"Critical level for time since last update"</span><span class="tok-p">)),</span>
    <span class="tok-p">],)</span></code></pre></div></div>
</div>
<div class="sect3">
<h4 id="heading__filesize">
<span class="hidden-anchor sr-only" id="_filesize"></span>Filesize</h4>
<div class="paragraph"><p>Die ValueSpec <code>Filesize</code> erlaubt die Eingabe von Datei- (oder
Festplatten)größen. Intern wird mit Bytes gerechnet, aber der Benutzer
darf aus KB, MB, GB oder TB auswählen:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="python"><span></span>    <span class="tok-n">Tuple</span><span class="tok-p">(</span>
        <span class="tok-n">title</span><span class="tok-o">=</span><span class="tok-n">_</span><span class="tok-p">(</span><span class="tok-s2">"Maximum size of all files on backup space"</span><span class="tok-p">),</span>
        <span class="tok-n">help</span><span class="tok-o">=</span><span class="tok-n">_</span><span class="tok-p">(</span><span class="tok-s2">"The maximum size of all files on the backup space. "</span>
               <span class="tok-s2">"This might be set to the allowed quotas on the configured "</span>
               <span class="tok-s2">"FTP server to be notified if the space limit is reached."</span><span class="tok-p">),</span>
        <span class="tok-n">elements</span><span class="tok-o">=</span><span class="tok-p">[</span>
            <span class="tok-n">Filesize</span><span class="tok-p">(</span><span class="tok-n">title</span><span class="tok-o">=</span><span class="tok-n">_</span><span class="tok-p">(</span><span class="tok-s2">"Warning at"</span><span class="tok-p">)),</span>
            <span class="tok-n">Filesize</span><span class="tok-p">(</span><span class="tok-n">title</span><span class="tok-o">=</span><span class="tok-n">_</span><span class="tok-p">(</span><span class="tok-s2">"Critical at"</span><span class="tok-p">)),</span>
        <span class="tok-p">],</span>
    <span class="tok-p">),</span></code></pre></div></div>
<div class="paragraph"><p>Das Thema ValueSpecs ist extrem flexibel und umfangreich und
würde diesen Artikel sprengen. Bitte schauen Sie sich die
Beispiele der von Checkmk mitausgelieferten Regeldefinitionen in
<code>lib/check_mk/gui/plugins/wato/check_parameters/</code> an. Dort gibt es
mehr als 500 Dateien mit Beispielen.</p></div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="heading_metrics">
<span class="hidden-anchor sr-only" id="metrics"></span>11. Angepasste Darstellung von Metriken</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="heading__der_sinn_von_metrikdefinitionen">
<span class="hidden-anchor sr-only" id="_der_sinn_von_metrikdefinitionen"></span>11.1. Der Sinn von Metrikdefinitionen</h3>
<div class="paragraph"><p>In unserem obigen Beispiel haben wir das Plugin <code>foobar</code> die Metrik <code>fooslots</code>
erzeugen lassen. Metriken werden in der grafischen Oberfläche von Checkmk sofort
sichtbar, ohne dass Sie etwas dafür tun müssten.
Pro Metrik wird bei den Servicedetails automatisch ein Graph erzeugt.</p></div>
<div class="paragraph"><p>Allerdings gibt es dabei ein paar Einschränkungen:</p></div>
<div class="ulist"><ul>
<li><p>Es erscheint nicht automatisch ein „Perf-O-Meter“, also die grafische balkenartige Vorschau des Messwerts, wenn der Service in der Listendarstellung angezeigt wird (z.B. in der Ansicht, die alle Services eines Hosts darstellt).</p></li>
<li><p>Es werden nicht automatisch passende Metriken in einem Graphen kombiniert, sondern jede erscheint einzeln.</p></li>
<li><p>Die Metrik hat keinen richtigen Titel, sondern es wird der interne Variablenname der Metrik gezeigt.</p></li>
<li><p>Es wird keine Einheit verwendet, die eine sinnvolle Darstellung erlaubt (z.B. GB anstelle von einzelnen Bytes)</p></li>
<li><p>Es wir zufällig eine Farbe ausgewählt.</p></li>
</ul></div>
<div class="paragraph"><p>Um die Darstellung Ihrer Metriken in diesen Belangen zu vervollständigen,
benötigen Sie noch einige Definitionen in einer weiteren Datei.</p></div>
</div>
<div class="sect2">
<h3 id="heading__vorhandene_metrikdefinitionen_verwenden">
<span class="hidden-anchor sr-only" id="_vorhandene_metrikdefinitionen_verwenden"></span>11.2. Vorhandene Metrikdefinitionen verwenden</h3>
<div class="paragraph"><p>Bevor Sie das tun, sollten Sie — ähnlich wie beim Regelsatz für
die Parameter — zunächst prüfen, ob Checkmk nicht bereits eine geeignete
Metrikdefinition mitbringt.  Die vordefinierten Metrikendefinitionen finden
Sie im Verzeichnis <code>lib/check_mk/gui/plugins/metrics/</code>. In der Datei <code>cpu.py</code>
finden Sie beispielsweise eine Metrik für freien Platz eines Dateisystems:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-n">metric_info</span><span class="tok-p">[</span><span class="tok-s2">"util"</span><span class="tok-p">]</span> <span class="tok-o">=</span> <span class="tok-p">{</span>
    <span class="tok-s2">"title"</span><span class="tok-p">:</span> <span class="tok-n">_</span><span class="tok-p">(</span><span class="tok-s2">"CPU utilization"</span><span class="tok-p">),</span>
    <span class="tok-s2">"unit"</span><span class="tok-p">:</span> <span class="tok-s2">"%"</span><span class="tok-p">,</span>
    <span class="tok-s2">"color"</span><span class="tok-p">:</span> <span class="tok-s2">"26/a"</span><span class="tok-p">,</span>
<span class="tok-p">}</span></code></pre></div></div>
<div class="paragraph"><p>Falls diese für Ihr Plugin geeignet ist, müssen Sie lediglich in Ihrem
Aufruf der <code>Metric()</code>-Klasse den Namen <code>"util"</code> verwenden.
Alles andere leitet sich dann automatisch davon ab.</p></div>
</div>
<div class="sect2">
<h3 id="heading_ownmetricdefinitions">
<span class="hidden-anchor sr-only" id="ownmetricdefinitions"></span>11.3. Eigene Metrikdefinitionen</h3>
<div class="paragraph"><p>Falls keine passende Metrik dabei ist, legen Sie einfach selbst
eine an.  In unserem Beispiel wollen wir einen eigene Metrik für
unsere <code>fooslots</code> definieren. Dazu legen wir eine Datei in
<code>local/share/check_mk/web/plugins/metrics</code> an`:</p></div>
<div class="listingblock">
<div class="title">local/share/check_mk/web/plugins/metrics/foobar_metric.py</div>
<div class="content"><pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-kn">from</span> <span class="tok-nn">cmk.gui.i18n</span> <span class="tok-kn">import</span> <span class="tok-n">_</span>
<span class="tok-kn">from</span> <span class="tok-nn">cmk.gui.plugins.metrics</span> <span class="tok-kn">import</span> <span class="tok-n">metric_info</span>

<span class="tok-n">metric_info</span><span class="tok-p">[</span><span class="tok-s2">"fooslots"</span><span class="tok-p">]</span> <span class="tok-o">=</span> <span class="tok-p">{</span>
    <span class="tok-s2">"title"</span><span class="tok-p">:</span> <span class="tok-n">_</span><span class="tok-p">(</span><span class="tok-s2">"Used slots"</span><span class="tok-p">),</span>
    <span class="tok-s2">"unit"</span><span class="tok-p">:</span> <span class="tok-s2">"count"</span><span class="tok-p">,</span>
    <span class="tok-s2">"color"</span><span class="tok-p">:</span> <span class="tok-s2">"15/a"</span><span class="tok-p">,</span>
<span class="tok-p">}</span></code></pre></div>
</div>
<div class="paragraph"><p>Dazu einige Hinweise:</p></div>
<div class="ulist"><ul>
<li><p>Der Schlüssel (hier <code>"fooslots"</code>) ist der Metrikname und muss dem entsprechen, was die Checkfunktion ausgibt.</p></li>
<li><p>Das Importieren und Verwenden des Unterstrichs für die Internationalisierung ist optional, wie bereits bei den Regeln besprochen.</p></li>
<li><p>Welche Unit-Definitionen es gibt, erfahren Sie in der Datei <code>lib/check_mk/gui/plugins/metrics/unit.py</code>.</p></li>
<li><p>Die Farbdefinition verwendet eine Palette. Zu jeder Palettenfarbe gibt es <code>/a</code> und <code>/b</code>. Dies sind zwei Schattierungen der gleichen Farbe. In den vorhandenen Definitionen werden Sie auch viele direkte Farbkodierungen wie <code>"#ff8800"</code> finden. Diese werden nach und nach abgeschafft und alle durch Palettenfarben ersetzt werden, da diese ein einheitlicheres Aussehen bieten und auch leichter an die Themes der Oberfläche angepasst werden können.</p></li>
</ul></div>
<div class="paragraph"><p>Diese Definition sorgt jetzt dafür, dass Farbe, Titel und Einheit der Metrik
nach unsere Wünschen angezeigt werden.</p></div>
</div>
<div class="sect2">
<h3 id="heading__graphen_mit_mehreren_metriken">
<span class="hidden-anchor sr-only" id="_graphen_mit_mehreren_metriken"></span>11.4. Graphen mit mehreren Metriken</h3>
<div class="paragraph"><p>Möchten Sie mehrere Metriken in einem Graphen kombinieren (was oft sehr sinnvoll ist),
benötigen Sie, einfach in der gleichen Datei, eine Graphdefinition. Dies geschieht über
das globale Dictionary <code>graph_info</code>.</p></div>
<div class="paragraph"><p>Nehmen wir dazu als Beispiel an, unser Check hätte zwei Metriken und zwar <code>fooslots</code>
und <code>fooslots_free</code>. Die Metrikdefinitionen wären z.B.:</p></div>
<div class="listingblock">
<div class="title">local/share/check_mk/web/plugins/metrics/foobar_metric.py</div>
<div class="content"><pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-kn">from</span> <span class="tok-nn">cmk.gui.i18n</span> <span class="tok-kn">import</span> <span class="tok-n">_</span>
<span class="tok-kn">from</span> <span class="tok-nn">cmk.gui.plugins.metrics</span> <span class="tok-kn">import</span> <span class="tok-p">(</span>
    <span class="tok-n">metric_info</span><span class="tok-p">,</span>
    <span class="tok-n">graph_info</span><span class="tok-p">,</span>
<span class="tok-p">)</span>

<span class="tok-n">metric_info</span><span class="tok-p">[</span><span class="tok-s2">"fooslots"</span><span class="tok-p">]</span> <span class="tok-o">=</span> <span class="tok-p">{</span>
    <span class="tok-s2">"title"</span><span class="tok-p">:</span> <span class="tok-n">_</span><span class="tok-p">(</span><span class="tok-s2">"Used slots"</span><span class="tok-p">),</span>
    <span class="tok-s2">"unit"</span><span class="tok-p">:</span> <span class="tok-s2">"count"</span><span class="tok-p">,</span>
    <span class="tok-s2">"color"</span><span class="tok-p">:</span> <span class="tok-s2">"16/a"</span><span class="tok-p">,</span>
<span class="tok-p">}</span>

<span class="tok-n">metric_info</span><span class="tok-p">[</span><span class="tok-s2">"fooslots_free"</span><span class="tok-p">]</span> <span class="tok-o">=</span> <span class="tok-p">{</span>
    <span class="tok-s2">"title"</span><span class="tok-p">:</span> <span class="tok-n">_</span><span class="tok-p">(</span><span class="tok-s2">"Free slots"</span><span class="tok-p">),</span>
    <span class="tok-s2">"unit"</span><span class="tok-p">:</span> <span class="tok-s2">"count"</span><span class="tok-p">,</span>
    <span class="tok-s2">"color"</span><span class="tok-p">:</span> <span class="tok-s2">"24/a"</span><span class="tok-p">,</span>
<span class="tok-p">}</span></code></pre></div>
</div>
<div class="paragraph"><p>Nun fügen wir einen Graphen an, der diese beiden Metriken als Linien einzeichnet:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-n">graph_info</span><span class="tok-p">[</span><span class="tok-s2">"fooslots_combined"</span><span class="tok-p">]</span> <span class="tok-o">=</span> <span class="tok-p">{</span>
    <span class="tok-s2">"metrics"</span><span class="tok-p">:</span> <span class="tok-p">[</span>
        <span class="tok-p">(</span><span class="tok-s2">"fooslots"</span><span class="tok-p">,</span> <span class="tok-s2">"line"</span><span class="tok-p">),</span>
        <span class="tok-p">(</span><span class="tok-s2">"fooslots_free"</span><span class="tok-p">,</span> <span class="tok-s2">"line"</span><span class="tok-p">),</span>
    <span class="tok-p">],</span>
<span class="tok-p">}</span></code></pre></div></div>
<div class="paragraph"><p>Hinweise dazu:</p></div>
<div class="ulist"><ul>
<li><p>Leider gibt es im Handbuch noch keine Beschreibung der Möglichkeiten dieser Definition. Aber Sie finden sehr viele Beispiele in den Dateien im Verzeichnis <code>lib/check_mk/gui/plugins/metrics</code>.</p></li>
<li><p>Probieren Sie anstelle von <code>line</code> auch mal <code>area</code> oder <code>stack</code>.</p></li>
</ul></div>
</div>
<div class="sect2">
<h3 id="heading_perfometer">
<span class="hidden-anchor sr-only" id="perfometer"></span>11.5. Darstellung der Metriken im Perf-O-Meter</h3>
<div class="paragraph"><p>Möchten Sie zu unserer Metrik noch ein Perf-O-Meter in der
Servicezeile anzeigen, benötigen Sie eine weitere Datei, diesmal
im Verzeichnis <code>local/share/check_mk/web/plugins/perfometer</code>.</p></div>
<div class="paragraph"><p>Beispiel:</p></div>
<div class="listingblock">
<div class="title">local/share/check_mk/web/plugins/perfometer/foobar_perfometer.py</div>
<div class="content"><pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-kn">from</span> <span class="tok-nn">cmk.gui.plugins.metrics</span> <span class="tok-kn">import</span> <span class="tok-n">perfometer_info</span>

<span class="tok-n">perfometer_info</span><span class="tok-o">.</span><span class="tok-n">append</span><span class="tok-p">({</span>
    <span class="tok-s2">"type"</span><span class="tok-p">:</span> <span class="tok-s2">"logarithmic"</span><span class="tok-p">,</span>
    <span class="tok-s2">"metric"</span><span class="tok-p">:</span> <span class="tok-s2">"fooslots"</span><span class="tok-p">,</span>
    <span class="tok-s2">"half_value"</span><span class="tok-p">:</span> <span class="tok-mi">5</span><span class="tok-p">,</span>
    <span class="tok-s2">"exponent"</span><span class="tok-p">:</span> <span class="tok-mf">2.0</span><span class="tok-p">,</span>
<span class="tok-p">})</span></code></pre></div>
</div>
<div class="paragraph"><p>Perf-O-Meter sind etwas trickreicher als Graphen, da es keine Legende
gibt. Und deswegen ist das mit dem Wertebereich schwierig. Da das arme
Perf-O-Meter nicht wissen kann, welche Messwerte denn überhaupt möglich
sind und der Platz sehr begrenzt ist, verwenden viele eingebaute Checkplugins
eine logarithmische Darstellung. Dies ist auch in unserem Beispiel so.
<code>half_value</code> ist der Messwert, welcher genau in der Mitte des
Perf-O-Meters angezeigt wird. Bei einem Wert von <code>5</code>, wäre also
hier der Balken halb gefüllt. Und <code>exponent</code> beschreibt den
Faktor, welcher notwendig ist, damit weitere 10% des Bereichs gefüllt würden.
Also würde hier im Beispiel ein Messwert von <code>10</code> bei 60% und einer
von <code>20</code> bei 70% angezeigt werden.</p></div>
<div class="paragraph"><p>Der Vorteil von dieser Methode: Wenn Sie eine Liste von Services gleicher
Art haben, können Sie alle Perf-O-Meter untereinander optisch schnell
vergleichen, da alle die gleiche Skala haben. Und trotz der sehr kleinen
Darstellungen kann man sowohl bei sehr kleinen als auch bei der großen
Messwerten die Unterschiede gut erkennen. Dafür sind die Werte allerdings nicht
maßstabsgetreu.</p></div>
<div class="paragraph"><p>Alternativ können Sie auch ein lineares Perf-O-Meter verwenden. Das
ist immer dann sinnvoll, wenn es einen bekannten Maximalwert gibt.
Ein typischer Fall sind Messwerte, welche Prozente von 0 bis 100
darstellen. Das sähe dann z.B. so aus:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-n">perfometer_info</span><span class="tok-o">.</span><span class="tok-n">append</span><span class="tok-p">({</span>
    <span class="tok-s2">"type"</span><span class="tok-p">:</span> <span class="tok-s2">"linear"</span><span class="tok-p">,</span>
    <span class="tok-s2">"segments"</span><span class="tok-p">:</span> <span class="tok-p">[</span><span class="tok-s2">"fooslots_used_percent"</span><span class="tok-p">],</span>
    <span class="tok-s2">"total"</span><span class="tok-p">:</span> <span class="tok-mf">100.0</span><span class="tok-p">,</span>
<span class="tok-p">})</span></code></pre></div></div>
<div class="paragraph"><p>Hier gibt es noch einen weiteren Unterschied zur logarithmischen
Darstellung: <code>segments</code> ist hier eine Liste und erlaubt das
nebeneinander Darstellen von mehreren Metriken.</p></div>
<div class="paragraph"><p>Wie immer finden Sie Beispiele in den vielen von Checkmk ausgelieferten
Plugins. Diese sind ebenfalls in den Dateien im Verzeichnis
<code>lib/check_mk/gui/plugins/metrics</code>.</p></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="heading_old_api">
<span class="hidden-anchor sr-only" id="old_api"></span>12. Hinweise für Nutzer der alten API</h2>
<div class="sectionbody">
<div class="paragraph"><p>Sind Sie bereits erfahren bei der Entwicklung von Checkplugins mit der bisherigen
API — derjenigen bis Version <span class="new">1.6.0</span> von Checkmk? Dann finden Sie hier einige
Hinweise über wichtige Änderungen zusammengefasst.</p></div>
<div class="sect2">
<h3 id="heading__saveint_und_savefloat">
<span class="hidden-anchor sr-only" id="_saveint_und_savefloat"></span>12.1. saveint() und savefloat()</h3>
<div class="paragraph"><p>Die beiden Funktionen <code>saveint()</code> und <code>savefloat()</code> sind weggefallen.
Zur Erinnerung: <code>saveint(x)</code> liefert <code>0</code> wenn sich <code>x</code> nicht
vernünftig in eine Zahl konvertieren lässt, z.B. weil es ein leerer String ist oder
nicht nur aus Ziffern besteht.</p></div>
<div class="paragraph"><p>Auch wenn es dafür einige wenige gute Anwendungsfälle gab, wurde es doch in der
Mehrheit der Fälle falsch verwendet und hat dazu geführt, dass so viele
<a href="#errors">Fehler</a> verschleiert wurden.</p></div>
<div class="paragraph"><p>Für den Fall, dass Sie bei einem Leerstring eine <code>0</code> bekommen möchten,
also den häufigsten „guten“ Anwendungsfall von <code>saveint(x)</code>, können
Sie einfach Folgendes schreiben:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-n">foo</span> <span class="tok-o">=</span> <span class="tok-nb">int</span><span class="tok-p">(</span><span class="tok-n">x</span><span class="tok-p">)</span> <span class="tok-k">if</span> <span class="tok-n">x</span> <span class="tok-k">else</span> <span class="tok-mi">0</span></code></pre></div></div>
<div class="paragraph"><p>Für <code>savefloat()</code> gilt alles analog.</p></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="heading_parsefunction">
<span class="hidden-anchor sr-only" id="parsefunction"></span>13. Komplexe Agentenausgaben mittels Parsefunktion bändigen</h2>
<div class="sectionbody">
<div class="paragraph"><p>Der nächste Schritt ist die sogenannten <em>Parsefunktion</em>. Diese
hat die Aufgabe, die „rohen“ Agentendaten zu parsen und in eine logisch
aufgeräumte Form zu bringen, die für alle weiteren Schritte einfach
zu verarbeiten ist. Konvention ist, dass diese nach der Agentensektion
benannt wird und mit <code>parse_</code> beginnt. Sie bekommt als einziges
Argument <code>string_table</code>. Bitte beachten Sie, dass Sie hier nicht
frei in der Wahl des Arguments sind. Es muss wirklich so heißen.</p></div>
<div class="paragraph"><p>Wir schreiben unsere Parsefunktion jetzt erstmal so, dass wir einfach
nur die Daten, die sie bekommt, auf der Konsole ausgeben. Dazu nehmen
wir einfach die <code>print</code>-Funktion (Achtung: seit Python 3 sind
hier Klammern zwingend notwendig):</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">def</span> <span class="tok-nf">parse_linux_usbstick</span><span class="tok-p">(</span><span class="tok-n">string_table</span><span class="tok-p">):</span>
    <span class="tok-nb">print</span><span class="tok-p">(</span><span class="tok-n">string_table</span><span class="tok-p">)</span></code></pre></div></div>
<div class="paragraph"><p>Damit das Ganze irgendetwas bewirken soll, müssen wir unsere Parsefunktion
und überhaupt die neue Agentensektion bei Checkmk bekannt machen. Dazu
rufen wir eine Registrierfunktion auf:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-n">register</span><span class="tok-o">.</span><span class="tok-n">agent_section</span><span class="tok-p">(</span>
    <span class="tok-n">name</span> <span class="tok-o">=</span> <span class="tok-s2">"linux_usbstick"</span><span class="tok-p">,</span>
    <span class="tok-n">parse_function</span> <span class="tok-o">=</span> <span class="tok-n">parse_linux_usbstick</span><span class="tok-p">,</span>
<span class="tok-p">)</span></code></pre></div></div>
<div class="paragraph"><p>Hier ist es wichtig, dass der Name der Sektion wirklich exakt mit dem
Sektionsheader in der Agentenausgabe übereinstimmt. Insgesamt
sieht das jetzt so aus:</p></div>
<div class="listingblock">
<div class="title">local/lib/check_mk/base/plugins/agent_based/linux_usbstick.py</div>
<div class="content"><pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-kn">from</span> <span class="tok-nn">.agent_based_api.v1</span> <span class="tok-kn">import</span> <span class="tok-o">*</span>

<span class="tok-k">def</span> <span class="tok-nf">parse_linux_usbstick</span><span class="tok-p">(</span><span class="tok-n">string_table</span><span class="tok-p">):</span>
    <span class="tok-nb">print</span><span class="tok-p">(</span><span class="tok-n">string_table</span><span class="tok-p">)</span>
    <span class="tok-k">return</span> <span class="tok-n">string_table</span>

<span class="tok-n">register</span><span class="tok-o">.</span><span class="tok-n">agent_section</span><span class="tok-p">(</span>
    <span class="tok-n">name</span> <span class="tok-o">=</span> <span class="tok-s2">"linux_usbstick"</span><span class="tok-p">,</span>
    <span class="tok-n">parse_function</span> <span class="tok-o">=</span> <span class="tok-n">parse_linux_usbstick</span><span class="tok-p">,</span>
<span class="tok-p">)</span></code></pre></div>
</div>
<div class="paragraph"><p>Von diesem Moment an bekommt jedes Plugin, das die Section <code>linux_usbstick</code>
benutzt, den Rückgabewert der Parsefunktion übergeben. In der Regel wird das das
gleichnamige Checkplugin sein.</p></div>
<div class="paragraph"><p>Wir haben jetzt gewissermaßen das einfachste mögliche Plugin gebaut, was noch
keinen wirklich Nutzen hat, aber das wir immerhin schon testen können.  Dazu
stoßen wir auf der Kommandozeile eine Serviceerkennung (Option <code>-I</code>)
von dem Host an, dessen Agenten wir vorhin präpariert haben. <em>Wenn</em>
dessen Ausgabe auch wirklich eine Sektion <code>linux_usbstick</code> enthält,
dann müssten wir unsere Debugausgabe sehen:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="console"><span></span><span class="tok-gp">OMD[mysite]:~$ </span>cmk<span class="tok-w"> </span>-I<span class="tok-w"> </span>myhost123
<span class="tok-go">[['ata-APPLE_SSD_SM0512F_S1K5NYBF810191'], ['wwn-0x5002538655584d30']]</span></code></pre></div></div>
<div class="paragraph"><p>Etwas übersichtlicher wird die Ausgabe, wenn wir das einfache <code>print</code>
durch ein Pretty-print aus dem Modul <code>pprint</code> ersetzen. Das ist für
alle weitere Debugausgaben sehr empfehlenswert:</p></div>
<div class="listingblock">
<div class="title">local/lib/check_mk/base/plugins/agent_based/linux_usbstick.py</div>
<div class="content"><pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-kn">from</span> <span class="tok-nn">.agent_based_api.v1</span> <span class="tok-kn">import</span> <span class="tok-o">*</span>
<span class="tok-o">*</span><span class="tok-kn">import</span> <span class="tok-nn">pprint</span><span class="tok-o">*</span>

<span class="tok-k">def</span> <span class="tok-nf">parse_linux_usbstick</span><span class="tok-p">(</span><span class="tok-n">string_table</span><span class="tok-p">):</span>
    <span class="tok-o">*</span><span class="tok-n">pprint</span><span class="tok-o">.</span><span class="tok-n">pprint</span><span class="tok-p">(</span><span class="tok-n">string_table</span><span class="tok-p">)</span><span class="tok-o">*</span>
    <span class="tok-k">return</span> <span class="tok-n">string_table</span>

<span class="tok-n">register</span><span class="tok-o">.</span><span class="tok-n">agent_section</span><span class="tok-p">(</span>
    <span class="tok-n">name</span> <span class="tok-o">=</span> <span class="tok-s2">"linux_usbstick"</span><span class="tok-p">,</span>
    <span class="tok-n">parse_function</span> <span class="tok-o">=</span> <span class="tok-n">parse_linux_usbstick</span><span class="tok-p">,</span>
<span class="tok-p">)</span></code></pre></div>
</div>
<div class="paragraph"><p>Das sieht dann so aus:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="console"><span></span><span class="tok-gp">OMD[mysite]:~$ </span>cmk<span class="tok-w"> </span>-I<span class="tok-w"> </span>myhost123
<span class="tok-go">[['ata-APPLE_SSD_SM0512F_S1K5NYBF810191'],</span>
<span class="tok-go"> ['wwn-0x5002538655584d30']]</span></code></pre></div></div>
<div class="sect2">
<h3 id="heading__die_parsefunktion_schreiben">
<span class="hidden-anchor sr-only" id="_die_parsefunktion_schreiben"></span>13.1. Die Parsefunktion schreiben</h3>
<div class="paragraph"><p>Wenn Sie genau hinsehen, dann erkennen Sie, dass es sich hier um verschachtelte
Listen handelt. Im Argument <code>string_table</code> bekommen Sie eine Liste,
welche <em>pro Zeile</em> der Agentenausgabe eine Liste von <em>Worten</em>
beinhaltet. Dabei werden die Zeilen an Folgen von Leerzeichen getrennt. Da
unsere Sektion pro Zeile nur ein Wort enthält, bestehen ergo die inneren
Listen aus nur jeweils einem Eintrag.</p></div>
<div class="paragraph"><p>Folgendes Beispiel macht die Struktur noch etwas klarer:</p></div>
<div class="listingblock">
<div class="title">local/lib/check_mk/base/plugins/agent_based/linux_usbstick.py</div>
<div class="content"><pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-kn">from</span> <span class="tok-nn">.agent_based_api.v1</span> <span class="tok-kn">import</span> <span class="tok-o">*</span>
<span class="tok-kn">import</span> <span class="tok-nn">pprint</span>

<span class="tok-k">def</span> <span class="tok-nf">parse_linux_usbstick</span><span class="tok-p">(</span><span class="tok-n">string_table</span><span class="tok-p">):</span>
    <span class="tok-nb">print</span><span class="tok-p">(</span><span class="tok-s2">"Number of lines: </span><span class="tok-si">%d</span><span class="tok-s2">"</span> <span class="tok-o">%</span> <span class="tok-nb">len</span><span class="tok-p">(</span><span class="tok-n">string_table</span><span class="tok-p">))</span>
    <span class="tok-nb">print</span><span class="tok-p">(</span><span class="tok-s2">"Number of words in first line: </span><span class="tok-si">%d</span><span class="tok-s2">"</span> <span class="tok-o">%</span> <span class="tok-nb">len</span><span class="tok-p">(</span><span class="tok-n">string_table</span><span class="tok-p">[</span><span class="tok-mi">0</span><span class="tok-p">]))</span>
    <span class="tok-nb">print</span><span class="tok-p">(</span><span class="tok-s2">"Length of first word: </span><span class="tok-si">%d</span><span class="tok-s2">"</span> <span class="tok-o">%</span> <span class="tok-nb">len</span><span class="tok-p">(</span><span class="tok-n">string_table</span><span class="tok-p">[</span><span class="tok-mi">0</span><span class="tok-p">][</span><span class="tok-mi">0</span><span class="tok-p">]))</span>
    <span class="tok-k">return</span> <span class="tok-n">string_table</span>

<span class="tok-n">register</span><span class="tok-o">.</span><span class="tok-n">agent_section</span><span class="tok-p">(</span>
    <span class="tok-n">name</span> <span class="tok-o">=</span> <span class="tok-s2">"linux_usbstick"</span><span class="tok-p">,</span>
    <span class="tok-n">parse_function</span> <span class="tok-o">=</span> <span class="tok-n">parse_linux_usbstick</span><span class="tok-p">,</span>
<span class="tok-p">)</span></code></pre></div>
</div>
<div class="paragraph"><p>Die Ausgabe sieht dann so aus:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="console"><span></span><span class="tok-gp">OMD[mysite]:~$ </span>cmk<span class="tok-w"> </span>-I<span class="tok-w"> </span>myhost123
<span class="tok-go">Number of lines: 3</span>
<span class="tok-go">Number of words in first line: 1</span>
<span class="tok-go">Length of first word: 36</span></code></pre></div></div>
<div class="paragraph"><p>Für unser Beispiel benötigen wir einfach nur eine einfache Liste der Devicenamen.
Also machen wir unsere Parsefunktion so, dass sie aus jeder Zeile das eine Wort
auspackt und in eine hübsche neue Liste verpackt:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">def</span> <span class="tok-nf">parse_linux_usbstick</span><span class="tok-p">(</span><span class="tok-n">string_table</span><span class="tok-p">):</span>
    <span class="tok-n">parsed</span> <span class="tok-o">=</span> <span class="tok-p">[]</span>
    <span class="tok-k">for</span> <span class="tok-n">line</span> <span class="tok-ow">in</span> <span class="tok-n">string_table</span><span class="tok-p">:</span>
        <span class="tok-n">parsed</span><span class="tok-o">.</span><span class="tok-n">append</span><span class="tok-p">(</span><span class="tok-n">line</span><span class="tok-p">[</span><span class="tok-mi">0</span><span class="tok-p">])</span>
    <span class="tok-n">pprint</span><span class="tok-o">.</span><span class="tok-n">pprint</span><span class="tok-p">(</span><span class="tok-n">parsed</span><span class="tok-p">)</span>
    <span class="tok-k">return</span> <span class="tok-n">string_table</span></code></pre></div></div>
<div class="paragraph"><p>Die Debugausgabe sieht dann so aus (bitte schauen Sie genau hin, es
gibt jetzt nur noch ein einziges paar eckiger Klammern):</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-p">[</span><span class="tok-s1">'ata-APPLE_SSD_SM0512F_S1K5NYBF810191'</span><span class="tok-p">,</span>
 <span class="tok-s1">'wwn-0x5002538655584d30'</span><span class="tok-p">]</span></code></pre></div></div>
<div class="paragraph"><p>Damit die Parsefunktion vollständig ist, müssen wir jetzt noch die
Debugmeldung entfernen und — ganz wichtig — das neue Ergebnis mit
<code>return</code> zurückgeben:</p></div>
<div class="listingblock"><div class="content"><pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">def</span> <span class="tok-nf">parse_linux_usbstick</span><span class="tok-p">(</span><span class="tok-n">string_table</span><span class="tok-p">):</span>
    <span class="tok-n">parsed</span> <span class="tok-o">=</span> <span class="tok-p">[]</span>
    <span class="tok-k">for</span> <span class="tok-n">line</span> <span class="tok-ow">in</span> <span class="tok-n">string_table</span><span class="tok-p">:</span>
        <span class="tok-n">parsed</span><span class="tok-o">.</span><span class="tok-n">append</span><span class="tok-p">(</span><span class="tok-n">line</span><span class="tok-p">[</span><span class="tok-mi">0</span><span class="tok-p">])</span>
    <span class="tok-k">return</span> <span class="tok-n">parsed</span></code></pre></div></div>
<div class="paragraph"><p>Natürlich müssen von diesem Moment an alle betroffenen Plugins mit dem neuen
Datenformat arbeiten können.</p></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="heading_outlook">
<span class="hidden-anchor sr-only" id="outlook"></span>14. Ausblick</h2>
<div class="sectionbody">
<div class="paragraph"><p>Es gibt noch viele weitere Aspekte und Themen rund um die Entwicklung von
eigenen Plugins. Checkmk hat sehr viele Schnittstellen für eigene Erweiterungen
und ist dadurch sehr flexibel erweiterbar. Wir arbeiten daran, dass diese
Schnittstellen nach und nach im Handbuch beschrieben werden.</p></div>
<div class="paragraph"><p>Falls Sie Fragen oder Schwierigkeiten haben, steht Ihnen natürlich unser professioneller
Support und auch das kostenlose Forum zur Verfügung.</p></div>
</div>
</div>
<div class="sect1">
<h2 id="heading_files">
<span class="hidden-anchor sr-only" id="files"></span>15. Dateien und Verzeichnisse</h2>
<div class="sectionbody"><table class="table-responsive table-bordered table tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">local/lib/check_mk/base/plugins/agent_based</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Ablageort für selbst geschriebene Checkplugins</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">local/share/check_mk/web/plugins/wato</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Ablageort für Ihre Regelsätze für Checkparameter</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">local/share/check_mk/web/plugins/metrics</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Ablageort für eigene Metrikdefinitionen</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">local/share/check_mk/web/plugins/perfometer</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Ablageort für eigene Definitionen von Perf-O-Metern</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">local/share/check_mk/mibs</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Legen Sie hier SNMP-MIB-Dateien ab, die automatisch geladen werden sollen.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">lib/check_mk/gui/plugins/wato/check_parameters</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Hier finden Sie die Regelsatzdefinitionen von allen mitgelieferten Checkplugins von Checkmk</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">lib/check_mk/gui/plugins/wato/utils/<em>init</em>.py</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">In dieser Datei sind die Gruppen der Setupoberfläche definiert, in welchen Sie neue Regelsätze ablegen können.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">lib/check_mk/gui/plugins/metrics/</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Hier finden Sie die Metrikdefinitionen der mitgelieferten Plugins</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">lib/check_mk/gui/plugins/metrics/unit.py</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">In dieser Datei sind die vordefinierten Einheiten für Metriken.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">/usr/lib/check_mk_agent/plugins</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Dieses Verzeichnis bezieht sich auf einen überwachten Linux-Host. Hier erwartet der Checkmk-Agent für Linux Erweiterungen des Agenten (Agent-Plugins).</p></td>
</tr>
</tbody>
</table></div>
</div>
</div></main><div id="toc" class="toc2">
<div id="toctitle">Auf dieser Seite</div>
<ul class="sectlevel1">
<li>
<a href="#_einleitung">1. Einleitung</a><ul class="sectlevel1">
<li><a href="#real_plug-in">1.1. Muss es immer ein echtes Plugin sein?</a></li>
<li><a href="#_was_hat_sich_seit_der_alten_api_ge%C3%A4ndert">1.2. Was hat sich seit der alten API geändert?</a></li>
<li><a href="#_wird_die_alte_api_noch_unterst%C3%BCtzt">1.3. Wird die alte API noch unterstützt</a></li>
<li><a href="#_verschiedene_arten_von_agenten">1.4. Verschiedene Arten von Agenten</a></li>
<li><a href="#_voraussetzungen">1.5. Voraussetzungen</a></li>
</ul>
</li>
<li>
<a href="#agentbased">2. Ein erstes einfaches Checkplugin</a><ul class="sectlevel1">
<li><a href="#_den_richtigen_befehl_finden">2.1. Den richtigen Befehl finden</a></li>
<li><a href="#_die_daten_entschlacken">2.2. Die Daten entschlacken</a></li>
<li><a href="#includecommand">2.3. Den Befehl in den Agenten einbauen</a></li>
<li><a href="#_agent_ausprobieren">2.4. Agent ausprobieren</a></li>
<li><a href="#_die_sektion_deklarieren">2.5. Die Sektion deklarieren</a></li>
<li><a href="#_den_check_deklarieren">2.6. Den Check deklarieren</a></li>
<li><a href="#_die_discovery_funktion_schreiben">2.7. Die Discovery-Funktion schreiben</a></li>
<li><a href="#_die_check_funktion_schreiben">2.8. Die Check-Funktion schreiben</a></li>
<li><a href="#_das_ganze_plugin_auf_einen_blick">2.9. Das ganze Plugin auf einen Blick</a></li>
</ul>
</li>
<li>
<a href="#_checks_mit_mehr_als_einem_service_pro_host_items">3. Checks mit mehr als einem Service pro Host (Items)</a><ul class="sectlevel1">
<li><a href="#_grundprinzip">3.1. Grundprinzip</a></li>
<li><a href="#_ein_einfaches_beispiel">3.2. Ein einfaches Beispiel</a></li>
<li><a href="#_beispiel_komplett">3.3. Beispiel komplett</a></li>
</ul>
</li>
<li>
<a href="#_messwerte">4. Messwerte</a><ul class="sectlevel1">
<li><a href="#_werte_in_der_check_funktion_ermitteln">4.1. Werte in der Check-Funktion ermitteln</a></li>
<li><a href="#thresholdinformation">4.2. Informationen zu den Schwellwerten</a></li>
<li><a href="#_der_wertebereich">4.3. Der Wertebereich</a></li>
</ul>
</li>
<li><a href="#_checks_mit_mehreren_teilresultaten">5. Checks mit mehreren Teilresultaten</a></li>
<li><a href="#_summary_und_details">6. Summary und Details</a></li>
<li>
<a href="#errors">7. Fehlerbehandlung</a><ul class="sectlevel1">
<li><a href="#_exceptions_und_crashreports">7.1. Exceptions und Crashreports</a></li>
<li><a href="#_exceptions_auf_der_kommandozeile_ansehen">7.2. Exceptions auf der Kommandozeile ansehen</a></li>
<li><a href="#_ung%C3%BCltige_ausgaben_vom_agenten">7.3. Ungültige Ausgaben vom Agenten</a></li>
<li><a href="#_fehlende_items">7.4. Fehlende Items</a></li>
</ul>
</li>
<li>
<a href="#snmp">8. SNMP-basierte Checks</a><ul class="sectlevel1">
<li>
<a href="#_grunds%C3%A4tzliches">8.1. Grundsätzliches</a><ul class="sectlevel2">
<li><a href="#_snmp_detection">SNMP-Detection</a></li>
<li><a href="#_discovery">Discovery</a></li>
<li><a href="#_checken">Checken</a></li>
<li><a href="#_zusammenfassung">Zusammenfassung</a></li>
</ul>
</li>
<li><a href="#_ein_wort_zu_den_mibs">8.2. Ein Wort zu den MIBs</a></li>
<li><a href="#locating_oids">8.3. Die richtigen OIDs finden</a></li>
<li>
<a href="#_die_registrierung_der_snmp_sektion">8.4. Die Registrierung der SNMP-Sektion</a><ul class="sectlevel2"><li><a href="#_die_snmp_detection">Die SNMP-Detection</a></li></ul>
</li>
<li><a href="#_die_oid_bereiche_f%C3%BCr_das_monitoring">8.5. Die OID-Bereiche für das Monitoring</a></li>
<li><a href="#_weitere_snmp_sonderheiten">8.6. Weitere SNMP-Sonderheiten</a></li>
</ul>
</li>
<li>
<a href="#format_numbers">9. Formatierung von Zahlen</a><ul class="sectlevel1">
<li><a href="#_grundlegendes">9.1. Grundlegendes</a></li>
<li><a href="#_zeiten_zeitspannen_frequenzen">9.2. Zeiten, Zeitspannen, Frequenzen</a></li>
<li><a href="#_bytes">9.3. Bytes</a></li>
<li><a href="#_bandbreiten_datenraten">9.4. Bandbreiten, Datenraten</a></li>
<li><a href="#_prozentwerte">9.5. Prozentwerte</a></li>
<li><a href="#_zusammenfassung_2">9.6. Zusammenfassung</a></li>
</ul>
</li>
<li>
<a href="#parameters">10. Schwellwerte und Checkparameter</a><ul class="sectlevel1">
<li><a href="#_ein_regelsatz_f%C3%BCr_das_setup">10.1. Ein Regelsatz für das Setup</a></li>
<li><a href="#_verwenden_von_vorhandenen_regels%C3%A4tzen">10.2. Verwenden von vorhandenen Regelsätzen</a></li>
<li>
<a href="#_einen_eigenen_regelsatz_definieren">10.3. Einen eigenen Regelsatz definieren</a><ul class="sectlevel2"><li><a href="#_test">Test</a></li></ul>
</li>
<li><a href="#_die_regel_im_checkplugin_benutzen">10.4. Die Regel im Checkplugin benutzen</a></li>
<li>
<a href="#_weitere_valuespecs">10.5. Weitere ValueSpecs</a><ul class="sectlevel2">
<li><a href="#_float">Float</a></li>
<li><a href="#_percentage">Percentage</a></li>
<li><a href="#_monitoringstate">MonitoringState</a></li>
<li><a href="#_age">Age</a></li>
<li><a href="#_filesize">Filesize</a></li>
</ul>
</li>
</ul>
</li>
<li>
<a href="#metrics">11. Angepasste Darstellung von Metriken</a><ul class="sectlevel1">
<li><a href="#_der_sinn_von_metrikdefinitionen">11.1. Der Sinn von Metrikdefinitionen</a></li>
<li><a href="#_vorhandene_metrikdefinitionen_verwenden">11.2. Vorhandene Metrikdefinitionen verwenden</a></li>
<li><a href="#ownmetricdefinitions">11.3. Eigene Metrikdefinitionen</a></li>
<li><a href="#_graphen_mit_mehreren_metriken">11.4. Graphen mit mehreren Metriken</a></li>
<li><a href="#perfometer">11.5. Darstellung der Metriken im Perf-O-Meter</a></li>
</ul>
</li>
<li>
<a href="#old_api">12. Hinweise für Nutzer der alten API</a><ul class="sectlevel1"><li><a href="#_saveint_und_savefloat">12.1. saveint() und savefloat()</a></li></ul>
</li>
<li>
<a href="#parsefunction">13. Komplexe Agentenausgaben mittels Parsefunktion bändigen</a><ul class="sectlevel1"><li><a href="#_die_parsefunktion_schreiben">13.1. Die Parsefunktion schreiben</a></li></ul>
</li>
<li><a href="#outlook">14. Ausblick</a></li>
<li><a href="#files">15. Dateien und Verzeichnisse</a></li>
</ul>
</div>
<script src="../../assets/js/manifest.js?id=7db827d654313dce4250"></script>
<script src="../../assets/js/vendor.js?id=581a3d4a61b7156d04df"></script>
<script src="../../assets/js/app.js?id=959ccd04b1f8b7b78c5e"></script>
<script src="../../assets/js/lunr.js"></script>
<script src="../../assets/js/lunr.stemmer.support.js"></script>
<script src="../../assets/js/lunr.de.js"></script>
<script src="../lunr.index.de.js"></script>
<script src="../../assets/js/lunr.client.js"></script>
</body>
</html>
